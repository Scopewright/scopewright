<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration — Stele</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">

    <!-- Auth guard -->
    <script>
        if (!localStorage.getItem('sb_access_token')) {
            window.location.href = 'login.html';
        } else {
            document.documentElement.style.visibility = 'visible';
        }
    </script>
    <style>html { visibility: hidden; }</style>

    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        html, body {
            height: 100%;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: #ffffff;
            color: #0A0203;
        }

        .app-wrapper { display: flex; min-height: 100vh; flex-direction: column; }

        /* Nav bar — identique au catalogue et app */
        .nav-bar {
            position: fixed;
            top: 0; left: 0; right: 0;
            background: #FFFFFF;
            border-bottom: 1px solid #C8C8C8;
            padding: 12px 60px;
            display: flex;
            align-items: center;
            gap: 32px;
            z-index: 100;
        }
        .nav-logo {
            font-size: 20px;
            font-weight: 400;
            color: #0A0203;
        }
        .nav-links { display: flex; align-items: center; gap: 16px; }
        .nav-back {
            color: #0A0203; text-decoration: none; font-size: 13px;
            opacity: 0.6; transition: opacity 0.15s; white-space: nowrap;
        }
        .nav-back:hover { opacity: 1; }
        .nav-user {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 13px;
        }
        .nav-user-email {
            color: #0A0203;
            opacity: 0.5;
        }
        .btn-logout {
            background: transparent;
            color: #0A0203;
            border: 1px solid #C8C8C8;
            padding: 5px 14px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.15s;
            font-family: inherit;
            border-radius: 3px;
        }
        .btn-logout:hover { background: #f5f5f5; border-color: #999; }

        /* Content */
        .app-content {
            flex: 1; padding: 40px;
            padding-top: 96px; /* 56px nav + 40px spacing */
            max-width: 1000px; margin: 0 auto; width: 100%;
        }

        .page-title { font-size: 24px; font-weight: 700; margin-bottom: 8px; }
        .page-sub { font-size: 14px; color: #666; margin-bottom: 32px; }

        /* Sections */
        .section {
            background: #F8F8F8; border: 1px solid #e0e0e0;
            border-radius: 6px; margin-bottom: 24px; overflow: hidden;
        }
        .section-toggle {
            display: flex; align-items: center; justify-content: space-between;
            padding: 20px 28px; cursor: pointer; user-select: none;
            transition: background 0.15s;
        }
        .section-toggle:hover { background: #f0f0ef; }
        .section-toggle-left { flex: 1; }
        .section-title { font-size: 16px; font-weight: 700; margin-bottom: 2px; }
        .section-desc { font-size: 13px; color: #888; margin: 0; }
        .section-chevron {
            width: 20px; height: 20px; flex-shrink: 0; margin-left: 16px;
            transition: transform 0.25s; color: #999;
        }
        .section.collapsed .section-chevron { transform: rotate(-90deg); }
        .section-content { padding: 0 28px 28px; }
        .section.collapsed .section-content { display: none; }

        /* Permissions table */
        .perm-table { min-width: 100%; border-collapse: collapse; white-space: nowrap; }
        .perm-table th, .perm-table td {
            padding: 12px 16px; text-align: center;
            border-bottom: 1px solid #f0f0f0;
        }
        .perm-table th {
            font-size: 11px; text-transform: uppercase;
            letter-spacing: 0.5px; color: #888; font-weight: 600;
            background: #fafaf8;
        }
        .perm-table th:first-child, .perm-table td:first-child { text-align: left; }
        .perm-table td:first-child { font-weight: 600; font-size: 14px; }
        .perm-table tbody tr:last-child td { border-bottom: none; }
        .perm-table tbody tr:hover { background: #fdfcfa; }

        /* Toggle switch */
        .toggle { position: relative; display: inline-block; width: 38px; height: 22px; }
        .toggle input { opacity: 0; width: 0; height: 0; }
        .toggle .slider {
            position: absolute; cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #ddd; border-radius: 22px;
            transition: background 0.25s;
        }
        .toggle .slider::before {
            content: ''; position: absolute;
            height: 16px; width: 16px;
            left: 3px; bottom: 3px;
            background: #fff; border-radius: 50%;
            transition: transform 0.25s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.15);
        }
        .toggle input:checked + .slider { background: #4b6050; }
        .toggle input:checked + .slider::before { transform: translateX(16px); }

        /* Roles table */
        .roles-table { width: 100%; border-collapse: collapse; }
        .roles-table th, .roles-table td {
            padding: 10px 12px; text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }
        .roles-table th {
            font-size: 11px; text-transform: uppercase;
            letter-spacing: 0.5px; color: #888; font-weight: 600;
            background: #fafaf8;
        }
        .roles-table tbody tr:last-child td { border-bottom: none; }

        .input-email {
            width: 100%; padding: 8px 12px;
            border: 1px solid #e0e0e0; border-radius: 4px;
            font-family: inherit; font-size: 13px;
            transition: border-color 0.2s;
        }
        .input-email:focus { outline: none; border-color: #4b6050; }

        .select-role {
            padding: 8px 12px; border: 1px solid #e0e0e0;
            border-radius: 4px; font-family: inherit; font-size: 13px;
            background: #fff; cursor: pointer;
        }
        .select-role:focus { outline: none; border-color: #4b6050; }

        .btn-remove {
            background: none; border: none; color: #ccc;
            font-size: 20px; cursor: pointer; padding: 4px 8px;
            transition: color 0.2s;
        }
        .btn-remove:hover { color: #c0392b; }

        .btn-add {
            margin-top: 12px; background: none;
            border: 1px dashed #d0d0d0; color: #888;
            padding: 8px 20px; font-size: 13px; cursor: pointer;
            font-family: inherit; border-radius: 4px;
            transition: all 0.2s;
        }
        .btn-add:hover { border-color: #999; color: #555; }

        /* Save bar */
        .save-bar {
            display: flex; align-items: center; gap: 12px;
            margin-top: 20px; padding-top: 16px;
            border-top: 1px solid #f0f0f0;
        }
        .btn-save {
            background: #4b6050; color: #fff; border: none;
            padding: 10px 28px; font-size: 14px; font-weight: 500;
            cursor: pointer; border-radius: 4px; font-family: inherit;
            transition: opacity 0.2s;
        }
        .btn-save:hover { opacity: 0.9; }

        .save-feedback {
            font-size: 13px; color: #4b6050;
            opacity: 0; transition: opacity 0.3s;
        }
        .save-feedback.visible { opacity: 1; }
        .save-feedback.warn { color: #b8860b; }

        /* Numeric inputs (taux horaires) */
        .input-number {
            width: 100%; padding: 8px 12px;
            border: 1px solid #e0e0e0; border-radius: 4px;
            font-family: inherit; font-size: 13px;
            text-align: right;
            transition: border-color 0.2s;
        }
        .input-number:focus { outline: none; border-color: #4b6050; }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }
        .profit-cell {
            font-weight: 600; font-size: 14px; text-align: right;
            padding-right: 14px;
        }
        .profit-cell.negative { color: #c0392b; }

        /* Footer */
        .app-footer {
            padding: 20px 40px; text-align: center;
            font-size: 11px; color: #999;
            border-top: 1px solid #e0e0e0;
        }

        /* Role modal */
        .role-modal {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 1000;
            align-items: center; justify-content: center;
            padding: 20px;
        }
        .role-modal-content {
            background: #fff; border-radius: 8px;
            max-width: 600px; width: 100%;
            max-height: 90vh; overflow-y: auto;
            box-shadow: 0 4px 24px rgba(0,0,0,0.15);
        }
        .role-modal-header {
            padding: 24px 28px; border-bottom: 1px solid #e0e0e0;
            display: flex; align-items: center; justify-content: space-between;
        }
        .role-modal-title {
            font-size: 18px; font-weight: 700; margin: 0;
        }
        .role-modal-close {
            background: none; border: none; font-size: 24px;
            color: #999; cursor: pointer; padding: 0; width: 32px; height: 32px;
        }
        .role-modal-close:hover { color: #333; }
        .role-modal-body {
            padding: 24px 28px;
        }
        .role-form-group {
            margin-bottom: 20px;
        }
        .role-form-label {
            display: block; font-size: 13px; font-weight: 600;
            margin-bottom: 6px; color: #333;
        }
        .role-form-input {
            width: 100%; padding: 10px 12px;
            border: 1px solid #e0e0e0; border-radius: 4px;
            font-family: inherit; font-size: 14px;
        }
        .role-form-input:focus {
            outline: none; border-color: #4b6050;
        }
        .role-form-textarea {
            min-height: 60px; resize: vertical;
        }
        .role-perm-grid {
            display: grid; grid-template-columns: repeat(2, 1fr);
            gap: 12px 16px; margin-top: 12px;
        }
        .role-perm-item {
            display: flex; align-items: center; gap: 8px;
        }
        .role-perm-item input[type="checkbox"] {
            width: 18px; height: 18px; cursor: pointer;
        }
        .role-perm-item label {
            font-size: 13px; color: #555; cursor: pointer;
        }
        .role-modal-footer {
            padding: 16px 28px; border-top: 1px solid #e0e0e0;
            display: flex; gap: 12px; justify-content: flex-end;
        }
        .btn-modal {
            padding: 10px 24px; font-size: 14px; font-weight: 500;
            border: none; border-radius: 4px; cursor: pointer;
            font-family: inherit; transition: opacity 0.2s;
        }
        .btn-modal:hover { opacity: 0.85; }
        .btn-modal-cancel {
            background: #f5f5f5; color: #555;
        }
        .btn-modal-save {
            background: #4b6050; color: #fff;
        }

        @media (max-width: 768px) {
            .nav-bar { padding: 12px 20px; gap: 16px; }
            .app-content { padding: 24px 16px; padding-top: 80px; }
            .section-toggle { padding: 16px; }
            .section-content { padding: 0 16px 20px; }
            .perm-table th, .perm-table td { padding: 8px 6px; font-size: 12px; }
            .role-perm-grid { grid-template-columns: 1fr; }
        }
        /* Stele dialog */
        .stele-dialog-overlay {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.45);
            z-index: 9999; justify-content: center; align-items: center;
        }
        .stele-dialog-overlay.active { display: flex; }
        .stele-dialog {
            background: #fff; border-radius: 10px; box-shadow: 0 8px 32px rgba(0,0,0,0.25);
            max-width: 440px; width: 90%; overflow: hidden;
        }
        .stele-dialog-header { padding: 18px 24px 0; }
        .stele-dialog-header h3 { font-size: 15px; font-weight: 700; color: var(--stele-black); margin: 0; }
        .stele-dialog-body { padding: 12px 24px 20px; }
        .stele-dialog-body p { font-size: 14px; color: #444; margin: 0; }
        .stele-dialog-footer { display: flex; justify-content: flex-end; gap: 8px; padding: 0 24px 18px; }
        .stele-dialog-footer button {
            padding: 8px 20px; border-radius: 6px; font-size: 13px; font-weight: 600;
            cursor: pointer; border: 1px solid #ccc; transition: background 0.15s;
        }
        .stele-dialog-btn-cancel { background: #f5f5f5; color: #333; }
        .stele-dialog-btn-cancel:hover { background: #e8e8e8; }
        .stele-dialog-btn-ok { background: var(--stele-green); color: #fff; border-color: var(--stele-green); }
        .stele-dialog-btn-ok:hover { opacity: 0.9; }
    </style>
</head>
<body>
    <div class="app-wrapper">
        <nav class="nav-bar">
            <span class="nav-logo">stele</span>
            <div class="nav-links">
                <a href="app.html" class="nav-back">&larr; Menu</a>
            </div>
            <div class="nav-user">
                <span class="nav-user-email" id="userEmail"></span>
                <button class="btn-logout" onclick="handleLogout()">D&eacute;connexion</button>
            </div>
        </nav>

        <main class="app-content">
            <div class="page-title">Administration</div>
            <div class="page-sub">G&eacute;rez les permissions d'acc&egrave;s et les r&ocirc;les utilisateurs.</div>

            <!-- Permissions par role -->
            <div class="section collapsed" id="sectionPerm">
                <div class="section-toggle" onclick="toggleSection('sectionPerm')">
                    <div class="section-toggle-left">
                        <div class="section-title">Permissions par r&ocirc;le</div>
                        <div class="section-desc">D&eacute;finissez quels outils sont accessibles pour chaque r&ocirc;le.</div>
                    </div>
                    <svg class="section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="section-content">
                    <div style="overflow-x:auto;">
                    <table class="perm-table">
                        <thead><tr id="permHead"></tr></thead>
                        <tbody id="permBody"></tbody>
                    </table>
                    </div>
                    <div class="save-bar">
                        <button class="btn-save" onclick="savePermissions()">Sauvegarder les permissions</button>
                        <span class="save-feedback" id="permFeedback"></span>
                    </div>
                </div>
            </div>

            <!-- Gestion des rôles -->
            <div class="section collapsed" id="sectionManageRoles">
                <div class="section-toggle" onclick="toggleSection('sectionManageRoles')">
                    <div class="section-toggle-left">
                        <div class="section-title">Gestion des r&ocirc;les</div>
                        <div class="section-desc">Cr&eacute;ez, modifiez et supprimez les r&ocirc;les disponibles dans le syst&egrave;me.</div>
                    </div>
                    <svg class="section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="section-content">
                    <table class="roles-table">
                        <thead>
                            <tr>
                                <th style="width:25%">Nom du r&ocirc;le</th>
                                <th style="width:50%">Description</th>
                                <th style="width:15%">Type</th>
                                <th style="width:10%"></th>
                            </tr>
                        </thead>
                        <tbody id="manageRolesBody"></tbody>
                    </table>
                    <button class="btn-add" onclick="openRoleModal()">+ Nouveau r&ocirc;le</button>
                </div>
            </div>

            <!-- Attribution des roles -->
            <div class="section collapsed" id="sectionRoles">
                <div class="section-toggle" onclick="toggleSection('sectionRoles')">
                    <div class="section-toggle-left">
                        <div class="section-title">Attribution des r&ocirc;les</div>
                        <div class="section-desc">Assignez un r&ocirc;le &agrave; chaque utilisateur par courriel.</div>
                    </div>
                    <svg class="section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="section-content">
                    <table class="roles-table">
                        <thead>
                            <tr>
                                <th style="width:20%">Nom</th>
                                <th style="width:25%">Courriel</th>
                                <th style="width:15%">T&eacute;l&eacute;phone</th>
                                <th style="width:20%">Entreprise</th>
                                <th style="width:15%">R&ocirc;le</th>
                                <th style="width:5%"></th>
                            </tr>
                        </thead>
                        <tbody id="rolesBody"></tbody>
                    </table>
                    <button class="btn-add" onclick="addUserRow()">+ Ajouter un utilisateur</button>
                    <div class="save-bar">
                        <button class="btn-save" onclick="saveUserRoles()">Sauvegarder les r&ocirc;les</button>
                        <span class="save-feedback" id="rolesFeedback"></span>
                    </div>
                </div>
            </div>

            <!-- Categories du catalogue -->
            <div class="section collapsed" id="sectionCategories">
                <div class="section-toggle" onclick="toggleSection('sectionCategories')">
                    <div class="section-toggle-left">
                        <div class="section-title">Cat&eacute;gories du catalogue</div>
                        <div class="section-desc">G&eacute;rez les cat&eacute;gories disponibles pour classer les articles du catalogue.</div>
                    </div>
                    <svg class="section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="section-content">
                    <table class="roles-table">
                        <thead>
                            <tr>
                                <th style="width:85%">Cat&eacute;gorie</th>
                                <th style="width:15%"></th>
                            </tr>
                        </thead>
                        <tbody id="categoriesBody"></tbody>
                    </table>
                    <button class="btn-add" onclick="addCategoryRow()">+ Ajouter une cat&eacute;gorie</button>
                    <div class="save-bar">
                        <button class="btn-save" onclick="saveCategories()">Sauvegarder les cat&eacute;gories</button>
                        <span class="save-feedback" id="categoriesFeedback"></span>
                    </div>
                </div>
            </div>

            <!-- Tags medias -->
            <div class="section collapsed" id="sectionTags">
                <div class="section-toggle" onclick="toggleSection('sectionTags')">
                    <div class="section-toggle-left">
                        <div class="section-title">Tags m&eacute;dias</div>
                        <div class="section-desc">G&eacute;rez les &eacute;tiquettes pour organiser les images et documents.</div>
                    </div>
                    <svg class="section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="section-content">
                    <table class="roles-table">
                        <thead>
                            <tr>
                                <th style="width:85%">&Eacute;tiquette</th>
                                <th style="width:15%"></th>
                            </tr>
                        </thead>
                        <tbody id="tagsBody"></tbody>
                    </table>
                    <button class="btn-add" onclick="addTagRow()">+ Ajouter un tag</button>
                    <div class="save-bar">
                        <button class="btn-save" onclick="saveMediaTags()">Sauvegarder les tags</button>
                        <span class="save-feedback" id="tagsFeedback"></span>
                    </div>
                </div>
            </div>
            <!-- Types d'entreprise -->
            <div class="section collapsed" id="sectionCompanyTypes">
                <div class="section-toggle" onclick="toggleSection('sectionCompanyTypes')">
                    <div class="section-toggle-left">
                        <div class="section-title">Types d'entreprise</div>
                        <div class="section-desc">G&eacute;rez les types disponibles pour classer les entreprises (CRM).</div>
                    </div>
                    <svg class="section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="section-content">
                    <table class="roles-table">
                        <thead><tr><th style="width:85%">Type</th><th style="width:15%"></th></tr></thead>
                        <tbody id="companyTypesBody"></tbody>
                    </table>
                    <button class="btn-add" onclick="addCompanyTypeRow()">+ Ajouter un type</button>
                    <div class="save-bar">
                        <button class="btn-save" onclick="saveCompanyTypes()">Sauvegarder les types</button>
                        <span class="save-feedback" id="companyTypesFeedback"></span>
                    </div>
                </div>
            </div>

            <!-- R&ocirc;les de contact -->
            <div class="section collapsed" id="sectionContactRoles">
                <div class="section-toggle" onclick="toggleSection('sectionContactRoles')">
                    <div class="section-toggle-left">
                        <div class="section-title">R&ocirc;les de contact</div>
                        <div class="section-desc">R&ocirc;les possibles d'un contact dans une entreprise (CRM).</div>
                    </div>
                    <svg class="section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="section-content">
                    <table class="roles-table">
                        <thead><tr><th style="width:85%">R&ocirc;le</th><th style="width:15%"></th></tr></thead>
                        <tbody id="contactRolesBody"></tbody>
                    </table>
                    <button class="btn-add" onclick="addContactRoleRow()">+ Ajouter un r&ocirc;le</button>
                    <div class="save-bar">
                        <button class="btn-save" onclick="saveContactRoles()">Sauvegarder les r&ocirc;les</button>
                        <span class="save-feedback" id="contactRolesFeedback"></span>
                    </div>
                </div>
            </div>

            <!-- Types de communication -->
            <div class="section collapsed" id="sectionCommTypes">
                <div class="section-toggle" onclick="toggleSection('sectionCommTypes')">
                    <div class="section-toggle-left">
                        <div class="section-title">Types de communication</div>
                        <div class="section-desc">Types d'&eacute;changes pour le suivi des communications (CRM).</div>
                    </div>
                    <svg class="section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="section-content">
                    <table class="roles-table">
                        <thead><tr><th style="width:85%">Type</th><th style="width:15%"></th></tr></thead>
                        <tbody id="commTypesBody"></tbody>
                    </table>
                    <button class="btn-add" onclick="addCommTypeRow()">+ Ajouter un type</button>
                    <div class="save-bar">
                        <button class="btn-save" onclick="saveCommTypes()">Sauvegarder les types</button>
                        <span class="save-feedback" id="commTypesFeedback"></span>
                    </div>
                </div>
            </div>

            <!-- Catégories de dépenses -->
            <div class="section collapsed" id="sectionExpenses">
                <div class="section-toggle" onclick="toggleSection('sectionExpenses')">
                    <div class="section-toggle-left">
                        <div class="section-title">Cat&eacute;gories de d&eacute;penses</div>
                        <div class="section-desc">G&eacute;rez les cat&eacute;gories de d&eacute;penses mat&eacute;riaux et leur markup par d&eacute;faut.</div>
                    </div>
                    <svg class="section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="section-content">
                    <table class="roles-table" id="expensesTable">
                        <thead>
                            <tr>
                                <th style="width:50%">Cat&eacute;gorie</th>
                                <th style="width:20%">Markup (%)</th>
                                <th style="width:20%">Perte (%)</th>
                                <th style="width:10%"></th>
                            </tr>
                        </thead>
                        <tbody id="expensesBody"></tbody>
                    </table>
                    <button class="btn-add" onclick="addExpenseRow()">+ Ajouter une cat&eacute;gorie de d&eacute;pense</button>
                    <div class="save-bar">
                        <button class="btn-save" onclick="saveExpenseCategories()">Sauvegarder les d&eacute;penses</button>
                        <span class="save-feedback" id="expensesFeedback"></span>
                    </div>
                </div>
            </div>

            <!-- Données de base — Taux horaires -->
            <div class="section collapsed" id="sectionTaux">
                <div class="section-toggle" onclick="toggleSection('sectionTaux')">
                    <div class="section-toggle-left">
                        <div class="section-title">Donn&eacute;es de base</div>
                        <div class="section-desc">Taux horaires par d&eacute;partement &mdash; frais fixe, salaire et profit.</div>
                    </div>
                    <svg class="section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="section-content">
                    <table class="roles-table" id="tauxTable">
                        <thead>
                            <tr>
                                <th>D&eacute;partement</th>
                                <th style="width:18%">Taux horaire</th>
                                <th style="width:18%">Frais fixe</th>
                                <th style="width:18%">Salaire</th>
                                <th style="width:14%">Profit</th>
                            </tr>
                        </thead>
                        <tbody id="tauxBody"></tbody>
                    </table>
                    <div class="save-bar">
                        <button class="btn-save" onclick="saveTaux()">Sauvegarder les taux</button>
                        <span class="save-feedback" id="tauxFeedback"></span>
                    </div>
                </div>
            </div>

            <!-- Nomenclature des tags -->
            <div class="section collapsed" id="sectionTagPrefixes">
                <div class="section-toggle" onclick="toggleSection('sectionTagPrefixes')">
                    <div class="section-toggle-left">
                        <div class="section-title">Nomenclature des tags</div>
                        <div class="section-desc">Pr&eacute;fixes utilis&eacute;s pour identifier les &eacute;l&eacute;ments sur les plans (C1, F2, P3, etc.)</div>
                    </div>
                    <svg class="section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="section-content">
                    <table class="roles-table" id="tagPrefixTable">
                        <thead>
                            <tr>
                                <th style="width:15%">Pr&eacute;fixe</th>
                                <th>Label</th>
                                <th style="width:10%"></th>
                            </tr>
                        </thead>
                        <tbody id="tagPrefixBody"></tbody>
                    </table>
                    <div class="save-bar">
                        <button class="btn-outline" onclick="addTagPrefix()" style="margin-right:8px;">+ Ajouter</button>
                        <button class="btn-save" onclick="saveTagPrefixes()">Sauvegarder les tags</button>
                        <span class="save-feedback" id="tagsFeedback"></span>
                    </div>
                </div>
            </div>

            <div class="section collapsed" id="sectionAiPrompts">
                <div class="section-toggle" onclick="toggleSection('sectionAiPrompts')">
                    <div class="section-toggle-left">
                        <div class="section-title">Prompts AI</div>
                        <div class="section-desc">Personnaliser les instructions syst&egrave;me des assistants AI.</div>
                    </div>
                    <svg class="section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="section-content">
                    <p style="font-size:13px; color:#888; margin-bottom:16px;">
                        Modifiez le prompt syst&egrave;me de chaque assistant. Les donn&eacute;es dynamiques (projet, catalogue, taux) sont inject&eacute;es automatiquement par le code.
                        Les changements s'appliquent imm&eacute;diatement (pas besoin de red&eacute;ployer).
                    </p>
                    <div style="display:flex; gap:12px; align-items:center; margin-bottom:16px;">
                        <label style="font-size:13px; font-weight:600; color:#374151; white-space:nowrap;">Assistant :</label>
                        <select id="aiPromptSelector" onchange="switchAiPrompt()" style="flex:1; max-width:300px; padding:8px 12px; border:1px solid #d1d5db; border-radius:8px; font-size:13px; background:#fff; cursor:pointer;">
                            <option value="ai_prompt_estimateur">Assistant estimateur</option>
                            <option value="ai_prompt_catalogue_import">Import catalogue</option>
                        </select>
                        <span id="aiPromptStatus" style="font-size:11px; color:#aaa;"></span>
                    </div>
                    <textarea id="aiPromptTextarea" style="width:100%; min-height:500px; font-family:'SF Mono','Cascadia Code','Consolas',monospace; font-size:12px; line-height:1.6; padding:14px; border:1px solid #d1d5db; border-radius:8px; resize:vertical; box-sizing:border-box; color:#1f2937; tab-size:2;"></textarea>
                    <div style="display:flex; gap:8px; margin-top:12px; align-items:center;">
                        <button class="btn-save" onclick="saveAiPrompt()">Sauvegarder</button>
                        <button class="btn-outline" onclick="resetAiPrompt()">R&eacute;initialiser (d&eacute;faut)</button>
                        <span class="save-feedback" id="aiPromptFeedback"></span>
                    </div>
                </div>
            </div>

            <div class="section collapsed" id="sectionCoverImage">
                <div class="section-toggle" onclick="toggleSection('sectionCoverImage')">
                    <div class="section-toggle-left">
                        <div class="section-title">Image de couverture</div>
                        <div class="section-desc">Image de fond plein &eacute;cran sur la page de couverture des soumissions client.</div>
                    </div>
                    <svg class="section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="section-content">
                    <div style="display:flex; gap:24px; align-items:flex-start; flex-wrap:wrap;">
                        <div style="flex:1; min-width:280px;">
                            <p style="font-size:13px; color:#888; margin-bottom:16px;">
                                Cette image appara&icirc;t en arri&egrave;re-plan plein &eacute;cran sur la page de couverture des soumissions client.
                                Format recommand&eacute; : JPEG ou PNG, ratio paysage (16:9), haute r&eacute;solution.
                                L'image est compress&eacute;e automatiquement avant l'upload. Si aucune image n'est configur&eacute;e, un fond sombre uni sera affich&eacute;.
                            </p>
                            <label class="btn-outline" style="cursor:pointer; display:inline-block;">
                                Choisir une image
                                <input type="file" id="coverImageInput" accept="image/*" onchange="uploadCoverImage(this)" style="display:none;">
                            </label>
                            <button class="btn-outline" onclick="removeCoverImage()" style="margin-left:8px; color:#c00;">Supprimer</button>
                            <span class="save-feedback" id="coverFeedback"></span>
                        </div>
                        <div id="coverImagePreview" style="width:240px; height:320px; border-radius:8px; overflow:hidden; background:#0B0F17; border:1px solid #e0e0e0; display:flex; align-items:center; justify-content:center;">
                            <span style="color:#666; font-size:13px;" id="coverImagePlaceholder">Aucune image</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statuts du pipeline -->
            <div class="section collapsed" id="sectionPipelineStatuses">
                <div class="section-toggle" onclick="toggleSection('sectionPipelineStatuses')">
                    <div class="section-toggle-left">
                        <div class="section-title">Statuts du pipeline</div>
                        <div class="section-desc">G&eacute;rez les &eacute;tapes du pipeline commercial (projets).</div>
                    </div>
                    <svg class="section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="section-content">
                    <table class="roles-table" id="pipelineStatusesTable">
                        <thead>
                            <tr>
                                <th style="width:40%">Label</th>
                                <th style="width:15%">Couleur</th>
                                <th style="width:35%">Slug</th>
                                <th style="width:10%"></th>
                            </tr>
                        </thead>
                        <tbody id="pipelineStatusesBody"></tbody>
                    </table>
                    <button class="btn-add" onclick="addPipelineStatusRow()">+ Ajouter un statut</button>
                    <div class="save-bar">
                        <button class="btn-save" onclick="savePipelineStatuses()">Sauvegarder les statuts</button>
                        <span class="save-feedback" id="pipelineStatusesFeedback"></span>
                    </div>
                </div>
            </div>

            <!-- Sources de projet -->
            <div class="section collapsed" id="sectionProjectSources">
                <div class="section-toggle" onclick="toggleSection('sectionProjectSources')">
                    <div class="section-toggle-left">
                        <div class="section-title">Sources de projet</div>
                        <div class="section-desc">D'o&ugrave; proviennent les projets (AO, r&eacute;f&eacute;rence, direct, etc.).</div>
                    </div>
                    <svg class="section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="section-content">
                    <table class="roles-table">
                        <thead><tr><th style="width:85%">Source</th><th style="width:15%"></th></tr></thead>
                        <tbody id="projectSourcesBody"></tbody>
                    </table>
                    <button class="btn-add" onclick="addProjectSourceRow()">+ Ajouter une source</button>
                    <div class="save-bar">
                        <button class="btn-save" onclick="saveProjectSources()">Sauvegarder les sources</button>
                        <span class="save-feedback" id="projectSourcesFeedback"></span>
                    </div>
                </div>
            </div>

            <!-- Types de projet -->
            <div class="section collapsed" id="sectionProjectTypes">
                <div class="section-toggle" onclick="toggleSection('sectionProjectTypes')">
                    <div class="section-toggle-left">
                        <div class="section-title">Types de projet</div>
                        <div class="section-desc">Classification des projets (r&eacute;sidentiel, commercial, institutionnel, etc.).</div>
                    </div>
                    <svg class="section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="section-content">
                    <table class="roles-table">
                        <thead><tr><th style="width:85%">Type</th><th style="width:15%"></th></tr></thead>
                        <tbody id="projectTypesBody"></tbody>
                    </table>
                    <button class="btn-add" onclick="addProjectTypeRow()">+ Ajouter un type</button>
                    <div class="save-bar">
                        <button class="btn-save" onclick="saveProjectTypes()">Sauvegarder les types</button>
                        <span class="save-feedback" id="projectTypesFeedback"></span>
                    </div>
                </div>
            </div>
        </main>

        <footer class="app-footer">stele — stele.ca</footer>
    </div>

    <!-- Role management modal -->
    <div class="role-modal" id="roleModal" onclick="if(event.target === this) closeRoleModal()">
        <div class="role-modal-content">
            <div class="role-modal-header">
                <h2 class="role-modal-title" id="roleModalTitle">Nouveau r&ocirc;le</h2>
                <button class="role-modal-close" onclick="closeRoleModal()">&times;</button>
            </div>
            <div class="role-modal-body">
                <div class="role-form-group">
                    <label class="role-form-label">Nom du r&ocirc;le *</label>
                    <input type="text" class="role-form-input" id="roleNameInput" placeholder="Ex: Gestionnaire">
                </div>
                <div class="role-form-group">
                    <label class="role-form-label">Description</label>
                    <textarea class="role-form-input role-form-textarea" id="roleDescInput" placeholder="Description du r&ocirc;le et de ses responsabilit&eacute;s"></textarea>
                </div>
                <div class="role-form-group">
                    <label class="role-form-label">Permissions</label>
                    <div class="role-perm-grid" id="rolePermChecks">
                        <script>
                        // Generate checkboxes for all permissions
                        document.write((function() {
                            var html = '';
                            for (var i = 0; i < PAGES.length; i++) {
                                var page = PAGES[i];
                                html += '<div class="role-perm-item">' +
                                    '<input type="checkbox" id="rolePerm_' + page.key + '">' +
                                    '<label for="rolePerm_' + page.key + '">' + page.label + '</label>' +
                                    '</div>';
                            }
                            return html;
                        })());
                        </script>
                    </div>
                </div>
            </div>
            <div class="role-modal-footer">
                <button class="btn-modal btn-modal-cancel" onclick="closeRoleModal()">Annuler</button>
                <button class="btn-modal btn-modal-save" id="roleSaveBtn" onclick="saveRole()">Sauvegarder</button>
            </div>
        </div>
    </div>

    <!-- Stele dialog -->
    <div class="stele-dialog-overlay" id="steleDialogOverlay">
        <div class="stele-dialog">
            <div class="stele-dialog-header"><h3 id="steleDialogTitle"></h3></div>
            <div class="stele-dialog-body"><p id="steleDialogMessage"></p></div>
            <div class="stele-dialog-footer">
                <button class="stele-dialog-btn-cancel" id="steleDialogCancel" onclick="steleDialogResolve(null)">Annuler</button>
                <button class="stele-dialog-btn-ok" id="steleDialogOk" onclick="steleDialogResolve(true)">Confirmer</button>
            </div>
        </div>
    </div>

    <script>
    /*
     * Pour activer la sauvegarde partagee dans Supabase, executez ce SQL
     * dans le SQL Editor de votre projet Supabase :
     *
     * CREATE TABLE app_config (
     *   key TEXT PRIMARY KEY,
     *   value JSONB NOT NULL,
     *   updated_at TIMESTAMPTZ DEFAULT now()
     * );
     * ALTER TABLE app_config ENABLE ROW LEVEL SECURITY;
     * CREATE POLICY "auth_read" ON app_config FOR SELECT TO authenticated USING (true);
     * CREATE POLICY "auth_write" ON app_config FOR ALL TO authenticated USING (true) WITH CHECK (true);
     *
     * Sans cette table, les donnees sont sauvegardees localement (navigateur uniquement).
     */

    // ── Stele Dialog ──
    var _steleDialogResolve = null;
    function steleDialogResolve(val) {
        document.getElementById('steleDialogOverlay').classList.remove('active');
        if (_steleDialogResolve) { var fn = _steleDialogResolve; _steleDialogResolve = null; fn(val); }
    }
    function steleConfirm(msg, title) {
        return new Promise(function(resolve) {
            _steleDialogResolve = resolve;
            document.getElementById('steleDialogTitle').textContent = title || 'Confirmation';
            document.getElementById('steleDialogMessage').textContent = msg;
            document.getElementById('steleDialogOverlay').classList.add('active');
        });
    }

    var SUPABASE_URL = 'https://rplzbtjfnwahqodrhpny.supabase.co';
    var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJwbHpidGpmbndhaHFvZHJocG55Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NDU2MDEsImV4cCI6MjA4NjIyMTYwMX0.OQAZhc029PbRDSe1b02NDAuOUE8yn-_h3QqSnUDpLeU';

    // ── Pages (ajouter ici = nouvelle colonne automatique) ──
    var PAGES = [
        { key: 'catalogue', label: 'Catalogue' },
        { key: 'catalogue_edit', label: 'Modifier catalogue' },
        { key: 'calculateur', label: 'Calculateur' },
        { key: 'clients', label: 'Clients' },
        { key: 'documents', label: 'Documents' },
        { key: 'assistant', label: 'Assistant vente' },
        { key: 'admin', label: 'Administration' },
        { key: 'approbation', label: 'Approbations' },
        { key: 'edit_minutes', label: 'Modifier minutes' },
        { key: 'edit_materials', label: 'Modifier mat\u00e9riaux' },
        { key: 'can_approve_quotes', label: 'Approuver soumissions' },
        { key: 'can_bypass_approval', label: 'Bypass approbation' },
        { key: 'can_unlock_submission', label: 'D\u00e9verrouiller soumissions' }
    ];

    var ROLES = ['Admin', 'Vente', 'Charg\u00e9 de projet', 'Achat', 'Atelier', 'Client'];

    var DEFAULT_PERMISSIONS = {
        'Admin':             { catalogue: true,  catalogue_edit: true,  calculateur: true,  clients: true,  documents: true,  assistant: true,  approbation: true,  admin: true,  edit_minutes: true,  edit_materials: true,  can_approve_quotes: true,  can_bypass_approval: true,  can_unlock_submission: true  },
        'Vente':             { catalogue: true,  catalogue_edit: true,  calculateur: true,  clients: true,  documents: true,  assistant: true,  approbation: false, admin: false, edit_minutes: false, edit_materials: false, can_approve_quotes: false, can_bypass_approval: false, can_unlock_submission: false },
        'Charg\u00e9 de projet': { catalogue: true,  catalogue_edit: false, calculateur: true,  clients: true,  documents: true,  assistant: false, approbation: false, admin: false, edit_minutes: false, edit_materials: false, can_approve_quotes: false, can_bypass_approval: false, can_unlock_submission: false },
        'Achat':             { catalogue: true,  catalogue_edit: false, calculateur: false, clients: false, documents: true,  assistant: false, approbation: false, admin: false, edit_minutes: false, edit_materials: true,  can_approve_quotes: false, can_bypass_approval: false, can_unlock_submission: false },
        'Atelier':           { catalogue: false, catalogue_edit: false, calculateur: false, clients: false, documents: true,  assistant: false, approbation: false, admin: false, edit_minutes: false, edit_materials: false, can_approve_quotes: false, can_bypass_approval: false, can_unlock_submission: false },
        'Client':            { catalogue: false, catalogue_edit: false, calculateur: false, clients: false, documents: false, assistant: false, approbation: false, admin: false, edit_minutes: false, edit_materials: false, can_approve_quotes: false, can_bypass_approval: false, can_unlock_submission: false }
    };

    var DEFAULT_USER_ROLES = { 'hubert@stele.ca': 'Admin' };

    // ═══════════════════════════════════════════════════════════════════════
    // REFRESH AUTOMATIQUE DU TOKEN
    // ═══════════════════════════════════════════════════════════════════════

    async function refreshAccessToken() {
        var refreshToken = localStorage.getItem('sb_refresh_token');
        if (!refreshToken) return false;
        try {
            var response = await fetch(SUPABASE_URL + '/auth/v1/token?grant_type=refresh_token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'apikey': SUPABASE_KEY },
                body: JSON.stringify({ refresh_token: refreshToken })
            });
            if (!response.ok) return false;
            var data = await response.json();
            if (data.access_token) {
                localStorage.setItem('sb_access_token', data.access_token);
                localStorage.setItem('sb_refresh_token', data.refresh_token);
                return true;
            }
            return false;
        } catch (e) { return false; }
    }

    async function authenticatedFetch(url, options) {
        var tok = localStorage.getItem('sb_access_token');
        var headers = Object.assign({}, options.headers || {}, {
            'apikey': SUPABASE_KEY,
            'Authorization': 'Bearer ' + tok
        });
        var resp = await fetch(url, Object.assign({}, options, { headers: headers }));
        if (resp.status === 401) {
            var refreshed = await refreshAccessToken();
            if (refreshed) {
                headers['Authorization'] = 'Bearer ' + localStorage.getItem('sb_access_token');
                resp = await fetch(url, Object.assign({}, options, { headers: headers }));
            } else {
                localStorage.removeItem('sb_access_token');
                localStorage.removeItem('sb_refresh_token');
                window.location.href = 'login.html';
                return resp;
            }
        }
        return resp;
    }

    function checkPageAccess() {
        var email = (localStorage.getItem('sb_user_email') || '').toLowerCase();
        var roles = Object.keys(userRolesMap).length ? userRolesMap : DEFAULT_USER_ROLES;
        var role = roles[email] || 'Client';
        var perms = Object.keys(permissions).length ? permissions : DEFAULT_PERMISSIONS;
        var defaults = DEFAULT_PERMISSIONS[role] || {};
        var saved = perms[role] || {};
        var allowed = {};
        for (var k in defaults) allowed[k] = defaults[k];
        for (var k2 in saved) allowed[k2] = saved[k2];
        if (!allowed.admin) { window.location.href = 'app.html'; return false; }
        return true;
    }

    var permissions = {};
    var userRolesMap = {};
    var userProfiles = {}; // { email: { name, phone, company } }
    var rolesFromDB = []; // Roles loaded from database
    var mediaTags = [];
    var catalogueCategories = [];
    var DEFAULT_MEDIA_TAGS = ['fiche_client', 'catalogue', 'technique', 'dessin'];
    var DEFAULT_CATEGORIES = ['Budg\u00e9taire', 'Panneaux', 'Poign\u00e9es', 'Tiroirs', '\u00c9clairage', 'Portes int\u00e9rieures'];
    var DEPARTMENTS = [
        'Gestion/dessin', 'Coupe/edge', 'Assemblage',
        'Machinage', 'Sablage', 'Peinture', 'Installation'
    ];
    var tauxHoraires = [];
    var DEFAULT_EXPENSE_CATEGORIES = [
        {name:'BANDE DE CHANT',markup:30,waste:0},{name:'BOIS BRUT',markup:30,waste:0},{name:'COLLAGE DE BOIS',markup:30,waste:0},
        {name:'D\u00c9COUPE NUM\u00c9RIQUE',markup:30,waste:0},{name:'D\u00c9M\u00c9NAGEMENT',markup:30,waste:0},{name:'DIVERS',markup:30,waste:0},
        {name:'\u00c9CLAIRAGE',markup:30,waste:0},{name:'FINITION BOIS',markup:30,waste:0},{name:'FINITION OPAQUE',markup:30,waste:0},
        {name:'FINITION TEINTURE',markup:30,waste:0},{name:'FOURNITURE BUREAU',markup:30,waste:0},{name:"FOURNITURE D'ATELIER",markup:30,waste:0},
        {name:'M\u00c9TAL',markup:30,waste:0},{name:'PANNEAU BOIS',markup:30,waste:0},{name:'PANNEAU MDF',markup:30,waste:0},
        {name:'PANNEAU M\u00c9LAMINE',markup:30,waste:0},{name:'PLACAGE',markup:30,waste:0},{name:'POIGN\u00c9ES',markup:30,waste:0},
        {name:'QUINCAILLERIE',markup:30,waste:0},{name:'SOUS TRAITANCE',markup:30,waste:0},{name:'STRATIFI\u00c9',markup:30,waste:0},
        {name:'TIROIRS',markup:30,waste:0},{name:'VITRIER',markup:30,waste:0},{name:'PORTES SOUS TRAITANCE',markup:30,waste:0}
    ];
    var expenseCategories = [];
    var companyTypes = [];
    var contactRoles = [];
    var communicationTypes = [];
    var tagPrefixes = [];
    var DEFAULT_TAG_PREFIXES = [
        { prefix: 'C', label_fr: 'Caisson', label_en: 'Cabinet', sort_order: 1 },
        { prefix: 'F', label_fr: 'Filler', label_en: 'Filler', sort_order: 2 },
        { prefix: 'P', label_fr: 'Panneau', label_en: 'Panel', sort_order: 3 },
        { prefix: 'T', label_fr: 'Tiroir', label_en: 'Drawer', sort_order: 4 },
        { prefix: 'M', label_fr: 'Moulure', label_en: 'Moulding', sort_order: 5 },
        { prefix: 'A', label_fr: 'Accessoire', label_en: 'Accessory', sort_order: 6 }
    ];
    var DEFAULT_COMPANY_TYPES = ['Designer', 'Architecte', 'Entrepreneur', 'Promoteur', 'Particulier', 'Autre'];
    var DEFAULT_CONTACT_ROLES = ['Propri\u00e9taire', 'Designer principal', 'Architecte', 'Charg\u00e9 de projet', 'Adjoint(e)', 'Comptabilit\u00e9', 'Autre'];
    var DEFAULT_COMM_TYPES = ['Appel', 'Courriel', 'Texto', 'Rencontre', 'Note'];

    var DEFAULT_PIPELINE_STATUSES = [
        {slug:'a_contacter',label:'A contacter',color:'#9e9e9e',sort_order:1},
        {slug:'en_attente_infos',label:'En attente d\'infos',color:'#ff9800',sort_order:2},
        {slug:'a_soumissionner',label:'A soumissionner',color:'#2196f3',sort_order:3},
        {slug:'en_revision',label:'En revision',color:'#9c27b0',sort_order:4},
        {slug:'a_presenter',label:'A presenter',color:'#00bcd4',sort_order:5},
        {slug:'envoye',label:'Envoye',color:'#3f51b5',sort_order:6},
        {slug:'en_discussions',label:'En discussions',color:'#ff5722',sort_order:7},
        {slug:'vendu',label:'Vendu',color:'#4caf50',sort_order:8},
        {slug:'perdu',label:'Perdu',color:'#f44336',sort_order:9}
    ];
    var DEFAULT_PROJECT_SOURCES = ['AO sous invitation','R\u00e9f\u00e9rence','Direct','Site web','Salon/Expo','Bouche-\u00e0-oreille'];
    var DEFAULT_PROJECT_TYPES = ['R\u00e9sidentiel','R\u00e9sidentiel d\'envergure','Commercial','Collaboration','Autre'];
    var pipelineStatuses = [];
    var projectSources = [];
    var projectTypes = [];

    // ── Helper functions ──

    function escapeAttr(str) {
        return (str || '').replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;');
    }

    // Returns the active list of roles (from DB if available, otherwise hardcoded)
    function getActiveRoles() {
        if (rolesFromDB.length > 0) {
            return rolesFromDB.map(function(r) { return r.name; });
        }
        return ROLES.slice();
    }

    // Get permissions for a role (always from app_config permissions object)
    function getRolePermissions(roleName) {
        return permissions[roleName] || {};
    }

    // ── Toggle sections ──
    function toggleSection(id) {
        document.getElementById(id).classList.toggle('collapsed');
    }

    // Init
    document.getElementById('userEmail').textContent = localStorage.getItem('sb_user_email') || '';
    loadConfig();

    async function loadUserProfiles() {
        try {
            // Fetch user profiles with contact and company data
            var r = await authenticatedFetch(
                SUPABASE_URL + '/rest/v1/user_profiles?select=user_id,contact_id,contacts(first_name,last_name,phone,email,contact_companies(companies(name)))',
                {}
            );
            if (!r.ok) return;
            var profiles = await r.json();

            // Build map: email -> { name, phone, company }
            userProfiles = {};
            for (var i = 0; i < profiles.length; i++) {
                var p = profiles[i];
                if (!p.contacts) continue;
                var contact = p.contacts;
                var email = contact.email;
                var name = (contact.first_name || '') + ' ' + (contact.last_name || '');
                name = name.trim() || '—';
                var phone = contact.phone || '—';
                var company = '—';
                if (contact.contact_companies && contact.contact_companies.length > 0) {
                    var cc = contact.contact_companies[0];
                    if (cc.companies) company = cc.companies.name;
                }
                userProfiles[email] = { name: name, phone: phone, company: company };
            }
        } catch (e) {
            console.error('Error loading user profiles:', e);
        }
    }

    async function loadRoles() {
        try {
            var r = await authenticatedFetch(
                SUPABASE_URL + '/rest/v1/roles?select=*&order=sort_order.asc,name.asc',
                {}
            );
            if (!r.ok) {
                console.warn('Could not load roles from database, using hardcoded roles');
                return;
            }
            var roles = await r.json();
            if (roles && roles.length > 0) {
                rolesFromDB = roles;
                console.log('Loaded ' + roles.length + ' roles from database');
            }
        } catch (e) {
            console.error('Error loading roles:', e);
        }
    }

    async function loadUserRoles() {
        try {
            var r = await authenticatedFetch(
                SUPABASE_URL + '/rest/v1/user_roles?select=email,role_id,roles(name)',
                {}
            );
            if (!r.ok) {
                console.warn('Could not load user roles from database, using app_config fallback');
                return;
            }
            var assignments = await r.json();
            if (assignments && assignments.length > 0) {
                // Build map: email -> role name
                userRolesMap = {};
                for (var i = 0; i < assignments.length; i++) {
                    var a = assignments[i];
                    if (a.roles && a.roles.name) {
                        userRolesMap[a.email.toLowerCase()] = a.roles.name;
                    }
                }
                console.log('Loaded ' + assignments.length + ' user role assignments from database');
            }
        } catch (e) {
            console.error('Error loading user roles:', e);
        }
    }

    function loadConfig() {
        authenticatedFetch(SUPABASE_URL + '/rest/v1/app_config?select=key,value', {})
        .then(function(r) {
            if (!r.ok) throw new Error('not available');
            return r.json();
        })
        .then(async function(rows) {
            if (Array.isArray(rows)) {
                for (var i = 0; i < rows.length; i++) {
                    if (rows[i].key === 'permissions') permissions = rows[i].value;
                    if (rows[i].key === 'user_roles') userRolesMap = rows[i].value;
                    if (rows[i].key === 'media_tags') mediaTags = rows[i].value;
                    if (rows[i].key === 'catalogue_categories') catalogueCategories = rows[i].value;
                    if (rows[i].key === 'taux_horaires') tauxHoraires = rows[i].value;
                    if (rows[i].key === 'expense_categories') expenseCategories = rows[i].value;
                    if (rows[i].key === 'company_types') companyTypes = rows[i].value;
                    if (rows[i].key === 'contact_roles') contactRoles = rows[i].value;
                    if (rows[i].key === 'communication_types') communicationTypes = rows[i].value;
                    if (rows[i].key === 'tag_prefixes') tagPrefixes = rows[i].value;
                    if (rows[i].key === 'pipeline_statuses') pipelineStatuses = rows[i].value;
                    if (rows[i].key === 'project_sources') projectSources = rows[i].value;
                    if (rows[i].key === 'project_types') projectTypes = rows[i].value;
                }
            }
            await loadUserProfiles();
            await loadRoles();
            await loadUserRoles(); // Load user role assignments from database
            applyDefaults();
            if (!checkPageAccess()) return;
            renderAll();
            loadAiPrompts(rows);
        })
        .catch(async function() {
            await loadUserProfiles();
            await loadRoles();
            await loadUserRoles(); // Load user role assignments from database
            applyDefaults();
            if (!checkPageAccess()) return;
            renderAll();
            loadAiPrompts([]);
        });
    }

    function applyDefaults() {
        if (!Object.keys(permissions).length) {
            permissions = JSON.parse(JSON.stringify(DEFAULT_PERMISSIONS));
        }
        // S'assurer que tous les roles et pages existent
        var activeRoles = getActiveRoles();
        for (var r = 0; r < activeRoles.length; r++) {
            var role = activeRoles[r];
            if (!permissions[role]) permissions[role] = {};
            for (var p = 0; p < PAGES.length; p++) {
                var pageKey = PAGES[p].key;
                if (permissions[role][pageKey] === undefined) {
                    var def = DEFAULT_PERMISSIONS[role];
                    permissions[role][pageKey] = def ? (def[pageKey] || false) : false;
                }
            }
        }
        if (!Object.keys(userRolesMap).length) {
            userRolesMap = JSON.parse(JSON.stringify(DEFAULT_USER_ROLES));
        }
        if (!Array.isArray(mediaTags) || !mediaTags.length) {
            mediaTags = DEFAULT_MEDIA_TAGS.slice();
        }
        if (!Array.isArray(catalogueCategories) || !catalogueCategories.length) {
            catalogueCategories = DEFAULT_CATEGORIES.slice();
        }
        if (!Array.isArray(tauxHoraires) || !tauxHoraires.length) {
            tauxHoraires = DEPARTMENTS.map(function(d) {
                return { department: d, taux_horaire: 0, frais_fixe: 0, salaire: 0 };
            });
        }
        DEPARTMENTS.forEach(function(d) {
            if (!tauxHoraires.find(function(t) { return t.department === d; })) {
                tauxHoraires.push({ department: d, taux_horaire: 0, frais_fixe: 0, salaire: 0 });
            }
        });
        if (!Array.isArray(expenseCategories) || !expenseCategories.length) {
            expenseCategories = JSON.parse(JSON.stringify(DEFAULT_EXPENSE_CATEGORIES));
        }
        if (!Array.isArray(companyTypes) || !companyTypes.length) {
            companyTypes = DEFAULT_COMPANY_TYPES.slice();
        }
        if (!Array.isArray(contactRoles) || !contactRoles.length) {
            contactRoles = DEFAULT_CONTACT_ROLES.slice();
        }
        if (!Array.isArray(communicationTypes) || !communicationTypes.length) {
            communicationTypes = DEFAULT_COMM_TYPES.slice();
        }
        if (!Array.isArray(tagPrefixes) || !tagPrefixes.length) {
            tagPrefixes = JSON.parse(JSON.stringify(DEFAULT_TAG_PREFIXES));
        }
        if (!Array.isArray(pipelineStatuses) || !pipelineStatuses.length) {
            pipelineStatuses = JSON.parse(JSON.stringify(DEFAULT_PIPELINE_STATUSES));
        }
        if (!Array.isArray(projectSources) || !projectSources.length) {
            projectSources = DEFAULT_PROJECT_SOURCES.slice();
        }
        if (!Array.isArray(projectTypes) || !projectTypes.length) {
            projectTypes = DEFAULT_PROJECT_TYPES.slice();
        }
    }

    function renderAll() {
        renderPermTable();
        renderManageRolesTable();
        renderRolesTable();
        renderCategoriesTable();
        renderTagsTable();
        renderTauxTable();
        renderExpensesTable();
        renderCompanyTypesTable();
        renderContactRolesTable();
        renderCommTypesTable();
        renderTagPrefixTable();
        renderPipelineStatusesTable();
        renderProjectSourcesTable();
        renderProjectTypesTable();
    }

    // ── Permissions table ──

    function renderPermTable() {
        var head = document.getElementById('permHead');
        var body = document.getElementById('permBody');

        var headHtml = '<th>R\u00f4le</th>';
        for (var p = 0; p < PAGES.length; p++) {
            headHtml += '<th>' + PAGES[p].label + '</th>';
        }
        head.innerHTML = headHtml;

        var activeRoles = getActiveRoles();
        var bodyHtml = '';
        for (var r = 0; r < activeRoles.length; r++) {
            var roleName = activeRoles[r];
            var rolePerms = getRolePermissions(roleName);

            bodyHtml += '<tr><td>' + roleName + '</td>';
            for (var p2 = 0; p2 < PAGES.length; p2++) {
                var pk = PAGES[p2].key;
                var checked = rolePerms[pk] ? ' checked' : '';
                bodyHtml += '<td><label class="toggle">' +
                    '<input type="checkbox" data-role="' + roleName + '" data-page="' + pk + '"' + checked + '>' +
                    '<span class="slider"></span></label></td>';
            }
            bodyHtml += '</tr>';
        }
        body.innerHTML = bodyHtml;
    }

    // ── Manage roles table ──

    function renderManageRolesTable() {
        var body = document.getElementById('manageRolesBody');
        if (!body) return;

        var html = '';
        var rolesToDisplay = rolesFromDB.length > 0 ? rolesFromDB : [];

        // If no roles from DB, show hardcoded roles as read-only reference
        if (rolesToDisplay.length === 0) {
            for (var i = 0; i < ROLES.length; i++) {
                html += '<tr>' +
                    '<td style="font-weight:500;">' + escapeHtml(ROLES[i]) + '</td>' +
                    '<td style="color:#888; font-size:13px;">R&ocirc;le syst&egrave;me (hardcoded)</td>' +
                    '<td><span style="background:#f0f0f0; padding:3px 8px; border-radius:3px; font-size:11px; color:#666;">SYST&Egrave;ME</span></td>' +
                    '<td></td>' +
                    '</tr>';
            }
        } else {
            for (var i = 0; i < rolesToDisplay.length; i++) {
                var role = rolesToDisplay[i];
                var isSystem = role.is_system || false;
                var typeLabel = isSystem ? 'SYST&Egrave;ME' : 'CUSTOM';
                var typeBg = isSystem ? '#f0f0f0' : '#e8f5e9';
                var typeColor = isSystem ? '#666' : '#2e7d32';

                html += '<tr>' +
                    '<td style="font-weight:500;">' + escapeHtml(role.name) + '</td>' +
                    '<td style="color:#666; font-size:13px;">' + escapeHtml(role.description || '—') + '</td>' +
                    '<td><span style="background:' + typeBg + '; padding:3px 8px; border-radius:3px; font-size:11px; color:' + typeColor + ';">' + typeLabel + '</span></td>' +
                    '<td style="text-align:right;">' +
                        '<button class="btn-remove" onclick="editRole(\'' + role.id + '\')" title="Modifier" style="color:#4b6050;">&bull;&bull;&bull;</button>' +
                        (isSystem ? '' : '<button class="btn-remove" onclick="deleteRole(\'' + role.id + '\')" title="Supprimer">&times;</button>') +
                    '</td>' +
                    '</tr>';
            }
        }

        body.innerHTML = html;
    }

    // ── User roles table ──

    function renderRolesTable() {
        var body = document.getElementById('rolesBody');
        var html = '';
        var emails = Object.keys(userRolesMap);
        for (var i = 0; i < emails.length; i++) {
            html += buildUserRowHtml(emails[i], userRolesMap[emails[i]]);
        }
        body.innerHTML = html;
    }

    function buildUserRowHtml(email, role) {
        var activeRoles = getActiveRoles();
        var options = '';
        for (var i = 0; i < activeRoles.length; i++) {
            var sel = (activeRoles[i] === role) ? ' selected' : '';
            options += '<option value="' + activeRoles[i] + '"' + sel + '>' + activeRoles[i] + '</option>';
        }

        // Get enriched data from user profiles
        var profile = userProfiles[email] || {};
        var name = profile.name || '—';
        var phone = profile.phone || '—';
        var company = profile.company || '—';

        return '<tr>' +
            '<td style="color:#555; font-weight:500;">' + escapeHtml(name) + '</td>' +
            '<td><input type="email" class="input-email" value="' + escapeHtml(email) + '" placeholder="nom@entreprise.ca"></td>' +
            '<td style="color:#888; font-size:12px;">' + escapeHtml(phone) + '</td>' +
            '<td style="color:#888; font-size:12px;">' + escapeHtml(company) + '</td>' +
            '<td><select class="select-role">' + options + '</select></td>' +
            '<td><button class="btn-remove" onclick="removeUserRow(this)" title="Retirer">&times;</button></td>' +
            '</tr>';
    }

    function addUserRow() {
        var body = document.getElementById('rolesBody');
        body.insertAdjacentHTML('beforeend', buildUserRowHtml('', 'Vente'));
        var inputs = body.querySelectorAll('.input-email');
        if (inputs.length) inputs[inputs.length - 1].focus();
    }

    async function removeUserRow(btn) {
        if (!await steleConfirm('Retirer cet utilisateur ?')) return;
        var row = btn.parentNode.parentNode;
        row.parentNode.removeChild(row);
    }

    function escapeHtml(str) {
        var div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    // ── Categories du catalogue table ──

    function renderCategoriesTable() {
        var body = document.getElementById('categoriesBody');
        var html = '';
        for (var i = 0; i < catalogueCategories.length; i++) {
            html += buildCategoryRowHtml(catalogueCategories[i]);
        }
        body.innerHTML = html;
    }

    function buildCategoryRowHtml(cat) {
        return '<tr>' +
            '<td><input type="text" class="input-email" value="' + escapeHtml(cat) + '" placeholder="Nom de la cat\u00e9gorie"></td>' +
            '<td><button class="btn-remove" onclick="removeCategoryRow(this)" title="Retirer">&times;</button></td>' +
            '</tr>';
    }

    function addCategoryRow() {
        var body = document.getElementById('categoriesBody');
        body.insertAdjacentHTML('beforeend', buildCategoryRowHtml(''));
        var inputs = body.querySelectorAll('.input-email');
        if (inputs.length) inputs[inputs.length - 1].focus();
    }

    async function removeCategoryRow(btn) {
        if (!await steleConfirm('Retirer cette catégorie ?')) return;
        var row = btn.parentNode.parentNode;
        row.parentNode.removeChild(row);
    }

    function saveCategories() {
        var newCats = [];
        var rows = document.querySelectorAll('#categoriesBody tr');
        for (var i = 0; i < rows.length; i++) {
            var val = rows[i].querySelector('.input-email').value.trim();
            if (!val) continue;
            if (newCats.indexOf(val) !== -1) continue;
            newCats.push(val);
        }
        catalogueCategories = newCats;
        saveConfig('catalogue_categories', catalogueCategories, 'categoriesFeedback');
    }

    // ── Tags médias table ──

    function renderTagsTable() {
        var body = document.getElementById('tagsBody');
        var html = '';
        for (var i = 0; i < mediaTags.length; i++) {
            html += buildTagRowHtml(mediaTags[i]);
        }
        body.innerHTML = html;
    }

    function buildTagRowHtml(tag) {
        var display = tag.replace(/_/g, ' ');
        return '<tr>' +
            '<td><input type="text" class="input-email" value="' + escapeHtml(display) + '" data-original="' + escapeHtml(tag) + '" placeholder="nom du tag"></td>' +
            '<td><button class="btn-remove" onclick="removeTagRow(this)" title="Retirer">&times;</button></td>' +
            '</tr>';
    }

    function addTagRow() {
        var body = document.getElementById('tagsBody');
        body.insertAdjacentHTML('beforeend', buildTagRowHtml(''));
        var inputs = body.querySelectorAll('.input-email');
        if (inputs.length) inputs[inputs.length - 1].focus();
    }

    async function removeTagRow(btn) {
        if (!await steleConfirm('Retirer ce tag ?')) return;
        var row = btn.parentNode.parentNode;
        row.parentNode.removeChild(row);
    }

    async function saveMediaTags() {
        var newTags = [];
        var renames = []; // { from: oldTag, to: newTag }
        var rows = document.querySelectorAll('#tagsBody tr');
        for (var i = 0; i < rows.length; i++) {
            var input = rows[i].querySelector('.input-email');
            var oldTag = (input.getAttribute('data-original') || '').trim().toLowerCase().replace(/\s+/g, '_');
            var newTag = input.value.trim().toLowerCase().replace(/\s+/g, '_');
            if (!newTag) continue;
            if (newTags.indexOf(newTag) !== -1) continue; // déduplique
            newTags.push(newTag);
            if (oldTag && oldTag !== newTag) {
                renames.push({ from: oldTag, to: newTag });
            }
        }

        // Propager les renommages dans item_media
        if (renames.length > 0) {
            var fb = document.getElementById('tagsFeedback');
            fb.textContent = 'Mise \u00e0 jour des m\u00e9dias...';
            fb.style.color = '#666';
            fb.style.display = 'inline';

            try {
                // Fetch all item_media that have any of the renamed tags
                var oldNames = renames.map(function(r) { return r.from; });
                var mediaResp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/item_media?select=id,tags&tags=ov.{' + oldNames.join(',') + '}', {});
                if (mediaResp.ok) {
                    var mediaRows = await mediaResp.json();
                    for (var mi = 0; mi < mediaRows.length; mi++) {
                        var m = mediaRows[mi];
                        var updatedTags = m.tags.slice();
                        var changed = false;
                        for (var ri = 0; ri < renames.length; ri++) {
                            var idx = updatedTags.indexOf(renames[ri].from);
                            if (idx !== -1) {
                                updatedTags[idx] = renames[ri].to;
                                changed = true;
                            }
                        }
                        if (changed) {
                            await authenticatedFetch(SUPABASE_URL + '/rest/v1/item_media?id=eq.' + m.id, {
                                method: 'PATCH',
                                headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                                body: JSON.stringify({ tags: updatedTags })
                            });
                        }
                    }
                }
            } catch (e) {
                console.error('Erreur propagation tags:', e);
            }
        }

        mediaTags = newTags;
        saveConfig('media_tags', mediaTags, 'tagsFeedback');
    }

    // ── Expense categories table ──

    function renderExpensesTable() {
        var body = document.getElementById('expensesBody');
        var html = '';
        for (var i = 0; i < expenseCategories.length; i++) {
            html += buildExpenseRowHtml(expenseCategories[i].name, expenseCategories[i].markup, expenseCategories[i].waste);
        }
        body.innerHTML = html;
    }

    function buildExpenseRowHtml(name, markup, waste) {
        return '<tr>' +
            '<td><input type="text" class="input-email" value="' + escapeHtml(name) + '" placeholder="Nom de la cat\u00e9gorie"></td>' +
            '<td><input type="number" class="input-number" value="' + (markup || 0) + '" placeholder="0" step="1" min="0"></td>' +
            '<td><input type="number" class="input-number input-waste" value="' + (waste || 0) + '" placeholder="0" step="1" min="0"></td>' +
            '<td><button class="btn-remove" onclick="removeExpenseRow(this)" title="Retirer">&times;</button></td>' +
            '</tr>';
    }

    function addExpenseRow() {
        var body = document.getElementById('expensesBody');
        body.insertAdjacentHTML('beforeend', buildExpenseRowHtml('', 30, 0));
        var inputs = body.querySelectorAll('.input-email');
        if (inputs.length) inputs[inputs.length - 1].focus();
    }

    async function removeExpenseRow(btn) {
        if (!await steleConfirm('Retirer cette catégorie de dépense ?')) return;
        var row = btn.parentNode.parentNode;
        row.parentNode.removeChild(row);
    }

    function saveExpenseCategories() {
        var newCats = [];
        var rows = document.querySelectorAll('#expensesBody tr');
        for (var i = 0; i < rows.length; i++) {
            var nameVal = rows[i].querySelector('.input-email').value.trim();
            if (!nameVal) continue;
            var markupVal = parseFloat(rows[i].querySelector('.input-number').value) || 0;
            var wasteInput = rows[i].querySelector('.input-waste');
            var wasteVal = parseFloat(wasteInput ? wasteInput.value : 0) || 0;
            newCats.push({ name: nameVal, markup: markupVal, waste: wasteVal });
        }
        expenseCategories = newCats;
        saveConfig('expense_categories', expenseCategories, 'expensesFeedback');
    }

    // ── Taux horaires table ──

    function renderTauxTable() {
        var body = document.getElementById('tauxBody');
        var html = '';
        for (var i = 0; i < tauxHoraires.length; i++) {
            var t = tauxHoraires[i];
            var profit = (t.taux_horaire || 0) - (t.frais_fixe || 0) - (t.salaire || 0);
            var profitClass = profit < 0 ? ' negative' : '';
            html += '<tr>' +
                '<td style="font-weight:600">' + escapeHtml(t.department) + '</td>' +
                '<td><input type="number" class="input-number" data-dept="' + i + '" data-field="taux_horaire" value="' + (t.taux_horaire || '') + '" placeholder="0.00" step="0.01" oninput="updateProfit(this)"></td>' +
                '<td><input type="number" class="input-number" data-dept="' + i + '" data-field="frais_fixe" value="' + (t.frais_fixe || '') + '" placeholder="0.00" step="0.01" oninput="updateProfit(this)"></td>' +
                '<td><input type="number" class="input-number" data-dept="' + i + '" data-field="salaire" value="' + (t.salaire || '') + '" placeholder="0.00" step="0.01" oninput="updateProfit(this)"></td>' +
                '<td class="profit-cell' + profitClass + '" id="profit_' + i + '">' + profit.toFixed(2) + ' $</td>' +
                '</tr>';
        }
        body.innerHTML = html;
    }

    function updateProfit(input) {
        var row = input.closest('tr');
        var inputs = row.querySelectorAll('.input-number');
        var taux = parseFloat(inputs[0].value) || 0;
        var fixe = parseFloat(inputs[1].value) || 0;
        var sal  = parseFloat(inputs[2].value) || 0;
        var profit = taux - fixe - sal;
        var idx = input.getAttribute('data-dept');
        var cell = document.getElementById('profit_' + idx);
        cell.textContent = profit.toFixed(2) + ' $';
        cell.className = 'profit-cell' + (profit < 0 ? ' negative' : '');
    }

    function saveTaux() {
        var rows = document.querySelectorAll('#tauxBody tr');
        var data = [];
        for (var i = 0; i < rows.length; i++) {
            var inputs = rows[i].querySelectorAll('.input-number');
            data.push({
                department: tauxHoraires[i].department,
                taux_horaire: parseFloat(inputs[0].value) || 0,
                frais_fixe:   parseFloat(inputs[1].value) || 0,
                salaire:      parseFloat(inputs[2].value) || 0
            });
        }
        tauxHoraires = data;
        saveConfig('taux_horaires', tauxHoraires, 'tauxFeedback');
    }

    // ── Company types table ──

    function renderCompanyTypesTable() {
        var body = document.getElementById('companyTypesBody');
        var html = '';
        for (var i = 0; i < companyTypes.length; i++) {
            html += '<tr><td><input type="text" class="input-email" value="' + escapeHtml(companyTypes[i]) + '" placeholder="Type d\'entreprise"></td>' +
                '<td><button class="btn-remove" onclick="removeGenericRow(this)" title="Retirer">&times;</button></td></tr>';
        }
        body.innerHTML = html;
    }
    function addCompanyTypeRow() {
        var body = document.getElementById('companyTypesBody');
        body.insertAdjacentHTML('beforeend', '<tr><td><input type="text" class="input-email" value="" placeholder="Type d\'entreprise"></td><td><button class="btn-remove" onclick="removeGenericRow(this)" title="Retirer">&times;</button></td></tr>');
        var inputs = body.querySelectorAll('.input-email');
        if (inputs.length) inputs[inputs.length - 1].focus();
    }
    function saveCompanyTypes() {
        companyTypes = collectSimpleList('companyTypesBody');
        saveConfig('company_types', companyTypes, 'companyTypesFeedback');
    }

    // ── Contact roles table ──

    function renderContactRolesTable() {
        var body = document.getElementById('contactRolesBody');
        var html = '';
        for (var i = 0; i < contactRoles.length; i++) {
            html += '<tr><td><input type="text" class="input-email" value="' + escapeHtml(contactRoles[i]) + '" placeholder="R\u00f4le"></td>' +
                '<td><button class="btn-remove" onclick="removeGenericRow(this)" title="Retirer">&times;</button></td></tr>';
        }
        body.innerHTML = html;
    }
    function addContactRoleRow() {
        var body = document.getElementById('contactRolesBody');
        body.insertAdjacentHTML('beforeend', '<tr><td><input type="text" class="input-email" value="" placeholder="R\u00f4le"></td><td><button class="btn-remove" onclick="removeGenericRow(this)" title="Retirer">&times;</button></td></tr>');
        var inputs = body.querySelectorAll('.input-email');
        if (inputs.length) inputs[inputs.length - 1].focus();
    }
    function saveContactRoles() {
        contactRoles = collectSimpleList('contactRolesBody');
        saveConfig('contact_roles', contactRoles, 'contactRolesFeedback');
    }

    // ── Communication types table ──

    function renderCommTypesTable() {
        var body = document.getElementById('commTypesBody');
        var html = '';
        for (var i = 0; i < communicationTypes.length; i++) {
            html += '<tr><td><input type="text" class="input-email" value="' + escapeHtml(communicationTypes[i]) + '" placeholder="Type"></td>' +
                '<td><button class="btn-remove" onclick="removeGenericRow(this)" title="Retirer">&times;</button></td></tr>';
        }
        body.innerHTML = html;
    }
    function addCommTypeRow() {
        var body = document.getElementById('commTypesBody');
        body.insertAdjacentHTML('beforeend', '<tr><td><input type="text" class="input-email" value="" placeholder="Type"></td><td><button class="btn-remove" onclick="removeGenericRow(this)" title="Retirer">&times;</button></td></tr>');
        var inputs = body.querySelectorAll('.input-email');
        if (inputs.length) inputs[inputs.length - 1].focus();
    }
    function saveCommTypes() {
        communicationTypes = collectSimpleList('commTypesBody');
        saveConfig('communication_types', communicationTypes, 'commTypesFeedback');
    }

    // ── Shared helpers for simple list sections ──

    async function removeGenericRow(btn) {
        if (!await steleConfirm('Retirer cet élément ?')) return;
        btn.closest('tr').remove();
    }
    function collectSimpleList(tbodyId) {
        var items = [];
        var rows = document.querySelectorAll('#' + tbodyId + ' tr');
        for (var i = 0; i < rows.length; i++) {
            var val = rows[i].querySelector('.input-email').value.trim();
            if (val && items.indexOf(val) === -1) items.push(val);
        }
        return items;
    }

    // ── Save functions ──

    async function savePermissions() {
        var activeRoles = getActiveRoles();
        var newPerm = {};
        for (var r = 0; r < activeRoles.length; r++) {
            newPerm[activeRoles[r]] = {};
        }

        var checkboxes = document.querySelectorAll('#permBody input[type="checkbox"]');
        for (var i = 0; i < checkboxes.length; i++) {
            var cb = checkboxes[i];
            var role = cb.getAttribute('data-role');
            var page = cb.getAttribute('data-page');
            newPerm[role][page] = cb.checked;
        }

        permissions = newPerm;

        // Always save to app_config (source of truth for all pages)
        saveConfig('permissions', newPerm, 'permFeedback');
    }

    async function saveUserRoles() {
        var newRoles = {};
        var rows = document.querySelectorAll('#rolesBody tr');
        for (var i = 0; i < rows.length; i++) {
            var email = rows[i].querySelector('.input-email').value.trim().toLowerCase();
            var role = rows[i].querySelector('.select-role').value;
            if (email) newRoles[email] = role;
        }

        userRolesMap = newRoles;

        // If we have roles from DB, save to user_roles table
        if (rolesFromDB.length > 0) {
            var fb = document.getElementById('rolesFeedback');
            fb.textContent = 'Sauvegarde en cours...';
            fb.className = 'save-feedback visible';

            try {
                // First, get all existing user_roles to handle deletions
                var existingResp = await authenticatedFetch(
                    SUPABASE_URL + '/rest/v1/user_roles?select=id,email',
                    {}
                );
                var existing = existingResp.ok ? await existingResp.json() : [];

                // Track which emails are in the new set
                var newEmails = Object.keys(newRoles);

                // Delete assignments that are no longer in the list
                for (var i = 0; i < existing.length; i++) {
                    if (newEmails.indexOf(existing[i].email.toLowerCase()) === -1) {
                        await authenticatedFetch(
                            SUPABASE_URL + '/rest/v1/user_roles?id=eq.' + existing[i].id,
                            { method: 'DELETE' }
                        );
                    }
                }

                // Upsert each assignment
                for (var email in newRoles) {
                    var roleName = newRoles[email];
                    var role = rolesFromDB.find(function(r) { return r.name === roleName; });

                    if (role) {
                        // Try to update first, then insert if not exists
                        var updateResp = await authenticatedFetch(
                            SUPABASE_URL + '/rest/v1/user_roles?email=eq.' + encodeURIComponent(email),
                            {
                                method: 'PATCH',
                                headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                                body: JSON.stringify({ role_id: role.id })
                            }
                        );

                        // If no row was updated, insert
                        if (!updateResp.ok || updateResp.status === 406) {
                            await authenticatedFetch(
                                SUPABASE_URL + '/rest/v1/user_roles',
                                {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                                    body: JSON.stringify({ email: email, role_id: role.id })
                                }
                            );
                        }
                    }
                }

                await loadUserRoles(); // Reload to sync
                renderRolesTable(); // Re-render the table
                showFeedback(fb, 'Rôles utilisateurs sauvegardés avec succès', false);
            } catch (e) {
                console.error('Error saving user roles:', e);
                showFeedback(fb, 'Erreur lors de la sauvegarde', true);
            }
        } else {
            // Fallback to app_config
            saveConfig('user_roles', userRolesMap, 'rolesFeedback');
        }
    }

    function saveConfig(key, value, feedbackId) {
        var fb = document.getElementById(feedbackId);

        authenticatedFetch(SUPABASE_URL + '/rest/v1/app_config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Prefer': 'resolution=merge-duplicates'
            },
            body: JSON.stringify({ key: key, value: value, updated_at: new Date().toISOString() })
        })
        .then(function(r) {
            if (r.ok || r.status === 201) {
                showFeedback(fb, 'Sauvegard\u00e9 avec succ\u00e8s', false);
            } else {
                throw new Error('save failed');
            }
        })
        .catch(function() {
            // Fallback localStorage
            localStorage.setItem('stele_' + key, JSON.stringify(value));
            showFeedback(fb, 'Sauvegard\u00e9 localement — cr\u00e9ez la table Supabase pour partager', true);
        });
    }

    function showFeedback(el, msg, isWarn) {
        if (!el) return;
        el.textContent = (isWarn ? '' : '\u2713 ') + msg;
        el.className = 'save-feedback visible' + (isWarn ? ' warn' : '');
        setTimeout(function() { el.className = 'save-feedback'; }, 4000);
    }

    // ── Tag Prefixes table ──

    function renderTagPrefixTable() {
        var body = document.getElementById('tagPrefixBody');
        if (!body) return;
        var html = '';
        tagPrefixes.forEach(function(tp, i) {
            html += '<tr>' +
                '<td><input type="text" value="' + escapeAttr(tp.prefix || '') + '" maxlength="2" style="width:50px;text-align:center;text-transform:uppercase;font-weight:700;font-family:monospace;" onchange="tagPrefixes[' + i + '].prefix=this.value.toUpperCase()"></td>' +
                '<td><input type="text" value="' + escapeAttr(tp.label_fr || '') + '" style="width:100%;" onchange="tagPrefixes[' + i + '].label_fr=this.value"></td>' +
                '<td style="text-align:center;"><button class="btn-outline" style="color:#c62828;border-color:#c62828;padding:4px 8px;font-size:11px;" onclick="removeTagPrefix(' + i + ')">&times;</button></td>' +
                '</tr>';
        });
        body.innerHTML = html;
    }

    function addTagPrefix() {
        var next = tagPrefixes.length + 1;
        tagPrefixes.push({ prefix: '', label_fr: '', label_en: '', sort_order: next });
        renderTagPrefixTable();
        // Focus the new prefix input
        var inputs = document.querySelectorAll('#tagPrefixBody input[type="text"]');
        if (inputs.length > 0) inputs[inputs.length - 2].focus();
    }

    async function removeTagPrefix(index) {
        if (!await steleConfirm('Retirer ce préfixe ?')) return;
        tagPrefixes.splice(index, 1);
        renderTagPrefixTable();
    }

    function saveTagPrefixes() {
        // Update sort_order
        tagPrefixes.forEach(function(tp, i) { tp.sort_order = i + 1; });
        saveConfig('tag_prefixes', tagPrefixes, 'tagsFeedback');
    }

    // ── Pipeline statuses table ──

    function slugify(str) {
        return (str || '').toLowerCase()
            .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
            .replace(/[^a-z0-9]+/g, '_').replace(/^_|_$/g, '');
    }

    function renderPipelineStatusesTable() {
        var body = document.getElementById('pipelineStatusesBody');
        if (!body) return;
        var html = '';
        for (var i = 0; i < pipelineStatuses.length; i++) {
            var s = pipelineStatuses[i];
            html += '<tr>' +
                '<td><input type="text" class="input-email ps-label" value="' + escapeAttr(s.label || '') + '" placeholder="Nom du statut" oninput="updatePipelineSlug(this)"></td>' +
                '<td><input type="color" class="ps-color" value="' + escapeAttr(s.color || '#9e9e9e') + '" style="width:40px;height:30px;border:1px solid #ccc;border-radius:3px;cursor:pointer;padding:0;"></td>' +
                '<td><input type="text" class="ps-slug" value="' + escapeAttr(s.slug || '') + '" readonly style="background:#f5f5f5;color:#888;font-family:monospace;font-size:12px;"></td>' +
                '<td><button class="btn-remove" onclick="removePipelineStatusRow(this)" title="Retirer">&times;</button></td>' +
                '</tr>';
        }
        body.innerHTML = html;
    }

    function updatePipelineSlug(input) {
        var row = input.closest('tr');
        var slugInput = row.querySelector('.ps-slug');
        slugInput.value = slugify(input.value);
    }

    function addPipelineStatusRow() {
        pipelineStatuses.push({slug:'', label:'', color:'#9e9e9e', sort_order: pipelineStatuses.length + 1});
        renderPipelineStatusesTable();
        var inputs = document.querySelectorAll('#pipelineStatusesBody .ps-label');
        if (inputs.length) inputs[inputs.length - 1].focus();
    }

    async function removePipelineStatusRow(btn) {
        if (!await steleConfirm('Retirer ce statut ?')) return;
        btn.closest('tr').remove();
    }

    function savePipelineStatuses() {
        var newStatuses = [];
        var rows = document.querySelectorAll('#pipelineStatusesBody tr');
        for (var i = 0; i < rows.length; i++) {
            var label = rows[i].querySelector('.ps-label').value.trim();
            if (!label) continue;
            var color = rows[i].querySelector('.ps-color').value;
            var slug = rows[i].querySelector('.ps-slug').value || slugify(label);
            newStatuses.push({ slug: slug, label: label, color: color, sort_order: i + 1 });
        }
        pipelineStatuses = newStatuses;
        saveConfig('pipeline_statuses', pipelineStatuses, 'pipelineStatusesFeedback');
    }

    // ── Project sources table ──

    function renderProjectSourcesTable() {
        var body = document.getElementById('projectSourcesBody');
        if (!body) return;
        var html = '';
        for (var i = 0; i < projectSources.length; i++) {
            html += '<tr><td><input type="text" class="input-email" value="' + escapeHtml(projectSources[i]) + '" placeholder="Source"></td>' +
                '<td><button class="btn-remove" onclick="removeGenericRow(this)" title="Retirer">&times;</button></td></tr>';
        }
        body.innerHTML = html;
    }
    function addProjectSourceRow() {
        var body = document.getElementById('projectSourcesBody');
        body.insertAdjacentHTML('beforeend', '<tr><td><input type="text" class="input-email" value="" placeholder="Source"></td><td><button class="btn-remove" onclick="removeGenericRow(this)" title="Retirer">&times;</button></td></tr>');
        var inputs = body.querySelectorAll('.input-email');
        if (inputs.length) inputs[inputs.length - 1].focus();
    }
    function saveProjectSources() {
        projectSources = collectSimpleList('projectSourcesBody');
        saveConfig('project_sources', projectSources, 'projectSourcesFeedback');
    }

    // ── Project types table ──

    function renderProjectTypesTable() {
        var body = document.getElementById('projectTypesBody');
        if (!body) return;
        var html = '';
        for (var i = 0; i < projectTypes.length; i++) {
            html += '<tr><td><input type="text" class="input-email" value="' + escapeHtml(projectTypes[i]) + '" placeholder="Type de projet"></td>' +
                '<td><button class="btn-remove" onclick="removeGenericRow(this)" title="Retirer">&times;</button></td></tr>';
        }
        body.innerHTML = html;
    }
    function addProjectTypeRow() {
        var body = document.getElementById('projectTypesBody');
        body.insertAdjacentHTML('beforeend', '<tr><td><input type="text" class="input-email" value="" placeholder="Type de projet"></td><td><button class="btn-remove" onclick="removeGenericRow(this)" title="Retirer">&times;</button></td></tr>');
        var inputs = body.querySelectorAll('.input-email');
        if (inputs.length) inputs[inputs.length - 1].focus();
    }
    function saveProjectTypes() {
        projectTypes = collectSimpleList('projectTypesBody');
        saveConfig('project_types', projectTypes, 'projectTypesFeedback');
    }

    function handleLogout() {
        localStorage.removeItem('sb_access_token');
        localStorage.removeItem('sb_refresh_token');
        localStorage.removeItem('sb_user_email');
        localStorage.removeItem('sb_user_id');
        window.location.href = 'login.html';
    }

    // ── Role management functions ──

    function openRoleModal(roleId) {
        var modal = document.getElementById('roleModal');
        if (!modal) return;

        var title = document.getElementById('roleModalTitle');
        var nameInput = document.getElementById('roleNameInput');
        var descInput = document.getElementById('roleDescInput');
        var permChecksContainer = document.getElementById('rolePermChecks');
        var saveBtn = document.getElementById('roleSaveBtn');

        if (roleId) {
            // Edit mode
            var role = rolesFromDB.find(function(r) { return r.id === roleId; });
            if (!role) return;

            title.textContent = 'Modifier le r\u00f4le';
            nameInput.value = role.name;
            descInput.value = role.description || '';
            saveBtn.setAttribute('data-role-id', roleId);

            // Check permissions
            var perms = role.permissions || {};
            for (var i = 0; i < PAGES.length; i++) {
                var cb = document.getElementById('rolePerm_' + PAGES[i].key);
                if (cb) cb.checked = perms[PAGES[i].key] || false;
            }
        } else {
            // Create mode
            title.textContent = 'Nouveau r\u00f4le';
            nameInput.value = '';
            descInput.value = '';
            saveBtn.removeAttribute('data-role-id');

            // Uncheck all permissions
            for (var i = 0; i < PAGES.length; i++) {
                var cb = document.getElementById('rolePerm_' + PAGES[i].key);
                if (cb) cb.checked = false;
            }
        }

        modal.style.display = 'flex';
    }

    function closeRoleModal() {
        var modal = document.getElementById('roleModal');
        if (modal) modal.style.display = 'none';
    }

    function editRole(roleId) {
        openRoleModal(roleId);
    }

    async function deleteRole(roleId) {
        if (!await steleConfirm('Voulez-vous vraiment supprimer ce rôle ?')) return;

        try {
            var resp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/roles?id=eq.' + roleId, {
                method: 'DELETE'
            });

            if (resp.ok) {
                await loadRoles();
                renderAll(); // Re-render all tables including permissions
                alert('R\u00f4le supprim\u00e9 avec succ\u00e8s');
            } else {
                alert('Erreur lors de la suppression du r\u00f4le');
            }
        } catch (e) {
            console.error('Error deleting role:', e);
            alert('Erreur lors de la suppression du r\u00f4le');
        }
    }

    async function saveRole() {
        var roleId = document.getElementById('roleSaveBtn').getAttribute('data-role-id');
        var name = document.getElementById('roleNameInput').value.trim();
        var description = document.getElementById('roleDescInput').value.trim();

        if (!name) {
            alert('Le nom du r\u00f4le est requis');
            return;
        }

        // Collect permissions
        var permissions = {};
        for (var i = 0; i < PAGES.length; i++) {
            var cb = document.getElementById('rolePerm_' + PAGES[i].key);
            permissions[PAGES[i].key] = cb ? cb.checked : false;
        }

        var payload = {
            name: name,
            description: description,
            permissions: permissions,
            is_system: false
        };

        try {
            var resp;
            if (roleId) {
                // Update
                resp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/roles?id=eq.' + roleId, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                    body: JSON.stringify(payload)
                });
            } else {
                // Create
                resp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/roles', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                    body: JSON.stringify(payload)
                });
            }

            if (resp.ok || resp.status === 201) {
                await loadRoles();
                renderAll(); // Re-render all tables including permissions
                closeRoleModal();
                alert('R\u00f4le sauvegard\u00e9 avec succ\u00e8s');
            } else {
                alert('Erreur lors de la sauvegarde du r\u00f4le');
            }
        } catch (e) {
            console.error('Error saving role:', e);
            alert('Erreur lors de la sauvegarde du r\u00f4le');
        }
    }
    // ═══════════════════════════════════════════════════════════════════════
    // COVER IMAGE
    // ═══════════════════════════════════════════════════════════════════════

    async function loadCoverImagePreview() {
        try {
            var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/app_config?key=eq.cover_image&select=value', {});
            if (r.ok) {
                var rows = await r.json();
                if (rows.length > 0 && rows[0].value) {
                    showCoverPreview(rows[0].value);
                }
            }
        } catch (e) { /* ignore */ }
    }

    function showCoverPreview(url) {
        var preview = document.getElementById('coverImagePreview');
        var placeholder = document.getElementById('coverImagePlaceholder');
        if (url) {
            preview.innerHTML = '<img src="' + url + '" style="width:100%;height:100%;object-fit:cover;">';
        } else {
            preview.innerHTML = '<span style="color:#666;font-size:13px;" id="coverImagePlaceholder">Aucune image</span>';
        }
    }

    async function uploadCoverImage(input) {
        if (!input.files || !input.files[0]) return;
        var file = input.files[0];
        var feedback = document.getElementById('coverFeedback');
        feedback.textContent = 'Upload en cours...';
        feedback.style.color = '#888';

        try {
            // Compress image client-side
            var compressed = await compressCoverImage(file, 1600, 0.85);

            // Upload to Supabase Storage (assets bucket, public)
            var r = await authenticatedFetch(SUPABASE_URL + '/storage/v1/object/assets/cover_image.jpg', {
                method: 'PUT',
                headers: { 'Content-Type': 'image/jpeg', 'x-upsert': 'true' },
                body: compressed
            });

            if (!r.ok) {
                // Try POST if PUT fails (file doesn't exist yet)
                r = await authenticatedFetch(SUPABASE_URL + '/storage/v1/object/assets/cover_image.jpg', {
                    method: 'POST',
                    headers: { 'Content-Type': 'image/jpeg', 'x-upsert': 'true' },
                    body: compressed
                });
            }

            if (r.ok) {
                var publicUrl = SUPABASE_URL + '/storage/v1/object/public/assets/cover_image.jpg?t=' + Date.now();
                // Save URL to app_config
                await authenticatedFetch(SUPABASE_URL + '/rest/v1/app_config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'resolution=merge-duplicates' },
                    body: JSON.stringify({ key: 'cover_image', value: JSON.stringify(publicUrl) })
                });
                showCoverPreview(publicUrl);
                feedback.textContent = 'Image sauvegard\u00e9e!';
                feedback.style.color = 'var(--stele-green, #4b6050)';
            } else {
                var errText = await r.text();
                console.error('Upload error:', errText);
                feedback.textContent = 'Erreur upload';
                feedback.style.color = '#c00';
            }
        } catch (e) {
            console.error('Cover image upload error:', e);
            feedback.textContent = 'Erreur';
            feedback.style.color = '#c00';
        }
        input.value = '';
    }

    function compressCoverImage(file, maxWidth, quality) {
        return new Promise(function(resolve) {
            var reader = new FileReader();
            reader.onload = function(e) {
                var img = new Image();
                img.onload = function() {
                    var w = img.width, h = img.height;
                    if (w > maxWidth) { h = Math.round(h * maxWidth / w); w = maxWidth; }
                    var canvas = document.createElement('canvas');
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    canvas.toBlob(function(blob) { resolve(blob); }, 'image/jpeg', quality);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
    }

    async function removeCoverImage() {
        if (!confirm('Supprimer l\'image de couverture ?')) return;
        var feedback = document.getElementById('coverFeedback');
        try {
            // Remove from app_config
            await authenticatedFetch(SUPABASE_URL + '/rest/v1/app_config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Prefer': 'resolution=merge-duplicates' },
                body: JSON.stringify({ key: 'cover_image', value: JSON.stringify('') })
            });
            showCoverPreview('');
            feedback.textContent = 'Image supprim\u00e9e';
            feedback.style.color = '#888';
        } catch (e) {
            feedback.textContent = 'Erreur';
            feedback.style.color = '#c00';
        }
    }

    // Load cover image preview on page load
    loadCoverImagePreview();

    // ── AI Prompts (simplified: 1 textarea per assistant) ──

    var aiPromptOverrides = {}; // loaded from app_config
    var AI_PROMPT_DEFAULTS = {};

    // Default for Assistant Estimateur — must match DEFAULT_STATIC_PROMPT in ai-assistant/index.ts
    AI_PROMPT_DEFAULTS['ai_prompt_estimateur'] = "Tu es l'assistant intelligent de Scopewright, la plateforme d'estimation pour Stele, un atelier d'\u00e9b\u00e9nisterie haut de gamme sur mesure bas\u00e9 au Qu\u00e9bec. Tu aides les designers \u00e0 estimer, analyser et optimiser leurs projets de meubles sur mesure.\n\n## Ton r\u00f4le\n- Analyser la rentabilit\u00e9 des pi\u00e8ces et du projet\n- Sugg\u00e9rer des articles du catalogue appropri\u00e9s\n- R\u00e9diger et optimiser les descriptions client (HTML format\u00e9 selon les r\u00e8gles Stele)\n- Comparer les prix avec les bar\u00e8mes de l'industrie\n- Expliquer les choix de mat\u00e9riaux et de main-d'\u0153uvre\n- R\u00e9pondre aux questions sur l'estimation et l'\u00e9b\u00e9nisterie\n\n## Mode simulation\nIMPORTANT : Tu proposes TOUJOURS les modifications en texte d'abord. Tu d\u00e9cris ce que tu ferais, avec les d\u00e9tails (articles, quantit\u00e9s, prix). L'utilisateur doit CONFIRMER explicitement avant que tu utilises un tool. Si l'utilisateur dit \"applique\", \"confirme\", \"go\", \"fais-le\", \"oui\", ou toute confirmation claire, ALORS tu appelles le tool appropri\u00e9. Sans confirmation = description textuelle seulement.\n\nQuand tu proposes une action, utilise ce format :\n**Action propos\u00e9e :** [description claire de ce qui serait modifi\u00e9]\n\n## Mod\u00e8le de prix Stele\nPrix de vente = Main-d'\u0153uvre + Mat\u00e9riaux\n- Main-d'\u0153uvre : \u03a3(minutes/60 \u00d7 taux_horaire_d\u00e9partement)\n- Mat\u00e9riaux : \u03a3(co\u00fbt \u00d7 (1 + markup%/100 + perte%/100))\n- Marge brute vis\u00e9e : 38%\n- Profit net = (profit sur taux horaire) + (markup mat\u00e9riaux)\n- Prix co\u00fbtant mat\u00e9riaux = co\u00fbt \u00d7 (1 + perte/100)\n\n## Tags de soumission\nChaque pi\u00e8ce \u00e0 soumissionner contient des tags plac\u00e9s sur les images du plan par l'estimateur.\nLes tags identifient les composantes physiques sur le plan.\nPr\u00e9fixes : {{TAG_PREFIXES}}\nExemples : C1 = premier caisson, F2 = deuxi\u00e8me filler, P1 = premier panneau\n\nLes pr\u00e9fixes de tags et leurs d\u00e9signations sont configur\u00e9s dans l'administration. Consulte le contexte pour conna\u00eetre les pr\u00e9fixes actifs et ce qu'ils repr\u00e9sentent.\n\nQuand l'estimateur te demande \"Fais-moi le C1\" :\n1. Regarde les images marqu\u00e9es AI pour voir o\u00f9 C1 est plac\u00e9 sur le plan\n2. Identifie le type d'\u00e9l\u00e9ment (caisson, panneau, filler, etc.) selon le pr\u00e9fixe\n3. Cherche dans le catalogue les articles correspondants \u00e0 ce type\n4. Si l'article a une r\u00e8gle de calcul, utilise-la pour proposer la quantit\u00e9\n5. Propose les lignes \u00e0 ajouter (mode simulation \u2014 ne rien appliquer sans confirmation)\n\nTu peux aussi signaler des oublis :\n- \"Tu n'as pas encore trait\u00e9 le C2\"\n- \"Sur le plan, l'\u00e9l\u00e9ment \u00e0 gauche du frigo n'a pas de tag \u2014 \u00e7a ressemble \u00e0 un recouvrement, tu veux l'ajouter ?\"\n\n**Tags dans les tools :**\n- Quand l'estimateur travaille par tag (\"Fais-moi le C1\", \"Ajoute le F2\"), inclus TOUJOURS le tag dans chaque article que tu ajoutes via add_catalogue_item. Tous les articles li\u00e9s au m\u00eame \u00e9l\u00e9ment physique portent le m\u00eame tag.\n- Exemple : \"Fais-moi le C1\" \u2192 tous les articles (caisson, portes, charni\u00e8res, pattes) doivent avoir tag=\"C1\".\n- TOUJOURS utiliser les tags dans tes r\u00e9ponses quand ils existent. Dis \"C3 n'a pas de filler \u00e0 sa droite\" plut\u00f4t que \"le troisi\u00e8me caisson\".\n\n## Comment lire les plans d'\u00e9b\u00e9nisterie\nLes plans sont des \u00e9l\u00e9vations int\u00e9rieures (vues de face d'un mur).\n\nRep\u00e8res de position :\n- Les caissons BAS sont SOUS la ligne de comptoir (partie inf\u00e9rieure du plan)\n- Les caissons HAUTS sont AU-DESSUS de la ligne de comptoir (partie sup\u00e9rieure du plan)\n- Les \u00e9lectrom\u00e9nagers (four, frigo, lave-vaisselle) sont entre les caissons bas\n- Les fillers (F1, F2...) sont des bandes \u00e9troites entre un meuble et un mur ou entre deux meubles\n- Les panneaux (P1, P2...) sont des surfaces d\u00e9coratives, souvent \u00e0 c\u00f4t\u00e9 des \u00e9lectros\n\nDimensions sur les plans :\n- Format typique : 2'-6\" signifie 2 pieds 6 pouces = 30 pouces\n- L'\u00e9chelle est indiqu\u00e9e en bas du plan (ex: 1/4\" = 1'-0\")\n- Les cotes (lignes avec fl\u00e8ches) indiquent les dimensions r\u00e9elles\n- Largeur = dimension horizontale, Hauteur = dimension verticale\n\nIMPORTANT \u2014 Pr\u00e9cision :\n- Si tu n'es pas certain de la position exacte d'un tag sur le plan, DIS-LE plut\u00f4t que de deviner\n- Exemple correct : \"C1 semble \u00eatre le caisson en bas \u00e0 gauche \u2014 tu confirmes ?\"\n- Exemple incorrect : affirmer avec certitude une position dont tu n'es pas s\u00fbr\n- En cas de doute, demande : \"C1 c'est lequel exactement sur le plan ?\"\n\n## R\u00e8gles pour les descriptions client\nQuand tu \u00e9cris ou optimises une description, respecte ces r\u00e8gles exactement :\n{{DESCRIPTION_FORMAT_RULES}}\n- Orthographe, accents, pluriels, concordances simples\n- Garder le ton original, pas de reformulation marketing\n- Pas de cr\u00e9ativit\u00e9 non demand\u00e9e, pas de contenu invent\u00e9\n\n## Descriptions client \u00e0 partir du catalogue\nChaque article du catalogue peut avoir un texte de pr\u00e9sentation client (champ client_text).\nQuand tu g\u00e9n\u00e8res une description client pour un \u00e9l\u00e9ment :\n1. Prends le client_text de chaque article/sous-composante utilis\u00e9\n2. Si l'article a une r\u00e8gle de pr\u00e9sentation (presentation_rule), suis-la pour l'ordre, le pr\u00e9fixe et les inclusions/exclusions\n3. Assemble les fragments dans l'ordre logique : Mat\u00e9riau \u2192 Finition \u2192 Quincaillerie \u2192 D\u00e9tails\n4. S\u00e9pare par le s\u00e9parateur d\u00e9fini (virgule par d\u00e9faut)\n5. Commence par le type d'\u00e9l\u00e9ment : \"Caisson en [mat\u00e9riau], [finition], [d\u00e9tails]\"\n6. Le r\u00e9sultat doit \u00eatre une phrase naturelle et professionnelle\n\nExemples :\n- \"Caisson bas en m\u00e9lamine blanche thermofusion\u00e9e, chants PVC assortis, 2 tablettes ajustables, ouverture par pression\"\n- \"Armoire haute en placage de ch\u00eane blanc FC, laque au polyur\u00e9thane clair, 4 tablettes ajustables, charni\u00e8res \u00e0 fermeture douce\"\n- \"Panneau d\u00e9coratif en placage de noyer naturel, vernis mat\"\n\nSi un article n'a pas de client_text, utilise sa description du catalogue reformul\u00e9e pour le client.\nLes fragments sont en minuscule sans point final \u2014 c'est toi qui assembles la phrase compl\u00e8te.\n\n## Articles par d\u00e9faut de l'atelier\nLes articles marqu\u00e9s \u2605 (is_default = true) dans le catalogue sont les articles \"go-to\" de l'atelier.\nQuand tu sugg\u00e8res des articles :\n- Privil\u00e9gie les articles \u2605 en premier\n- Si l'estimateur ne sp\u00e9cifie pas de produit pr\u00e9cis, propose le \u2605 de la cat\u00e9gorie concern\u00e9e\n- Tu peux dire \"Je sugg\u00e8re le [article \u2605] comme d'habitude \u2014 ou tu pr\u00e9f\u00e8res autre chose ?\"\n\n## Efficacit\u00e9\nSois efficace. Ne pose pas de questions inutiles :\n- Si un d\u00e9faut existe et qu'il est \u00e9vident, utilise-le\n- Si une dimension est visible sur le plan, utilise-la sans demander confirmation\n- Regroupe tes questions : \"Pour le C1, j'ai besoin de : largeur? profondeur?\" \u2014 pas une question \u00e0 la fois\n- Quand tu proposes des articles, montre le r\u00e9sultat directement : \"C1 \u2014 Caisson base 36\u00d724\u00d730 : BAS-001 (467$) + 4 pattes QUI-001 (38.20$) = 505.20$. Confirmer?\"\n\n## Langue\nR\u00e9ponds dans la langue de l'utilisateur (fran\u00e7ais canadien par d\u00e9faut). Ton professionnel mais naturel, comme un coll\u00e8gue exp\u00e9riment\u00e9 en \u00e9b\u00e9nisterie.\n\n## Limitations\n- Tu ne peux PAS modifier les taux horaires ou cat\u00e9gories de d\u00e9penses\n- Tu ne peux PAS approuver ou changer le statut des soumissions\n- Tu ne peux PAS acc\u00e9der aux projets d'autres utilisateurs\n- Si on te demande quelque chose hors scope, dis-le clairement";

    // Default for Import Catalogue — must match DEFAULT_STATIC_PROMPT in catalogue-import/index.ts
    AI_PROMPT_DEFAULTS['ai_prompt_catalogue_import'] = "Tu es l'assistant d'import du catalogue pour un atelier d'\u00e9b\u00e9nisterie haut de gamme.\n\n## Ton r\u00f4le\nL'utilisateur te donne des donn\u00e9es en vrac \u2014 screenshots d'Excel, listes copi\u00e9es-coll\u00e9es, descriptions textuelles, photos de catalogues fournisseur \u2014 et tu extrais des articles structur\u00e9s pour le catalogue interne.\n\n## Ce que tu extrais pour chaque article\n\nPour chaque article identifi\u00e9, tu dois d\u00e9terminer :\n- **Description** : nom clair et concis de l'article\n- **Cat\u00e9gorie** : parmi les cat\u00e9gories existantes du catalogue (voir contexte)\n- **Type d'unit\u00e9** : unitaire, pi\u00b2, pied_lineaire, ou autre selon le contexte\n- **Code** : g\u00e9n\u00e9r\u00e9 automatiquement selon le pr\u00e9fixe de la cat\u00e9gorie + prochain num\u00e9ro disponible\n\nEt le **PRIX COMPOS\u00c9** qui se divise en deux volets :\n\n### Minutes main-d'\u0153uvre (par d\u00e9partement)\nLes d\u00e9partements sont ceux list\u00e9s dans les taux horaires (voir contexte). Les plus courants :\n- Gestion/dessin, Coupe/edge, Assemblage, Machinage, Sablage, Peinture, Installation\n\n### Co\u00fbts mat\u00e9riaux (par cat\u00e9gorie de d\u00e9pense)\nLes cat\u00e9gories de d\u00e9penses sont list\u00e9es dans le contexte. Exemples : Quincaillerie, Panneau m\u00e9lamine, Panneau MDF, Bois brut, Finition, etc.\n\nImportant : la liste des cat\u00e9gories de d\u00e9penses est charg\u00e9e dynamiquement du contexte. Utilise SEULEMENT les cat\u00e9gories qui existent dans le syst\u00e8me.\n\nOptionnel si l'info est disponible :\n- Fournisseur + SKU fournisseur + co\u00fbt (composante fournisseur)\n- Instruction (notes pour l'estimateur)\n- Texte pr\u00e9sentation client (fragment de phrase pour la soumission, minuscule, pas de point)\n\n## Comment tu travailles\n\n1. L'utilisateur colle ou envoie des donn\u00e9es\n2. Tu analyses et extrais les articles\n3. **Avant de cr\u00e9er**, utilise search_catalogue pour v\u00e9rifier les doublons potentiels\n4. Tu pr\u00e9sentes un r\u00e9capitulatif clair :\n   \"J'ai identifi\u00e9 X articles :\n   1. [CODE] Description \u2014 Type\n      MO: Gestion 5min, Assemblage 10min\n      Mat: Quincaillerie 12.50$\n   2. [CODE] Description \u2014 Type\n      MO: Gestion 3min, Coupe 8min\n      Mat: Panneau m\u00e9lamine 5.00$\n   ...\"\n5. Tu demandes confirmation : \"Je cr\u00e9e ces articles ? Tu peux modifier avant.\"\n6. L'utilisateur confirme ou corrige\n7. Tu cr\u00e9es les articles via le tool create_catalogue_item\n\n## Mode simulation\nIMPORTANT : Tu proposes TOUJOURS les articles en texte d'abord. L'utilisateur doit CONFIRMER explicitement avant que tu appelles un tool de modification (create, update, delete). Si l'utilisateur dit \"oui\", \"go\", \"confirme\", \"cr\u00e9e-les\", ou toute confirmation claire, ALORS tu appelles le tool. Sans confirmation = description textuelle seulement.\n\n## R\u00e8gles importantes\n\n### Cat\u00e9gories\n- Toujours classer dans une cat\u00e9gorie EXISTANTE du catalogue\n- Si aucune cat\u00e9gorie ne correspond, propose la plus proche et demande : \"Je n'ai pas de cat\u00e9gorie exacte pour \u00e7a. Je le mets dans [cat\u00e9gorie] ou tu pr\u00e9f\u00e8res en cr\u00e9er une nouvelle ?\"\n- Ne jamais cr\u00e9er de cat\u00e9gorie toi-m\u00eame\n\n### Codes\n- Format : PREFIXE-XXX (ex: TIR-001, PAN-005, QUI-012)\n- Le pr\u00e9fixe d\u00e9pend de la cat\u00e9gorie\n- Utilise le prochain num\u00e9ro disponible (voir les codes existants dans le contexte)\n\n### Doublons\n- Avant de cr\u00e9er, v\u00e9rifie si un article similaire existe d\u00e9j\u00e0 dans le catalogue\n- Si doublon probable : \"Attention, TIR-001 'Bois massif queue d'aronde' existe d\u00e9j\u00e0 \u00e0 400$. C'est le m\u00eame article ou un nouveau ?\"\n\n### Prix compos\u00e9 et prix de vente\n- Le prix de vente est CALCUL\u00c9 automatiquement : (minutes \u00d7 taux horaire) + (mat\u00e9riaux \u00d7 (1 + markup + waste))\n- Ne JAMAIS demander le prix de vente \u2014 remplis les minutes et mat\u00e9riaux, le syst\u00e8me calcule\n- Si l'utilisateur donne un prix de vente sans d\u00e9tails, demande : \"Tu as le d\u00e9tail des minutes et mat\u00e9riaux ? Le prix de vente se calcule automatiquement \u00e0 partir du prix compos\u00e9.\"\n- Si l'utilisateur insiste pour donner juste un prix global sans d\u00e9tails, mets tout dans la cat\u00e9gorie mat\u00e9riaux la plus logique et 0 minutes \u2014 l'admin compl\u00e9tera\n- Si le prix est en co\u00fbt fournisseur, demande : \"Ce prix (X$) c'est le co\u00fbt fournisseur ou le prix de vente ?\"\n- Si l'utilisateur donne des prix avec taxes, clarifier : \"Ces prix incluent les taxes ? Le catalogue est en prix hors taxes.\"\n\n### Champs optionnels mais importants\n- **Instruction** : notes internes pour l'estimateur (ex: \"V\u00e9rifier disponibilit\u00e9 avant de proposer\")\n- **Texte pr\u00e9sentation client** : fragment de phrase pour la soumission client (ex: \"tiroirs en \u00e9rable massif \u00e0 queues d'aronde\"). Minuscule, pas de point.\n- **Article par d\u00e9faut \u2605** : si l'utilisateur dit \"c'est notre go-to\" ou \"celui qu'on utilise toujours\", mettre is_default: true\n- **Composantes fournisseur** : si l'utilisateur donne un fournisseur + SKU + co\u00fbt, les stocker comme composante\n\n### Screenshots et images\n- Tu peux lire des screenshots d'Excel, de tableaux, de listes de prix fournisseur\n- Extrais les colonnes : description, prix, code produit, unit\u00e9\n- Si le format n'est pas clair, montre ce que tu as compris et demande confirmation\n\n### Quantit\u00e9 et lots\n- Si l'utilisateur donne beaucoup d'articles d'un coup (ex: 20+ lignes d'Excel), traite-les par lots de 10 max\n- Apr\u00e8s chaque lot : \"Lot 1 (10 articles) cr\u00e9\u00e9. Je continue avec les 10 suivants ?\"\n\n### Pr\u00e9cision\n- Si le type d'unit\u00e9 n'est pas clair, demande \u00e0 l'utilisateur\n- Sois conservateur : il vaut mieux demander que de se tromper\n- Si le contenu est ambigu ou illisible, dis-le clairement\n\n### R\u00e8gles d'utilisation des tools\n- **create** : toujours proposer le r\u00e9capitulatif AVANT de cr\u00e9er. Attendre confirmation.\n- **update** : toujours montrer l'ancien vs le nouveau AVANT de modifier. \"TIR-001 : Assemblage 10min \u2192 15min. Confirmer ?\"\n- **delete** : toujours demander confirmation explicite. \"Supprimer TIR-001 'Tiroir 4x12 plaine' ? Cette action est irr\u00e9versible.\"\n- **update en lot** : si l'utilisateur dit \"change tous les tiroirs de 10 \u00e0 15 minutes assemblage\", lister les articles affect\u00e9s et demander confirmation avant d'appliquer.\n\n## Ton ton\n- Direct et efficace \u2014 pas de bavardage\n- \"J'ai trouv\u00e9 12 tiroirs Legrabox. Voici la liste :\" pas \"Super ! Je vais analyser tes donn\u00e9es...\"\n- Si quelque chose n'est pas clair, demande UNE question pr\u00e9cise, pas 5\n\n## Langue\nR\u00e9ponds en fran\u00e7ais canadien. Ton professionnel mais naturel.";

    var currentPromptKey = 'ai_prompt_estimateur';

    function switchAiPrompt() {
        var sel = document.getElementById('aiPromptSelector');
        currentPromptKey = sel.value;
        var textarea = document.getElementById('aiPromptTextarea');
        var statusEl = document.getElementById('aiPromptStatus');
        // Show override if exists, else show default
        if (aiPromptOverrides[currentPromptKey]) {
            textarea.value = aiPromptOverrides[currentPromptKey];
            statusEl.textContent = 'personnalis\u00e9';
            statusEl.style.color = '#4b6050';
        } else {
            textarea.value = AI_PROMPT_DEFAULTS[currentPromptKey] || '';
            statusEl.textContent = 'par d\u00e9faut';
            statusEl.style.color = '#aaa';
        }
    }

    function loadAiPrompts(rows) {
        aiPromptOverrides = {};
        if (Array.isArray(rows)) {
            for (var i = 0; i < rows.length; i++) {
                var row = rows[i];
                if (row.key === 'ai_prompt_estimateur' || row.key === 'ai_prompt_catalogue_import') {
                    if (row.value && typeof row.value === 'string' && row.value.trim()) {
                        aiPromptOverrides[row.key] = row.value;
                    }
                }
            }
        }
        // Initialize textarea with current selection
        switchAiPrompt();
    }

    function saveAiPrompt() {
        var textarea = document.getElementById('aiPromptTextarea');
        var fb = document.getElementById('aiPromptFeedback');
        var statusEl = document.getElementById('aiPromptStatus');
        if (!textarea) return;
        var val = textarea.value.trim();
        authenticatedFetch(SUPABASE_URL + '/rest/v1/app_config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Prefer': 'resolution=merge-duplicates' },
            body: JSON.stringify({ key: currentPromptKey, value: val })
        }).then(function(r) {
            if (r.ok || r.status === 201) {
                aiPromptOverrides[currentPromptKey] = val;
                showFeedback(fb, 'Sauvegard\u00e9', false);
                if (statusEl) { statusEl.textContent = 'personnalis\u00e9'; statusEl.style.color = '#4b6050'; }
            } else { throw new Error('save failed'); }
        }).catch(function() { showFeedback(fb, 'Erreur', true); });
    }

    function resetAiPrompt() {
        var textarea = document.getElementById('aiPromptTextarea');
        var fb = document.getElementById('aiPromptFeedback');
        var statusEl = document.getElementById('aiPromptStatus');
        if (!textarea) return;
        // Clear override — show default
        textarea.value = AI_PROMPT_DEFAULTS[currentPromptKey] || '';
        authenticatedFetch(SUPABASE_URL + '/rest/v1/app_config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Prefer': 'resolution=merge-duplicates' },
            body: JSON.stringify({ key: currentPromptKey, value: JSON.stringify('') })
        }).then(function(r) {
            if (r.ok || r.status === 201) {
                delete aiPromptOverrides[currentPromptKey];
                showFeedback(fb, 'R\u00e9initialis\u00e9 (d\u00e9faut actif)', false);
                if (statusEl) { statusEl.textContent = 'par d\u00e9faut'; statusEl.style.color = '#aaa'; }
            } else { throw new Error('reset failed'); }
        }).catch(function() { showFeedback(fb, 'Erreur', true); });
    }

    </script>
</body>
</html>
