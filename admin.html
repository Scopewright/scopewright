<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration — Stele</title>

    <!-- Auth guard -->
    <script>
        if (!localStorage.getItem('sb_access_token')) {
            window.location.href = 'login.html';
        } else {
            document.documentElement.style.visibility = 'visible';
        }
    </script>
    <style>html { visibility: hidden; }</style>

    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        html, body {
            height: 100%;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: #ffffff;
            color: #0A0203;
        }

        .app-wrapper { display: flex; min-height: 100vh; flex-direction: column; }

        /* Nav bar — identique au catalogue et app */
        .nav-bar {
            position: fixed;
            top: 0; left: 0; right: 0;
            background: #FFFFFF;
            border-bottom: 1px solid #C8C8C8;
            padding: 12px 60px;
            display: flex;
            align-items: center;
            gap: 32px;
            z-index: 100;
        }
        .nav-logo {
            font-size: 20px;
            font-weight: 400;
            color: #0A0203;
        }
        .nav-links { display: flex; align-items: center; gap: 16px; }
        .nav-back {
            color: #0A0203; text-decoration: none; font-size: 13px;
            opacity: 0.6; transition: opacity 0.15s; white-space: nowrap;
        }
        .nav-back:hover { opacity: 1; }
        .nav-user {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 13px;
        }
        .nav-user-email {
            color: #0A0203;
            opacity: 0.5;
        }
        .btn-logout {
            background: transparent;
            color: #0A0203;
            border: 1px solid #C8C8C8;
            padding: 5px 14px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.15s;
            font-family: inherit;
            border-radius: 3px;
        }
        .btn-logout:hover { background: #f5f5f5; border-color: #999; }

        /* Content */
        .app-content {
            flex: 1; padding: 40px;
            padding-top: 96px; /* 56px nav + 40px spacing */
            max-width: 1000px; margin: 0 auto; width: 100%;
        }

        .page-title { font-size: 24px; font-weight: 700; margin-bottom: 8px; }
        .page-sub { font-size: 14px; color: #666; margin-bottom: 32px; }

        /* Sections */
        .section {
            background: #F8F8F8; border: 1px solid #e0e0e0;
            border-radius: 6px; margin-bottom: 24px; overflow: hidden;
        }
        .section-toggle {
            display: flex; align-items: center; justify-content: space-between;
            padding: 20px 28px; cursor: pointer; user-select: none;
            transition: background 0.15s;
        }
        .section-toggle:hover { background: #f0f0ef; }
        .section-toggle-left { flex: 1; }
        .section-title { font-size: 16px; font-weight: 700; margin-bottom: 2px; }
        .section-desc { font-size: 13px; color: #888; margin: 0; }
        .section-chevron {
            width: 20px; height: 20px; flex-shrink: 0; margin-left: 16px;
            transition: transform 0.25s; color: #999;
        }
        .section.collapsed .section-chevron { transform: rotate(-90deg); }
        .section-content { padding: 0 28px 28px; }
        .section.collapsed .section-content { display: none; }

        /* Permissions table */
        .perm-table { width: 100%; border-collapse: collapse; }
        .perm-table th, .perm-table td {
            padding: 12px 16px; text-align: center;
            border-bottom: 1px solid #f0f0f0;
        }
        .perm-table th {
            font-size: 11px; text-transform: uppercase;
            letter-spacing: 0.5px; color: #888; font-weight: 600;
            background: #fafaf8;
        }
        .perm-table th:first-child, .perm-table td:first-child { text-align: left; }
        .perm-table td:first-child { font-weight: 600; font-size: 14px; }
        .perm-table tbody tr:last-child td { border-bottom: none; }
        .perm-table tbody tr:hover { background: #fdfcfa; }

        /* Toggle switch */
        .toggle { position: relative; display: inline-block; width: 38px; height: 22px; }
        .toggle input { opacity: 0; width: 0; height: 0; }
        .toggle .slider {
            position: absolute; cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #ddd; border-radius: 22px;
            transition: background 0.25s;
        }
        .toggle .slider::before {
            content: ''; position: absolute;
            height: 16px; width: 16px;
            left: 3px; bottom: 3px;
            background: #fff; border-radius: 50%;
            transition: transform 0.25s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.15);
        }
        .toggle input:checked + .slider { background: #4b6050; }
        .toggle input:checked + .slider::before { transform: translateX(16px); }

        /* Roles table */
        .roles-table { width: 100%; border-collapse: collapse; }
        .roles-table th, .roles-table td {
            padding: 10px 12px; text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }
        .roles-table th {
            font-size: 11px; text-transform: uppercase;
            letter-spacing: 0.5px; color: #888; font-weight: 600;
            background: #fafaf8;
        }
        .roles-table tbody tr:last-child td { border-bottom: none; }

        .input-email {
            width: 100%; padding: 8px 12px;
            border: 1px solid #e0e0e0; border-radius: 4px;
            font-family: inherit; font-size: 13px;
            transition: border-color 0.2s;
        }
        .input-email:focus { outline: none; border-color: #4b6050; }

        .select-role {
            padding: 8px 12px; border: 1px solid #e0e0e0;
            border-radius: 4px; font-family: inherit; font-size: 13px;
            background: #fff; cursor: pointer;
        }
        .select-role:focus { outline: none; border-color: #4b6050; }

        .btn-remove {
            background: none; border: none; color: #ccc;
            font-size: 20px; cursor: pointer; padding: 4px 8px;
            transition: color 0.2s;
        }
        .btn-remove:hover { color: #c0392b; }

        .btn-add {
            margin-top: 12px; background: none;
            border: 1px dashed #d0d0d0; color: #888;
            padding: 8px 20px; font-size: 13px; cursor: pointer;
            font-family: inherit; border-radius: 4px;
            transition: all 0.2s;
        }
        .btn-add:hover { border-color: #999; color: #555; }

        /* Save bar */
        .save-bar {
            display: flex; align-items: center; gap: 12px;
            margin-top: 20px; padding-top: 16px;
            border-top: 1px solid #f0f0f0;
        }
        .btn-save {
            background: #4b6050; color: #fff; border: none;
            padding: 10px 28px; font-size: 14px; font-weight: 500;
            cursor: pointer; border-radius: 4px; font-family: inherit;
            transition: opacity 0.2s;
        }
        .btn-save:hover { opacity: 0.9; }

        .save-feedback {
            font-size: 13px; color: #4b6050;
            opacity: 0; transition: opacity 0.3s;
        }
        .save-feedback.visible { opacity: 1; }
        .save-feedback.warn { color: #b8860b; }

        /* Footer */
        .app-footer {
            padding: 20px 40px; text-align: center;
            font-size: 11px; color: #999;
            border-top: 1px solid #e0e0e0;
        }

        @media (max-width: 768px) {
            .nav-bar { padding: 12px 20px; gap: 16px; }
            .app-content { padding: 24px 16px; padding-top: 80px; }
            .section-toggle { padding: 16px; }
            .section-content { padding: 0 16px 20px; }
            .perm-table th, .perm-table td { padding: 8px 6px; font-size: 12px; }
        }
    </style>
</head>
<body>
    <div class="app-wrapper">
        <nav class="nav-bar">
            <span class="nav-logo">stele</span>
            <div class="nav-links">
                <a href="app.html" class="nav-back">&larr; Menu</a>
            </div>
            <div class="nav-user">
                <span class="nav-user-email" id="userEmail"></span>
                <button class="btn-logout" onclick="handleLogout()">D&eacute;connexion</button>
            </div>
        </nav>

        <main class="app-content">
            <div class="page-title">Administration</div>
            <div class="page-sub">G&eacute;rez les permissions d'acc&egrave;s et les r&ocirc;les utilisateurs.</div>

            <!-- Permissions par role -->
            <div class="section" id="sectionPerm">
                <div class="section-toggle" onclick="toggleSection('sectionPerm')">
                    <div class="section-toggle-left">
                        <div class="section-title">Permissions par r&ocirc;le</div>
                        <div class="section-desc">D&eacute;finissez quels outils sont accessibles pour chaque r&ocirc;le.</div>
                    </div>
                    <svg class="section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="section-content">
                    <table class="perm-table">
                        <thead><tr id="permHead"></tr></thead>
                        <tbody id="permBody"></tbody>
                    </table>
                    <div class="save-bar">
                        <button class="btn-save" onclick="savePermissions()">Sauvegarder les permissions</button>
                        <span class="save-feedback" id="permFeedback"></span>
                    </div>
                </div>
            </div>

            <!-- Attribution des roles -->
            <div class="section" id="sectionRoles">
                <div class="section-toggle" onclick="toggleSection('sectionRoles')">
                    <div class="section-toggle-left">
                        <div class="section-title">Attribution des r&ocirc;les</div>
                        <div class="section-desc">Assignez un r&ocirc;le &agrave; chaque utilisateur par courriel.</div>
                    </div>
                    <svg class="section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="section-content">
                    <table class="roles-table">
                        <thead>
                            <tr>
                                <th style="width:55%">Courriel</th>
                                <th style="width:35%">R&ocirc;le</th>
                                <th style="width:10%"></th>
                            </tr>
                        </thead>
                        <tbody id="rolesBody"></tbody>
                    </table>
                    <button class="btn-add" onclick="addUserRow()">+ Ajouter un utilisateur</button>
                    <div class="save-bar">
                        <button class="btn-save" onclick="saveUserRoles()">Sauvegarder les r&ocirc;les</button>
                        <span class="save-feedback" id="rolesFeedback"></span>
                    </div>
                </div>
            </div>

            <!-- Categories du catalogue -->
            <div class="section" id="sectionCategories">
                <div class="section-toggle" onclick="toggleSection('sectionCategories')">
                    <div class="section-toggle-left">
                        <div class="section-title">Cat&eacute;gories du catalogue</div>
                        <div class="section-desc">G&eacute;rez les cat&eacute;gories disponibles pour classer les articles du catalogue.</div>
                    </div>
                    <svg class="section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="section-content">
                    <table class="roles-table">
                        <thead>
                            <tr>
                                <th style="width:85%">Cat&eacute;gorie</th>
                                <th style="width:15%"></th>
                            </tr>
                        </thead>
                        <tbody id="categoriesBody"></tbody>
                    </table>
                    <button class="btn-add" onclick="addCategoryRow()">+ Ajouter une cat&eacute;gorie</button>
                    <div class="save-bar">
                        <button class="btn-save" onclick="saveCategories()">Sauvegarder les cat&eacute;gories</button>
                        <span class="save-feedback" id="categoriesFeedback"></span>
                    </div>
                </div>
            </div>

            <!-- Tags medias -->
            <div class="section" id="sectionTags">
                <div class="section-toggle" onclick="toggleSection('sectionTags')">
                    <div class="section-toggle-left">
                        <div class="section-title">Tags m&eacute;dias</div>
                        <div class="section-desc">G&eacute;rez les &eacute;tiquettes pour organiser les images et documents.</div>
                    </div>
                    <svg class="section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="section-content">
                    <table class="roles-table">
                        <thead>
                            <tr>
                                <th style="width:85%">&Eacute;tiquette</th>
                                <th style="width:15%"></th>
                            </tr>
                        </thead>
                        <tbody id="tagsBody"></tbody>
                    </table>
                    <button class="btn-add" onclick="addTagRow()">+ Ajouter un tag</button>
                    <div class="save-bar">
                        <button class="btn-save" onclick="saveMediaTags()">Sauvegarder les tags</button>
                        <span class="save-feedback" id="tagsFeedback"></span>
                    </div>
                </div>
            </div>
        </main>

        <footer class="app-footer">stele — stele.ca</footer>
    </div>

    <script>
    /*
     * Pour activer la sauvegarde partagee dans Supabase, executez ce SQL
     * dans le SQL Editor de votre projet Supabase :
     *
     * CREATE TABLE app_config (
     *   key TEXT PRIMARY KEY,
     *   value JSONB NOT NULL,
     *   updated_at TIMESTAMPTZ DEFAULT now()
     * );
     * ALTER TABLE app_config ENABLE ROW LEVEL SECURITY;
     * CREATE POLICY "auth_read" ON app_config FOR SELECT TO authenticated USING (true);
     * CREATE POLICY "auth_write" ON app_config FOR ALL TO authenticated USING (true) WITH CHECK (true);
     *
     * Sans cette table, les donnees sont sauvegardees localement (navigateur uniquement).
     */

    var SUPABASE_URL = 'https://rplzbtjfnwahqodrhpny.supabase.co';
    var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJwbHpidGpmbndhaHFvZHJocG55Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NDU2MDEsImV4cCI6MjA4NjIyMTYwMX0.OQAZhc029PbRDSe1b02NDAuOUE8yn-_h3QqSnUDpLeU';

    // ── Pages (ajouter ici = nouvelle colonne automatique) ──
    var PAGES = [
        { key: 'catalogue', label: 'Catalogue' },
        { key: 'catalogue_edit', label: 'Modifier catalogue' },
        { key: 'calculateur', label: 'Calculateur' },
        { key: 'documents', label: 'Documents' },
        { key: 'assistant', label: 'Assistant vente' },
        { key: 'admin', label: 'Administration' },
        { key: 'approbation', label: 'Approbations' }
    ];

    var ROLES = ['Admin', 'Vente', 'Charg\u00e9 de projet', 'Achat', 'Atelier', 'Client'];

    var DEFAULT_PERMISSIONS = {
        'Admin':             { catalogue: true,  catalogue_edit: true,  calculateur: true,  documents: true,  assistant: true,  approbation: true,  admin: true  },
        'Vente':             { catalogue: true,  catalogue_edit: true,  calculateur: true,  documents: true,  assistant: true,  approbation: false, admin: false },
        'Charg\u00e9 de projet': { catalogue: true,  catalogue_edit: false, calculateur: true,  documents: true,  assistant: false, approbation: false, admin: false },
        'Achat':             { catalogue: true,  catalogue_edit: false, calculateur: false, documents: true,  assistant: false, approbation: false, admin: false },
        'Atelier':           { catalogue: false, catalogue_edit: false, calculateur: false, documents: true,  assistant: false, approbation: false, admin: false },
        'Client':            { catalogue: false, catalogue_edit: false, calculateur: false, documents: false, assistant: false, approbation: false, admin: false }
    };

    var DEFAULT_USER_ROLES = { 'hubert@stele.ca': 'Admin' };

    // ═══════════════════════════════════════════════════════════════════════
    // REFRESH AUTOMATIQUE DU TOKEN
    // ═══════════════════════════════════════════════════════════════════════

    async function refreshAccessToken() {
        var refreshToken = localStorage.getItem('sb_refresh_token');
        if (!refreshToken) return false;
        try {
            var response = await fetch(SUPABASE_URL + '/auth/v1/token?grant_type=refresh_token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'apikey': SUPABASE_KEY },
                body: JSON.stringify({ refresh_token: refreshToken })
            });
            if (!response.ok) return false;
            var data = await response.json();
            if (data.access_token) {
                localStorage.setItem('sb_access_token', data.access_token);
                localStorage.setItem('sb_refresh_token', data.refresh_token);
                return true;
            }
            return false;
        } catch (e) { return false; }
    }

    async function authenticatedFetch(url, options) {
        var tok = localStorage.getItem('sb_access_token');
        var headers = Object.assign({}, options.headers || {}, {
            'apikey': SUPABASE_KEY,
            'Authorization': 'Bearer ' + tok
        });
        var resp = await fetch(url, Object.assign({}, options, { headers: headers }));
        if (resp.status === 401) {
            var refreshed = await refreshAccessToken();
            if (refreshed) {
                headers['Authorization'] = 'Bearer ' + localStorage.getItem('sb_access_token');
                resp = await fetch(url, Object.assign({}, options, { headers: headers }));
            } else {
                localStorage.removeItem('sb_access_token');
                localStorage.removeItem('sb_refresh_token');
                window.location.href = 'login.html';
                return resp;
            }
        }
        return resp;
    }

    var permissions = {};
    var userRolesMap = {};
    var mediaTags = [];
    var catalogueCategories = [];
    var DEFAULT_MEDIA_TAGS = ['fiche_client', 'catalogue', 'technique', 'dessin'];
    var DEFAULT_CATEGORIES = ['Budg\u00e9taire', 'Panneaux', 'Poign\u00e9es', 'Tiroirs', '\u00c9clairage', 'Portes int\u00e9rieures'];

    // ── Toggle sections ──
    function toggleSection(id) {
        document.getElementById(id).classList.toggle('collapsed');
    }

    // Init
    document.getElementById('userEmail').textContent = localStorage.getItem('sb_user_email') || '';
    loadConfig();

    function loadConfig() {
        authenticatedFetch(SUPABASE_URL + '/rest/v1/app_config?select=key,value', {})
        .then(function(r) {
            if (!r.ok) throw new Error('not available');
            return r.json();
        })
        .then(function(rows) {
            if (Array.isArray(rows)) {
                for (var i = 0; i < rows.length; i++) {
                    if (rows[i].key === 'permissions') permissions = rows[i].value;
                    if (rows[i].key === 'user_roles') userRolesMap = rows[i].value;
                    if (rows[i].key === 'media_tags') mediaTags = rows[i].value;
                    if (rows[i].key === 'catalogue_categories') catalogueCategories = rows[i].value;
                }
            }
            applyDefaults();
            renderAll();
        })
        .catch(function() {
            applyDefaults();
            renderAll();
        });
    }

    function applyDefaults() {
        if (!Object.keys(permissions).length) {
            permissions = JSON.parse(JSON.stringify(DEFAULT_PERMISSIONS));
        }
        // S'assurer que tous les roles et pages existent
        for (var r = 0; r < ROLES.length; r++) {
            var role = ROLES[r];
            if (!permissions[role]) permissions[role] = {};
            for (var p = 0; p < PAGES.length; p++) {
                var pageKey = PAGES[p].key;
                if (permissions[role][pageKey] === undefined) {
                    var def = DEFAULT_PERMISSIONS[role];
                    permissions[role][pageKey] = def ? (def[pageKey] || false) : false;
                }
            }
        }
        if (!Object.keys(userRolesMap).length) {
            userRolesMap = JSON.parse(JSON.stringify(DEFAULT_USER_ROLES));
        }
        if (!Array.isArray(mediaTags) || !mediaTags.length) {
            mediaTags = DEFAULT_MEDIA_TAGS.slice();
        }
        if (!Array.isArray(catalogueCategories) || !catalogueCategories.length) {
            catalogueCategories = DEFAULT_CATEGORIES.slice();
        }
    }

    function renderAll() {
        renderPermTable();
        renderRolesTable();
        renderCategoriesTable();
        renderTagsTable();
    }

    // ── Permissions table ──

    function renderPermTable() {
        var head = document.getElementById('permHead');
        var body = document.getElementById('permBody');

        var headHtml = '<th>R\u00f4le</th>';
        for (var p = 0; p < PAGES.length; p++) {
            headHtml += '<th>' + PAGES[p].label + '</th>';
        }
        head.innerHTML = headHtml;

        var bodyHtml = '';
        for (var r = 0; r < ROLES.length; r++) {
            var role = ROLES[r];
            bodyHtml += '<tr><td>' + role + '</td>';
            for (var p2 = 0; p2 < PAGES.length; p2++) {
                var pk = PAGES[p2].key;
                var checked = (permissions[role] && permissions[role][pk]) ? ' checked' : '';
                bodyHtml += '<td><label class="toggle">' +
                    '<input type="checkbox" data-role="' + role + '" data-page="' + pk + '"' + checked + '>' +
                    '<span class="slider"></span></label></td>';
            }
            bodyHtml += '</tr>';
        }
        body.innerHTML = bodyHtml;
    }

    // ── User roles table ──

    function renderRolesTable() {
        var body = document.getElementById('rolesBody');
        var html = '';
        var emails = Object.keys(userRolesMap);
        for (var i = 0; i < emails.length; i++) {
            html += buildUserRowHtml(emails[i], userRolesMap[emails[i]]);
        }
        body.innerHTML = html;
    }

    function buildUserRowHtml(email, role) {
        var options = '';
        for (var i = 0; i < ROLES.length; i++) {
            var sel = (ROLES[i] === role) ? ' selected' : '';
            options += '<option value="' + ROLES[i] + '"' + sel + '>' + ROLES[i] + '</option>';
        }
        return '<tr>' +
            '<td><input type="email" class="input-email" value="' + escapeHtml(email) + '" placeholder="nom@entreprise.ca"></td>' +
            '<td><select class="select-role">' + options + '</select></td>' +
            '<td><button class="btn-remove" onclick="removeUserRow(this)" title="Retirer">&times;</button></td>' +
            '</tr>';
    }

    function addUserRow() {
        var body = document.getElementById('rolesBody');
        body.insertAdjacentHTML('beforeend', buildUserRowHtml('', 'Vente'));
        var inputs = body.querySelectorAll('.input-email');
        if (inputs.length) inputs[inputs.length - 1].focus();
    }

    function removeUserRow(btn) {
        if (!confirm('Retirer cet utilisateur ?')) return;
        var row = btn.parentNode.parentNode;
        row.parentNode.removeChild(row);
    }

    function escapeHtml(str) {
        var div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    // ── Categories du catalogue table ──

    function renderCategoriesTable() {
        var body = document.getElementById('categoriesBody');
        var html = '';
        for (var i = 0; i < catalogueCategories.length; i++) {
            html += buildCategoryRowHtml(catalogueCategories[i]);
        }
        body.innerHTML = html;
    }

    function buildCategoryRowHtml(cat) {
        return '<tr>' +
            '<td><input type="text" class="input-email" value="' + escapeHtml(cat) + '" placeholder="Nom de la cat\u00e9gorie"></td>' +
            '<td><button class="btn-remove" onclick="removeCategoryRow(this)" title="Retirer">&times;</button></td>' +
            '</tr>';
    }

    function addCategoryRow() {
        var body = document.getElementById('categoriesBody');
        body.insertAdjacentHTML('beforeend', buildCategoryRowHtml(''));
        var inputs = body.querySelectorAll('.input-email');
        if (inputs.length) inputs[inputs.length - 1].focus();
    }

    function removeCategoryRow(btn) {
        if (!confirm('Retirer cette cat\u00e9gorie ?')) return;
        var row = btn.parentNode.parentNode;
        row.parentNode.removeChild(row);
    }

    function saveCategories() {
        var newCats = [];
        var rows = document.querySelectorAll('#categoriesBody tr');
        for (var i = 0; i < rows.length; i++) {
            var val = rows[i].querySelector('.input-email').value.trim();
            if (!val) continue;
            if (newCats.indexOf(val) !== -1) continue;
            newCats.push(val);
        }
        catalogueCategories = newCats;
        saveConfig('catalogue_categories', catalogueCategories, 'categoriesFeedback');
    }

    // ── Tags médias table ──

    function renderTagsTable() {
        var body = document.getElementById('tagsBody');
        var html = '';
        for (var i = 0; i < mediaTags.length; i++) {
            html += buildTagRowHtml(mediaTags[i]);
        }
        body.innerHTML = html;
    }

    function buildTagRowHtml(tag) {
        var display = tag.replace(/_/g, ' ');
        return '<tr>' +
            '<td><input type="text" class="input-email" value="' + escapeHtml(display) + '" data-original="' + escapeHtml(tag) + '" placeholder="nom du tag"></td>' +
            '<td><button class="btn-remove" onclick="removeTagRow(this)" title="Retirer">&times;</button></td>' +
            '</tr>';
    }

    function addTagRow() {
        var body = document.getElementById('tagsBody');
        body.insertAdjacentHTML('beforeend', buildTagRowHtml(''));
        var inputs = body.querySelectorAll('.input-email');
        if (inputs.length) inputs[inputs.length - 1].focus();
    }

    function removeTagRow(btn) {
        if (!confirm('Retirer ce tag ?')) return;
        var row = btn.parentNode.parentNode;
        row.parentNode.removeChild(row);
    }

    async function saveMediaTags() {
        var newTags = [];
        var renames = []; // { from: oldTag, to: newTag }
        var rows = document.querySelectorAll('#tagsBody tr');
        for (var i = 0; i < rows.length; i++) {
            var input = rows[i].querySelector('.input-email');
            var oldTag = (input.getAttribute('data-original') || '').trim().toLowerCase().replace(/\s+/g, '_');
            var newTag = input.value.trim().toLowerCase().replace(/\s+/g, '_');
            if (!newTag) continue;
            if (newTags.indexOf(newTag) !== -1) continue; // déduplique
            newTags.push(newTag);
            if (oldTag && oldTag !== newTag) {
                renames.push({ from: oldTag, to: newTag });
            }
        }

        // Propager les renommages dans item_media
        if (renames.length > 0) {
            var fb = document.getElementById('tagsFeedback');
            fb.textContent = 'Mise \u00e0 jour des m\u00e9dias...';
            fb.style.color = '#666';
            fb.style.display = 'inline';

            try {
                // Fetch all item_media that have any of the renamed tags
                var oldNames = renames.map(function(r) { return r.from; });
                var mediaResp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/item_media?select=id,tags&tags=ov.{' + oldNames.join(',') + '}', {});
                if (mediaResp.ok) {
                    var mediaRows = await mediaResp.json();
                    for (var mi = 0; mi < mediaRows.length; mi++) {
                        var m = mediaRows[mi];
                        var updatedTags = m.tags.slice();
                        var changed = false;
                        for (var ri = 0; ri < renames.length; ri++) {
                            var idx = updatedTags.indexOf(renames[ri].from);
                            if (idx !== -1) {
                                updatedTags[idx] = renames[ri].to;
                                changed = true;
                            }
                        }
                        if (changed) {
                            await authenticatedFetch(SUPABASE_URL + '/rest/v1/item_media?id=eq.' + m.id, {
                                method: 'PATCH',
                                headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                                body: JSON.stringify({ tags: updatedTags })
                            });
                        }
                    }
                }
            } catch (e) {
                console.error('Erreur propagation tags:', e);
            }
        }

        mediaTags = newTags;
        saveConfig('media_tags', mediaTags, 'tagsFeedback');
    }

    // ── Save functions ──

    function savePermissions() {
        var newPerm = {};
        for (var r = 0; r < ROLES.length; r++) {
            newPerm[ROLES[r]] = {};
        }

        var checkboxes = document.querySelectorAll('#permBody input[type="checkbox"]');
        for (var i = 0; i < checkboxes.length; i++) {
            var cb = checkboxes[i];
            var role = cb.getAttribute('data-role');
            var page = cb.getAttribute('data-page');
            newPerm[role][page] = cb.checked;
        }

        permissions = newPerm;
        saveConfig('permissions', permissions, 'permFeedback');
    }

    function saveUserRoles() {
        var newRoles = {};
        var rows = document.querySelectorAll('#rolesBody tr');
        for (var i = 0; i < rows.length; i++) {
            var email = rows[i].querySelector('.input-email').value.trim().toLowerCase();
            var role = rows[i].querySelector('.select-role').value;
            if (email) newRoles[email] = role;
        }

        userRolesMap = newRoles;
        saveConfig('user_roles', userRolesMap, 'rolesFeedback');
    }

    function saveConfig(key, value, feedbackId) {
        var fb = document.getElementById(feedbackId);

        authenticatedFetch(SUPABASE_URL + '/rest/v1/app_config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Prefer': 'resolution=merge-duplicates'
            },
            body: JSON.stringify({ key: key, value: value, updated_at: new Date().toISOString() })
        })
        .then(function(r) {
            if (r.ok || r.status === 201) {
                showFeedback(fb, 'Sauvegard\u00e9 avec succ\u00e8s', false);
            } else {
                throw new Error('save failed');
            }
        })
        .catch(function() {
            // Fallback localStorage
            localStorage.setItem('stele_' + key, JSON.stringify(value));
            showFeedback(fb, 'Sauvegard\u00e9 localement — cr\u00e9ez la table Supabase pour partager', true);
        });
    }

    function showFeedback(el, msg, isWarn) {
        el.textContent = (isWarn ? '' : '\u2713 ') + msg;
        el.className = 'save-feedback visible' + (isWarn ? ' warn' : '');
        setTimeout(function() { el.className = 'save-feedback'; }, 4000);
    }

    function handleLogout() {
        localStorage.removeItem('sb_access_token');
        localStorage.removeItem('sb_refresh_token');
        localStorage.removeItem('sb_user_email');
        localStorage.removeItem('sb_user_id');
        window.location.href = 'login.html';
    }
    </script>
</body>
</html>
