<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administration — Stele</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">

    <!-- Auth guard -->
    <script>
        if (!localStorage.getItem('sb_access_token')) {
            window.location.href = 'login.html';
        } else {
            document.documentElement.style.visibility = 'visible';
        }
    </script>
    <style>html { visibility: hidden; }</style>

    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        html, body {
            height: 100%;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: #ffffff;
            color: #0A0203;
        }

        .app-wrapper { display: flex; min-height: 100vh; flex-direction: column; }

        /* Nav bar — identique au catalogue et app */
        .nav-bar {
            position: fixed;
            top: 0; left: 0; right: 0;
            background: #FFFFFF;
            border-bottom: 1px solid #C8C8C8;
            padding: 12px 60px;
            display: flex;
            align-items: center;
            gap: 32px;
            z-index: 100;
        }
        .nav-logo {
            font-size: 20px;
            font-weight: 400;
            color: #0A0203;
        }
        .nav-links { display: flex; align-items: center; gap: 16px; }
        .nav-back {
            color: #0A0203; text-decoration: none; font-size: 13px;
            opacity: 0.6; transition: opacity 0.15s; white-space: nowrap;
        }
        .nav-back:hover { opacity: 1; }
        .nav-user {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 13px;
        }
        .nav-user-email {
            color: #0A0203;
            opacity: 0.5;
        }
        .btn-logout {
            background: transparent;
            color: #0A0203;
            border: 1px solid #C8C8C8;
            padding: 5px 14px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.15s;
            font-family: inherit;
            border-radius: 3px;
        }
        .btn-logout:hover { background: #f5f5f5; border-color: #999; }

        /* Content */
        .app-content {
            flex: 1; padding: 40px;
            padding-top: 96px; /* 56px nav + 40px spacing */
            max-width: 1000px; margin: 0 auto; width: 100%;
        }

        .page-title { font-size: 24px; font-weight: 700; margin-bottom: 8px; }
        .page-sub { font-size: 14px; color: #666; margin-bottom: 32px; }

        /* Sections */
        .section {
            background: #F8F8F8; border: 1px solid #e0e0e0;
            border-radius: 6px; margin-bottom: 24px; overflow: hidden;
        }
        .section-toggle {
            display: flex; align-items: center; justify-content: space-between;
            padding: 20px 28px; cursor: pointer; user-select: none;
            transition: background 0.15s;
        }
        .section-toggle:hover { background: #f0f0ef; }
        .section-toggle-left { flex: 1; }
        .section-title { font-size: 16px; font-weight: 700; margin-bottom: 2px; }
        .section-desc { font-size: 13px; color: #888; margin: 0; }
        .section-chevron {
            width: 20px; height: 20px; flex-shrink: 0; margin-left: 16px;
            transition: transform 0.25s; color: #999;
        }
        .section.collapsed .section-chevron { transform: rotate(-90deg); }
        .section-content { padding: 0 28px 28px; }
        .section.collapsed .section-content { display: none; }

        /* Permissions table */
        .perm-table { min-width: 100%; border-collapse: collapse; white-space: nowrap; }
        .perm-table th, .perm-table td {
            padding: 12px 16px; text-align: center;
            border-bottom: 1px solid #f0f0f0;
        }
        .perm-table th {
            font-size: 11px; text-transform: uppercase;
            letter-spacing: 0.5px; color: #888; font-weight: 600;
            background: #fafaf8;
        }
        .perm-table th:first-child, .perm-table td:first-child { text-align: left; }
        .perm-table td:first-child { font-weight: 600; font-size: 14px; }
        .perm-table tbody tr:last-child td { border-bottom: none; }
        .perm-table tbody tr:hover { background: #fdfcfa; }

        /* Toggle switch */
        .toggle { position: relative; display: inline-block; width: 38px; height: 22px; }
        .toggle input { opacity: 0; width: 0; height: 0; }
        .toggle .slider {
            position: absolute; cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #ddd; border-radius: 22px;
            transition: background 0.25s;
        }
        .toggle .slider::before {
            content: ''; position: absolute;
            height: 16px; width: 16px;
            left: 3px; bottom: 3px;
            background: #fff; border-radius: 50%;
            transition: transform 0.25s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.15);
        }
        .toggle input:checked + .slider { background: #4b6050; }
        .toggle input:checked + .slider::before { transform: translateX(16px); }

        /* Roles table */
        .roles-table { width: 100%; border-collapse: collapse; }
        .roles-table th, .roles-table td {
            padding: 10px 12px; text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }
        .roles-table th {
            font-size: 11px; text-transform: uppercase;
            letter-spacing: 0.5px; color: #888; font-weight: 600;
            background: #fafaf8;
        }
        .roles-table tbody tr:last-child td { border-bottom: none; }

        .input-email {
            width: 100%; padding: 8px 12px;
            border: 1px solid #e0e0e0; border-radius: 4px;
            font-family: inherit; font-size: 13px;
            transition: border-color 0.2s;
        }
        .input-email:focus { outline: none; border-color: #4b6050; }

        .select-role {
            padding: 8px 12px; border: 1px solid #e0e0e0;
            border-radius: 4px; font-family: inherit; font-size: 13px;
            background: #fff; cursor: pointer;
        }
        .select-role:focus { outline: none; border-color: #4b6050; }

        .btn-remove {
            background: none; border: none; color: #ccc;
            font-size: 20px; cursor: pointer; padding: 4px 8px;
            transition: color 0.2s;
        }
        .btn-remove:hover { color: #c0392b; }

        .btn-add {
            margin-top: 12px; background: none;
            border: 1px dashed #d0d0d0; color: #888;
            padding: 8px 20px; font-size: 13px; cursor: pointer;
            font-family: inherit; border-radius: 4px;
            transition: all 0.2s;
        }
        .btn-add:hover { border-color: #999; color: #555; }

        /* Save bar */
        .save-bar {
            display: flex; align-items: center; gap: 12px;
            margin-top: 20px; padding-top: 16px;
            border-top: 1px solid #f0f0f0;
        }
        .btn-save {
            background: #4b6050; color: #fff; border: none;
            padding: 10px 28px; font-size: 14px; font-weight: 500;
            cursor: pointer; border-radius: 4px; font-family: inherit;
            transition: opacity 0.2s;
        }
        .btn-save:hover { opacity: 0.9; }

        .save-feedback {
            font-size: 13px; color: #4b6050;
            opacity: 0; transition: opacity 0.3s;
        }
        .save-feedback.visible { opacity: 1; }
        .save-feedback.warn { color: #b8860b; }

        /* Numeric inputs (taux horaires) */
        .input-number {
            width: 100%; padding: 8px 12px;
            border: 1px solid #e0e0e0; border-radius: 4px;
            font-family: inherit; font-size: 13px;
            text-align: right;
            transition: border-color 0.2s;
        }
        .input-number:focus { outline: none; border-color: #4b6050; }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }
        .profit-cell {
            font-weight: 600; font-size: 14px; text-align: right;
            padding-right: 14px;
        }
        .profit-cell.negative { color: #c0392b; }

        /* Footer */
        .app-footer {
            padding: 20px 40px; text-align: center;
            font-size: 11px; color: #999;
            border-top: 1px solid #e0e0e0;
        }

        /* Role modal */
        .role-modal {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 1000;
            align-items: center; justify-content: center;
            padding: 20px;
        }
        .role-modal-content {
            background: #fff; border-radius: 8px;
            max-width: 600px; width: 100%;
            max-height: 90vh; overflow-y: auto;
            box-shadow: 0 4px 24px rgba(0,0,0,0.15);
        }
        .role-modal-header {
            padding: 24px 28px; border-bottom: 1px solid #e0e0e0;
            display: flex; align-items: center; justify-content: space-between;
        }
        .role-modal-title {
            font-size: 18px; font-weight: 700; margin: 0;
        }
        .role-modal-close {
            background: none; border: none; font-size: 24px;
            color: #999; cursor: pointer; padding: 0; width: 32px; height: 32px;
        }
        .role-modal-close:hover { color: #333; }
        .role-modal-body {
            padding: 24px 28px;
        }
        .role-form-group {
            margin-bottom: 20px;
        }
        .role-form-label {
            display: block; font-size: 13px; font-weight: 600;
            margin-bottom: 6px; color: #333;
        }
        .role-form-input {
            width: 100%; padding: 10px 12px;
            border: 1px solid #e0e0e0; border-radius: 4px;
            font-family: inherit; font-size: 14px;
        }
        .role-form-input:focus {
            outline: none; border-color: #4b6050;
        }
        .role-form-textarea {
            min-height: 60px; resize: vertical;
        }
        .role-perm-grid {
            display: grid; grid-template-columns: repeat(2, 1fr);
            gap: 12px 16px; margin-top: 12px;
        }
        .role-perm-item {
            display: flex; align-items: center; gap: 8px;
        }
        .role-perm-item input[type="checkbox"] {
            width: 18px; height: 18px; cursor: pointer;
        }
        .role-perm-item label {
            font-size: 13px; color: #555; cursor: pointer;
        }
        .role-modal-footer {
            padding: 16px 28px; border-top: 1px solid #e0e0e0;
            display: flex; gap: 12px; justify-content: flex-end;
        }
        .btn-modal {
            padding: 10px 24px; font-size: 14px; font-weight: 500;
            border: none; border-radius: 4px; cursor: pointer;
            font-family: inherit; transition: opacity 0.2s;
        }
        .btn-modal:hover { opacity: 0.85; }
        .btn-modal-cancel {
            background: #f5f5f5; color: #555;
        }
        .btn-modal-save {
            background: #4b6050; color: #fff;
        }

        @media (max-width: 768px) {
            .nav-bar { padding: 12px 20px; gap: 16px; }
            .app-content { padding: 24px 16px; padding-top: 80px; }
            .section-toggle { padding: 16px; }
            .section-content { padding: 0 16px 20px; }
            .perm-table th, .perm-table td { padding: 8px 6px; font-size: 12px; }
            .role-perm-grid { grid-template-columns: 1fr; }
        }
        /* Stele dialog */
        .stele-dialog-overlay {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.45);
            z-index: 9999; justify-content: center; align-items: center;
        }
        .stele-dialog-overlay.active { display: flex; }
        .stele-dialog {
            background: #fff; border-radius: 10px; box-shadow: 0 8px 32px rgba(0,0,0,0.25);
            max-width: 440px; width: 90%; overflow: hidden;
        }
        .stele-dialog-header { padding: 18px 24px 0; }
        .stele-dialog-header h3 { font-size: 15px; font-weight: 700; color: var(--stele-black); margin: 0; }
        .stele-dialog-body { padding: 12px 24px 20px; }
        .stele-dialog-body p { font-size: 14px; color: #444; margin: 0; }
        .stele-dialog-footer { display: flex; justify-content: flex-end; gap: 8px; padding: 0 24px 18px; }
        .stele-dialog-footer button {
            padding: 8px 20px; border-radius: 6px; font-size: 13px; font-weight: 600;
            cursor: pointer; border: 1px solid #ccc; transition: background 0.15s;
        }
        .stele-dialog-btn-cancel { background: #f5f5f5; color: #333; }
        .stele-dialog-btn-cancel:hover { background: #e8e8e8; }
        .stele-dialog-btn-ok { background: var(--stele-green); color: #fff; border-color: var(--stele-green); }
        .stele-dialog-btn-ok:hover { opacity: 0.9; }
    </style>
</head>
<body>
    <div class="app-wrapper">
        <nav class="nav-bar">
            <span class="nav-logo">stele</span>
            <div class="nav-links">
                <a href="app.html" class="nav-back">&larr; Menu</a>
            </div>
            <div class="nav-user">
                <span class="nav-user-email" id="userEmail"></span>
                <button class="btn-logout" onclick="handleLogout()">D&eacute;connexion</button>
            </div>
        </nav>

        <main class="app-content">
            <div class="page-title">Administration</div>
            <div class="page-sub">G&eacute;rez les permissions d'acc&egrave;s et les r&ocirc;les utilisateurs.</div>

            <!-- Permissions par role -->
            <div class="section collapsed" id="sectionPerm">
                <div class="section-toggle" onclick="toggleSection('sectionPerm')">
                    <div class="section-toggle-left">
                        <div class="section-title">Permissions par r&ocirc;le</div>
                        <div class="section-desc">D&eacute;finissez quels outils sont accessibles pour chaque r&ocirc;le.</div>
                    </div>
                    <svg class="section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="section-content">
                    <div style="overflow-x:auto;">
                    <table class="perm-table">
                        <thead><tr id="permHead"></tr></thead>
                        <tbody id="permBody"></tbody>
                    </table>
                    </div>
                    <div class="save-bar">
                        <button class="btn-save" onclick="savePermissions()">Sauvegarder les permissions</button>
                        <span class="save-feedback" id="permFeedback"></span>
                    </div>
                </div>
            </div>

            <!-- Gestion des rôles -->
            <div class="section collapsed" id="sectionManageRoles">
                <div class="section-toggle" onclick="toggleSection('sectionManageRoles')">
                    <div class="section-toggle-left">
                        <div class="section-title">Gestion des r&ocirc;les</div>
                        <div class="section-desc">Cr&eacute;ez, modifiez et supprimez les r&ocirc;les disponibles dans le syst&egrave;me.</div>
                    </div>
                    <svg class="section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="section-content">
                    <table class="roles-table">
                        <thead>
                            <tr>
                                <th style="width:25%">Nom du r&ocirc;le</th>
                                <th style="width:50%">Description</th>
                                <th style="width:15%">Type</th>
                                <th style="width:10%"></th>
                            </tr>
                        </thead>
                        <tbody id="manageRolesBody"></tbody>
                    </table>
                    <button class="btn-add" onclick="openRoleModal()">+ Nouveau r&ocirc;le</button>
                </div>
            </div>

            <!-- Attribution des roles -->
            <div class="section collapsed" id="sectionRoles">
                <div class="section-toggle" onclick="toggleSection('sectionRoles')">
                    <div class="section-toggle-left">
                        <div class="section-title">Attribution des r&ocirc;les</div>
                        <div class="section-desc">Assignez un r&ocirc;le &agrave; chaque utilisateur par courriel.</div>
                    </div>
                    <svg class="section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="section-content">
                    <table class="roles-table">
                        <thead>
                            <tr>
                                <th style="width:20%">Nom</th>
                                <th style="width:25%">Courriel</th>
                                <th style="width:15%">T&eacute;l&eacute;phone</th>
                                <th style="width:20%">Entreprise</th>
                                <th style="width:15%">R&ocirc;le</th>
                                <th style="width:5%"></th>
                            </tr>
                        </thead>
                        <tbody id="rolesBody"></tbody>
                    </table>
                    <button class="btn-add" onclick="addUserRow()">+ Ajouter un utilisateur</button>
                    <div class="save-bar">
                        <button class="btn-save" onclick="saveUserRoles()">Sauvegarder les r&ocirc;les</button>
                        <span class="save-feedback" id="rolesFeedback"></span>
                    </div>
                </div>
            </div>

            <!-- Categories du catalogue -->
            <div class="section collapsed" id="sectionCategories">
                <div class="section-toggle" onclick="toggleSection('sectionCategories')">
                    <div class="section-toggle-left">
                        <div class="section-title">Cat&eacute;gories du catalogue</div>
                        <div class="section-desc">G&eacute;rez les cat&eacute;gories disponibles pour classer les articles du catalogue.</div>
                    </div>
                    <svg class="section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="section-content">
                    <table class="roles-table">
                        <thead>
                            <tr>
                                <th style="width:85%">Cat&eacute;gorie</th>
                                <th style="width:15%"></th>
                            </tr>
                        </thead>
                        <tbody id="categoriesBody"></tbody>
                    </table>
                    <button class="btn-add" onclick="addCategoryRow()">+ Ajouter une cat&eacute;gorie</button>
                    <div class="save-bar">
                        <button class="btn-save" onclick="saveCategories()">Sauvegarder les cat&eacute;gories</button>
                        <span class="save-feedback" id="categoriesFeedback"></span>
                    </div>
                </div>
            </div>

            <!-- Tags medias -->
            <div class="section collapsed" id="sectionTags">
                <div class="section-toggle" onclick="toggleSection('sectionTags')">
                    <div class="section-toggle-left">
                        <div class="section-title">Tags m&eacute;dias</div>
                        <div class="section-desc">G&eacute;rez les &eacute;tiquettes pour organiser les images et documents.</div>
                    </div>
                    <svg class="section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="section-content">
                    <table class="roles-table">
                        <thead>
                            <tr>
                                <th style="width:85%">&Eacute;tiquette</th>
                                <th style="width:15%"></th>
                            </tr>
                        </thead>
                        <tbody id="tagsBody"></tbody>
                    </table>
                    <button class="btn-add" onclick="addTagRow()">+ Ajouter un tag</button>
                    <div class="save-bar">
                        <button class="btn-save" onclick="saveMediaTags()">Sauvegarder les tags</button>
                        <span class="save-feedback" id="tagsFeedback"></span>
                    </div>
                </div>
            </div>
            <!-- Types d'entreprise -->
            <div class="section collapsed" id="sectionCompanyTypes">
                <div class="section-toggle" onclick="toggleSection('sectionCompanyTypes')">
                    <div class="section-toggle-left">
                        <div class="section-title">Types d'entreprise</div>
                        <div class="section-desc">G&eacute;rez les types disponibles pour classer les entreprises (CRM).</div>
                    </div>
                    <svg class="section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="section-content">
                    <table class="roles-table">
                        <thead><tr><th style="width:85%">Type</th><th style="width:15%"></th></tr></thead>
                        <tbody id="companyTypesBody"></tbody>
                    </table>
                    <button class="btn-add" onclick="addCompanyTypeRow()">+ Ajouter un type</button>
                    <div class="save-bar">
                        <button class="btn-save" onclick="saveCompanyTypes()">Sauvegarder les types</button>
                        <span class="save-feedback" id="companyTypesFeedback"></span>
                    </div>
                </div>
            </div>

            <!-- R&ocirc;les de contact -->
            <div class="section collapsed" id="sectionContactRoles">
                <div class="section-toggle" onclick="toggleSection('sectionContactRoles')">
                    <div class="section-toggle-left">
                        <div class="section-title">R&ocirc;les de contact</div>
                        <div class="section-desc">R&ocirc;les possibles d'un contact dans une entreprise (CRM).</div>
                    </div>
                    <svg class="section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="section-content">
                    <table class="roles-table">
                        <thead><tr><th style="width:85%">R&ocirc;le</th><th style="width:15%"></th></tr></thead>
                        <tbody id="contactRolesBody"></tbody>
                    </table>
                    <button class="btn-add" onclick="addContactRoleRow()">+ Ajouter un r&ocirc;le</button>
                    <div class="save-bar">
                        <button class="btn-save" onclick="saveContactRoles()">Sauvegarder les r&ocirc;les</button>
                        <span class="save-feedback" id="contactRolesFeedback"></span>
                    </div>
                </div>
            </div>

            <!-- Types de communication -->
            <div class="section collapsed" id="sectionCommTypes">
                <div class="section-toggle" onclick="toggleSection('sectionCommTypes')">
                    <div class="section-toggle-left">
                        <div class="section-title">Types de communication</div>
                        <div class="section-desc">Types d'&eacute;changes pour le suivi des communications (CRM).</div>
                    </div>
                    <svg class="section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="section-content">
                    <table class="roles-table">
                        <thead><tr><th style="width:85%">Type</th><th style="width:15%"></th></tr></thead>
                        <tbody id="commTypesBody"></tbody>
                    </table>
                    <button class="btn-add" onclick="addCommTypeRow()">+ Ajouter un type</button>
                    <div class="save-bar">
                        <button class="btn-save" onclick="saveCommTypes()">Sauvegarder les types</button>
                        <span class="save-feedback" id="commTypesFeedback"></span>
                    </div>
                </div>
            </div>

            <!-- Catégories de dépenses -->
            <div class="section collapsed" id="sectionExpenses">
                <div class="section-toggle" onclick="toggleSection('sectionExpenses')">
                    <div class="section-toggle-left">
                        <div class="section-title">Cat&eacute;gories de d&eacute;penses</div>
                        <div class="section-desc">G&eacute;rez les cat&eacute;gories de d&eacute;penses mat&eacute;riaux et leur markup par d&eacute;faut.</div>
                    </div>
                    <svg class="section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="section-content">
                    <table class="roles-table" id="expensesTable">
                        <thead>
                            <tr>
                                <th style="width:50%">Cat&eacute;gorie</th>
                                <th style="width:20%">Markup (%)</th>
                                <th style="width:20%">Perte (%)</th>
                                <th style="width:10%"></th>
                            </tr>
                        </thead>
                        <tbody id="expensesBody"></tbody>
                    </table>
                    <button class="btn-add" onclick="addExpenseRow()">+ Ajouter une cat&eacute;gorie de d&eacute;pense</button>
                    <div class="save-bar">
                        <button class="btn-save" onclick="saveExpenseCategories()">Sauvegarder les d&eacute;penses</button>
                        <span class="save-feedback" id="expensesFeedback"></span>
                    </div>
                </div>
            </div>

            <!-- Données de base — Taux horaires -->
            <div class="section collapsed" id="sectionTaux">
                <div class="section-toggle" onclick="toggleSection('sectionTaux')">
                    <div class="section-toggle-left">
                        <div class="section-title">Donn&eacute;es de base</div>
                        <div class="section-desc">Taux horaires par d&eacute;partement &mdash; frais fixe, salaire et profit.</div>
                    </div>
                    <svg class="section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="section-content">
                    <table class="roles-table" id="tauxTable">
                        <thead>
                            <tr>
                                <th>D&eacute;partement</th>
                                <th style="width:18%">Taux horaire</th>
                                <th style="width:18%">Frais fixe</th>
                                <th style="width:18%">Salaire</th>
                                <th style="width:14%">Profit</th>
                            </tr>
                        </thead>
                        <tbody id="tauxBody"></tbody>
                    </table>
                    <div class="save-bar">
                        <button class="btn-save" onclick="saveTaux()">Sauvegarder les taux</button>
                        <span class="save-feedback" id="tauxFeedback"></span>
                    </div>
                </div>
            </div>

            <!-- Nomenclature des tags -->
            <div class="section collapsed" id="sectionTagPrefixes">
                <div class="section-toggle" onclick="toggleSection('sectionTagPrefixes')">
                    <div class="section-toggle-left">
                        <div class="section-title">Nomenclature des tags</div>
                        <div class="section-desc">Pr&eacute;fixes utilis&eacute;s pour identifier les &eacute;l&eacute;ments sur les plans (C1, F2, P3, etc.)</div>
                    </div>
                    <svg class="section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="section-content">
                    <table class="roles-table" id="tagPrefixTable">
                        <thead>
                            <tr>
                                <th style="width:15%">Pr&eacute;fixe</th>
                                <th>Label</th>
                                <th style="width:10%"></th>
                            </tr>
                        </thead>
                        <tbody id="tagPrefixBody"></tbody>
                    </table>
                    <div class="save-bar">
                        <button class="btn-outline" onclick="addTagPrefix()" style="margin-right:8px;">+ Ajouter</button>
                        <button class="btn-save" onclick="saveTagPrefixes()">Sauvegarder les tags</button>
                        <span class="save-feedback" id="tagsFeedback"></span>
                    </div>
                </div>
            </div>

            <div class="section collapsed" id="sectionCoverImage">
                <div class="section-toggle" onclick="toggleSection('sectionCoverImage')">
                    <div class="section-toggle-left">
                        <div class="section-title">Image de couverture</div>
                        <div class="section-desc">Image de fond plein &eacute;cran sur la page de couverture des soumissions client.</div>
                    </div>
                    <svg class="section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="section-content">
                    <div style="display:flex; gap:24px; align-items:flex-start; flex-wrap:wrap;">
                        <div style="flex:1; min-width:280px;">
                            <p style="font-size:13px; color:#888; margin-bottom:16px;">
                                Cette image appara&icirc;t en arri&egrave;re-plan plein &eacute;cran sur la page de couverture des soumissions client.
                                Format recommand&eacute; : JPEG ou PNG, ratio paysage (16:9), haute r&eacute;solution.
                                L'image est compress&eacute;e automatiquement avant l'upload. Si aucune image n'est configur&eacute;e, un fond sombre uni sera affich&eacute;.
                            </p>
                            <label class="btn-outline" style="cursor:pointer; display:inline-block;">
                                Choisir une image
                                <input type="file" id="coverImageInput" accept="image/*" onchange="uploadCoverImage(this)" style="display:none;">
                            </label>
                            <button class="btn-outline" onclick="removeCoverImage()" style="margin-left:8px; color:#c00;">Supprimer</button>
                            <span class="save-feedback" id="coverFeedback"></span>
                        </div>
                        <div id="coverImagePreview" style="width:240px; height:320px; border-radius:8px; overflow:hidden; background:#0B0F17; border:1px solid #e0e0e0; display:flex; align-items:center; justify-content:center;">
                            <span style="color:#666; font-size:13px;" id="coverImagePlaceholder">Aucune image</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statuts du pipeline -->
            <div class="section collapsed" id="sectionPipelineStatuses">
                <div class="section-toggle" onclick="toggleSection('sectionPipelineStatuses')">
                    <div class="section-toggle-left">
                        <div class="section-title">Statuts du pipeline</div>
                        <div class="section-desc">G&eacute;rez les &eacute;tapes du pipeline commercial (projets).</div>
                    </div>
                    <svg class="section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="section-content">
                    <table class="roles-table" id="pipelineStatusesTable">
                        <thead>
                            <tr>
                                <th style="width:40%">Label</th>
                                <th style="width:15%">Couleur</th>
                                <th style="width:35%">Slug</th>
                                <th style="width:10%"></th>
                            </tr>
                        </thead>
                        <tbody id="pipelineStatusesBody"></tbody>
                    </table>
                    <button class="btn-add" onclick="addPipelineStatusRow()">+ Ajouter un statut</button>
                    <div class="save-bar">
                        <button class="btn-save" onclick="savePipelineStatuses()">Sauvegarder les statuts</button>
                        <span class="save-feedback" id="pipelineStatusesFeedback"></span>
                    </div>
                </div>
            </div>

            <!-- Sources de projet -->
            <div class="section collapsed" id="sectionProjectSources">
                <div class="section-toggle" onclick="toggleSection('sectionProjectSources')">
                    <div class="section-toggle-left">
                        <div class="section-title">Sources de projet</div>
                        <div class="section-desc">D'o&ugrave; proviennent les projets (AO, r&eacute;f&eacute;rence, direct, etc.).</div>
                    </div>
                    <svg class="section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="section-content">
                    <table class="roles-table">
                        <thead><tr><th style="width:85%">Source</th><th style="width:15%"></th></tr></thead>
                        <tbody id="projectSourcesBody"></tbody>
                    </table>
                    <button class="btn-add" onclick="addProjectSourceRow()">+ Ajouter une source</button>
                    <div class="save-bar">
                        <button class="btn-save" onclick="saveProjectSources()">Sauvegarder les sources</button>
                        <span class="save-feedback" id="projectSourcesFeedback"></span>
                    </div>
                </div>
            </div>

            <!-- Types de projet -->
            <div class="section collapsed" id="sectionProjectTypes">
                <div class="section-toggle" onclick="toggleSection('sectionProjectTypes')">
                    <div class="section-toggle-left">
                        <div class="section-title">Types de projet</div>
                        <div class="section-desc">Classification des projets (r&eacute;sidentiel, commercial, institutionnel, etc.).</div>
                    </div>
                    <svg class="section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </div>
                <div class="section-content">
                    <table class="roles-table">
                        <thead><tr><th style="width:85%">Type</th><th style="width:15%"></th></tr></thead>
                        <tbody id="projectTypesBody"></tbody>
                    </table>
                    <button class="btn-add" onclick="addProjectTypeRow()">+ Ajouter un type</button>
                    <div class="save-bar">
                        <button class="btn-save" onclick="saveProjectTypes()">Sauvegarder les types</button>
                        <span class="save-feedback" id="projectTypesFeedback"></span>
                    </div>
                </div>
            </div>
        </main>

        <footer class="app-footer">stele — stele.ca</footer>
    </div>

    <!-- Role management modal -->
    <div class="role-modal" id="roleModal" onclick="if(event.target === this) closeRoleModal()">
        <div class="role-modal-content">
            <div class="role-modal-header">
                <h2 class="role-modal-title" id="roleModalTitle">Nouveau r&ocirc;le</h2>
                <button class="role-modal-close" onclick="closeRoleModal()">&times;</button>
            </div>
            <div class="role-modal-body">
                <div class="role-form-group">
                    <label class="role-form-label">Nom du r&ocirc;le *</label>
                    <input type="text" class="role-form-input" id="roleNameInput" placeholder="Ex: Gestionnaire">
                </div>
                <div class="role-form-group">
                    <label class="role-form-label">Description</label>
                    <textarea class="role-form-input role-form-textarea" id="roleDescInput" placeholder="Description du r&ocirc;le et de ses responsabilit&eacute;s"></textarea>
                </div>
                <div class="role-form-group">
                    <label class="role-form-label">Permissions</label>
                    <div class="role-perm-grid" id="rolePermChecks">
                        <script>
                        // Generate checkboxes for all permissions
                        document.write((function() {
                            var html = '';
                            for (var i = 0; i < PAGES.length; i++) {
                                var page = PAGES[i];
                                html += '<div class="role-perm-item">' +
                                    '<input type="checkbox" id="rolePerm_' + page.key + '">' +
                                    '<label for="rolePerm_' + page.key + '">' + page.label + '</label>' +
                                    '</div>';
                            }
                            return html;
                        })());
                        </script>
                    </div>
                </div>
            </div>
            <div class="role-modal-footer">
                <button class="btn-modal btn-modal-cancel" onclick="closeRoleModal()">Annuler</button>
                <button class="btn-modal btn-modal-save" id="roleSaveBtn" onclick="saveRole()">Sauvegarder</button>
            </div>
        </div>
    </div>

    <!-- Stele dialog -->
    <div class="stele-dialog-overlay" id="steleDialogOverlay">
        <div class="stele-dialog">
            <div class="stele-dialog-header"><h3 id="steleDialogTitle"></h3></div>
            <div class="stele-dialog-body"><p id="steleDialogMessage"></p></div>
            <div class="stele-dialog-footer">
                <button class="stele-dialog-btn-cancel" id="steleDialogCancel" onclick="steleDialogResolve(null)">Annuler</button>
                <button class="stele-dialog-btn-ok" id="steleDialogOk" onclick="steleDialogResolve(true)">Confirmer</button>
            </div>
        </div>
    </div>

    <script>
    /*
     * Pour activer la sauvegarde partagee dans Supabase, executez ce SQL
     * dans le SQL Editor de votre projet Supabase :
     *
     * CREATE TABLE app_config (
     *   key TEXT PRIMARY KEY,
     *   value JSONB NOT NULL,
     *   updated_at TIMESTAMPTZ DEFAULT now()
     * );
     * ALTER TABLE app_config ENABLE ROW LEVEL SECURITY;
     * CREATE POLICY "auth_read" ON app_config FOR SELECT TO authenticated USING (true);
     * CREATE POLICY "auth_write" ON app_config FOR ALL TO authenticated USING (true) WITH CHECK (true);
     *
     * Sans cette table, les donnees sont sauvegardees localement (navigateur uniquement).
     */

    // ── Stele Dialog ──
    var _steleDialogResolve = null;
    function steleDialogResolve(val) {
        document.getElementById('steleDialogOverlay').classList.remove('active');
        if (_steleDialogResolve) { var fn = _steleDialogResolve; _steleDialogResolve = null; fn(val); }
    }
    function steleConfirm(msg, title) {
        return new Promise(function(resolve) {
            _steleDialogResolve = resolve;
            document.getElementById('steleDialogTitle').textContent = title || 'Confirmation';
            document.getElementById('steleDialogMessage').textContent = msg;
            document.getElementById('steleDialogOverlay').classList.add('active');
        });
    }

    var SUPABASE_URL = 'https://rplzbtjfnwahqodrhpny.supabase.co';
    var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJwbHpidGpmbndhaHFvZHJocG55Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NDU2MDEsImV4cCI6MjA4NjIyMTYwMX0.OQAZhc029PbRDSe1b02NDAuOUE8yn-_h3QqSnUDpLeU';

    // ── Pages (ajouter ici = nouvelle colonne automatique) ──
    var PAGES = [
        { key: 'catalogue', label: 'Catalogue' },
        { key: 'catalogue_edit', label: 'Modifier catalogue' },
        { key: 'calculateur', label: 'Calculateur' },
        { key: 'clients', label: 'Clients' },
        { key: 'documents', label: 'Documents' },
        { key: 'assistant', label: 'Assistant vente' },
        { key: 'admin', label: 'Administration' },
        { key: 'approbation', label: 'Approbations' },
        { key: 'edit_minutes', label: 'Modifier minutes' },
        { key: 'edit_materials', label: 'Modifier mat\u00e9riaux' },
        { key: 'can_approve_quotes', label: 'Approuver soumissions' },
        { key: 'can_bypass_approval', label: 'Bypass approbation' },
        { key: 'can_unlock_submission', label: 'D\u00e9verrouiller soumissions' }
    ];

    var ROLES = ['Admin', 'Vente', 'Charg\u00e9 de projet', 'Achat', 'Atelier', 'Client'];

    var DEFAULT_PERMISSIONS = {
        'Admin':             { catalogue: true,  catalogue_edit: true,  calculateur: true,  clients: true,  documents: true,  assistant: true,  approbation: true,  admin: true,  edit_minutes: true,  edit_materials: true,  can_approve_quotes: true,  can_bypass_approval: true,  can_unlock_submission: true  },
        'Vente':             { catalogue: true,  catalogue_edit: true,  calculateur: true,  clients: true,  documents: true,  assistant: true,  approbation: false, admin: false, edit_minutes: false, edit_materials: false, can_approve_quotes: false, can_bypass_approval: false, can_unlock_submission: false },
        'Charg\u00e9 de projet': { catalogue: true,  catalogue_edit: false, calculateur: true,  clients: true,  documents: true,  assistant: false, approbation: false, admin: false, edit_minutes: false, edit_materials: false, can_approve_quotes: false, can_bypass_approval: false, can_unlock_submission: false },
        'Achat':             { catalogue: true,  catalogue_edit: false, calculateur: false, clients: false, documents: true,  assistant: false, approbation: false, admin: false, edit_minutes: false, edit_materials: true,  can_approve_quotes: false, can_bypass_approval: false, can_unlock_submission: false },
        'Atelier':           { catalogue: false, catalogue_edit: false, calculateur: false, clients: false, documents: true,  assistant: false, approbation: false, admin: false, edit_minutes: false, edit_materials: false, can_approve_quotes: false, can_bypass_approval: false, can_unlock_submission: false },
        'Client':            { catalogue: false, catalogue_edit: false, calculateur: false, clients: false, documents: false, assistant: false, approbation: false, admin: false, edit_minutes: false, edit_materials: false, can_approve_quotes: false, can_bypass_approval: false, can_unlock_submission: false }
    };

    var DEFAULT_USER_ROLES = { 'hubert@stele.ca': 'Admin' };

    // ═══════════════════════════════════════════════════════════════════════
    // REFRESH AUTOMATIQUE DU TOKEN
    // ═══════════════════════════════════════════════════════════════════════

    async function refreshAccessToken() {
        var refreshToken = localStorage.getItem('sb_refresh_token');
        if (!refreshToken) return false;
        try {
            var response = await fetch(SUPABASE_URL + '/auth/v1/token?grant_type=refresh_token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'apikey': SUPABASE_KEY },
                body: JSON.stringify({ refresh_token: refreshToken })
            });
            if (!response.ok) return false;
            var data = await response.json();
            if (data.access_token) {
                localStorage.setItem('sb_access_token', data.access_token);
                localStorage.setItem('sb_refresh_token', data.refresh_token);
                return true;
            }
            return false;
        } catch (e) { return false; }
    }

    async function authenticatedFetch(url, options) {
        var tok = localStorage.getItem('sb_access_token');
        var headers = Object.assign({}, options.headers || {}, {
            'apikey': SUPABASE_KEY,
            'Authorization': 'Bearer ' + tok
        });
        var resp = await fetch(url, Object.assign({}, options, { headers: headers }));
        if (resp.status === 401) {
            var refreshed = await refreshAccessToken();
            if (refreshed) {
                headers['Authorization'] = 'Bearer ' + localStorage.getItem('sb_access_token');
                resp = await fetch(url, Object.assign({}, options, { headers: headers }));
            } else {
                localStorage.removeItem('sb_access_token');
                localStorage.removeItem('sb_refresh_token');
                window.location.href = 'login.html';
                return resp;
            }
        }
        return resp;
    }

    function checkPageAccess() {
        var email = (localStorage.getItem('sb_user_email') || '').toLowerCase();
        var roles = Object.keys(userRolesMap).length ? userRolesMap : DEFAULT_USER_ROLES;
        var role = roles[email] || 'Client';
        var perms = Object.keys(permissions).length ? permissions : DEFAULT_PERMISSIONS;
        var defaults = DEFAULT_PERMISSIONS[role] || {};
        var saved = perms[role] || {};
        var allowed = {};
        for (var k in defaults) allowed[k] = defaults[k];
        for (var k2 in saved) allowed[k2] = saved[k2];
        if (!allowed.admin) { window.location.href = 'app.html'; return false; }
        return true;
    }

    var permissions = {};
    var userRolesMap = {};
    var userProfiles = {}; // { email: { name, phone, company } }
    var rolesFromDB = []; // Roles loaded from database
    var mediaTags = [];
    var catalogueCategories = [];
    var DEFAULT_MEDIA_TAGS = ['fiche_client', 'catalogue', 'technique', 'dessin'];
    var DEFAULT_CATEGORIES = ['Budg\u00e9taire', 'Panneaux', 'Poign\u00e9es', 'Tiroirs', '\u00c9clairage', 'Portes int\u00e9rieures'];
    var DEPARTMENTS = [
        'Gestion/dessin', 'Coupe/edge', 'Assemblage',
        'Machinage', 'Sablage', 'Peinture', 'Installation'
    ];
    var tauxHoraires = [];
    var DEFAULT_EXPENSE_CATEGORIES = [
        {name:'BANDE DE CHANT',markup:30,waste:0},{name:'BOIS BRUT',markup:30,waste:0},{name:'COLLAGE DE BOIS',markup:30,waste:0},
        {name:'D\u00c9COUPE NUM\u00c9RIQUE',markup:30,waste:0},{name:'D\u00c9M\u00c9NAGEMENT',markup:30,waste:0},{name:'DIVERS',markup:30,waste:0},
        {name:'\u00c9CLAIRAGE',markup:30,waste:0},{name:'FINITION BOIS',markup:30,waste:0},{name:'FINITION OPAQUE',markup:30,waste:0},
        {name:'FINITION TEINTURE',markup:30,waste:0},{name:'FOURNITURE BUREAU',markup:30,waste:0},{name:"FOURNITURE D'ATELIER",markup:30,waste:0},
        {name:'M\u00c9TAL',markup:30,waste:0},{name:'PANNEAU BOIS',markup:30,waste:0},{name:'PANNEAU MDF',markup:30,waste:0},
        {name:'PANNEAU M\u00c9LAMINE',markup:30,waste:0},{name:'PLACAGE',markup:30,waste:0},{name:'POIGN\u00c9ES',markup:30,waste:0},
        {name:'QUINCAILLERIE',markup:30,waste:0},{name:'SOUS TRAITANCE',markup:30,waste:0},{name:'STRATIFI\u00c9',markup:30,waste:0},
        {name:'TIROIRS',markup:30,waste:0},{name:'VITRIER',markup:30,waste:0},{name:'PORTES SOUS TRAITANCE',markup:30,waste:0}
    ];
    var expenseCategories = [];
    var companyTypes = [];
    var contactRoles = [];
    var communicationTypes = [];
    var tagPrefixes = [];
    var DEFAULT_TAG_PREFIXES = [
        { prefix: 'C', label_fr: 'Caisson', label_en: 'Cabinet', sort_order: 1 },
        { prefix: 'F', label_fr: 'Filler', label_en: 'Filler', sort_order: 2 },
        { prefix: 'P', label_fr: 'Panneau', label_en: 'Panel', sort_order: 3 },
        { prefix: 'T', label_fr: 'Tiroir', label_en: 'Drawer', sort_order: 4 },
        { prefix: 'M', label_fr: 'Moulure', label_en: 'Moulding', sort_order: 5 },
        { prefix: 'A', label_fr: 'Accessoire', label_en: 'Accessory', sort_order: 6 }
    ];
    var DEFAULT_COMPANY_TYPES = ['Designer', 'Architecte', 'Entrepreneur', 'Promoteur', 'Particulier', 'Autre'];
    var DEFAULT_CONTACT_ROLES = ['Propri\u00e9taire', 'Designer principal', 'Architecte', 'Charg\u00e9 de projet', 'Adjoint(e)', 'Comptabilit\u00e9', 'Autre'];
    var DEFAULT_COMM_TYPES = ['Appel', 'Courriel', 'Texto', 'Rencontre', 'Note'];

    var DEFAULT_PIPELINE_STATUSES = [
        {slug:'a_contacter',label:'A contacter',color:'#9e9e9e',sort_order:1},
        {slug:'en_attente_infos',label:'En attente d\'infos',color:'#ff9800',sort_order:2},
        {slug:'a_soumissionner',label:'A soumissionner',color:'#2196f3',sort_order:3},
        {slug:'en_revision',label:'En revision',color:'#9c27b0',sort_order:4},
        {slug:'a_presenter',label:'A presenter',color:'#00bcd4',sort_order:5},
        {slug:'envoye',label:'Envoye',color:'#3f51b5',sort_order:6},
        {slug:'en_discussions',label:'En discussions',color:'#ff5722',sort_order:7},
        {slug:'vendu',label:'Vendu',color:'#4caf50',sort_order:8},
        {slug:'perdu',label:'Perdu',color:'#f44336',sort_order:9}
    ];
    var DEFAULT_PROJECT_SOURCES = ['AO sous invitation','R\u00e9f\u00e9rence','Direct','Site web','Salon/Expo','Bouche-\u00e0-oreille'];
    var DEFAULT_PROJECT_TYPES = ['R\u00e9sidentiel','R\u00e9sidentiel d\'envergure','Commercial','Collaboration','Autre'];
    var pipelineStatuses = [];
    var projectSources = [];
    var projectTypes = [];

    // ── Helper functions ──

    function escapeAttr(str) {
        return (str || '').replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;');
    }

    // Returns the active list of roles (from DB if available, otherwise hardcoded)
    function getActiveRoles() {
        if (rolesFromDB.length > 0) {
            return rolesFromDB.map(function(r) { return r.name; });
        }
        return ROLES.slice();
    }

    // Get permissions for a role (always from app_config permissions object)
    function getRolePermissions(roleName) {
        return permissions[roleName] || {};
    }

    // ── Toggle sections ──
    function toggleSection(id) {
        document.getElementById(id).classList.toggle('collapsed');
    }

    // Init
    document.getElementById('userEmail').textContent = localStorage.getItem('sb_user_email') || '';
    loadConfig();

    async function loadUserProfiles() {
        try {
            // Fetch user profiles with contact and company data
            var r = await authenticatedFetch(
                SUPABASE_URL + '/rest/v1/user_profiles?select=user_id,contact_id,contacts(first_name,last_name,phone,email,contact_companies(companies(name)))',
                {}
            );
            if (!r.ok) return;
            var profiles = await r.json();

            // Build map: email -> { name, phone, company }
            userProfiles = {};
            for (var i = 0; i < profiles.length; i++) {
                var p = profiles[i];
                if (!p.contacts) continue;
                var contact = p.contacts;
                var email = contact.email;
                var name = (contact.first_name || '') + ' ' + (contact.last_name || '');
                name = name.trim() || '—';
                var phone = contact.phone || '—';
                var company = '—';
                if (contact.contact_companies && contact.contact_companies.length > 0) {
                    var cc = contact.contact_companies[0];
                    if (cc.companies) company = cc.companies.name;
                }
                userProfiles[email] = { name: name, phone: phone, company: company };
            }
        } catch (e) {
            console.error('Error loading user profiles:', e);
        }
    }

    async function loadRoles() {
        try {
            var r = await authenticatedFetch(
                SUPABASE_URL + '/rest/v1/roles?select=*&order=sort_order.asc,name.asc',
                {}
            );
            if (!r.ok) {
                console.warn('Could not load roles from database, using hardcoded roles');
                return;
            }
            var roles = await r.json();
            if (roles && roles.length > 0) {
                rolesFromDB = roles;
                console.log('Loaded ' + roles.length + ' roles from database');
            }
        } catch (e) {
            console.error('Error loading roles:', e);
        }
    }

    async function loadUserRoles() {
        try {
            var r = await authenticatedFetch(
                SUPABASE_URL + '/rest/v1/user_roles?select=email,role_id,roles(name)',
                {}
            );
            if (!r.ok) {
                console.warn('Could not load user roles from database, using app_config fallback');
                return;
            }
            var assignments = await r.json();
            if (assignments && assignments.length > 0) {
                // Build map: email -> role name
                userRolesMap = {};
                for (var i = 0; i < assignments.length; i++) {
                    var a = assignments[i];
                    if (a.roles && a.roles.name) {
                        userRolesMap[a.email.toLowerCase()] = a.roles.name;
                    }
                }
                console.log('Loaded ' + assignments.length + ' user role assignments from database');
            }
        } catch (e) {
            console.error('Error loading user roles:', e);
        }
    }

    function loadConfig() {
        authenticatedFetch(SUPABASE_URL + '/rest/v1/app_config?select=key,value', {})
        .then(function(r) {
            if (!r.ok) throw new Error('not available');
            return r.json();
        })
        .then(async function(rows) {
            if (Array.isArray(rows)) {
                for (var i = 0; i < rows.length; i++) {
                    if (rows[i].key === 'permissions') permissions = rows[i].value;
                    if (rows[i].key === 'user_roles') userRolesMap = rows[i].value;
                    if (rows[i].key === 'media_tags') mediaTags = rows[i].value;
                    if (rows[i].key === 'catalogue_categories') catalogueCategories = rows[i].value;
                    if (rows[i].key === 'taux_horaires') tauxHoraires = rows[i].value;
                    if (rows[i].key === 'expense_categories') expenseCategories = rows[i].value;
                    if (rows[i].key === 'company_types') companyTypes = rows[i].value;
                    if (rows[i].key === 'contact_roles') contactRoles = rows[i].value;
                    if (rows[i].key === 'communication_types') communicationTypes = rows[i].value;
                    if (rows[i].key === 'tag_prefixes') tagPrefixes = rows[i].value;
                    if (rows[i].key === 'pipeline_statuses') pipelineStatuses = rows[i].value;
                    if (rows[i].key === 'project_sources') projectSources = rows[i].value;
                    if (rows[i].key === 'project_types') projectTypes = rows[i].value;
                }
            }
            await loadUserProfiles();
            await loadRoles();
            await loadUserRoles(); // Load user role assignments from database
            applyDefaults();
            if (!checkPageAccess()) return;
            renderAll();
        })
        .catch(async function() {
            await loadUserProfiles();
            await loadRoles();
            await loadUserRoles(); // Load user role assignments from database
            applyDefaults();
            if (!checkPageAccess()) return;
            renderAll();
        });
    }

    function applyDefaults() {
        if (!Object.keys(permissions).length) {
            permissions = JSON.parse(JSON.stringify(DEFAULT_PERMISSIONS));
        }
        // S'assurer que tous les roles et pages existent
        var activeRoles = getActiveRoles();
        for (var r = 0; r < activeRoles.length; r++) {
            var role = activeRoles[r];
            if (!permissions[role]) permissions[role] = {};
            for (var p = 0; p < PAGES.length; p++) {
                var pageKey = PAGES[p].key;
                if (permissions[role][pageKey] === undefined) {
                    var def = DEFAULT_PERMISSIONS[role];
                    permissions[role][pageKey] = def ? (def[pageKey] || false) : false;
                }
            }
        }
        if (!Object.keys(userRolesMap).length) {
            userRolesMap = JSON.parse(JSON.stringify(DEFAULT_USER_ROLES));
        }
        if (!Array.isArray(mediaTags) || !mediaTags.length) {
            mediaTags = DEFAULT_MEDIA_TAGS.slice();
        }
        if (!Array.isArray(catalogueCategories) || !catalogueCategories.length) {
            catalogueCategories = DEFAULT_CATEGORIES.slice();
        }
        if (!Array.isArray(tauxHoraires) || !tauxHoraires.length) {
            tauxHoraires = DEPARTMENTS.map(function(d) {
                return { department: d, taux_horaire: 0, frais_fixe: 0, salaire: 0 };
            });
        }
        DEPARTMENTS.forEach(function(d) {
            if (!tauxHoraires.find(function(t) { return t.department === d; })) {
                tauxHoraires.push({ department: d, taux_horaire: 0, frais_fixe: 0, salaire: 0 });
            }
        });
        if (!Array.isArray(expenseCategories) || !expenseCategories.length) {
            expenseCategories = JSON.parse(JSON.stringify(DEFAULT_EXPENSE_CATEGORIES));
        }
        if (!Array.isArray(companyTypes) || !companyTypes.length) {
            companyTypes = DEFAULT_COMPANY_TYPES.slice();
        }
        if (!Array.isArray(contactRoles) || !contactRoles.length) {
            contactRoles = DEFAULT_CONTACT_ROLES.slice();
        }
        if (!Array.isArray(communicationTypes) || !communicationTypes.length) {
            communicationTypes = DEFAULT_COMM_TYPES.slice();
        }
        if (!Array.isArray(tagPrefixes) || !tagPrefixes.length) {
            tagPrefixes = JSON.parse(JSON.stringify(DEFAULT_TAG_PREFIXES));
        }
        if (!Array.isArray(pipelineStatuses) || !pipelineStatuses.length) {
            pipelineStatuses = JSON.parse(JSON.stringify(DEFAULT_PIPELINE_STATUSES));
        }
        if (!Array.isArray(projectSources) || !projectSources.length) {
            projectSources = DEFAULT_PROJECT_SOURCES.slice();
        }
        if (!Array.isArray(projectTypes) || !projectTypes.length) {
            projectTypes = DEFAULT_PROJECT_TYPES.slice();
        }
    }

    function renderAll() {
        renderPermTable();
        renderManageRolesTable();
        renderRolesTable();
        renderCategoriesTable();
        renderTagsTable();
        renderTauxTable();
        renderExpensesTable();
        renderCompanyTypesTable();
        renderContactRolesTable();
        renderCommTypesTable();
        renderTagPrefixTable();
        renderPipelineStatusesTable();
        renderProjectSourcesTable();
        renderProjectTypesTable();
    }

    // ── Permissions table ──

    function renderPermTable() {
        var head = document.getElementById('permHead');
        var body = document.getElementById('permBody');

        var headHtml = '<th>R\u00f4le</th>';
        for (var p = 0; p < PAGES.length; p++) {
            headHtml += '<th>' + PAGES[p].label + '</th>';
        }
        head.innerHTML = headHtml;

        var activeRoles = getActiveRoles();
        var bodyHtml = '';
        for (var r = 0; r < activeRoles.length; r++) {
            var roleName = activeRoles[r];
            var rolePerms = getRolePermissions(roleName);

            bodyHtml += '<tr><td>' + roleName + '</td>';
            for (var p2 = 0; p2 < PAGES.length; p2++) {
                var pk = PAGES[p2].key;
                var checked = rolePerms[pk] ? ' checked' : '';
                bodyHtml += '<td><label class="toggle">' +
                    '<input type="checkbox" data-role="' + roleName + '" data-page="' + pk + '"' + checked + '>' +
                    '<span class="slider"></span></label></td>';
            }
            bodyHtml += '</tr>';
        }
        body.innerHTML = bodyHtml;
    }

    // ── Manage roles table ──

    function renderManageRolesTable() {
        var body = document.getElementById('manageRolesBody');
        if (!body) return;

        var html = '';
        var rolesToDisplay = rolesFromDB.length > 0 ? rolesFromDB : [];

        // If no roles from DB, show hardcoded roles as read-only reference
        if (rolesToDisplay.length === 0) {
            for (var i = 0; i < ROLES.length; i++) {
                html += '<tr>' +
                    '<td style="font-weight:500;">' + escapeHtml(ROLES[i]) + '</td>' +
                    '<td style="color:#888; font-size:13px;">R&ocirc;le syst&egrave;me (hardcoded)</td>' +
                    '<td><span style="background:#f0f0f0; padding:3px 8px; border-radius:3px; font-size:11px; color:#666;">SYST&Egrave;ME</span></td>' +
                    '<td></td>' +
                    '</tr>';
            }
        } else {
            for (var i = 0; i < rolesToDisplay.length; i++) {
                var role = rolesToDisplay[i];
                var isSystem = role.is_system || false;
                var typeLabel = isSystem ? 'SYST&Egrave;ME' : 'CUSTOM';
                var typeBg = isSystem ? '#f0f0f0' : '#e8f5e9';
                var typeColor = isSystem ? '#666' : '#2e7d32';

                html += '<tr>' +
                    '<td style="font-weight:500;">' + escapeHtml(role.name) + '</td>' +
                    '<td style="color:#666; font-size:13px;">' + escapeHtml(role.description || '—') + '</td>' +
                    '<td><span style="background:' + typeBg + '; padding:3px 8px; border-radius:3px; font-size:11px; color:' + typeColor + ';">' + typeLabel + '</span></td>' +
                    '<td style="text-align:right;">' +
                        '<button class="btn-remove" onclick="editRole(\'' + role.id + '\')" title="Modifier" style="color:#4b6050;">&bull;&bull;&bull;</button>' +
                        (isSystem ? '' : '<button class="btn-remove" onclick="deleteRole(\'' + role.id + '\')" title="Supprimer">&times;</button>') +
                    '</td>' +
                    '</tr>';
            }
        }

        body.innerHTML = html;
    }

    // ── User roles table ──

    function renderRolesTable() {
        var body = document.getElementById('rolesBody');
        var html = '';
        var emails = Object.keys(userRolesMap);
        for (var i = 0; i < emails.length; i++) {
            html += buildUserRowHtml(emails[i], userRolesMap[emails[i]]);
        }
        body.innerHTML = html;
    }

    function buildUserRowHtml(email, role) {
        var activeRoles = getActiveRoles();
        var options = '';
        for (var i = 0; i < activeRoles.length; i++) {
            var sel = (activeRoles[i] === role) ? ' selected' : '';
            options += '<option value="' + activeRoles[i] + '"' + sel + '>' + activeRoles[i] + '</option>';
        }

        // Get enriched data from user profiles
        var profile = userProfiles[email] || {};
        var name = profile.name || '—';
        var phone = profile.phone || '—';
        var company = profile.company || '—';

        return '<tr>' +
            '<td style="color:#555; font-weight:500;">' + escapeHtml(name) + '</td>' +
            '<td><input type="email" class="input-email" value="' + escapeHtml(email) + '" placeholder="nom@entreprise.ca"></td>' +
            '<td style="color:#888; font-size:12px;">' + escapeHtml(phone) + '</td>' +
            '<td style="color:#888; font-size:12px;">' + escapeHtml(company) + '</td>' +
            '<td><select class="select-role">' + options + '</select></td>' +
            '<td><button class="btn-remove" onclick="removeUserRow(this)" title="Retirer">&times;</button></td>' +
            '</tr>';
    }

    function addUserRow() {
        var body = document.getElementById('rolesBody');
        body.insertAdjacentHTML('beforeend', buildUserRowHtml('', 'Vente'));
        var inputs = body.querySelectorAll('.input-email');
        if (inputs.length) inputs[inputs.length - 1].focus();
    }

    async function removeUserRow(btn) {
        if (!await steleConfirm('Retirer cet utilisateur ?')) return;
        var row = btn.parentNode.parentNode;
        row.parentNode.removeChild(row);
    }

    function escapeHtml(str) {
        var div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    // ── Categories du catalogue table ──

    function renderCategoriesTable() {
        var body = document.getElementById('categoriesBody');
        var html = '';
        for (var i = 0; i < catalogueCategories.length; i++) {
            html += buildCategoryRowHtml(catalogueCategories[i]);
        }
        body.innerHTML = html;
    }

    function buildCategoryRowHtml(cat) {
        return '<tr>' +
            '<td><input type="text" class="input-email" value="' + escapeHtml(cat) + '" placeholder="Nom de la cat\u00e9gorie"></td>' +
            '<td><button class="btn-remove" onclick="removeCategoryRow(this)" title="Retirer">&times;</button></td>' +
            '</tr>';
    }

    function addCategoryRow() {
        var body = document.getElementById('categoriesBody');
        body.insertAdjacentHTML('beforeend', buildCategoryRowHtml(''));
        var inputs = body.querySelectorAll('.input-email');
        if (inputs.length) inputs[inputs.length - 1].focus();
    }

    async function removeCategoryRow(btn) {
        if (!await steleConfirm('Retirer cette catégorie ?')) return;
        var row = btn.parentNode.parentNode;
        row.parentNode.removeChild(row);
    }

    function saveCategories() {
        var newCats = [];
        var rows = document.querySelectorAll('#categoriesBody tr');
        for (var i = 0; i < rows.length; i++) {
            var val = rows[i].querySelector('.input-email').value.trim();
            if (!val) continue;
            if (newCats.indexOf(val) !== -1) continue;
            newCats.push(val);
        }
        catalogueCategories = newCats;
        saveConfig('catalogue_categories', catalogueCategories, 'categoriesFeedback');
    }

    // ── Tags médias table ──

    function renderTagsTable() {
        var body = document.getElementById('tagsBody');
        var html = '';
        for (var i = 0; i < mediaTags.length; i++) {
            html += buildTagRowHtml(mediaTags[i]);
        }
        body.innerHTML = html;
    }

    function buildTagRowHtml(tag) {
        var display = tag.replace(/_/g, ' ');
        return '<tr>' +
            '<td><input type="text" class="input-email" value="' + escapeHtml(display) + '" data-original="' + escapeHtml(tag) + '" placeholder="nom du tag"></td>' +
            '<td><button class="btn-remove" onclick="removeTagRow(this)" title="Retirer">&times;</button></td>' +
            '</tr>';
    }

    function addTagRow() {
        var body = document.getElementById('tagsBody');
        body.insertAdjacentHTML('beforeend', buildTagRowHtml(''));
        var inputs = body.querySelectorAll('.input-email');
        if (inputs.length) inputs[inputs.length - 1].focus();
    }

    async function removeTagRow(btn) {
        if (!await steleConfirm('Retirer ce tag ?')) return;
        var row = btn.parentNode.parentNode;
        row.parentNode.removeChild(row);
    }

    async function saveMediaTags() {
        var newTags = [];
        var renames = []; // { from: oldTag, to: newTag }
        var rows = document.querySelectorAll('#tagsBody tr');
        for (var i = 0; i < rows.length; i++) {
            var input = rows[i].querySelector('.input-email');
            var oldTag = (input.getAttribute('data-original') || '').trim().toLowerCase().replace(/\s+/g, '_');
            var newTag = input.value.trim().toLowerCase().replace(/\s+/g, '_');
            if (!newTag) continue;
            if (newTags.indexOf(newTag) !== -1) continue; // déduplique
            newTags.push(newTag);
            if (oldTag && oldTag !== newTag) {
                renames.push({ from: oldTag, to: newTag });
            }
        }

        // Propager les renommages dans item_media
        if (renames.length > 0) {
            var fb = document.getElementById('tagsFeedback');
            fb.textContent = 'Mise \u00e0 jour des m\u00e9dias...';
            fb.style.color = '#666';
            fb.style.display = 'inline';

            try {
                // Fetch all item_media that have any of the renamed tags
                var oldNames = renames.map(function(r) { return r.from; });
                var mediaResp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/item_media?select=id,tags&tags=ov.{' + oldNames.join(',') + '}', {});
                if (mediaResp.ok) {
                    var mediaRows = await mediaResp.json();
                    for (var mi = 0; mi < mediaRows.length; mi++) {
                        var m = mediaRows[mi];
                        var updatedTags = m.tags.slice();
                        var changed = false;
                        for (var ri = 0; ri < renames.length; ri++) {
                            var idx = updatedTags.indexOf(renames[ri].from);
                            if (idx !== -1) {
                                updatedTags[idx] = renames[ri].to;
                                changed = true;
                            }
                        }
                        if (changed) {
                            await authenticatedFetch(SUPABASE_URL + '/rest/v1/item_media?id=eq.' + m.id, {
                                method: 'PATCH',
                                headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                                body: JSON.stringify({ tags: updatedTags })
                            });
                        }
                    }
                }
            } catch (e) {
                console.error('Erreur propagation tags:', e);
            }
        }

        mediaTags = newTags;
        saveConfig('media_tags', mediaTags, 'tagsFeedback');
    }

    // ── Expense categories table ──

    function renderExpensesTable() {
        var body = document.getElementById('expensesBody');
        var html = '';
        for (var i = 0; i < expenseCategories.length; i++) {
            html += buildExpenseRowHtml(expenseCategories[i].name, expenseCategories[i].markup, expenseCategories[i].waste);
        }
        body.innerHTML = html;
    }

    function buildExpenseRowHtml(name, markup, waste) {
        return '<tr>' +
            '<td><input type="text" class="input-email" value="' + escapeHtml(name) + '" placeholder="Nom de la cat\u00e9gorie"></td>' +
            '<td><input type="number" class="input-number" value="' + (markup || 0) + '" placeholder="0" step="1" min="0"></td>' +
            '<td><input type="number" class="input-number input-waste" value="' + (waste || 0) + '" placeholder="0" step="1" min="0"></td>' +
            '<td><button class="btn-remove" onclick="removeExpenseRow(this)" title="Retirer">&times;</button></td>' +
            '</tr>';
    }

    function addExpenseRow() {
        var body = document.getElementById('expensesBody');
        body.insertAdjacentHTML('beforeend', buildExpenseRowHtml('', 30, 0));
        var inputs = body.querySelectorAll('.input-email');
        if (inputs.length) inputs[inputs.length - 1].focus();
    }

    async function removeExpenseRow(btn) {
        if (!await steleConfirm('Retirer cette catégorie de dépense ?')) return;
        var row = btn.parentNode.parentNode;
        row.parentNode.removeChild(row);
    }

    function saveExpenseCategories() {
        var newCats = [];
        var rows = document.querySelectorAll('#expensesBody tr');
        for (var i = 0; i < rows.length; i++) {
            var nameVal = rows[i].querySelector('.input-email').value.trim();
            if (!nameVal) continue;
            var markupVal = parseFloat(rows[i].querySelector('.input-number').value) || 0;
            var wasteInput = rows[i].querySelector('.input-waste');
            var wasteVal = parseFloat(wasteInput ? wasteInput.value : 0) || 0;
            newCats.push({ name: nameVal, markup: markupVal, waste: wasteVal });
        }
        expenseCategories = newCats;
        saveConfig('expense_categories', expenseCategories, 'expensesFeedback');
    }

    // ── Taux horaires table ──

    function renderTauxTable() {
        var body = document.getElementById('tauxBody');
        var html = '';
        for (var i = 0; i < tauxHoraires.length; i++) {
            var t = tauxHoraires[i];
            var profit = (t.taux_horaire || 0) - (t.frais_fixe || 0) - (t.salaire || 0);
            var profitClass = profit < 0 ? ' negative' : '';
            html += '<tr>' +
                '<td style="font-weight:600">' + escapeHtml(t.department) + '</td>' +
                '<td><input type="number" class="input-number" data-dept="' + i + '" data-field="taux_horaire" value="' + (t.taux_horaire || '') + '" placeholder="0.00" step="0.01" oninput="updateProfit(this)"></td>' +
                '<td><input type="number" class="input-number" data-dept="' + i + '" data-field="frais_fixe" value="' + (t.frais_fixe || '') + '" placeholder="0.00" step="0.01" oninput="updateProfit(this)"></td>' +
                '<td><input type="number" class="input-number" data-dept="' + i + '" data-field="salaire" value="' + (t.salaire || '') + '" placeholder="0.00" step="0.01" oninput="updateProfit(this)"></td>' +
                '<td class="profit-cell' + profitClass + '" id="profit_' + i + '">' + profit.toFixed(2) + ' $</td>' +
                '</tr>';
        }
        body.innerHTML = html;
    }

    function updateProfit(input) {
        var row = input.closest('tr');
        var inputs = row.querySelectorAll('.input-number');
        var taux = parseFloat(inputs[0].value) || 0;
        var fixe = parseFloat(inputs[1].value) || 0;
        var sal  = parseFloat(inputs[2].value) || 0;
        var profit = taux - fixe - sal;
        var idx = input.getAttribute('data-dept');
        var cell = document.getElementById('profit_' + idx);
        cell.textContent = profit.toFixed(2) + ' $';
        cell.className = 'profit-cell' + (profit < 0 ? ' negative' : '');
    }

    function saveTaux() {
        var rows = document.querySelectorAll('#tauxBody tr');
        var data = [];
        for (var i = 0; i < rows.length; i++) {
            var inputs = rows[i].querySelectorAll('.input-number');
            data.push({
                department: tauxHoraires[i].department,
                taux_horaire: parseFloat(inputs[0].value) || 0,
                frais_fixe:   parseFloat(inputs[1].value) || 0,
                salaire:      parseFloat(inputs[2].value) || 0
            });
        }
        tauxHoraires = data;
        saveConfig('taux_horaires', tauxHoraires, 'tauxFeedback');
    }

    // ── Company types table ──

    function renderCompanyTypesTable() {
        var body = document.getElementById('companyTypesBody');
        var html = '';
        for (var i = 0; i < companyTypes.length; i++) {
            html += '<tr><td><input type="text" class="input-email" value="' + escapeHtml(companyTypes[i]) + '" placeholder="Type d\'entreprise"></td>' +
                '<td><button class="btn-remove" onclick="removeGenericRow(this)" title="Retirer">&times;</button></td></tr>';
        }
        body.innerHTML = html;
    }
    function addCompanyTypeRow() {
        var body = document.getElementById('companyTypesBody');
        body.insertAdjacentHTML('beforeend', '<tr><td><input type="text" class="input-email" value="" placeholder="Type d\'entreprise"></td><td><button class="btn-remove" onclick="removeGenericRow(this)" title="Retirer">&times;</button></td></tr>');
        var inputs = body.querySelectorAll('.input-email');
        if (inputs.length) inputs[inputs.length - 1].focus();
    }
    function saveCompanyTypes() {
        companyTypes = collectSimpleList('companyTypesBody');
        saveConfig('company_types', companyTypes, 'companyTypesFeedback');
    }

    // ── Contact roles table ──

    function renderContactRolesTable() {
        var body = document.getElementById('contactRolesBody');
        var html = '';
        for (var i = 0; i < contactRoles.length; i++) {
            html += '<tr><td><input type="text" class="input-email" value="' + escapeHtml(contactRoles[i]) + '" placeholder="R\u00f4le"></td>' +
                '<td><button class="btn-remove" onclick="removeGenericRow(this)" title="Retirer">&times;</button></td></tr>';
        }
        body.innerHTML = html;
    }
    function addContactRoleRow() {
        var body = document.getElementById('contactRolesBody');
        body.insertAdjacentHTML('beforeend', '<tr><td><input type="text" class="input-email" value="" placeholder="R\u00f4le"></td><td><button class="btn-remove" onclick="removeGenericRow(this)" title="Retirer">&times;</button></td></tr>');
        var inputs = body.querySelectorAll('.input-email');
        if (inputs.length) inputs[inputs.length - 1].focus();
    }
    function saveContactRoles() {
        contactRoles = collectSimpleList('contactRolesBody');
        saveConfig('contact_roles', contactRoles, 'contactRolesFeedback');
    }

    // ── Communication types table ──

    function renderCommTypesTable() {
        var body = document.getElementById('commTypesBody');
        var html = '';
        for (var i = 0; i < communicationTypes.length; i++) {
            html += '<tr><td><input type="text" class="input-email" value="' + escapeHtml(communicationTypes[i]) + '" placeholder="Type"></td>' +
                '<td><button class="btn-remove" onclick="removeGenericRow(this)" title="Retirer">&times;</button></td></tr>';
        }
        body.innerHTML = html;
    }
    function addCommTypeRow() {
        var body = document.getElementById('commTypesBody');
        body.insertAdjacentHTML('beforeend', '<tr><td><input type="text" class="input-email" value="" placeholder="Type"></td><td><button class="btn-remove" onclick="removeGenericRow(this)" title="Retirer">&times;</button></td></tr>');
        var inputs = body.querySelectorAll('.input-email');
        if (inputs.length) inputs[inputs.length - 1].focus();
    }
    function saveCommTypes() {
        communicationTypes = collectSimpleList('commTypesBody');
        saveConfig('communication_types', communicationTypes, 'commTypesFeedback');
    }

    // ── Shared helpers for simple list sections ──

    async function removeGenericRow(btn) {
        if (!await steleConfirm('Retirer cet élément ?')) return;
        btn.closest('tr').remove();
    }
    function collectSimpleList(tbodyId) {
        var items = [];
        var rows = document.querySelectorAll('#' + tbodyId + ' tr');
        for (var i = 0; i < rows.length; i++) {
            var val = rows[i].querySelector('.input-email').value.trim();
            if (val && items.indexOf(val) === -1) items.push(val);
        }
        return items;
    }

    // ── Save functions ──

    async function savePermissions() {
        var activeRoles = getActiveRoles();
        var newPerm = {};
        for (var r = 0; r < activeRoles.length; r++) {
            newPerm[activeRoles[r]] = {};
        }

        var checkboxes = document.querySelectorAll('#permBody input[type="checkbox"]');
        for (var i = 0; i < checkboxes.length; i++) {
            var cb = checkboxes[i];
            var role = cb.getAttribute('data-role');
            var page = cb.getAttribute('data-page');
            newPerm[role][page] = cb.checked;
        }

        permissions = newPerm;

        // Always save to app_config (source of truth for all pages)
        saveConfig('permissions', newPerm, 'permFeedback');
    }

    async function saveUserRoles() {
        var newRoles = {};
        var rows = document.querySelectorAll('#rolesBody tr');
        for (var i = 0; i < rows.length; i++) {
            var email = rows[i].querySelector('.input-email').value.trim().toLowerCase();
            var role = rows[i].querySelector('.select-role').value;
            if (email) newRoles[email] = role;
        }

        userRolesMap = newRoles;

        // If we have roles from DB, save to user_roles table
        if (rolesFromDB.length > 0) {
            var fb = document.getElementById('rolesFeedback');
            fb.textContent = 'Sauvegarde en cours...';
            fb.className = 'save-feedback visible';

            try {
                // First, get all existing user_roles to handle deletions
                var existingResp = await authenticatedFetch(
                    SUPABASE_URL + '/rest/v1/user_roles?select=id,email',
                    {}
                );
                var existing = existingResp.ok ? await existingResp.json() : [];

                // Track which emails are in the new set
                var newEmails = Object.keys(newRoles);

                // Delete assignments that are no longer in the list
                for (var i = 0; i < existing.length; i++) {
                    if (newEmails.indexOf(existing[i].email.toLowerCase()) === -1) {
                        await authenticatedFetch(
                            SUPABASE_URL + '/rest/v1/user_roles?id=eq.' + existing[i].id,
                            { method: 'DELETE' }
                        );
                    }
                }

                // Upsert each assignment
                for (var email in newRoles) {
                    var roleName = newRoles[email];
                    var role = rolesFromDB.find(function(r) { return r.name === roleName; });

                    if (role) {
                        // Try to update first, then insert if not exists
                        var updateResp = await authenticatedFetch(
                            SUPABASE_URL + '/rest/v1/user_roles?email=eq.' + encodeURIComponent(email),
                            {
                                method: 'PATCH',
                                headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                                body: JSON.stringify({ role_id: role.id })
                            }
                        );

                        // If no row was updated, insert
                        if (!updateResp.ok || updateResp.status === 406) {
                            await authenticatedFetch(
                                SUPABASE_URL + '/rest/v1/user_roles',
                                {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                                    body: JSON.stringify({ email: email, role_id: role.id })
                                }
                            );
                        }
                    }
                }

                await loadUserRoles(); // Reload to sync
                renderRolesTable(); // Re-render the table
                showFeedback(fb, 'Rôles utilisateurs sauvegardés avec succès', false);
            } catch (e) {
                console.error('Error saving user roles:', e);
                showFeedback(fb, 'Erreur lors de la sauvegarde', true);
            }
        } else {
            // Fallback to app_config
            saveConfig('user_roles', userRolesMap, 'rolesFeedback');
        }
    }

    function saveConfig(key, value, feedbackId) {
        var fb = document.getElementById(feedbackId);

        authenticatedFetch(SUPABASE_URL + '/rest/v1/app_config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Prefer': 'resolution=merge-duplicates'
            },
            body: JSON.stringify({ key: key, value: value, updated_at: new Date().toISOString() })
        })
        .then(function(r) {
            if (r.ok || r.status === 201) {
                showFeedback(fb, 'Sauvegard\u00e9 avec succ\u00e8s', false);
            } else {
                throw new Error('save failed');
            }
        })
        .catch(function() {
            // Fallback localStorage
            localStorage.setItem('stele_' + key, JSON.stringify(value));
            showFeedback(fb, 'Sauvegard\u00e9 localement — cr\u00e9ez la table Supabase pour partager', true);
        });
    }

    function showFeedback(el, msg, isWarn) {
        if (!el) return;
        el.textContent = (isWarn ? '' : '\u2713 ') + msg;
        el.className = 'save-feedback visible' + (isWarn ? ' warn' : '');
        setTimeout(function() { el.className = 'save-feedback'; }, 4000);
    }

    // ── Tag Prefixes table ──

    function renderTagPrefixTable() {
        var body = document.getElementById('tagPrefixBody');
        if (!body) return;
        var html = '';
        tagPrefixes.forEach(function(tp, i) {
            html += '<tr>' +
                '<td><input type="text" value="' + escapeAttr(tp.prefix || '') + '" maxlength="2" style="width:50px;text-align:center;text-transform:uppercase;font-weight:700;font-family:monospace;" onchange="tagPrefixes[' + i + '].prefix=this.value.toUpperCase()"></td>' +
                '<td><input type="text" value="' + escapeAttr(tp.label_fr || '') + '" style="width:100%;" onchange="tagPrefixes[' + i + '].label_fr=this.value"></td>' +
                '<td style="text-align:center;"><button class="btn-outline" style="color:#c62828;border-color:#c62828;padding:4px 8px;font-size:11px;" onclick="removeTagPrefix(' + i + ')">&times;</button></td>' +
                '</tr>';
        });
        body.innerHTML = html;
    }

    function addTagPrefix() {
        var next = tagPrefixes.length + 1;
        tagPrefixes.push({ prefix: '', label_fr: '', label_en: '', sort_order: next });
        renderTagPrefixTable();
        // Focus the new prefix input
        var inputs = document.querySelectorAll('#tagPrefixBody input[type="text"]');
        if (inputs.length > 0) inputs[inputs.length - 2].focus();
    }

    async function removeTagPrefix(index) {
        if (!await steleConfirm('Retirer ce préfixe ?')) return;
        tagPrefixes.splice(index, 1);
        renderTagPrefixTable();
    }

    function saveTagPrefixes() {
        // Update sort_order
        tagPrefixes.forEach(function(tp, i) { tp.sort_order = i + 1; });
        saveConfig('tag_prefixes', tagPrefixes, 'tagsFeedback');
    }

    // ── Pipeline statuses table ──

    function slugify(str) {
        return (str || '').toLowerCase()
            .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
            .replace(/[^a-z0-9]+/g, '_').replace(/^_|_$/g, '');
    }

    function renderPipelineStatusesTable() {
        var body = document.getElementById('pipelineStatusesBody');
        if (!body) return;
        var html = '';
        for (var i = 0; i < pipelineStatuses.length; i++) {
            var s = pipelineStatuses[i];
            html += '<tr>' +
                '<td><input type="text" class="input-email ps-label" value="' + escapeAttr(s.label || '') + '" placeholder="Nom du statut" oninput="updatePipelineSlug(this)"></td>' +
                '<td><input type="color" class="ps-color" value="' + escapeAttr(s.color || '#9e9e9e') + '" style="width:40px;height:30px;border:1px solid #ccc;border-radius:3px;cursor:pointer;padding:0;"></td>' +
                '<td><input type="text" class="ps-slug" value="' + escapeAttr(s.slug || '') + '" readonly style="background:#f5f5f5;color:#888;font-family:monospace;font-size:12px;"></td>' +
                '<td><button class="btn-remove" onclick="removePipelineStatusRow(this)" title="Retirer">&times;</button></td>' +
                '</tr>';
        }
        body.innerHTML = html;
    }

    function updatePipelineSlug(input) {
        var row = input.closest('tr');
        var slugInput = row.querySelector('.ps-slug');
        slugInput.value = slugify(input.value);
    }

    function addPipelineStatusRow() {
        pipelineStatuses.push({slug:'', label:'', color:'#9e9e9e', sort_order: pipelineStatuses.length + 1});
        renderPipelineStatusesTable();
        var inputs = document.querySelectorAll('#pipelineStatusesBody .ps-label');
        if (inputs.length) inputs[inputs.length - 1].focus();
    }

    async function removePipelineStatusRow(btn) {
        if (!await steleConfirm('Retirer ce statut ?')) return;
        btn.closest('tr').remove();
    }

    function savePipelineStatuses() {
        var newStatuses = [];
        var rows = document.querySelectorAll('#pipelineStatusesBody tr');
        for (var i = 0; i < rows.length; i++) {
            var label = rows[i].querySelector('.ps-label').value.trim();
            if (!label) continue;
            var color = rows[i].querySelector('.ps-color').value;
            var slug = rows[i].querySelector('.ps-slug').value || slugify(label);
            newStatuses.push({ slug: slug, label: label, color: color, sort_order: i + 1 });
        }
        pipelineStatuses = newStatuses;
        saveConfig('pipeline_statuses', pipelineStatuses, 'pipelineStatusesFeedback');
    }

    // ── Project sources table ──

    function renderProjectSourcesTable() {
        var body = document.getElementById('projectSourcesBody');
        if (!body) return;
        var html = '';
        for (var i = 0; i < projectSources.length; i++) {
            html += '<tr><td><input type="text" class="input-email" value="' + escapeHtml(projectSources[i]) + '" placeholder="Source"></td>' +
                '<td><button class="btn-remove" onclick="removeGenericRow(this)" title="Retirer">&times;</button></td></tr>';
        }
        body.innerHTML = html;
    }
    function addProjectSourceRow() {
        var body = document.getElementById('projectSourcesBody');
        body.insertAdjacentHTML('beforeend', '<tr><td><input type="text" class="input-email" value="" placeholder="Source"></td><td><button class="btn-remove" onclick="removeGenericRow(this)" title="Retirer">&times;</button></td></tr>');
        var inputs = body.querySelectorAll('.input-email');
        if (inputs.length) inputs[inputs.length - 1].focus();
    }
    function saveProjectSources() {
        projectSources = collectSimpleList('projectSourcesBody');
        saveConfig('project_sources', projectSources, 'projectSourcesFeedback');
    }

    // ── Project types table ──

    function renderProjectTypesTable() {
        var body = document.getElementById('projectTypesBody');
        if (!body) return;
        var html = '';
        for (var i = 0; i < projectTypes.length; i++) {
            html += '<tr><td><input type="text" class="input-email" value="' + escapeHtml(projectTypes[i]) + '" placeholder="Type de projet"></td>' +
                '<td><button class="btn-remove" onclick="removeGenericRow(this)" title="Retirer">&times;</button></td></tr>';
        }
        body.innerHTML = html;
    }
    function addProjectTypeRow() {
        var body = document.getElementById('projectTypesBody');
        body.insertAdjacentHTML('beforeend', '<tr><td><input type="text" class="input-email" value="" placeholder="Type de projet"></td><td><button class="btn-remove" onclick="removeGenericRow(this)" title="Retirer">&times;</button></td></tr>');
        var inputs = body.querySelectorAll('.input-email');
        if (inputs.length) inputs[inputs.length - 1].focus();
    }
    function saveProjectTypes() {
        projectTypes = collectSimpleList('projectTypesBody');
        saveConfig('project_types', projectTypes, 'projectTypesFeedback');
    }

    function handleLogout() {
        localStorage.removeItem('sb_access_token');
        localStorage.removeItem('sb_refresh_token');
        localStorage.removeItem('sb_user_email');
        localStorage.removeItem('sb_user_id');
        window.location.href = 'login.html';
    }

    // ── Role management functions ──

    function openRoleModal(roleId) {
        var modal = document.getElementById('roleModal');
        if (!modal) return;

        var title = document.getElementById('roleModalTitle');
        var nameInput = document.getElementById('roleNameInput');
        var descInput = document.getElementById('roleDescInput');
        var permChecksContainer = document.getElementById('rolePermChecks');
        var saveBtn = document.getElementById('roleSaveBtn');

        if (roleId) {
            // Edit mode
            var role = rolesFromDB.find(function(r) { return r.id === roleId; });
            if (!role) return;

            title.textContent = 'Modifier le r\u00f4le';
            nameInput.value = role.name;
            descInput.value = role.description || '';
            saveBtn.setAttribute('data-role-id', roleId);

            // Check permissions
            var perms = role.permissions || {};
            for (var i = 0; i < PAGES.length; i++) {
                var cb = document.getElementById('rolePerm_' + PAGES[i].key);
                if (cb) cb.checked = perms[PAGES[i].key] || false;
            }
        } else {
            // Create mode
            title.textContent = 'Nouveau r\u00f4le';
            nameInput.value = '';
            descInput.value = '';
            saveBtn.removeAttribute('data-role-id');

            // Uncheck all permissions
            for (var i = 0; i < PAGES.length; i++) {
                var cb = document.getElementById('rolePerm_' + PAGES[i].key);
                if (cb) cb.checked = false;
            }
        }

        modal.style.display = 'flex';
    }

    function closeRoleModal() {
        var modal = document.getElementById('roleModal');
        if (modal) modal.style.display = 'none';
    }

    function editRole(roleId) {
        openRoleModal(roleId);
    }

    async function deleteRole(roleId) {
        if (!await steleConfirm('Voulez-vous vraiment supprimer ce rôle ?')) return;

        try {
            var resp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/roles?id=eq.' + roleId, {
                method: 'DELETE'
            });

            if (resp.ok) {
                await loadRoles();
                renderAll(); // Re-render all tables including permissions
                alert('R\u00f4le supprim\u00e9 avec succ\u00e8s');
            } else {
                alert('Erreur lors de la suppression du r\u00f4le');
            }
        } catch (e) {
            console.error('Error deleting role:', e);
            alert('Erreur lors de la suppression du r\u00f4le');
        }
    }

    async function saveRole() {
        var roleId = document.getElementById('roleSaveBtn').getAttribute('data-role-id');
        var name = document.getElementById('roleNameInput').value.trim();
        var description = document.getElementById('roleDescInput').value.trim();

        if (!name) {
            alert('Le nom du r\u00f4le est requis');
            return;
        }

        // Collect permissions
        var permissions = {};
        for (var i = 0; i < PAGES.length; i++) {
            var cb = document.getElementById('rolePerm_' + PAGES[i].key);
            permissions[PAGES[i].key] = cb ? cb.checked : false;
        }

        var payload = {
            name: name,
            description: description,
            permissions: permissions,
            is_system: false
        };

        try {
            var resp;
            if (roleId) {
                // Update
                resp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/roles?id=eq.' + roleId, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                    body: JSON.stringify(payload)
                });
            } else {
                // Create
                resp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/roles', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                    body: JSON.stringify(payload)
                });
            }

            if (resp.ok || resp.status === 201) {
                await loadRoles();
                renderAll(); // Re-render all tables including permissions
                closeRoleModal();
                alert('R\u00f4le sauvegard\u00e9 avec succ\u00e8s');
            } else {
                alert('Erreur lors de la sauvegarde du r\u00f4le');
            }
        } catch (e) {
            console.error('Error saving role:', e);
            alert('Erreur lors de la sauvegarde du r\u00f4le');
        }
    }
    // ═══════════════════════════════════════════════════════════════════════
    // COVER IMAGE
    // ═══════════════════════════════════════════════════════════════════════

    async function loadCoverImagePreview() {
        try {
            var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/app_config?key=eq.cover_image&select=value', {});
            if (r.ok) {
                var rows = await r.json();
                if (rows.length > 0 && rows[0].value) {
                    showCoverPreview(rows[0].value);
                }
            }
        } catch (e) { /* ignore */ }
    }

    function showCoverPreview(url) {
        var preview = document.getElementById('coverImagePreview');
        var placeholder = document.getElementById('coverImagePlaceholder');
        if (url) {
            preview.innerHTML = '<img src="' + url + '" style="width:100%;height:100%;object-fit:cover;">';
        } else {
            preview.innerHTML = '<span style="color:#666;font-size:13px;" id="coverImagePlaceholder">Aucune image</span>';
        }
    }

    async function uploadCoverImage(input) {
        if (!input.files || !input.files[0]) return;
        var file = input.files[0];
        var feedback = document.getElementById('coverFeedback');
        feedback.textContent = 'Upload en cours...';
        feedback.style.color = '#888';

        try {
            // Compress image client-side
            var compressed = await compressCoverImage(file, 1600, 0.85);

            // Upload to Supabase Storage (assets bucket, public)
            var r = await authenticatedFetch(SUPABASE_URL + '/storage/v1/object/assets/cover_image.jpg', {
                method: 'PUT',
                headers: { 'Content-Type': 'image/jpeg', 'x-upsert': 'true' },
                body: compressed
            });

            if (!r.ok) {
                // Try POST if PUT fails (file doesn't exist yet)
                r = await authenticatedFetch(SUPABASE_URL + '/storage/v1/object/assets/cover_image.jpg', {
                    method: 'POST',
                    headers: { 'Content-Type': 'image/jpeg', 'x-upsert': 'true' },
                    body: compressed
                });
            }

            if (r.ok) {
                var publicUrl = SUPABASE_URL + '/storage/v1/object/public/assets/cover_image.jpg?t=' + Date.now();
                // Save URL to app_config
                await authenticatedFetch(SUPABASE_URL + '/rest/v1/app_config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'resolution=merge-duplicates' },
                    body: JSON.stringify({ key: 'cover_image', value: JSON.stringify(publicUrl) })
                });
                showCoverPreview(publicUrl);
                feedback.textContent = 'Image sauvegard\u00e9e!';
                feedback.style.color = 'var(--stele-green, #4b6050)';
            } else {
                var errText = await r.text();
                console.error('Upload error:', errText);
                feedback.textContent = 'Erreur upload';
                feedback.style.color = '#c00';
            }
        } catch (e) {
            console.error('Cover image upload error:', e);
            feedback.textContent = 'Erreur';
            feedback.style.color = '#c00';
        }
        input.value = '';
    }

    function compressCoverImage(file, maxWidth, quality) {
        return new Promise(function(resolve) {
            var reader = new FileReader();
            reader.onload = function(e) {
                var img = new Image();
                img.onload = function() {
                    var w = img.width, h = img.height;
                    if (w > maxWidth) { h = Math.round(h * maxWidth / w); w = maxWidth; }
                    var canvas = document.createElement('canvas');
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    canvas.toBlob(function(blob) { resolve(blob); }, 'image/jpeg', quality);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
    }

    async function removeCoverImage() {
        if (!confirm('Supprimer l\'image de couverture ?')) return;
        var feedback = document.getElementById('coverFeedback');
        try {
            // Remove from app_config
            await authenticatedFetch(SUPABASE_URL + '/rest/v1/app_config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Prefer': 'resolution=merge-duplicates' },
                body: JSON.stringify({ key: 'cover_image', value: JSON.stringify('') })
            });
            showCoverPreview('');
            feedback.textContent = 'Image supprim\u00e9e';
            feedback.style.color = '#888';
        } catch (e) {
            feedback.textContent = 'Erreur';
            feedback.style.color = '#c00';
        }
    }

    // Load cover image preview on page load
    loadCoverImagePreview();

    </script>
</body>
</html>
