<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Approbations — Stele</title>

    <!-- Auth guard -->
    <script>
        if (!localStorage.getItem('sb_access_token')) {
            window.location.href = 'login.html';
        } else {
            document.documentElement.style.visibility = 'visible';
        }
    </script>
    <style>html { visibility: hidden; }</style>

    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }

        html, body {
            height: 100%;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: #ffffff;
            color: #0A0203;
        }

        .app-wrapper { display: flex; min-height: 100vh; flex-direction: column; }

        /* Nav bar */
        .nav-bar {
            position: fixed;
            top: 0; left: 0; right: 0;
            background: #FFFFFF;
            border-bottom: 1px solid #C8C8C8;
            padding: 12px 60px;
            display: flex;
            align-items: center;
            gap: 32px;
            z-index: 100;
        }
        .nav-logo { font-size: 20px; font-weight: 400; color: #0A0203; }
        .nav-back {
            color: #0A0203; text-decoration: none; font-size: 13px;
            opacity: 0.6; transition: opacity 0.15s; white-space: nowrap;
        }
        .nav-back:hover { opacity: 1; }
        .nav-user {
            margin-left: auto; display: flex; align-items: center;
            gap: 16px; font-size: 13px;
        }
        .nav-user-email { color: #0A0203; opacity: 0.5; }
        .btn-logout {
            background: transparent; color: #0A0203;
            border: 1px solid #C8C8C8; padding: 5px 14px;
            font-size: 12px; cursor: pointer; transition: all 0.15s;
            font-family: inherit; border-radius: 3px;
        }
        .btn-logout:hover { background: #f5f5f5; border-color: #999; }

        /* Content */
        .app-content {
            flex: 1; padding: 40px;
            padding-top: 96px;
            max-width: 1100px; margin: 0 auto; width: 100%;
        }

        .page-title { font-size: 24px; font-weight: 700; margin-bottom: 8px; }
        .page-sub { font-size: 14px; color: #666; margin-bottom: 32px; }

        /* Section */
        .section {
            background: #F8F8F8; border: 1px solid #e0e0e0;
            border-radius: 6px; padding: 28px; margin-bottom: 24px;
        }
        .section-title { font-size: 16px; font-weight: 700; margin-bottom: 4px; }
        .section-desc { font-size: 13px; color: #888; margin-bottom: 20px; }

        /* Table */
        .approval-table { width: 100%; border-collapse: collapse; }
        .approval-table th, .approval-table td {
            padding: 10px 8px; text-align: left;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }
        .approval-table th {
            font-size: 11px; text-transform: uppercase;
            letter-spacing: 0.5px; color: #888; font-weight: 600;
            background: #fafaf8;
        }
        .approval-table tbody tr:last-child td { border-bottom: none; }
        .approval-table tbody tr:hover { background: #fdfcfa; }

        .col-code { width: 12%; }
        .col-cat { width: 16%; }
        .col-desc { width: 30%; }
        .col-type { width: 12%; }
        .col-price { width: 12%; }
        .col-actions { width: 18%; text-align: right; }

        .approval-table td.col-actions { text-align: right; }

        .td-code { font-weight: 600; font-size: 12px; color: #555; }
        .td-by { font-size: 12px; color: #888; }

        .btn-examine {
            background: #4b6050; color: #fff; border: none;
            padding: 6px 16px; font-size: 12px; font-family: inherit;
            cursor: pointer; border-radius: 3px; transition: opacity 0.2s;
        }
        .btn-examine:hover { opacity: 0.85; }

        /* Modal */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.45);
            z-index: 1000; justify-content: center; align-items: center;
        }
        .modal-overlay.active { display: flex; }

        .modal {
            background: #fff; border-radius: 8px;
            width: 90%; max-width: 460px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.18);
            max-height: 90vh; display: flex; flex-direction: column;
        }
        .modal-header {
            padding: 20px 24px 0; display: flex;
            justify-content: space-between; align-items: center;
        }
        .modal-title { font-size: 17px; font-weight: 700; }
        .modal-proposed-by { font-size: 12px; color: #888; margin-top: 2px; }
        .modal-body { padding: 20px 24px; overflow-y: auto; }
        .modal-footer {
            padding: 16px 24px; border-top: 1px solid #e0e0e0;
            display: flex; gap: 10px; justify-content: flex-end;
        }

        .form-group { margin-bottom: 16px; }
        .form-group:last-child { margin-bottom: 0; }
        .form-label {
            display: block; font-size: 12px; font-weight: 600;
            color: #555; margin-bottom: 6px; text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .form-input {
            width: 100%; padding: 8px 10px;
            border: 1px solid #e0e0e0; border-radius: 4px;
            font-family: inherit; font-size: 14px;
        }
        .form-input:focus { outline: none; border-color: #4b6050; }
        .form-select {
            width: 100%; padding: 8px 10px;
            border: 1px solid #e0e0e0; border-radius: 4px;
            font-family: inherit; font-size: 14px;
            background: #fff; cursor: pointer;
        }
        .form-select:focus { outline: none; border-color: #4b6050; }

        .btn-approve {
            background: #4b6050; color: #fff; border: none;
            padding: 8px 20px; font-size: 13px; font-family: inherit;
            cursor: pointer; border-radius: 4px; transition: opacity 0.2s;
            font-weight: 600;
        }
        .btn-approve:hover { opacity: 0.85; }

        .btn-reject {
            background: none; color: #c0392b; border: 1px solid #e0c0c0;
            padding: 7px 18px; font-size: 13px; font-family: inherit;
            cursor: pointer; border-radius: 4px; transition: all 0.2s;
        }
        .btn-reject:hover { background: #fdf0f0; border-color: #c0392b; }

        .btn-modal-cancel {
            background: none; color: #666; border: 1px solid #ddd;
            padding: 7px 18px; font-size: 13px; font-family: inherit;
            cursor: pointer; border-radius: 4px; transition: all 0.2s;
            margin-right: auto;
        }
        .btn-modal-cancel:hover { background: #f5f5f5; border-color: #999; }

        .modal-status {
            padding: 10px 14px; margin-top: 16px; border-radius: 4px;
            font-size: 13px; display: none;
        }
        .modal-status.success { display: block; background: #e8f5e9; color: #2e7d32; }
        .modal-status.error { display: block; background: #ffebee; color: #c62828; }

        /* Feedback */
        .feedback {
            display: none; padding: 10px 16px; margin-bottom: 16px;
            border-radius: 4px; font-size: 13px;
        }
        .feedback.success { display: block; background: #e8f5e9; color: #2e7d32; }
        .feedback.error { display: block; background: #ffebee; color: #c62828; }

        /* Empty state */
        .empty-state {
            text-align: center; padding: 48px 20px;
            color: #999; font-size: 15px;
        }

        /* Footer */
        .app-footer {
            padding: 20px 40px; text-align: center;
            font-size: 11px; color: #999;
            border-top: 1px solid #e0e0e0;
        }

        /* Modal élargi pour vue complète article */
        .modal.modal-edit {
            max-width: 800px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        .edit-row {
            display: flex;
            gap: 12px;
        }
        .edit-row .form-group {
            flex: 1;
        }

        /* Prix composé — tableaux minutes & matériaux */
        .composed-price-section {
            display: flex;
            gap: 16px;
            margin-top: 8px;
        }
        .cp-table-wrap {
            flex: 1;
            min-width: 0;
        }
        .cp-section-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--stele-green);
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 1px solid #f0f0f0;
        }
        .cp-sub-title {
            font-size: 11px;
            font-weight: 600;
            color: #555;
            margin-bottom: 6px;
        }
        .cp-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .cp-table th {
            text-align: left;
            font-weight: 600;
            font-size: 11px;
            color: #888;
            padding: 4px 6px;
            border-bottom: 1px solid #e0e0e0;
        }
        .cp-table th:last-child {
            text-align: right;
        }
        .cp-table td {
            padding: 3px 6px;
        }
        .cp-table td:first-child {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 140px;
            font-size: 11px;
        }
        .cp-table td:last-child {
            text-align: right;
            font-family: 'SF Mono', 'Consolas', monospace;
            color: #555;
        }
        .cp-calculated {
            margin-top: 12px;
            padding: 10px 14px;
            background: #f8f8f4;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }
        .cp-calculated .cp-total-label {
            font-weight: 600;
            color: #555;
        }
        .cp-calculated .cp-total-value {
            font-weight: 700;
            font-size: 16px;
            color: var(--stele-green);
        }
        .cp-calculated .cp-breakdown {
            font-size: 11px;
            color: #888;
            margin-left: 8px;
        }

        /* Médias */
        .cat-media-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--stele-green);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f0f0f0;
        }
        .cat-media-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .cat-media-item {
            display: flex;
            gap: 10px;
            padding: 10px;
            background: #f8f8f8;
            border-radius: 6px;
            align-items: flex-start;
        }
        .cat-media-item img {
            width: 80px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid var(--stele-gray);
            flex-shrink: 0;
        }
        .cat-pdf-icon {
            width: 80px;
            height: 60px;
            background: #e8e8e8;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            color: #999;
            flex-shrink: 0;
        }
        .cat-media-info { flex: 1; min-width: 0; }
        .cat-media-name {
            font-size: 12px;
            font-weight: 500;
            color: #333;
            word-break: break-word;
        }

        /* Toggles */
        .edit-toggle-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .edit-toggle {
            position: relative;
            display: inline-block;
            width: 38px;
            height: 22px;
        }
        .edit-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .edit-toggle .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #ddd;
            border-radius: 22px;
            transition: background 0.25s;
        }
        .edit-toggle .slider::before {
            content: '';
            position: absolute;
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background: #fff;
            border-radius: 50%;
            transition: transform 0.25s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.15);
        }
        .edit-toggle input:checked + .slider {
            background: var(--stele-green);
        }
        .edit-toggle input:checked + .slider::before {
            transform: translateX(16px);
        }
        .edit-toggle-label {
            font-size: 13px;
            color: var(--stele-black);
        }

        @media (max-width: 768px) {
            .composed-price-section {
                flex-direction: column;
            }
            .modal.modal-edit {
                max-width: 98vw;
            }
            .nav-bar { padding: 12px 20px; gap: 16px; }
            .app-content { padding: 24px 16px; padding-top: 80px; }
            .section { padding: 20px 16px; }
            .approval-table th, .approval-table td { padding: 8px 4px; font-size: 12px; }
            .modal { width: 95%; max-width: none; }
        }
    </style>
</head>
<body>
    <div class="app-wrapper">
        <nav class="nav-bar">
            <span class="nav-logo">stele</span>
            <a href="app.html" class="nav-back">&larr; Menu</a>
            <div class="nav-user">
                <span class="nav-user-email" id="userEmail"></span>
                <button class="btn-logout" onclick="handleLogout()">D&eacute;connexion</button>
            </div>
        </nav>

        <main class="app-content">
            <div class="page-title">Approbations</div>
            <div class="page-sub">Examinez et approuvez les articles propos&eacute;s au catalogue.</div>

            <div class="feedback" id="feedback"></div>

            <!-- Soumissions en attente -->
            <div class="section">
                <div class="section-title">Soumissions en attente d'approbation</div>
                <div class="section-desc">Approuvez ou retournez les soumissions soumises pour r&eacute;vision interne.</div>

                <div id="subTableWrap">
                    <div class="empty-state" id="subEmptyState" style="display:none;">Aucune soumission en attente.</div>
                    <table class="approval-table" id="subTable" style="display:none;">
                        <thead>
                            <tr>
                                <th style="width:10%">#</th>
                                <th style="width:25%">Projet</th>
                                <th style="width:25%">Titre</th>
                                <th style="width:12%">Version</th>
                                <th style="width:12%">Total</th>
                                <th style="width:16%; text-align:right;"></th>
                            </tr>
                        </thead>
                        <tbody id="subBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Articles en attente -->
            <div class="section">
                <div class="section-title">Articles en attente d'approbation</div>
                <div class="section-desc">Modifiez les champs si n&eacute;cessaire avant d'approuver.</div>

                <div id="tableWrap">
                    <div class="empty-state" id="emptyState" style="display:none;">Aucun article en attente d'approbation.</div>
                    <table class="approval-table" id="approvalTable" style="display:none;">
                        <thead>
                            <tr>
                                <th class="col-code">Code</th>
                                <th class="col-cat">Cat&eacute;gorie</th>
                                <th class="col-desc">Description</th>
                                <th class="col-type">Type</th>
                                <th class="col-price">Prix</th>
                                <th class="col-actions"></th>
                            </tr>
                        </thead>
                        <tbody id="approvalBody"></tbody>
                    </table>
                </div>
            </div>
        </main>

        <footer class="app-footer">stele &mdash; stele.ca</footer>
    </div>

    <!-- Modal examiner -->
    <div class="modal-overlay" id="examineModal">
        <div class="modal modal-edit">
            <div class="modal-header">
                <div>
                    <div class="modal-title">Examiner l'article</div>
                    <div class="modal-proposed-by" id="modalProposedBy"></div>
                </div>
            </div>
            <div class="modal-body">
                <div class="edit-row">
                    <div class="form-group">
                        <label class="form-label">Code</label>
                        <input class="form-input" id="modalCode" type="text" readonly style="background:#f5f5f5; color:#888;">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Cat&eacute;gorie</label>
                        <select class="form-select" id="modalCategory"></select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <input class="form-input" id="modalDescription" type="text">
                </div>
                <div class="edit-row">
                    <div class="form-group">
                        <label class="form-label">Type</label>
                        <select class="form-select" id="modalType"></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Prix</label>
                        <div class="form-input" id="modalPriceDisplay" style="background:#f5f5f5; color:#888;">Calculé automatiquement</div>
                        <input type="hidden" id="modalPrice">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Instruction</label>
                    <textarea class="form-input" id="modalInstruction" rows="2" style="resize:vertical;"></textarea>
                </div>

                <!-- Prix composé -->
                <div class="form-group" id="composedPriceGroup">
                    <div class="cp-section-title">Prix compos&eacute;</div>
                    <div class="composed-price-section">
                        <div class="cp-table-wrap">
                            <div class="cp-sub-title">Minutes main-d'&oelig;uvre</div>
                            <table class="cp-table">
                                <thead><tr><th>D&eacute;partement</th><th style="width:70px">Min.</th></tr></thead>
                                <tbody id="cpMinutesBody"></tbody>
                            </table>
                        </div>
                        <div class="cp-table-wrap">
                            <div class="cp-sub-title">Mat&eacute;riaux</div>
                            <table class="cp-table">
                                <thead><tr><th>Cat&eacute;gorie</th><th style="width:80px">Co&ucirc;t ($)</th></tr></thead>
                                <tbody id="cpMaterialsBody"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="cp-calculated">
                        <div>
                            <span class="cp-total-label">Prix calcul&eacute;</span>
                            <span class="cp-breakdown" id="cpBreakdown"></span>
                        </div>
                        <span class="cp-total-value" id="cpTotalValue">—</span>
                    </div>
                </div>

                <!-- Médias -->
                <div class="form-group" id="mediaGroup">
                    <div class="cat-media-title">M&eacute;dias</div>
                    <div class="cat-media-list" id="catMediaList"></div>
                </div>

                <!-- Toggles -->
                <div class="form-group" style="margin-bottom:0;">
                    <div class="edit-toggle-row">
                        <label class="edit-toggle">
                            <input type="checkbox" id="modalInCalculator">
                            <span class="slider"></span>
                        </label>
                        <span class="edit-toggle-label">Visible dans le calculateur</span>
                    </div>
                </div>

                <div class="modal-status" id="modalStatus"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal-cancel" onclick="closeModal()">Fermer</button>
                <button class="btn-reject" onclick="rejectFromModal()">Rejeter</button>
                <button class="btn-approve" onclick="approveFromModal()">Approuver</button>
            </div>
        </div>
    </div>

    <!-- Modal générique -->
    <div class="modal-overlay" id="steleDialogOverlay">
        <div class="modal" style="max-width:440px;">
            <div class="modal-header">
                <div class="modal-title" id="steleDialogTitle"></div>
            </div>
            <div class="modal-body">
                <p id="steleDialogMessage" style="font-size:14px; color:#444; margin-bottom:0;"></p>
            </div>
            <div class="modal-footer">
                <button class="btn-modal-cancel" id="steleDialogCancel" onclick="steleDialogResolve(null)" style="display:none;">Annuler</button>
                <button class="btn-approve" id="steleDialogOk" onclick="steleDialogResolve(true)">OK</button>
            </div>
        </div>
    </div>

    <script>
    var SUPABASE_URL = 'https://rplzbtjfnwahqodrhpny.supabase.co';
    var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJwbHpidGpmbndhaHFvZHJocG55Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NDU2MDEsImV4cCI6MjA4NjIyMTYwMX0.OQAZhc029PbRDSe1b02NDAuOUE8yn-_h3QqSnUDpLeU';

    var _steleDialogResolve = null;
    function steleDialogResolve(val) {
        document.getElementById('steleDialogOverlay').classList.remove('active');
        if (_steleDialogResolve) { var fn = _steleDialogResolve; _steleDialogResolve = null; fn(val); }
    }
    function steleConfirm(msg, title, okLabel, danger) {
        return new Promise(function(resolve) {
            _steleDialogResolve = resolve;
            document.getElementById('steleDialogTitle').textContent = title || 'Confirmation';
            document.getElementById('steleDialogMessage').textContent = msg;
            document.getElementById('steleDialogCancel').style.display = '';
            document.getElementById('steleDialogOk').textContent = okLabel || 'Confirmer';
            if (danger) document.getElementById('steleDialogOk').style.background = '#c0392b';
            else document.getElementById('steleDialogOk').style.background = '';
            document.getElementById('steleDialogOverlay').classList.add('active');
        });
    }

    var DEFAULT_CATEGORIES = ['Budg\u00e9taire', 'Panneaux', 'Poign\u00e9es', 'Tiroirs', '\u00c9clairage', 'Portes int\u00e9rieures'];
    var CATEGORIES = DEFAULT_CATEGORIES.slice();
    var TYPES = ['pi\u00b2', 'unitaire', 'lin\u00e9aire', '%'];

    // ═══ Auth ═══

    document.getElementById('userEmail').textContent = localStorage.getItem('sb_user_email') || '';

    async function refreshAccessToken() {
        var refreshToken = localStorage.getItem('sb_refresh_token');
        if (!refreshToken) return false;
        try {
            var response = await fetch(SUPABASE_URL + '/auth/v1/token?grant_type=refresh_token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'apikey': SUPABASE_KEY },
                body: JSON.stringify({ refresh_token: refreshToken })
            });
            if (!response.ok) return false;
            var data = await response.json();
            if (data.access_token) {
                localStorage.setItem('sb_access_token', data.access_token);
                localStorage.setItem('sb_refresh_token', data.refresh_token);
                return true;
            }
            return false;
        } catch (e) { return false; }
    }

    async function authenticatedFetch(url, options) {
        var tok = localStorage.getItem('sb_access_token');
        var headers = Object.assign({}, options.headers || {}, {
            'apikey': SUPABASE_KEY,
            'Authorization': 'Bearer ' + tok
        });
        var resp = await fetch(url, Object.assign({}, options, { headers: headers }));
        if (resp.status === 401) {
            var refreshed = await refreshAccessToken();
            if (refreshed) {
                headers['Authorization'] = 'Bearer ' + localStorage.getItem('sb_access_token');
                return fetch(url, Object.assign({}, options, { headers: headers }));
            }
        }
        return resp;
    }

    function handleLogout() {
        localStorage.removeItem('sb_access_token');
        localStorage.removeItem('sb_refresh_token');
        localStorage.removeItem('sb_user_email');
        localStorage.removeItem('sb_user_id');
        window.location.href = 'login.html';
    }

    var DEFAULT_PERMISSIONS = {
        'Admin': { approbation: true }, 'Vente': { approbation: false },
        'Charg\u00e9 de projet': { approbation: false }, 'Achat': { approbation: false },
        'Atelier': { approbation: false }, 'Client': { approbation: false }
    };
    var DEFAULT_USER_ROLES = { 'hubert@stele.ca': 'Admin' };

    async function checkPageAccess() {
        try {
            var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/app_config?select=key,value', {});
            var perms = DEFAULT_PERMISSIONS, roles = DEFAULT_USER_ROLES;
            if (r.ok) {
                var rows = await r.json();
                for (var i = 0; i < rows.length; i++) {
                    if (rows[i].key === 'permissions') perms = rows[i].value;
                    if (rows[i].key === 'user_roles') roles = rows[i].value;
                }
            }
            var email = (localStorage.getItem('sb_user_email') || '').toLowerCase();
            var role = roles[email] || 'Client';
            var defaults = DEFAULT_PERMISSIONS[role] || {};
            var saved = (perms[role] || {});
            var allowed = {};
            for (var k in defaults) allowed[k] = defaults[k];
            for (var k2 in saved) allowed[k2] = saved[k2];
            if (!allowed.approbation) { window.location.href = 'app.html'; return false; }
        } catch (e) {
            var email2 = (localStorage.getItem('sb_user_email') || '').toLowerCase();
            var role2 = DEFAULT_USER_ROLES[email2] || 'Client';
            if (!(DEFAULT_PERMISSIONS[role2] || {}).approbation) { window.location.href = 'app.html'; return false; }
        }
        return true;
    }

    // ═══ Load pending items ═══

    var pendingItems = [];

    async function loadPending() {
        try {
            var r = await authenticatedFetch(
                SUPABASE_URL + '/rest/v1/catalogue_items?status=eq.pending&order=id&select=id,category,description,type,price,proposed_by,sort_order,in_calculator,instruction,labor_minutes,material_costs,image_url,has_sales_sheet',
                {}
            );
            if (!r.ok) { showMsg('error', 'Erreur chargement: ' + r.status); return; }
            pendingItems = await r.json();
            renderTable();
        } catch (e) {
            showMsg('error', 'Erreur de connexion.');
        }
    }

    function renderTable() {
        var body = document.getElementById('approvalBody');
        var table = document.getElementById('approvalTable');
        var empty = document.getElementById('emptyState');

        if (pendingItems.length === 0) {
            table.style.display = 'none';
            empty.style.display = '';
            return;
        }

        table.style.display = '';
        empty.style.display = 'none';

        var html = '';
        for (var i = 0; i < pendingItems.length; i++) {
            var item = pendingItems[i];
            var priceDisplay = item.price != null ? parseFloat(item.price).toFixed(2) + ' $' : '—';

            html += '<tr id="row-' + escapeAttr(item.id) + '" style="cursor:pointer;" onclick="openModal(\'' + escapeAttr(item.id) + '\')">'
                + '<td class="td-code">' + escapeHtml(item.id) + '</td>'
                + '<td>' + escapeHtml(item.category || '') + '</td>'
                + '<td>' + escapeHtml(item.description || '') + '</td>'
                + '<td>' + escapeHtml(item.type || '') + '</td>'
                + '<td>' + priceDisplay + '</td>'
                + '<td class="col-actions">'
                +   '<button class="btn-examine" onclick="event.stopPropagation(); openModal(\'' + escapeAttr(item.id) + '\')">Examiner</button>'
                + '</td>'
                + '</tr>';
        }
        body.innerHTML = html;
    }

    // ═══ Modal ═══

    var currentItemId = null;
    var tauxHoraires = {};
    var expenseCategories = [];

    // Helper: render composed price
    function renderComposedPrice(item) {
        var laborMinutes = item.labor_minutes || {};
        var materialCosts = item.material_costs || {};

        // Minutes table
        var minutesHtml = '';
        Object.keys(laborMinutes).forEach(function(dept) {
            var mins = laborMinutes[dept] || 0;
            minutesHtml += '<tr><td>' + escapeHtml(dept) + '</td><td>' + mins + '</td></tr>';
        });
        document.getElementById('cpMinutesBody').innerHTML = minutesHtml || '<tr><td colspan="2" style="text-align:center; color:#999;">Aucune</td></tr>';

        // Materials table
        var materialsHtml = '';
        Object.keys(materialCosts).forEach(function(cat) {
            var cost = materialCosts[cat] || 0;
            materialsHtml += '<tr><td>' + escapeHtml(cat) + '</td><td>' + cost.toFixed(2) + ' $</td></tr>';
        });
        document.getElementById('cpMaterialsBody').innerHTML = materialsHtml || '<tr><td colspan="2" style="text-align:center; color:#999;">Aucun</td></tr>';

        // Calculate total
        var total = computeComposedPrice(laborMinutes, materialCosts);
        document.getElementById('cpTotalValue').textContent = total.toFixed(2) + ' $';

        // Breakdown (simplified for read-only view)
        var laborTotal = 0;
        Object.keys(laborMinutes).forEach(function(dept) {
            var rate = tauxHoraires[dept] || 0;
            laborTotal += (laborMinutes[dept] || 0) / 60 * rate;
        });
        var materialTotal = 0;
        Object.keys(materialCosts).forEach(function(cat) {
            var expense = expenseCategories.find(function(e) { return e.name === cat; });
            var markup = expense ? (expense.markup || 0) : 0;
            var waste = expense ? (expense.waste || 0) : 0;
            var cost = materialCosts[cat] || 0;
            materialTotal += cost * (1 + markup/100 + waste/100);
        });
        var breakdown = 'MO: ' + laborTotal.toFixed(2) + ' $ + Mat: ' + materialTotal.toFixed(2) + ' $';
        document.getElementById('cpBreakdown').textContent = breakdown;

        document.getElementById('modalPriceDisplay').textContent = total.toFixed(2) + ' $';
        document.getElementById('modalPrice').value = total;
    }

    function computeComposedPrice(laborMinutes, materialCosts) {
        var total = 0;
        // Labor
        Object.keys(laborMinutes).forEach(function(dept) {
            var rate = tauxHoraires[dept] || 0;
            total += (laborMinutes[dept] || 0) / 60 * rate;
        });
        // Materials
        Object.keys(materialCosts).forEach(function(cat) {
            var expense = expenseCategories.find(function(e) { return e.name === cat; });
            var markup = expense ? (expense.markup || 0) : 0;
            var waste = expense ? (expense.waste || 0) : 0;
            var cost = materialCosts[cat] || 0;
            total += cost * (1 + markup/100 + waste/100);
        });
        return total;
    }

    // Helper: render media
    async function renderMedia(itemId) {
        try {
            var r = await authenticatedFetch(
                SUPABASE_URL + '/rest/v1/room_media?catalogue_item_id=eq.' + encodeURIComponent(itemId) + '&order=created_at',
                {}
            );
            if (!r.ok) {
                document.getElementById('catMediaList').innerHTML = '<div style="text-align:center; color:#999; padding:10px;">Erreur chargement médias</div>';
                return;
            }
            var media = await r.json();
            var html = '';
            if (media.length === 0) {
                html = '<div style="text-align:center; color:#999; padding:10px;">Aucun média</div>';
            } else {
                media.forEach(function(m) {
                    var isPdf = m.url && m.url.toLowerCase().endsWith('.pdf');
                    var thumb = isPdf
                        ? '<div class="cat-pdf-icon">PDF</div>'
                        : '<img src="' + escapeAttr(m.url) + '" alt="">';
                    var name = m.url ? m.url.split('/').pop() : 'media';
                    html += '<div class="cat-media-item">' + thumb + '<div class="cat-media-info"><div class="cat-media-name">' + escapeHtml(name) + '</div></div></div>';
                });
            }
            document.getElementById('catMediaList').innerHTML = html;
        } catch (e) {
            document.getElementById('catMediaList').innerHTML = '<div style="text-align:center; color:#999; padding:10px;">Erreur réseau</div>';
        }
    }

    function openModal(itemId) {
        var item = pendingItems.find(function(it) { return it.id === itemId; });
        if (!item) return;

        currentItemId = itemId;

        // Populate code (read-only)
        document.getElementById('modalCode').value = item.id;

        // Populate proposed by
        document.getElementById('modalProposedBy').textContent = 'Propos\u00e9 par : ' + (item.proposed_by || '—');

        // Populate category dropdown
        var catSel = document.getElementById('modalCategory');
        catSel.innerHTML = CATEGORIES.map(function(c) {
            return '<option value="' + escapeAttr(c) + '"' + (c === item.category ? ' selected' : '') + '>' + escapeHtml(c) + '</option>';
        }).join('');

        // Populate description
        document.getElementById('modalDescription').value = item.description || '';

        // Populate type dropdown
        var typeSel = document.getElementById('modalType');
        typeSel.innerHTML = TYPES.map(function(t) {
            return '<option value="' + escapeAttr(t) + '"' + (t === item.type ? ' selected' : '') + '>' + escapeHtml(t) + '</option>';
        }).join('');

        // Populate instruction
        document.getElementById('modalInstruction').value = item.instruction || '';

        // Populate toggle
        document.getElementById('modalInCalculator').checked = item.in_calculator !== false;

        // Render composed price
        renderComposedPrice(item);

        // Render media
        renderMedia(itemId);

        // Reset status
        var st = document.getElementById('modalStatus');
        st.className = 'modal-status';
        st.textContent = '';

        document.getElementById('examineModal').classList.add('active');
    }

    function closeModal() {
        document.getElementById('examineModal').classList.remove('active');
        currentItemId = null;
    }

    // Click outside to close
    document.getElementById('examineModal').addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });

    function removeItemFromList(itemId) {
        pendingItems = pendingItems.filter(function(it) { return it.id !== itemId; });
        var row = document.getElementById('row-' + itemId);
        if (row) row.remove();
        if (pendingItems.length === 0) {
            document.getElementById('approvalTable').style.display = 'none';
            document.getElementById('emptyState').style.display = '';
        }
    }

    async function approveFromModal() {
        if (!currentItemId) return;

        var description = document.getElementById('modalDescription').value.trim();
        if (!description) {
            showModalStatus('error', 'La description ne peut pas \u00eatre vide.');
            return;
        }

        var category = document.getElementById('modalCategory').value;
        var type = document.getElementById('modalType').value;
        var priceVal = document.getElementById('modalPrice').value;
        var price = priceVal !== '' ? parseFloat(priceVal) : null;
        var instruction = document.getElementById('modalInstruction').value.trim();
        var inCalculator = document.getElementById('modalInCalculator').checked;

        try {
            var r = await authenticatedFetch(
                SUPABASE_URL + '/rest/v1/catalogue_items?id=eq.' + encodeURIComponent(currentItemId),
                {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                    body: JSON.stringify({
                        status: 'approved',
                        category: category,
                        description: description,
                        type: type,
                        price: price,
                        instruction: instruction || null,
                        in_calculator: inCalculator
                    })
                }
            );
            if (!r.ok) { showModalStatus('error', 'Erreur approbation: ' + r.status); return; }

            showModalStatus('success', '\u2713 Article ' + currentItemId + ' approuv\u00e9 avec succ\u00e8s.');
            var approvedId = currentItemId;
            setTimeout(function() {
                removeItemFromList(approvedId);
                closeModal();
                showMsg('success', '\u2713 Article ' + approvedId + ' approuv\u00e9.');
            }, 1500);
        } catch (e) {
            showModalStatus('error', 'Erreur r\u00e9seau.');
        }
    }

    async function rejectFromModal() {
        if (!currentItemId) return;
        if (!(await steleConfirm('Rejeter et supprimer l\u2019article ' + currentItemId + ' ?', 'Rejeter', 'Rejeter', true))) return;

        try {
            var r = await authenticatedFetch(
                SUPABASE_URL + '/rest/v1/catalogue_items?id=eq.' + encodeURIComponent(currentItemId),
                { method: 'DELETE' }
            );
            if (!r.ok) { showModalStatus('error', 'Erreur suppression: ' + r.status); return; }

            showModalStatus('success', 'Article ' + currentItemId + ' rejet\u00e9.');
            var rejectedId = currentItemId;
            setTimeout(function() {
                removeItemFromList(rejectedId);
                closeModal();
                showMsg('success', 'Article ' + rejectedId + ' rejet\u00e9.');
            }, 1500);
        } catch (e) {
            showModalStatus('error', 'Erreur r\u00e9seau.');
        }
    }

    function showModalStatus(type, text) {
        var el = document.getElementById('modalStatus');
        el.textContent = text;
        el.className = 'modal-status ' + type;
    }

    // ═══ Helpers ═══

    function showMsg(type, text) {
        var el = document.getElementById('feedback');
        el.textContent = text;
        el.className = 'feedback ' + type;
        setTimeout(function() { el.className = 'feedback'; }, 5000);
    }

    function escapeHtml(str) {
        var div = document.createElement('div');
        div.textContent = str || '';
        return div.innerHTML;
    }

    function escapeAttr(str) {
        return (str || '').replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;');
    }

    // ═══ Soumissions en attente ═══

    var pendingSubmissions = [];

    async function loadPendingSubmissions() {
        try {
            var r = await authenticatedFetch(
                SUPABASE_URL + '/rest/v1/submissions?status=eq.pending_internal&order=updated_at.desc&select=*,projects(name,client_name,user_id)',
                {}
            );
            if (!r.ok) return;
            pendingSubmissions = await r.json();
            renderSubTable();
        } catch (e) {
            console.error('Erreur chargement soumissions:', e);
        }
    }

    function renderSubTable() {
        var body = document.getElementById('subBody');
        var table = document.getElementById('subTable');
        var empty = document.getElementById('subEmptyState');

        if (pendingSubmissions.length === 0) {
            table.style.display = 'none';
            empty.style.display = '';
            return;
        }
        table.style.display = '';
        empty.style.display = 'none';

        var html = '';
        for (var i = 0; i < pendingSubmissions.length; i++) {
            var sub = pendingSubmissions[i];
            var projName = sub.projects ? sub.projects.name : '—';
            var totalStr = sub.approved_total != null ? parseFloat(sub.approved_total).toFixed(2) + ' $' : '—';
            html += '<tr style="cursor:pointer;" onclick="window.location.href=\'calculateur.html?submission=' + encodeURIComponent(sub.id) + '&from=approbation\'">'
                + '<td style="font-weight:600; font-size:12px; color:#555;">#' + escapeHtml(String(sub.submission_number)) + '</td>'
                + '<td>' + escapeHtml(projName) + '</td>'
                + '<td>' + escapeHtml(sub.title || 'Sans titre') + '</td>'
                + '<td>v' + (sub.current_version || 1) + '</td>'
                + '<td>' + totalStr + '</td>'
                + '<td style="text-align:right;">'
                + '<a href="calculateur.html?submission=' + encodeURIComponent(sub.id) + '&from=approbation" class="btn-examine" style="text-decoration:none;" onclick="event.stopPropagation();">Ouvrir</a>'
                + '</td>'
                + '</tr>';
        }
        body.innerHTML = html;
    }

    // ═══ Load categories from app_config ═══

    async function loadCategories() {
        try {
            var r = await authenticatedFetch(
                SUPABASE_URL + '/rest/v1/app_config?key=eq.catalogue_categories&select=value', {}
            );
            if (r.ok) {
                var rows = await r.json();
                if (rows.length > 0 && Array.isArray(rows[0].value) && rows[0].value.length > 0) {
                    CATEGORIES = rows[0].value;
                }
            }
        } catch (e) { /* keep defaults */ }
    }

    async function loadPricingConfig() {
        try {
            var r = await authenticatedFetch(
                SUPABASE_URL + '/rest/v1/app_config?key=in.(taux_horaires,expense_categories)&select=key,value', {}
            );
            if (r.ok) {
                var rows = await r.json();
                rows.forEach(function(row) {
                    if (row.key === 'taux_horaires' && row.value) {
                        tauxHoraires = row.value;
                    }
                    if (row.key === 'expense_categories' && Array.isArray(row.value)) {
                        expenseCategories = row.value;
                    }
                });
            }
        } catch (e) { /* keep defaults */ }
    }

    // ═══ Init ═══

    (async function() {
        if (!(await checkPageAccess())) return;
        await loadCategories();
        await loadPricingConfig();
        loadPending();
        loadPendingSubmissions();
    })();
    </script>
</body>
</html>
