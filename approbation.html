<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Approbations — Stele</title>

    <!-- Auth guard -->
    <script>
        if (!localStorage.getItem('sb_access_token')) {
            window.location.href = 'login.html';
        } else {
            document.documentElement.style.visibility = 'visible';
        }
    </script>
    <style>html { visibility: hidden; }</style>

    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        html, body {
            height: 100%;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: #ffffff;
            color: #0A0203;
        }

        .app-wrapper { display: flex; min-height: 100vh; flex-direction: column; }

        /* Nav bar */
        .nav-bar {
            position: fixed;
            top: 0; left: 0; right: 0;
            background: #FFFFFF;
            border-bottom: 1px solid #C8C8C8;
            padding: 12px 60px;
            display: flex;
            align-items: center;
            gap: 32px;
            z-index: 100;
        }
        .nav-logo { font-size: 20px; font-weight: 400; color: #0A0203; }
        .nav-back {
            color: #0A0203; text-decoration: none; font-size: 13px;
            opacity: 0.6; transition: opacity 0.15s; white-space: nowrap;
        }
        .nav-back:hover { opacity: 1; }
        .nav-user {
            margin-left: auto; display: flex; align-items: center;
            gap: 16px; font-size: 13px;
        }
        .nav-user-email { color: #0A0203; opacity: 0.5; }
        .btn-logout {
            background: transparent; color: #0A0203;
            border: 1px solid #C8C8C8; padding: 5px 14px;
            font-size: 12px; cursor: pointer; transition: all 0.15s;
            font-family: inherit; border-radius: 3px;
        }
        .btn-logout:hover { background: #f5f5f5; border-color: #999; }

        /* Content */
        .app-content {
            flex: 1; padding: 40px;
            padding-top: 96px;
            max-width: 1100px; margin: 0 auto; width: 100%;
        }

        .page-title { font-size: 24px; font-weight: 700; margin-bottom: 8px; }
        .page-sub { font-size: 14px; color: #666; margin-bottom: 32px; }

        /* Section */
        .section {
            background: #F8F8F8; border: 1px solid #e0e0e0;
            border-radius: 6px; padding: 28px; margin-bottom: 24px;
        }
        .section-title { font-size: 16px; font-weight: 700; margin-bottom: 4px; }
        .section-desc { font-size: 13px; color: #888; margin-bottom: 20px; }

        /* Table */
        .approval-table { width: 100%; border-collapse: collapse; }
        .approval-table th, .approval-table td {
            padding: 10px 8px; text-align: left;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }
        .approval-table th {
            font-size: 11px; text-transform: uppercase;
            letter-spacing: 0.5px; color: #888; font-weight: 600;
            background: #fafaf8;
        }
        .approval-table tbody tr:last-child td { border-bottom: none; }
        .approval-table tbody tr:hover { background: #fdfcfa; }

        .col-code { width: 12%; }
        .col-cat { width: 16%; }
        .col-desc { width: 30%; }
        .col-type { width: 12%; }
        .col-price { width: 12%; }
        .col-actions { width: 18%; text-align: right; }

        .approval-table td.col-actions { text-align: right; }

        .td-code { font-weight: 600; font-size: 12px; color: #555; }
        .td-by { font-size: 12px; color: #888; }

        .btn-examine {
            background: #4b6050; color: #fff; border: none;
            padding: 6px 16px; font-size: 12px; font-family: inherit;
            cursor: pointer; border-radius: 3px; transition: opacity 0.2s;
        }
        .btn-examine:hover { opacity: 0.85; }

        /* Modal */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.45);
            z-index: 1000; justify-content: center; align-items: center;
        }
        .modal-overlay.active { display: flex; }

        .modal {
            background: #fff; border-radius: 8px;
            width: 90%; max-width: 460px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.18);
            max-height: 90vh; display: flex; flex-direction: column;
        }
        .modal-header {
            padding: 20px 24px 0; display: flex;
            justify-content: space-between; align-items: center;
        }
        .modal-title { font-size: 17px; font-weight: 700; }
        .modal-proposed-by { font-size: 12px; color: #888; margin-top: 2px; }
        .modal-body { padding: 20px 24px; overflow-y: auto; }
        .modal-footer {
            padding: 16px 24px; border-top: 1px solid #e0e0e0;
            display: flex; gap: 10px; justify-content: flex-end;
        }

        .form-group { margin-bottom: 16px; }
        .form-group:last-child { margin-bottom: 0; }
        .form-label {
            display: block; font-size: 12px; font-weight: 600;
            color: #555; margin-bottom: 6px; text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .form-input {
            width: 100%; padding: 8px 10px;
            border: 1px solid #e0e0e0; border-radius: 4px;
            font-family: inherit; font-size: 14px;
        }
        .form-input:focus { outline: none; border-color: #4b6050; }
        .form-select {
            width: 100%; padding: 8px 10px;
            border: 1px solid #e0e0e0; border-radius: 4px;
            font-family: inherit; font-size: 14px;
            background: #fff; cursor: pointer;
        }
        .form-select:focus { outline: none; border-color: #4b6050; }

        .btn-approve {
            background: #4b6050; color: #fff; border: none;
            padding: 8px 20px; font-size: 13px; font-family: inherit;
            cursor: pointer; border-radius: 4px; transition: opacity 0.2s;
            font-weight: 600;
        }
        .btn-approve:hover { opacity: 0.85; }

        .btn-reject {
            background: none; color: #c0392b; border: 1px solid #e0c0c0;
            padding: 7px 18px; font-size: 13px; font-family: inherit;
            cursor: pointer; border-radius: 4px; transition: all 0.2s;
        }
        .btn-reject:hover { background: #fdf0f0; border-color: #c0392b; }

        .btn-modal-cancel {
            background: none; color: #666; border: 1px solid #ddd;
            padding: 7px 18px; font-size: 13px; font-family: inherit;
            cursor: pointer; border-radius: 4px; transition: all 0.2s;
            margin-right: auto;
        }
        .btn-modal-cancel:hover { background: #f5f5f5; border-color: #999; }

        .modal-status {
            padding: 10px 14px; margin-top: 16px; border-radius: 4px;
            font-size: 13px; display: none;
        }
        .modal-status.success { display: block; background: #e8f5e9; color: #2e7d32; }
        .modal-status.error { display: block; background: #ffebee; color: #c62828; }

        /* Feedback */
        .feedback {
            display: none; padding: 10px 16px; margin-bottom: 16px;
            border-radius: 4px; font-size: 13px;
        }
        .feedback.success { display: block; background: #e8f5e9; color: #2e7d32; }
        .feedback.error { display: block; background: #ffebee; color: #c62828; }

        /* Empty state */
        .empty-state {
            text-align: center; padding: 48px 20px;
            color: #999; font-size: 15px;
        }

        /* Footer */
        .app-footer {
            padding: 20px 40px; text-align: center;
            font-size: 11px; color: #999;
            border-top: 1px solid #e0e0e0;
        }

        @media (max-width: 768px) {
            .nav-bar { padding: 12px 20px; gap: 16px; }
            .app-content { padding: 24px 16px; padding-top: 80px; }
            .section { padding: 20px 16px; }
            .approval-table th, .approval-table td { padding: 8px 4px; font-size: 12px; }
            .modal { width: 95%; max-width: none; }
        }
    </style>
</head>
<body>
    <div class="app-wrapper">
        <nav class="nav-bar">
            <span class="nav-logo">stele</span>
            <a href="app.html" class="nav-back">&larr; Menu</a>
            <div class="nav-user">
                <span class="nav-user-email" id="userEmail"></span>
                <button class="btn-logout" onclick="handleLogout()">D&eacute;connexion</button>
            </div>
        </nav>

        <main class="app-content">
            <div class="page-title">Approbations</div>
            <div class="page-sub">Examinez et approuvez les articles propos&eacute;s au catalogue.</div>

            <div class="feedback" id="feedback"></div>

            <div class="section">
                <div class="section-title">Articles en attente d'approbation</div>
                <div class="section-desc">Modifiez les champs si n&eacute;cessaire avant d'approuver.</div>

                <div id="tableWrap">
                    <div class="empty-state" id="emptyState" style="display:none;">Aucun article en attente d'approbation.</div>
                    <table class="approval-table" id="approvalTable" style="display:none;">
                        <thead>
                            <tr>
                                <th class="col-code">Code</th>
                                <th class="col-cat">Cat&eacute;gorie</th>
                                <th class="col-desc">Description</th>
                                <th class="col-type">Type</th>
                                <th class="col-price">Prix</th>
                                <th class="col-actions"></th>
                            </tr>
                        </thead>
                        <tbody id="approvalBody"></tbody>
                    </table>
                </div>
            </div>
        </main>

        <footer class="app-footer">stele &mdash; stele.ca</footer>
    </div>

    <!-- Modal examiner -->
    <div class="modal-overlay" id="examineModal">
        <div class="modal">
            <div class="modal-header">
                <div>
                    <div class="modal-title">Examiner l'article</div>
                    <div class="modal-proposed-by" id="modalProposedBy"></div>
                </div>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Code</label>
                    <input class="form-input" id="modalCode" type="text" readonly style="background:#f5f5f5; color:#888;">
                </div>
                <div class="form-group">
                    <label class="form-label">Cat&eacute;gorie</label>
                    <select class="form-select" id="modalCategory"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <input class="form-input" id="modalDescription" type="text">
                </div>
                <div class="form-group">
                    <label class="form-label">Type</label>
                    <select class="form-select" id="modalType"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Prix</label>
                    <input class="form-input" id="modalPrice" type="number" min="0" step="0.01">
                </div>
                <div class="modal-status" id="modalStatus"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal-cancel" onclick="closeModal()">Fermer</button>
                <button class="btn-reject" onclick="rejectFromModal()">Rejeter</button>
                <button class="btn-approve" onclick="approveFromModal()">Approuver</button>
            </div>
        </div>
    </div>

    <script>
    var SUPABASE_URL = 'https://rplzbtjfnwahqodrhpny.supabase.co';
    var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJwbHpidGpmbndhaHFvZHJocG55Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NDU2MDEsImV4cCI6MjA4NjIyMTYwMX0.OQAZhc029PbRDSe1b02NDAuOUE8yn-_h3QqSnUDpLeU';

    var DEFAULT_CATEGORIES = ['Budg\u00e9taire', 'Panneaux', 'Poign\u00e9es', 'Tiroirs', '\u00c9clairage', 'Portes int\u00e9rieures'];
    var CATEGORIES = DEFAULT_CATEGORIES.slice();
    var TYPES = ['pi\u00b2', 'unitaire', 'lin\u00e9aire', '%'];

    // ═══ Auth ═══

    document.getElementById('userEmail').textContent = localStorage.getItem('sb_user_email') || '';

    async function refreshAccessToken() {
        var refreshToken = localStorage.getItem('sb_refresh_token');
        if (!refreshToken) return false;
        try {
            var response = await fetch(SUPABASE_URL + '/auth/v1/token?grant_type=refresh_token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'apikey': SUPABASE_KEY },
                body: JSON.stringify({ refresh_token: refreshToken })
            });
            if (!response.ok) return false;
            var data = await response.json();
            if (data.access_token) {
                localStorage.setItem('sb_access_token', data.access_token);
                localStorage.setItem('sb_refresh_token', data.refresh_token);
                return true;
            }
            return false;
        } catch (e) { return false; }
    }

    async function authenticatedFetch(url, options) {
        var tok = localStorage.getItem('sb_access_token');
        var headers = Object.assign({}, options.headers || {}, {
            'apikey': SUPABASE_KEY,
            'Authorization': 'Bearer ' + tok
        });
        var resp = await fetch(url, Object.assign({}, options, { headers: headers }));
        if (resp.status === 401) {
            var refreshed = await refreshAccessToken();
            if (refreshed) {
                headers['Authorization'] = 'Bearer ' + localStorage.getItem('sb_access_token');
                return fetch(url, Object.assign({}, options, { headers: headers }));
            }
        }
        return resp;
    }

    function handleLogout() {
        localStorage.removeItem('sb_access_token');
        localStorage.removeItem('sb_refresh_token');
        localStorage.removeItem('sb_user_email');
        localStorage.removeItem('sb_user_id');
        window.location.href = 'login.html';
    }

    var DEFAULT_PERMISSIONS = {
        'Admin': { approbation: true }, 'Vente': { approbation: false },
        'Charg\u00e9 de projet': { approbation: false }, 'Achat': { approbation: false },
        'Atelier': { approbation: false }, 'Client': { approbation: false }
    };
    var DEFAULT_USER_ROLES = { 'hubert@stele.ca': 'Admin' };

    async function checkPageAccess() {
        try {
            var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/app_config?select=key,value', {});
            var perms = DEFAULT_PERMISSIONS, roles = DEFAULT_USER_ROLES;
            if (r.ok) {
                var rows = await r.json();
                for (var i = 0; i < rows.length; i++) {
                    if (rows[i].key === 'permissions') perms = rows[i].value;
                    if (rows[i].key === 'user_roles') roles = rows[i].value;
                }
            }
            var email = (localStorage.getItem('sb_user_email') || '').toLowerCase();
            var role = roles[email] || 'Client';
            var defaults = DEFAULT_PERMISSIONS[role] || {};
            var saved = (perms[role] || {});
            var allowed = {};
            for (var k in defaults) allowed[k] = defaults[k];
            for (var k2 in saved) allowed[k2] = saved[k2];
            if (!allowed.approbation) { window.location.href = 'app.html'; return false; }
        } catch (e) {
            var email2 = (localStorage.getItem('sb_user_email') || '').toLowerCase();
            var role2 = DEFAULT_USER_ROLES[email2] || 'Client';
            if (!(DEFAULT_PERMISSIONS[role2] || {}).approbation) { window.location.href = 'app.html'; return false; }
        }
        return true;
    }

    // ═══ Load pending items ═══

    var pendingItems = [];

    async function loadPending() {
        try {
            var r = await authenticatedFetch(
                SUPABASE_URL + '/rest/v1/catalogue_items?status=eq.pending&order=id&select=id,category,description,type,price,proposed_by,sort_order,in_calculator',
                {}
            );
            if (!r.ok) { showMsg('error', 'Erreur chargement: ' + r.status); return; }
            pendingItems = await r.json();
            renderTable();
        } catch (e) {
            showMsg('error', 'Erreur de connexion.');
        }
    }

    function renderTable() {
        var body = document.getElementById('approvalBody');
        var table = document.getElementById('approvalTable');
        var empty = document.getElementById('emptyState');

        if (pendingItems.length === 0) {
            table.style.display = 'none';
            empty.style.display = '';
            return;
        }

        table.style.display = '';
        empty.style.display = 'none';

        var html = '';
        for (var i = 0; i < pendingItems.length; i++) {
            var item = pendingItems[i];
            var priceDisplay = item.price != null ? parseFloat(item.price).toFixed(2) + ' $' : '—';

            html += '<tr id="row-' + escapeAttr(item.id) + '" style="cursor:pointer;" onclick="openModal(\'' + escapeAttr(item.id) + '\')">'
                + '<td class="td-code">' + escapeHtml(item.id) + '</td>'
                + '<td>' + escapeHtml(item.category || '') + '</td>'
                + '<td>' + escapeHtml(item.description || '') + '</td>'
                + '<td>' + escapeHtml(item.type || '') + '</td>'
                + '<td>' + priceDisplay + '</td>'
                + '<td class="col-actions">'
                +   '<button class="btn-examine" onclick="event.stopPropagation(); openModal(\'' + escapeAttr(item.id) + '\')">Examiner</button>'
                + '</td>'
                + '</tr>';
        }
        body.innerHTML = html;
    }

    // ═══ Modal ═══

    var currentItemId = null;

    function openModal(itemId) {
        var item = pendingItems.find(function(it) { return it.id === itemId; });
        if (!item) return;

        currentItemId = itemId;

        // Populate code (read-only)
        document.getElementById('modalCode').value = item.id;

        // Populate proposed by
        document.getElementById('modalProposedBy').textContent = 'Propos\u00e9 par : ' + (item.proposed_by || '—');

        // Populate category dropdown
        var catSel = document.getElementById('modalCategory');
        catSel.innerHTML = CATEGORIES.map(function(c) {
            return '<option value="' + escapeAttr(c) + '"' + (c === item.category ? ' selected' : '') + '>' + escapeHtml(c) + '</option>';
        }).join('');

        // Populate description
        document.getElementById('modalDescription').value = item.description || '';

        // Populate type dropdown
        var typeSel = document.getElementById('modalType');
        typeSel.innerHTML = TYPES.map(function(t) {
            return '<option value="' + escapeAttr(t) + '"' + (t === item.type ? ' selected' : '') + '>' + escapeHtml(t) + '</option>';
        }).join('');

        // Populate price
        document.getElementById('modalPrice').value = item.price != null ? item.price : '';

        // Reset status
        var st = document.getElementById('modalStatus');
        st.className = 'modal-status';
        st.textContent = '';

        document.getElementById('examineModal').classList.add('active');
    }

    function closeModal() {
        document.getElementById('examineModal').classList.remove('active');
        currentItemId = null;
    }

    // Click outside to close
    document.getElementById('examineModal').addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });

    function removeItemFromList(itemId) {
        pendingItems = pendingItems.filter(function(it) { return it.id !== itemId; });
        var row = document.getElementById('row-' + itemId);
        if (row) row.remove();
        if (pendingItems.length === 0) {
            document.getElementById('approvalTable').style.display = 'none';
            document.getElementById('emptyState').style.display = '';
        }
    }

    async function approveFromModal() {
        if (!currentItemId) return;

        var description = document.getElementById('modalDescription').value.trim();
        if (!description) {
            showModalStatus('error', 'La description ne peut pas \u00eatre vide.');
            return;
        }

        var category = document.getElementById('modalCategory').value;
        var type = document.getElementById('modalType').value;
        var priceVal = document.getElementById('modalPrice').value;
        var price = priceVal !== '' ? parseFloat(priceVal) : null;

        try {
            var r = await authenticatedFetch(
                SUPABASE_URL + '/rest/v1/catalogue_items?id=eq.' + encodeURIComponent(currentItemId),
                {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                    body: JSON.stringify({
                        status: 'approved',
                        category: category,
                        description: description,
                        type: type,
                        price: price
                    })
                }
            );
            if (!r.ok) { showModalStatus('error', 'Erreur approbation: ' + r.status); return; }

            showModalStatus('success', '\u2713 Article ' + currentItemId + ' approuv\u00e9 avec succ\u00e8s.');
            var approvedId = currentItemId;
            setTimeout(function() {
                removeItemFromList(approvedId);
                closeModal();
                showMsg('success', '\u2713 Article ' + approvedId + ' approuv\u00e9.');
            }, 1500);
        } catch (e) {
            showModalStatus('error', 'Erreur r\u00e9seau.');
        }
    }

    async function rejectFromModal() {
        if (!currentItemId) return;
        if (!confirm('Rejeter et supprimer l\u2019article ' + currentItemId + ' ?')) return;

        try {
            var r = await authenticatedFetch(
                SUPABASE_URL + '/rest/v1/catalogue_items?id=eq.' + encodeURIComponent(currentItemId),
                { method: 'DELETE' }
            );
            if (!r.ok) { showModalStatus('error', 'Erreur suppression: ' + r.status); return; }

            showModalStatus('success', 'Article ' + currentItemId + ' rejet\u00e9.');
            var rejectedId = currentItemId;
            setTimeout(function() {
                removeItemFromList(rejectedId);
                closeModal();
                showMsg('success', 'Article ' + rejectedId + ' rejet\u00e9.');
            }, 1500);
        } catch (e) {
            showModalStatus('error', 'Erreur r\u00e9seau.');
        }
    }

    function showModalStatus(type, text) {
        var el = document.getElementById('modalStatus');
        el.textContent = text;
        el.className = 'modal-status ' + type;
    }

    // ═══ Helpers ═══

    function showMsg(type, text) {
        var el = document.getElementById('feedback');
        el.textContent = text;
        el.className = 'feedback ' + type;
        setTimeout(function() { el.className = 'feedback'; }, 5000);
    }

    function escapeHtml(str) {
        var div = document.createElement('div');
        div.textContent = str || '';
        return div.innerHTML;
    }

    function escapeAttr(str) {
        return (str || '').replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;');
    }

    // ═══ Load categories from app_config ═══

    async function loadCategories() {
        try {
            var r = await authenticatedFetch(
                SUPABASE_URL + '/rest/v1/app_config?key=eq.catalogue_categories&select=value', {}
            );
            if (r.ok) {
                var rows = await r.json();
                if (rows.length > 0 && Array.isArray(rows[0].value) && rows[0].value.length > 0) {
                    CATEGORIES = rows[0].value;
                }
            }
        } catch (e) { /* keep defaults */ }
    }

    // ═══ Init ═══

    (async function() {
        if (!(await checkPageAccess())) return;
        await loadCategories();
        loadPending();
    })();
    </script>
</body>
</html>
