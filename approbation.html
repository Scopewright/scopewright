<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Approbations — Scopewright</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="scopewright-tokens.css">

    <!-- Auth guard -->
    <script>
        if (!localStorage.getItem('sb_access_token')) {
            window.location.href = 'login.html';
        } else {
            document.documentElement.style.visibility = 'visible';
        }
    </script>
    <style>html { visibility: hidden; }</style>

    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }

        html, body {
            height: 100%;
        }

        .app-wrapper { display: flex; min-height: 100vh; flex-direction: column; }

        /* HEADER SCOPEWRIGHT STANDARD */
        .nav-bar { position: fixed; top: 0; left: 0; right: 0; height: 56px; background: var(--sw-surface); border-bottom: 1px solid var(--sw-border); padding: 0 60px; display: flex; align-items: center; gap: var(--sw-space-3); z-index: 100; }
        .nav-logo { font-size: 23px; font-weight: 650; letter-spacing: -0.025em; line-height: 1; color: var(--sw-navy); text-decoration: none; }
        .nav-back { color: var(--sw-text); text-decoration: none; font-size: 13px; font-weight: 400; opacity: 0.45; transition: opacity var(--sw-ease); white-space: nowrap; }
        .nav-back:hover { opacity: 0.8; }
        .data-status { margin-left: auto; display: flex; align-items: center; gap: 8px; font-size: 12px; padding: 6px 12px; border-radius: 20px; background: #f5f5f5; }
        .data-status.online { background: #e8f5e9; color: #2e7d32; }
        .data-status.offline { background: #fff3e0; color: #ef6c00; }
        .data-status.error { background: #ffebee; color: #c62828; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; }
        .data-status.online .status-dot { background: #4caf50; }
        .data-status.offline .status-dot { background: #ff9800; }
        .data-status.error .status-dot { background: #f44336; }
        .status-text { white-space: nowrap; }

        /* Content */
        .app-content {
            flex: 1; padding: 40px;
            padding-top: 96px;
            max-width: 1100px; margin: 0 auto; width: 100%;
        }

        .page-title { font-size: 24px; font-weight: 700; margin-bottom: 8px; }
        .page-sub { font-size: 14px; color: #666; margin-bottom: 32px; }

        /* Section */
        .section {
            background: #F8F8F8; border: 1px solid #e0e0e0;
            border-radius: 6px; padding: 28px; margin-bottom: 24px;
        }
        .section-title { font-size: 16px; font-weight: 700; margin-bottom: 4px; }
        .section-desc { font-size: 13px; color: #888; margin-bottom: 20px; }

        /* Table */
        .approval-table { width: 100%; border-collapse: collapse; }
        .approval-table th, .approval-table td {
            padding: 10px 8px; text-align: left;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }
        .approval-table th {
            font-size: 11px; text-transform: uppercase;
            letter-spacing: 0.5px; color: #888; font-weight: 600;
            background: #fafaf8;
        }
        .approval-table tbody tr:last-child td { border-bottom: none; }
        .approval-table tbody tr:hover { background: #fdfcfa; }

        .col-code { width: 12%; }
        .col-cat { width: 16%; }
        .col-desc { width: 30%; }
        .col-type { width: 12%; }
        .col-price { width: 12%; }
        .col-actions { width: 18%; text-align: right; }

        .approval-table td.col-actions { text-align: right; }

        .td-code { font-weight: 600; font-size: 12px; color: #555; }
        .td-by { font-size: 12px; color: #888; }

        .btn-examine {
            background: var(--sw-navy); color: #fff; border: none;
            padding: 6px 16px; font-size: 12px; font-family: inherit;
            cursor: pointer; border-radius: 3px; transition: opacity 0.2s;
        }
        .btn-examine:hover { opacity: 0.85; }

        /* Modal */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.45);
            z-index: 1000; justify-content: center; align-items: center;
        }
        .modal-overlay.active { display: flex; }

        .modal {
            background: #fff; border-radius: 8px;
            width: 90%; max-width: 460px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.18);
            max-height: 90vh; display: flex; flex-direction: column;
        }
        .modal-header {
            padding: 20px 24px 0; display: flex;
            justify-content: space-between; align-items: center;
        }
        .modal-title { font-size: 17px; font-weight: 700; }
        .modal-proposed-by { font-size: 12px; color: #888; margin-top: 2px; }
        .modal-body { padding: 20px 24px; overflow-y: auto; }
        .modal-footer {
            padding: 16px 24px; border-top: 1px solid #e0e0e0;
            display: flex; gap: 10px; justify-content: flex-end;
        }

        .form-group { margin-bottom: 16px; }
        .form-group:last-child { margin-bottom: 0; }
        .form-label {
            display: block; font-size: 12px; font-weight: 600;
            color: #555; margin-bottom: 6px; text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        .form-input {
            width: 100%; padding: 8px 10px;
            border: 1px solid #e0e0e0; border-radius: 4px;
            font-family: inherit; font-size: 14px;
        }
        .form-input:focus { outline: none; border-color: var(--sw-navy); }
        .form-select {
            width: 100%; padding: 8px 10px;
            border: 1px solid #e0e0e0; border-radius: 4px;
            font-family: inherit; font-size: 14px;
            background: #fff; cursor: pointer;
        }
        .form-select:focus { outline: none; border-color: var(--sw-navy); }

        .btn-approve {
            background: var(--sw-navy); color: #fff; border: none;
            padding: 8px 20px; font-size: 13px; font-family: inherit;
            cursor: pointer; border-radius: 4px; transition: opacity 0.2s;
            font-weight: 600;
        }
        .btn-approve:hover { opacity: 0.85; }

        .btn-reject {
            background: none; color: #c0392b; border: 1px solid #e0c0c0;
            padding: 7px 18px; font-size: 13px; font-family: inherit;
            cursor: pointer; border-radius: 4px; transition: all 0.2s;
        }
        .btn-reject:hover { background: #fdf0f0; border-color: #c0392b; }

        .btn-modal-cancel {
            background: none; color: #666; border: 1px solid #ddd;
            padding: 7px 18px; font-size: 13px; font-family: inherit;
            cursor: pointer; border-radius: 4px; transition: all 0.2s;
            margin-right: auto;
        }
        .btn-modal-cancel:hover { background: #f5f5f5; border-color: #999; }

        .modal-status {
            padding: 10px 14px; margin-top: 16px; border-radius: 4px;
            font-size: 13px; display: none;
        }
        .modal-status.success { display: block; background: #e8f5e9; color: #2e7d32; }
        .modal-status.error { display: block; background: #ffebee; color: #c62828; }

        /* AI dot button in modal header */
        .btn-ai-dot-header {
            width: 28px; height: 28px; border-radius: 50%;
            border: none; background: transparent; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: background 150ms; flex-shrink: 0;
        }
        .btn-ai-dot-header:hover { background: rgba(0,0,0,0.06); }
        .btn-ai-dot-header .ai-dot {
            width: 9px; height: 9px; border-radius: 50%;
            background: #0B1220; opacity: 0.45;
            animation: aiBreathe 3s ease-in-out infinite;
        }
        .btn-ai-dot-header.ai-active .ai-dot {
            animation: aiBreathe 1.5s ease-in-out infinite;
        }
        @keyframes aiBreathe {
            0%, 100% { opacity: .45; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.15); }
        }

        /* AI Review chat overlay */
        .ai-review-overlay {
            position: fixed; top: 0; right: 0; bottom: 0; left: 0;
            background: rgba(0,0,0,0.3); z-index: 9010;
            display: flex; justify-content: flex-end;
            animation: arFadeIn 200ms ease;
        }
        @keyframes arFadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes arSlideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        .ai-review-panel {
            width: 440px; max-width: 100%; height: 100%;
            background: #fff; display: flex; flex-direction: column;
            box-shadow: -4px 0 24px rgba(0,0,0,0.12);
            animation: arSlideIn 250ms ease;
        }

        .ai-review-header {
            padding: 16px 20px; display: flex;
            justify-content: space-between; align-items: center;
            border-bottom: 1px solid #e5e7eb; flex-shrink: 0;
        }
        .ai-review-header span {
            font-size: 15px; font-weight: 700; color: #0f172a;
        }
        .ai-review-close {
            width: 28px; height: 28px; border: none; background: transparent;
            cursor: pointer; font-size: 18px; color: #64748b; border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
        }
        .ai-review-close:hover { background: #f1f5f9; color: #0f172a; }

        .ai-review-messages {
            flex: 1; overflow-y: auto; padding: 16px 20px;
            display: flex; flex-direction: column; gap: 12px;
        }

        @keyframes arMsgFadeIn {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .ai-review-msg {
            max-width: 88%; padding: 10px 14px;
            border-radius: 10px; font-size: 13px; line-height: 1.55;
            word-wrap: break-word; white-space: pre-wrap;
            animation: arMsgFadeIn 140ms ease-out both;
        }
        .ai-review-msg.user {
            align-self: flex-end; background: rgba(15,28,45,0.06); color: #1A1A2E;
        }
        .ai-review-msg.assistant {
            align-self: flex-start; background: #FFFFFF; color: #1e293b;
            box-shadow: 0 1px 2px rgba(0,0,0,0.04);
        }
        .ai-review-msg.assistant p { margin: 0 0 8px; }
        .ai-review-msg.assistant p:last-child { margin-bottom: 0; }
        .ai-review-msg.assistant strong { font-weight: 700; }
        .ai-review-msg.assistant ul, .ai-review-msg.assistant ol {
            margin: 4px 0 8px 18px; padding: 0;
        }
        .ai-review-msg.assistant li { margin-bottom: 2px; }
        .ai-review-msg.assistant code {
            background: rgba(0,0,0,0.06); padding: 1px 4px;
            border-radius: 3px; font-size: 12px;
        }
        .ai-review-msg.context {
            align-self: flex-start; background: transparent; color: rgba(0,0,0,0.4);
            font-size: 12px; padding: 4px 0; border-radius: 0;
            max-width: 100%;
        }

        /* Typing indicator */
        .ai-review-typing {
            padding: 8px 20px; display: flex; gap: 4px; align-items: center;
        }
        .ai-review-typing .dot {
            width: 6px; height: 6px; border-radius: 50%;
            background: #94a3b8; animation: arTyping 1.4s infinite;
        }
        .ai-review-typing .dot:nth-child(2) { animation-delay: 0.2s; }
        .ai-review-typing .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes arTyping {
            0%, 60%, 100% { opacity: 0.3; transform: scale(0.8); }
            30% { opacity: 1; transform: scale(1); }
        }

        /* Input area */
        .ai-review-input-area {
            padding: 12px 16px; border-top: 1px solid #e5e7eb;
            display: flex; gap: 8px; align-items: flex-end; flex-shrink: 0;
        }
        .ai-review-input {
            flex: 1; resize: none; border: 1px solid #d1d5db;
            border-radius: 10px; padding: 8px 12px; font-family: inherit;
            font-size: 13px; line-height: 1.4; max-height: 120px;
            outline: none; transition: border-color 150ms;
        }
        .ai-review-input:focus { border-color: #0F1C2D; }
        .ai-review-send {
            width: 32px; height: 32px; border-radius: 50%;
            border: none; background: #0F1C2D; color: #fff;
            cursor: pointer; font-size: 16px; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
            transition: opacity 150ms;
        }
        .ai-review-send:hover { opacity: 0.85; }
        .ai-review-send:disabled { opacity: 0.4; cursor: default; }

        @media (prefers-reduced-motion: reduce) {
            .btn-ai-dot-header .ai-dot,
            .btn-ai-dot-header.ai-active .ai-dot { animation: none; opacity: 0.7; }
            .ai-review-overlay, .ai-review-panel { animation: none; }
            .ai-review-typing .dot { animation: none; opacity: 0.5; }
        }

        /* Feedback */
        .feedback {
            display: none; padding: 10px 16px; margin-bottom: 16px;
            border-radius: 4px; font-size: 13px;
        }
        .feedback.success { display: block; background: #e8f5e9; color: #2e7d32; }
        .feedback.error { display: block; background: #ffebee; color: #c62828; }

        /* Empty state */
        .empty-state {
            text-align: center; padding: 48px 20px;
            color: #999; font-size: 15px;
        }

        /* Footer */
        .app-footer {
            padding: 20px 40px; text-align: center;
            font-size: 11px; color: #999;
            border-top: 1px solid #e0e0e0;
        }

        /* Modal élargi pour vue complète article */
        .modal.modal-edit {
            max-width: 800px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        .edit-row {
            display: flex;
            gap: 12px;
        }
        .edit-row .form-group {
            flex: 1;
        }

        /* Prix composé — tableaux minutes & matériaux */
        .composed-price-section {
            display: flex;
            gap: 16px;
            margin-top: 8px;
        }
        .cp-table-wrap {
            flex: 1;
            min-width: 0;
        }
        .cp-section-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--sw-navy);
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 1px solid #f0f0f0;
        }
        .cp-sub-title {
            font-size: 11px;
            font-weight: 600;
            color: #555;
            margin-bottom: 6px;
        }
        .cp-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .cp-table th {
            text-align: left;
            font-weight: 600;
            font-size: 11px;
            color: #888;
            padding: 4px 6px;
            border-bottom: 1px solid #e0e0e0;
        }
        .cp-table th:last-child {
            text-align: right;
        }
        .cp-table td {
            padding: 3px 6px;
        }
        .cp-table td:first-child {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 140px;
            font-size: 11px;
        }
        .cp-table td:last-child {
            text-align: right;
        }
        .cp-table input[type="number"] {
            width: 100%;
            padding: 4px 6px;
            border: 1px solid #e0e0e0;
            border-radius: 3px;
            font-size: 12px;
            text-align: right;
            font-family: inherit;
        }
        .cp-table input[type="number"]:focus {
            outline: none;
            border-color: var(--sw-navy);
        }
        .cp-calculated {
            margin-top: 12px;
            padding: 10px 14px;
            background: #f8f8f4;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }
        .cp-calculated .cp-total-label {
            font-weight: 600;
            color: #555;
        }
        .cp-calculated .cp-total-value {
            font-weight: 700;
            font-size: 16px;
            color: var(--sw-navy);
        }
        .cp-calculated .cp-breakdown {
            font-size: 11px;
            color: #888;
            margin-left: 8px;
        }

        /* Médias */
        .cat-media-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--sw-navy);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f0f0f0;
        }
        .cat-dropzone {
            border: 2px dashed var(--sw-border);
            border-radius: 6px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s;
            font-size: 13px;
            color: #888;
            margin-bottom: 12px;
        }
        .cat-dropzone:hover,
        .cat-dropzone.dragover {
            border-color: var(--sw-navy);
            color: var(--sw-navy);
        }
        .cat-media-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .cat-media-item {
            display: flex;
            gap: 10px;
            padding: 10px;
            background: #f8f8f8;
            border-radius: 6px;
            align-items: flex-start;
        }
        .cat-media-item img {
            width: 80px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid var(--sw-border);
            flex-shrink: 0;
        }
        .cat-pdf-icon {
            width: 80px;
            height: 60px;
            background: #e8e8e8;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            color: #999;
            flex-shrink: 0;
        }
        .cat-media-info { flex: 1; min-width: 0; }
        .cat-media-name {
            font-size: 12px;
            font-weight: 500;
            color: #333;
            word-break: break-word;
        }
        .cat-media-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .cat-tag {
            display: inline-block;
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 12px;
            cursor: pointer;
            border: 1px solid var(--sw-border);
            background: #fff;
            color: #666;
            transition: all 0.15s;
            user-select: none;
        }
        .cat-tag.active {
            background: var(--sw-navy);
            color: #fff;
            border-color: var(--sw-navy);
        }
        .cat-media-remove {
            background: none;
            border: none;
            color: #c62828;
            cursor: pointer;
            font-size: 18px;
            padding: 0 4px;
            flex-shrink: 0;
            opacity: 0.5;
            transition: opacity 0.15s;
        }
        .cat-media-remove:hover { opacity: 1; }

        /* Toggles */
        .edit-toggle-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .edit-toggle {
            position: relative;
            display: inline-block;
            width: 38px;
            height: 22px;
        }
        .edit-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .edit-toggle .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #ddd;
            border-radius: 22px;
            transition: background 0.25s;
        }
        .edit-toggle .slider::before {
            content: '';
            position: absolute;
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background: #fff;
            border-radius: 50%;
            transition: transform 0.25s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.15);
        }
        .edit-toggle input:checked + .slider {
            background: var(--sw-navy);
        }
        .edit-toggle input:checked + .slider::before {
            transform: translateX(16px);
        }
        .edit-toggle-label {
            font-size: 13px;
            color: var(--sw-text);
        }

        @media (max-width: 768px) {
            .composed-price-section {
                flex-direction: column;
            }
            .modal.modal-edit {
                max-width: 98vw;
            }
            .nav-bar { padding: 0 20px; gap: 16px; }
            .app-content { padding: 24px 16px; padding-top: 80px; }
            .section { padding: 20px 16px; }
            .approval-table th, .approval-table td { padding: 8px 4px; font-size: 12px; }
            .modal { width: 95%; max-width: none; }
        }
    </style>
</head>
<body>
    <div class="app-wrapper">
        <nav class="nav-bar">
            <span class="nav-logo">scopewright</span>
            <a href="app.html" class="nav-back">&larr; Menu</a>
            <div class="data-status" id="dataStatus">
                <span class="status-dot"></span>
                <span class="status-text" id="statusText">Chargement...</span>
            </div>
        </nav>

        <main class="app-content">
            <div class="page-title">Approbations</div>
            <div class="page-sub">Examinez et approuvez les articles propos&eacute;s au catalogue.</div>

            <div class="feedback" id="feedback"></div>

            <!-- Soumissions en attente -->
            <div class="section">
                <div class="section-title">Soumissions en attente d'approbation</div>
                <div class="section-desc">Approuvez ou retournez les soumissions soumises pour r&eacute;vision interne.</div>

                <div id="subTableWrap">
                    <div class="empty-state" id="subEmptyState" style="display:none;">Aucune soumission en attente.</div>
                    <table class="approval-table" id="subTable" style="display:none;">
                        <thead>
                            <tr>
                                <th style="width:10%">#</th>
                                <th style="width:25%">Projet</th>
                                <th style="width:25%">Titre</th>
                                <th style="width:12%">Version</th>
                                <th style="width:12%">Total</th>
                                <th style="width:16%; text-align:right;"></th>
                            </tr>
                        </thead>
                        <tbody id="subBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Articles en attente -->
            <div class="section">
                <div class="section-title">Articles en attente d'approbation</div>
                <div class="section-desc">Modifiez les champs si n&eacute;cessaire avant d'approuver.</div>

                <div id="tableWrap">
                    <div class="empty-state" id="emptyState" style="display:none;">Aucun article en attente d'approbation.</div>
                    <table class="approval-table" id="approvalTable" style="display:none;">
                        <thead>
                            <tr>
                                <th class="col-code">Code</th>
                                <th class="col-cat">Cat&eacute;gorie</th>
                                <th class="col-desc">Description</th>
                                <th class="col-type">Type</th>
                                <th class="col-price">Prix</th>
                                <th class="col-actions"></th>
                            </tr>
                        </thead>
                        <tbody id="approvalBody"></tbody>
                    </table>
                </div>
            </div>
        </main>

        <footer class="app-footer">stele &mdash; stele.ca</footer>
    </div>

    <!-- Modal examiner -->
    <div class="modal-overlay" id="examineModal">
        <div class="modal modal-edit">
            <div class="modal-header">
                <div>
                    <div class="modal-title">Examiner l'article</div>
                    <div class="modal-proposed-by" id="modalProposedBy"></div>
                </div>
                <button class="btn-ai-dot-header" id="aiReviewBtn" onclick="openAiReviewChat()" title="Assistant AI">
                    <span class="ai-dot"></span>
                </button>
            </div>
            <div class="modal-body">
                <div class="edit-row">
                    <div class="form-group">
                        <label class="form-label">Code</label>
                        <input class="form-input" id="modalCode" type="text" readonly style="background:#f5f5f5; color:#888;">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Cat&eacute;gorie</label>
                        <select class="form-select" id="modalCategory"></select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <input class="form-input" id="modalDescription" type="text">
                </div>
                <div class="edit-row">
                    <div class="form-group">
                        <label class="form-label">Type</label>
                        <select class="form-select" id="modalType"></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Prix</label>
                        <div class="form-input" id="modalPriceDisplay" style="background:#f5f5f5; color:#888;">Calculé automatiquement</div>
                        <input type="hidden" id="modalPrice">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Instruction</label>
                    <textarea class="form-input" id="modalInstruction" rows="2" style="resize:vertical;"></textarea>
                </div>

                <!-- Prix composé -->
                <div class="form-group" id="composedPriceGroup">
                    <div class="cp-section-title">Prix compos&eacute;</div>
                    <div class="composed-price-section">
                        <div class="cp-table-wrap">
                            <div class="cp-sub-title">Minutes main-d'&oelig;uvre</div>
                            <table class="cp-table">
                                <thead><tr><th>D&eacute;partement</th><th style="width:70px">Min.</th></tr></thead>
                                <tbody id="cpMinutesBody"></tbody>
                            </table>
                        </div>
                        <div class="cp-table-wrap">
                            <div class="cp-sub-title">Mat&eacute;riaux</div>
                            <table class="cp-table">
                                <thead><tr><th>Cat&eacute;gorie</th><th style="width:80px">Co&ucirc;t ($)</th></tr></thead>
                                <tbody id="cpMaterialsBody"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="cp-calculated">
                        <div>
                            <span class="cp-total-label">Prix calcul&eacute;</span>
                            <span class="cp-breakdown" id="cpBreakdown"></span>
                        </div>
                        <span class="cp-total-value" id="cpTotalValue">—</span>
                    </div>
                </div>

                <!-- Médias -->
                <div class="form-group" id="mediaGroup">
                    <div class="cat-media-title">M&eacute;dias</div>
                    <div class="cat-dropzone" id="catDropzone">
                        Cliquer ou glisser des images / PDFs ici
                    </div>
                    <input type="file" id="catMediaInput" accept="image/*,.pdf,application/pdf" multiple style="display:none;">
                    <div class="cat-media-list" id="catMediaList"></div>
                </div>

                <!-- Toggles -->
                <div class="form-group" style="margin-bottom:0;">
                    <div class="edit-toggle-row">
                        <label class="edit-toggle">
                            <input type="checkbox" id="modalInCalculator">
                            <span class="slider"></span>
                        </label>
                        <span class="edit-toggle-label">Visible dans le calculateur</span>
                    </div>
                    <div class="edit-toggle-row" style="margin-top: 12px;">
                        <label class="edit-toggle">
                            <input type="checkbox" id="modalHasSalesSheet">
                            <span class="slider"></span>
                        </label>
                        <span class="edit-toggle-label">Ce produit a une fiche de vente</span>
                    </div>
                </div>

                <div class="modal-status" id="modalStatus"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal-cancel" onclick="closeModal()">Fermer</button>
                <button class="btn-reject" onclick="rejectFromModal()">Rejeter</button>
                <button class="btn-approve" onclick="approveFromModal()">Approuver</button>
            </div>
        </div>
    </div>

    <!-- Modal générique -->
    <div class="modal-overlay" id="steleDialogOverlay">
        <div class="modal" style="max-width:440px;">
            <div class="modal-header">
                <div class="modal-title" id="steleDialogTitle"></div>
            </div>
            <div class="modal-body">
                <p id="steleDialogMessage" style="font-size:14px; color:#444; margin-bottom:0;"></p>
            </div>
            <div class="modal-footer">
                <button class="btn-modal-cancel" id="steleDialogCancel" onclick="steleDialogResolve(null)" style="display:none;">Annuler</button>
                <button class="btn-approve" id="steleDialogOk" onclick="steleDialogResolve(true)">OK</button>
            </div>
        </div>
    </div>

    <!-- AI Review Chat Overlay -->
    <div class="ai-review-overlay" id="aiReviewOverlay" style="display:none">
        <div class="ai-review-panel">
            <div class="ai-review-header">
                <span>R&eacute;vision AI</span>
                <button class="ai-review-close" onclick="closeAiReviewChat()">&times;</button>
            </div>
            <div class="ai-review-messages" id="aiReviewMessages"></div>
            <div class="ai-review-typing" id="aiReviewTyping" style="display:none">
                <span class="dot"></span><span class="dot"></span><span class="dot"></span>
            </div>
            <div class="ai-review-input-area">
                <textarea class="ai-review-input" id="aiReviewInput" placeholder="Poser une question..." rows="1"></textarea>
                <button class="ai-review-send" id="aiReviewSendBtn" onclick="sendAiReviewMessage()" title="Envoyer">&#8593;</button>
            </div>
        </div>
    </div>

    <script>
    var SUPABASE_URL = 'https://rplzbtjfnwahqodrhpny.supabase.co';
    var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJwbHpidGpmbndhaHFvZHJocG55Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NDU2MDEsImV4cCI6MjA4NjIyMTYwMX0.OQAZhc029PbRDSe1b02NDAuOUE8yn-_h3QqSnUDpLeU';

    var _steleDialogResolve = null;
    function steleDialogResolve(val) {
        document.getElementById('steleDialogOverlay').classList.remove('active');
        if (_steleDialogResolve) { var fn = _steleDialogResolve; _steleDialogResolve = null; fn(val); }
    }
    function steleConfirm(msg, title, okLabel, danger) {
        return new Promise(function(resolve) {
            _steleDialogResolve = resolve;
            document.getElementById('steleDialogTitle').textContent = title || 'Confirmation';
            document.getElementById('steleDialogMessage').textContent = msg;
            document.getElementById('steleDialogCancel').style.display = '';
            document.getElementById('steleDialogOk').textContent = okLabel || 'Confirmer';
            if (danger) document.getElementById('steleDialogOk').style.background = '#c0392b';
            else document.getElementById('steleDialogOk').style.background = '';
            document.getElementById('steleDialogOverlay').classList.add('active');
        });
    }

    var DEFAULT_CATEGORIES = ['Budg\u00e9taire', 'Panneaux', 'Poign\u00e9es', 'Tiroirs', '\u00c9clairage', 'Portes int\u00e9rieures'];
    var CATEGORIES = DEFAULT_CATEGORIES.slice();
    var TYPES = ['pi\u00b2', 'unitaire', 'lin\u00e9aire', '%'];

    // ═══ Auth ═══

    function updateStatus(state, text) {
        var el = document.getElementById('dataStatus');
        var txt = document.getElementById('statusText');
        if (!el || !txt) return;
        el.className = 'data-status ' + state;
        txt.textContent = text;
    }

    var _refreshPromise = null;
    function isTokenExpiringSoon(token, bufferSec) {
        if (!token) return true;
        try { var p = JSON.parse(atob(token.split('.')[1])); return p.exp < (Date.now() / 1000 + (bufferSec || 300)); }
        catch(e) { return true; }
    }
    function _tokenDebug(token) {
        if (!token) return 'null';
        try { var p = JSON.parse(atob(token.split('.')[1])); var ttl = Math.round(p.exp - Date.now() / 1000); return 'exp in ' + ttl + 's'; }
        catch(e) { return 'invalid'; }
    }
    async function refreshAccessToken() {
        if (_refreshPromise) { console.log('[auth] Refresh already in progress, reusing promise'); return _refreshPromise; }
        _refreshPromise = (async function() {
            var rt = localStorage.getItem('sb_refresh_token');
            if (!rt) { console.warn('[auth] No refresh token in localStorage'); return false; }
            try {
                var r = await fetch(SUPABASE_URL + '/auth/v1/token?grant_type=refresh_token', {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'apikey': SUPABASE_KEY },
                    body: JSON.stringify({ refresh_token: rt })
                });
                if (!r.ok) { var errBody = await r.text().catch(function() { return ''; }); console.warn('[auth] Refresh failed:', r.status, errBody.substring(0, 200)); return false; }
                var d = await r.json();
                if (d.access_token) { localStorage.setItem('sb_access_token', d.access_token); localStorage.setItem('sb_refresh_token', d.refresh_token); console.log('[auth] Token refreshed OK —', _tokenDebug(d.access_token)); return true; }
                console.warn('[auth] Refresh response missing access_token'); return false;
            } catch(e) { console.warn('[auth] Refresh exception:', e.message); return false; }
        })();
        var result = await _refreshPromise; _refreshPromise = null; return result;
    }
    async function authenticatedFetch(url, options) {
        options = options || {};
        var token = localStorage.getItem('sb_access_token');
        var endpoint = url.split('/').pop().split('?')[0];
        if (isTokenExpiringSoon(token, 300)) {
            console.log('[auth]', endpoint, '— token expiring soon (' + _tokenDebug(token) + '), refreshing...');
            if (await refreshAccessToken()) token = localStorage.getItem('sb_access_token');
        }
        var headers = Object.assign({}, options.headers || {}, { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + token });
        var resp = await fetch(url, Object.assign({}, options, { headers: headers }));
        if (resp.status === 401 || resp.status === 403) {
            console.warn('[auth]', endpoint, '— got', resp.status, '(token:', _tokenDebug(token) + '). Refreshing...');
            for (var attempt = 1; attempt <= 2; attempt++) {
                if (attempt === 2) { console.warn('[auth]', endpoint, '— attempt 2: waiting 1s before retry...'); await new Promise(function(r) { setTimeout(r, 1000); }); _refreshPromise = null; }
                if (await refreshAccessToken()) {
                    token = localStorage.getItem('sb_access_token'); headers['Authorization'] = 'Bearer ' + token;
                    resp = await fetch(url, Object.assign({}, options, { headers: headers }));
                    if (resp.status !== 401 && resp.status !== 403) { console.log('[auth]', endpoint, '— retry', attempt, 'succeeded:', resp.status); return resp; }
                    console.warn('[auth]', endpoint, '— retry', attempt, 'still', resp.status);
                } else { console.warn('[auth]', endpoint, '— refresh failed on attempt', attempt); localStorage.removeItem('sb_access_token'); localStorage.removeItem('sb_refresh_token'); window.location.href = 'login.html'; return resp; }
            }
        }
        return resp;
    }


    var DEFAULT_PERMISSIONS = {
        'Admin': { approbation: true }, 'Vente': { approbation: false },
        'Charg\u00e9 de projet': { approbation: false }, 'Achat': { approbation: false },
        'Atelier': { approbation: false }, 'Client': { approbation: false }
    };
    var DEFAULT_USER_ROLES = { 'hubert@stele.ca': 'Admin' };

    async function checkPageAccess() {
        try {
            var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/app_config?select=key,value', {});
            var perms = DEFAULT_PERMISSIONS, roles = DEFAULT_USER_ROLES;
            if (r.ok) {
                var rows = await r.json();
                for (var i = 0; i < rows.length; i++) {
                    if (rows[i].key === 'permissions') perms = rows[i].value;
                    if (rows[i].key === 'user_roles') roles = rows[i].value;
                }
            }
            var email = (localStorage.getItem('sb_user_email') || '').toLowerCase();
            var role = roles[email] || 'Client';
            var defaults = DEFAULT_PERMISSIONS[role] || {};
            var saved = (perms[role] || {});
            var allowed = {};
            for (var k in defaults) allowed[k] = defaults[k];
            for (var k2 in saved) allowed[k2] = saved[k2];
            if (!allowed.approbation) { window.location.href = 'app.html'; return false; }
        } catch (e) {
            var email2 = (localStorage.getItem('sb_user_email') || '').toLowerCase();
            var role2 = DEFAULT_USER_ROLES[email2] || 'Client';
            if (!(DEFAULT_PERMISSIONS[role2] || {}).approbation) { window.location.href = 'app.html'; return false; }
        }
        return true;
    }

    // ═══ Load pending items ═══

    var pendingItems = [];

    async function loadPending() {
        try {
            var r = await authenticatedFetch(
                SUPABASE_URL + '/rest/v1/catalogue_items?status=eq.pending&order=id&select=id,category,description,type,price,proposed_by,sort_order,in_calculator,instruction,labor_minutes,material_costs,image_url,has_sales_sheet',
                {}
            );
            if (!r.ok) { showMsg('error', 'Erreur chargement: ' + r.status); return; }
            pendingItems = await r.json();
            renderTable();
        } catch (e) {
            showMsg('error', 'Erreur de connexion.');
        }
    }

    function renderTable() {
        var body = document.getElementById('approvalBody');
        var table = document.getElementById('approvalTable');
        var empty = document.getElementById('emptyState');

        if (pendingItems.length === 0) {
            table.style.display = 'none';
            empty.style.display = '';
            return;
        }

        table.style.display = '';
        empty.style.display = 'none';

        var html = '';
        for (var i = 0; i < pendingItems.length; i++) {
            var item = pendingItems[i];
            var priceDisplay = item.price != null ? parseFloat(item.price).toFixed(2) + ' $' : '—';

            html += '<tr id="row-' + escapeAttr(item.id) + '" style="cursor:pointer;" onclick="openModal(\'' + escapeAttr(item.id) + '\')">'
                + '<td class="td-code">' + escapeHtml(item.id) + '</td>'
                + '<td>' + escapeHtml(item.category || '') + '</td>'
                + '<td>' + escapeHtml(item.description || '') + '</td>'
                + '<td>' + escapeHtml(item.type || '') + '</td>'
                + '<td>' + priceDisplay + '</td>'
                + '<td class="col-actions">'
                +   '<button class="btn-examine" onclick="event.stopPropagation(); openModal(\'' + escapeAttr(item.id) + '\')">Examiner</button>'
                + '</td>'
                + '</tr>';
        }
        body.innerHTML = html;
    }

    // ═══ Modal ═══

    var currentItemId = null;
    var tauxHoraires = [];
    var expenseCategories = [];
    var editMedia = [];
    var editMediaToDelete = [];
    var mediaTagsList = ['fiche_client', 'catalogue', 'technique', 'dessin'];

    // ═══ Prix composé — Tableaux éditables ═══

    function renderComposedTables(item) {
        var laborMinutes = item.labor_minutes || {};
        var materialCosts = item.material_costs || {};

        // Tableau des minutes
        var mBody = document.getElementById('cpMinutesBody');
        var mHtml = '';
        for (var i = 0; i < tauxHoraires.length; i++) {
            var dept = tauxHoraires[i].department;
            var val = laborMinutes[dept] || '';
            mHtml += '<tr><td>' + escapeHtml(dept) + '</td>' +
                '<td><input type="number" step="0.1" placeholder="0" value="' + val + '"' +
                ' data-dept="' + escapeAttr(dept) + '"' +
                ' oninput="updateComposedPrice()"></td></tr>';
        }
        mBody.innerHTML = mHtml;

        // Tableau des matériaux
        var cBody = document.getElementById('cpMaterialsBody');
        var cHtml = '';
        for (var j = 0; j < expenseCategories.length; j++) {
            var cat = expenseCategories[j].name;
            var cVal = materialCosts[cat] || '';
            cHtml += '<tr><td title="' + escapeAttr(cat) + '">' + escapeHtml(cat) + '</td>' +
                '<td><input type="number" step="0.01" placeholder="0.00" value="' + cVal + '"' +
                ' data-cat="' + escapeAttr(cat) + '"' +
                ' oninput="updateComposedPrice()"></td></tr>';
        }
        cBody.innerHTML = cHtml;

        updateComposedPrice();
    }

    function updateComposedPrice() {
        // Calcul main-d'œuvre
        var laborTotal = 0;
        var mInputs = document.querySelectorAll('#cpMinutesBody input[type="number"]');
        for (var i = 0; i < mInputs.length; i++) {
            var minutes = parseFloat(mInputs[i].value) || 0;
            var dept = mInputs[i].getAttribute('data-dept');
            var taux = tauxHoraires.find(function(t) { return t.department === dept; });
            var tauxHoraire = taux ? (taux.taux_horaire || 0) : 0;
            laborTotal += (minutes / 60) * tauxHoraire;
        }

        // Calcul matériaux
        var materialTotal = 0;
        var cInputs = document.querySelectorAll('#cpMaterialsBody input[type="number"]');
        for (var j = 0; j < cInputs.length; j++) {
            var cost = parseFloat(cInputs[j].value) || 0;
            var catName = cInputs[j].getAttribute('data-cat');
            var expCat = expenseCategories.find(function(c) { return c.name === catName; });
            var markup = expCat ? (expCat.markup || 0) : 0;
            var waste = expCat ? (expCat.waste || 0) : 0;
            materialTotal += cost * (1 + markup / 100 + waste / 100);
        }

        var total = laborTotal + materialTotal;
        var totalEl = document.getElementById('cpTotalValue');
        var breakdownEl = document.getElementById('cpBreakdown');
        var priceDisplay = document.getElementById('modalPriceDisplay');
        var priceField = document.getElementById('modalPrice');

        if (total > 0) {
            totalEl.textContent = total.toFixed(2) + ' $';
            breakdownEl.textContent = '(MO: ' + laborTotal.toFixed(2) + ' + Mat: ' + materialTotal.toFixed(2) + ')';
            priceField.value = total.toFixed(2);
            priceDisplay.textContent = total.toFixed(2) + ' $';
        } else {
            totalEl.textContent = '\u2014';
            breakdownEl.textContent = '';
            priceField.value = '';
            priceDisplay.textContent = 'Calculé automatiquement';
        }
    }

    function collectLaborMinutes() {
        var data = {};
        var inputs = document.querySelectorAll('#cpMinutesBody input[type="number"]');
        for (var i = 0; i < inputs.length; i++) {
            var val = parseFloat(inputs[i].value) || 0;
            if (val > 0) {
                data[inputs[i].getAttribute('data-dept')] = val;
            }
        }
        return data;
    }

    function collectMaterialCosts() {
        var data = {};
        var inputs = document.querySelectorAll('#cpMaterialsBody input[type="number"]');
        for (var i = 0; i < inputs.length; i++) {
            var val = parseFloat(inputs[i].value) || 0;
            if (val > 0) {
                data[inputs[i].getAttribute('data-cat')] = val;
            }
        }
        return data;
    }

    // ═══ Médias — Render, Upload, Delete ═══

    function renderEditMedia() {
        var list = document.getElementById('catMediaList');
        list.innerHTML = '';

        editMedia.forEach(function(media, index) {
            var item = document.createElement('div');
            item.className = 'cat-media-item';

            if (media.file_type === 'pdf') {
                var pdfIcon = document.createElement('div');
                pdfIcon.className = 'cat-pdf-icon';
                pdfIcon.textContent = 'PDF';
                item.appendChild(pdfIcon);
            } else {
                var img = document.createElement('img');
                img.src = media.file_url || media.previewUrl || '';
                img.alt = '';
                item.appendChild(img);
            }

            var info = document.createElement('div');
            info.className = 'cat-media-info';

            var tags = document.createElement('div');
            tags.className = 'cat-media-tags';

            mediaTagsList.forEach(function(tag) {
                var chip = document.createElement('span');
                chip.className = 'cat-tag' + (media.tags.indexOf(tag) !== -1 ? ' active' : '');
                chip.textContent = tag.replace(/_/g, ' ');
                chip.onclick = function() {
                    var idx = media.tags.indexOf(tag);
                    if (idx !== -1) {
                        media.tags.splice(idx, 1);
                    } else {
                        media.tags.push(tag);
                    }
                    chip.classList.toggle('active');
                };
                tags.appendChild(chip);
            });

            info.appendChild(tags);
            item.appendChild(info);

            var removeBtn = document.createElement('button');
            removeBtn.className = 'cat-media-remove';
            removeBtn.innerHTML = '&times;';
            removeBtn.title = 'Supprimer';
            removeBtn.onclick = function() {
                if (media.id && !media.isNew) {
                    steleConfirm('Supprimer ce média ?').then(function(ok) {
                        if (!ok) return;
                        editMediaToDelete.push({ id: media.id, file_url: media.file_url });
                        editMedia.splice(index, 1);
                        renderEditMedia();
                    });
                    return;
                }
                editMedia.splice(index, 1);
                renderEditMedia();
            };
            item.appendChild(removeBtn);

            list.appendChild(item);
        });
    }

    function handleMediaFiles(files) {
        Array.from(files).forEach(function(file) {
            var isPdf = file.type === 'application/pdf';
            var isImage = file.type.startsWith('image/');
            if (!isPdf && !isImage) return;

            var mediaEntry = {
                id: null,
                file_url: null,
                previewUrl: null,
                file_type: isPdf ? 'pdf' : 'image',
                tags: [],
                isNew: true,
                file: file
            };

            if (isImage) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    mediaEntry.previewUrl = e.target.result;
                    editMedia.push(mediaEntry);
                    renderEditMedia();
                };
                reader.readAsDataURL(file);
            } else {
                editMedia.push(mediaEntry);
                renderEditMedia();
            }
        });
    }

    async function loadMediaTags() {
        try {
            var r = await authenticatedFetch(
                SUPABASE_URL + '/rest/v1/app_config?key=eq.media_tags&select=value', {}
            );
            if (r.ok) {
                var rows = await r.json();
                if (rows.length > 0 && Array.isArray(rows[0].value)) {
                    mediaTagsList = rows[0].value;
                }
            }
        } catch (e) { /* keep defaults */ }
    }

    async function loadMedia(itemId) {
        editMedia = [];
        editMediaToDelete = [];
        try {
            var r = await authenticatedFetch(
                SUPABASE_URL + '/rest/v1/item_media?catalogue_item_id=eq.' + encodeURIComponent(itemId) + '&order=sort_order&select=id,file_url,file_type,tags',
                {}
            );
            if (r.ok) {
                var existing = await r.json();
                editMedia = existing.map(function(m) {
                    return { id: m.id, file_url: m.file_url, file_type: m.file_type || 'image', tags: m.tags || [], isNew: false };
                });
            }
        } catch (e) { /* ignore */ }
        renderEditMedia();
    }

    function openModal(itemId) {
        var item = pendingItems.find(function(it) { return it.id === itemId; });
        if (!item) return;

        currentItemId = itemId;

        // Populate code (read-only)
        document.getElementById('modalCode').value = item.id;

        // Populate proposed by
        document.getElementById('modalProposedBy').textContent = 'Propos\u00e9 par : ' + (item.proposed_by || '\u2014');

        // Populate category dropdown
        var catSel = document.getElementById('modalCategory');
        catSel.innerHTML = CATEGORIES.map(function(c) {
            return '<option value="' + escapeAttr(c) + '"' + (c === item.category ? ' selected' : '') + '>' + escapeHtml(c) + '</option>';
        }).join('');

        // Populate description
        document.getElementById('modalDescription').value = item.description || '';

        // Populate type dropdown
        var typeSel = document.getElementById('modalType');
        typeSel.innerHTML = TYPES.map(function(t) {
            return '<option value="' + escapeAttr(t) + '"' + (t === item.type ? ' selected' : '') + '>' + escapeHtml(t) + '</option>';
        }).join('');

        // Populate instruction
        document.getElementById('modalInstruction').value = item.instruction || '';

        // Populate toggles
        document.getElementById('modalInCalculator').checked = item.in_calculator !== false;
        document.getElementById('modalHasSalesSheet').checked = item.has_sales_sheet === true;

        // Render composed price (editable inputs)
        renderComposedTables(item);

        // Load & render media from item_media
        loadMedia(itemId);

        // Reset status
        var st = document.getElementById('modalStatus');
        st.className = 'modal-status';
        st.textContent = '';

        document.getElementById('examineModal').classList.add('active');
    }

    function closeModal() {
        document.getElementById('examineModal').classList.remove('active');
        document.getElementById('aiReviewOverlay').style.display = 'none';
        currentItemId = null;
        editMedia = [];
        editMediaToDelete = [];
    }

    // Click outside to close
    document.getElementById('examineModal').addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });

    function removeItemFromList(itemId) {
        pendingItems = pendingItems.filter(function(it) { return it.id !== itemId; });
        var row = document.getElementById('row-' + itemId);
        if (row) row.remove();
        if (pendingItems.length === 0) {
            document.getElementById('approvalTable').style.display = 'none';
            document.getElementById('emptyState').style.display = '';
        }
    }

    async function approveFromModal() {
        if (!currentItemId) return;

        var description = document.getElementById('modalDescription').value.trim();
        if (!description) {
            showModalStatus('error', 'La description ne peut pas \u00eatre vide.');
            return;
        }

        var category = document.getElementById('modalCategory').value;
        var type = document.getElementById('modalType').value;
        var priceVal = document.getElementById('modalPrice').value;
        var price = priceVal !== '' ? parseFloat(priceVal) : null;
        var instruction = document.getElementById('modalInstruction').value.trim();
        var inCalculator = document.getElementById('modalInCalculator').checked;
        var hasSalesSheet = document.getElementById('modalHasSalesSheet').checked;
        var laborMinutes = collectLaborMinutes();
        var materialCosts = collectMaterialCosts();

        try {
            // 1. Save catalogue item
            var r = await authenticatedFetch(
                SUPABASE_URL + '/rest/v1/catalogue_items?id=eq.' + encodeURIComponent(currentItemId),
                {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                    body: JSON.stringify({
                        status: 'approved',
                        category: category,
                        description: description,
                        type: type,
                        price: price,
                        instruction: instruction || null,
                        in_calculator: inCalculator,
                        has_sales_sheet: hasSalesSheet,
                        labor_minutes: laborMinutes,
                        material_costs: materialCosts
                    })
                }
            );
            if (!r.ok) { showModalStatus('error', 'Erreur approbation: ' + r.status); return; }

            // 2. Save media changes
            await saveMediaChanges(currentItemId);

            showModalStatus('success', '\u2713 Article ' + currentItemId + ' approuv\u00e9 avec succ\u00e8s.');
            var approvedId = currentItemId;
            setTimeout(function() {
                removeItemFromList(approvedId);
                closeModal();
                showMsg('success', '\u2713 Article ' + approvedId + ' approuv\u00e9.');
            }, 1500);
        } catch (e) {
            showModalStatus('error', 'Erreur: ' + (e.message || 'réseau'));
        }
    }

    async function saveMediaChanges(itemId) {
        // 1. Delete removed media
        for (var i = 0; i < editMediaToDelete.length; i++) {
            var del = editMediaToDelete[i];
            await authenticatedFetch(SUPABASE_URL + '/rest/v1/item_media?id=eq.' + del.id, {
                method: 'DELETE',
                headers: { 'Prefer': 'return=minimal' }
            });
            if (del.file_url && del.file_url.indexOf('/fiche-images/') !== -1) {
                var storagePath = del.file_url.split('/fiche-images/')[1];
                if (storagePath) {
                    await authenticatedFetch(SUPABASE_URL + '/storage/v1/object/fiche-images/' + storagePath, {
                        method: 'DELETE'
                    }).catch(function() {});
                }
            }
        }
        editMediaToDelete = [];

        // 2. Upload new media + update tags on existing
        for (var j = 0; j < editMedia.length; j++) {
            var m = editMedia[j];

            if (m.isNew && m.file) {
                var ext = m.file.name.split('.').pop().toLowerCase() || 'bin';
                var path = itemId + '/' + Date.now() + '_' + j + '.' + ext;

                var uploadResp = await authenticatedFetch(SUPABASE_URL + '/storage/v1/object/fiche-images/' + path, {
                    method: 'POST',
                    headers: { 'Content-Type': m.file.type, 'x-upsert': 'true' },
                    body: m.file
                });
                if (!uploadResp.ok) throw new Error('Erreur upload: ' + uploadResp.status);

                var fileUrl = SUPABASE_URL + '/storage/v1/object/public/fiche-images/' + path;

                var insertResp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/item_media', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                    body: JSON.stringify({
                        catalogue_item_id: itemId,
                        file_url: fileUrl,
                        file_type: m.file_type,
                        tags: m.tags,
                        sort_order: j
                    })
                });
                if (!insertResp.ok) throw new Error('Erreur insertion média: ' + insertResp.status);

                var insertedData = await insertResp.json();
                m.id = insertedData[0].id;
                m.file_url = fileUrl;
                m.isNew = false;
                m.file = null;
                m.previewUrl = null;
            } else if (m.id && !m.isNew) {
                // Update tags
                await authenticatedFetch(SUPABASE_URL + '/rest/v1/item_media?id=eq.' + m.id, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                    body: JSON.stringify({ tags: m.tags, sort_order: j })
                });
            }
        }

        // 3. Auto-sync image_url from first media tagged "catalogue"
        var catalogueMedia = editMedia.find(function(m) { return m.tags.indexOf('catalogue') !== -1 && m.file_type === 'image'; });
        var syncImageUrl = catalogueMedia ? catalogueMedia.file_url : null;
        var currentItem = pendingItems.find(function(it) { return it.id === itemId; });
        if (currentItem && currentItem.image_url !== syncImageUrl) {
            await authenticatedFetch(SUPABASE_URL + '/rest/v1/catalogue_items?id=eq.' + itemId, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                body: JSON.stringify({ image_url: syncImageUrl })
            });
        }
    }

    async function rejectFromModal() {
        if (!currentItemId) return;
        if (!(await steleConfirm('Rejeter l\u2019article ' + currentItemId + ' ?\n\nL\u2019article restera dans les soumissions existantes mais ne sera pas ajout\u00e9 au catalogue.', 'Rejeter', 'Rejeter', true))) return;

        try {
            var r = await authenticatedFetch(
                SUPABASE_URL + '/rest/v1/catalogue_items?id=eq.' + encodeURIComponent(currentItemId),
                { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ status: 'rejected' }) }
            );
            if (!r.ok) { showModalStatus('error', 'Erreur rejet: ' + r.status); return; }

            showModalStatus('success', 'Article ' + currentItemId + ' rejet\u00e9.');
            var rejectedId = currentItemId;
            setTimeout(function() {
                removeItemFromList(rejectedId);
                closeModal();
                showMsg('success', 'Article ' + rejectedId + ' rejet\u00e9 (conserv\u00e9 pour les soumissions existantes).');
            }, 1500);
        } catch (e) {
            showModalStatus('error', 'Erreur r\u00e9seau.');
        }
    }

    function showModalStatus(type, text) {
        var el = document.getElementById('modalStatus');
        el.textContent = text;
        el.className = 'modal-status ' + type;
    }

    // ═══ Helpers ═══

    function showMsg(type, text) {
        var el = document.getElementById('feedback');
        el.textContent = text;
        el.className = 'feedback ' + type;
        setTimeout(function() { el.className = 'feedback'; }, 5000);
    }

    function escapeHtml(str) {
        var div = document.createElement('div');
        div.textContent = str || '';
        return div.innerHTML;
    }

    function escapeAttr(str) {
        return (str || '').replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;');
    }

    // ═══ Soumissions en attente ═══

    var pendingSubmissions = [];

    async function loadPendingSubmissions() {
        try {
            var r = await authenticatedFetch(
                SUPABASE_URL + '/rest/v1/submissions?status=eq.pending_internal&order=updated_at.desc&select=*,projects(name,client_name,user_id)',
                {}
            );
            if (!r.ok) return;
            pendingSubmissions = await r.json();
            renderSubTable();
        } catch (e) {
            console.error('Erreur chargement soumissions:', e);
        }
    }

    function renderSubTable() {
        var body = document.getElementById('subBody');
        var table = document.getElementById('subTable');
        var empty = document.getElementById('subEmptyState');

        if (pendingSubmissions.length === 0) {
            table.style.display = 'none';
            empty.style.display = '';
            return;
        }
        table.style.display = '';
        empty.style.display = 'none';

        var html = '';
        for (var i = 0; i < pendingSubmissions.length; i++) {
            var sub = pendingSubmissions[i];
            var projName = sub.projects ? sub.projects.name : '—';
            var totalStr = sub.approved_total != null ? parseFloat(sub.approved_total).toFixed(2) + ' $' : '—';
            html += '<tr style="cursor:pointer;" onclick="window.location.href=\'calculateur.html?submission=' + encodeURIComponent(sub.id) + '&from=approbation\'">'
                + '<td style="font-weight:600; font-size:12px; color:#555;">#' + escapeHtml(String(sub.submission_number)) + '</td>'
                + '<td>' + escapeHtml(projName) + '</td>'
                + '<td>' + escapeHtml(sub.title || 'Sans titre') + '</td>'
                + '<td>v' + (sub.current_version || 1) + '</td>'
                + '<td>' + totalStr + '</td>'
                + '<td style="text-align:right;">'
                + '<a href="calculateur.html?submission=' + encodeURIComponent(sub.id) + '&from=approbation" class="btn-examine" style="text-decoration:none;" onclick="event.stopPropagation();">Ouvrir</a>'
                + '</td>'
                + '</tr>';
        }
        body.innerHTML = html;
    }

    // ═══ Load categories from app_config ═══

    async function loadCategories() {
        try {
            var r = await authenticatedFetch(
                SUPABASE_URL + '/rest/v1/app_config?key=eq.catalogue_categories&select=value', {}
            );
            if (r.ok) {
                var rows = await r.json();
                if (rows.length > 0 && Array.isArray(rows[0].value) && rows[0].value.length > 0) {
                    CATEGORIES = rows[0].value;
                }
            }
        } catch (e) { /* keep defaults */ }
    }

    async function loadPricingConfig() {
        try {
            var r = await authenticatedFetch(
                SUPABASE_URL + '/rest/v1/app_config?key=in.(taux_horaires,expense_categories)&select=key,value', {}
            );
            if (r.ok) {
                var rows = await r.json();
                rows.forEach(function(row) {
                    if (row.key === 'taux_horaires' && row.value) {
                        tauxHoraires = row.value;
                    }
                    if (row.key === 'expense_categories' && Array.isArray(row.value)) {
                        expenseCategories = row.value;
                    }
                });
            }
        } catch (e) { /* keep defaults */ }
    }

    // ═══ Dropzone events ═══

    (function() {
        var dropzone = document.getElementById('catDropzone');
        var fileInput = document.getElementById('catMediaInput');

        dropzone.addEventListener('click', function() { fileInput.click(); });
        fileInput.addEventListener('change', function() {
            if (fileInput.files.length > 0) handleMediaFiles(fileInput.files);
            fileInput.value = '';
        });
        dropzone.addEventListener('dragover', function(e) {
            e.preventDefault();
            dropzone.classList.add('dragover');
        });
        dropzone.addEventListener('dragleave', function() {
            dropzone.classList.remove('dragover');
        });
        dropzone.addEventListener('drop', function(e) {
            e.preventDefault();
            dropzone.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) handleMediaFiles(e.dataTransfer.files);
        });
    })();

    // ═══ AI Review Chat ═══

    var aiReviewMessages = [];
    var aiReviewItemId = null;
    var aiReviewLoading = false;

    async function openAiReviewChat() {
        var item = pendingItems.find(function(it) { return it.id === currentItemId; });
        if (!item) return;

        // Reset conversation if different item
        if (aiReviewItemId !== currentItemId) {
            aiReviewMessages = [];
            aiReviewItemId = currentItemId;
            document.getElementById('aiReviewMessages').innerHTML = '';
        }

        // Show overlay
        document.getElementById('aiReviewOverlay').style.display = '';
        document.getElementById('aiReviewInput').focus();

        // If fresh conversation, send initial context + request analysis
        if (aiReviewMessages.length === 0) {
            await sendInitialReviewContext(item);
        }
    }

    function closeAiReviewChat() {
        document.getElementById('aiReviewOverlay').style.display = 'none';
    }

    // Click outside panel to close
    document.getElementById('aiReviewOverlay').addEventListener('click', function(e) {
        if (e.target === this) closeAiReviewChat();
    });

    async function sendInitialReviewContext(item) {
        // Load similar items from catalogue (same category, approved status)
        var similarItems = [];
        try {
            var r = await authenticatedFetch(
                SUPABASE_URL + '/rest/v1/catalogue_items?category=eq.' + encodeURIComponent(item.category) + '&status=neq.pending&select=id,description,type,price,labor_minutes,material_costs&limit=20',
                {}
            );
            if (r.ok) similarItems = await r.json();
        } catch (e) { /* continue without */ }

        // Build context message
        var contextParts = [];
        contextParts.push('=== ARTICLE PROPOSÉ ===');
        contextParts.push('Code: ' + item.id);
        contextParts.push('Description: ' + (item.description || '—'));
        contextParts.push('Catégorie: ' + (item.category || '—'));
        contextParts.push('Type d\'unité: ' + (item.type || '—'));
        contextParts.push('Proposé par: ' + (item.proposed_by || '—'));
        contextParts.push('Instruction: ' + (item.instruction || '—'));

        // Price type + calculated breakdown
        var hasLM = item.labor_minutes && typeof item.labor_minutes === 'object' && Object.keys(item.labor_minutes).some(function(d) { return item.labor_minutes[d] > 0; });
        var hasMC = item.material_costs && typeof item.material_costs === 'object' && Object.keys(item.material_costs).some(function(c) { var m = item.material_costs[c]; return m && m.cost > 0; });
        var isComposed = hasLM || hasMC;

        if (item.price != null && item.price > 0 && !isComposed) {
            contextParts.push('Type de prix: fixe (' + item.price + ' $)');
        } else if (isComposed) {
            var computedPrice = computeItemPrice(item);
            contextParts.push('Type de prix: composé (calculé à partir des composantes MO + matériaux)');

            // Labor detail
            var laborTotal = 0;
            if (hasLM) {
                contextParts.push('');
                var lmLines = [];
                for (var dept in item.labor_minutes) {
                    var mins = item.labor_minutes[dept] || 0;
                    if (mins <= 0) continue;
                    var th = tauxHoraires.find(function(t) { return t.department === dept; });
                    var rate = th ? th.taux_horaire : 0;
                    var laborCost = (mins / 60) * rate;
                    laborTotal += laborCost;
                    lmLines.push('  - ' + dept + ': ' + mins + ' min × ' + rate.toFixed(2) + ' $/h = ' + laborCost.toFixed(2) + ' $');
                }
                contextParts.push('Main-d\'oeuvre (total: ' + laborTotal.toFixed(2) + ' $):');
                lmLines.forEach(function(l) { contextParts.push(l); });
            }

            // Material detail
            var matTotal = 0;
            if (hasMC) {
                contextParts.push('');
                var mcLines = [];
                for (var mcat in item.material_costs) {
                    var mc = item.material_costs[mcat];
                    if (!mc || !mc.cost || mc.cost <= 0) continue;
                    var baseCost = mc.cost * (mc.qty || 1);
                    var ec = (expenseCategories || []).find(function(e) { return e.name === mcat; });
                    var markup = ec ? (ec.markup || 0) : 0;
                    var waste = ec ? (ec.waste || 0) : 0;
                    var matCost = baseCost * (1 + markup / 100 + waste / 100);
                    matTotal += matCost;
                    mcLines.push('  - ' + mcat + ': ' + baseCost.toFixed(2) + ' $ × (1 + ' + markup + '% markup + ' + waste + '% perte) = ' + matCost.toFixed(2) + ' $');
                }
                contextParts.push('Matériaux (total: ' + matTotal.toFixed(2) + ' $):');
                mcLines.forEach(function(l) { contextParts.push(l); });
            }

            contextParts.push('');
            contextParts.push('PRIX COMPOSÉ TOTAL: ' + computedPrice.toFixed(2) + ' $ (MO: ' + laborTotal.toFixed(2) + ' + Mat: ' + matTotal.toFixed(2) + ')');
        } else {
            contextParts.push('Type de prix: AUCUN (ni fixe ni composé) — à vérifier');
        }

        // Taux horaires
        if (tauxHoraires && tauxHoraires.length > 0) {
            var thParts = [];
            tauxHoraires.forEach(function(t) { thParts.push(t.department + ': ' + t.taux_horaire + ' $/h'); });
            contextParts.push('\n=== TAUX HORAIRES ===');
            contextParts.push(thParts.join(', '));
        }

        // Expense categories
        if (expenseCategories && expenseCategories.length > 0) {
            contextParts.push('\n=== CATÉGORIES DE DÉPENSES ===');
            expenseCategories.forEach(function(ec) {
                contextParts.push(ec.name + ': markup ' + (ec.markup || 0) + '%, perte ' + (ec.waste || 0) + '%');
            });
        }

        // Similar items
        if (similarItems.length > 0) {
            contextParts.push('\n=== ARTICLES SIMILAIRES AU CATALOGUE (même catégorie: ' + item.category + ') ===');
            similarItems.forEach(function(si) {
                var siPrice = si.price || computeItemPrice(si);
                var siLine = si.id + ' — ' + (si.description || '?') + ' — ' + (si.type || '?') + ' — ' + (siPrice > 0 ? siPrice.toFixed(2) + ' $' : 'prix N/A');
                contextParts.push(siLine);
            });
        } else {
            contextParts.push('\n=== ARTICLES SIMILAIRES ===\nAucun article de la même catégorie au catalogue.');
        }

        contextParts.push('\nAnalyse cet article selon les 4 axes (comparaison interne, benchmarking industrie, cohérence des données, verdict).');

        var contextMsg = contextParts.join('\n');

        // Show context indicator
        appendAiReviewMessage('context', 'Contexte transmis');

        // Add to messages array
        aiReviewMessages.push({ role: 'user', content: contextMsg });

        // Call API
        await callAiReviewAssistant();
    }

    function computeItemPrice(item) {
        var total = 0;
        // Labor
        if (item.labor_minutes && tauxHoraires) {
            for (var dept in item.labor_minutes) {
                var mins = item.labor_minutes[dept] || 0;
                var th = tauxHoraires.find(function(t) { return t.department === dept; });
                var rate = th ? th.taux_horaire : 0;
                total += (mins / 60) * rate;
            }
        }
        // Materials
        if (item.material_costs) {
            for (var cat in item.material_costs) {
                var mc = item.material_costs[cat];
                if (!mc || !mc.cost) continue;
                var cost = mc.cost * (mc.qty || 1);
                var ec = (expenseCategories || []).find(function(e) { return e.name === cat; });
                var markup = ec ? (ec.markup || 0) : 0;
                var waste = ec ? (ec.waste || 0) : 0;
                total += cost * (1 + markup / 100 + waste / 100);
            }
        }
        return total;
    }

    async function sendAiReviewMessage() {
        if (aiReviewLoading) return;
        var input = document.getElementById('aiReviewInput');
        var text = input.value.trim();
        if (!text) return;

        input.value = '';
        input.style.height = 'auto';

        // Add user message
        aiReviewMessages.push({ role: 'user', content: text });
        appendAiReviewMessage('user', text);

        await callAiReviewAssistant();
    }

    async function callAiReviewAssistant() {
        aiReviewLoading = true;
        var btn = document.getElementById('aiReviewBtn');
        var sendBtn = document.getElementById('aiReviewSendBtn');
        btn.classList.add('ai-active');
        sendBtn.disabled = true;
        document.getElementById('aiReviewTyping').style.display = '';
        scrollReviewMessages();

        try {
            var r = await authenticatedFetch(
                SUPABASE_URL + '/functions/v1/ai-assistant',
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: aiReviewMessages,
                        context: {},
                        prompt_key: 'ai_prompt_approval_review',
                        tools_enabled: false
                    })
                }
            );

            if (!r.ok) {
                var errText = '';
                try { var errData = await r.json(); errText = errData.error || r.status; } catch(e) { errText = r.status; }
                appendAiReviewMessage('assistant', 'Erreur : ' + errText);
                return;
            }

            var data = await r.json();
            if (data.error) {
                appendAiReviewMessage('assistant', 'Erreur : ' + data.error);
                return;
            }

            // Extract text from content blocks
            var responseText = '';
            if (Array.isArray(data.content)) {
                data.content.forEach(function(block) {
                    if (block.type === 'text') responseText += block.text;
                });
            } else if (typeof data.content === 'string') {
                responseText = data.content;
            }

            if (responseText) {
                aiReviewMessages.push({ role: 'assistant', content: responseText });
                appendAiReviewMessage('assistant', responseText);
            }
        } catch (e) {
            appendAiReviewMessage('assistant', 'Erreur de connexion.');
        } finally {
            aiReviewLoading = false;
            btn.classList.remove('ai-active');
            sendBtn.disabled = false;
            document.getElementById('aiReviewTyping').style.display = 'none';
        }
    }

    function appendAiReviewMessage(role, content) {
        var container = document.getElementById('aiReviewMessages');
        var div = document.createElement('div');
        div.className = 'ai-review-msg ' + role;

        if (role === 'assistant') {
            div.innerHTML = renderReviewMarkdown(content);
        } else if (role === 'context') {
            div.textContent = content;
        } else {
            div.textContent = content;
        }

        container.appendChild(div);
        scrollReviewMessages();
    }

    function renderReviewMarkdown(text) {
        // Basic markdown rendering
        var html = escapeHtml(text);

        // Bold **text**
        html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

        // Italic *text*
        html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');

        // Inline code `text`
        html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

        // Headers ### → bold
        html = html.replace(/^#{1,4}\s+(.+)$/gm, '<strong>$1</strong>');

        // Unordered lists
        html = html.replace(/^[-•]\s+(.+)$/gm, '<li>$1</li>');
        html = html.replace(/((?:<li>.*<\/li>\n?)+)/g, '<ul>$1</ul>');

        // Numbered lists
        html = html.replace(/^\d+\.\s+(.+)$/gm, '<li>$1</li>');

        // Paragraphs (double newlines)
        html = html.replace(/\n{2,}/g, '</p><p>');
        html = '<p>' + html + '</p>';

        // Single newlines inside paragraphs → <br>
        html = html.replace(/\n/g, '<br>');

        // Clean up empty paragraphs
        html = html.replace(/<p>\s*<\/p>/g, '');

        return html;
    }

    function scrollReviewMessages() {
        var el = document.getElementById('aiReviewMessages');
        setTimeout(function() { el.scrollTop = el.scrollHeight; }, 50);
    }

    // Keyboard: Enter to send, Escape to close, auto-resize
    (function() {
        var input = document.getElementById('aiReviewInput');
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendAiReviewMessage();
            }
            if (e.key === 'Escape') {
                closeAiReviewChat();
            }
        });
        input.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
    })();

    // Close with Escape key on overlay
    document.getElementById('aiReviewOverlay').addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closeAiReviewChat();
    });

    // ═══ Init ═══

    (async function() {
        if (!(await checkPageAccess())) return;
        await loadCategories();
        await loadPricingConfig();
        await loadMediaTags();
        loadPending();
        loadPendingSubmissions();
        updateStatus('online', 'Données à jour');
    })();
    </script>
</body>
</html>
