<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stele — Calculateur</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="scopewright-tokens.css">
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;1,300;1,400&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"
            onerror="handleScriptError('PDF.js')"></script>

    <script>
    // ═══════════════════════════════════════════════════════════════════════
    // ERROR HANDLING & LOADING STATE
    // ═══════════════════════════════════════════════════════════════════════

    var appLoadTimeout = null;
    var scriptsLoaded = { pdfjs: false };
    var appReady = false;

    function handleScriptError(scriptName) {
        console.error('Failed to load:', scriptName);
        showOverlayError(
            'Erreur de connexion',
            'Impossible de charger les ressources nécessaires. Vérifiez votre connexion internet et rafraîchissez la page.'
        );
    }

    function showOverlayError(title, message) {
        clearTimeout(appLoadTimeout);
        var overlay = document.getElementById('appOverlay');
        if (!overlay) return;

        document.getElementById('overlaySpinner').style.display = 'none';
        document.getElementById('overlayErrorIcon').style.display = 'block';
        document.getElementById('overlayTitle').textContent = title;
        document.getElementById('overlayMessage').textContent = message;
        document.getElementById('overlayRetryBtn').style.display = 'inline-block';
        overlay.classList.remove('hidden');
    }

    function hideOverlay() {
        clearTimeout(appLoadTimeout);
        var overlay = document.getElementById('appOverlay');
        if (overlay) {
            overlay.classList.add('hidden');
            setTimeout(function() { overlay.style.display = 'none'; }, 300);
        }
    }

    // Timeout de 30 secondes pour le chargement initial
    appLoadTimeout = setTimeout(function() {
        if (!appReady) {
            console.error('App load timeout - appReady never set to true');
            showOverlayError(
                'Chargement lent',
                'Le chargement prend plus de temps que prévu. Vérifiez votre connexion internet ou rafraîchissez la page.'
            );
        }
    }, 30000);

    // ═══════════════════════════════════════════════════════════════════════
    // AUTHENTICATION & CONSTANTS
    // ═══════════════════════════════════════════════════════════════════════

    // Vérifier la connexion
    if (!localStorage.getItem('sb_access_token')) {
        window.location.href = 'login.html';
    }

    const SUPABASE_URL = 'https://rplzbtjfnwahqodrhpny.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJwbHpidGpmbndhaHFvZHJocG55Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NDU2MDEsImV4cCI6MjA4NjIyMTYwMX0.OQAZhc029PbRDSe1b02NDAuOUE8yn-_h3QqSnUDpLeU';

    const STORAGE_KEY = 'stele_catalogue_data';
    const STORAGE_DATE_KEY = 'stele_catalogue_date';

    // GAS retiré — workflow interne via soumissions

    let EMPLOYEES_DATA = [];
    let CATALOGUE_DATA = [];
    var _catEditRowId = null; // rowId being edited in catalogue iframe overlay
    let tauxHoraires = [];
    let expenseCategories = [];
    var _allUserRoles = {};    // { email: roleName } from app_config
    var _allPermissions = {};  // { roleName: { perm1: true, ... } } from app_config
    var USER_PROFILES_MAP = {}; // { email: "Prénom Nom" } from user_profiles
    var SUPPLIER_COMPANIES = [];     // [{id, name}] from companies where company_type='Fournisseurs'
    var _customItemDataMap = {};     // { rowId: { description, unit_price, markup, custom_data } }
    var _cimRowId = null;            // rowId being edited in custom item modal
    var _cimAttachments = [];        // [{path, name, type, size, isNew, file}]
    var _cimAttachmentsToDelete = []; // storage paths to delete on save
    let canEditMinutes = false;
    let canEditMaterials = false;
    let mediaTagsList = ['fiche_client', 'catalogue', 'technique', 'dessin'];
    // Pipeline commercial
    var pipelineStatuses = [];
    var projectSources = [];
    var projectTypes = [];
    var currentPipelineView = 'cards';
    var cachedProjects = [];
    var pipelineSortColumn = 'updated_at';
    var pipelineSortDir = 'desc';
    var pipelineFilters = { search: '', status: '', assigned: '', type: '', followsOnly: false, showArchived: false };
    var userFollows = {};

    // Configure PDF.js worker (wait for script to load)
    function initPdfJs() {
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            scriptsLoaded.pdfjs = true;
            return true;
        }
        return false;
    }

    // Try to initialize PDF.js immediately, or wait for load event
    if (!initPdfJs()) {
        window.addEventListener('load', initPdfJs);
    }

    // Global error handlers
    window.addEventListener('error', function(e) {
        if (e.filename && e.filename.includes('pdf')) {
            console.error('PDF.js error:', e);
            // Don't show overlay if app is already loaded
            if (!appReady) {
                handleScriptError('PDF.js');
            }
        }
    });

    window.addEventListener('unhandledrejection', function(e) {
        console.error('Unhandled promise rejection:', e.reason);
        // Only show overlay for critical errors during initialization
        if (!appReady && e.reason && (
            e.reason.message?.includes('fetch') ||
            e.reason.message?.includes('network') ||
            e.reason.message?.includes('Failed to fetch')
        )) {
            showOverlayError(
                'Erreur de connexion',
                'Impossible de se connecter au serveur. Vérifiez votre connexion internet.'
            );
        }
    });

    // ═══════════════════════════════════════════════════════════════════════
    // PROJETS — ÉTAT GLOBAL
    // ═══════════════════════════════════════════════════════════════════════

    let currentProject = null;      // objet projet courant { id, name, client_name, ... }
    let currentSubmission = null;   // objet soumission courante { id, submission_number, title, status, ... }
    let canApproveQuotes = false;   // permission can_approve_quotes
    let canBypassApproval = false;  // permission can_bypass_approval
    let canUnlockSubmission = false; // permission can_unlock_submission
    let isApprovalMode = false;     // true when opened from approbation.html via ?submission=
    let roomMap = {};               // { groupDomId: supabaseRoomUUID }
    let itemMap = {};               // { rowDomId: supabaseItemUUID }
    let groupImages = {};        // { groupDomId: [{ name, dataUrl }] }
    let roomModifiers = {};          // { groupDomId: number (percentage) } — price_modifier_pct per room
    let roomDM = {};                 // { groupDomId: [{type, catalogue_item_id, description}] } — per-room default materials
    let saveTimeout = null;      // pour le debounce
    const MAX_GROUP_IMAGES = 8;

    // Project contacts state
    var projectContacts = [];
    var allContactsCache = [];
    var selectedComboContactId = null;
    var configContactRoles = ['Client', 'Entrepreneur', 'Designer', 'Architecte', 'Ingénieur'];
    var allCompaniesCache = [];
    var selectedClientType = null;
    var selectedClientId = null;
    var coverImageUrl = null;
    var introConfig = {};
    var projectManagerEmail = '';

    // ═══════════════════════════════════════════════════════════════════════
    // DIALOGUES CUSTOM (remplace alert/confirm/prompt natifs)
    // ═══════════════════════════════════════════════════════════════════════

    var _steleDialogResolve = null;
    function steleDialogResolve(val) {
        document.getElementById('steleDialogOverlay').classList.remove('active');
        if (_steleDialogResolve) { var fn = _steleDialogResolve; _steleDialogResolve = null; fn(val); }
    }
    function steleDialogOk() {
        var input = document.getElementById('steleDialogInput');
        var wrap = document.getElementById('steleDialogInputWrap');
        steleDialogResolve(wrap.style.display === 'none' ? true : input.value);
    }

    function steleAlert(msg, title) {
        return new Promise(function(resolve) {
            _steleDialogResolve = resolve;
            document.getElementById('steleDialogTitle').textContent = title || '';
            document.getElementById('steleDialogMessage').textContent = msg;
            document.getElementById('steleDialogInputWrap').style.display = 'none';
            document.getElementById('steleDialogCancel').style.display = 'none';
            document.getElementById('steleDialogOk').textContent = 'OK';
            document.getElementById('steleDialogOk').className = 'btn-generate';
            document.getElementById('steleDialogOverlay').classList.add('active');
        });
    }

    function steleConfirm(msg, title, okLabel, danger) {
        return new Promise(function(resolve) {
            _steleDialogResolve = resolve;
            document.getElementById('steleDialogTitle').textContent = title || 'Confirmation';
            document.getElementById('steleDialogMessage').textContent = msg;
            document.getElementById('steleDialogInputWrap').style.display = 'none';
            document.getElementById('steleDialogCancel').style.display = '';
            document.getElementById('steleDialogOk').textContent = okLabel || 'Confirmer';
            document.getElementById('steleDialogOk').className = danger ? 'btn-generate' : 'btn-generate';
            if (danger) document.getElementById('steleDialogOk').style.background = '#c0392b';
            else document.getElementById('steleDialogOk').style.background = '';
            document.getElementById('steleDialogOverlay').classList.add('active');
        });
    }

    function stelePrompt(msg, title, placeholder, required) {
        return new Promise(function(resolve) {
            _steleDialogResolve = resolve;
            document.getElementById('steleDialogTitle').textContent = title || '';
            document.getElementById('steleDialogMessage').textContent = msg;
            document.getElementById('steleDialogInputWrap').style.display = '';
            var input = document.getElementById('steleDialogInput');
            input.value = '';
            input.placeholder = placeholder || '';
            document.getElementById('steleDialogCancel').style.display = '';
            document.getElementById('steleDialogOk').textContent = 'OK';
            document.getElementById('steleDialogOk').className = 'btn-generate';
            document.getElementById('steleDialogOk').style.background = '';
            document.getElementById('steleDialogOverlay').classList.add('active');
            setTimeout(function() { input.focus(); }, 100);
        });
    }

    // ═══════════════════════════════════════════════════════════════════════

    function escapeHtml(str) {
        if (!str) return '';
        var div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    function escapeAttr(str) {
        return (str || '').replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;');
    }

    // Convert plain text (legacy) to basic HTML; if already HTML, return as-is
    function textToHtml(str) {
        if (!str) return '';
        if (str.indexOf('<p>') !== -1 || str.indexOf('<strong>') !== -1 || str.indexOf('<ul>') !== -1) {
            return str; // already HTML
        }
        // Legacy plain text: escape then convert newlines to <br>
        return escapeHtml(str).replace(/\n/g, '<br>');
    }

    // Convert HTML to plain text for textarea display
    function htmlToText(str) {
        if (!str) return '';
        var tmp = document.createElement('div');
        tmp.innerHTML = str;
        return tmp.textContent || tmp.innerText || '';
    }

    // Format description text for display (MAJUSCULES → sentence case, bold keywords, lists)
    function formatDescriptionForDisplay(text) {
        if (!text || !text.trim()) return '';
        var lines = text.split('\n');
        var keywords = [
            'CAISSON', 'FAÇADES ET PANNEAUX APPARENTS', 'FAÇADES',
            'TIROIRS LEGRABOX', 'TIROIRS', 'POIGNÉES', 'ÉCLAIRAGE',
            'DÉTAILS', 'EXCLUSIONS', 'COMPTOIR', 'QUINCAILLERIE',
            'FINITION', 'ÉLECTRO', 'RANGEMENT', 'DIMENSIONS',
            'NOTES', 'PARTICULARITÉS'
        ];
        var hasKeyword = lines.some(function(l) {
            var upper = l.trim().toUpperCase();
            return keywords.some(function(k) { return upper.startsWith(k); });
        });
        if (!hasKeyword) return escapeHtml(text).replace(/\n/g, '<br>');
        var html = '';
        var inList = false;
        lines.forEach(function(line) {
            var trimmed = line.trim();
            if (!trimmed) { if (inList) { html += '</ul>'; inList = false; } return; }
            if (trimmed.startsWith('-') || trimmed.startsWith('•')) {
                if (!inList) { html += '<ul>'; inList = true; }
                html += '<li>' + escapeHtml(trimmed.replace(/^[-•]\s*/, '')) + '</li>';
                return;
            }
            if (inList) { html += '</ul>'; inList = false; }
            var matched = false;
            var upper = trimmed.toUpperCase();
            for (var i = 0; i < keywords.length; i++) {
                if (upper.startsWith(keywords[i])) {
                    var colonIdx = trimmed.indexOf(':');
                    if (colonIdx !== -1) {
                        var label = trimmed.substring(0, colonIdx).trim();
                        var value = trimmed.substring(colonIdx + 1).trim();
                        html += '<p><strong>' + escapeHtml(toSentenceCase(label)) + ' :</strong> ' + escapeHtml(value) + '</p>';
                    } else {
                        html += '<p><strong>' + escapeHtml(toSentenceCase(trimmed)) + '</strong></p>';
                    }
                    matched = true;
                    break;
                }
            }
            if (!matched) html += '<p>' + escapeHtml(trimmed) + '</p>';
        });
        if (inList) html += '</ul>';
        return html;
    }

    function toSentenceCase(str) {
        if (!str) return '';
        return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
    }

    function debounce(fn, delay) {
        let timer;
        return function(...args) {
            clearTimeout(timer);
            timer = setTimeout(() => fn.apply(this, args), delay);
        };
    }

    // ═══════════════════════════════════════════════════════════════════════
    // PROJETS — CRUD SUPABASE
    // ═══════════════════════════════════════════════════════════════════════

    async function loadProjects() {
        const userId = localStorage.getItem('sb_user_id');
        // Try enriched query with pipeline columns + contacts
        var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/projects?user_id=eq.' + userId + '&order=updated_at.desc&select=*,submissions(id,submission_number,title,status,current_version,updated_at,bypass_approval,approved_total,estimateur,vendeur_cp,approbateur,internal_deadline,client_deadline,estimateur_accepted_at,is_archived),project_contacts(role,is_primary,contacts(first_name,last_name,contact_companies(companies(name))))', {});
        if (!r.ok) {
            // Fallback: basic query without pipeline columns (migrations not yet run)
            r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/projects?user_id=eq.' + userId + '&order=updated_at.desc&select=*,submissions(id,submission_number,title,status,current_version,updated_at,bypass_approval,is_archived)', {});
            if (!r.ok) return [];
        }
        var projects = await r.json();
        projects.forEach(function(p) {
            if (p.submissions) p.submissions.sort(function(a, b) { return b.submission_number - a.submission_number; });
        });
        return projects;
    }

    async function createProject(name, clientName) {
        const userId = localStorage.getItem('sb_user_id');
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/projects', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
            body: JSON.stringify({ user_id: userId, name: name, client_name: clientName || '' })
        });
        if (!r.ok) throw new Error('Erreur création projet: ' + r.status);
        const data = await r.json();
        return data[0];
    }

    async function updateProject(projectId, fields) {
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/projects?id=eq.' + projectId, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
            body: JSON.stringify(fields)
        });
        return r.ok;
    }

    async function deleteProject(projectId) {
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/projects?id=eq.' + projectId, {
            method: 'DELETE'
        });
        return r.ok;
    }

    // ═══════════════════════════════════════════════════════════════════════
    // PROJECT FOLLOWS (★)
    // ═══════════════════════════════════════════════════════════════════════

    async function loadUserFollows() {
        var userId = localStorage.getItem('sb_user_id');
        try {
            var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/project_follows?user_id=eq.' + userId + '&select=project_id', {});
            if (!r.ok) return;
            var rows = await r.json();
            userFollows = {};
            rows.forEach(function(row) { userFollows[row.project_id] = true; });
        } catch (e) {
            console.warn('loadUserFollows error (table may not exist yet):', e);
        }
    }

    async function toggleFollow(projectId, evt) {
        evt.stopPropagation();
        var userId = localStorage.getItem('sb_user_id');
        if (userFollows[projectId]) {
            await authenticatedFetch(SUPABASE_URL + '/rest/v1/project_follows?project_id=eq.' + projectId + '&user_id=eq.' + userId, { method: 'DELETE' });
            delete userFollows[projectId];
        } else {
            await authenticatedFetch(SUPABASE_URL + '/rest/v1/project_follows', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                body: JSON.stringify({ project_id: projectId, user_id: userId })
            });
            userFollows[projectId] = true;
        }
        renderCurrentView();
    }

    function toggleFollowsFilter() {
        pipelineFilters.followsOnly = !pipelineFilters.followsOnly;
        var btn = document.getElementById('filterFollowsBtn');
        if (btn) btn.classList.toggle('active', pipelineFilters.followsOnly);
        applyPipelineFilters();
    }

    // ═══════════════════════════════════════════════════════════════════════
    // SOUMISSIONS — CRUD SUPABASE
    // ═══════════════════════════════════════════════════════════════════════

    async function loadSubmissions(projectId) {
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/submissions?project_id=eq.' + projectId + '&order=submission_number.desc&select=*', {});
        if (!r.ok) return [];
        return await r.json();
    }

    async function createSubmission(projectId, title) {
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/submissions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
            body: JSON.stringify({ project_id: projectId, title: title || '' })
        });
        if (!r.ok) throw new Error('Erreur cr\u00e9ation soumission: ' + r.status);
        const data = await r.json();
        return data[0];
    }

    async function updateSubmission(submissionId, fields) {
        // Guard: transition vers 'accepted' uniquement depuis 'sent_client'
        if (fields.status === 'accepted') {
            if (!currentSubmission || currentSubmission.status !== 'sent_client') {
                throw new Error('Transition invalide: seul le statut "sent_client" peut mener à "accepted".');
            }
        }
        fields.updated_at = new Date().toISOString();
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/submissions?id=eq.' + submissionId, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
            body: JSON.stringify(fields)
        });
        if (!r.ok) {
            var errText = '';
            try { errText = await r.text(); } catch(e) {}
            throw new Error('Échec mise à jour soumission (' + r.status + '): ' + errText);
        }
        return true;
    }

    async function deleteSubmission(submissionId) {
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/submissions?id=eq.' + submissionId, {
            method: 'DELETE'
        });
        return r.ok;
    }

    // Vérifie si une soumission a déjà été acceptée (online ou offline)
    async function wasAlreadyAccepted(submissionId) {
        try {
            var r = await authenticatedFetch(
                SUPABASE_URL + '/rest/v1/submission_reviews?submission_id=eq.' + submissionId +
                '&action=in.(offline_accepted,accepted)&limit=1&select=id',
                {}
            );
            if (r.ok) {
                var rows = await r.json();
                if (rows.length > 0) return true;
            }
            // Vérifier aussi via public_quote_tokens (acceptation en ligne)
            var r2 = await authenticatedFetch(
                SUPABASE_URL + '/rest/v1/public_quote_tokens?submission_id=eq.' + submissionId +
                '&accepted_at=not.is.null&limit=1&select=id',
                {}
            );
            if (r2.ok) {
                var rows2 = await r2.json();
                if (rows2.length > 0) return true;
            }
        } catch (e) { /* fail open — le trigger BD protégera */ }
        return false;
    }

    // ═══════════════════════════════════════════════════════════════════════
    // REVIEWS — CRUD SUPABASE
    // ═══════════════════════════════════════════════════════════════════════

    async function createSubmissionReview(submissionId, action, comment) {
        const userId = localStorage.getItem('sb_user_id');
        var versionAt = currentSubmission ? currentSubmission.current_version : null;
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/submission_reviews', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
            body: JSON.stringify({
                submission_id: submissionId,
                reviewer_id: userId,
                action: action,
                comment: comment || '',
                version_at_review: versionAt
            })
        });
        if (!r.ok) {
            var errText = await r.text().catch(function() { return ''; });
            console.error('createSubmissionReview failed:', r.status, errText);
            throw new Error('Erreur review: ' + r.status + ' ' + errText);
        }
        return (await r.json())[0];
    }

    // ═══════════════════════════════════════════════════════════════════════
    // TIMELINE DRAWER — HISTORIQUE SOUMISSION
    // ═══════════════════════════════════════════════════════════════════════

    var timelineReviews = [];

    async function loadSubmissionReviews(submissionId) {
        var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/submission_reviews?submission_id=eq.' + submissionId + '&order=created_at.asc&select=*', {});
        if (!r.ok) { timelineReviews = []; return; }
        timelineReviews = await r.json();
        renderTimelineDrawer();
        // Show button if there are reviews (now in kebab menu, always visible)
        var btn = document.getElementById('btnTimeline');
        if (btn) btn.style.display = '';
    }

    function renderTimelineDrawer() {
        var body = document.getElementById('timelineBody');
        if (timelineReviews.length === 0) {
            body.innerHTML = '<div class="timeline-empty">Aucun historique pour cette soumission.</div>';
            return;
        }

        var actionLabels = {
            'submitted': 'Soumis pour approbation',
            'approved': 'Approuv\u00e9',
            'returned': 'Retourn\u00e9',
            'sent': 'Envoy\u00e9 au client',
            'bypass': 'Bypass approbation',
            'offline_accepted': 'Vente confirmée (hors-ligne)',
            'duplicated': 'Soumission dupliquée',
            'unlocked': 'DÉVERROUILLÉ'
        };

        var html = '';
        timelineReviews.forEach(function(rev) {
            var action = rev.action || 'submitted';
            var label = actionLabels[action] || action;
            var date = rev.created_at ? new Date(rev.created_at) : null;
            var dateStr = date ? date.toLocaleDateString('fr-CA', { year: 'numeric', month: 'short', day: 'numeric' }) + ' \u00e0 ' + date.toLocaleTimeString('fr-CA', { hour: '2-digit', minute: '2-digit' }) : '';
            var version = rev.version_at_review ? 'V' + rev.version_at_review : '';

            html += '<div class="timeline-entry">';
            html += '<div class="timeline-dot timeline-dot-' + action + '"></div>';
            html += '<div class="timeline-entry-header">';
            html += '<span class="timeline-action timeline-action-' + action + '">' + label + '</span>';
            if (version) html += '<span class="timeline-version">' + version + '</span>';
            html += '</div>';
            html += '<div class="timeline-date">' + dateStr + '</div>';
            if (rev.comment) {
                html += '<div class="timeline-comment timeline-comment-' + action + '">' + escapeHtml(rev.comment) + '</div>';
            }
            html += '</div>';
        });

        body.innerHTML = html;
    }

    function openTimelineDrawer() {
        document.getElementById('timelineOverlay').classList.add('active');
        document.getElementById('timelineDrawer').classList.add('active');
    }

    function closeTimelineDrawer() {
        document.getElementById('timelineOverlay').classList.remove('active');
        document.getElementById('timelineDrawer').classList.remove('active');
    }

    // ═══════════════════════════════════════════════════════════════════════
    // AI ASSISTANT — DRAWER & MESSAGING
    // ═══════════════════════════════════════════════════════════════════════

    var aiConversation = [];      // { role, content } for API
    var aiPendingImages = [];     // base64 images waiting to send
    var aiCurrentScope = 'project';
    var aiChatLoaded = false;     // whether we loaded from DB for this submission
    var aiScopeObserver = null;
    var _aiScopeDebounceTimer = null;

    function openAiDrawer() {
        document.getElementById('aiOverlay').classList.add('active');
        document.getElementById('aiDrawer').classList.add('active');
        document.getElementById('btnAiAssistant').classList.add('active');
        updateAiScope();
        if (!aiChatLoaded && currentSubmission) {
            aiChatLoaded = true;
            loadAiChat(currentSubmission.id);
        }
        setTimeout(function() {
            var inp = document.getElementById('aiInput');
            if (inp) inp.focus({ preventScroll: true });
        }, 300);
    }

    function closeAiDrawer() {
        document.getElementById('aiOverlay').classList.remove('active');
        document.getElementById('aiDrawer').classList.remove('active');
        document.getElementById('btnAiAssistant').classList.remove('active');
    }

    function updateAiScope() {
        var badge = document.getElementById('aiScopeBadge');
        if (!badge) return;
        if (aiCurrentScope === 'room' && aiFocusGroupId) {
            var nameInput = document.getElementById(aiFocusGroupId + '-name');
            var roomName = nameInput ? nameInput.value.trim() : '';
            badge.textContent = roomName ? roomName : 'Pièce';
            badge.title = 'AI ciblée sur: ' + (roomName || 'pièce sélectionnée');
        } else {
            badge.textContent = 'Projet';
            badge.title = 'AI analyse le projet entier';
        }
    }

    function toggleAiFocus(groupId) {
        // Deselect all focus buttons
        document.querySelectorAll('.btn-ai-focus.active').forEach(function(btn) { btn.classList.remove('active'); });

        if (aiFocusGroupId === groupId) {
            // Toggle off — back to project scope
            aiFocusGroupId = null;
            aiCurrentScope = 'project';
        } else {
            // Focus on this room and open the AI drawer
            aiFocusGroupId = groupId;
            aiCurrentScope = 'room';
            var btn = document.getElementById(groupId + '-aiFocus');
            if (btn) btn.classList.add('active');
            openAiDrawer();
        }
        updateAiScope();
    }

    function setAiScopeFromScroll(groupId) {
        // groupId = null means project scope, otherwise room scope
        if (groupId === aiFocusGroupId) return; // no change

        // Update focus buttons
        document.querySelectorAll('.btn-ai-focus.active').forEach(function(btn) { btn.classList.remove('active'); });

        if (groupId) {
            aiFocusGroupId = groupId;
            aiCurrentScope = 'room';
            var btn = document.getElementById(groupId + '-aiFocus');
            if (btn) btn.classList.add('active');
        } else {
            aiFocusGroupId = null;
            aiCurrentScope = 'project';
        }

        updateAiScope();

        // Flash the badge
        var badge = document.getElementById('aiScopeBadge');
        if (badge) {
            badge.classList.remove('flash');
            void badge.offsetWidth;
            badge.classList.add('flash');
        }
    }

    function initAiScopeObserver() {
        if (aiScopeObserver) return;
        var visibleHeaders = new Set();
        aiScopeObserver = new IntersectionObserver(function(entries) {
            entries.forEach(function(entry) {
                var group = entry.target.closest('.furniture-group');
                if (!group) return;
                if (entry.isIntersecting) {
                    visibleHeaders.add(group.id);
                } else {
                    visibleHeaders.delete(group.id);
                }
            });
            clearTimeout(_aiScopeDebounceTimer);
            _aiScopeDebounceTimer = setTimeout(function() {
                if (visibleHeaders.size === 0) {
                    setAiScopeFromScroll(null);
                } else {
                    // Pick the first visible header in DOM order
                    var allGroups = document.querySelectorAll('#calculatorView .furniture-group');
                    for (var i = 0; i < allGroups.length; i++) {
                        if (visibleHeaders.has(allGroups[i].id)) {
                            setAiScopeFromScroll(allGroups[i].id);
                            break;
                        }
                    }
                }
            }, 300);
        }, { rootMargin: '-40% 0px -55% 0px', threshold: 0 });
    }

    // ── Render un message dans le chat ──
    function appendAiMessage(role, content, opts) {
        opts = opts || {};
        var container = document.getElementById('aiMessages');
        var div = document.createElement('div');

        if (role === 'action') {
            div.className = 'ai-msg ai-msg-action';
            div.innerHTML = '<div class="ai-action-label">Action propos\u00e9e</div>' + escapeHtml(content);
            container.appendChild(div);
        } else if (role === 'confirm') {
            div.className = 'ai-msg ai-msg-confirm';
            var confirmId = 'ai-confirm-' + Date.now();
            div.id = confirmId;
            div.innerHTML = '<div class="ai-confirm-text">' + renderAiMarkdown(content) + '</div>' +
                '<div class="ai-confirm-actions">' +
                '<button class="btn-ai-apply" onclick="aiApplyPending(\'' + confirmId + '\')">Appliquer</button>' +
                '<button class="btn-ai-dismiss" onclick="aiDismissPending(\'' + confirmId + '\')">Ignorer</button>' +
                '</div>';
            container.appendChild(div);
        } else {
            div.className = 'ai-msg ai-msg-' + role;
            if (role === 'user' && opts.images && opts.images.length > 0) {
                var imgHtml = opts.images.map(function(src) {
                    return '<img src="' + src + '" style="max-width:100%;border-radius:8px;margin-bottom:6px;">';
                }).join('');
                div.innerHTML = imgHtml + renderAiMarkdown(content);
            } else {
                div.innerHTML = renderAiMarkdown(content);
            }
            container.appendChild(div);
        }

        // Auto scroll — only if user is near the bottom (not scrolled up to read history)
        var isNearBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 80;
        if (isNearBottom) container.scrollTop = container.scrollHeight;
    }

    // ── Markdown minimal : gras, italique, listes, code, tableaux ──
    function renderAiMarkdown(text) {
        if (!text) return '';
        var s = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        // Code blocks
        s = s.replace(/```([\s\S]*?)```/g, '<pre>$1</pre>');
        // Inline code
        s = s.replace(/`([^`]+)`/g, '<code>$1</code>');
        // Bold
        s = s.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        // Italic
        s = s.replace(/\*(.+?)\*/g, '<em>$1</em>');
        // Tables → cards (with stagger animation)
        s = s.replace(/((?:\|.*\|\n?)+)/g, function(table) {
            var rows = table.trim().split('\n').filter(function(r) { return r.trim() && !/^\|[\s\-:]+\|$/.test(r); });
            if (rows.length === 0) return table;
            // Parse header to find column indices
            var headers = rows[0].split('|').filter(function(c) { return c.trim() !== ''; }).map(function(c) { return c.trim().toLowerCase(); });
            // Try to detect code/description/price columns
            var codeIdx = -1, descIdx = -1, priceIdx = -1;
            headers.forEach(function(h, i) {
                var hl = h.toLowerCase();
                if (codeIdx < 0 && (hl === 'code' || hl === 'id' || hl.indexOf('code') >= 0)) codeIdx = i;
                if (descIdx < 0 && (hl === 'description' || hl.indexOf('desc') >= 0 || hl === 'article' || hl === 'nom')) descIdx = i;
                if (priceIdx < 0 && (hl === 'prix' || hl === 'price' || hl.indexOf('prix') >= 0 || hl.indexOf('total') >= 0 || hl === 'montant')) priceIdx = i;
            });
            // If we can identify card structure (at least desc), use cards
            if (descIdx >= 0 && rows.length > 1) {
                var cards = '';
                for (var ri = 1; ri < rows.length; ri++) {
                    var cells = rows[ri].split('|').filter(function(c) { return c.trim() !== ''; }).map(function(c) { return c.trim(); });
                    var code = codeIdx >= 0 && cells[codeIdx] ? cells[codeIdx] : '';
                    var desc = cells[descIdx] || '';
                    var price = priceIdx >= 0 && cells[priceIdx] ? cells[priceIdx] : '';
                    // Collect remaining columns as meta
                    var meta = [];
                    headers.forEach(function(h, i) {
                        if (i !== codeIdx && i !== descIdx && i !== priceIdx && cells[i] && cells[i].trim()) {
                            meta.push(h.charAt(0).toUpperCase() + h.slice(1) + ': ' + cells[i]);
                        }
                    });
                    var delay = (ri - 1) * 40;
                    cards += '<div class="ai-card" style="animation-delay:' + delay + 'ms">';
                    if (code || price) {
                        cards += '<div class="ai-card-row">';
                        cards += code ? '<span class="ai-card-code">' + code + '</span>' : '<span></span>';
                        cards += price ? '<span class="ai-card-price">' + price + '</span>' : '';
                        cards += '</div>';
                    }
                    if (desc) cards += '<div class="ai-card-desc">' + desc + '</div>';
                    if (meta.length) cards += '<div class="ai-card-meta">' + meta.join(' &middot; ') + '</div>';
                    cards += '</div>';
                }
                return '<div class="ai-card-stack">' + cards + '</div>';
            }
            // Fallback: soft-styled table
            var html = '<table>';
            rows.forEach(function(row, i) {
                var cells = row.split('|').filter(function(c) { return c.trim() !== ''; });
                var tag = i === 0 ? 'th' : 'td';
                html += '<tr>' + cells.map(function(c) { return '<' + tag + '>' + c.trim() + '</' + tag + '>'; }).join('') + '</tr>';
            });
            html += '</table>';
            return html;
        });
        // Unordered lists
        s = s.replace(/^[•\-\*] (.+)$/gm, '<li>$1</li>');
        s = s.replace(/((?:<li>.*<\/li>\n?)+)/g, '<ul>$1</ul>');
        // Paragraphs
        s = s.replace(/\n{2,}/g, '</p><p>');
        s = s.replace(/\n/g, '<br>');
        s = '<p>' + s + '</p>';
        s = s.replace(/<p><\/p>/g, '');
        return s;
    }

    function showAiTyping() { document.getElementById('aiTyping').classList.add('active'); }
    function hideAiTyping() { document.getElementById('aiTyping').classList.remove('active'); }

    function aiInputKeydown(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendAiMessage();
        }
    }

    function aiQuickAction(text) {
        document.getElementById('aiInput').value = text;
        sendAiMessage();
    }

    // ── Auto-resize textarea ──
    (function() {
        document.addEventListener('input', function(e) {
            if (e.target.id === 'aiInput') {
                e.target.style.height = 'auto';
                e.target.style.height = Math.min(e.target.scrollHeight, 120) + 'px';
            }
        });
    })();

    // ── Image paste & drag-drop ──
    function setupAiImageHandlers() {
        var input = document.getElementById('aiInput');
        var dropZone = document.getElementById('aiDropZone');
        var drawer = document.getElementById('aiDrawer');

        if (input) {
            input.addEventListener('paste', function(e) {
                var items = (e.clipboardData || {}).items || [];
                for (var i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        e.preventDefault();
                        var file = items[i].getAsFile();
                        aiProcessImage(file);
                        break;
                    }
                }
            });
        }

        if (drawer) {
            drawer.addEventListener('dragover', function(e) {
                e.preventDefault();
                dropZone.classList.add('active');
            });
            drawer.addEventListener('dragleave', function(e) {
                if (!drawer.contains(e.relatedTarget)) dropZone.classList.remove('active');
            });
            drawer.addEventListener('drop', function(e) {
                e.preventDefault();
                dropZone.classList.remove('active');
                var files = e.dataTransfer.files;
                for (var i = 0; i < files.length; i++) {
                    if (files[i].type.indexOf('image') !== -1) {
                        aiProcessImage(files[i]);
                    }
                }
            });
        }
    }

    function aiProcessImage(file) {
        var reader = new FileReader();
        reader.onload = function(e) {
            // Compress via canvas
            var img = new Image();
            img.onload = function() {
                var canvas = document.createElement('canvas');
                var maxDim = 1200;
                var w = img.width, h = img.height;
                if (w > maxDim || h > maxDim) {
                    if (w > h) { h = Math.round(h * maxDim / w); w = maxDim; }
                    else { w = Math.round(w * maxDim / h); h = maxDim; }
                }
                canvas.width = w; canvas.height = h;
                canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                var dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                aiPendingImages.push(dataUrl);
                renderAiImagePreviews();
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    function renderAiImagePreviews() {
        var container = document.getElementById('aiImgPreview');
        container.innerHTML = '';
        aiPendingImages.forEach(function(src, i) {
            var div = document.createElement('div');
            div.className = 'ai-img-thumb';
            div.innerHTML = '<img src="' + src + '"><button class="ai-img-remove" onclick="aiRemoveImage(' + i + ')">&times;</button>';
            container.appendChild(div);
        });
    }

    function aiRemoveImage(index) {
        aiPendingImages.splice(index, 1);
        renderAiImagePreviews();
    }

    // ── Reset chat when switching submissions ──
    function resetAiChat() {
        aiConversation = [];
        aiPendingImages = [];
        aiChatLoaded = false;
        aiClientFileCache = null;
        aiFocusGroupId = null;
        aiCurrentScope = 'project';
        var container = document.getElementById('aiMessages');
        if (container) container.innerHTML = '';
        var preview = document.getElementById('aiImgPreview');
        if (preview) preview.innerHTML = '';
    }

    // ── Collect AI context from current calculator state ──
    var aiClientFileCache = null;

    function collectRoomsSummary() {
        var rooms = [];
        document.querySelectorAll('#calculatorView .furniture-group').forEach(function(group) {
            var gid = group.id;
            var nameEl = group.querySelector('.furniture-name-input');
            var name = nameEl ? (nameEl.value.trim() || 'Sans nom') : 'Sans nom';
            var rows = group.querySelectorAll('.calc-row');
            var itemCount = 0;
            var subtotal = 0;
            rows.forEach(function(row) {
                var sel = row.querySelector('.item-select');
                if (sel && sel.value) { itemCount++; subtotal += getRowTotal(row); }
            });
            var descEl = document.getElementById(gid + '-clientDesc');
            var installCb = document.getElementById(gid + '-install');
            var roomPct = roomModifiers[gid] || 0;
            var globalPct = (currentSubmission && currentSubmission.global_price_modifier_pct) || 0;
            var effectiveTotal = getEffectiveRoomTotal(gid);
            rooms.push({
                groupId: gid,
                roomId: roomMap[gid] || null,
                name: name,
                itemCount: itemCount,
                subtotal: Math.round(subtotal * 100) / 100,
                roomModifierPct: roomPct,
                globalModifierPct: globalPct,
                effectiveTotal: effectiveTotal,
                hasDescription: !!(descEl && descEl.value.trim()),
                installationIncluded: installCb ? installCb.checked : true,
                defaultMaterials: roomDM[gid] || []
            });
        });
        return rooms;
    }

    function collectRowDims(row) {
        var rowId = row.id;
        var lEl = document.getElementById(rowId + '-dim-l');
        if (!lEl) return null;
        var l = parseFloat(lEl.value) || 0;
        var h = parseFloat(document.getElementById(rowId + '-dim-h').value) || 0;
        var p = parseFloat(document.getElementById(rowId + '-dim-p').value) || 0;
        if (!l && !h && !p) return null;
        return { l: l, h: h, p: p };
    }

    function collectRoomDetail(groupId) {
        var group = document.getElementById(groupId);
        if (!group) return null;
        var nameEl = group.querySelector('.furniture-name-input');
        var name = nameEl ? (nameEl.value.trim() || 'Sans nom') : 'Sans nom';
        var descEl = document.getElementById(groupId + '-clientDesc');
        var installCb = document.getElementById(groupId + '-install');
        var includeInstall = installCb ? installCb.checked : true;

        var items = [];
        var subtotal = 0;
        group.querySelectorAll('.calc-row').forEach(function(row, idx) {
            var sel = row.querySelector('.item-select');
            var qtyInput = row.querySelector('.qty-input');
            if (!sel || !sel.value) return;
            var qty = parseFloat(qtyInput.value) || 0;
            var selectedId = sel.value;
            var tagInput = row.querySelector('.cell-tag input');
            var tag = tagInput ? tagInput.value.trim() : '';
            if (selectedId === '__AJOUT__') {
                var cdCtx = _customItemDataMap[row.id] || {};
                var ajP = cdCtx.unit_price || 0;
                var ajM = cdCtx.markup || 0;
                var lt = ajP * qty * (1 + ajM / 100);
                var ajoutDims = collectRowDims(row);
                var ajSupplier = (cdCtx.custom_data && cdCtx.custom_data.supplier_name) || '';
                items.push({ index: idx, tag: tag || null, type: 'ajout', description: cdCtx.description || '', unitPrice: ajP, qty: qty, markup: ajM, lineTotal: Math.round(lt * 100) / 100, dims: ajoutDims, supplier: ajSupplier });
                subtotal += lt;
            } else if (selectedId !== '__PROPOSER__') {
                var item = CATALOGUE_DATA.find(function(i) { return i.id === selectedId; });
                if (item) {
                    var composed = computeComposedPrice(item, includeInstall);
                    var effPrice = composed !== null ? composed : (item.price || 0);
                    var lt2 = effPrice * qty;
                    subtotal += lt2;
                    var catDims = collectRowDims(row);
                    items.push({
                        index: idx, tag: tag || null, type: 'catalogue', catalogueId: item.id,
                        description: item.description, itemType: item.type,
                        unitPrice: Math.round(effPrice * 100) / 100, qty: qty,
                        lineTotal: Math.round(lt2 * 100) / 100,
                        laborMinutes: item.labor_minutes || {},
                        materialCosts: item.material_costs || {},
                        dims: catDims
                    });
                }
            }
        });

        // Compute rentability inline (same logic as openRentab but returns data)
        var rentab = computeRentabilityData('room', groupId);

        return {
            groupId: groupId,
            roomId: roomMap[groupId] || null,
            name: name,
            installationIncluded: includeInstall,
            clientDescription: descEl ? descEl.value.trim() : '',
            defaultMaterials: roomDM[groupId] || [],
            items: items,
            subtotal: Math.round(subtotal * 100) / 100,
            rentability: rentab
        };
    }

    function computeRentabilityData(scope, groupId) {
        var rows;
        if (scope === 'project') {
            rows = document.querySelectorAll('.calc-row');
        } else {
            rows = document.querySelectorAll('#' + groupId + '-rows .calc-row');
        }
        if (!rows || rows.length === 0) return null;

        var deptMinutes = {};
        var totalMatCoutant = 0, totalMatMarkup = 0, totalMatWaste = 0;
        var totalHeuresCharge = 0, totalSalaires = 0, totalFraisFixes = 0, totalProfitMO = 0;
        var totalPrixVente = 0;
        var totalAjout = 0;

        tauxHoraires.forEach(function(t) { deptMinutes[t.department] = 0; });

        rows.forEach(function(row) {
            var select = row.querySelector('.item-select');
            var qtyInput = row.querySelector('.qty-input');
            if (!select || !qtyInput) return;
            var selectedId = select.value;
            var qty = parseFloat(qtyInput.value) || 0;
            if (!selectedId || selectedId === '__PROPOSER__') return;
            if (selectedId === '__AJOUT__') {
                var ajt = getRowTotal(row);
                totalPrixVente += ajt;
                totalAjout += ajt;
                return;
            }
            var item = CATALOGUE_DATA.find(function(i) { return i.id === selectedId; });
            if (!item) return;
            var installCb = document.getElementById(row.id + '-install');
            var includeInstall = installCb ? installCb.checked : true;
            var laborMinutes = item.labor_minutes || {};
            var materialCosts = item.material_costs || {};

            tauxHoraires.forEach(function(t) {
                var dept = t.department;
                var mins = (laborMinutes[dept] || 0) * qty;
                if (!includeInstall && dept === 'Installation') return;
                deptMinutes[dept] = (deptMinutes[dept] || 0) + mins;
                var hours = mins / 60;
                totalHeuresCharge += hours * (t.taux_horaire || 0);
                totalSalaires += hours * (t.salaire || 0);
                totalFraisFixes += hours * (t.frais_fixe || 0);
                totalProfitMO += hours * ((t.taux_horaire || 0) - (t.salaire || 0) - (t.frais_fixe || 0));
            });

            expenseCategories.forEach(function(c) {
                var cost = (materialCosts[c.name] || 0) * qty;
                totalMatCoutant += cost;
                totalMatMarkup += cost * ((c.markup || 0) / 100);
                var wasteRate = item.loss_override_pct != null ? item.loss_override_pct : (c.waste || 0);
                totalMatWaste += cost * (wasteRate / 100);
            });

            // Fallback: si pas de données composées, utiliser item.price
            var composedPrice = computeComposedPrice(item, includeInstall);
            if (composedPrice === null) {
                totalPrixVente += (item.price || 0) * qty;
            }
        });

        totalPrixVente += totalHeuresCharge + totalMatCoutant + totalMatWaste + totalMatMarkup;
        var profitNet = totalProfitMO + totalMatMarkup;
        var prixVenteSansAjout = totalPrixVente - totalAjout;
        var margeReelle = prixVenteSansAjout > 0 ? (profitNet / prixVenteSansAjout * 100) : 0;
        var profitNetAvecAjout = profitNet + totalAjout;
        var margeAvecAjout = totalPrixVente > 0 ? (profitNetAvecAjout / totalPrixVente * 100) : 0;

        return {
            prixVente: Math.round(totalPrixVente * 100) / 100,
            coutMateriaux: Math.round(totalMatCoutant * 100) / 100,
            perteMateriaux: Math.round(totalMatWaste * 100) / 100,
            markupMateriaux: Math.round(totalMatMarkup * 100) / 100,
            heuresCharge: Math.round(totalHeuresCharge * 100) / 100,
            salaires: Math.round(totalSalaires * 100) / 100,
            fraisFixes: Math.round(totalFraisFixes * 100) / 100,
            profitMO: Math.round(totalProfitMO * 100) / 100,
            profitNet: Math.round(profitNetAvecAjout * 100) / 100,
            ajouts: Math.round(totalAjout * 100) / 100,
            margeReelle: Math.round(margeReelle * 10) / 10,
            margeAvecAjout: Math.round(margeAvecAjout * 10) / 10,
            margeVisee: 38,
            heuresParDept: deptMinutes
        };
    }

    function buildCatalogueSummary() {
        if (!CATALOGUE_DATA || CATALOGUE_DATA.length === 0) return '';
        var cats = {};
        CATALOGUE_DATA.forEach(function(item) {
            if (!item.in_calculator) return;
            var cat = item.category || 'Autre';
            if (!cats[cat]) cats[cat] = [];
            var typeTag = item.item_type === 'fabrication' ? '[Fab] ' : item.item_type === 'materiau' ? '[Mat] ' : '';
            var line = (item.is_default ? '\u2605 ' : '') + typeTag + item.id + ': ' + (item.description || '').substring(0, 60) + ' (' + (item.type || '') + ' ' + (item.price || 0) + '$)';
            if (item.client_text) line += ' \u2192 client: "' + item.client_text + '"';
            cats[cat].push(line);
        });
        var lines = [];
        Object.keys(cats).forEach(function(cat) {
            lines.push('### ' + cat);
            cats[cat].forEach(function(line) { lines.push('- ' + line); });
        });
        return lines.join('\n');
    }

    async function loadClientFile() {
        if (aiClientFileCache) return aiClientFileCache;
        if (!currentProject || !currentProject.client_name) return null;
        try {
            var clientName = currentProject.client_name.trim();
            // Search contacts by name match
            var parts = clientName.split(' ');
            var firstName = parts[0] || '';
            var lastName = parts.slice(1).join(' ') || '';
            var query = SUPABASE_URL + '/rest/v1/contacts?select=*,contact_companies(role,companies(name,notes))';
            if (lastName) {
                query += '&first_name=ilike.' + encodeURIComponent(firstName + '%') + '&last_name=ilike.' + encodeURIComponent(lastName + '%');
            } else {
                query += '&or=(first_name.ilike.' + encodeURIComponent('%' + firstName + '%') + ',last_name.ilike.' + encodeURIComponent('%' + firstName + '%') + ')';
            }
            var r = await authenticatedFetch(query, {});
            if (!r.ok) return null;
            var contacts = await r.json();
            if (contacts.length === 0) return null;
            var c = contacts[0];
            var companies = (c.contact_companies || []).map(function(cc) {
                return cc.companies ? cc.companies.name : null;
            }).filter(Boolean);
            var companyNotes = (c.contact_companies || []).map(function(cc) {
                return cc.companies && cc.companies.notes ? cc.companies.notes : null;
            }).filter(Boolean);

            // Load recent communications
            var commR = await authenticatedFetch(SUPABASE_URL + '/rest/v1/communications?contact_id=eq.' + c.id + '&order=comm_date.desc&limit=5&select=comm_type,direction,subject,content,comm_date', {});
            var comms = commR.ok ? await commR.json() : [];
            var commStr = comms.map(function(cm) {
                return (cm.direction === 'outgoing' ? '→' : '←') + ' ' + (cm.comm_type || '') + ': ' + (cm.subject || cm.content || '').substring(0, 100);
            }).join('\n');

            aiClientFileCache = {
                name: c.first_name + ' ' + c.last_name,
                email: c.email || '',
                phone: c.phone || '',
                company: companies.join(', '),
                notes: c.notes || '',
                preferences: c.preferred_contact || '',
                companyNotes: companyNotes.join('; '),
                history: commStr || 'Aucune communication récente'
            };
            return aiClientFileCache;
        } catch (e) {
            console.warn('[AI] Could not load client file:', e);
            return null;
        }
    }

    async function collectAiContext() {
        var clientFile = await loadClientFile();

        // Load benchmarks from app_config if not already cached
        var benchmarks = null;
        try {
            var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/app_config?key=eq.ai_benchmarks&select=value', {});
            if (r.ok) {
                var rows = await r.json();
                if (rows.length > 0) benchmarks = rows[0].value;
            }
        } catch (e) { /* ignore */ }

        return {
            project: currentProject ? {
                name: currentProject.name,
                client: currentProject.client_name,
                designer: currentProject.designer,
                address: currentProject.client_address
            } : null,
            submission: currentSubmission ? {
                id: currentSubmission.id,
                number: currentSubmission.submission_number,
                status: currentSubmission.status,
                title: currentSubmission.title,
                discount_type: currentSubmission.discount_type || null,
                discount_value: currentSubmission.discount_value || null,
                global_price_modifier_pct: currentSubmission.global_price_modifier_pct || null
            } : null,
            rooms: collectRoomsSummary(),
            focusRoomDetail: aiCurrentScope === 'room' && aiFocusGroupId ? collectRoomDetail(aiFocusGroupId) : null,
            tauxHoraires: tauxHoraires,
            expenseCategories: expenseCategories,
            grandTotal: calculerGrandTotal(),
            subtotalBeforeDiscount: calculerSubtotalBeforeDiscount(),
            catalogueSummary: buildCatalogueSummary(),
            clientFile: clientFile,
            benchmarks: benchmarks,
            defaultMaterials: getDefaultMaterials(),
            tagPrefixes: tagPrefixes,
            aiReferenceImageUrls: collectAiReferenceImageUrls(),
            calculationRules: (CATALOGUE_DATA || [])
                .filter(function(item) { return item.calculation_rule_ai; })
                .map(function(item) { return { id: item.id, description: item.description, type: item.type, rule: item.calculation_rule_ai }; })
        };
    }

    function collectAiReferenceImageUrls() {
        var urls = [];
        var groups = document.querySelectorAll('#calculatorView .furniture-group');
        groups.forEach(function(group) {
            var gid = group.id;
            var nameEl = group.querySelector('.furniture-name-input');
            var roomName = nameEl ? nameEl.value.trim() : 'Sans nom';
            (groupImages[gid] || []).forEach(function(img) {
                if (img.aiReference && (img.url || img.dataUrl)) {
                    urls.push({ url: img.url || img.dataUrl, room: roomName });
                }
            });
        });
        return urls;
    }

    var aiFocusGroupId = null;

    // ── Call AI Edge Function ──
    var _aiRetried401 = false;
    async function callAiAssistant(messages, context) {
        var resp = await authenticatedFetch(SUPABASE_URL + '/functions/v1/ai-assistant', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ messages: messages, context: context })
        });
        if (!resp.ok) {
            var errText = await resp.text().catch(function() { return ''; });
            // Auto-retry on 401 auth error (force token refresh + one more try)
            if (resp.status === 401 && !_aiRetried401) {
                _aiRetried401 = true;
                if (await refreshAccessToken()) {
                    var result = await callAiAssistant(messages, context);
                    _aiRetried401 = false;
                    return result;
                }
                throw new Error('Session expirée — veuillez vous reconnecter');
            }
            _aiRetried401 = false;
            try {
                var errObj = JSON.parse(errText);
                throw new Error(errObj.error || errObj.msg || errObj.message || 'Erreur ' + resp.status);
            } catch(e) { if (e.message) throw e; throw new Error('Erreur ' + resp.status); }
        }
        var data = await resp.json();
        return data;
    }

    // ── Build API message content (text + images) ──
    function buildUserContent(text, images) {
        if (!images || images.length === 0) return text;
        // Multi-modal: array of content blocks
        var content = [];
        images.forEach(function(dataUrl) {
            var match = dataUrl.match(/^data:(.*?);base64,(.*)$/);
            if (match) {
                content.push({
                    type: 'image',
                    source: { type: 'base64', media_type: match[1], data: match[2] }
                });
            }
        });
        if (text) content.push({ type: 'text', text: text });
        return content;
    }

    // ── Main send function ──
    var aiPendingToolCalls = null; // stores pending tool_use blocks for confirmation

    async function sendAiMessage() {
        var input = document.getElementById('aiInput');
        var text = input.value.trim();
        if (!text && aiPendingImages.length === 0) return;

        var images = aiPendingImages.slice();
        aiPendingImages = [];
        renderAiImagePreviews();
        input.value = '';
        input.style.height = 'auto';

        appendAiMessage('user', text || '(image)', { images: images });

        // Build the user message for API (user images + AI reference images)
        var userContent = buildUserContent(text, images);

        // Include AI reference images from rooms (as URL sources)
        var refImgs = collectAiReferenceImageUrls();
        if (refImgs.length > 0) {
            // Convert to array format if it's just text
            if (typeof userContent === 'string') {
                userContent = [{ type: 'text', text: userContent }];
            }
            refImgs.forEach(function(ref) {
                if (ref.url && !ref.url.startsWith('data:')) {
                    userContent.unshift({
                        type: 'image',
                        source: { type: 'url', url: ref.url }
                    });
                }
            });
            // Add context about which rooms the images are from
            var refLabel = refImgs.map(function(r) { return r.room; }).join(', ');
            userContent.push({ type: 'text', text: '[Images de référence des pièces: ' + refLabel + ']' });
        }

        aiConversation.push({ role: 'user', content: userContent });

        // Save user message to DB
        saveAiChatMessage('user', text, images);

        showAiTyping();
        document.getElementById('aiSendBtn').disabled = true;

        try {
            var context = await collectAiContext();
            var data = await callAiAssistant(aiConversation, context);

            // Process response blocks
            var contentBlocks = data.content || [];
            var textParts = [];
            var toolCalls = [];

            contentBlocks.forEach(function(block) {
                if (block.type === 'text') textParts.push(block.text);
                if (block.type === 'tool_use') toolCalls.push(block);
            });

            // Add assistant response to conversation
            aiConversation.push({ role: 'assistant', content: contentBlocks });

            if (toolCalls.length > 0) {
                // Mode simulation: show text + confirm buttons, don't execute tools yet
                var fullText = textParts.join('\n');
                if (fullText) appendAiMessage('assistant', fullText);

                // Store pending tool calls
                aiPendingToolCalls = { tools: toolCalls, conversationSnapshot: aiConversation.length };
                appendAiMessage('confirm', formatPendingActions(toolCalls));

                saveAiChatMessage('assistant', fullText + '\n[Actions proposées - en attente de confirmation]', []);
            } else {
                // Pure text response
                var fullText = textParts.join('\n');
                appendAiMessage('assistant', fullText);
                saveAiChatMessage('assistant', fullText, []);
            }
        } catch (err) {
            appendAiMessage('assistant', 'Erreur : ' + err.message);
        } finally {
            hideAiTyping();
            document.getElementById('aiSendBtn').disabled = false;
            maybeAutoSummarize(); // async, fire-and-forget
        }
    }

    function formatPendingActions(toolCalls) {
        return toolCalls.map(function(tc) {
            switch (tc.name) {
                case 'write_description':
                    return 'Écrire la description de **' + (tc.input.room_name || '?') + '**';
                case 'add_catalogue_item':
                    return 'Ajouter **' + (tc.input.catalogue_item_id || '?') + '** × ' + (tc.input.quantity || 1) + ' à **' + (tc.input.room_name || '?') + '**';
                case 'update_item_quantity':
                    return 'Modifier quantité ligne ' + tc.input.item_index + ' → ' + tc.input.new_quantity + ' dans **' + (tc.input.room_name || '?') + '**';
                case 'analyze_rentability':
                    return 'Analyser la rentabilité (' + (tc.input.scope || 'projet') + ')';
                case 'suggest_items':
                    return 'Rechercher articles : ' + (tc.input.query || '?');
                case 'compare_versions':
                    return 'Comparer versions ' + tc.input.version_a + ' et ' + tc.input.version_b;
                default:
                    return tc.name + ': ' + JSON.stringify(tc.input);
            }
        }).join('\n');
    }

    // ── Apply / dismiss pending tool actions ──
    async function aiApplyPending(confirmId) {
        var el = document.getElementById(confirmId);
        if (!el || !aiPendingToolCalls) return;
        el.querySelector('.ai-confirm-actions').innerHTML = '<span class="ai-confirm-applied">Application en cours...</span>';

        try {
            var toolResults = [];
            var addItemIndex = 0;
            for (var i = 0; i < aiPendingToolCalls.tools.length; i++) {
                var tc = aiPendingToolCalls.tools[i];
                if (tc.name === 'add_catalogue_item') {
                    tc.input._staggerIndex = addItemIndex++;
                }
                var result = await executeAiTool(tc.name, tc.input);
                toolResults.push({ type: 'tool_result', tool_use_id: tc.id, content: JSON.stringify(result) });
                appendAiMessage('action', toolActionLabel(tc.name, tc.input));
            }
            // Pulse on totals after batch
            if (addItemIndex > 0) {
                setTimeout(function() { pulseTotals(); }, addItemIndex * 50 + 250);
            }

            // Continue conversation with tool results
            aiConversation.push({ role: 'user', content: toolResults });
            showAiTyping();

            var freshContext = await collectAiContext();
            var data = await callAiAssistant(aiConversation, freshContext);
            var contentBlocks = data.content || [];
            aiConversation.push({ role: 'assistant', content: contentBlocks });

            var text = contentBlocks.filter(function(b) { return b.type === 'text'; }).map(function(b) { return b.text; }).join('\n');
            if (text) {
                appendAiMessage('assistant', text);
                saveAiChatMessage('assistant', text, []);
            }

            el.querySelector('.ai-confirm-actions').innerHTML = '<span class="ai-confirm-applied">Appliqué \u2713</span>';
        } catch (err) {
            el.querySelector('.ai-confirm-actions').innerHTML = '<span style="color:#c62828;font-size:11px;">Erreur: ' + escapeHtml(err.message) + '</span>';
        } finally {
            aiPendingToolCalls = null;
            hideAiTyping();
        }
    }

    function aiDismissPending(confirmId) {
        var el = document.getElementById(confirmId);
        if (!el) return;
        el.querySelector('.ai-confirm-actions').innerHTML = '<span style="font-size:11px;color:#999;">Ignoré</span>';
        aiPendingToolCalls = null;
    }

    function toolActionLabel(name, input) {
        switch (name) {
            case 'write_description': return 'Description mise à jour : ' + (input.room_name || '');
            case 'add_catalogue_item': return 'Article ajouté : ' + (input.catalogue_item_id || '') + ' × ' + (input.quantity || 1);
            case 'update_item_quantity': return 'Quantité modifiée : ligne ' + input.item_index + ' → ' + input.new_quantity;
            case 'analyze_rentability': return 'Analyse de rentabilité effectuée';
            case 'suggest_items': return 'Recherche catalogue effectuée';
            case 'compare_versions': return 'Comparaison de versions effectuée';
            default: return name;
        }
    }

    // ── Tool execution (client-side) ──
    async function executeAiTool(name, input) {
        switch (name) {
            case 'analyze_rentability': {
                if (input.scope === 'room' && input.room_name) {
                    var gid = findGroupIdByName(input.room_name);
                    if (!gid) return { error: 'Pièce introuvable: ' + input.room_name };
                    return computeRentabilityData('room', gid);
                }
                return computeRentabilityData('project');
            }
            case 'write_description': {
                var gid = findGroupIdByName(input.room_name);
                if (!gid) return { error: 'Pièce introuvable: ' + input.room_name };
                var textarea = document.getElementById(gid + '-clientDesc');
                if (textarea) {
                    // AI sends HTML — store as HTML, show plain text in textarea
                    var descHtml = input.description_html || '';
                    roomDescHTML[gid] = descHtml;
                    textarea.value = htmlToText(descHtml);
                    roomDescEN[gid] = '';
                    if (roomMap[gid]) {
                        updateRoom(roomMap[gid], { client_description: descHtml, client_description_en: '' });
                    }
                    showSaveIndicator();
                    return { success: true, room: input.room_name };
                }
                return { error: 'Textarea introuvable' };
            }
            case 'add_catalogue_item': {
                var gid = findGroupIdByName(input.room_name);
                if (!gid) return { error: 'Pièce introuvable: ' + input.room_name };
                var rowId = addRow(gid, { staggerIndex: input._staggerIndex || 0 });
                // Wait for Supabase item creation (async in addRow) before updating
                var waitAttempts = 0;
                while (!itemMap[rowId] && waitAttempts < 50) {
                    await new Promise(function(r) { setTimeout(r, 100); });
                    waitAttempts++;
                }
                if (!itemMap[rowId]) return { error: 'Échec création ligne Supabase' };
                var select = document.querySelector('#' + rowId + ' .item-select');
                if (select) {
                    select.value = input.catalogue_item_id;
                    updateRow(rowId);
                    var qtyInput = document.getElementById(rowId + '-qty');
                    if (qtyInput && input.quantity) {
                        qtyInput.value = input.quantity;
                        updateRow(rowId);
                    }
                }
                if (input.tag) {
                    var tagInput = document.getElementById(rowId + '-tag');
                    if (tagInput) {
                        tagInput.value = input.tag.toUpperCase();
                        saveRowTag(rowId);
                    }
                }
                // Set dimensions L, H, P if provided
                if (input.length || input.height || input.depth) {
                    var dimsEl = document.getElementById(rowId + '-dims');
                    if (dimsEl) {
                        dimsEl.dataset.l = input.length || '';
                        dimsEl.dataset.h = input.height || '';
                        dimsEl.dataset.p = input.depth || '';
                    }
                    // Force updateRow to create dim inputs (it checks dims-hidden)
                    updateRow(rowId);
                    // Now set values in the created inputs
                    if (input.length) {
                        var dimL = document.getElementById(rowId + '-dim-l');
                        if (dimL) dimL.value = input.length;
                    }
                    if (input.height) {
                        var dimH = document.getElementById(rowId + '-dim-h');
                        if (dimH) dimH.value = input.height;
                    }
                    if (input.depth) {
                        var dimP = document.getElementById(rowId + '-dim-p');
                        if (dimP) dimP.value = input.depth;
                    }
                    updateRow(rowId);
                }
                updateGrandTotal();
                return { success: true, rowId: rowId, room: input.room_name, tag: input.tag || null };
            }
            case 'update_item_quantity': {
                var gid = findGroupIdByName(input.room_name);
                if (!gid) return { error: 'Pièce introuvable: ' + input.room_name };
                var rows = document.querySelectorAll('#' + gid + '-rows .calc-row');
                var targetRow = rows[input.item_index];
                if (!targetRow) return { error: 'Ligne ' + input.item_index + ' introuvable' };
                var qtyInput = targetRow.querySelector('.qty-input');
                if (qtyInput) {
                    qtyInput.value = input.new_quantity;
                    updateRow(targetRow.id);
                }
                updateGrandTotal();
                return { success: true, room: input.room_name, index: input.item_index, newQty: input.new_quantity };
            }
            case 'suggest_items': {
                var q = (input.query || '').toLowerCase();
                var results = CATALOGUE_DATA.filter(function(item) {
                    if (!item.in_calculator) return false;
                    return (item.description || '').toLowerCase().indexOf(q) !== -1 ||
                           (item.category || '').toLowerCase().indexOf(q) !== -1 ||
                           (item.id || '').toLowerCase().indexOf(q) !== -1;
                }).slice(0, 10).map(function(item) {
                    return { id: item.id, description: item.description, category: item.category, type: item.type, price: item.price };
                });
                return { results: results };
            }
            case 'compare_versions': {
                if (!currentSubmission) return { error: 'Pas de soumission courante' };
                try {
                    var rA = await authenticatedFetch(SUPABASE_URL + '/rest/v1/project_versions?submission_id=eq.' + currentSubmission.id + '&version_number=eq.' + input.version_a + '&select=snapshot', {});
                    var rB = await authenticatedFetch(SUPABASE_URL + '/rest/v1/project_versions?submission_id=eq.' + currentSubmission.id + '&version_number=eq.' + input.version_b + '&select=snapshot', {});
                    if (!rA.ok || !rB.ok) return { error: 'Versions introuvables' };
                    var dataA = await rA.json();
                    var dataB = await rB.json();
                    if (dataA.length === 0 || dataB.length === 0) return { error: 'Version(s) introuvable(s)' };
                    var snapA = dataA[0].snapshot;
                    var snapB = dataB[0].snapshot;
                    return {
                        versionA: input.version_a,
                        versionB: input.version_b,
                        totalA: snapA.total,
                        totalB: snapB.total,
                        roomCountA: (snapA.meubles || []).length,
                        roomCountB: (snapB.meubles || []).length,
                        roomsA: (snapA.meubles || []).map(function(m) { return { name: m.name, subtotal: m.subtotal, items: m.items.length }; }),
                        roomsB: (snapB.meubles || []).map(function(m) { return { name: m.name, subtotal: m.subtotal, items: m.items.length }; })
                    };
                } catch (e) { return { error: e.message }; }
            }
            default:
                return { error: 'Tool inconnu: ' + name };
        }
    }

    function findGroupIdByName(name) {
        if (!name) return null;
        var lowerName = name.toLowerCase().trim();
        var groups = document.querySelectorAll('#calculatorView .furniture-group');
        for (var i = 0; i < groups.length; i++) {
            var nameEl = groups[i].querySelector('.furniture-name-input');
            if (nameEl && nameEl.value.toLowerCase().trim() === lowerName) return groups[i].id;
        }
        // Partial match fallback
        for (var i = 0; i < groups.length; i++) {
            var nameEl = groups[i].querySelector('.furniture-name-input');
            if (nameEl && nameEl.value.toLowerCase().indexOf(lowerName) !== -1) return groups[i].id;
        }
        return null;
    }

    // ── Save / Load chat messages (Supabase) ──
    async function saveAiChatMessage(role, content, images) {
        if (!currentSubmission) return;
        try {
            await authenticatedFetch(SUPABASE_URL + '/rest/v1/chat_messages', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                body: JSON.stringify({
                    submission_id: currentSubmission.id,
                    role: role,
                    content: content || '',
                    image_urls: (images || []).length > 0 ? ['(image attachée)'] : []
                })
            });
        } catch (e) { console.warn('[AI] Failed to save chat message:', e); }
    }

    async function loadAiChat(submissionId) {
        try {
            var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/chat_messages?submission_id=eq.' + submissionId + '&order=created_at.desc&limit=20&select=role,content,created_at', {});
            if (!r.ok) return;
            var msgs = await r.json();
            if (msgs.length === 0) return;

            // Reverse to chronological order
            msgs.reverse();

            // If there's a summary, show it first
            var container = document.getElementById('aiMessages');
            container.innerHTML = '';

            msgs.forEach(function(msg) {
                if (msg.role === 'summary') {
                    var div = document.createElement('div');
                    div.className = 'ai-msg ai-msg-action';
                    div.innerHTML = '<div class="ai-action-label">Résumé de la conversation précédente</div>' + renderAiMarkdown(msg.content);
                    container.appendChild(div);
                } else {
                    appendAiMessage(msg.role, msg.content);
                }
            });

            // Rebuild aiConversation from loaded messages
            aiConversation = [];
            msgs.forEach(function(msg) {
                if (msg.role === 'summary') {
                    // Inject summary as a system-ish context at start
                    aiConversation.push({ role: 'user', content: '[Résumé conversation précédente: ' + msg.content + ']' });
                    aiConversation.push({ role: 'assistant', content: 'Compris, je continue avec ce contexte.' });
                } else if (msg.role === 'user' || msg.role === 'assistant') {
                    aiConversation.push({ role: msg.role, content: msg.content });
                }
            });
        } catch (e) { console.warn('[AI] Failed to load chat:', e); }
    }

    // ── Auto-summarize when conversation gets long ──
    async function maybeAutoSummarize() {
        if (!currentSubmission) return;
        // Count messages in DB
        try {
            var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/chat_messages?submission_id=eq.' + currentSubmission.id + '&select=id', {});
            if (!r.ok) return;
            var msgs = await r.json();
            if (msgs.length < 25) return;

            // Get the oldest messages to summarize (all except last 5)
            var r2 = await authenticatedFetch(SUPABASE_URL + '/rest/v1/chat_messages?submission_id=eq.' + currentSubmission.id + '&order=created_at.asc&limit=' + (msgs.length - 5) + '&select=id,role,content', {});
            if (!r2.ok) return;
            var oldMsgs = await r2.json();

            // Build text to summarize
            var textToSummarize = oldMsgs.map(function(m) { return m.role + ': ' + (m.content || '').substring(0, 300); }).join('\n');

            // Call AI to generate summary
            var summaryResp = await callAiAssistant([
                { role: 'user', content: 'Résume cette conversation en 3-5 points clés. Sois concis et factuel. Ne commence pas par "Voici un résumé".\n\n' + textToSummarize }
            ], { project: { name: currentProject?.name }, submission: { number: currentSubmission?.submission_number } });

            var summaryText = (summaryResp.content || []).filter(function(b) { return b.type === 'text'; }).map(function(b) { return b.text; }).join('\n');

            if (summaryText) {
                // Delete old messages
                var idsToDelete = oldMsgs.map(function(m) { return m.id; });
                await authenticatedFetch(SUPABASE_URL + '/rest/v1/chat_messages?id=in.(' + idsToDelete.join(',') + ')', { method: 'DELETE' });

                // Insert summary
                await authenticatedFetch(SUPABASE_URL + '/rest/v1/chat_messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                    body: JSON.stringify({
                        submission_id: currentSubmission.id,
                        role: 'summary',
                        content: summaryText
                    })
                });
            }
        } catch (e) { console.warn('[AI] Auto-summarize failed:', e); }
    }

    // Init image handlers after DOM ready
    document.addEventListener('DOMContentLoaded', function() {
        setupAiImageHandlers();
    });

    // ═══════════════════════════════════════════════════════════════════════
    // MATÉRIAUX PAR DÉFAUT (JSONB dans submissions.default_materials)
    // ═══════════════════════════════════════════════════════════════════════
    // Structure: [ { type: "Caisson", catalogue_item_id: "uuid", description: "Mélamine blanc ME1" }, ... ]

    function getDmTypes() { return materialGroups; }
    var dmActiveAC = null; // currently open autocomplete index

    function toggleDefaultMaterials() {
        var body = document.getElementById('dmBody');
        var arrow = document.getElementById('dmArrow');
        var isCollapsed = body.classList.toggle('collapsed');
        arrow.classList.toggle('open', !isCollapsed);
        localStorage.setItem('dmPanelCollapsed', isCollapsed ? '1' : '0');
        if (!isCollapsed) renderDefaultMaterials();
    }

    function restoreDmPanelState() {
        var saved = localStorage.getItem('dmPanelCollapsed');
        // Default collapsed (saved is null or '1')
        var shouldCollapse = saved !== '0';
        var body = document.getElementById('dmBody');
        var arrow = document.getElementById('dmArrow');
        if (body) body.classList.toggle('collapsed', shouldCollapse);
        if (arrow) arrow.classList.toggle('open', !shouldCollapse);
        if (!shouldCollapse) renderDefaultMaterials();
    }

    function getDefaultMaterials() {
        var raw = (currentSubmission && currentSubmission.default_materials);
        // Migrate old object format to new array format
        if (raw && !Array.isArray(raw)) {
            var arr = [];
            Object.keys(raw).forEach(function(cat) {
                (raw[cat] || []).forEach(function(entry) {
                    if (entry.material) arr.push({ type: cat, catalogue_item_id: null, description: entry.material });
                });
            });
            return arr;
        }
        return raw || [];
    }

    /**
     * Get default materials for a specific room (furniture group).
     * Fallback chain: room-level DM → submission-level DM → empty array.
     */
    function getDefaultMaterialsForGroup(groupId) {
        var rdm = roomDM[groupId];
        if (rdm && rdm.length > 0) return rdm;
        return getDefaultMaterials();
    }

    function renderDefaultMaterials() {
        var dm = getDefaultMaterials();
        var body = document.getElementById('dmBody');
        var html = '<div class="dm-rows" id="dmRows">';
        dm.forEach(function(entry, idx) {
            html += renderDmRow(idx, entry);
        });
        html += '</div>';
        html += '<button class="dm-add-btn" onclick="addDefaultMaterial()">+ Ajouter un mat&eacute;riau par d&eacute;faut</button>';
        body.innerHTML = html;
    }

    function renderDmRow(idx, entry) {
        var typeOptions = getDmTypes().map(function(t) {
            return '<option value="' + escapeAttr(t) + '"' + (entry.type === t ? ' selected' : '') + '>' + escapeHtml(t) + '</option>';
        }).join('');
        // Show client_text if the catalogue item has one, otherwise fall back to stored description
        var displayLabel = entry.description || '';
        if (entry.catalogue_item_id) {
            var catItem = (CATALOGUE_DATA || []).find(function(i) { return i.id === entry.catalogue_item_id; });
            if (catItem && catItem.client_text) displayLabel = catItem.client_text;
        }
        return '<div class="dm-row" data-dm-idx="' + idx + '">' +
            '<select onchange="updateDmType(' + idx + ',this.value)">' + typeOptions + '</select>' +
            '<div class="dm-search-wrap">' +
                '<input type="text" value="' + escapeAttr(displayLabel) + '" placeholder="Rechercher dans le catalogue..." ' +
                    'oninput="dmSearchCatalogue(' + idx + ',this)" ' +
                    'onfocus="dmSearchCatalogue(' + idx + ',this)" ' +
                    'onkeydown="dmSearchKeydown(event,' + idx + ')" ' +
                    (entry.catalogue_item_id ? 'class="dm-resolved"' : '') + '>' +
                '<div class="dm-autocomplete" id="dmAC-' + idx + '"></div>' +
            '</div>' +
            '<button class="dm-remove" onclick="removeDmEntry(' + idx + ')" title="Supprimer">&times;</button>' +
            '</div>';
    }

    function addDefaultMaterial() {
        var dm = getDefaultMaterials();
        dm.push({ type: getDmTypes()[0], catalogue_item_id: null, description: '' });
        if (currentSubmission) currentSubmission.default_materials = dm;
        saveDefaultMaterials(dm);
        renderDefaultMaterials();
        // Focus the new search input
        var rows = document.querySelectorAll('.dm-row');
        if (rows.length > 0) {
            var lastInput = rows[rows.length - 1].querySelector('.dm-search-wrap input');
            if (lastInput) lastInput.focus();
        }
    }

    function updateDmType(idx, newType) {
        var dm = getDefaultMaterials();
        if (!dm[idx]) return;
        var oldType = dm[idx].type;
        // Invalidate dmChoiceCache for both old and new type
        if (oldType) { var sfx1 = ':' + oldType; Object.keys(dmChoiceCache).forEach(function(k) { if (k.endsWith(sfx1)) delete dmChoiceCache[k]; }); }
        if (newType && newType !== oldType) { var sfx2 = ':' + newType; Object.keys(dmChoiceCache).forEach(function(k) { if (k.endsWith(sfx2)) delete dmChoiceCache[k]; }); }
        dm[idx].type = newType;
        if (currentSubmission) currentSubmission.default_materials = dm;
        saveDefaultMaterials(dm);
        // Re-trigger cascades for both old and new group
        if (oldType) reprocessDefaultCascades(oldType);
        if (newType && newType !== oldType) reprocessDefaultCascades(newType);
    }

    // Build set of allowed catalogue categories for a given material group
    function getAllowedCategoriesForGroup(groupName) {
        if (!groupName || !categoryGroupMapping || typeof categoryGroupMapping !== 'object') return null;
        // Invert the mapping: category → groups[] → find categories that include this group
        var allowed = [];
        Object.keys(categoryGroupMapping).forEach(function(cat) {
            if (Array.isArray(categoryGroupMapping[cat]) && categoryGroupMapping[cat].indexOf(groupName) !== -1) {
                allowed.push(cat);
            }
        });
        return allowed.length > 0 ? allowed : null; // null = no filter (show all)
    }

    function dmSearchCatalogue(idx, input) {
        var query = input.value.trim().toLowerCase();
        var acDiv = document.getElementById('dmAC-' + idx);
        if (!acDiv) return;

        // Mark as unresolved when user edits
        input.classList.remove('dm-resolved');

        // Get the selected group for this row to filter by allowed categories
        var dm = getDefaultMaterials();
        var selectedGroup = dm[idx] ? dm[idx].type : null;
        var allowedCats = getAllowedCategoriesForGroup(selectedGroup);

        var items = CATALOGUE_DATA || [];
        // Pre-filter by allowed categories if mapping exists (dedup by ID)
        var seen = {};
        if (allowedCats) {
            items = items.filter(function(item) {
                if (seen[item.id]) return false;
                seen[item.id] = true;
                return allowedCats.indexOf(item.category) !== -1;
            });
        } else {
            items = items.filter(function(item) {
                if (seen[item.id]) return false;
                seen[item.id] = true;
                return true;
            });
        }

        var results;
        if (query.length < 2) {
            // No query: show all items grouped by category (browseable)
            results = items.slice(0, 50);
        } else {
            // Filter by query — search client_text, description, and category
            results = items.filter(function(item) {
                var desc = (item.description || '').toLowerCase();
                var ct = (item.client_text || '').toLowerCase();
                var cat = (item.category || '').toLowerCase();
                return ct.indexOf(query) !== -1 || desc.indexOf(query) !== -1 || cat.indexOf(query) !== -1;
            }).slice(0, 30);
        }

        if (results.length === 0) {
            acDiv.innerHTML = '<div class="dm-ac-item" style="color:#999;cursor:default;">Aucun r&eacute;sultat</div>';
            acDiv.classList.add('open');
            dmActiveAC = idx;
            return;
        }

        // Detect label collisions for disambiguation
        var labelCount = {};
        results.forEach(function(item) {
            var lbl = item.client_text || item.description || item.id;
            labelCount[lbl] = (labelCount[lbl] || 0) + 1;
        });

        // Group by category for display
        var grouped = {};
        results.forEach(function(item) {
            var cat = item.category || 'Autre';
            if (!grouped[cat]) grouped[cat] = [];
            grouped[cat].push(item);
        });

        var html = '';
        var globalIdx = 0;
        Object.keys(grouped).forEach(function(cat) {
            html += '<div style="padding:4px 10px;font-size:10px;font-weight:700;color:#888;background:#f9f9f9;text-transform:uppercase;letter-spacing:0.3px;position:sticky;top:0;">' + escapeHtml(cat) + '</div>';
            grouped[cat].forEach(function(item) {
                var displayName = item.client_text || item.description;
                var secondary = item.client_text && item.client_text !== item.description ? item.description : '';
                if (!secondary && labelCount[displayName] > 1) secondary = item.id;
                html += '<div class="dm-ac-item" data-idx="' + globalIdx + '" ' +
                    'onmousedown="dmSelectItem(' + idx + ',\'' + escapeAttr(item.id) + '\',\'' + escapeAttr(displayName) + '\')">' +
                    '<span>' + escapeHtml(displayName) + '</span>' +
                    (secondary ? '<span class="dm-ac-secondary">' + escapeHtml(secondary) + '</span>' : '') +
                    '</div>';
                globalIdx++;
            });
        });
        acDiv.innerHTML = html;
        acDiv.classList.add('open');
        dmActiveAC = idx;
    }

    function dmSearchKeydown(e, idx) {
        var acDiv = document.getElementById('dmAC-' + idx);
        if (!acDiv || !acDiv.classList.contains('open')) return;
        var items = acDiv.querySelectorAll('.dm-ac-item[data-idx]');
        var activeIdx = -1;
        items.forEach(function(el, i) { if (el.classList.contains('active')) activeIdx = i; });

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            activeIdx = Math.min(activeIdx + 1, items.length - 1);
            items.forEach(function(el, i) { el.classList.toggle('active', i === activeIdx); });
            if (items[activeIdx]) items[activeIdx].scrollIntoView({ block: 'nearest' });
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            activeIdx = Math.max(activeIdx - 1, 0);
            items.forEach(function(el, i) { el.classList.toggle('active', i === activeIdx); });
            if (items[activeIdx]) items[activeIdx].scrollIntoView({ block: 'nearest' });
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (activeIdx >= 0 && items[activeIdx]) items[activeIdx].dispatchEvent(new Event('mousedown'));
        } else if (e.key === 'Escape') {
            acDiv.classList.remove('open');
            dmActiveAC = null;
        }
    }

    function dmSelectItem(idx, itemId, itemDesc) {
        var dm = getDefaultMaterials();
        if (!dm[idx]) return;
        var changedGroup = dm[idx].type;
        // Invalidate dmChoiceCache for this type (all rooms using submission fallback)
        if (changedGroup) {
            var sfx = ':' + changedGroup;
            Object.keys(dmChoiceCache).forEach(function(k) { if (k.endsWith(sfx)) delete dmChoiceCache[k]; });
        }
        dm[idx].catalogue_item_id = itemId;
        dm[idx].description = itemDesc;
        if (currentSubmission) currentSubmission.default_materials = dm;
        saveDefaultMaterials(dm);
        // Update input visually
        var row = document.querySelector('.dm-row[data-dm-idx="' + idx + '"]');
        if (row) {
            var input = row.querySelector('.dm-search-wrap input');
            if (input) { input.value = itemDesc; input.classList.add('dm-resolved'); }
            var ac = document.getElementById('dmAC-' + idx);
            if (ac) { ac.classList.remove('open'); ac.innerHTML = ''; }
        }
        dmActiveAC = null;
        // Re-trigger cascades that use $default: for this group
        reprocessDefaultCascades(changedGroup);
    }

    function removeDmEntry(idx) {
        var dm = getDefaultMaterials();
        var label = (dm[idx] && dm[idx].description) ? dm[idx].description : 'ce matériau';
        var changedGroup = (dm[idx] && dm[idx].type) ? dm[idx].type : null;
        steleConfirm('Supprimer « ' + label + ' » ?').then(function(ok) {
            if (!ok) return;
            // Invalidate dmChoiceCache for this type
            if (changedGroup) {
                var sfx = ':' + changedGroup;
                Object.keys(dmChoiceCache).forEach(function(k) { if (k.endsWith(sfx)) delete dmChoiceCache[k]; });
            }
            var dm2 = getDefaultMaterials();
            dm2.splice(idx, 1);
            if (currentSubmission) currentSubmission.default_materials = dm2;
            saveDefaultMaterials(dm2);
            renderDefaultMaterials();
            // Re-trigger cascades — material removed, $default: will now resolve to null
            reprocessDefaultCascades(changedGroup);
        });
    }

    var dmSaveTimer = null;
    function saveDefaultMaterials(dm) {
        clearTimeout(dmSaveTimer);
        dmSaveTimer = setTimeout(function() {
            if (!currentSubmission) return;
            authenticatedFetch(SUPABASE_URL + '/rest/v1/submissions?id=eq.' + currentSubmission.id, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                body: JSON.stringify({ default_materials: dm })
            }).then(function() { showSaveIndicator(); }).catch(function(e) { console.warn('[DM] Save failed:', e); });
        }, 500);
    }

    // Close autocomplete when clicking outside
    document.addEventListener('click', function(e) {
        if (dmActiveAC !== null && !e.target.closest('.dm-search-wrap')) {
            var ac = document.getElementById('dmAC-' + dmActiveAC);
            if (ac) { ac.classList.remove('open'); ac.innerHTML = ''; }
            dmActiveAC = null;
        }
    });

    // ═══════════════════════════════════════════════════════════════════════
    // MATÉRIAUX PAR DÉFAUT — PAR PIÈCE (ROOM-LEVEL DM)
    // ═══════════════════════════════════════════════════════════════════════

    var roomDmActiveAC = null; // currently open room-level DM autocomplete key

    function toggleRoomDm(groupId) {
        var body = document.getElementById(groupId + '-dmBody');
        var arrow = document.getElementById(groupId + '-dmArrow');
        if (!body) return;
        var wasCollapsed = body.classList.contains('collapsed');
        body.classList.toggle('collapsed', !wasCollapsed);
        if (arrow) arrow.classList.toggle('open', wasCollapsed);
        if (wasCollapsed) renderRoomDm(groupId);
    }

    function updateRoomDmBadge(groupId) {
        var badge = document.getElementById(groupId + '-dmBadge');
        if (!badge) return;
        var rdm = roomDM[groupId];
        if (rdm && rdm.length > 0) {
            badge.textContent = rdm.length + ' mat\u00e9riau' + (rdm.length > 1 ? 'x' : '');
            badge.style.display = '';
        } else {
            badge.textContent = '';
            badge.style.display = 'none';
        }
    }

    function renderRoomDm(groupId) {
        var rdm = roomDM[groupId] || [];
        var body = document.getElementById(groupId + '-dmBody');
        if (!body) return;
        var html = '<div class="rdm-rows" id="' + groupId + '-dmRows">';
        rdm.forEach(function(entry, idx) {
            html += renderRoomDmRow(groupId, idx, entry);
        });
        html += '</div>';
        html += '<div class="rdm-actions">';
        html += '<button class="dm-add-btn" onclick="addRoomDmEntry(\'' + groupId + '\')">+ Ajouter</button>';
        html += '<button class="rdm-copy-btn" onclick="openRoomDmCopyMenu(\'' + groupId + '\', this)">Copier de\u2026</button>';
        if (rdm.length > 0) {
            html += '<button class="rdm-clear-btn" onclick="clearRoomDm(\'' + groupId + '\')">Effacer tout</button>';
        }
        html += '</div>';
        if (rdm.length === 0) {
            html += '<div class="rdm-fallback-hint">Utilise les mat\u00e9riaux de la soumission (mod\u00e8le)</div>';
        }
        body.innerHTML = html;
        updateRoomDmBadge(groupId);
    }

    function renderRoomDmRow(groupId, idx, entry) {
        var typeOptions = getDmTypes().map(function(t) {
            return '<option value="' + escapeAttr(t) + '"' + (entry.type === t ? ' selected' : '') + '>' + escapeHtml(t) + '</option>';
        }).join('');
        var displayLabel = entry.description || '';
        if (entry.catalogue_item_id) {
            var catItem = (CATALOGUE_DATA || []).find(function(i) { return i.id === entry.catalogue_item_id; });
            if (catItem && catItem.client_text) displayLabel = catItem.client_text;
        }
        var acId = 'rdmAC-' + groupId + '-' + idx;
        return '<div class="dm-row rdm-row" data-rdm-idx="' + idx + '" data-rdm-group="' + groupId + '">' +
            '<select onchange="updateRoomDmType(\'' + groupId + '\',' + idx + ',this.value)">' + typeOptions + '</select>' +
            '<div class="dm-search-wrap">' +
                '<input type="text" value="' + escapeAttr(displayLabel) + '" placeholder="Rechercher dans le catalogue..." ' +
                    'oninput="rdmSearchCatalogue(\'' + groupId + '\',' + idx + ',this)" ' +
                    'onfocus="rdmSearchCatalogue(\'' + groupId + '\',' + idx + ',this)" ' +
                    'onkeydown="rdmSearchKeydown(event,\'' + groupId + '\',' + idx + ')" ' +
                    (entry.catalogue_item_id ? 'class="dm-resolved"' : '') + '>' +
                '<div class="dm-autocomplete" id="' + acId + '"></div>' +
            '</div>' +
            '<button class="dm-remove" onclick="removeRoomDmEntry(\'' + groupId + '\',' + idx + ')" title="Supprimer">&times;</button>' +
            '</div>';
    }

    function addRoomDmEntry(groupId) {
        if (!roomDM[groupId]) roomDM[groupId] = [];
        roomDM[groupId].push({ type: getDmTypes()[0], catalogue_item_id: null, description: '' });
        saveRoomDm(groupId);
        renderRoomDm(groupId);
        var rows = document.querySelectorAll('#' + groupId + '-dmRows .rdm-row');
        if (rows.length > 0) {
            var lastInput = rows[rows.length - 1].querySelector('.dm-search-wrap input');
            if (lastInput) lastInput.focus();
        }
    }

    function updateRoomDmType(groupId, idx, newType) {
        var rdm = roomDM[groupId];
        if (!rdm || !rdm[idx]) return;
        var oldType = rdm[idx].type;
        if (oldType) delete dmChoiceCache[groupId + ':' + oldType];
        if (newType) delete dmChoiceCache[groupId + ':' + newType];
        rdm[idx].type = newType;
        saveRoomDm(groupId);
        reprocessDefaultCascades(oldType, groupId);
        reprocessDefaultCascades(newType, groupId);
    }

    function removeRoomDmEntry(groupId, idx) {
        var rdm = roomDM[groupId];
        if (!rdm || !rdm[idx]) return;
        var label = rdm[idx].description || rdm[idx].type;
        var changedGroup = rdm[idx].type;
        steleConfirm('Supprimer \u00ab ' + label + ' \u00bb ?').then(function(ok) {
            if (!ok) return;
            if (changedGroup) delete dmChoiceCache[groupId + ':' + changedGroup];
            var rdm2 = roomDM[groupId];
            rdm2.splice(idx, 1);
            saveRoomDm(groupId);
            renderRoomDm(groupId);
            reprocessDefaultCascades(changedGroup, groupId);
        });
    }

    function clearRoomDm(groupId) {
        steleConfirm('Effacer tous les mat\u00e9riaux par d\u00e9faut de cette pi\u00e8ce ?\nLes mat\u00e9riaux de la soumission seront utilis\u00e9s.').then(function(ok) {
            if (!ok) return;
            var oldTypes = (roomDM[groupId] || []).map(function(e) { return e.type; });
            // Invalidate all dmChoiceCache entries for this room
            oldTypes.forEach(function(t) { if (t) delete dmChoiceCache[groupId + ':' + t]; });
            roomDM[groupId] = [];
            saveRoomDm(groupId);
            renderRoomDm(groupId);
            // Reprocess cascades for all previously set types
            oldTypes.forEach(function(t) { reprocessDefaultCascades(t, groupId); });
        });
    }

    function rdmSearchCatalogue(groupId, idx, input) {
        var query = input.value.trim().toLowerCase();
        var acId = 'rdmAC-' + groupId + '-' + idx;
        var acDiv = document.getElementById(acId);
        if (!acDiv) return;
        input.classList.remove('dm-resolved');

        var rdm = roomDM[groupId] || [];
        var selectedGroup = rdm[idx] ? rdm[idx].type : null;
        var allowedCats = getAllowedCategoriesForGroup(selectedGroup);

        var items = CATALOGUE_DATA || [];
        // Pre-filter by allowed categories if mapping exists (dedup by ID)
        var seen = {};
        if (allowedCats) {
            items = items.filter(function(item) {
                if (seen[item.id]) return false;
                seen[item.id] = true;
                return allowedCats.indexOf(item.category) !== -1;
            });
        } else {
            items = items.filter(function(item) {
                if (seen[item.id]) return false;
                seen[item.id] = true;
                return true;
            });
        }

        var results;
        if (query.length < 2) {
            results = items.slice(0, 50);
        } else {
            results = items.filter(function(item) {
                var desc = (item.description || '').toLowerCase();
                var ct = (item.client_text || '').toLowerCase();
                var cat = (item.category || '').toLowerCase();
                return ct.indexOf(query) !== -1 || desc.indexOf(query) !== -1 || cat.indexOf(query) !== -1;
            }).slice(0, 30);
        }

        if (results.length === 0) {
            acDiv.innerHTML = '<div class="dm-ac-item" style="color:#999;cursor:default;">Aucun r\u00e9sultat</div>';
            acDiv.classList.add('open');
            roomDmActiveAC = acId;
            return;
        }

        // Detect label collisions for disambiguation
        var labelCount = {};
        results.forEach(function(item) {
            var lbl = item.client_text || item.description || item.id;
            labelCount[lbl] = (labelCount[lbl] || 0) + 1;
        });

        var grouped = {};
        results.forEach(function(item) {
            var cat = item.category || 'Autre';
            if (!grouped[cat]) grouped[cat] = [];
            grouped[cat].push(item);
        });

        var html = '';
        var globalIdx = 0;
        Object.keys(grouped).forEach(function(cat) {
            html += '<div style="padding:4px 10px;font-size:10px;font-weight:700;color:#888;background:#f9f9f9;text-transform:uppercase;letter-spacing:0.3px;position:sticky;top:0;">' + escapeHtml(cat) + '</div>';
            grouped[cat].forEach(function(item) {
                var displayName = item.client_text || item.description;
                var secondary = item.client_text && item.client_text !== item.description ? item.description : '';
                if (!secondary && labelCount[displayName] > 1) secondary = item.id;
                html += '<div class="dm-ac-item" data-idx="' + globalIdx + '" ' +
                    'onmousedown="rdmSelectItem(\'' + groupId + '\',' + idx + ',\'' + escapeAttr(item.id) + '\',\'' + escapeAttr(displayName) + '\')">' +
                    '<span>' + escapeHtml(displayName) + '</span>' +
                    (secondary ? '<span class="dm-ac-secondary">' + escapeHtml(secondary) + '</span>' : '') +
                    '</div>';
                globalIdx++;
            });
        });
        acDiv.innerHTML = html;
        acDiv.classList.add('open');
        roomDmActiveAC = acId;
    }

    function rdmSearchKeydown(e, groupId, idx) {
        var acId = 'rdmAC-' + groupId + '-' + idx;
        var acDiv = document.getElementById(acId);
        if (!acDiv || !acDiv.classList.contains('open')) return;
        var items = acDiv.querySelectorAll('.dm-ac-item[data-idx]');
        var activeIdx = -1;
        items.forEach(function(el, i) { if (el.classList.contains('active')) activeIdx = i; });

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            activeIdx = Math.min(activeIdx + 1, items.length - 1);
            items.forEach(function(el, i) { el.classList.toggle('active', i === activeIdx); });
            if (items[activeIdx]) items[activeIdx].scrollIntoView({ block: 'nearest' });
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            activeIdx = Math.max(activeIdx - 1, 0);
            items.forEach(function(el, i) { el.classList.toggle('active', i === activeIdx); });
            if (items[activeIdx]) items[activeIdx].scrollIntoView({ block: 'nearest' });
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (activeIdx >= 0 && items[activeIdx]) items[activeIdx].dispatchEvent(new Event('mousedown'));
        } else if (e.key === 'Escape') {
            acDiv.classList.remove('open');
            roomDmActiveAC = null;
        }
    }

    function rdmSelectItem(groupId, idx, itemId, itemDesc) {
        var rdm = roomDM[groupId];
        if (!rdm || !rdm[idx]) return;
        var changedGroup = rdm[idx].type;
        if (changedGroup) delete dmChoiceCache[groupId + ':' + changedGroup];
        rdm[idx].catalogue_item_id = itemId;
        rdm[idx].description = itemDesc;
        saveRoomDm(groupId);
        // Update input visually
        var row = document.querySelector('.rdm-row[data-rdm-group="' + groupId + '"][data-rdm-idx="' + idx + '"]');
        if (row) {
            var input = row.querySelector('.dm-search-wrap input');
            if (input) { input.value = itemDesc; input.classList.add('dm-resolved'); }
            var acId = 'rdmAC-' + groupId + '-' + idx;
            var ac = document.getElementById(acId);
            if (ac) { ac.classList.remove('open'); ac.innerHTML = ''; }
        }
        roomDmActiveAC = null;
        // Re-trigger cascades for this room
        reprocessDefaultCascades(changedGroup, groupId);
    }

    var roomDmSaveTimers = {};
    function saveRoomDm(groupId) {
        clearTimeout(roomDmSaveTimers[groupId]);
        roomDmSaveTimers[groupId] = setTimeout(function() {
            var roomId = roomMap[groupId];
            if (!roomId) return;
            authenticatedFetch(SUPABASE_URL + '/rest/v1/project_rooms?id=eq.' + roomId, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                body: JSON.stringify({ default_materials: roomDM[groupId] || [] })
            }).then(function() { showSaveIndicator(); }).catch(function(e) { console.warn('[RoomDM] Save failed:', e); });
        }, 500);
    }

    // "Copier de..." dropdown (Linear/Notion style)
    function openRoomDmCopyMenu(groupId, btnEl) {
        // Close any existing dropdown
        var old = document.querySelector('.rdm-copy-dropdown');
        if (old) old.remove();

        var rect = btnEl.getBoundingClientRect();
        var dd = document.createElement('div');
        dd.className = 'rdm-copy-dropdown';
        dd.style.position = 'fixed';
        dd.style.left = rect.left + 'px';
        dd.style.zIndex = '99999';

        var options = [];
        // Submission template
        var subDM = getDefaultMaterials();
        if (subDM.length > 0) {
            options.push({ label: 'Soumission (mod\u00e8le)', dm: JSON.parse(JSON.stringify(subDM)) });
        }
        // Other rooms
        document.querySelectorAll('.furniture-group').forEach(function(g) {
            if (g.id === groupId) return;
            var otherDM = roomDM[g.id];
            if (!otherDM || otherDM.length === 0) return;
            var nameEl = g.querySelector('.furniture-name-input');
            var name = nameEl ? (nameEl.value.trim() || 'Sans nom') : 'Sans nom';
            options.push({ label: name, dm: JSON.parse(JSON.stringify(otherDM)) });
        });

        if (options.length === 0) {
            dd.innerHTML = '<div class="rdm-copy-item" style="color:#999;cursor:default;">Aucune source disponible</div>';
        } else {
            options.forEach(function(opt) {
                var item = document.createElement('div');
                item.className = 'rdm-copy-item';
                item.textContent = opt.label;
                item.addEventListener('click', function() {
                    roomDM[groupId] = opt.dm;
                    saveRoomDm(groupId);
                    renderRoomDm(groupId);
                    dd.remove();
                    // Reprocess all groups for changed types
                    var types = {};
                    opt.dm.forEach(function(e) { types[e.type] = true; });
                    Object.keys(types).forEach(function(t) { reprocessDefaultCascades(t, groupId); });
                });
                dd.appendChild(item);
            });
        }

        // Flip up if near bottom
        var spaceBelow = window.innerHeight - rect.bottom;
        if (spaceBelow < 200) {
            dd.style.bottom = (window.innerHeight - rect.top) + 'px';
        } else {
            dd.style.top = rect.bottom + 'px';
        }

        document.body.appendChild(dd);

        // Close on outside click
        setTimeout(function() {
            function closeDD(e) {
                if (!dd.contains(e.target)) {
                    dd.remove();
                    document.removeEventListener('click', closeDD, true);
                }
            }
            document.addEventListener('click', closeDD, true);
        }, 0);
    }

    // Close room-level DM autocomplete when clicking outside
    document.addEventListener('click', function(e) {
        if (roomDmActiveAC && !e.target.closest('.dm-search-wrap')) {
            var ac = document.getElementById(roomDmActiveAC);
            if (ac) { ac.classList.remove('open'); ac.innerHTML = ''; }
            roomDmActiveAC = null;
        }
    });

    // ═══════════════════════════════════════════════════════════════════════
    // PIÈCES & ARTICLES — CRUD SUPABASE
    // ═══════════════════════════════════════════════════════════════════════

    async function loadSubmissionRooms(submissionId) {
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/project_rooms?submission_id=eq.' + submissionId + '&order=sort_order&select=*,room_items(*)', {});
        if (!r.ok) return [];
        const rooms = await r.json();
        rooms.forEach(room => {
            if (room.room_items) room.room_items.sort((a, b) => a.sort_order - b.sort_order);
        });
        return rooms;
    }

    // Legacy — keep for transition
    async function loadProjectRooms(projectId) {
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/project_rooms?project_id=eq.' + projectId + '&order=sort_order&select=*,room_items(*)', {});
        if (!r.ok) return [];
        const rooms = await r.json();
        rooms.forEach(room => {
            if (room.room_items) room.room_items.sort((a, b) => a.sort_order - b.sort_order);
        });
        return rooms;
    }

    async function createRoom(submissionId, name, sortOrder) {
        var payload = { submission_id: submissionId, name: name || '', sort_order: sortOrder || 0 };
        // Also set project_id for transition period
        if (currentProject) payload.project_id = currentProject.id;
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/project_rooms', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
            body: JSON.stringify(payload)
        });
        if (!r.ok) return null;
        const data = await r.json();
        return data[0];
    }

    async function updateRoom(roomId, fields) {
        await authenticatedFetch(SUPABASE_URL + '/rest/v1/project_rooms?id=eq.' + roomId, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
            body: JSON.stringify(fields)
        });
    }

    async function deleteRoom(roomId) {
        await authenticatedFetch(SUPABASE_URL + '/rest/v1/project_rooms?id=eq.' + roomId, {
            method: 'DELETE'
        });
    }

    async function createItem(roomId, itemData) {
        const payload = Object.assign({ room_id: roomId }, itemData);
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/room_items', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
            body: JSON.stringify(payload)
        });
        if (!r.ok) return null;
        const data = await r.json();
        return data[0];
    }

    async function updateItem(itemId, fields) {
        await authenticatedFetch(SUPABASE_URL + '/rest/v1/room_items?id=eq.' + itemId, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
            body: JSON.stringify(fields)
        });
    }

    async function deleteItem(itemId) {
        await authenticatedFetch(SUPABASE_URL + '/rest/v1/room_items?id=eq.' + itemId, {
            method: 'DELETE'
        });
    }

    /**
     * Sync sort_order in DB to match current DOM order for all rows in a group.
     * Called after cascade insertion to persist the correct ordering.
     */
    function syncSortOrderForGroup(groupId) {
        var container = document.getElementById(groupId + '-rows');
        if (!container) return;
        var rows = container.querySelectorAll('.calc-row');
        rows.forEach(function(row, idx) {
            var dbId = itemMap[row.id];
            if (dbId) {
                updateItem(dbId, { sort_order: idx + 1 });
            }
        });
    }

    // ═══════════════════════════════════════════════════════════════════════
    // MOTEUR CASCADE — Phase 3
    // ═══════════════════════════════════════════════════════════════════════

    var cascadeParentMap = {};   // cascadeParentMap[childRowId] = parentRowId
    var _cascadeRunning = false; // guard against re-entrancy
    var _isLoadingSubmission = false; // guard against cascades during submission load
    var matchDefaults = {};      // cache $match: resolutions (loaded from submission.match_defaults)
    var dmChoiceCache = {};      // { "groupId:TypeName": catalogue_item_id } — per-room $default: choice cache

    var MATCH_STOP_WORDS = ['de', 'du', 'des', 'le', 'la', 'les', 'en', 'avec', 'pour', 'et',
        'un', 'une', 'sur', 'par', 'au', 'aux',
        'caisson', 'meuble', 'panneau', 'panneaux', 'façade', 'façades',
        'mm', 'po', 'pce', 'pcs'];

    function extractMatchKeywords(clientText) {
        return clientText.toLowerCase()
            .replace(/[^a-zàâäéèêëïîôùûüÿç0-9\s-]/g, '')
            .split(/\s+/)
            .filter(function(w) { return w.length > 2 && MATCH_STOP_WORDS.indexOf(w) === -1; });
    }

    function findParentFabRow(groupId) {
        var rows = document.querySelectorAll('#' + groupId + ' .calc-row:not(.cascade-child)');
        for (var i = 0; i < rows.length; i++) {
            var sel = rows[i].querySelector('.item-select');
            if (sel && sel.value && sel.value !== '__AJOUT__' && sel.value !== '__PROPOSER__') {
                return { rowId: rows[i].id, catalogueId: sel.value };
            }
        }
        return null;
    }

    function saveMatchDefault(cacheKey, itemId) {
        matchDefaults[cacheKey] = itemId;
        if (currentSubmission && currentSubmission.id) {
            authenticatedFetch(SUPABASE_URL + '/rest/v1/submissions?id=eq.' + currentSubmission.id, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                body: JSON.stringify({ match_defaults: matchDefaults })
            });
        }
    }

    /**
     * Évaluateur de formules sécurisé.
     * Variables : L, H, P (dimensions en pouces), QTY (quantité du parent)
     * Fonctions : ceil, floor, round, min, max
     */
    function evalFormula(expr, vars) {
        if (!expr) return null;
        // Substitute n_tablettes/n_partitions first (underscores must be resolved before security check)
        var safe = String(expr)
            .replace(/\bn_tablettes\b/g, (vars.n_tablettes != null) ? Number(vars.n_tablettes) : 0)
            .replace(/\bn_partitions\b/g, (vars.n_partitions != null) ? Number(vars.n_partitions) : 0);
        safe = safe.replace(/\b(L|H|P|QTY)\b/g, function(m) {
            return (vars[m] != null) ? Number(vars[m]) : 0;
        });
        safe = safe.replace(/\bceil\b/g, 'Math.ceil')
                   .replace(/\bfloor\b/g, 'Math.floor')
                   .replace(/\bround\b/g, 'Math.round')
                   .replace(/\bmin\b/g, 'Math.min')
                   .replace(/\bmax\b/g, 'Math.max');
        var check = safe.replace(/Math\.\w+/g, '').replace(/[\d\s+\-*/.(),><=!&|]/g, '');
        if (check.length > 0) { console.warn('[Cascade] Formule non sécuritaire:', expr, '→', check); return null; }
        try { return new Function('return ' + safe)(); }
        catch (e) { console.error('[Cascade] Erreur formule:', expr, e); return null; }
    }

    /**
     * For dynamic cascade rules ($default: / $match:), check if an existing active child
     * already satisfies the rule — so we can skip resolution (and avoid popup).
     * Returns the child's catalogueId if found, or null.
     */
    function findExistingChildForDynamicRule(ruleTarget, groupId, activeChildren, alreadyMatched) {
        if (ruleTarget.startsWith('$default:')) {
            var groupName = ruleTarget.substring(9);
            var dm = groupId ? getDefaultMaterialsForGroup(groupId) : getDefaultMaterials();
            var validIds = {};
            for (var i = 0; i < dm.length; i++) {
                if (dm[i].type === groupName && dm[i].catalogue_item_id) {
                    validIds[dm[i].catalogue_item_id] = true;
                }
            }
            for (var j = 0; j < activeChildren.length; j++) {
                var c = activeChildren[j];
                if (alreadyMatched.indexOf(c.rowId) === -1 && c.catalogueId && validIds[c.catalogueId]) {
                    return c.catalogueId;
                }
            }
            return null;
        }
        if (ruleTarget.startsWith('$match:')) {
            var expCat = ruleTarget.substring(7).toUpperCase();
            for (var k = 0; k < activeChildren.length; k++) {
                var ch = activeChildren[k];
                if (alreadyMatched.indexOf(ch.rowId) === -1 && ch.catalogueId) {
                    var catItem = CATALOGUE_DATA.find(function(it) { return it.id === ch.catalogueId; });
                    if (catItem && itemHasMaterialCost(catItem, expCat)) {
                        return ch.catalogueId;
                    }
                }
            }
            return null;
        }
        return null;
    }

    /** Trouver les enfants cascade d'un parent (lookup dans cascadeParentMap) */
    function findCascadeChildren(parentRowId) {
        var children = [];
        for (var childRowId in cascadeParentMap) {
            if (cascadeParentMap[childRowId] === parentRowId) {
                var row = document.getElementById(childRowId);
                var select = row ? row.querySelector('.item-select') : null;
                children.push({ rowId: childRowId, catalogueId: select ? select.value : null });
            }
        }
        return children;
    }

    /** Remonter la chaîne parent pour trouver les dimensions L/H/P de la racine fabrication */
    function getRootDimsForCascade(rowId) {
        var visited = {};
        var current = rowId;
        while (cascadeParentMap[current] && !visited[current]) {
            visited[current] = true;
            current = cascadeParentMap[current];
        }
        // current = racine (le row fabrication avec les dims)
        var dimL = document.getElementById(current + '-dim-l');
        var dimH = document.getElementById(current + '-dim-h');
        var dimP = document.getElementById(current + '-dim-p');
        var nTab = document.getElementById(current + '-n-tab');
        var nPart = document.getElementById(current + '-n-part');
        return {
            L: dimL ? (parseFloat(dimL.value) || 0) : 0,
            H: dimH ? (parseFloat(dimH.value) || 0) : 0,
            P: dimP ? (parseFloat(dimP.value) || 0) : 0,
            n_tablettes: nTab ? (parseInt(nTab.value) || 0) : 0,
            n_partitions: nPart ? (parseInt(nPart.value) || 0) : 0
        };
    }

    /**
     * Resolve a cascade target.
     * - "$default:GROUP" → look up default material for the group
     * - "$match:EXPENSE_CATEGORY" → keyword-match parent's client_text against catalogue
     * - Otherwise return the target as-is (direct catalogue code).
     */
    /** Check if item has material_costs in a given expense category (case-insensitive). */
    function itemHasMaterialCost(item, expenseCategoryUpper) {
        if (!item.material_costs || typeof item.material_costs !== 'object') return false;
        var keys = Object.keys(item.material_costs);
        for (var i = 0; i < keys.length; i++) {
            if (keys[i].toUpperCase() === expenseCategoryUpper) {
                var val = item.material_costs[keys[i]];
                return typeof val === 'number' ? val > 0 : (val && val.cost > 0);
            }
        }
        return false;
    }

    async function resolveCascadeTarget(target, groupId) {
        if (!target) return null;
        if (!target.startsWith('$default:') && !target.startsWith('$match:')) return target;
        if (target.startsWith('$default:')) {
            var groupName = target.substring(9);
            var dm = groupId ? getDefaultMaterialsForGroup(groupId) : getDefaultMaterials();
            // Collect ALL DM entries matching this type name
            var matches = [];
            for (var i = 0; i < dm.length; i++) {
                if (dm[i].type === groupName && dm[i].catalogue_item_id) {
                    matches.push(dm[i]);
                }
            }
            if (matches.length === 0) return null;
            if (matches.length === 1) return matches[0].catalogue_item_id;
            // Multiple DM entries for same type → check cache first
            var cacheKey = groupId + ':' + groupName;
            if (dmChoiceCache[cacheKey]) {
                var cached = matches.find(function(m) { return m.catalogue_item_id === dmChoiceCache[cacheKey]; });
                if (cached) return cached.catalogue_item_id;
            }
            // Show choice popup
            var result = await showDmChoiceModal(groupName, matches);
            if (!result) return matches[0].catalogue_item_id; // cancelled → fallback to first
            if (result.remember) {
                dmChoiceCache[cacheKey] = result.itemId;
            }
            return result.itemId;
        }
        // $match: resolution (case-insensitive)
        var expenseCategory = target.substring(7);
        return await resolveMatchTarget(expenseCategory, groupId);
    }

    /**
     * Resolve a $match:EXPENSE_CATEGORY target by keyword-matching the parent
     * fabrication item's client_text against catalogue items with costs in that category.
     *
     * Fallback chain for keywords:
     * 1. Parent item's client_text
     * 2. Parent item's description
     * 3. Default material for the parent's material group (via categoryGroupMapping or name match)
     */
    async function resolveMatchTarget(expenseCategory, groupId) {
        var parentRow = findParentFabRow(groupId);
        if (!parentRow) { console.warn('[CASCADE] $match: no parent fab row in group', groupId); return null; }
        var parentItem = CATALOGUE_DATA.find(function(i) { return i.id === parentRow.catalogueId; });
        if (!parentItem) { console.warn('[CASCADE] $match: parent item not found', parentRow.catalogueId); return null; }

        var expCatUpper = expenseCategory.toUpperCase();

        // Filter catalogue once: items with material_costs in this expense category
        var candidates = CATALOGUE_DATA.filter(function(item) {
            return itemHasMaterialCost(item, expCatUpper);
        });
        console.log('[CASCADE] $match: ' + candidates.length + ' candidates with material_costs in "' + expCatUpper + '"',
            candidates.slice(0, 5).map(function(c) { return c.id + ' "' + (c.client_text || c.description || '').substring(0, 40) + '"'; }));

        // ── Fallback chain: client_text → description → default material ──
        // Each step extracts keywords and scores independently.
        // If a step scores 0, continue to the next step (not just when no keywords).
        var steps = [];
        if (parentItem.client_text) {
            var kw1 = extractMatchKeywords(parentItem.client_text);
            if (kw1.length > 0) steps.push({ keywords: kw1, source: 'client_text' });
        }
        if (parentItem.description) {
            var kw2 = extractMatchKeywords(parentItem.description);
            if (kw2.length > 0) steps.push({ keywords: kw2, source: 'description' });
        }

        for (var si = 0; si < steps.length; si++) {
            var keywords = steps[si].keywords;
            var keywordSource = steps[si].source;
            console.log('[CASCADE] $match: step ' + (si + 1) + ' — keywords from ' + keywordSource + ':', keywords.join(', '));

            var cacheKey = expCatUpper + ':' + keywords.join('+');
            if (matchDefaults[cacheKey]) {
                if (CATALOGUE_DATA.find(function(i) { return i.id === matchDefaults[cacheKey]; })) {
                    console.log('[CASCADE] $match: cache hit', cacheKey, '→', matchDefaults[cacheKey]);
                    return matchDefaults[cacheKey];
                }
            }

            var scored = scoreMatchCandidates(candidates, keywords);
            console.log('[CASCADE] $match: scored ' + scored.length + '/' + candidates.length + ' (' + keywordSource + ')',
                scored.slice(0, 3).map(function(s) { return s.item.id + ' score=' + s.score; }));

            if (scored.length === 0 && keywords.length > 2) {
                var relaxedKw = keywords.slice(0, 2);
                scored = scoreMatchCandidates(candidates, relaxedKw);
                console.log('[CASCADE] $match: relaxed to top-2 (' + relaxedKw.join(', ') + ') → ' + scored.length + ' results');
            }

            if (scored.length === 1) {
                saveMatchDefault(cacheKey, scored[0].item.id);
                return scored[0].item.id;
            }
            if (scored.length > 1) {
                var chosen = await showMatchChoiceModal(expenseCategory, scored, keywords);
                if (chosen) saveMatchDefault(cacheKey, chosen);
                return chosen;
            }
            // scored === 0 → continue to next keyword source
            console.log('[CASCADE] $match: 0 results from ' + keywordSource + ', continuing fallback...');
        }

        // Step 3: Fallback to default material keywords
        var dmKeywords = await getDefaultMaterialKeywords(groupId, expenseCategory);
        if (dmKeywords) {
            var keywords = dmKeywords.keywords;
            var keywordSource = 'default_material(' + dmKeywords.dmItemId + ')';
            console.log('[CASCADE] $match: DM fallback — keywords from ' + keywordSource + ':', keywords.join(', '));

            var cacheKey = expCatUpper + ':' + keywords.join('+');
            if (matchDefaults[cacheKey]) {
                if (CATALOGUE_DATA.find(function(i) { return i.id === matchDefaults[cacheKey]; })) {
                    console.log('[CASCADE] $match: cache hit', cacheKey, '→', matchDefaults[cacheKey]);
                    return matchDefaults[cacheKey];
                }
            }

            var scored = scoreMatchCandidates(candidates, keywords);
            console.log('[CASCADE] $match: scored ' + scored.length + '/' + candidates.length + ' (DM keywords)');

            if (scored.length === 0 && keywords.length > 2) {
                var relaxedKw = keywords.slice(0, 2);
                scored = scoreMatchCandidates(candidates, relaxedKw);
                console.log('[CASCADE] $match: relaxed DM to top-2 (' + relaxedKw.join(', ') + ') → ' + scored.length);
            }

            if (scored.length === 1) {
                saveMatchDefault(cacheKey, scored[0].item.id);
                return scored[0].item.id;
            }
            if (scored.length > 1) {
                var chosen = await showMatchChoiceModal(expenseCategory, scored, keywords);
                if (chosen) saveMatchDefault(cacheKey, chosen);
                return chosen;
            }
        }

        // All fallback sources exhausted
        console.warn('[CASCADE] $match: 0 scored results after full fallback chain for', parentRow.catalogueId);
        showConstraintToast('Aucun article trouvé pour $match:' + expenseCategory);
        return null;
    }

    /**
     * Score catalogue candidates against keywords by matching client_text/description.
     */
    function scoreMatchCandidates(candidates, keywords) {
        var scored = candidates.map(function(item) {
            var itemText = (item.client_text || item.description || '').toLowerCase();
            var hits = keywords.filter(function(kw) { return itemText.indexOf(kw) !== -1; });
            return { item: item, score: hits.length };
        }).filter(function(s) { return s.score > 0; });
        scored.sort(function(a, b) { return b.score - a.score; });
        return scored;
    }

    /**
     * Fallback: get keywords from the default material assigned to the parent's material group.
     * Matches parent catalogue category name → DM type name (case-insensitive).
     * Supports multiple DM entries of same type via dmChoiceCache/popup.
     */
    async function getDefaultMaterialKeywords(groupId, parentCategory) {
        // Determine DM source: room-level or submission-level
        var rdm = roomDM[groupId];
        var dmSource = (rdm && rdm.length > 0) ? 'room' : 'submission';
        var dm = (rdm && rdm.length > 0) ? rdm : getDefaultMaterials();
        if (!dm || dm.length === 0) {
            console.log('[CASCADE] DM fallback: no default materials for group', groupId, '(source: ' + dmSource + ')');
            return null;
        }
        console.log('[CASCADE] DM fallback: parentCategory=' + parentCategory + ', source=' + dmSource + ', dm entries:', dm.map(function(d) { return d.type + '\u2192' + (d.catalogue_item_id || 'null'); }).join(', '));

        // 1. Collect ALL direct matches: catalogue category name === DM type name (case-insensitive)
        var directMatches = [];
        if (parentCategory) {
            var targetLower = parentCategory.toLowerCase();
            for (var di = 0; di < dm.length; di++) {
                if (dm[di].type && dm[di].type.toLowerCase() === targetLower && dm[di].catalogue_item_id) {
                    directMatches.push(dm[di]);
                }
            }
        }

        var dmEntry = null;
        var matchMethod = '';

        if (directMatches.length === 1) {
            dmEntry = directMatches[0];
            matchMethod = 'direct';
        } else if (directMatches.length > 1) {
            // Multiple DM entries for same type → use cache or popup
            var cacheKey = groupId + ':' + parentCategory;
            if (dmChoiceCache[cacheKey]) {
                var cached = directMatches.find(function(m) { return m.catalogue_item_id === dmChoiceCache[cacheKey]; });
                if (cached) {
                    dmEntry = cached;
                    matchMethod = 'direct(cached)';
                }
            }
            if (!dmEntry) {
                var result = await showDmChoiceModal(parentCategory, directMatches);
                if (result) {
                    dmEntry = directMatches.find(function(m) { return m.catalogue_item_id === result.itemId; });
                    matchMethod = 'direct(chosen)';
                    if (result.remember) dmChoiceCache[cacheKey] = result.itemId;
                } else {
                    dmEntry = directMatches[0]; // cancelled → fallback to first
                    matchMethod = 'direct(first)';
                }
            }
        }

        // 2. Fuzzy match: parent category name contains group name or vice versa
        if (!dmEntry && parentCategory) {
            var catLower = parentCategory.toLowerCase();
            for (var fi = 0; fi < dm.length; fi++) {
                if (!dm[fi].catalogue_item_id || !dm[fi].type) continue;
                var typeLower = dm[fi].type.toLowerCase();
                if (catLower.indexOf(typeLower) !== -1 || typeLower.indexOf(catLower) !== -1) {
                    dmEntry = dm[fi];
                    matchMethod = 'fuzzy(' + dm[fi].type + ')';
                    break;
                }
            }
        }

        // 3. Last resort: first default material with a catalogue_item_id
        if (!dmEntry) {
            dmEntry = dm.find(function(d) { return d.catalogue_item_id; }) || null;
            if (dmEntry) matchMethod = 'first-available(' + dmEntry.type + ')';
        }

        if (!dmEntry || !dmEntry.catalogue_item_id) {
            console.log('[CASCADE] DM fallback: no DM entry found for category', parentCategory);
            return null;
        }
        console.log('[CASCADE] DM fallback: matched via ' + matchMethod + ' \u2192 ' + dmEntry.catalogue_item_id);

        var dmItem = CATALOGUE_DATA.find(function(i) { return i.id === dmEntry.catalogue_item_id; });
        if (!dmItem) return null;

        var text = dmItem.client_text || dmItem.description || '';
        var kw = extractMatchKeywords(text);
        if (kw.length === 0) return null;

        return { keywords: kw, dmItemId: dmItem.id };
    }

    /** Find DM entry by type name (case-insensitive). */
    function findDmEntryByType(dm, typeName) {
        var targetLower = typeName.toLowerCase();
        for (var i = 0; i < dm.length; i++) {
            if (dm[i].type && dm[i].type.toLowerCase() === targetLower && dm[i].catalogue_item_id) return dm[i];
        }
        return null;
    }

    /**
     * Show a modal for the user to choose among multiple $match: candidates.
     */
    async function showMatchChoiceModal(expenseCategory, scored, keywords) {
        return new Promise(function(resolve) {
            var overlay = document.createElement('div');
            overlay.className = 'constraint-modal-overlay';
            var modal = document.createElement('div');
            modal.className = 'constraint-modal';
            modal.style.maxWidth = '480px';

            var title = 'Sélectionner : ' + expenseCategory;
            var subtitle = 'Mots-clés : ' + keywords.join(', ');
            modal.innerHTML = '<h3 style="margin:0 0 4px;">' + escapeHtml(title) + '</h3>'
                + '<p style="font-size:12px;color:#666;margin:0 0 12px;">' + escapeHtml(subtitle) + '</p>';

            var selectedId = null;
            var list = document.createElement('div');
            list.style.cssText = 'max-height:260px; overflow-y:auto; margin:0 0 12px;';

            scored.slice(0, 8).forEach(function(s, idx) {
                var priceText = s.item.price != null ? formatPrice(s.item.price) : '';
                var btn = document.createElement('div');
                btn.style.cssText = 'display:flex; align-items:center; gap:10px; padding:10px 12px; margin:4px 0; border:1px solid #e0e0e0; border-radius:8px; background:#fff; cursor:pointer; font-size:13px; transition:all 0.15s;';
                var radio = '<div style="width:16px;height:16px;border-radius:50%;border:2px solid #cbd5e1;flex-shrink:0;" class="match-radio"></div>';
                btn.innerHTML = radio
                    + '<div style="flex:1;min-width:0;">'
                    + '<div><strong>' + escapeHtml(s.item.id) + '</strong> — ' + escapeHtml(s.item.client_text || s.item.description || '') + '</div>'
                    + (priceText ? '<div style="font-size:11px;color:#888;">' + priceText + '/' + escapeHtml(s.item.type || 'unité') + '</div>' : '')
                    + '</div>';
                btn.onmouseover = function() { if (selectedId !== s.item.id) btn.style.background = '#f8fafc'; };
                btn.onmouseout = function() { if (selectedId !== s.item.id) btn.style.background = '#fff'; };
                btn.onclick = function() {
                    selectedId = s.item.id;
                    list.querySelectorAll('.match-radio').forEach(function(r) {
                        r.style.cssText = 'width:16px;height:16px;border-radius:50%;border:2px solid #cbd5e1;flex-shrink:0;';
                    });
                    list.querySelectorAll('[data-match-row]').forEach(function(r) { r.style.background = '#fff'; r.style.borderColor = '#e0e0e0'; });
                    btn.querySelector('.match-radio').style.cssText = 'width:16px;height:16px;border-radius:50%;border:2px solid var(--sw-navy, #0B1220);background:var(--sw-navy, #0B1220);flex-shrink:0;box-shadow:inset 0 0 0 3px #fff;';
                    btn.style.background = '#f0f4ff';
                    btn.style.borderColor = 'var(--sw-navy, #0B1220)';
                    confirmBtn.disabled = false;
                    confirmBtn.style.opacity = '1';
                };
                btn.setAttribute('data-match-row', '1');
                list.appendChild(btn);
            });
            modal.appendChild(list);

            // Remember checkbox
            var rememberDiv = document.createElement('div');
            rememberDiv.style.cssText = 'display:flex;align-items:center;gap:6px;margin:0 0 14px;font-size:12px;color:#666;';
            var rememberCb = document.createElement('input');
            rememberCb.type = 'checkbox';
            rememberCb.checked = true;
            rememberCb.style.cssText = 'width:14px;height:14px;accent-color:var(--sw-navy, #0B1220);';
            rememberDiv.appendChild(rememberCb);
            var rememberLabel = document.createElement('span');
            rememberLabel.textContent = 'Mémoriser ce choix pour cette soumission';
            rememberDiv.appendChild(rememberLabel);
            modal.appendChild(rememberDiv);

            var actions = document.createElement('div');
            actions.style.cssText = 'display:flex;justify-content:flex-end;gap:8px;';

            var cancelBtn = document.createElement('button');
            cancelBtn.className = 'cm-btn-secondary';
            cancelBtn.textContent = 'Annuler';
            cancelBtn.onclick = function() { overlay.remove(); resolve(null); };
            actions.appendChild(cancelBtn);

            var confirmBtn = document.createElement('button');
            confirmBtn.style.cssText = 'padding:7px 18px;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;border:none;background:var(--sw-navy, #0B1220);color:#fff;opacity:0.4;';
            confirmBtn.textContent = 'Confirmer';
            confirmBtn.disabled = true;
            confirmBtn.onclick = function() {
                overlay.remove();
                if (selectedId && rememberCb.checked) {
                    var ck = expenseCategory.toUpperCase() + ':' + keywords.join('+');
                    saveMatchDefault(ck, selectedId);
                }
                resolve(selectedId);
            };
            actions.appendChild(confirmBtn);
            modal.appendChild(actions);

            overlay.appendChild(modal);
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) { overlay.remove(); resolve(null); }
            });
            document.body.appendChild(overlay);
        });
    }

    /**
     * Show a modal for the user to choose among multiple $default: DM entries of the same type.
     * Returns { itemId, remember } or null if cancelled.
     */
    async function showDmChoiceModal(groupName, dmEntries) {
        var enriched = dmEntries.map(function(entry) {
            var catItem = CATALOGUE_DATA.find(function(i) { return i.id === entry.catalogue_item_id; });
            return {
                entry: entry,
                catItem: catItem,
                label: catItem ? (catItem.client_text || catItem.description || entry.catalogue_item_id) : (entry.description || entry.catalogue_item_id),
                price: catItem ? catItem.price : null
            };
        });

        return new Promise(function(resolve) {
            var overlay = document.createElement('div');
            overlay.className = 'constraint-modal-overlay';
            var modal = document.createElement('div');
            modal.className = 'constraint-modal';
            modal.style.maxWidth = '480px';

            modal.innerHTML = '<h3 style="margin:0 0 4px;">Mat\u00e9riau par d\u00e9faut : ' + escapeHtml(groupName) + '</h3>'
                + '<p style="font-size:12px;color:#666;margin:0 0 12px;">Plusieurs mat\u00e9riaux par d\u00e9faut sont configur\u00e9s pour ce type. Lequel utiliser ?</p>';

            var selectedId = null;
            var list = document.createElement('div');
            list.style.cssText = 'max-height:260px; overflow-y:auto; margin:0 0 12px;';

            enriched.forEach(function(e) {
                var priceText = e.price != null ? formatPrice(e.price) : '';
                var btn = document.createElement('div');
                btn.style.cssText = 'display:flex; align-items:center; gap:10px; padding:10px 12px; margin:4px 0; border:1px solid #e0e0e0; border-radius:8px; background:#fff; cursor:pointer; font-size:13px; transition:all 0.15s;';
                var radio = '<div style="width:16px;height:16px;border-radius:50%;border:2px solid #cbd5e1;flex-shrink:0;" class="dm-radio"></div>';
                btn.innerHTML = radio
                    + '<div style="flex:1;min-width:0;">'
                    + '<div><strong>' + escapeHtml(e.entry.catalogue_item_id) + '</strong> \u2014 ' + escapeHtml(e.label) + '</div>'
                    + (priceText ? '<div style="font-size:11px;color:#888;">' + priceText + '/' + escapeHtml(e.catItem ? (e.catItem.type || 'unit\u00e9') : 'unit\u00e9') + '</div>' : '')
                    + '</div>';
                btn.onmouseover = function() { if (selectedId !== e.entry.catalogue_item_id) btn.style.background = '#f8fafc'; };
                btn.onmouseout = function() { if (selectedId !== e.entry.catalogue_item_id) btn.style.background = '#fff'; };
                btn.onclick = function() {
                    selectedId = e.entry.catalogue_item_id;
                    list.querySelectorAll('.dm-radio').forEach(function(r) {
                        r.style.cssText = 'width:16px;height:16px;border-radius:50%;border:2px solid #cbd5e1;flex-shrink:0;';
                    });
                    list.querySelectorAll('[data-dm-row]').forEach(function(r) { r.style.background = '#fff'; r.style.borderColor = '#e0e0e0'; });
                    btn.querySelector('.dm-radio').style.cssText = 'width:16px;height:16px;border-radius:50%;border:2px solid var(--sw-navy, #0B1220);background:var(--sw-navy, #0B1220);flex-shrink:0;box-shadow:inset 0 0 0 3px #fff;';
                    btn.style.background = '#f0f4ff';
                    btn.style.borderColor = 'var(--sw-navy, #0B1220)';
                    confirmBtn.disabled = false;
                    confirmBtn.style.opacity = '1';
                };
                btn.setAttribute('data-dm-row', '1');
                list.appendChild(btn);
            });
            modal.appendChild(list);

            var rememberDiv = document.createElement('div');
            rememberDiv.style.cssText = 'display:flex;align-items:center;gap:6px;margin:0 0 14px;font-size:12px;color:#666;';
            var rememberCb = document.createElement('input');
            rememberCb.type = 'checkbox';
            rememberCb.checked = true;
            rememberCb.style.cssText = 'width:14px;height:14px;accent-color:var(--sw-navy, #0B1220);';
            rememberDiv.appendChild(rememberCb);
            var rememberLabel = document.createElement('span');
            rememberLabel.textContent = 'M\u00e9moriser pour cette pi\u00e8ce';
            rememberDiv.appendChild(rememberLabel);
            modal.appendChild(rememberDiv);

            var actions = document.createElement('div');
            actions.style.cssText = 'display:flex;justify-content:flex-end;gap:8px;';

            var cancelBtn = document.createElement('button');
            cancelBtn.className = 'cm-btn-secondary';
            cancelBtn.textContent = 'Annuler';
            cancelBtn.onclick = function() { overlay.remove(); resolve(null); };
            actions.appendChild(cancelBtn);

            var confirmBtn = document.createElement('button');
            confirmBtn.style.cssText = 'padding:7px 18px;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;border:none;background:var(--sw-navy, #0B1220);color:#fff;opacity:0.4;';
            confirmBtn.textContent = 'Confirmer';
            confirmBtn.disabled = true;
            confirmBtn.onclick = function() {
                overlay.remove();
                resolve({ itemId: selectedId, remember: rememberCb.checked });
            };
            actions.appendChild(confirmBtn);
            modal.appendChild(actions);

            overlay.appendChild(modal);
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) { overlay.remove(); resolve(null); }
            });
            document.body.appendChild(overlay);
        });
    }

    /**
     * Re-trigger cascades on all parent rows that use $default: for the given group.
     * Called when a default material changes (dmSelectItem, removeDmEntry, updateDmType).
     */
    async function reprocessDefaultCascades(changedGroup, scopeGroupId) {
        if (!changedGroup) return;
        var token = '$default:' + changedGroup;
        // Scope: if scopeGroupId provided, only reprocess rows in that room;
        // if submission-level change, reprocess rooms that use fallback (no room-level DM)
        var selector = scopeGroupId
            ? '#' + scopeGroupId + ' .calc-row:not(.cascade-child)'
            : '.calc-row:not(.cascade-child)';
        var rowIds = [];
        document.querySelectorAll(selector).forEach(function(row) {
            // For submission-level changes, skip rooms that have their own DM
            if (!scopeGroupId) {
                var rowGroupId = row.dataset.group;
                var rdm = roomDM[rowGroupId];
                if (rdm && rdm.length > 0) return; // room has its own DM, not affected
            }
            var select = row.querySelector('.item-select');
            if (!select || !select.value) return;
            var catItem = CATALOGUE_DATA.find(function(i) { return i.id === select.value; });
            if (!catItem || !catItem.calculation_rule_ai || !catItem.calculation_rule_ai.cascade) return;
            var hasDynamic = catItem.calculation_rule_ai.cascade.some(function(c) {
                return c.target === token;
            });
            if (hasDynamic) rowIds.push(row.id);
        });
        // Execute cascades sequentially (each executeCascade handles orphan cleanup)
        for (var i = 0; i < rowIds.length; i++) {
            await executeCascade(rowIds[i], 0);
        }
    }

    /**
     * Moteur cascade récursif.
     * Exécute les règles `cascade` du calculation_rule_ai de l'article sélectionné.
     * Crée/met à jour/supprime les lignes enfants automatiquement.
     */
    async function executeCascade(parentRowId, depth) {
        depth = depth || 0;
        if (depth >= 3) { console.log('[CASCADE] max depth reached for', parentRowId); return; }
        console.log('[CASCADE] itemMap check:', parentRowId, '→', itemMap[parentRowId] || 'MISSING');
        if (!itemMap[parentRowId]) { console.log('[CASCADE] no itemMap for', parentRowId); return; }

        var row = document.getElementById(parentRowId);
        if (!row) return;
        var select = row.querySelector('.item-select');
        var qtyInput = row.querySelector('.qty-input');
        if (!select || !qtyInput) return;

        var selectedId = select.value;
        var catItem = CATALOGUE_DATA.find(function(i) { return i.id === selectedId; });
        var rules = catItem && catItem.calculation_rule_ai && catItem.calculation_rule_ai.cascade;
        console.log('[CASCADE] executeCascade:', selectedId, 'rules:', rules ? rules.length : 0, 'depth:', depth);
        if (!rules || !Array.isArray(rules) || rules.length === 0) {
            // Pas de règles cascade → supprimer les enfants existants
            var orphans = findCascadeChildren(parentRowId);
            orphans.forEach(function(c) { removeRow(c.rowId); });
            return;
        }

        // Dimensions : si ce row a ses propres dims, les utiliser ; sinon remonter la chaîne
        var dims = getRootDimsForCascade(parentRowId);
        // Si c'est un row avec dims propres (fabrication), les utiliser directement
        var ownL = document.getElementById(parentRowId + '-dim-l');
        if (ownL) {
            dims.L = parseFloat(ownL.value) || 0;
            var ownH = document.getElementById(parentRowId + '-dim-h');
            dims.H = ownH ? (parseFloat(ownH.value) || 0) : dims.H;
            var ownP = document.getElementById(parentRowId + '-dim-p');
            dims.P = ownP ? (parseFloat(ownP.value) || 0) : dims.P;
        }
        var parentQty = parseFloat(qtyInput.value) || 0;
        // Caisson fields: read from parent row (override root dims if present)
        var parentNTab = document.getElementById(parentRowId + '-n-tab');
        var parentNPart = document.getElementById(parentRowId + '-n-part');
        var vars = {
            L: dims.L, H: dims.H, P: dims.P, QTY: parentQty,
            n_tablettes: parentNTab ? (parseInt(parentNTab.value) || 0) : (dims.n_tablettes || 0),
            n_partitions: parentNPart ? (parseInt(parentNPart.value) || 0) : (dims.n_partitions || 0)
        };
        console.log('[CASCADE] vars:', JSON.stringify(vars));

        // Au moins une dimension doit exister pour exécuter la cascade
        if (dims.L === 0 && dims.H === 0 && dims.P === 0 && parentQty === 0) {
            console.log('[CASCADE] skipped: all dims+qty = 0');
            return;
        }

        var groupId = row.dataset.group;
        var parentItemId = itemMap[parentRowId];
        var existingChildren = findCascadeChildren(parentRowId);

        // Separate locked children — invisible to the cascade engine
        var activeChildren = [];
        existingChildren.forEach(function(c) {
            var childEl = document.getElementById(c.rowId);
            if (childEl && childEl.classList.contains('cascade-locked')) {
                // Locked: skip entirely (no update, no delete, no duplicate)
            } else {
                activeChildren.push(c);
            }
        });
        var matchedChildRowIds = [];

        // Tag du parent à hériter
        var parentTagEl = document.getElementById(parentRowId + '-tag');
        var parentTag = parentTagEl ? parentTagEl.value : '';

        // Track insertion point: start after last existing child (locked or active)
        var lastInsertedRowId = parentRowId;
        existingChildren.forEach(function(c) {
            if (document.getElementById(c.rowId)) lastInsertedRowId = c.rowId;
        });

        for (var ri = 0; ri < rules.length; ri++) {
            var rule = rules[ri];
            if (!rule.target) continue; // target null = AI (pas JS)

            // For dynamic targets, reuse existing child if it already satisfies the rule (skip popup)
            var resolvedTarget = null;
            if (rule.target.startsWith('$default:') || rule.target.startsWith('$match:')) {
                resolvedTarget = findExistingChildForDynamicRule(rule.target, groupId, activeChildren, matchedChildRowIds);
            }
            if (!resolvedTarget) {
                resolvedTarget = await resolveCascadeTarget(rule.target, groupId);
            }
            if (!resolvedTarget) {
                if (rule.target.startsWith('$default:'))
                    showConstraintToast('Aucun matériau par défaut pour : ' + rule.target.substring(9));
                else if (rule.target.startsWith('$match:'))
                    showConstraintToast('Aucun article trouvé pour cascade : ' + rule.target.substring(7));
                continue;
            }

            // Évaluer la condition
            if (rule.condition) {
                var condResult = evalFormula(rule.condition, vars);
                if (!condResult) continue;
            }

            // Calculer la quantité
            var qty = evalFormula(rule.qty, vars);
            if (qty === null || qty <= 0) continue;
            qty = Math.round(qty * 100) / 100; // arrondir à 2 décimales

            // Chercher un enfant ACTIF existant avec le même target (skip locked)
            var existing = null;
            for (var ei = 0; ei < activeChildren.length; ei++) {
                if (activeChildren[ei].catalogueId === resolvedTarget) {
                    existing = activeChildren[ei];
                    break;
                }
            }

            if (existing) {
                // Mettre à jour la quantité de l'enfant existant
                var childRow = document.getElementById(existing.rowId);
                if (childRow) {
                    var childQty = childRow.querySelector('.qty-input');
                    if (childQty && parseFloat(childQty.value) !== qty) {
                        childQty.value = qty;
                        updateRow(existing.rowId);
                    }
                    // Sync tag from parent
                    var childTagSync = document.getElementById(existing.rowId + '-tag');
                    if (childTagSync && childTagSync.value !== parentTag) {
                        childTagSync.value = parentTag;
                        if (itemMap[existing.rowId]) updateItem(itemMap[existing.rowId], { tag: parentTag || null });
                    }
                }
                matchedChildRowIds.push(existing.rowId);
                lastInsertedRowId = existing.rowId;
            } else {
                // Créer une nouvelle ligne enfant — insert after parent/last sibling
                var newRowId = addRow(groupId, { skipFocus: true, cascade: true, afterRowId: lastInsertedRowId });

                // Attendre que itemMap soit peuplé (async createItem)
                var waitAttempts = 0;
                while (!itemMap[newRowId] && waitAttempts < 50) {
                    await new Promise(function(r) { setTimeout(r, 80); });
                    waitAttempts++;
                }
                if (!itemMap[newRowId]) {
                    console.error('[Cascade] Timeout création ligne pour', resolvedTarget, '(rule:', rule.target, ')');
                    continue;
                }

                // Enregistrer le lien parent
                cascadeParentMap[newRowId] = parentRowId;
                updateItem(itemMap[newRowId], { parent_item_id: parentItemId });

                // Sélectionner l'article cible
                var childRow2 = document.getElementById(newRowId);
                var childSelect = childRow2 ? childRow2.querySelector('.item-select') : null;
                if (childSelect) childSelect.value = resolvedTarget;
                var childQtyInput = childRow2 ? childRow2.querySelector('.qty-input') : null;
                if (childQtyInput) childQtyInput.value = qty;

                // Hériter le tag du parent (toujours, même si vide)
                var childTagInput = document.getElementById(newRowId + '-tag');
                if (childTagInput) childTagInput.value = parentTag;

                updateRow(newRowId);
                matchedChildRowIds.push(newRowId);
                lastInsertedRowId = newRowId;
            }
        }

        // Supprimer les enfants orphelins (seulement actifs, pas les locked)
        activeChildren.forEach(function(c) {
            if (matchedChildRowIds.indexOf(c.rowId) === -1) {
                removeRow(c.rowId);
            }
        });

        // Persist sort_order to match DOM order
        syncSortOrderForGroup(groupId);

        // Récursion : chaque enfant peut avoir ses propres règles cascade
        for (var ci = 0; ci < matchedChildRowIds.length; ci++) {
            await executeCascade(matchedChildRowIds[ci], depth + 1);
        }
    }

    /** Revert a cascade-locked child back to auto-managed mode. */
    async function revertCascadeLock(rowId) {
        var row = document.getElementById(rowId);
        if (!row) return;

        // Unlock in DB
        if (itemMap[rowId]) {
            await updateItem(itemMap[rowId], { cascade_locked: false });
        }

        // Remove locked state
        row.classList.remove('cascade-locked');
        delete row.dataset.cascadeOriginalTarget;

        // Re-execute parent cascade — this row won't match → orphan → deleted → correct one recreated
        var parentRowId = cascadeParentMap[rowId];
        if (parentRowId) {
            await executeCascade(parentRowId, 0);
        }
    }

    var _pendingCascadeRowId = null;

    function runCascadeNow(rowId) {
        _cascadeRunning = true;
        _pendingCascadeRowId = null;
        executeCascade(rowId, 0).catch(function(err) {
            console.error('[CASCADE] ERROR:', err);
        }).finally(function() {
            _cascadeRunning = false;
            // If a cascade was queued while we were running, execute it now
            if (_pendingCascadeRowId) {
                var pending = _pendingCascadeRowId;
                runCascadeNow(pending);
            }
        });
    }

    var _cascadePendingTimer = null;

    /**
     * Schedule a cascade execution.
     * @param {string} rowId — parent row to cascade
     * @param {boolean} [immediate=false] — if true, run immediately (bypass debounce)
     */
    function scheduleCascade(rowId, immediate) {
        // During active cascade, drop all external triggers — the cascade engine
        // handles its own recursion via executeCascade(child, depth+1) at L3375.
        // This prevents infinite loops where updateRow(child) → scheduleCascade → parent.
        if (_cascadeRunning || _isLoadingSubmission) return;

        // Check eligibility: row must have cascade rules or existing children
        var row = document.getElementById(rowId);
        if (!row) return;
        var sel = row.querySelector('.item-select');
        var selVal = sel ? sel.value : '';
        if (!selVal || selVal === '__PROPOSER__' || selVal === '__AJOUT__') return;
        var catItem = CATALOGUE_DATA.find(function(i) { return i.id === selVal; });
        var hasRules = catItem && catItem.calculation_rule_ai && catItem.calculation_rule_ai.cascade;
        if (!hasRules && findCascadeChildren(rowId).length === 0) return;

        if (_cascadePendingTimer) {
            clearTimeout(_cascadePendingTimer);
            _cascadePendingTimer = null;
        }
        if (immediate) {
            runCascadeNow(rowId);
        } else {
            _cascadePendingTimer = setTimeout(function() {
                _cascadePendingTimer = null;
                if (_cascadeRunning) return;
                runCascadeNow(rowId);
            }, 400);
        }
    }

    // ═══════════════════════════════════════════
    // ── Constraint engine (auto_add, requires_swap, requires_choice) ──
    // ═══════════════════════════════════════════

    /**
     * Show a temporary toast at the bottom of the screen.
     * @param {string} msg — message to display
     * @param {number} [duration=3000] — ms before auto-hide
     */
    function showConstraintToast(msg, duration) {
        var existing = document.querySelector('.constraint-toast');
        if (existing) existing.remove();
        var t = document.createElement('div');
        t.className = 'constraint-toast';
        t.textContent = msg;
        document.body.appendChild(t);
        setTimeout(function() {
            t.classList.add('ct-out');
            t.addEventListener('animationend', function() { t.remove(); });
        }, duration || 3000);
    }

    /**
     * Find all catalogue item IDs currently present in a given room group.
     * Returns a Set of catalogue item IDs.
     */
    function getRoomCatalogueIds(groupId) {
        var ids = new Set();
        var container = document.getElementById(groupId + '-rows');
        if (!container) return ids;
        container.querySelectorAll('.calc-row').forEach(function(row) {
            var sel = row.querySelector('.item-select');
            if (sel && sel.value && sel.value !== '__PROPOSER__' && sel.value !== '__AJOUT__') {
                ids.add(sel.value);
            }
        });
        return ids;
    }

    /**
     * Handle auto_add constraint: add a linked item with fixed quantity.
     * If the item is already in the room, show a toast and skip.
     */
    async function handleAutoAdd(rule, groupId, sourceRowId) {
        if (!rule.item_id) return;

        // Check if item already exists in the room
        var existingIds = getRoomCatalogueIds(groupId);
        if (existingIds.has(rule.item_id)) {
            var dupeItem = CATALOGUE_DATA.find(function(i) { return i.id === rule.item_id; });
            var dupeName = dupeItem ? (dupeItem.client_text || dupeItem.description) : rule.item_id;
            showConstraintToast(dupeName + ' — déjà présent dans cette pièce');
            return;
        }

        // Create a new standalone row
        var newRowId = addRow(groupId, { skipFocus: true });

        // Wait for itemMap to be populated (async createItem)
        var waitAttempts = 0;
        while (!itemMap[newRowId] && waitAttempts < 50) {
            await new Promise(function(r) { setTimeout(r, 80); });
            waitAttempts++;
        }
        if (!itemMap[newRowId]) {
            console.error('[Constraint] Timeout creating row for', rule.item_id);
            return;
        }

        // Select the target catalogue item
        var newRow = document.getElementById(newRowId);
        var newSelect = newRow ? newRow.querySelector('.item-select') : null;
        if (newSelect) newSelect.value = rule.item_id;

        // Set quantity
        var newQty = newRow ? newRow.querySelector('.qty-input') : null;
        if (newQty) newQty.value = rule.quantity || 1;

        // Inherit tag from source row
        var srcTag = document.getElementById(sourceRowId + '-tag');
        if (srcTag && srcTag.value) {
            var newTag = document.getElementById(newRowId + '-tag');
            if (newTag) newTag.value = srcTag.value;
        }

        // Visual indicator
        newRow.classList.add('constraint-added');

        // Update the row (triggers price calc, display, save)
        updateRow(newRowId);

        // Toast
        showConstraintToast(rule.message || 'Article ajouté automatiquement');
    }

    /**
     * Handle auto_add_calculated constraint: add a linked item with formula-based quantity.
     * Uses evalFormula() with L/H/P/QTY from the source row dimensions.
     * If dimensions are not available, adds the item with qty 0 + warning.
     */
    async function handleAutoAddCalculated(rule, groupId, sourceRowId) {
        if (!rule.item_id) return;

        // Check if item already exists in the room
        var existingIds = getRoomCatalogueIds(groupId);
        if (existingIds.has(rule.item_id)) {
            var dupeItem = CATALOGUE_DATA.find(function(i) { return i.id === rule.item_id; });
            var dupeName = dupeItem ? (dupeItem.client_text || dupeItem.description) : rule.item_id;
            showConstraintToast(dupeName + ' — déjà présent dans cette pièce');
            return;
        }

        // Gather dimensions from source row
        var dimL = document.getElementById(sourceRowId + '-dim-l');
        var dimH = document.getElementById(sourceRowId + '-dim-h');
        var dimP = document.getElementById(sourceRowId + '-dim-p');
        var srcQty = document.getElementById(sourceRowId)?.querySelector('.qty-input');
        var vars = {
            L: dimL ? (parseFloat(dimL.value) || 0) : 0,
            H: dimH ? (parseFloat(dimH.value) || 0) : 0,
            P: dimP ? (parseFloat(dimP.value) || 0) : 0,
            QTY: srcQty ? (parseFloat(srcQty.value) || 0) : 0
        };

        var hasDims = vars.L > 0 || vars.H > 0 || vars.P > 0;
        var qty = 0;
        var warning = null;

        if (hasDims && rule.quantity_formula) {
            qty = evalFormula(rule.quantity_formula, vars);
            if (qty === null || qty < 0) qty = 0;
            qty = Math.round(qty * 100) / 100;
        }

        if (!hasDims || qty === 0) {
            warning = 'Quantité à ajuster selon les dimensions';
            if (rule.quantity_formula) warning += ' (formule : ' + rule.quantity_formula + ')';
        }

        // Create the row
        var newRowId = addRow(groupId, { skipFocus: true });
        var waitAttempts = 0;
        while (!itemMap[newRowId] && waitAttempts < 50) {
            await new Promise(function(r) { setTimeout(r, 80); });
            waitAttempts++;
        }
        if (!itemMap[newRowId]) {
            console.error('[Constraint] Timeout creating row for', rule.item_id);
            return;
        }

        var newRow = document.getElementById(newRowId);
        var newSelect = newRow ? newRow.querySelector('.item-select') : null;
        if (newSelect) newSelect.value = rule.item_id;
        var newQty = newRow ? newRow.querySelector('.qty-input') : null;
        if (newQty) newQty.value = qty;

        // Inherit tag
        var srcTag = document.getElementById(sourceRowId + '-tag');
        if (srcTag && srcTag.value) {
            var newTag = document.getElementById(newRowId + '-tag');
            if (newTag) newTag.value = srcTag.value;
        }

        newRow.classList.add('constraint-added');
        updateRow(newRowId);

        // Show warning if dimensions were missing
        if (warning) {
            addConstraintWarning(newRowId, warning);
            showConstraintToast(warning);
        } else {
            showConstraintToast(rule.message || 'Article ajouté automatiquement');
        }
    }

    /**
     * Add a ⚠️ warning indicator on a row with tooltip message.
     */
    function addConstraintWarning(rowId, message) {
        var row = document.getElementById(rowId);
        if (!row) return;
        // Remove existing warning if any
        var existing = row.querySelector('.constraint-warn');
        if (existing) existing.remove();
        // Add warning after the combobox
        var comboDiv = row.querySelector('.cell-select');
        if (!comboDiv) return;
        var warn = document.createElement('span');
        warn.className = 'constraint-warn';
        warn.innerHTML = '⚠️<span class="cw-tip">' + escapeHtml(message) + '</span>';
        comboDiv.appendChild(warn);
    }

    /**
     * Remove ⚠️ warning indicator from a row.
     */
    function removeConstraintWarning(rowId) {
        var row = document.getElementById(rowId);
        if (!row) return;
        var warn = row.querySelector('.constraint-warn');
        if (warn) warn.remove();
    }

    /**
     * Show a constraint modal (for requires_swap and requires_choice).
     * Returns a Promise that resolves to the button key clicked.
     */
    function showConstraintModal(title, message, buttons) {
        return new Promise(function(resolve) {
            var overlay = document.createElement('div');
            overlay.className = 'constraint-modal-overlay';
            var modal = document.createElement('div');
            modal.className = 'constraint-modal';
            modal.innerHTML = '<h3>' + escapeHtml(title) + '</h3>'
                + '<p>' + escapeHtml(message) + '</p>';
            var actions = document.createElement('div');
            actions.className = 'constraint-modal-actions';
            buttons.forEach(function(btn) {
                var b = document.createElement('button');
                b.className = btn.primary ? 'cm-btn-primary' : 'cm-btn-secondary';
                b.textContent = btn.label;
                b.onclick = function() {
                    overlay.remove();
                    resolve(btn.key);
                };
                actions.appendChild(b);
            });
            modal.appendChild(actions);
            overlay.appendChild(modal);
            // Close on overlay click (outside modal)
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) { overlay.remove(); resolve('dismiss'); }
            });
            document.body.appendChild(overlay);
        });
    }

    /**
     * Find items in a room that belong to a given material group (via category_group_mapping).
     * Returns array of { rowId, catalogueId, catItem, description }.
     */
    function findRoomItemsByGroup(groupId, targetGroup) {
        var allowedCats = getAllowedCategoriesForGroup(targetGroup);
        if (!allowedCats) return [];
        var results = [];
        var container = document.getElementById(groupId + '-rows');
        if (!container) return results;
        container.querySelectorAll('.calc-row').forEach(function(row) {
            var sel = row.querySelector('.item-select');
            if (!sel || !sel.value || sel.value === '__PROPOSER__' || sel.value === '__AJOUT__') return;
            var catItem = CATALOGUE_DATA.find(function(i) { return i.id === sel.value; });
            if (!catItem) return;
            if (allowedCats.indexOf(catItem.category) !== -1) {
                results.push({
                    rowId: row.id,
                    catalogueId: sel.value,
                    catItem: catItem,
                    description: (catItem.description || '').toLowerCase()
                });
            }
        });
        return results;
    }

    /**
     * Handle requires_swap constraint: verify that an item in the room matches criteria.
     * If not, propose a swap via modal. If user declines, add ⚠️ warning.
     */
    async function handleRequiresSwap(rule, groupId, sourceRowId) {
        if (!rule.target_group || !rule.current_must_match) return;

        // Find items in the room that belong to target_group
        var targetItems = findRoomItemsByGroup(groupId, rule.target_group);
        if (targetItems.length === 0) return; // No item of that group → nothing to check

        var mustMatch = rule.current_must_match.toLowerCase();
        var searchIn = rule.search_in || 'description';

        // Check if any target item already matches
        var allMatch = true;
        var nonMatchingItems = [];
        targetItems.forEach(function(ti) {
            var fieldValue = '';
            if (searchIn === 'description') fieldValue = ti.description;
            else if (searchIn === 'client_text') fieldValue = ((ti.catItem.client_text || '') + ' ' + ti.description).toLowerCase();
            else fieldValue = ti.description;

            if (fieldValue.indexOf(mustMatch) === -1) {
                allMatch = false;
                nonMatchingItems.push(ti);
            }
        });

        if (allMatch) return; // All items match → no issue

        // Find replacement candidates in catalogue
        for (var ni = 0; ni < nonMatchingItems.length; ni++) {
            var nonMatch = nonMatchingItems[ni];
            var replacement = null;

            if (rule.swap_logic === 'same_client_text_with_match') {
                var originalClientText = (nonMatch.catItem.client_text || '').toLowerCase();
                if (originalClientText) {
                    replacement = CATALOGUE_DATA.find(function(c) {
                        if (c.id === nonMatch.catalogueId) return false;
                        var cClientText = (c.client_text || '').toLowerCase();
                        var cDesc = (c.description || '').toLowerCase();
                        return cClientText === originalClientText && cDesc.indexOf(mustMatch) !== -1;
                    });
                }
            }

            var currentName = nonMatch.catItem.client_text || nonMatch.catItem.description;
            var replacementName = replacement ? (replacement.client_text || replacement.description) : null;

            var buttons = [];
            if (replacement) {
                buttons.push({ key: 'swap', label: 'Remplacer par ' + replacementName, primary: true });
            }
            buttons.push({ key: 'keep', label: 'Garder quand même', primary: false });

            var result = await showConstraintModal(
                'Compatibilité matériaux',
                rule.warning || ('L\'article « ' + currentName + ' » pourrait être incompatible.'),
                buttons
            );

            if (result === 'swap' && replacement) {
                // Perform the swap: change the item in the existing row
                var swapRow = document.getElementById(nonMatch.rowId);
                var swapSelect = swapRow ? swapRow.querySelector('.item-select') : null;
                if (swapSelect) {
                    swapSelect.value = replacement.id;
                    // Reset constraintsProcessed so new item's own constraints can fire
                    swapRow.dataset.constraintsProcessed = '';
                    updateRow(nonMatch.rowId);
                    removeConstraintWarning(nonMatch.rowId);
                    showConstraintToast('Remplacé par ' + replacementName);
                }
            } else if (result === 'keep' || result === 'dismiss') {
                // Add warning indicator on the non-matching row
                addConstraintWarning(nonMatch.rowId, rule.warning || 'Compatibilité non vérifiée');
            }
        }
    }

    /**
     * Handle requires_choice constraint: verify conditions and restrict/warn about items in a group.
     * If an incompatible item exists in the target group, show modal.
     * Stores active restrictions for future combobox filtering.
     */
    async function handleRequiresChoice(rule, groupId, sourceRowId) {
        if (!rule.target_group || !rule.conditions || !Array.isArray(rule.conditions)) return;

        // Determine which condition matches the source item
        var sourceRow = document.getElementById(sourceRowId);
        var sourceSelect = sourceRow ? sourceRow.querySelector('.item-select') : null;
        var sourceId = sourceSelect ? sourceSelect.value : '';
        var sourceCatItem = CATALOGUE_DATA.find(function(i) { return i.id === sourceId; });
        if (!sourceCatItem) return;
        var sourceDesc = (sourceCatItem.description || '').toLowerCase();

        var activeCondition = null;
        for (var ci = 0; ci < rule.conditions.length; ci++) {
            var cond = rule.conditions[ci];
            if (cond.if_description_contains && sourceDesc.indexOf(cond.if_description_contains.toLowerCase()) !== -1) {
                activeCondition = cond;
                break;
            }
        }
        if (!activeCondition) return; // No condition matched

        // Check existing items in the target group for compatibility
        var targetItems = findRoomItemsByGroup(groupId, rule.target_group);
        var restrictPatterns = activeCondition.restrict_to.toLowerCase().split('|');

        for (var ti = 0; ti < targetItems.length; ti++) {
            var target = targetItems[ti];
            var targetDesc = target.description;
            var isCompatible = restrictPatterns.some(function(pat) { return targetDesc.indexOf(pat) !== -1; });

            if (!isCompatible) {
                // Find a compatible replacement
                var allowedCats = getAllowedCategoriesForGroup(rule.target_group);
                var replacement = null;
                if (allowedCats) {
                    var originalClientText = (target.catItem.client_text || '').toLowerCase();
                    replacement = CATALOGUE_DATA.find(function(c) {
                        if (c.id === target.catalogueId) return false;
                        if (allowedCats.indexOf(c.category) === -1) return false;
                        var cDesc = (c.description || '').toLowerCase();
                        var matches = restrictPatterns.some(function(pat) { return cDesc.indexOf(pat) !== -1; });
                        if (!matches) return false;
                        // Prefer same client_text
                        if (originalClientText) {
                            return (c.client_text || '').toLowerCase() === originalClientText;
                        }
                        return true;
                    });
                }

                var targetName = target.catItem.client_text || target.catItem.description;
                var replacementName = replacement ? (replacement.client_text || replacement.description) : null;

                var buttons = [];
                if (replacement) {
                    buttons.push({ key: 'swap', label: 'Remplacer par ' + replacementName, primary: true });
                }
                buttons.push({ key: 'keep', label: 'Garder quand même', primary: false });

                var result = await showConstraintModal(
                    'Choix requis',
                    activeCondition.message || ('L\'article « ' + targetName + ' » pourrait être incompatible.'),
                    buttons
                );

                if (result === 'swap' && replacement) {
                    var swapRow = document.getElementById(target.rowId);
                    var swapSelect = swapRow ? swapRow.querySelector('.item-select') : null;
                    if (swapSelect) {
                        swapSelect.value = replacement.id;
                        swapRow.dataset.constraintsProcessed = '';
                        updateRow(target.rowId);
                        removeConstraintWarning(target.rowId);
                        showConstraintToast('Remplacé par ' + replacementName);
                    }
                } else if (result === 'keep' || result === 'dismiss') {
                    addConstraintWarning(target.rowId, activeCondition.message || 'Choix possiblement incompatible');
                }
            }
        }
    }

    /**
     * Process all constraints on a catalogue item when it is first selected.
     * Called from updateRow() — only fires once per item selection (tracked via dataset).
     */
    async function processConstraints(rowId) {
        var row = document.getElementById(rowId);
        if (!row) return;
        var select = row.querySelector('.item-select');
        if (!select) return;
        var selectedId = select.value;
        if (!selectedId || selectedId === '__PROPOSER__' || selectedId === '__AJOUT__') return;

        // Only process once per item selection
        if (row.dataset.constraintsProcessed === selectedId) return;
        row.dataset.constraintsProcessed = selectedId;

        // Don't process constraints on cascade children (they are auto-managed)
        if (row.classList.contains('cascade-child')) return;

        // Don't process if submission is not editable
        if (typeof isSubmissionCurrentlyEditable === 'function' && !isSubmissionCurrentlyEditable()) return;

        var catItem = CATALOGUE_DATA.find(function(i) { return i.id === selectedId; });
        if (!catItem || !catItem.calculation_rule_ai) return;

        var constraints = catItem.calculation_rule_ai.constraints;
        if (!constraints || !Array.isArray(constraints) || constraints.length === 0) return;

        var groupId = row.dataset.group;

        for (var i = 0; i < constraints.length; i++) {
            var rule = constraints[i];
            switch (rule.type) {
                case 'auto_add':
                    await handleAutoAdd(rule, groupId, rowId);
                    break;
                case 'auto_add_calculated':
                    await handleAutoAddCalculated(rule, groupId, rowId);
                    break;
                case 'requires_swap':
                    await handleRequiresSwap(rule, groupId, rowId);
                    break;
                case 'requires_choice':
                    await handleRequiresChoice(rule, groupId, rowId);
                    break;
            }
        }
    }

    async function createVersion(submissionId) {
        // Trouver le prochain numéro de version (par project_id pour respecter la contrainte unique)
        var versionQuery = currentProject
            ? SUPABASE_URL + '/rest/v1/project_versions?project_id=eq.' + currentProject.id + '&order=version_number.desc&limit=1&select=version_number'
            : SUPABASE_URL + '/rest/v1/project_versions?submission_id=eq.' + submissionId + '&order=version_number.desc&limit=1&select=version_number';
        const r = await authenticatedFetch(versionQuery, {});
        let nextVersion = 1;
        if (r.ok) {
            const data = await r.json();
            if (data.length > 0) nextVersion = data[0].version_number + 1;
        }

        const snapshot = collecterDonneesCalculateur();
        const userId = localStorage.getItem('sb_user_id');

        var projectId = currentProject ? currentProject.id : (currentSubmission ? currentSubmission.project_id : null);
        var payload = {
            submission_id: submissionId,
            project_id: projectId,
            version_number: nextVersion,
            snapshot: snapshot,
            status_at_save: currentSubmission ? currentSubmission.status : 'draft',
            created_by: userId
        };

        var vr = await authenticatedFetch(SUPABASE_URL + '/rest/v1/project_versions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
            body: JSON.stringify(payload)
        });
        if (!vr.ok) {
            var errText = await vr.text().catch(function() { return ''; });
            console.error('createVersion failed:', vr.status, errText);
            throw new Error('Erreur version: ' + vr.status + ' ' + errText);
        }

        // Update current_version on submission
        await updateSubmission(submissionId, { current_version: nextVersion });
        if (currentSubmission) currentSubmission.current_version = nextVersion;
    }

    // ═══════════════════════════════════════════════════════════════════════
    // REFRESH AUTOMATIQUE DU TOKEN
    // ═══════════════════════════════════════════════════════════════════════

    var _refreshPromise = null;

    function isTokenExpiringSoon(token, bufferSec) {
        if (!token) return true;
        try { var p = JSON.parse(atob(token.split('.')[1])); return p.exp < (Date.now() / 1000 + (bufferSec || 300)); }
        catch(e) { return true; }
    }

    function _tokenDebug(token) {
        if (!token) return 'null';
        try { var p = JSON.parse(atob(token.split('.')[1])); var ttl = Math.round(p.exp - Date.now() / 1000); return 'exp in ' + ttl + 's'; }
        catch(e) { return 'invalid'; }
    }

    async function refreshAccessToken() {
        if (_refreshPromise) { console.log('[auth] Refresh already in progress, reusing promise'); return _refreshPromise; }
        _refreshPromise = (async function() {
            var rt = localStorage.getItem('sb_refresh_token');
            if (!rt) { console.warn('[auth] No refresh token in localStorage'); return false; }
            try {
                var r = await fetch(SUPABASE_URL + '/auth/v1/token?grant_type=refresh_token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'apikey': SUPABASE_KEY },
                    body: JSON.stringify({ refresh_token: rt })
                });
                if (!r.ok) {
                    var errBody = await r.text().catch(function() { return ''; });
                    console.warn('[auth] Refresh failed:', r.status, errBody.substring(0, 200));
                    return false;
                }
                var d = await r.json();
                if (d.access_token) {
                    localStorage.setItem('sb_access_token', d.access_token);
                    localStorage.setItem('sb_refresh_token', d.refresh_token);
                    console.log('[auth] Token refreshed OK —', _tokenDebug(d.access_token));
                    return true;
                }
                console.warn('[auth] Refresh response missing access_token');
                return false;
            } catch(e) { console.warn('[auth] Refresh exception:', e.message); return false; }
        })();
        var result = await _refreshPromise;
        _refreshPromise = null;
        return result;
    }

    async function authenticatedFetch(url, options) {
        options = options || {};
        var token = localStorage.getItem('sb_access_token');
        var endpoint = url.split('/').pop().split('?')[0];

        // Proactive refresh if token expires within 5 minutes
        if (isTokenExpiringSoon(token, 300)) {
            console.log('[auth]', endpoint, '— token expiring soon (' + _tokenDebug(token) + '), refreshing...');
            if (await refreshAccessToken()) token = localStorage.getItem('sb_access_token');
        }

        var headers = Object.assign({}, options.headers || {}, {
            'apikey': SUPABASE_KEY,
            'Authorization': 'Bearer ' + token
        });
        var resp = await fetch(url, Object.assign({}, options, { headers: headers }));

        // Retry loop on 401/403
        if (resp.status === 401 || resp.status === 403) {
            console.warn('[auth]', endpoint, '— got', resp.status, '(token:', _tokenDebug(token) + '). Refreshing...');
            for (var attempt = 1; attempt <= 2; attempt++) {
                if (attempt === 2) {
                    console.warn('[auth]', endpoint, '— attempt 2: waiting 1s before retry...');
                    await new Promise(function(r) { setTimeout(r, 1000); });
                    _refreshPromise = null; // force a fresh refresh
                }
                if (await refreshAccessToken()) {
                    token = localStorage.getItem('sb_access_token');
                    headers['Authorization'] = 'Bearer ' + token;
                    resp = await fetch(url, Object.assign({}, options, { headers: headers }));
                    if (resp.status !== 401 && resp.status !== 403) {
                        console.log('[auth]', endpoint, '— retry', attempt, 'succeeded:', resp.status);
                        return resp;
                    }
                    console.warn('[auth]', endpoint, '— retry', attempt, 'still', resp.status);
                } else {
                    console.warn('[auth]', endpoint, '— refresh failed on attempt', attempt, '— redirecting to login');
                    localStorage.removeItem('sb_access_token');
                    localStorage.removeItem('sb_refresh_token');
                    window.location.href = 'login.html';
                    return resp;
                }
            }
        }
        return resp;
    }
    </script>

    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-size: 16px;
            line-height: 1.5;
        }

        /* HEADER SCOPEWRIGHT STANDARD */
        .nav-bar {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: 56px;
            background: var(--sw-surface);
            border-bottom: 1px solid var(--sw-border);
            padding: 0 60px;
            display: flex;
            align-items: center;
            gap: var(--sw-space-3);
            z-index: 100;
        }
        .nav-logo {
            font-size: 23px;
            font-weight: 650;
            letter-spacing: -0.025em;
            line-height: 1;
            color: var(--sw-navy);
            text-decoration: none;
        }
        .nav-back {
            color: var(--sw-text);
            text-decoration: none;
            font-size: 13px;
            font-weight: 400;
            opacity: 0.45;
            transition: opacity var(--sw-ease);
            white-space: nowrap;
        }
        .nav-back:hover { opacity: 0.8; }

        .data-status {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            padding: 6px 12px;
            border-radius: 20px;
            background: #f5f5f5;
        }
        .data-status.online { background: #e8f5e9; color: #2e7d32; }
        .data-status.offline { background: #fff3e0; color: #ef6c00; }
        .data-status.error { background: #ffebee; color: #c62828; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; }
        .data-status.online .status-dot { background: #4caf50; }
        .data-status.offline .status-dot { background: #ff9800; }
        .data-status.error .status-dot { background: #f44336; }
        .status-text { white-space: nowrap; }

        /* Main content */
        .main-content {
            margin-top: 56px;
            padding: 40px 60px 60px;
        }

        .page-title {
            font-size: 32px;
            font-weight: 400;
            margin-bottom: 8px;
        }

        .page-subtitle {
            font-size: 14px;
            color: #666;
            margin-bottom: 32px;
        }

        /* ═══════════════════════════════════════════════════════════════
           CALCULATEUR STYLES
           ═══════════════════════════════════════════════════════════════ */

        .calculator-container {
            max-width: 1200px;
        }

        .calc-header {
            display: grid;
            grid-template-columns: 30px 55px 1fr 90px 90px 230px 110px 100px 30px 120px 30px;
            gap: 6px;
            padding: 8px 10px;
            background: transparent;
            color: #888;
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            border-bottom: 1px solid #e0e0e0;
        }

        .calc-header span {
            display: flex;
            align-items: center;
        }
        .calc-header .sortable {
            cursor: pointer; user-select: none; gap: 3px;
        }
        .calc-header .sortable:hover { color: var(--sw-navy); }
        .calc-header .sort-arrow { font-size: 9px; opacity: 0.4; }
        .calc-header .sortable.sort-active .sort-arrow { opacity: 1; color: var(--sw-navy); }

        .calc-header .col-center { justify-content: center; }
        .calc-header .col-right { justify-content: flex-end; }

        .calc-rows {
            border-top: none;
        }

        .calc-row {
            display: grid;
            grid-template-columns: 30px 55px 1fr 90px 90px 230px 110px 100px 30px 120px 30px;
            gap: 6px;
            padding: 6px 10px;
            align-items: center;
            border-bottom: 1px solid #eee;
            background: var(--sw-surface);
            transition: background-color 0.15s ease;
        }
        .calc-row.cascade-child {
            border-left: 2px solid var(--stele-green);
            margin-left: 6px;
            background: #f8faf9;
        }
        .calc-row.cascade-child .cell-add .btn-add { visibility: hidden; }
        /* ── Cascade locked (manual override) ── */
        .calc-row.cascade-locked {
            border-left: 3px solid #E8A84C !important;
            background: rgba(232, 168, 76, 0.06) !important;
        }
        .btn-revert-cascade {
            display: none;
            align-items: center; justify-content: center;
            width: 22px; height: 22px;
            border: none; background: rgba(232, 168, 76, 0.15);
            color: #b87a2a; border-radius: 4px;
            cursor: pointer; font-size: 13px;
            transition: background 0.15s;
        }
        .btn-revert-cascade:hover { background: rgba(232, 168, 76, 0.3); }
        .cascade-locked .btn-revert-cascade { display: inline-flex !important; }
        .cascade-badge {
            font-size: 9px; background: #e2e8f0; color: #475569;
            padding: 1px 5px; border-radius: 3px; margin-left: 4px;
            vertical-align: middle; letter-spacing: 0.02em;
        }
        /* ── Constraint toast (auto_add etc.) ── */
        .constraint-toast {
            position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
            background: #1e293b; color: #fff; font-size: 13px; padding: 10px 20px;
            border-radius: 8px; z-index: 9999; box-shadow: 0 4px 16px rgba(0,0,0,0.18);
            animation: ctToastIn 0.2s ease; max-width: 400px; text-align: center;
        }
        @keyframes ctToastIn { from { opacity: 0; transform: translateX(-50%) translateY(8px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }
        .constraint-toast.ct-out { animation: ctToastOut 0.2s ease forwards; }
        @keyframes ctToastOut { to { opacity: 0; transform: translateX(-50%) translateY(8px); } }
        .calc-row.constraint-added { border-left: 2px solid #1565C0; background: #f0f7ff; }
        .constraint-badge {
            font-size: 9px; background: #dbeafe; color: #1565C0;
            padding: 1px 5px; border-radius: 3px; margin-left: 4px;
            vertical-align: middle; letter-spacing: 0.02em;
        }
        /* ── Constraint warning indicator ⚠️ on row ── */
        .constraint-warn {
            position: relative; display: inline-flex; align-items: center;
            margin-left: 4px; cursor: help; font-size: 14px; color: #f59e0b;
        }
        .constraint-warn .cw-tip {
            display: none; position: absolute; bottom: calc(100% + 6px); left: 50%;
            transform: translateX(-50%); white-space: nowrap; background: #1e293b;
            color: #fff; font-size: 11px; padding: 4px 10px; border-radius: 4px;
            z-index: 20; pointer-events: none;
        }
        .constraint-warn:hover .cw-tip { display: block; }
        /* ── Constraint modal (requires_swap / requires_choice) ── */
        .constraint-modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.35);
            z-index: 10000; display: flex; align-items: center; justify-content: center;
            animation: cmFadeIn 0.15s ease;
        }
        @keyframes cmFadeIn { from { opacity: 0; } to { opacity: 1; } }
        .constraint-modal {
            background: #fff; border-radius: 12px; padding: 28px 32px;
            max-width: 460px; width: 90%; box-shadow: 0 8px 32px rgba(0,0,0,0.18);
        }
        .constraint-modal h3 { margin: 0 0 12px; font-size: 16px; font-weight: 700; color: #0f172a; }
        .constraint-modal p { margin: 0 0 20px; font-size: 14px; color: #475569; line-height: 1.5; }
        .constraint-modal-actions { display: flex; gap: 10px; justify-content: flex-end; }
        .constraint-modal-actions button {
            padding: 8px 18px; border-radius: 6px; font-size: 13px; font-weight: 600;
            cursor: pointer; border: none; transition: background 0.15s;
        }
        .cm-btn-primary { background: var(--sw-navy); color: #fff; }
        .cm-btn-primary:hover { opacity: 0.9; }
        .cm-btn-secondary { background: #f1f5f9; color: #475569; }
        .cm-btn-secondary:hover { background: #e2e8f0; }

        .cell-tag input {
            width: 100%; padding: 4px 6px; font-size: 11px; font-family: monospace;
            border: 1px solid #e0e0e0; border-radius: 4px; text-align: center;
            text-transform: uppercase; font-weight: 600; color: var(--sw-navy);
        }
        .cell-tag input:focus { border-color: var(--sw-navy); outline: none; }
        .cell-tag input::placeholder { color: #ccc; font-weight: 400; }
        .cascade-child .cell-tag input,
        .cascade-locked .cell-tag input {
            opacity: 0.55; cursor: default; background: #f8f8f8;
        }

        /* ── Combobox autocomplete ── */
        .combobox { position: relative; display: flex; align-items: center; gap: 3px; }
        .combobox-input {
            width: 100%; padding: 5px 8px; font-size: 11px; border: 1px solid #e0e0e0;
            border-radius: 4px; background: #fff; cursor: text;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .combobox-input:focus { border-color: var(--sw-navy); outline: none; }
        .combobox-input::placeholder { color: #aaa; }
        .combobox-input.has-value { font-weight: 500; color: var(--sw-navy); }
        .btn-edit-cat {
            flex-shrink: 0; width: 22px; height: 22px; border: none; background: none;
            cursor: pointer; font-size: 12px; color: #94a3b8; border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-edit-cat:hover { background: #f1f5f9; color: var(--sw-navy); }

        .cb-dropdown {
            position: fixed; z-index: 9999; background: #fff;
            border: 1px solid #e2e8f0; border-radius: 10px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.12); max-height: 340px;
            overflow-y: auto; min-width: 320px;
            animation: sdFadeIn 120ms ease-out;
        }
        .cb-dropdown .cb-search {
            position: sticky; top: 0; background: #fff; padding: 8px; border-bottom: 1px solid #f1f5f9;
        }
        .cb-dropdown .cb-search input {
            width: 100%; padding: 6px 10px; font-size: 12px; border: 1px solid #e2e8f0;
            border-radius: 6px; outline: none;
        }
        .cb-dropdown .cb-search input:focus { border-color: var(--sw-navy); }
        .cb-group-label {
            padding: 6px 12px 3px; font-size: 10px; font-weight: 600;
            color: #94a3b8; text-transform: uppercase; letter-spacing: 0.04em;
        }
        .cb-item {
            padding: 6px 12px; cursor: pointer; font-size: 12px;
            display: flex; align-items: center; gap: 8px;
            border-radius: 6px; margin: 1px 4px;
        }
        .cb-item:hover, .cb-item.cb-active { background: #f1f5f9; }
        .cb-item.cb-pending { opacity: 0.45; cursor: not-allowed; }
        .cb-item.cb-pending:hover, .cb-item.cb-pending.cb-active { background: transparent; }
        .cb-item-code { color: #94a3b8; font-size: 10px; font-family: monospace; min-width: 60px; }
        .cb-item-desc { flex: 1; color: #0f172a; }
        .cb-item-type { color: #94a3b8; font-size: 10px; }
        .cb-item-special { color: var(--sw-navy); font-weight: 500; }
        .cb-empty { padding: 12px; text-align: center; color: #94a3b8; font-size: 12px; }
        .cb-pending-toast { position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); background: #1e293b; color: #fff; font-size: 12px; padding: 6px 14px; border-radius: 6px; white-space: nowrap; z-index: 10; animation: cbToastIn 0.15s ease; }
        @keyframes cbToastIn { from { opacity: 0; transform: translateX(-50%) translateY(4px); } to { opacity: 1; transform: translateX(-50%) translateY(0); } }

        .calc-row:nth-child(even) { background: #fafafa; }
        .calc-row:last-child { border-bottom: none; }

        /* ── Row insertion animation ── */
        @keyframes rowEnter {
            from { opacity: 0; transform: translateY(8px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        @keyframes rowHighlight {
            from { background-color: #F8FAFC; }
            to   { background-color: inherit; }
        }
        .calc-row.row-entering {
            animation: rowEnter 200ms ease-out forwards, rowHighlight 600ms ease-out 200ms forwards;
        }
        /* Total pulse after batch insert */
        @keyframes totalPulse {
            0%   { transform: scale(1); }
            50%  { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        .total-pulse {
            animation: totalPulse 300ms ease-out;
        }
        .calc-row:hover { background: #f5f5f5; }

        .btn-add {
            width: 20px;
            height: 20px;
            border: 1.5px solid var(--sw-navy);
            background: var(--sw-surface);
            color: var(--sw-navy);
            border-radius: 50%;
            font-size: 14px;
            font-weight: 400;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
            line-height: 1;
        }

        .btn-add:hover {
            background: var(--sw-navy);
            color: var(--sw-surface);
        }

        .btn-remove {
            width: 20px;
            height: 20px;
            border: none;
            background: transparent;
            color: var(--sw-border);
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.15s ease;
            border-radius: 4px;
        }

        .btn-remove:hover {
            color: #c0392b;
            background: #fdeaea;
        }

        .item-select {
            width: 100%;
            padding: 4px 8px;
            font-size: 11px;
            font-family: inherit;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #fff;
            color: var(--sw-text);
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%230A0203' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            padding-right: 28px;
        }

        .item-select:focus {
            outline: none;
            border-color: var(--sw-navy);
        }

        .cell-code, .cell-type, .cell-unit-price {
            font-size: 11px;
            color: var(--sw-text);
        }

        .cell-code {
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            font-size: 11px;
            color: #666;
            position: relative;
            cursor: help;
        }

        .cell-type { text-align: center; }
        .cell-unit-price { text-align: right; }

        .cell-dims {
            display: flex;
            align-items: center;
            gap: 2px;
            font-size: 10px;
            color: #94a3b8;
        }
        .cell-dims input {
            width: 36px;
            padding: 3px 2px;
            font-size: 10px;
            text-align: center;
            border: 1px solid #e0e0e0;
            border-radius: 3px;
            background: #fff;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
        }
        .cell-dims input:focus { border-color: var(--sw-navy); outline: none; }
        .cell-dims input::placeholder { color: #d4d4d4; }
        .cell-dims .dim-sep { color: #cbd5e1; font-size: 9px; }
        .cell-dims .caisson-sep { width: 1px; height: 16px; background: #ddd; margin: 0 4px; flex-shrink: 0; }
        .cell-dims .caisson-input {
            width: 40px; padding: 3px 2px; font-size: 10px; text-align: center;
            border: 1px solid #e0e0e0; border-radius: 3px; background: #fff;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
        }
        .cell-dims .caisson-input:focus { border-color: var(--sw-navy); outline: none; }
        .cell-dims .caisson-input::placeholder { color: #d4d4d4; }
        .cell-dims.dims-hidden { justify-content: center; }

        /* Tooltip styles */
        .tooltip-container {
            position: relative;
            cursor: help;
        }

        .tooltip {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--sw-text);
            color: var(--sw-surface);
            padding: 10px 14px;
            border-radius: 4px;
            font-size: 12px;
            line-height: 1.5;
            white-space: normal;
            width: 240px;
            text-align: left;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: opacity 0.2s ease, visibility 0.2s ease;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }

        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--sw-text);
        }

        .tooltip-container:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        .tooltip-img {
            width: 100%;
            border-radius: 3px;
            margin-bottom: 8px;
        }

        .tooltip-title { font-weight: 700; margin-bottom: 4px; font-size: 12px; }
        .tooltip-text { font-weight: 400; color: rgba(255,255,255,0.85); }

        .qty-input {
            width: 100%;
            padding: 5px 8px;
            font-size: 12px;
            font-family: inherit;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            background: #fff;
        }

        .qty-input:focus { outline: none; border-color: var(--sw-navy); }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }

        .cell-total {
            font-size: 12px;
            font-weight: 600;
            text-align: right;
            color: var(--sw-text);
        }

        .add-row-container {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: none;
            background: var(--sw-surface);
        }

        .add-row-text { font-size: 13px; color: #999; }

        .grand-total-container {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 20px 16px;
            background: var(--sw-text);
            border-radius: 0 0 4px 4px;
            margin-top: -1px;
        }

        .grand-total-label {
            font-size: 16px;
            font-weight: 700;
            color: var(--sw-surface);
            margin-right: 24px;
        }

        .grand-total-amount {
            font-size: 24px;
            font-weight: 700;
            color: var(--sw-surface);
            min-width: 140px;
            text-align: right;
        }

        .discount-row {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 8px 16px;
            background: var(--sw-text);
            gap: 12px;
        }
        .discount-label { font-size: 13px; color: rgba(255,255,255,0.6); }
        .discount-amount { font-size: 15px; font-weight: 600; color: #ef5350; min-width: 120px; text-align: right; }
        .discount-toggle-btn {
            background: none;
            border: 1px solid rgba(255,255,255,0.2);
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            font-size: 12px;
            padding: 3px 10px;
            border-radius: 4px;
            transition: all 0.15s;
        }
        .discount-toggle-btn:hover { border-color: rgba(255,255,255,0.5); color: #fff; }
        .discount-input {
            width: 80px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            padding: 3px 8px;
            font-size: 13px;
            color: #fff;
            text-align: right;
            background: rgba(255,255,255,0.08);
            outline: none;
        }
        .discount-type-select {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            color: #fff;
            font-size: 12px;
            padding: 3px 8px;
            cursor: pointer;
        }

        /* ── Global modifier row ── */
        .global-modifier-row {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 8px 16px;
            background: var(--sw-text);
            gap: 12px;
        }
        .global-modifier-label { font-size: 13px; color: rgba(255,255,255,0.6); }
        .global-modifier-badge { font-size: 13px; font-weight: 600; color: #42A5F5; }
        .global-modifier-input {
            width: 70px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            padding: 3px 8px;
            font-size: 13px;
            color: #fff;
            text-align: right;
            background: rgba(255,255,255,0.08);
            outline: none;
        }

        /* ── Tag filter bar ── */
        .tag-filter-bar {
            display: flex; align-items: center; gap: 6px; padding: 8px 12px;
            background: #f5f5f5; border-radius: 6px; margin-bottom: 12px; flex-wrap: wrap;
        }
        .tag-filter-bar .tag-filter-label {
            font-size: 11px; font-weight: 600; color: #888; text-transform: uppercase;
            letter-spacing: 0.3px; margin-right: 4px;
        }
        .tag-filter-chip {
            padding: 4px 10px; border: 1px solid #ddd; border-radius: 12px;
            font-size: 11px; font-weight: 600; cursor: pointer; background: #fff;
            color: #555; transition: all 0.15s; font-family: monospace;
        }
        .tag-filter-chip:hover { border-color: var(--sw-navy); color: var(--sw-navy); }
        .tag-filter-chip.active {
            background: var(--sw-navy); color: #fff; border-color: var(--sw-navy);
        }
        .tag-filter-chip.chip-all {
            font-family: inherit; font-weight: 500;
        }
        .calc-row.tag-hidden { display: none !important; }

        /* ── Rentab tag breakdown ── */
        .rentab-tag-section { margin-top: 16px; }
        .rentab-tag-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px; margin-top: 10px;
        }
        .rentab-tag-card {
            border: 1px solid #eee; border-radius: 6px; padding: 12px;
            background: #fafafa;
        }
        .rentab-tag-card-title {
            font-size: 13px; font-weight: 700; color: var(--sw-navy);
            margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 6px;
        }
        .rentab-tag-card table { width: 100%; font-size: 12px; }
        .rentab-tag-card td { padding: 2px 0; }
        .rentab-tag-card td:last-child { text-align: right; font-family: monospace; }
        .rentab-tag-card .tag-card-total { font-weight: 700; border-top: 1px solid #ddd; padding-top: 4px; }

        /* Sections meuble */
        .furniture-group {
            margin-bottom: 28px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e0e0e0;
            border-top: none;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
        }

        .btn-collapse {
            background: none;
            border: none;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            font-size: 12px;
            padding: 4px;
            transition: transform 0.2s;
            line-height: 1;
        }

        .btn-collapse:hover { color: #fff; }

        .furniture-group.collapsed .btn-collapse {
            transform: rotate(-90deg);
        }

        .furniture-group.collapsed .calc-header,
        .furniture-group.collapsed .calc-rows,
        .furniture-group.collapsed .group-images-section,
        .furniture-group.collapsed .client-description-section,
        .furniture-group.collapsed .room-dm-section {
            display: none;
        }

        .furniture-group-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: var(--sw-navy);
            color: var(--sw-surface);
            border-radius: 8px 8px 0 0;
        }

        .furniture-group-header .group-label {
            font-size: 13px;
            font-weight: 700;
            white-space: nowrap;
        }

        .furniture-name-input {
            flex: 1;
            padding: 7px 12px;
            font-size: 14px;
            font-family: inherit;
            font-weight: 600;
            border: none;
            border-radius: 4px;
            background: rgba(255,255,255,0.2);
            color: var(--sw-surface);
        }

        .furniture-name-input::placeholder { color: rgba(255,255,255,0.6); }
        .furniture-name-input:focus { outline: none; background: rgba(255,255,255,0.3); }

        .install-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            white-space: nowrap;
            font-size: 12px;
            color: rgba(255,255,255,0.85);
        }
        .install-toggle input[type="checkbox"] {
            width: 14px;
            height: 14px;
            cursor: pointer;
            accent-color: var(--sw-surface);
        }
        .install-label {
            font-weight: 500;
        }
        .install-toggle-project {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            white-space: nowrap;
            font-size: 12px;
            font-weight: 500;
        }
        .install-toggle-project input[type="checkbox"] {
            width: 14px;
            height: 14px;
            cursor: pointer;
            accent-color: var(--sw-navy);
        }
        .install-toggle-row {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .install-toggle-row input[type="checkbox"] {
            width: 12px;
            height: 12px;
            cursor: pointer;
            accent-color: var(--sw-navy);
        }

        .btn-remove-group {
            padding: 5px 12px;
            background: transparent;
            color: rgba(255,255,255,0.7);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            font-size: 12px;
            font-family: inherit;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.15s;
        }

        .btn-remove-group:hover {
            background: rgba(255,255,255,0.15);
            color: var(--sw-surface);
            border-color: rgba(255,255,255,0.6);
        }

        .group-subtotal-container {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 14px 16px;
            background: #f5f7f5;
            border-top: 1px solid #e8e8e8;
        }

        .group-subtotal-label {
            font-size: 13px;
            font-weight: 600;
            color: #666;
            margin-right: 20px;
        }

        .group-subtotal-amount {
            font-size: 17px;
            font-weight: 700;
            color: var(--sw-text);
            min-width: 120px;
            text-align: right;
        }

        /* Room modifier (%) — subtotal area */
        .group-subtotal-wrap {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn-room-modifier {
            background: none;
            border: 1px solid transparent;
            cursor: pointer;
            font-size: 12px;
            color: #999;
            padding: 2px 8px;
            border-radius: 4px;
            transition: color 0.15s, background 0.15s, border-color 0.15s;
        }
        .btn-room-modifier:hover { color: #1565C0; background: rgba(21,101,192,0.06); border-color: rgba(21,101,192,0.15); }
        .btn-room-modifier.active { color: #1565C0; font-weight: 600; border-color: rgba(21,101,192,0.2); background: rgba(21,101,192,0.04); }
        .room-modifier-input {
            width: 60px;
            border: 1px solid #1565C0;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 13px;
            font-weight: 600;
            color: #1565C0;
            text-align: right;
            background: rgba(21,101,192,0.04);
            outline: none;
        }
        .room-modifier-badge {
            font-size: 11px;
            font-weight: 600;
            color: #1565C0;
            background: rgba(21,101,192,0.08);
            border-radius: 4px;
            padding: 1px 6px;
            white-space: nowrap;
        }
        .room-modifier-tooltip {
            position: absolute;
            bottom: calc(100% + 6px);
            right: 0;
            white-space: nowrap;
            background: #333;
            color: #fff;
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 4px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s;
            z-index: 10;
        }
        .group-subtotal-container:hover .room-modifier-tooltip { opacity: 1; }

        .group-images-section {
            padding: 14px 16px;
            background: #f9f9f9;
            border-top: 1px solid #eee;
        }

        .group-images-header {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            margin-bottom: 8px;
        }

        .group-image-drop-zone {
            padding: 12px;
        }

        .group-image-drop-zone .image-drop-zone-text {
            font-size: 11px;
        }

        /* Description client par pièce */
        .client-description-section {
            padding: 10px 16px 12px; background: #fff; border-top: 1px solid #eee;
        }
        .client-desc-label {
            display: block; font-size: 12px; font-weight: 600; color: #444;
            margin-bottom: 6px;
        }
        .client-desc-textarea {
            width: 100%; padding: 8px 12px; border: 1px solid #e8e8e8; border-radius: 6px;
            font-family: inherit; font-size: 13px; resize: vertical; min-height: 40px;
            background: #fafafa; color: #333; line-height: 1.5;
        }
        .client-desc-textarea:focus { outline: none; border-color: var(--sw-navy); background: #fff; }
        .client-desc-display {
            width: 100%; padding: 8px 12px; border: 1px solid #e8e8e8; border-radius: 6px;
            font-family: inherit; font-size: 13px; min-height: 40px;
            background: #fafafa; color: #333; line-height: 1.5; cursor: text;
        }
        .client-desc-display:hover { border-color: #ccc; }
        .client-desc-display p { margin: 0 0 4px 0; }
        .client-desc-display strong { font-weight: 600; color: #222; }
        .client-desc-display ul { margin: 2px 0 6px 0; padding-left: 18px; }
        .client-desc-display li { margin-bottom: 2px; color: #555; }
        .client-desc-display .desc-placeholder { color: #aaa; font-style: italic; }
        .ai-field-wrap { position: relative; }
        .btn-ai-dot {
            position: absolute; top: 6px; right: 6px; z-index: 2;
            width: 22px; height: 22px; border-radius: 50%;
            background: transparent; border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            padding: 0; flex-shrink: 0;
        }
        .btn-ai-dot:disabled { opacity: 0.3; cursor: not-allowed; }
        .btn-ai-dot .ai-dot {
            width: 9px; height: 9px; border-radius: 50%;
            background: #0B1220; opacity: 0.45;
            animation: aiBreathe 3s ease-in-out infinite;
        }
        .btn-ai-dot:hover .ai-dot { opacity: 1; transform: scale(1.3); }
        .btn-ai-dot.ai-active .ai-dot {
            animation: aiBreathe 1.5s ease-in-out infinite;
        }
        @keyframes aiBreathe {
            0%,100% { opacity:0.45; transform:scale(1); }
            50% { opacity:1; transform:scale(1.15); }
        }

        .btn-assemble-desc {
            position: absolute; top: 6px; right: 30px; z-index: 2;
            width: 22px; height: 22px; border-radius: 50%;
            background: transparent; border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            padding: 0; flex-shrink: 0; font-size: 13px; opacity: 0.4;
        }
        .btn-assemble-desc:hover { opacity: 1; transform: scale(1.2); }

        /* Toggle showInQuote sur images */
        .image-quote-toggle {
            position: absolute; bottom: 2px; left: 2px; display: flex; align-items: center; gap: 2px;
            background: rgba(0,0,0,0.6); color: #fff; padding: 1px 4px; border-radius: 3px;
            font-size: 9px; cursor: pointer;
        }
        .image-quote-toggle input[type="checkbox"] { width: 11px; height: 11px; margin: 0; }
        .image-ai-toggle {
            position: absolute; bottom: 2px; right: 2px; display: flex; align-items: center; gap: 2px;
            background: rgba(11,18,32,0.75); color: #fff; padding: 1px 4px; border-radius: 3px;
            font-size: 9px; cursor: pointer;
        }
        .image-ai-toggle input[type="checkbox"] { width: 11px; height: 11px; margin: 0; }

        /* Exclusions */
        .exclusions-section {
            margin-top: 16px; padding: 14px 16px; background: #fafafa;
            border: 1px solid #e8e8e8; border-radius: 8px;
        }

        .btn-add-group {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 14px 20px;
            margin-bottom: 20px;
            background: var(--sw-surface);
            color: var(--sw-navy);
            border: 2px dashed #b5c4b8;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            width: 100%;
            justify-content: center;
        }

        .btn-add-group:hover { background: #edf0f5; border-color: var(--sw-navy); }

        .calc-disclaimer {
            margin-top: 24px;
            padding: 16px;
            background: var(--sw-border-2);
            border-radius: 4px;
            font-size: 13px;
            color: #666;
            font-style: italic;
        }

        .btn-pdf {
            display: none; /* Hidden - replaced by timeline CTA */
        }

        /* Ajout personnalis&eacute; — summary row */
        .ajout-edit-btn {
            background: none; border: 1px dashed #cbd5e1; border-radius: 6px;
            padding: 4px 10px; font-size: 11px; color: #475569; cursor: pointer;
            max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
            transition: border-color 0.15s, color 0.15s;
        }
        .ajout-edit-btn:hover { border-color: var(--stele-green); color: var(--stele-green); }

        /* Custom item modal */
        .custom-item-modal {
            background: #fff; border-radius: 12px; width: 520px; max-height: 90vh;
            overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        }
        .cim-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px 0; }
        .cim-header h3 { margin: 0; font-size: 16px; font-weight: 600; }
        .cim-close { background: none; border: none; font-size: 22px; cursor: pointer; color: #666; padding: 4px 8px; }
        .cim-close:hover { color: #000; }
        .cim-body { padding: 16px 24px; display: flex; flex-direction: column; gap: 12px; }
        .cim-label { font-size: 12px; font-weight: 600; color: #374151; margin-bottom: -6px; }
        .cim-body textarea, .cim-body input[type="number"], .cim-body select {
            padding: 8px 10px; border: 1px solid #d1d5db; border-radius: 8px;
            font-size: 13px; font-family: inherit; width: 100%; box-sizing: border-box;
        }
        .cim-body textarea:focus, .cim-body input:focus, .cim-body select:focus {
            outline: none; border-color: var(--stele-green);
        }
        .cim-body textarea { resize: vertical; }
        .cim-row { display: flex; gap: 12px; }
        .cim-field { flex: 1; display: flex; flex-direction: column; gap: 4px; }
        .cim-computed { font-size: 15px; font-weight: 700; padding: 8px 0; color: var(--stele-green); }
        .cim-dropzone {
            border: 2px dashed #d1d5db; border-radius: 8px; padding: 20px;
            text-align: center; color: #666; font-size: 13px; cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
        }
        .cim-dropzone.dragover { border-color: var(--stele-green); background: #f0fdf4; }
        .cim-dropzone a { color: var(--stele-green); text-decoration: underline; }
        .cim-file-list { display: flex; flex-direction: column; gap: 6px; }
        .cim-file-item {
            display: flex; align-items: center; gap: 8px; padding: 6px 10px;
            background: #f9fafb; border-radius: 6px; font-size: 12px;
        }
        .cim-file-icon { font-size: 16px; flex-shrink: 0; }
        .cim-file-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .cim-file-size { color: #9ca3af; flex-shrink: 0; }
        .cim-file-del { margin-left: auto; cursor: pointer; color: #dc3545; background: none; border: none; font-size: 14px; padding: 2px 6px; }
        .cim-file-del:hover { color: #b02a37; }
        .cim-footer { display: flex; justify-content: flex-end; gap: 10px; padding: 16px 24px; border-top: 1px solid #f1f5f9; }
        .cim-btn-cancel { background: #f3f4f6; border: none; padding: 8px 20px; border-radius: 8px; cursor: pointer; font-size: 13px; }
        .cim-btn-cancel:hover { background: #e5e7eb; }
        .cim-btn-save { background: var(--stele-green); color: #fff; border: none; padding: 8px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; }
        .cim-btn-save:hover { background: #3a4d3f; }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-y: auto;
        }
        #steleDialogOverlay { z-index: 9999; }

        .modal-overlay.active { display: flex; }

        /* Catalogue edit iframe overlay */
        .cat-edit-overlay {
            display: none; position: fixed; inset: 0; z-index: 10000;
            background: rgba(0,0,0,0.45); backdrop-filter: blur(2px);
            justify-content: center; align-items: center;
        }
        .cat-edit-overlay.active { display: flex; }
        .cat-edit-frame-wrap {
            width: min(95vw, 800px); height: min(92vh, 900px);
            border-radius: 14px; overflow: hidden;
            box-shadow: 0 25px 60px rgba(0,0,0,0.3);
            background: #fff;
        }
        .cat-edit-iframe { width: 100%; height: 100%; border: none; }

        .modal {
            background: var(--sw-surface);
            border-radius: 8px;
            width: 100%;
            max-width: 450px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--sw-border);
            flex-shrink: 0;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--sw-text);
        }

        .modal-body { padding: 24px; overflow-y: auto; flex: 1; }

        .form-group { margin-bottom: 16px; }
        .form-group:last-child { margin-bottom: 0; }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--sw-text);
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            font-size: 14px;
            font-family: inherit;
            border: 1px solid var(--sw-border);
            border-radius: 4px;
            background: var(--sw-surface);
        }

        .form-input:focus { outline: none; border-color: var(--sw-navy); }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--sw-border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            flex-shrink: 0;
        }

        .btn-cancel {
            padding: 10px 20px;
            background: transparent;
            color: var(--sw-text);
            border: 1px solid var(--sw-border);
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-cancel:hover { background: var(--sw-border-2); }

        .btn-generate {
            padding: 10px 20px;
            background: var(--sw-navy);
            color: var(--sw-surface);
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-generate:hover { background: #3d4f42; }

        /* Modal edit (large) */
        .modal.modal-edit {
            max-width: 800px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        .modal.modal-edit .modal-body { overflow-y: auto; }
        .edit-row { display: flex; gap: 12px; }
        .edit-row .form-group { flex: 1; }

        /* Prix composé */
        .composed-price-section { display: flex; gap: 16px; margin-top: 8px; }
        .cp-table-wrap { flex: 1; min-width: 0; }
        .cp-section-title {
            font-size: 12px; font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.5px; color: var(--sw-navy);
            margin-bottom: 10px; padding-bottom: 6px; border-bottom: 1px solid #f0f0f0;
        }
        .cp-sub-title { font-size: 11px; font-weight: 600; color: #555; margin-bottom: 6px; }
        .cp-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .cp-table th { text-align: left; font-weight: 600; font-size: 11px; color: #888; padding: 4px 6px; border-bottom: 1px solid #e0e0e0; }
        .cp-table th:last-child { text-align: right; }
        .cp-table td { padding: 3px 6px; }
        .cp-table td:first-child { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 140px; font-size: 11px; }
        .cp-table input[type="number"] { width: 100%; padding: 4px 6px; border: 1px solid #e0e0e0; border-radius: 3px; font-size: 12px; text-align: right; font-family: inherit; }
        .cp-table input[type="number"]:focus { outline: none; border-color: var(--sw-navy); }
        .cp-table input[type="number"]:disabled { background: #f0f0f0; color: #999; cursor: not-allowed; }
        .cp-calculated {
            margin-top: 12px; padding: 10px 14px; background: #f8f8f4;
            border-radius: 6px; display: flex; justify-content: space-between;
            align-items: center; font-size: 14px;
        }
        .cp-calculated .cp-total-label { font-weight: 600; color: #555; }
        .cp-calculated .cp-total-value { font-weight: 700; font-size: 16px; color: var(--sw-navy); }
        .cp-calculated .cp-breakdown { font-size: 11px; color: #888; margin-left: 8px; }

        /* Médias tagués */
        .cat-media-title {
            font-size: 12px; font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.5px; color: var(--sw-navy);
            margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #f0f0f0;
        }
        .cat-dropzone {
            border: 2px dashed var(--sw-border); border-radius: 6px; padding: 16px;
            text-align: center; cursor: pointer; transition: border-color 0.2s;
            font-size: 13px; color: #888; margin-bottom: 12px;
        }
        .cat-dropzone:hover, .cat-dropzone.dragover { border-color: var(--sw-navy); color: var(--sw-navy); }
        .cat-media-list { display: flex; flex-direction: column; gap: 10px; }
        .cat-media-item { display: flex; gap: 10px; padding: 10px; background: #f8f8f8; border-radius: 6px; align-items: flex-start; }
        .cat-media-item img { width: 80px; height: 60px; object-fit: cover; border-radius: 4px; border: 1px solid var(--sw-border); flex-shrink: 0; }
        .cat-pdf-icon { width: 80px; height: 60px; background: #e8e8e8; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; color: #999; flex-shrink: 0; }
        .cat-media-info { flex: 1; min-width: 0; }
        .cat-media-tags { display: flex; flex-wrap: wrap; gap: 5px; }
        .cat-tag { display: inline-block; font-size: 11px; padding: 3px 8px; border-radius: 12px; cursor: pointer; border: 1px solid var(--sw-border); background: #fff; color: #666; transition: all 0.15s; user-select: none; }
        .cat-tag.active { background: var(--sw-navy); color: #fff; border-color: var(--sw-navy); }
        .cat-media-remove { background: none; border: none; color: #c62828; cursor: pointer; font-size: 18px; padding: 0 4px; flex-shrink: 0; opacity: 0.5; transition: opacity 0.15s; }
        .cat-media-remove:hover { opacity: 1; }

        /* Toggle switch */
        .edit-toggle-row { display: flex; align-items: center; gap: 10px; }
        .edit-toggle { position: relative; display: inline-block; width: 38px; height: 22px; }
        .edit-toggle input { opacity: 0; width: 0; height: 0; }
        .edit-toggle .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #ddd; border-radius: 22px; transition: background 0.25s; }
        .edit-toggle .slider::before { content: ''; position: absolute; height: 16px; width: 16px; left: 3px; bottom: 3px; background: #fff; border-radius: 50%; transition: transform 0.25s; box-shadow: 0 1px 3px rgba(0,0,0,0.15); }
        .edit-toggle input:checked + .slider { background: var(--sw-navy); }
        .edit-toggle input:checked + .slider::before { transform: translateX(16px); }
        .edit-toggle-label { font-size: 13px; color: var(--sw-text); }

        .edit-status { font-size: 13px; padding: 8px 12px; border-radius: 4px; margin-top: 8px; display: none; }
        .edit-status.success { display: block; background: #e8f5e9; color: #2e7d32; }
        .edit-status.error { display: block; background: #ffebee; color: #c62828; }

        @media (max-width: 768px) {
            .composed-price-section { flex-direction: column; }
            .modal.modal-edit { max-width: 98vw; }
        }

        /* Image zone */
        .image-drop-zone {
            border: 2px dashed var(--sw-border);
            border-radius: 6px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
            margin-top: 4px;
        }

        .image-drop-zone:hover,
        .image-drop-zone.dragover {
            border-color: var(--sw-navy);
            background: #edf1f7;
        }

        .image-drop-zone-text { font-size: 12px; color: #888; }
        .image-drop-zone-text strong { color: #555; }

        .image-previews {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .image-preview-item {
            position: relative;
            width: 90px;
            height: 90px;
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid #ddd;
        }

        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-preview-remove {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(0,0,0,0.6);
            color: #fff;
            border: none;
            cursor: pointer;
            font-size: 12px;
            line-height: 20px;
            text-align: center;
            padding: 0;
        }

        .image-preview-remove:hover { background: rgba(200,0,0,0.8); }
        .image-count { font-size: 11px; color: #888; margin-top: 4px; }

        .image-preview-item img { cursor: pointer; }

        /* Lightbox */
        .lightbox-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }

        .lightbox-overlay.active { display: flex; }

        .lightbox-overlay img {
            max-width: 90vw;
            max-height: 90vh;
            object-fit: contain;
            border-radius: 4px;
            box-shadow: 0 4px 30px rgba(0,0,0,0.4);
        }

        /* Modal Plans */
        .modal-close {
            position: absolute;
            top: 20px;
            right: 24px;
            background: none;
            border: none;
            font-size: 28px;
            line-height: 1;
            color: #888;
            cursor: pointer;
            transition: color 0.15s;
        }
        .modal-close:hover { color: var(--sw-text); }

        .plans-upload-zone {
            margin-bottom: 20px;
            padding: 16px;
            background: #f9f9f9;
            border: 1px dashed #ccc;
            border-radius: 6px;
            text-align: center;
        }

        .btn-upload-plan {
            padding: 12px 24px;
            background: var(--sw-navy);
            color: var(--sw-surface);
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            font-family: inherit;
        }
        .btn-upload-plan:hover { background: #3d4f42; }

        .plans-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .plans-empty {
            padding: 40px 20px;
            text-align: center;
            color: #888;
            font-size: 14px;
        }

        .plan-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            margin-bottom: 8px;
            transition: background 0.15s;
        }
        .plan-item:hover { background: #f9f9f9; }

        .plan-icon {
            font-size: 32px;
            color: #c62828;
        }

        .plan-info {
            flex: 1;
            min-width: 0;
        }

        .plan-version {
            font-size: 11px;
            font-weight: 700;
            color: var(--sw-navy);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }

        .plan-filename {
            font-size: 14px;
            font-weight: 600;
            color: var(--sw-text);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .plan-meta {
            font-size: 11px;
            color: #888;
        }

        .plan-actions {
            display: flex;
            gap: 6px;
        }

        .plan-action-btn {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.15s;
            color: #555;
            font-family: inherit;
        }
        .plan-action-btn:hover {
            background: #f0f0f0;
            border-color: #b0b0b0;
            color: var(--sw-text);
        }
        .plan-action-btn.danger {
            color: #c62828;
            border-color: #ffcdd2;
        }
        .plan-action-btn.danger:hover {
            background: #ffebee;
            border-color: #ef9a9a;
        }

        /* PDF Viewer */
        .pdf-viewer-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 5000;
            justify-content: center;
            align-items: center;
        }
        .pdf-viewer-overlay.active { display: flex; }

        .pdf-viewer-container {
            width: 95vw;
            height: 95vh;
            background: #2b2b2b;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
        }

        .pdf-viewer-header {
            background: #1e1e1e;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #3a3a3a;
        }

        .pdf-viewer-title {
            font-size: 15px;
            font-weight: 600;
            color: #fff;
        }

        .pdf-viewer-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pdf-control-btn, .pdf-action-btn {
            background: #3a3a3a;
            border: 1px solid #4a4a4a;
            color: #e0e0e0;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-family: inherit;
            transition: all 0.15s;
        }
        .pdf-control-btn:hover, .pdf-action-btn:hover {
            background: #4a4a4a;
            border-color: #5a5a5a;
        }
        .pdf-control-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .pdf-action-btn {
            background: var(--sw-navy);
            border-color: var(--sw-navy);
            color: #fff;
            font-weight: 600;
        }
        .pdf-action-btn:hover {
            background: #3d4f42;
            border-color: #3d4f42;
        }

        .pdf-page-info, .pdf-zoom-info {
            color: #b0b0b0;
            font-size: 13px;
            min-width: 60px;
            text-align: center;
        }

        .pdf-control-divider {
            width: 1px;
            height: 20px;
            background: #4a4a4a;
            margin: 0 4px;
        }

        .pdf-viewer-close {
            background: none;
            border: none;
            color: #b0b0b0;
            font-size: 32px;
            line-height: 1;
            cursor: pointer;
            padding: 0;
            margin-left: 12px;
            transition: color 0.15s;
        }
        .pdf-viewer-close:hover { color: #fff; }

        .pdf-viewer-content {
            flex: 1;
            display: flex;
            overflow: hidden;
            background: #2b2b2b;
        }

        .pdf-sidebar {
            width: 180px;
            background: #1e1e1e;
            border-right: 1px solid #3a3a3a;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .pdf-sidebar-title {
            padding: 12px 16px;
            font-size: 11px;
            font-weight: 700;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #3a3a3a;
        }

        .pdf-thumbnails {
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .pdf-thumb {
            background: #2b2b2b;
            border: 2px solid transparent;
            border-radius: 4px;
            cursor: pointer;
            overflow: hidden;
            transition: all 0.15s;
            position: relative;
        }
        .pdf-thumb:hover {
            border-color: #5a5a5a;
        }
        .pdf-thumb.active {
            border-color: var(--sw-navy);
            box-shadow: 0 0 0 1px var(--sw-navy);
        }

        .pdf-thumb canvas {
            display: block;
            width: 100%;
            height: auto;
        }

        .pdf-thumb-label {
            position: absolute;
            bottom: 4px;
            right: 4px;
            background: rgba(0,0,0,0.7);
            color: #fff;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .pdf-canvas-container {
            flex: 1;
            overflow: auto;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        #pdfCanvas {
            display: block;
            max-width: 100%;
            height: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        /* Crop Modal */
        .crop-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.88); z-index: 3000;
            justify-content: center; align-items: center; flex-direction: column;
        }
        .crop-overlay.active { display: flex; }
        .crop-box {
            background: #fff; border-radius: 8px; overflow: hidden;
            width: 90vw; max-width: 800px; max-height: 90vh; display: flex; flex-direction: column;
        }
        .crop-header {
            padding: 14px 20px; font-weight: 700; font-size: 15px;
            border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between;
        }
        .crop-container { position: relative; flex: 1; min-height: 300px; max-height: 60vh; background: #222; overflow: hidden; }
        .crop-container img { display: block; max-width: 100%; }
        .crop-controls {
            padding: 12px 20px; display: flex; gap: 10px; align-items: center;
            border-top: 1px solid #eee; justify-content: space-between;
        }
        .crop-controls .crop-ratios { display: flex; gap: 6px; }
        .crop-controls .crop-ratio-btn {
            padding: 6px 16px; border: 2px solid #ccc; border-radius: 4px;
            background: #fff; cursor: pointer; font-size: 13px; font-weight: 600;
        }
        .crop-controls .crop-ratio-btn.active { border-color: var(--sw-navy); background: var(--sw-navy); color: #fff; }
        .crop-controls .crop-actions { display: flex; gap: 8px; }
        .crop-controls .crop-btn {
            padding: 8px 20px; border: none; border-radius: 4px;
            cursor: pointer; font-size: 13px; font-weight: 600;
        }
        .crop-btn-cancel { background: #eee; color: #555; }
        .crop-btn-confirm { background: var(--sw-navy); color: #fff; }
        .crop-btn-confirm:disabled { opacity: 0.5; cursor: not-allowed; }
        .crop-error { padding: 10px 20px; background: #fee; color: #c00; font-size: 13px; display: none; }
        .crop-loading { padding: 20px; text-align: center; color: #888; font-size: 14px; }

        /* ── Annotation Modal ── */
        .annotation-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.88); z-index: 3500;
            justify-content: center; align-items: center; flex-direction: column;
        }
        .annotation-overlay.active { display: flex; }
        .annotation-box {
            background: #fff; border-radius: 8px; overflow: hidden;
            width: 95vw; max-width: 1200px; max-height: 92vh;
            display: flex; flex-direction: column;
        }
        .annotation-header {
            padding: 12px 20px; border-bottom: 1px solid #eee;
            display: flex; align-items: center; gap: 12px; flex-shrink: 0;
        }
        .annotation-header .annotation-title { font-weight: 700; font-size: 15px; margin-right: auto; }
        .annotation-header select {
            padding: 5px 10px; border: 1px solid #ddd; border-radius: 4px;
            font-size: 13px; font-family: inherit;
        }
        .annotation-header .annotation-next {
            font-size: 13px; font-weight: 600; color: var(--sw-navy);
            min-width: 90px;
        }
        .annotation-header .annotation-arrow-toggle {
            display: flex; align-items: center; gap: 4px; font-size: 12px; cursor: pointer;
        }
        .annotation-header .annotation-arrow-toggle input { width: 14px; height: 14px; accent-color: var(--sw-navy); }
        .annotation-close {
            background: none; border: none; font-size: 22px; cursor: pointer; color: #888;
            padding: 0 4px; line-height: 1;
        }
        .annotation-close:hover { color: #333; }
        .annotation-img-container {
            flex: 1; position: relative; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
            background: #1a1a1a; min-height: 300px;
        }
        .annotation-img-container img {
            max-width: 100%; max-height: 75vh; display: block; user-select: none; -webkit-user-drag: none;
        }
        .annotation-img-container svg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; overflow: visible;
        }
        .annotation-img-container svg .annot-label {
            pointer-events: all; cursor: grab; user-select: none;
        }
        .annotation-img-container svg .annot-label:hover rect { stroke: #fff; stroke-width: 2; }
        .annotation-img-container svg .annot-label.dragging { cursor: grabbing; opacity: 0.8; }
        .annotation-img-container svg .annot-arrow {
            stroke: var(--sw-navy); stroke-width: 2; fill: none;
            marker-end: url(#annotArrowHead);
        }
        .annotation-footer {
            padding: 10px 20px; border-top: 1px solid #eee;
            display: flex; align-items: center; gap: 12px; font-size: 12px; color: #888;
        }
        .annotation-footer .annotation-hint { flex: 1; }
        .annotation-badge {
            position: absolute; top: 2px; left: 2px;
            background: var(--sw-navy); color: #fff;
            font-size: 9px; font-weight: 700; min-width: 16px; height: 16px;
            border-radius: 8px; display: flex; align-items: center; justify-content: center;
            padding: 0 3px; line-height: 1;
        }
        .annotation-btn {
            position: absolute; top: 2px; left: 2px;
            background: rgba(11,18,32,0.85); color: #fff; border: none;
            width: 22px; height: 22px; border-radius: 4px; cursor: pointer;
            font-size: 12px; display: flex; align-items: center; justify-content: center;
            padding: 0; opacity: 0.7; transition: opacity 0.15s;
        }
        .image-preview-item:hover .annotation-btn { opacity: 1; }
        .annotation-btn:hover { background: var(--sw-navy); }

        /* ═══════════════════════════════════════════════════════════════
           VUE LISTE DE PROJETS
           ═══════════════════════════════════════════════════════════════ */

        .project-list-view { display: none; }
        .project-list-view.active { display: block; }
        .calculator-view { display: none; max-width: 1200px; }
        .calculator-view.active { display: block; }

        /* ═══════════════════════════════════════════════════════════════
           PREVIEW VIEW (Aperçu soumission)
           ═══════════════════════════════════════════════════════════════ */
        /* Preview — split layout (document gauche, outils droite) */
        .preview-view {
            display: none; position: fixed; top: 56px; left: 0; right: 0; bottom: 0;
            z-index: 50; background: #fff;
        }
        .preview-view.active { display: flex; flex-direction: column; }

        .pv-toolbar {
            display: flex; align-items: center; gap: 16px; flex-wrap: wrap;
            padding: 10px 24px; border-bottom: 2px solid var(--sw-text);
            background: #fff; flex-shrink: 0;
        }
        .pv-toolbar button {
            background: none; border: 1px solid var(--sw-navy); color: var(--sw-navy);
            padding: 6px 14px; border-radius: 4px; font-size: 12px; cursor: pointer; font-weight: 500;
        }
        .pv-toolbar button:hover { background: var(--sw-navy); color: #fff; }
        .pv-toolbar-title { font-size: 16px; font-weight: 600; color: var(--sw-text); }
        .pv-toolbar-sub { font-size: 13px; color: var(--sw-navy); font-weight: 600; margin-left: auto; }

        /* Split panels */
        .pv-split { flex: 1; display: flex; overflow: hidden; }
        .pv-left { flex: 1; overflow-y: auto; padding: 4px 0; background: #ddd; }
        .pv-right {
            width: 360px; min-width: 360px; overflow-y: auto;
            background: #f8f8f8; border-left: 1px solid rgba(0,0,0,0.1);
        }

        .pv-content {
            display: flex; flex-direction: column; gap: 4px;
        }

        /* ── Landscape pages (11 × 8.5 in) ── */
        .pv-page {
            background: #fff; padding: 36px 48px;
            aspect-ratio: 11 / 8.5;
            overflow: hidden; position: relative;
            display: flex; flex-direction: column;
        }

        /* Title page — full-screen image + text overlay */
        .pv-page-title { position: relative; padding: 32px; overflow: hidden; background: #fff; }
        .pv-cover-right {
            position: absolute; inset: 32px; z-index: 0; background: var(--sw-navy); overflow: hidden; border-radius: 8px;
        }
        .pv-cover-right img { width: 100%; height: 100%; object-fit: cover; display: block; filter: none; opacity: 1; }
        .pv-cover-right .pv-cover-overlay { display: none; }
        .pv-cover-left {
            position: relative; z-index: 1; width: 320px;
            display: flex; flex-direction: column; justify-content: flex-start;
            padding: 48px; min-height: 100%;
            background: transparent; text-align: left;
        }
        .pv-cover-brand {
            position: absolute; bottom: 49px; left: 56px; z-index: 1;
            font-family: 'Inter', -apple-system, sans-serif;
            font-size: 40px; font-weight: 400; letter-spacing: -0.01em;
            text-transform: lowercase; color: white; opacity: 0.9;
            margin: 0; line-height: 1;
        }
        .pv-cover-label {
            font-family: 'Cormorant Garamond', Georgia, serif;
            font-style: italic; font-size: 13px; color: rgba(255,255,255,0.75);
            line-height: 1.2; margin-bottom: 10px;
        }
        .pv-cover-left .pv-client-name {
            font-family: 'Inter', -apple-system, sans-serif;
            font-size: 15px; font-weight: 400; color: white; opacity: 0.85;
            line-height: 1.5; margin-bottom: 0;
        }
        .pv-cover-left .pv-client-address {
            font-family: 'Inter', -apple-system, sans-serif;
            font-size: 15px; font-weight: 400; color: white; opacity: 0.85;
            line-height: 1.5; margin-bottom: 0;
        }
        .pv-cover-left .pv-project-name {
            font-family: 'Inter', -apple-system, sans-serif;
            font-size: 56px; font-weight: 400; color: #FFFFFF;
            line-height: 1.1; letter-spacing: -0.02em;
            margin-top: 28px; margin-bottom: 0;
        }
        .pv-cover-left .pv-cover-divider { width: 32px; height: 1px; background: rgba(255,255,255,0.25); margin: 14px 0; }
        .pv-cover-left .pv-sub-number { font-family: 'Inter', -apple-system, sans-serif; font-size: 13px; font-weight: 400; color: white; opacity: 0.7; margin-bottom: 2px; }
        .pv-cover-left .pv-sub-date { font-family: 'Inter', -apple-system, sans-serif; font-size: 13px; font-weight: 400; color: white; opacity: 0.7; }
        .pv-cover-logo { display: none; }

        /* Installation non incluse — indicators */
        .pv-install-banner { font-size: 12px; color: rgba(255,255,255,0.7); margin-top: 60px; letter-spacing: 0.3px; }
        .pv-install-room-note { font-size: 11px; color: #999; font-style: italic; margin-top: -30px; margin-bottom: 20px; padding-left: 20px; }
        .pv-install-total-note { font-size: 13px; color: #999; margin-bottom: 16px; letter-spacing: 0.3px; }

        /* Room page — landscape layout */
        .pv-page-room-header {
            display: flex; align-items: baseline; justify-content: space-between;
            padding: 10px 0; background: transparent; color: #1A1A1A;
            border-radius: 0; margin: 0; flex-shrink: 0;
            border-bottom: 1px solid #1A1A1A;
        }
        .pv-room-separator {
            border-bottom: 1px solid #E5E5E5;
            flex-shrink: 0;
        }
        .pv-page-room-name {
            font-family: 'Inter', -apple-system, sans-serif;
            font-size: 12px; font-weight: 500; letter-spacing: 0.05em;
            text-transform: uppercase; color: #1A1A1A;
        }
        .pv-page-room-subtotal {
            font-family: 'Inter', -apple-system, sans-serif;
            font-size: 17px; font-weight: 600; letter-spacing: -0.01em;
            color: #1A1A1A;
        }
        .pv-page-room-body { flex: 1; display: flex; gap: 56px; overflow: hidden; min-height: 0; padding-top: 32px; }
        .pv-page-room-text { flex: 0 1 440px; max-width: 440px; display: flex; flex-direction: column; overflow: hidden; justify-content: center; }
        .pv-page-room-media {
            flex: 1.3; display: grid; grid-template-columns: repeat(2, 1fr);
            gap: 12px; align-content: center; max-height: 100%;
        }
        /* 1 image: single column, centered */
        .pv-page-room-media.imgs-1 { grid-template-columns: 1fr; }
        /* 2 images: stacked vertically */
        .pv-page-room-media.imgs-2 { grid-template-columns: 1fr; gap: 20px; }
        /* 3 images: first spans full width, 2 below side by side */
        .pv-page-room-media.imgs-3 { gap: 12px; }
        .pv-page-room-media.imgs-3 .pv-img-wrap:first-child { grid-column: 1 / -1; }
        .pv-page-room-media .pv-img-wrap {
            overflow: hidden; min-height: 0;
            background: transparent; border: none;
            border-radius: 0; padding: 0;
            box-shadow: none;
        }
        .pv-page-room-media .pv-img-wrap img {
            width: 100%; height: 100%; object-fit: cover; display: block; cursor: pointer;
            border-radius: 0;
        }
        .pv-page-room-desc {
            width: 100%; border: 1px dashed #ccc; border-radius: 4px;
            padding: 10px 12px; font-family: 'Inter', -apple-system, sans-serif;
            font-size: 14px; font-weight: 400; line-height: 1.6; color: #2B2B2B;
            flex: 1; min-height: 60px;
            background: #fafafa; transition: border-color 0.2s;
            overflow-y: auto; white-space: normal; word-wrap: break-word;
        }
        .pv-page-room-desc:focus { outline: none; border-color: var(--sw-navy); background: #fff; }
        .pv-page-room-desc[contenteditable="false"] { background: transparent; border-color: transparent; cursor: default; }
        .pv-page-room-desc:empty::before { content: attr(data-placeholder); color: #aaa; font-style: italic; }
        .pv-page-room-desc p { margin: 0 0 8px 0; }
        .pv-page-room-desc ul { margin: 6px 0 12px 0; padding-left: 18px; }
        .pv-page-room-desc li { margin-bottom: 6px; color: #555555; font-size: 14px; line-height: 1.6; }
        .pv-page-room-desc li::marker { color: #B0B0B0; }
        .pv-page-room-desc ul + p { margin-top: 16px; }
        .pv-page-room-desc strong { font-weight: 500; color: #1A1A1A; letter-spacing: 0.01em; }

        /* Clauses page — compact */
        .pv-page-clauses-header {
            font-family: 'Inter', -apple-system, sans-serif;
            font-size: 12px; text-transform: uppercase; letter-spacing: 1px;
            color: #1A1A1A; font-weight: 500; margin-bottom: 14px;
            padding-bottom: 6px; border-bottom: 1px solid #1A1A1A;
        }
        .pv-page-clauses-body { flex: 1; overflow: hidden; }
        .pv-page-clause {
            margin-bottom: 8px; padding: 6px 14px;
            border-left: 1px solid #1A1A1A; background: #fafafa;
            border-radius: 0;
        }
        .pv-page-clause-title {
            font-family: 'Inter', -apple-system, sans-serif;
            font-size: 11px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 2px; color: #1A1A1A;
        }
        .pv-page-clause-text {
            width: 100%; border: 1px dashed transparent; border-radius: 3px;
            padding: 2px 4px; font-family: 'Inter', -apple-system, sans-serif;
            font-size: 12px; line-height: 1.3; color: #555555;
            resize: none; background: transparent;
        }
        .pv-page-clause-text:focus { outline: none; border-color: #1A1A1A; background: #fff; }
        .pv-page-clause-text:disabled { border-color: transparent; background: transparent; }
        .pv-page-clause-actions { display: flex; gap: 6px; margin-top: 2px; justify-content: flex-end; }

        /* Total page */
        .pv-page-total { justify-content: center; align-items: center; text-align: center; }
        .pv-total-box {
            padding: 36px 56px; background: #1A1A1A; color: #fff; border-radius: 0;
        }
        .pv-total-box .total-label {
            font-family: 'Inter', -apple-system, sans-serif;
            font-size: 12px; font-weight: 400; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 10px; opacity: 0.8;
        }
        .pv-total-box .total-amount {
            font-family: 'Inter', -apple-system, sans-serif;
            font-size: 42px; font-weight: 400; letter-spacing: -0.02em;
        }
        .pv-total-box .total-taxes { font-size: 13px; opacity: 0.6; margin-top: 6px; }
        .pv-total-breakdown { margin-bottom: 12px; }
        .pv-total-subtotal-line, .pv-total-discount-line { display: flex; justify-content: space-between; font-size: 16px; padding: 4px 0; opacity: 0.8; }
        .pv-total-discount-line { color: #ef5350; }
        .pv-total-divider { border-top: 1px solid rgba(255,255,255,0.2); margin: 8px 0; }
        .pv-page-footer-text {
            margin-top: 32px; font-family: 'Inter', -apple-system, sans-serif;
            font-size: 12px; font-weight: 400; color: #888888; letter-spacing: 0.02em; text-transform: uppercase;
        }

        /* Steps page */
        .pv-page-steps { padding: 32px 32px; }
        .pv-steps-title {
            font-family: 'Inter', -apple-system, sans-serif;
            font-size: 12px; text-transform: uppercase; letter-spacing: 1px;
            color: #1A1A1A; font-weight: 500; margin-bottom: 20px;
            padding-bottom: 6px; border-bottom: 1px solid #1A1A1A;
        }
        .pv-steps-grid {
            flex: 1; display: grid; grid-template-columns: 1fr 1fr;
            grid-template-rows: repeat(4, 1fr); gap: 10px 48px;
            grid-auto-flow: column;
        }
        .pv-step { display: flex; gap: 16px; align-items: flex-start; }
        .pv-step-circle {
            width: 64px; height: 64px; min-width: 64px; border-radius: 50%;
            color: #fff; display: flex; align-items: center; justify-content: center;
            font-family: 'Inter', -apple-system, sans-serif;
            font-size: 24px; font-weight: 400; margin-top: 2px;
        }
        .pv-step-content { flex: 1; min-width: 0; }
        .pv-step-label {
            font-family: 'Inter', -apple-system, sans-serif;
            font-size: 12px; font-weight: 500; text-transform: uppercase;
            letter-spacing: 0.3px; color: #1A1A1A; margin-bottom: 4px;
        }
        .pv-step-desc {
            font-family: 'Inter', -apple-system, sans-serif;
            font-size: 11px; font-weight: 400; line-height: 1.45; color: #555555;
        }

        /* Introduction page */
        .pv-page-intro {
            padding: 32px;
            display: grid;
            grid-template-columns: 42% 1fr;
            grid-template-rows: 1fr;
            overflow: hidden;
            position: relative;
        }
        .pv-intro-section-label {
            display: none;
        }
        .pv-intro-image { grid-row: 1; grid-column: 1; overflow: hidden; border-radius: 8px; min-height: 0; background: #f0f0f0; }
        .pv-intro-image img { width: 100%; height: 100%; object-fit: cover; object-position: center; display: block; border-radius: 8px; }
        .pv-intro-content {
            grid-column: 2; grid-row: 1;
            padding: 40px 24px 32px 48px;
            display: flex; flex-direction: column; justify-content: flex-start;
            overflow: hidden;
        }
        .pv-intro-attention-label {
            font-family: 'Inter', -apple-system, sans-serif;
            font-style: italic; font-weight: 400;
            font-size: 13px; color: #888888; margin-bottom: 6px;
            letter-spacing: 0.05em;
        }
        .pv-intro-attention-name {
            font-family: 'Inter', -apple-system, sans-serif;
            font-weight: 400; font-size: 14px;
            color: #1a1a1a; letter-spacing: 0.01em;
            margin-bottom: 52px; line-height: 1.6;
        }
        .pv-intro-rule { width: 48px; height: 1px; background: #1A1A1A; margin-bottom: 52px; }
        .pv-intro-title {
            font-family: 'Inter', -apple-system, sans-serif;
            font-weight: 400; font-size: 28px;
            line-height: 1.3; letter-spacing: -0.02em;
            color: #1A1A1A; margin-bottom: 48px;
        }
        .pv-intro-title strong { font-weight: 600; }
        .pv-intro-body { max-width: 460px; }
        .pv-intro-body p {
            font-family: 'Inter', -apple-system, sans-serif;
            font-weight: 400; font-size: 14px;
            line-height: 1.7; color: #555555; margin-bottom: 20px;
        }
        .pv-intro-body p:last-child { margin-bottom: 0; }
        .pv-intro-footer {
            position: absolute; bottom: 24px; left: 32px; right: 56px;
            display: flex; justify-content: space-between; align-items: flex-end;
        }
        .pv-intro-footer-addresses { display: flex; gap: 48px; }
        .pv-intro-footer-block { display: flex; gap: 8px; align-items: baseline; }
        .pv-intro-footer-label {
            font-family: 'Inter', -apple-system, sans-serif;
            font-weight: 500; font-size: 11px;
            text-transform: uppercase; letter-spacing: 0.08em; color: #888888;
        }
        .pv-intro-footer-value {
            font-family: 'Inter', -apple-system, sans-serif;
            font-weight: 400; font-size: 10px; color: #888888;
        }
        .pv-intro-footer-right { text-align: right; }
        .pv-intro-footer-name {
            font-family: 'Inter', -apple-system, sans-serif;
            font-weight: 400; font-size: 11px; color: #1a1a1a; margin-bottom: 2px;
        }
        .pv-intro-footer-email {
            font-family: 'Inter', -apple-system, sans-serif;
            font-weight: 400; font-size: 10px; color: #888888;
        }
        .pv-intro-bottom {
            position: absolute; bottom: 8px; left: 32px; right: 56px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .pv-intro-bottom-url {
            font-family: 'Inter', -apple-system, sans-serif;
            font-weight: 400; font-size: 9px; color: #1a1a1a;
            text-decoration: none; letter-spacing: 0.02em;
        }
        .pv-intro-bottom-page {
            font-family: 'Inter', -apple-system, sans-serif;
            font-weight: 400; font-size: 9px; color: #888;
        }

        /* Pourquoi stele page */
        .pv-page-why {
            display: grid; grid-template-columns: 42% 1fr;
            grid-template-rows: 1fr; padding: 32px; overflow: hidden; position: relative;
        }
        .pv-why-image { grid-row: 1; grid-column: 1; overflow: hidden; border-radius: 8px; min-height: 0; background: #f0f0f0; }
        .pv-why-image img { width: 100%; height: 100%; object-fit: cover; object-position: center; display: block; border-radius: 8px; filter: grayscale(100%) contrast(1.05); box-shadow: none; }
        .pv-why-content { grid-row: 1; grid-column: 2; padding: 40px 24px 32px 48px; display: flex; flex-direction: column; justify-content: center; }
        .pv-why-rule { width: 48px; height: 1px; background: #1A1A1A; margin-bottom: 52px; }
        .pv-why-title { font-family: 'Inter', -apple-system, sans-serif; font-size: 28px; font-weight: 400; letter-spacing: -0.02em; line-height: 1.3; color: #1A1A1A; margin-bottom: 48px; }
        .pv-why-title strong { font-weight: 600; }
        .pv-why-body { max-width: 460px; }
        .pv-why-body p { font-family: 'Inter', -apple-system, sans-serif; font-size: 14px; font-weight: 400; line-height: 1.7; color: #555555; margin-bottom: 20px; }
        .pv-why-body p:last-child { margin-bottom: 0; }
        .pv-why-bottom { position: absolute; bottom: 8px; left: 32px; right: 56px; display: flex; justify-content: space-between; align-items: center; }
        .pv-why-bottom-url { font-family: 'Inter', -apple-system, sans-serif; font-size: 9px; font-weight: 400; letter-spacing: 0.02em; color: #1a1a1a; }
        .pv-why-bottom-page { font-family: 'Inter', -apple-system, sans-serif; font-size: 9px; font-weight: 400; color: #888; }

        /* Tools panel */
        .pv-tools-header {
            padding: 14px 20px; font-size: 13px; font-weight: 700;
            text-transform: uppercase; letter-spacing: 1px; color: var(--sw-text);
            border-bottom: 1px solid rgba(0,0,0,0.08); background: #f0f0f0;
            position: sticky; top: 0; z-index: 1;
        }
        .pv-tools-section { padding: 16px 20px; border-bottom: 1px solid rgba(0,0,0,0.06); }
        .pv-tools-section h5 {
            font-size: 11px; text-transform: uppercase; letter-spacing: 0.6px;
            color: var(--sw-navy); margin-bottom: 10px; font-weight: 600;
        }
        .pv-tools-placeholder { font-size: 13px; color: #888; line-height: 1.4; font-style: italic; }

        .pv-clause-list { display: flex; flex-direction: column; gap: 6px; }
        .pv-clause-item {
            padding: 10px 12px; background: #fff; border: 1px solid rgba(0,0,0,0.08);
            border-radius: 4px; font-size: 13px; color: #333; cursor: grab;
            transition: box-shadow 0.15s, border-color 0.15s;
        }
        .pv-clause-item:hover { border-color: var(--sw-navy); box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .pv-clause-item .clause-title { font-weight: 600; margin-bottom: 2px; }
        .pv-clause-item .clause-preview {
            font-size: 12px; color: #888; overflow: hidden;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
        }

        /* Image wrap (used in room pages) */
        .pv-img-wrap { position: relative; border-radius: 4px; overflow: hidden; }
        .pv-img-delete {
            position: absolute; top: 6px; right: 6px; width: 24px; height: 24px;
            border-radius: 50%; background: rgba(0,0,0,0.6); color: #fff;
            border: none; cursor: pointer; font-size: 14px; line-height: 24px;
            text-align: center; padding: 0; transition: background 0.15s;
            display: none;
        }
        .pv-img-wrap:hover .pv-img-delete { display: block; }
        .pv-img-delete:hover { background: rgba(200,0,0,0.85); }
        .pv-img-badge-client {
            position: absolute; bottom: 6px; left: 6px;
            background: rgba(11,18,32,0.85); color: #fff; font-size: 8px;
            padding: 2px 5px; border-radius: 3px; font-weight: 600;
            letter-spacing: 0.3px; text-transform: uppercase;
        }

        /* Client / presentation mode — hide edit UI */
        .pv-toolbar .btn-client-view {
            background: none; border: 1px solid #333; color: #333;
            padding: 6px 14px; border-radius: 4px; font-size: 12px;
            cursor: pointer; font-weight: 500; margin-left: 8px;
        }
        .pv-toolbar .btn-client-view:hover { background: #333; color: #fff; }
        .pv-toolbar .btn-client-view.active { background: #333; color: #fff; }
        .pv-optimize-btn {
            position: absolute; top: 6px; right: 6px; z-index: 2;
            display: flex; align-items: center; justify-content: center;
            width: 28px; height: 28px; padding: 0;
            background: transparent; border: none; cursor: pointer;
            font-size: 0; color: transparent;
        }
        .pv-optimize-btn::after {
            content: ''; display: block; width: 9px; height: 9px;
            border-radius: 50%; background: var(--sw-navy);
            opacity: 0.6; box-shadow: 0 0 0 3px rgba(11,18,32,0.06);
            transition: all 200ms ease;
            animation: ai-breathe 3s ease-in-out infinite;
        }
        .pv-optimize-btn:hover::after { opacity: 1; transform: scale(1.05); }
        .pv-client-mode .pv-optimize-btn { display: none !important; }
        .pv-client-mode .pv-right { display: none; }
        .pv-client-mode .pv-page-room-desc { border-color: transparent; background: transparent; padding: 0; flex: initial; min-height: auto; }
        .pv-client-mode .pv-page-clause { background: transparent; border-left: 3px solid #4b6050; border: 1px solid #e0e0e0; border-left: 3px solid #4b6050; }
        .pv-client-mode .pv-page-clause-text { border-color: transparent; background: transparent; padding: 0; height: auto !important; overflow: visible; }
        .pv-client-mode .pv-page-clause-actions,
        .pv-client-mode .pv-clause-dropzone,
        .pv-client-mode .pv-img-delete { display: none !important; }

        /* Clause action buttons (in document) */
        .pv-doc-clause-btn {
            background: none; border: none; font-size: 10px; cursor: pointer;
            font-family: inherit; padding: 2px 5px; border-radius: 3px; transition: all 0.15s;
        }
        .pv-doc-clause-btn.remove { color: #c62828; }
        .pv-doc-clause-btn.remove:hover { background: #ffebee; }
        .pv-doc-clause-btn.save-lib { color: var(--sw-navy); }
        .pv-doc-clause-btn.save-lib:hover { background: #e8f5e9; }

        /* Drop zone for clauses */
        .pv-clause-dropzone {
            padding: 10px; border: 2px dashed #ccc; border-radius: 4px;
            text-align: center; color: #aaa; font-size: 12px; font-style: italic;
            transition: all 0.2s; margin-top: 6px;
        }
        .pv-clause-dropzone.drag-over {
            border-color: var(--sw-navy); background: #edf1f7; color: var(--sw-navy);
        }

        /* Iframe presentation overlay */
        .pres-iframe-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            z-index: 10000; background: #fff;
            display: flex; flex-direction: column;
        }
        .pres-iframe-toolbar {
            display: flex; align-items: center; gap: 12px;
            padding: 8px 16px; background: #fafafa; border-bottom: 1px solid #e5e5e5;
            flex-shrink: 0;
        }
        .pres-iframe-toolbar button {
            background: none; border: 1px solid #333; color: #333;
            padding: 6px 14px; border-radius: 4px; font-size: 12px;
            cursor: pointer; font-weight: 500; font-family: inherit;
        }
        .pres-iframe-toolbar button:hover { background: #333; color: #fff; }
        .pres-iframe-toolbar span { font-size: 13px; color: #666; }
        .pres-iframe-overlay iframe {
            flex: 1; border: none; width: 100%;
        }

        /* Tools panel — clause library items */
        .pv-lib-actions { display: flex; gap: 6px; margin-bottom: 10px; }
        .pv-btn-add-clause {
            background: var(--sw-navy); color: #fff; border: none;
            padding: 6px 12px; border-radius: 4px; font-size: 11px;
            cursor: pointer; font-family: inherit; font-weight: 500;
        }
        .pv-btn-add-clause:hover { background: #3d5043; }
        .pv-clause-item {
            padding: 10px 12px; background: #fff; border: 1px solid rgba(0,0,0,0.08);
            border-radius: 4px; font-size: 13px; color: #333; cursor: grab;
            transition: box-shadow 0.15s, border-color 0.15s; margin-bottom: 6px;
        }
        .pv-clause-item:hover { border-color: var(--sw-navy); box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .pv-clause-item.dragging { opacity: 0.5; }
        .pv-clause-item-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px;
        }
        .pv-clause-item-title { font-weight: 600; font-size: 12px; }
        .pv-clause-item-btns { display: flex; gap: 4px; }
        .pv-clause-item-btn {
            background: none; border: none; font-size: 11px; cursor: pointer;
            color: #888; padding: 1px 4px; border-radius: 2px;
        }
        .pv-clause-item-btn:hover { color: var(--sw-text); background: rgba(0,0,0,0.05); }
        .pv-clause-item-btn.add-to-sub { color: var(--sw-navy); font-size: 14px; font-weight: 700; }
        .pv-clause-item-btn.add-to-sub:hover { background: #e8f5e9; }
        .pv-clause-item-btn.delete:hover { color: #c62828; background: #ffebee; }
        .pv-clause-item-preview {
            font-size: 11px; color: #999; overflow: hidden;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
            line-height: 1.3;
        }
        .pv-clause-empty { font-size: 12px; color: #aaa; font-style: italic; padding: 8px 0; }

        /* Clause edit modal (inline in tools panel) */
        .pv-clause-edit {
            padding: 12px; background: #fff; border: 2px solid var(--sw-navy);
            border-radius: 6px; margin-bottom: 10px;
        }
        .pv-clause-edit label { font-size: 11px; font-weight: 600; color: #666; display: block; margin-bottom: 3px; }
        .pv-clause-edit input, .pv-clause-edit textarea {
            width: 100%; border: 1px solid #ddd; border-radius: 4px;
            padding: 6px 8px; font-size: 12px; font-family: inherit; margin-bottom: 8px;
        }
        .pv-clause-edit input:focus, .pv-clause-edit textarea:focus { outline: none; border-color: var(--sw-navy); }
        .pv-clause-edit textarea { resize: vertical; min-height: 60px; line-height: 1.35; }
        .pv-clause-edit-btns { display: flex; gap: 6px; justify-content: flex-end; }
        .pv-clause-edit-btns button {
            padding: 5px 12px; border-radius: 4px; font-size: 11px;
            cursor: pointer; font-family: inherit; border: none;
        }
        .pv-clause-edit-btns .save { background: var(--sw-navy); color: #fff; }
        .pv-clause-edit-btns .save:hover { background: #3d5043; }
        .pv-clause-edit-btns .cancel { background: #eee; color: #666; }
        .pv-clause-edit-btns .cancel:hover { background: #ddd; }

        /* Responsive — tools panel collapses on small screens */
        @media (max-width: 1100px) {
            .pv-right { width: 300px; min-width: 300px; }
        }
        @media (max-width: 900px) {
            .pv-split { flex-direction: column; }
            .pv-left { padding: 2px 0; }
            .pv-right { width: 100%; min-width: 100%; max-height: 240px; border-left: none; border-top: 1px solid rgba(0,0,0,0.1); }
            .pv-page-room-body { flex-direction: column; }
            .pv-page-room-media { grid-template-columns: 1fr 1fr; }
            .pv-page-room-header { padding: 10px 0; }
        }

        .project-list-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 24px; flex-wrap: wrap; gap: 12px;
        }
        .project-list-title { font-size: 28px; font-weight: 400; }

        .btn-new-project {
            background: var(--sw-navy); color: #fff; border: none;
            padding: 10px 20px; font-size: 14px; cursor: pointer;
            border-radius: 6px; font-family: inherit; transition: background 0.15s;
        }
        .btn-new-project:hover { background: #3d4f41; }

        .project-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }

        .project-card {
            background: #fff; border: 1px solid #e0e0e0; border-radius: 8px;
            padding: 20px; cursor: pointer; transition: all 0.2s; position: relative;
        }
        .project-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.1); transform: translateY(-2px); }

        .project-card-name { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
        .project-card-client { font-size: 13px; color: #666; margin-bottom: 10px; }
        .project-card-meta { display: flex; align-items: center; justify-content: space-between; gap: 8px; }
        .project-card-date { font-size: 11px; color: #999; }

        .project-status-badge {
            display: inline-block; padding: 2px 10px; border-radius: 12px;
            font-size: 11px; font-weight: 600; text-transform: capitalize;
        }
        /* Nouveau workflow */
        .status-draft { background: #f0f0f0; color: #666; }
        .status-pending_internal { background: #e3f2fd; color: #1565c0; }
        .status-returned { background: #fff3e0; color: #e65100; }
        .status-approved_internal { background: #e8f5e9; color: #2e7d32; }
        .status-sent_client { background: #ede7f6; color: #4527a0; }
        .status-accepted { background: #e8f5e9; color: #1b5e20; }
        .status-lost { background: #ffebee; color: #c62828; }
        /* Legacy */
        .status-brouillon { background: #f0f0f0; color: #666; }
        .status-soumis { background: #e3f2fd; color: #1565c0; }
        .status-approuvé { background: #e8f5e9; color: #2e7d32; }
        .status-envoyé { background: #fff3e0; color: #e65100; }
        .status-signé { background: #e8f5e9; color: #1b5e20; }

        /* Soumissions dans la carte projet */
        .project-subs { margin: 10px 0 8px; }
        .sub-line {
            display: flex; align-items: center; gap: 8px; padding: 6px 10px;
            border-radius: 6px; cursor: pointer; transition: background 0.15s;
        }
        .sub-line:hover { background: #f5f5f5; }
        .sub-number { font-size: 12px; font-weight: 700; color: var(--sw-navy); min-width: 40px; }
        .sub-title { font-size: 13px; color: #333; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .sub-empty { font-size: 12px; color: #aaa; padding: 8px 10px; font-style: italic; }
        .btn-add-sub {
            display: block; width: 100%; padding: 6px 0; margin-top: 4px;
            background: none; border: 1px dashed #ccc; border-radius: 6px;
            color: #888; font-size: 12px; cursor: pointer; transition: all 0.15s;
        }
        .btn-add-sub:hover { border-color: var(--sw-navy); color: var(--sw-navy); background: #f7f8fa; }

        /* ── Pipeline — Tabs ── */
        .pipeline-tabs {
            display: flex; gap: 0; margin-bottom: 16px; border-bottom: 2px solid #e0e0e0;
        }
        .pipeline-tab {
            padding: 10px 20px; font-size: 13px; font-weight: 600; color: #888;
            cursor: pointer; border: none; background: none; font-family: inherit;
            border-bottom: 2px solid transparent; margin-bottom: -2px; transition: all 0.15s;
        }
        .pipeline-tab:hover { color: #333; }
        .pipeline-tab.active { color: var(--sw-navy); border-bottom-color: var(--sw-navy); }

        /* ── Pipeline — Filter bar ── */
        .pipeline-filters {
            display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; align-items: center;
        }
        .pipeline-filters input[type="text"] {
            flex: 1; min-width: 180px; padding: 7px 12px; border: 1px solid #ddd;
            border-radius: 6px; font-size: 13px; font-family: inherit;
        }
        .pipeline-filters select {
            padding: 7px 10px; border: 1px solid #ddd; border-radius: 6px;
            font-size: 13px; font-family: inherit; background: #fff; min-width: 140px;
        }
        .pipeline-filter-btn {
            padding: 7px 14px; border: 1px solid #ddd; border-radius: 6px;
            background: #fff; cursor: pointer; font-size: 13px; font-family: inherit;
        }
        .pipeline-filter-btn.active { background: var(--sw-navy); color: #fff; border-color: var(--sw-navy); }

        /* ── Pipeline — Table view ── */
        .pipeline-table-wrap {
            overflow-x: hidden; margin-bottom: 16px; border: 1px solid #e0e0e0; border-radius: 8px;
        }
        .pipeline-table {
            width: 100%; border-collapse: collapse; font-size: 13px; table-layout: fixed;
        }
        .pipeline-table thead th {
            background: #f8f8f8; padding: 10px 14px; text-align: left; font-weight: 600;
            font-size: 11px; text-transform: uppercase; letter-spacing: 0.3px; color: #666;
            cursor: pointer; user-select: none; white-space: nowrap; border-bottom: 1px solid #e0e0e0;
            overflow: hidden; text-overflow: ellipsis;
        }
        .pipeline-table thead th:hover { background: #f0f0f0; }
        .pipeline-table thead th .sort-arrow { font-size: 10px; margin-left: 4px; opacity: 0.4; }
        .pipeline-table thead th.sorted .sort-arrow { opacity: 1; color: var(--sw-navy); }
        .pipeline-table tbody tr {
            cursor: pointer; transition: background 0.1s; border-bottom: 1px solid #f0f0f0;
        }
        .pipeline-table tbody tr:hover { background: #f7f8fa; }
        .pipeline-table tbody td {
            padding: 9px 14px; white-space: nowrap;
            overflow: hidden; text-overflow: ellipsis;
        }
        .pipeline-table tbody td.col-name { font-weight: 500; }
        .pipeline-table tbody td.col-amount { text-align: right; font-family: 'SF Mono', monospace; font-size: 12px; }
        /* Column widths */
        .col-w-follow { width: 36px; text-align: center; }
        .col-w-name { width: auto; }
        .col-w-contact { width: 11%; }
        .col-w-amount { width: 100px; }
        .col-w-prob { width: 60px; }
        .col-w-status { width: 120px; }
        .col-w-deadline { width: 80px; }
        .col-w-resp { width: 10%; }
        .col-w-type { width: 10%; }
        .col-w-delivery { width: 90px; }
        .col-w-more { width: 40px; text-align: center; }
        /* PROB% — always hidden */
        .col-prob-hidden th, .col-prob-hidden td { /* handled via inline class */ }
        .col-always-hidden { display: none !important; }
        /* Responsive column hiding */
        @media (max-width: 1399px) {
            .col-hide-xl { display: none !important; }
        }
        @media (max-width: 1199px) {
            .col-hide-lg { display: none !important; }
        }
        @media (max-width: 991px) {
            .col-hide-md { display: none !important; }
        }
        /* Follow star */
        .follow-star {
            cursor: pointer; font-size: 16px; color: #ccc;
            transition: color 0.15s; user-select: none;
        }
        .follow-star.active { color: #f5a623; }
        .follow-star:hover { color: #f5a623; }
        /* Priority indicator (inline in name cell) */
        .prio-indicator {
            display: inline-block; width: 8px; height: 8px;
            border-radius: 50%; margin-right: 6px; vertical-align: middle;
            cursor: pointer; flex-shrink: 0;
        }
        .prio-indicator.haute { background: #F59E0B; }
        .prio-indicator.urgente { background: #EF4444; }
        .prio-indicator.normal { background: transparent; width: 8px; height: 8px; }
        .prio-indicator:hover { opacity: 0.8; }
        /* Priority dropdown */
        .prio-dropdown {
            position: absolute; top: 100%; left: 0; z-index: 100;
            background: #fff; border: 1px solid #ddd; border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.12); padding: 4px 0;
            min-width: 130px;
        }
        .prio-dropdown-item {
            display: flex; align-items: center; gap: 8px;
            padding: 6px 12px; cursor: pointer; font-size: 13px;
            white-space: nowrap;
        }
        .prio-dropdown-item:hover { background: #f5f5f5; }
        .prio-dropdown-dot {
            display: inline-block; width: 8px; height: 8px; border-radius: 50%;
        }
        .name-cell-inner { display: flex; align-items: center; position: relative; }
        /* More button */
        .tbl-more-btn {
            background: none; border: none; cursor: pointer; font-size: 16px;
            color: #999; padding: 2px 6px; border-radius: 4px; line-height: 1;
        }
        .tbl-more-btn:hover { background: #f0f0f0; color: #333; }
        .pipeline-badge {
            display: inline-block; padding: 2px 10px; border-radius: 12px;
            font-size: 11px; font-weight: 600; white-space: nowrap; cursor: pointer;
        }
        /* ── Status dropdown (Linear/Notion style) ── */
        .status-dropdown {
            position: fixed; z-index: 9999;
            background: #fff; border: 1px solid #e2e8f0;
            border-radius: 10px; box-shadow: 0 4px 24px rgba(0,0,0,0.12), 0 1px 4px rgba(0,0,0,0.06);
            padding: 4px; min-width: 180px;
            transform-origin: top left;
            animation: sdFadeIn 0.12s ease-out;
        }
        @keyframes sdFadeIn {
            from { opacity: 0; transform: scale(0.96) translateY(-4px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        .status-dropdown-item {
            display: flex; align-items: center; gap: 10px;
            padding: 7px 10px; cursor: pointer; font-size: 13px;
            border-radius: 6px; color: var(--sw-text); white-space: nowrap;
            transition: background 0.08s;
        }
        .status-dropdown-item:hover, .status-dropdown-item.sd-focused {
            background: var(--sw-border-2);
        }
        .status-dropdown-item .sd-dot {
            width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
        }
        .status-dropdown-item .sd-label { flex: 1; }
        .status-dropdown-item .sd-check {
            width: 16px; text-align: center; font-size: 13px; color: var(--sw-text-2);
        }
        /* ── Date picker (Apple/Linear style) ── */
        .dp-popover {
            position: fixed; z-index: 9999;
            background: #fff; border: 1px solid #e2e8f0;
            border-radius: 12px; box-shadow: 0 4px 24px rgba(0,0,0,0.12), 0 1px 4px rgba(0,0,0,0.06);
            padding: 12px; width: 264px; user-select: none;
            animation: sdFadeIn 0.12s ease-out;
        }
        .dp-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 8px; padding: 0 2px;
        }
        .dp-header-title {
            font-size: 14px; font-weight: 600; color: var(--sw-text);
            cursor: default;
        }
        .dp-nav {
            display: flex; gap: 2px;
        }
        .dp-nav-btn {
            width: 28px; height: 28px; border: none; background: transparent;
            border-radius: 6px; cursor: pointer; font-size: 16px; color: var(--sw-text-2);
            display: flex; align-items: center; justify-content: center;
            transition: background 0.08s;
        }
        .dp-nav-btn:hover { background: var(--sw-border-2); }
        .dp-weekdays {
            display: grid; grid-template-columns: repeat(7, 1fr);
            text-align: center; font-size: 11px; font-weight: 600;
            color: var(--sw-muted); margin-bottom: 4px;
        }
        .dp-weekdays span { padding: 4px 0; }
        .dp-grid {
            display: grid; grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }
        .dp-day {
            width: 32px; height: 32px; border: none; background: transparent;
            border-radius: 8px; cursor: pointer; font-size: 13px; color: var(--sw-text);
            display: flex; align-items: center; justify-content: center;
            margin: 0 auto; transition: background 0.08s;
        }
        .dp-day:hover { background: var(--sw-border-2); }
        .dp-day.outside { color: #cbd5e1; }
        .dp-day.today { box-shadow: inset 0 0 0 1.5px #cbd5e1; }
        .dp-day.selected { background: var(--sw-navy); color: #fff; }
        .dp-day.selected.today { box-shadow: none; }
        .dp-footer {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--sw-border-2);
        }
        .dp-footer-btn {
            border: none; background: transparent; cursor: pointer;
            font-size: 12px; color: var(--sw-text-2); padding: 4px 8px; border-radius: 6px;
        }
        .dp-footer-btn:hover { background: var(--sw-border-2); color: var(--sw-text); }
        .dp-footer-btn.dp-today-btn { color: var(--sw-navy); font-weight: 600; }
        /* ── Pipeline — Amount override inline edit ── */
        .amount-cell { cursor: pointer; position: relative; }
        .amount-cell:hover { background: rgba(0,0,0,0.03); }
        .inline-editable { cursor: pointer; }
        .inline-editable:hover { background: rgba(0,0,0,0.03); }
        .inline-edit-select, .inline-edit-input {
            width: 100%; padding: 4px 6px; font-size: 12px; font-family: inherit;
            border: 1px solid var(--sw-navy); border-radius: 4px; background: #fff;
            outline: none;
        }
        .amount-override { color: #c62828; }
        .amount-override::after {
            content: attr(data-tooltip); position: absolute; bottom: calc(100% + 4px); right: 0;
            white-space: nowrap; background: #333; color: #fff; font-size: 11px;
            padding: 3px 8px; border-radius: 4px; pointer-events: none;
            opacity: 0; transition: opacity 0.15s; font-family: "Segoe UI", system-ui, sans-serif;
        }
        .amount-override:hover::after { opacity: 1; }
        .amount-inline-input {
            width: 100%; border: 1px solid var(--sw-navy); border-radius: 3px;
            padding: 2px 6px; font-family: 'SF Mono', monospace; font-size: 12px;
            text-align: right; outline: none; background: #fff;
        }

        /* ── Pipeline — Submissions view ── */
        .pipeline-mini-timeline {
            display: inline-flex; align-items: center; gap: 3px;
        }
        .pipeline-table tbody td:has(.pipeline-mini-timeline) { overflow: visible; }
        .pipeline-mini-timeline .tl-dot {
            width: 8px; height: 8px; border-radius: 50%; background: #e0e0e0;
            position: relative; cursor: default;
        }
        .pipeline-mini-timeline .tl-dot.filled { background: var(--sw-navy); }
        .pipeline-mini-timeline .tl-dot.filled.lost { background: #c62828; }
        .pipeline-mini-timeline .tl-dot::after {
            content: attr(data-label); position: absolute; bottom: calc(100% + 6px); left: 50%;
            transform: translateX(-50%); white-space: nowrap;
            background: #333; color: #fff; font-size: 11px; padding: 3px 8px;
            border-radius: 4px; pointer-events: none;
            opacity: 0; transition: opacity 0.15s; z-index: 10;
        }
        .pipeline-mini-timeline .tl-dot:hover::after { opacity: 1; }
        .pipeline-mini-timeline .tl-line {
            width: 6px; height: 2px; background: #e0e0e0;
        }
        .pipeline-mini-timeline .tl-line.filled { background: var(--sw-navy); }

        /* ── Pipeline — Project detail drawer ── */
        .project-drawer-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.25); z-index: 900;
            opacity: 0; transition: opacity 0.2s; pointer-events: none;
        }
        .project-drawer-overlay.open { opacity: 1; pointer-events: auto; }
        .project-drawer {
            position: fixed; top: 0; right: -380px; width: 380px; height: 100%;
            background: #fff; z-index: 901; box-shadow: -4px 0 24px rgba(0,0,0,0.12);
            transition: right 0.25s ease; display: flex; flex-direction: column;
        }
        .project-drawer.open { right: 0; }
        .project-drawer-head {
            display: flex; align-items: center; justify-content: space-between;
            padding: 20px 24px; border-bottom: 1px solid #e8e8e8;
        }
        .project-drawer-head h3 { font-size: 16px; font-weight: 600; margin: 0; }
        .project-drawer-close {
            background: none; border: none; font-size: 22px; cursor: pointer;
            color: #999; line-height: 1; padding: 4px;
        }
        .project-drawer-close:hover { color: #333; }
        .project-drawer-body {
            flex: 1; overflow-y: auto; padding: 24px;
        }
        .drawer-field { margin-bottom: 14px; }
        .drawer-field-label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.4px; color: #999; margin-bottom: 3px; }
        .drawer-field-value { font-size: 14px; color: #222; }
        .drawer-field-value.readonly { color: #666; }
        .drawer-edit {
            width: 100%; padding: 5px 8px; font-size: 13px; font-family: inherit;
            border: 1px solid #ddd; border-radius: 4px; background: #fff; outline: none;
            color: #222; box-sizing: border-box;
        }
        .drawer-edit:focus { border-color: var(--sw-navy); }
        select.drawer-edit { cursor: pointer; }

        /* ── Pipeline — Full-width with side padding ── */
        .project-list-view { margin-left: -60px; margin-right: -60px; padding-left: 48px; padding-right: 48px; }

        /* ── Pipeline — Auto-switch to cards on mobile ── */
        @media (max-width: 767px) {
            #viewTableContainer { display: none !important; }
        }

        /* ── Pipeline — Card enhancements ── */
        .project-card-pipeline {
            display: flex; align-items: center; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;
        }
        .project-card-amount {
            font-size: 14px; font-weight: 600; color: var(--sw-navy);
        }
        .project-card-meta-row {
            display: flex; align-items: center; gap: 12px; font-size: 11px; color: #888; margin-top: 6px;
        }
        .project-card-deadline { color: #c62828; font-weight: 600; }
        .project-card-urgent { border-left: 3px solid #c62828; }

        /* ── Alert badge on project cards ── */
        .project-alert-badge {
            position: absolute; top: 12px; right: 40px;
            min-width: 24px; height: 24px; border-radius: 12px;
            padding: 0 8px; font-size: 11px; font-weight: 700; color: #fff;
            display: flex; align-items: center; justify-content: center;
            cursor: default; z-index: 2;
        }
        .project-alert-badge--orange { background: #f0ad4e; box-shadow: 0 2px 6px rgba(240,173,78,0.4); }
        .project-alert-badge--red { background: #dc3545; box-shadow: 0 2px 6px rgba(220,53,69,0.4); }
        .project-alert-badge .alert-tooltip {
            display: none; position: absolute; top: calc(100% + 8px); right: 0;
            background: #0F172A; color: #fff; padding: 10px 14px; border-radius: 8px;
            font-size: 12px; font-weight: 400; white-space: nowrap; z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); line-height: 1.6;
        }
        .project-alert-badge .alert-tooltip::before {
            content: ''; position: absolute; bottom: 100%; right: 10px;
            border: 6px solid transparent; border-bottom-color: #0F172A;
        }
        .project-alert-badge:hover .alert-tooltip { display: block; }

        /* ── Accept assignment button ── */
        .sa-accept-btn {
            background: #4b6050; color: #fff; border: none;
            padding: 2px 10px; border-radius: 6px; font-size: 11px;
            cursor: pointer; margin-left: 6px;
        }
        .sa-accept-btn:hover { background: #3a4d3f; }

        /* ── Alert dot in table view ── */
        .project-alert-dot {
            display: inline-block; width: 8px; height: 8px; border-radius: 50%;
            margin-right: 6px; vertical-align: middle;
        }
        .project-alert-dot--orange { background: #f0ad4e; }
        .project-alert-dot--red { background: #dc3545; }

        /* ── Pipeline — Submission assignment ── */
        .sub-assignment-row {
            display: flex; gap: 12px; flex-wrap: wrap; margin-top: 10px; padding-top: 10px;
            border-top: 1px solid #f0f0f0;
        }
        .sub-assignment-row .sa-field {
            display: flex; flex-direction: column; gap: 3px; flex: 1; min-width: 120px;
        }
        .sub-assignment-row .sa-label {
            font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; color: #999;
        }
        .sub-assignment-row select, .sub-assignment-row input[type="date"] {
            padding: 5px 8px; border: 1px solid #ddd; border-radius: 4px;
            font-size: 12px; font-family: inherit; background: #fff;
        }

        /* Panneau soumissions dans le calculateur */
        .header-sub-panel {
            display: none; background: #fff; border: 1px solid #e0e0e0; border-radius: 8px;
            padding: 10px 14px; margin: -8px 0 16px;
        }
        .header-sub-panel .sub-line {
            display: flex; align-items: center; gap: 8px;
            padding: 6px 8px; border-radius: 4px; cursor: pointer;
        }
        .header-sub-panel .sub-line:hover { background: #f5f5f5; }
        .header-sub-panel .sub-line.active { background: #eef3ef; }
        .header-sub-panel .sub-line.active .sub-number { color: var(--sw-text); }
        .header-sub-panel .sub-line .sub-kebab {
            margin-left: auto; background: none; border: none;
            color: #999; cursor: pointer; font-size: 16px; padding: 2px 6px;
            font-family: inherit; border-radius: 4px;
        }
        .header-sub-panel .sub-line .sub-kebab:hover { color: #333; background: #e0e0e0; }
        .header-sub-panel .header-sub-label {
            font-size: 11px; font-weight: 600; color: #888; text-transform: uppercase;
            letter-spacing: 0.5px; margin-bottom: 6px; cursor: pointer; user-select: none;
            display: flex; align-items: center; gap: 6px;
        }
        .header-sub-panel .header-sub-label:hover { color: #555; }
        .header-sub-label .sub-chevron { transition: transform 0.2s; display: inline-block; font-size: 10px; }
        .header-sub-label .sub-chevron.open { transform: rotate(90deg); }
        .header-sub-body {
            overflow: hidden; transition: max-height 0.25s ease, opacity 0.2s ease;
            max-height: 500px; opacity: 1;
        }
        .header-sub-body.collapsed { max-height: 0; opacity: 0; }

        /* ── Matériaux par défaut section — same style as header-sub-panel ── */
        .default-materials-panel {
            background: #fff; border: 1px solid #e0e0e0; border-radius: 8px;
            padding: 10px 14px; margin: -8px 0 16px; overflow: visible; position: relative; z-index: 2;
        }
        .default-materials-panel .dm-label {
            font-size: 11px; font-weight: 600; color: #888; text-transform: uppercase;
            letter-spacing: 0.5px; margin-bottom: 6px; cursor: pointer; user-select: none;
            display: flex; align-items: center; gap: 6px;
        }
        .default-materials-panel .dm-label:hover { color: #555; }
        .dm-label .dm-arrow { transition: transform 0.2s; display: inline-block; font-size: 10px; }
        .dm-label .dm-arrow.open { transform: rotate(90deg); }
        .default-materials-body {
            overflow: visible; transition: max-height 0.3s ease, opacity 0.2s ease;
            max-height: 600px; opacity: 1; padding-top: 8px;
        }
        .default-materials-body.collapsed { max-height: 0; opacity: hidden; padding-top: 0; overflow: hidden; }
        .dm-rows { display: flex; flex-direction: column; gap: 6px; margin-bottom: 8px; }
        .dm-row {
            display: flex; gap: 6px; align-items: center; font-size: 12px;
        }
        .dm-row select {
            width: 180px; padding: 5px 8px; border: 1px solid #ddd; border-radius: 4px;
            font-size: 12px; font-family: inherit; background: #fff; flex-shrink: 0;
        }
        .dm-row select:focus { border-color: var(--sw-navy); outline: none; }
        .dm-search-wrap {
            flex: 1; position: relative;
        }
        .dm-search-wrap input {
            width: 100%; padding: 5px 8px; border: 1px solid #ddd; border-radius: 4px;
            font-size: 12px; font-family: inherit; box-sizing: border-box;
        }
        .dm-search-wrap input:focus { border-color: var(--sw-navy); outline: none; }
        .dm-search-wrap input.dm-resolved {
            background: #edf1f7; border-color: var(--sw-navy); color: #333;
        }
        .dm-autocomplete {
            position: absolute; top: 100%; left: 0; right: 0; z-index: 100;
            background: #fff; border: 1px solid #ddd; border-top: none; border-radius: 0 0 4px 4px;
            max-height: 280px; overflow-y: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: none;
        }
        .dm-autocomplete.open { display: block; }
        .dm-ac-item {
            padding: 6px 10px; cursor: pointer; font-size: 12px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .dm-ac-item:hover, .dm-ac-item.active { background: #edf1f7; }
        .dm-ac-item .dm-ac-cat { font-size: 10px; color: #999; }
        .dm-ac-item .dm-ac-secondary { font-size: 10px; color: #999; margin-left: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 160px; }
        .dm-row .dm-remove {
            background: none; border: none; color: #ccc; cursor: pointer; font-size: 16px;
            padding: 0 4px; flex-shrink: 0; line-height: 1;
        }
        .dm-row .dm-remove:hover { color: #c62828; }
        .dm-add-btn {
            font-size: 12px; color: var(--sw-navy); background: none; border: 1px dashed #ccc;
            cursor: pointer; padding: 6px 12px; border-radius: 4px; width: 100%;
        }
        .dm-add-btn:hover { border-color: var(--sw-navy); background: #edf1f7; }
        .dm-sub-hint {
            font-size: 10px; color: #aaa; margin: -4px 0 6px 16px; font-style: italic;
        }

        /* ── Room-level default materials ── */
        .room-dm-section {
            padding: 6px 14px; border-bottom: 1px solid #eee; overflow: visible; position: relative;
        }
        .room-dm-label {
            font-size: 11px; font-weight: 600; color: #888; text-transform: uppercase;
            letter-spacing: 0.5px; cursor: pointer; user-select: none;
            display: flex; align-items: center; gap: 6px;
        }
        .room-dm-label:hover { color: #555; }
        .room-dm-arrow { transition: transform 0.2s; display: inline-block; font-size: 10px; }
        .room-dm-arrow.open { transform: rotate(90deg); }
        .room-dm-badge {
            font-size: 10px; font-weight: 500; color: var(--sw-navy); background: #edf1f7;
            padding: 1px 8px; border-radius: 10px; margin-left: 4px;
        }
        .room-dm-body {
            overflow: visible; transition: max-height 0.3s ease, opacity 0.2s ease;
            max-height: 500px; opacity: 1; padding-top: 8px;
        }
        .room-dm-body.collapsed { max-height: 0; opacity: 0; padding-top: 0; overflow: hidden; }
        .rdm-rows { display: flex; flex-direction: column; gap: 6px; margin-bottom: 8px; }
        .rdm-actions { display: flex; gap: 6px; align-items: center; }
        .rdm-actions .dm-add-btn { flex: 1; width: auto; }
        .rdm-copy-btn {
            font-size: 12px; color: #666; background: none; border: 1px solid #ddd;
            cursor: pointer; padding: 6px 12px; border-radius: 4px; white-space: nowrap;
        }
        .rdm-copy-btn:hover { border-color: var(--sw-navy); color: var(--sw-navy); background: #edf1f7; }
        .rdm-clear-btn {
            font-size: 12px; color: #c62828; background: none; border: 1px solid #f5c6cb;
            cursor: pointer; padding: 6px 12px; border-radius: 4px; white-space: nowrap; margin-left: auto;
        }
        .rdm-clear-btn:hover { border-color: #c62828; background: #fdecea; }
        .rdm-fallback-hint {
            font-size: 11px; color: #aaa; font-style: italic; padding: 4px 0;
        }
        .rdm-copy-dropdown {
            background: #fff; border: 1px solid #e0e0e0; border-radius: 10px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1); min-width: 180px; padding: 4px 0;
            animation: sdFadeIn 0.12s ease;
        }
        .rdm-copy-item {
            padding: 8px 14px; font-size: 13px; cursor: pointer; color: #333;
        }
        .rdm-copy-item:hover { background: #f1f5f9; }

        /* ── Main action buttons ── */
        .ph-actions { display: none; /* replaced by timeline CTA */ }
        .btn-main-action {
            display: none; padding: 12px 28px; font-size: 15px; font-weight: 600;
            border: none; border-radius: 8px; cursor: pointer; font-family: inherit;
            transition: opacity 0.15s; background: #1565c0; color: #fff;
        }
        .btn-main-action:hover { opacity: 0.85; }
        .btn-main-green { background: var(--sw-navy); color: #fff; }
        .btn-main-orange { background: #e65100; color: #fff; }
        .btn-main-purple { background: #4527a0; color: #fff; }
        .btn-main-red { background: #c0392b; color: #fff; }

        /* ── Kebab menu ── */
        .kebab-menu { position: relative; }
        .btn-kebab {
            background: #f5f5f5; border: 1px solid #e0e0e0; border-radius: 50%;
            width: 32px; height: 32px; font-size: 16px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            color: #666; transition: all 0.15s; font-family: inherit;
        }
        .btn-kebab:hover { background: #eee; border-color: #ccc; }
        .btn-kebab.active { background: var(--sw-navy); color: #fff; border-color: var(--sw-navy); }
        .kebab-dropdown {
            display: none; position: absolute; top: 100%; right: 0; margin-top: 4px;
            background: #fff; border: 1px solid #e0e0e0; border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1); min-width: 180px; z-index: 100;
            padding: 4px 0;
        }
        .kebab-dropdown.open { display: block; }
        .kebab-dropdown button {
            display: flex; align-items: center; gap: 10px; width: 100%;
            background: none; border: none; padding: 10px 16px; font-size: 13px;
            font-family: inherit; cursor: pointer; color: #333; text-align: left;
        }
        .kebab-dropdown button:hover { background: #f5f5f5; }
        .kebab-icon { font-size: 15px; width: 20px; text-align: center; }

        /* Version Drawer */
        .version-drawer { position:fixed; right:0; top:0; width:360px; height:100vh; background:#fff; box-shadow:-4px 0 20px rgba(0,0,0,.15); z-index:1000; display:flex; flex-direction:column; transition:transform .3s ease; }
        .version-drawer-header { padding:16px 20px; border-bottom:1px solid #e0e0e0; display:flex; justify-content:space-between; align-items:center; }
        .version-drawer-header h3 { margin:0; font-size:16px; }
        .btn-close-drawer { background:none; border:none; font-size:22px; cursor:pointer; color:#666; padding:4px 8px; }
        .btn-close-drawer:hover { color:#000; }
        .version-list { flex:1; overflow-y:auto; padding:12px; }
        .version-card { padding:12px; border:1px solid #e0e0e0; border-radius:8px; margin-bottom:8px; cursor:pointer; transition:all .15s; }
        .version-card:hover { background:#f5f5f5; border-color:#bbb; }
        .version-snapshot-overlay { position:fixed; inset:0; background:rgba(0,0,0,.85); z-index:1100; overflow-y:auto; padding:40px; }

        .bypass-badge {
            display: inline-block; background: #ffebee; color: #c0392b;
            font-size: 9px; font-weight: 700; padding: 2px 6px;
            border-radius: 3px; margin-left: 6px; text-transform: uppercase;
            letter-spacing: 0.3px; vertical-align: middle;
        }
        .timeline-dot-bypass { background: #c0392b; }
        .timeline-action-bypass { color: #c0392b; font-weight: 700; }
        .timeline-comment-bypass { background: #ffebee; border-left: 3px solid #c0392b; padding: 6px 10px; border-radius: 4px; }
        .timeline-dot-offline_accepted { background: #2e7d32; }
        .timeline-action-offline_accepted { color: #2e7d32; font-weight: 700; }
        .timeline-comment-offline_accepted { background: #e8f5e9; border-left: 3px solid #2e7d32; padding: 6px 10px; border-radius: 4px; }
        .timeline-dot-duplicated { background: #546e7a; }
        .timeline-action-duplicated { color: #546e7a; font-weight: 700; }
        .timeline-dot-unlocked { background: #c62828; }
        .timeline-action-unlocked { color: #c62828; font-weight: 700; text-transform: uppercase; }
        .timeline-comment-unlocked { background: #ffebee; border-left: 3px solid #c62828; padding: 6px 10px; border-radius: 4px; font-weight: 600; }
        .status-badge {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 5px 12px; font-size: 11px; font-weight: 700;
            border-radius: 12px; text-transform: uppercase; letter-spacing: 0.3px;
        }
        .status-draft { background: #f0f0f0; color: #666; }
        .status-pending_internal { background: #fff3e0; color: #e65100; }
        .status-returned { background: #fce4ec; color: #c62828; }
        .status-approved_internal { background: #e8f5e9; color: #2e7d32; }
        .status-sent_client { background: #e3f2fd; color: #1565c0; }
        .status-accepted { background: #e8f5e9; color: #1b5e20; }
        .status-lost { background: #ffebee; color: #c62828; }

        .project-card-delete {
            position: absolute; top: 8px; right: 8px; background: none; border: none;
            color: #ccc; cursor: pointer; font-size: 18px; padding: 4px 8px;
            border-radius: 4px; transition: all 0.15s; line-height: 1;
        }
        .project-card-delete:hover { color: #c62828; background: #ffebee; }
        .card-follow { font-size: 18px; flex-shrink: 0; }

        .project-empty {
            text-align: center; padding: 60px 20px; color: #999; font-size: 15px;
        }

        /* Formulaire nouveau projet (inline) */
        .new-project-form {
            display: none; background: #f8f8f8; border: 1px solid #e0e0e0;
            border-radius: 8px; padding: 20px; margin-bottom: 20px;
        }
        .new-project-form.active { display: block; }
        .new-project-form .form-row {
            display: flex; gap: 12px; margin-bottom: 12px; flex-wrap: wrap;
        }
        .new-project-form input {
            flex: 1; min-width: 200px; padding: 10px 14px; font-size: 14px;
            border: 1px solid #ccc; border-radius: 6px; font-family: inherit;
        }
        .new-project-form input:focus { outline: none; border-color: var(--sw-navy); }
        .new-project-form-actions { display: flex; gap: 8px; }
        .btn-create-project {
            background: var(--sw-navy); color: #fff; border: none;
            padding: 10px 20px; font-size: 14px; cursor: pointer;
            border-radius: 6px; font-family: inherit;
        }
        .btn-create-project:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-cancel-project {
            background: #fff; color: #666; border: 1px solid #ccc;
            padding: 10px 20px; font-size: 14px; cursor: pointer;
            border-radius: 6px; font-family: inherit;
        }

        /* ═══════════════════════════════════════════════════════════════
           HEADER PROJET (dans le calculateur)
           ═══════════════════════════════════════════════════════════════ */

        .project-header {
            background: #fff; border: 1px solid #e0e0e0; border-radius: 8px;
            padding: 20px 24px; margin-bottom: 16px; position: relative;
            display: flex; flex-direction: column; gap: 4px;
        }
        .ph-top-bar {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 8px;
        }
        .ph-top-actions { display: flex; align-items: center; gap: 8px; }
        .btn-back-projects {
            background: none; border: none; color: var(--sw-navy);
            cursor: pointer; font-size: 14px; font-family: inherit;
            padding: 6px 0; white-space: nowrap;
        }
        .btn-back-projects:hover { text-decoration: underline; }
        .btn-header-link {
            background: none; border: none; color: #555; font-size: 13px;
            font-family: inherit; cursor: pointer; padding: 4px 8px;
            transition: color 0.15s;
        }
        .btn-header-link:hover { color: var(--sw-navy); }
        .ai-assistant-btn { vertical-align: middle; }
        .ph-project-name {
            font-size: 26px; font-weight: 700; border: none; outline: none;
            background: transparent; font-family: inherit; color: var(--sw-text);
            padding: 0; width: 100%; user-select: none; pointer-events: none; cursor: default;
        }
        .ph-sub-number { font-size: 13px; color: #999; font-weight: 400; display: block; margin-top: 2px; }
        .ph-status-row { margin: 4px 0; }
        .ph-total-section { margin: 12px 0 4px; }
        .ph-total-label { font-size: 12px; color: #888; margin-bottom: 2px; }
        .ph-total-amount { font-size: 28px; font-weight: 700; color: var(--sw-text); }
        .save-indicator {
            font-size: 11px; color: #999; white-space: nowrap;
            position: absolute; top: 8px; right: 12px;
        }
        .save-indicator.saving { color: var(--sw-navy); }

        /* Status Timeline */
        .status-timeline {
            margin: 16px 0 4px; display: flex; align-items: center; gap: 0;
            position: relative;
        }
        .timeline-step {
            display: flex; align-items: center; gap: 6px; position: relative; flex: 0 0 auto;
            padding-right: 16px;
        }
        .timeline-step:last-child { padding-right: 0; }
        .timeline-step::after {
            content: ''; position: absolute; right: -1px; top: 50%;
            transform: translateY(-50%); width: 24px; height: 1px; background: #ddd;
        }
        .timeline-step:last-child::after { display: none; }
        .timeline-step.completed::after { background: #4caf50; }
        .timeline-circle {
            width: 20px; height: 20px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; font-size: 11px; flex-shrink: 0;
        }
        .timeline-step.completed .timeline-circle {
            background: #4caf50; color: #fff;
        }
        .timeline-step.active .timeline-circle {
            background: var(--sw-navy); color: #fff; box-shadow: 0 0 0 3px rgba(11,18,32,0.15);
        }
        .timeline-step.active.returned .timeline-circle {
            background: #ff9800; box-shadow: 0 0 0 3px rgba(255,152,0,0.15);
        }
        .timeline-step.active.lost .timeline-circle {
            background: #c62828; box-shadow: 0 0 0 3px rgba(198,40,40,0.15);
        }
        .timeline-step.future .timeline-circle {
            background: #f0f0f0; color: #bbb; border: 1px solid #ddd;
        }
        .timeline-label {
            font-size: 12px; color: #666; white-space: nowrap;
        }
        .timeline-step.active .timeline-label {
            font-weight: 700; color: var(--sw-text);
        }
        .timeline-step.completed .timeline-label {
            color: #666;
        }
        .timeline-cta {
            margin-left: auto; padding-left: 16px; display: flex; gap: 8px; align-items: center;
        }
        .timeline-cta button {
            background: var(--sw-navy); color: #fff; border: none; padding: 8px 20px;
            border-radius: 6px; font-size: 13px; font-weight: 600; font-family: inherit;
            cursor: pointer; transition: all 0.15s; white-space: nowrap;
        }
        .timeline-cta button:hover {
            background: #3e4f42; transform: translateY(-1px); box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        .timeline-cta button.btn-orange {
            background: #ff9800;
        }
        .timeline-cta button.btn-orange:hover {
            background: #f57c00;
        }
        .timeline-cta button.btn-outline-orange {
            background: transparent; color: #e65100; border: 1.5px solid #e65100;
        }
        .timeline-cta button.btn-outline-orange:hover {
            background: #fff3e0; box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        .timeline-cta button.btn-outline {
            background: transparent; color: #555; border: 1.5px solid #ccc;
        }
        .timeline-cta button.btn-outline:hover {
            background: #f5f5f5; box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        .timeline-cta button.btn-outline-red {
            background: transparent; color: #c62828; border: 1.5px solid #c62828;
        }
        .timeline-cta button.btn-outline-red:hover {
            background: #ffebee; box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        .sub-line.archived { opacity: 0.5; }

        /* Timeline step clickable (pour copier lien client) */
        .timeline-step.clickable {
            cursor: pointer;
        }
        .timeline-step.clickable .timeline-circle {
            animation: heartbeat 2s ease-in-out infinite;
        }
        .timeline-step.clickable:hover .timeline-circle {
            transform: scale(1.1);
            box-shadow: 0 0 0 4px rgba(11,18,32,0.25);
        }
        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            14% { transform: scale(1.15); }
            28% { transform: scale(1); }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        @keyframes ai-breathe {
            0%, 100% { opacity: 0.6; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.1); }
        }
        @keyframes scope-flash {
            0% { background: rgba(75, 96, 80, 0.25); }
            100% { background: #edf0f5; }
        }
        .ai-scope-badge.flash {
            animation: scope-flash 500ms ease-out;
        }

        /* Modal Rentabilité */
        /* ── Rentabilité modal ── */
        .rentab-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4); z-index: 9000; justify-content: center; align-items: flex-start; padding: 40px 20px;
        }
        .rentab-overlay.active { display: flex; }
        .rentab-modal {
            background: #fff; border-radius: 10px; max-width: 1100px; width: 100%;
            max-height: 90vh; overflow-y: auto; box-shadow: 0 8px 40px rgba(0,0,0,0.2);
        }
        .rentab-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px 32px; border-bottom: 1px solid #e8e8e8;
        }
        .rentab-header h2 { font-size: 18px; font-weight: 600; color: var(--sw-text); margin: 0; }
        .rentab-close {
            background: none; border: none; font-size: 24px; cursor: pointer; color: #999;
            padding: 4px 8px; transition: color 0.15s;
        }
        .rentab-close:hover { color: var(--sw-text); }
        .rentab-body { padding: 28px 32px; }
        .rentab-columns { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; }
        .rentab-section { margin-bottom: 24px; }
        .rentab-section-title {
            font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
            color: #666; margin-bottom: 10px; padding-bottom: 6px; border-bottom: 1px solid #e8e8e8;
        }
        .rentab-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .rentab-table td { padding: 6px 10px; }
        .rentab-table td:first-child { color: #555; font-weight: 400; }
        .rentab-table td:last-child { text-align: right; font-weight: 600; font-family: 'SF Mono', 'Consolas', monospace; color: var(--sw-text); }
        .rentab-table tr.highlight td { background: #f5f5f5; font-weight: 700; color: var(--sw-text); border-radius: 4px; }
        .rentab-table tr.highlight td:first-child { font-size: 12px; text-transform: uppercase; letter-spacing: 0.3px; }
        .rentab-table tr.total td { border-top: 1px solid #ccc; font-weight: 700; font-size: 14px; padding-top: 10px; }
        .rentab-table tr.spacer td { padding: 8px 0; }
        .rentab-dept-table { width: 100%; border-collapse: collapse; font-size: 12px; border: 1px solid #e8e8e8; border-radius: 6px; overflow: hidden; }
        .rentab-dept-table th {
            background: #f5f5f5; color: #666; padding: 8px 8px;
            font-weight: 600; font-size: 11px; text-align: center; border-bottom: 1px solid #e8e8e8;
        }
        .rentab-dept-table td { padding: 8px 8px; text-align: right; font-family: 'SF Mono', 'Consolas', monospace; color: var(--sw-text); }
        .rentab-dept-table td:first-child { text-align: left; font-family: inherit; color: #555; font-weight: 500; }
        .rentab-margins {
            margin-top: 8px; border: 1px solid #e8e8e8; border-radius: 6px; overflow: hidden;
        }
        .rentab-margins-row {
            display: flex; justify-content: space-between; padding: 8px 14px;
            font-size: 13px; border-bottom: 1px solid #eee; align-items: center;
        }
        .rentab-margins-row:last-child { border-bottom: none; }
        .rentab-margins-row.profit-row { background: #f5f5f5; font-weight: 700; }
        .rentab-margins-row span:first-child { color: #555; }
        .rentab-margins-row span:last-child { font-weight: 600; font-family: 'SF Mono', 'Consolas', monospace; color: var(--sw-text); }
        .rentab-full { grid-column: 1 / -1; }
        .rentab-footer {
            padding: 16px 32px 24px; display: flex; justify-content: flex-end;
        }
        .rentab-footer button {
            padding: 10px 28px; background: #fff; border: 1px solid #ddd; border-radius: 6px;
            font-size: 14px; font-family: inherit; cursor: pointer; color: #333; transition: all 0.15s;
        }
        .rentab-footer button:hover { background: #f5f5f5; border-color: #bbb; }
        .btn-rentab {
            background: none; border: 1px solid rgba(255,255,255,0.4); color: rgba(255,255,255,0.85);
            padding: 4px 10px; border-radius: 4px; font-size: 11px; cursor: pointer; white-space: nowrap;
            font-family: inherit; transition: all 0.15s;
        }
        .btn-rentab:hover { background: rgba(255,255,255,0.15); border-color: rgba(255,255,255,0.7); }
        .btn-ai-focus {
            display: inline-flex; align-items: center; justify-content: center;
            width: 28px; height: 28px; padding: 0; border: none;
            background: transparent; cursor: pointer; position: relative;
            vertical-align: middle;
        }
        .btn-ai-focus::after {
            content: ''; display: block; width: 9px; height: 9px;
            border-radius: 50%; background: #fff;
            opacity: 0.6; box-shadow: 0 0 0 3px rgba(255,255,255,0.12);
            transition: all 200ms ease;
            animation: ai-breathe 3s ease-in-out infinite;
        }
        .btn-ai-focus:hover::after { opacity: 1; transform: scale(1.05); }
        .btn-ai-focus.active::after {
            opacity: 1; box-shadow: 0 0 0 4px rgba(255,255,255,0.25);
            animation: none;
        }
        /* Print */
        @media print {
            .nav-bar { display: none; }
            .btn-add, .btn-remove, .add-row-container, .group-images-section { display: none !important; }
            .item-select { border: none; background: none; padding: 0; appearance: none; background-image: none; }
            .qty-input { border: none; background: none; }
            .ajout-edit-btn { border: none; background: none; }
            .btn-room-modifier, .room-modifier-badge { display: none; }
            .calculator-container { page-break-inside: avoid; }
        }

        /* Responsive */
        @media (max-width: 900px) {
            .nav-bar { padding: 0 20px; gap: 16px; }
            .main-content { padding: 24px 16px; }
            .project-list-view { margin-left: -16px; margin-right: -16px; padding-left: 16px; padding-right: 16px; }
            .calc-header, .calc-row {
                grid-template-columns: 24px 45px 1fr 70px 70px 170px 90px 80px 24px 100px 24px;
                gap: 4px;
                padding: 3px 8px;
                font-size: 10px;
            }
            .btn-add, .btn-remove, .btn-add-group { font-size: 12px; }
            .ajout-edit-btn { font-size: 10px !important; }
            .calculator-container { font-size: 13px; }
        }

        /* ═══════════════════════════════════════════════════════════════
           TIMELINE DRAWER (historique soumission)
           ═══════════════════════════════════════════════════════════════ */
        .timeline-drawer-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.3); z-index: 8500;
        }
        .timeline-drawer-overlay.active { display: block; }
        .timeline-drawer {
            position: fixed; top: 0; right: -420px; width: 400px; height: 100%;
            background: #fff; box-shadow: -4px 0 20px rgba(0,0,0,0.15);
            z-index: 8600; transition: right 0.3s ease; overflow-y: auto;
        }
        .timeline-drawer.active { right: 0; }
        .timeline-drawer-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 20px; border-bottom: 2px solid var(--sw-navy);
            background: #fafafa; position: sticky; top: 0; z-index: 1;
        }
        .timeline-drawer-header h3 { font-size: 15px; font-weight: 700; margin: 0; color: var(--sw-text); }
        .timeline-drawer-close {
            background: none; border: none; font-size: 20px; cursor: pointer; color: #666; padding: 0 4px;
        }
        .timeline-drawer-close:hover { color: var(--sw-text); }
        .timeline-drawer-body { padding: 20px; }
        .timeline-empty { text-align: center; color: #999; font-size: 13px; padding: 40px 0; font-style: italic; }

        .timeline-entry { position: relative; padding-left: 28px; margin-bottom: 20px; }
        .timeline-entry::before {
            content: ''; position: absolute; left: 8px; top: 24px; bottom: -20px;
            width: 2px; background: #e0e0e0;
        }
        .timeline-entry:last-child::before { display: none; }
        .timeline-dot {
            position: absolute; left: 2px; top: 6px; width: 14px; height: 14px;
            border-radius: 50%; border: 2px solid #fff;
        }
        .timeline-dot-submitted { background: #1565c0; }
        .timeline-dot-approved { background: #2e7d32; }
        .timeline-dot-returned { background: #e65100; }
        .timeline-dot-sent { background: #4527a0; }
        .timeline-entry-header {
            display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 4px;
        }
        .timeline-action {
            font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px;
        }
        .timeline-action-submitted { color: #1565c0; }
        .timeline-action-approved { color: #2e7d32; }
        .timeline-action-returned { color: #e65100; }
        .timeline-action-sent { color: #4527a0; }
        .timeline-date { font-size: 11px; color: #999; }
        .timeline-reviewer { font-size: 12px; color: #666; margin-bottom: 4px; }
        .timeline-comment {
            font-size: 13px; color: #444; background: #f8f8f8;
            border-radius: 6px; padding: 8px 12px; border-left: 3px solid #e0e0e0;
        }
        .timeline-comment-submitted { border-left-color: #1565c0; }
        .timeline-comment-approved { border-left-color: #2e7d32; }
        .timeline-comment-returned { border-left-color: #e65100; }
        .timeline-comment-sent { border-left-color: #4527a0; }
        .timeline-version { font-size: 10px; color: #aaa; margin-top: 4px; }

        @media (max-width: 600px) {
            .timeline-drawer { width: 100%; right: -100%; }
        }

        /* ═══════════════════════════════════════════════════════════════
           AI ASSISTANT DRAWER — Premium Redesign
           ═══════════════════════════════════════════════════════════════ */

        @keyframes aiMsgFadeIn {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes aiCardStagger {
            from { opacity: 0; transform: translateY(3px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .ai-drawer-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: transparent; z-index: 8700; pointer-events: none;
        }
        .ai-drawer-overlay.active { display: block; }

        .ai-drawer {
            position: fixed; top: 0; right: -460px; width: 440px; height: 100%;
            background: rgba(255, 255, 255, 0.82);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border-left: 1px solid rgba(0, 0, 0, 0.06);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.06), inset 0 1px 0 rgba(255, 255, 255, 0.4);
            z-index: 8800; transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; flex-direction: column;
        }
        .ai-drawer.active { right: 0; }
        .ai-drawer:hover, .ai-drawer:focus-within {
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
        }

        /* Header — minimal */
        .ai-drawer-header {
            display: flex; align-items: center; gap: 10px;
            padding: 16px 20px; border-bottom: 1px solid rgba(0, 0, 0, 0.06);
            background: transparent; flex-shrink: 0;
        }
        .ai-drawer-header h3 {
            font-size: 14px; font-weight: 600; margin: 0;
            color: #1A1A2E; flex: 1; letter-spacing: -0.01em;
        }
        .ai-scope-badge {
            font-size: 10px; font-weight: 500; padding: 3px 8px;
            border-radius: 10px; background: #edf0f5; color: var(--sw-navy);
            text-transform: uppercase; letter-spacing: 0.3px;
        }
        .ai-drawer-close {
            background: none; border: none; font-size: 18px;
            cursor: pointer; color: #9ca3af; padding: 2px 4px;
            transition: color 0.15s; border-radius: 6px;
        }
        .ai-drawer-close:hover { color: #1A1A2E; }

        /* Messages area */
        .ai-messages {
            flex: 1; min-height: 0; overflow-y: auto; padding: 20px;
            display: flex; flex-direction: column; gap: 16px;
            overscroll-behavior: contain;
            scrollbar-width: thin; scrollbar-color: #e5e7eb transparent;
        }
        .ai-messages::before { content: ''; flex: 1 1 0; }
        .ai-messages::-webkit-scrollbar { width: 5px; }
        .ai-messages::-webkit-scrollbar-track { background: transparent; }
        .ai-messages::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 3px; }
        .ai-messages::-webkit-scrollbar-thumb:hover { background: #d1d5db; }
        .ai-messages:empty::after {
            content: 'Posez une question sur votre projet, demandez une analyse de rentabilit\00e9, ou d\00e9crivez ce que vous voulez ajouter.';
            color: #9ca3af; font-size: 13px; text-align: center; padding: 40px 24px;
            line-height: 1.6;
        }

        /* Message base */
        .ai-msg {
            max-width: 85%; padding: 0; border-radius: 0;
            font-size: 14px; line-height: 1.5; word-wrap: break-word;
            color: #1A1A2E;
            animation: aiMsgFadeIn 140ms ease-out both;
        }
        .ai-msg p { margin: 0 0 8px 0; }
        .ai-msg p:last-child { margin-bottom: 0; }
        .ai-msg ul, .ai-msg ol { margin: 6px 0; padding-left: 20px; }
        .ai-msg li { margin-bottom: 4px; }
        .ai-msg strong { font-weight: 600; }
        .ai-msg code {
            background: #f3f4f6; padding: 2px 6px; border-radius: 4px;
            font-size: 13px; font-family: 'SF Mono', 'Cascadia Code', 'Consolas', monospace;
        }
        .ai-msg pre {
            background: #f8f9fa; padding: 12px 14px; border-radius: 8px;
            overflow-x: auto; font-size: 12px; margin: 8px 0;
            font-family: 'SF Mono', 'Cascadia Code', 'Consolas', monospace;
            line-height: 1.5;
        }

        /* Cards — replace tables */
        .ai-msg .ai-card-stack { display: flex; flex-direction: column; gap: 6px; margin: 10px 0; }
        .ai-msg .ai-card {
            background: #F8FAFC; border-radius: 10px; padding: 12px 14px;
            animation: aiCardStagger 180ms ease-out both;
        }
        .ai-msg .ai-card-row {
            display: flex; justify-content: space-between; align-items: baseline;
        }
        .ai-msg .ai-card-code {
            font-size: 12px; font-weight: 600; color: #6B7280;
            font-family: 'SF Mono', 'Cascadia Code', 'Consolas', monospace;
            letter-spacing: 0.02em;
        }
        .ai-msg .ai-card-price {
            font-size: 13px; font-weight: 600; color: #1A1A2E;
            font-family: 'SF Mono', 'Cascadia Code', 'Consolas', monospace;
        }
        .ai-msg .ai-card-desc {
            font-size: 13px; color: #374151; margin-top: 2px; line-height: 1.4;
        }
        .ai-msg .ai-card-meta {
            font-size: 11px; color: #9ca3af; margin-top: 4px;
        }

        /* Legacy table fallback — soft styling */
        .ai-msg table {
            width: 100%; border-collapse: separate; border-spacing: 0;
            margin: 8px 0; font-size: 13px; border-radius: 8px;
            overflow: hidden; background: #F8FAFC;
        }
        .ai-msg th, .ai-msg td {
            padding: 8px 12px; border: none; text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }
        .ai-msg th {
            background: var(--sw-border-2); font-weight: 600; font-size: 11px;
            color: #6B7280; text-transform: uppercase; letter-spacing: 0.04em;
        }
        .ai-msg tr:last-child td { border-bottom: none; }

        /* User messages */
        .ai-msg-user {
            align-self: flex-end; background: rgba(15,28,45,0.06);
            padding: 10px 14px; border-radius: 10px;
        }

        /* Assistant messages */
        .ai-msg-assistant {
            align-self: flex-start; background: #FFFFFF;
            padding: 10px 14px; border-radius: 10px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.04);
        }

        /* Action messages */
        .ai-msg-action {
            align-self: flex-start; background: #FFFBEB;
            border-radius: 10px; padding: 10px 14px; font-size: 13px; color: #92400e;
            max-width: 92%;
        }
        .ai-msg-action .ai-action-label {
            font-weight: 600; font-size: 11px; color: #b45309;
            text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 4px;
        }

        /* Confirm messages — CTA style */
        .ai-msg-confirm {
            align-self: flex-start; background: #fff; border: none;
            border-radius: 12px; padding: 14px 16px; max-width: 92%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 0 0 1px rgba(0,0,0,0.04);
        }
        .ai-msg-confirm .ai-confirm-text {
            font-size: 14px; color: #1A1A2E; margin-bottom: 12px; line-height: 1.5;
        }
        .ai-confirm-actions { display: flex; gap: 8px; align-items: center; }
        .ai-confirm-actions button {
            padding: 8px 18px; border-radius: 8px; font-size: 13px; font-weight: 600;
            cursor: pointer; border: none; transition: all 0.15s;
        }
        .btn-ai-apply {
            background: var(--sw-navy); color: #fff;
        }
        .btn-ai-apply:hover { background: var(--sw-navy-hover); }
        .btn-ai-dismiss {
            background: transparent; color: #6B7280; padding: 8px 12px;
        }
        .btn-ai-dismiss:hover { color: #1A1A2E; }
        .ai-confirm-applied {
            font-size: 12px; color: var(--sw-navy); font-weight: 500;
        }

        /* Typing indicator */
        .ai-typing {
            padding: 10px 20px; display: none;
        }
        .ai-typing.active { display: flex; gap: 6px; align-items: center; }
        .ai-typing-dot {
            width: 8px; height: 8px; border-radius: 50%; background: var(--sw-navy);
            animation: aiTypingBounce 1.4s ease-in-out infinite;
        }
        .ai-typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .ai-typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes aiTypingBounce {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.25; }
            30% { transform: translateY(-4px); opacity: 0.9; }
        }

        /* Quick actions */
        .ai-quick-actions {
            display: flex; gap: 6px; padding: 10px 20px; flex-wrap: wrap;
            border-top: 1px solid #f5f5f5; flex-shrink: 0;
        }
        .ai-quick-btn {
            padding: 6px 12px; border-radius: 8px; font-size: 12px;
            background: #fff; border: 1px solid #e5e7eb; color: #6B7280;
            cursor: pointer; transition: all 0.15s; white-space: nowrap;
            font-weight: 500;
        }
        .ai-quick-btn:hover { background: #f9fafb; border-color: #d1d5db; color: #374151; }

        /* Input area */
        .ai-input-area {
            display: flex; gap: 8px; padding: 12px 16px 14px;
            border-top: 1px solid #f0f0f0;
            background: #fff; flex-shrink: 0; align-items: flex-end;
        }
        .ai-input-area textarea {
            flex: 1; resize: none; border: 1px solid #e5e7eb; border-radius: 10px;
            padding: 10px 14px; font-size: 14px; font-family: inherit; line-height: 1.4;
            max-height: 120px; min-height: 40px; outline: none;
            transition: border-color 0.15s; background: #fafbfc;
            color: #1A1A2E;
        }
        .ai-input-area textarea:focus { border-color: #d1d5db; background: #fff; }
        .ai-input-area textarea::placeholder { color: #9ca3af; }

        .ai-send-btn {
            width: 36px; height: 36px; border-radius: 10px; border: none;
            background: var(--sw-navy); color: #fff; font-size: 16px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: background 0.15s; flex-shrink: 0;
        }
        .ai-send-btn:hover { background: var(--sw-navy-hover); }
        .ai-send-btn:disabled { background: #e5e7eb; color: #9ca3af; cursor: default; }

        /* Drop zone */
        .ai-drop-zone {
            display: none; position: absolute; inset: 0; background: rgba(11,18,32,0.04);
            border: 2px dashed #d1d5db; border-radius: 10px;
            z-index: 10; align-items: center; justify-content: center;
            font-size: 13px; color: #6B7280; font-weight: 500;
        }
        .ai-drop-zone.active { display: flex; }

        /* Image preview */
        .ai-img-preview {
            display: flex; gap: 6px; padding: 6px 20px; flex-wrap: wrap; flex-shrink: 0;
        }
        .ai-img-preview:empty { display: none; }
        .ai-img-thumb {
            position: relative; width: 52px; height: 52px; border-radius: 8px;
            overflow: hidden; border: 1px solid #e5e7eb;
        }
        .ai-img-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .ai-img-thumb .ai-img-remove {
            position: absolute; top: 2px; right: 2px; width: 18px; height: 18px;
            border-radius: 50%; background: rgba(0,0,0,0.5); color: #fff;
            border: none; font-size: 11px; cursor: pointer; display: flex;
            align-items: center; justify-content: center; line-height: 1;
            transition: background 0.15s;
        }
        .ai-img-thumb .ai-img-remove:hover { background: rgba(0,0,0,0.7); }

        @media (max-width: 600px) {
            .ai-drawer { width: 100%; right: -100%; }
        }
        @media (prefers-reduced-motion: reduce) {
            .ai-drawer, .ai-drawer:hover, .ai-drawer:focus-within {
                transition: none; backdrop-filter: none; -webkit-backdrop-filter: none;
                background: #fff;
            }
        }

        /* Loading & Error Overlay */
        .app-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: #fff; z-index: 10000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.3s ease-out;
        }
        .app-overlay.hidden {
            opacity: 0; pointer-events: none;
        }
        .overlay-content {
            text-align: center; max-width: 400px; padding: 40px;
        }
        .overlay-spinner {
            width: 48px; height: 48px; border: 4px solid #e0e0e0;
            border-top-color: var(--sw-navy);
            border-radius: 50%; margin: 0 auto 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .overlay-title {
            font-size: 20px; font-weight: 700; color: var(--sw-text);
            margin-bottom: 8px;
        }
        .overlay-message {
            font-size: 14px; color: #666; margin-bottom: 24px;
            white-space: pre-line;
        }
        .overlay-error-icon {
            font-size: 48px; margin-bottom: 16px;
        }
        .btn-overlay {
            padding: 12px 24px; background: var(--sw-navy); color: #fff;
            border: none; border-radius: 4px; font-size: 14px; font-weight: 600;
            cursor: pointer; font-family: inherit;
        }
        .btn-overlay:hover { opacity: 0.9; }

        /* ═══════════════════════════════════════════════════════════════
           PROJECT INFO BLOC
           ═══════════════════════════════════════════════════════════════ */
        .ph-info-bloc {
            display: flex; align-items: center; gap: 8px; margin: 2px 0 0; padding: 0;
        }
        .ph-info-text { font-size: 13px; color: #666; line-height: 1.4; }
        .ph-info-text span { color: #999; }
        .ph-info-empty { font-size: 13px; color: #bbb; font-style: italic; }
        .btn-edit-info {
            background: none; border: none; cursor: pointer; color: #bbb;
            font-size: 14px; padding: 2px 6px; transition: color 0.15s; flex-shrink: 0;
        }
        .btn-edit-info:hover { color: var(--sw-navy); }
        .info-modal-row { display: grid; grid-template-columns: 2fr 1fr; gap: 12px; }
        @media (max-width: 500px) { .info-modal-row { grid-template-columns: 1fr; } }

        /* ═══════════════════════════════════════════════════════════════
           CONTACT BADGES STRIP (in project header)
           ═══════════════════════════════════════════════════════════════ */
        .ph-contacts-strip { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 6px; }
        .ph-contact-badge {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 3px 10px; border-radius: 12px;
            background: #f5f5f5; border: 1px solid #e0e0e0;
            font-size: 12px; font-weight: 500; color: #666;
            cursor: pointer; transition: all 0.15s; white-space: nowrap;
        }
        .ph-contact-badge:hover { background: #fff; box-shadow: 0 1px 4px rgba(0,0,0,0.06); color: #333; }
        .ph-contact-badge-role { color: #999; font-weight: 400; font-size: 11px; }
        .ph-contacts-more {
            display: inline-flex; align-items: center; padding: 3px 8px;
            border-radius: 12px; font-size: 12px; font-weight: 500;
            color: var(--sw-navy); cursor: pointer; transition: all 0.15s;
        }
        .ph-contacts-more:hover { background: #f5f5f5; }

        /* ═══════════════════════════════════════════════════════════════
           CONTACTS MODAL
           ═══════════════════════════════════════════════════════════════ */
        .contacts-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4); z-index: 9000;
            justify-content: center; align-items: flex-start; padding: 40px 20px;
        }
        .contacts-overlay.active { display: flex; }
        .contacts-modal {
            background: #fff; border-radius: 16px; max-width: 900px; width: 100%;
            max-height: 90vh; overflow-y: auto;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08), 0 1px 4px rgba(0,0,0,0.04);
        }
        .contacts-modal-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 24px 32px; border-bottom: 1px solid #f0f0f0;
        }
        .contacts-modal-header h2 { font-size: 20px; font-weight: 700; color: var(--sw-text); margin: 0; }
        .contacts-modal-close {
            background: none; border: none; font-size: 24px; cursor: pointer;
            color: #999; padding: 4px 8px; transition: color 0.15s;
        }
        .contacts-modal-close:hover { color: var(--sw-text); }
        .contacts-modal-body { padding: 28px 32px; }
        .contact-cards-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 16px;
        }
        .contact-card {
            background: #fff; border: 1px solid #e8e8e8; border-radius: 16px;
            padding: 20px; transition: box-shadow 0.15s; position: relative;
        }
        .contact-card:hover { box-shadow: 0 2px 12px rgba(0,0,0,0.06); }
        .contact-card-role {
            font-size: 11px; font-weight: 700; text-transform: uppercase;
            letter-spacing: 0.5px; color: var(--sw-navy); margin-bottom: 8px;
            display: flex; align-items: center; gap: 6px;
        }
        .contact-primary-star {
            cursor: pointer; font-size: 15px; line-height: 1; color: #ccc; transition: color 0.15s;
        }
        .contact-primary-star:hover { color: #f5a623; }
        .contact-primary-star.active { color: #f5a623; }
        .contact-card-name { font-size: 16px; font-weight: 700; color: var(--sw-text); margin-bottom: 2px; }
        .contact-card-name-link {
            color: var(--sw-text); text-decoration: none; transition: color 0.15s; cursor: pointer;
        }
        .contact-card-name-link:hover { color: var(--sw-navy); text-decoration: underline; }
        .contact-card-company { font-size: 13px; color: #888; margin-bottom: 12px; }
        .contact-card-company-link {
            color: #888; text-decoration: none; transition: color 0.15s;
        }
        .contact-card-company-link:hover { color: var(--sw-navy); text-decoration: underline; }
        .contact-card-details { font-size: 13px; color: #555; line-height: 1.6; }
        .contact-card-actions { display: flex; gap: 8px; margin-top: 14px; flex-wrap: wrap; }
        .contact-card-btn {
            background: #f8f8f8; border: 1px solid #e8e8e8; border-radius: 8px;
            padding: 6px 12px; font-size: 12px; font-weight: 600; cursor: pointer;
            font-family: inherit; color: #555; transition: all 0.15s;
        }
        .contact-card-btn:hover { background: #f0f0f0; border-color: #ccc; color: var(--sw-text); }
        .contact-card-remove {
            position: absolute; top: 8px; right: 8px; background: none;
            border: none; cursor: pointer; color: #ccc; font-size: 16px;
            padding: 4px; transition: color 0.15s;
        }
        .contact-card-remove:hover { color: #c62828; }
        .contact-card-placeholder {
            background: #fafafa; border: 2px dashed #e0e0e0; border-radius: 16px;
            padding: 20px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.15s; min-height: 120px;
        }
        .contact-card-placeholder:hover { border-color: var(--sw-navy); background: #f3f5f8; }
        .contact-card-placeholder span { font-size: 14px; color: #999; font-weight: 500; }
        .btn-add-contact {
            background: var(--sw-navy); color: #fff; border: none;
            border-radius: 12px; padding: 10px 20px; font-size: 14px;
            font-weight: 600; cursor: pointer; font-family: inherit;
            margin-top: 20px; transition: opacity 0.15s;
        }
        .btn-add-contact:hover { opacity: 0.9; }
        @media (max-width: 600px) {
            .contact-cards-grid { grid-template-columns: 1fr; }
            .contacts-modal-body { padding: 16px; }
            .contacts-modal-header { padding: 16px; }
        }

        /* ═══════════════════════════════════════════════════════════════
           ADD CONTACT SUB-MODAL + COMBOBOX
           ═══════════════════════════════════════════════════════════════ */
        .add-contact-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 9500;
            justify-content: center; align-items: center;
        }
        .add-contact-overlay.active { display: flex; }
        .add-contact-overlay .modal { overflow: visible; }
        .add-contact-overlay .modal-body { overflow: visible; }
        .contact-combo-wrap { position: relative; width: 100%; }
        .contact-combo-wrap input {
            width: 100%; padding: 10px 12px; font-size: 14px;
            font-family: inherit; border: 1px solid var(--sw-border);
            border-radius: 4px; box-sizing: border-box;
        }
        .contact-combo-dd {
            display: none; position: absolute; top: 100%; left: 0; right: 0;
            background: #fff; border: 1px solid #ddd; border-radius: 0 0 6px 6px;
            max-height: 220px; overflow-y: auto; z-index: 10;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .contact-combo-dd.open { display: block; }
        .contact-combo-item {
            padding: 8px 12px; cursor: pointer; font-size: 13px; transition: background 0.1s;
        }
        .contact-combo-item:hover { background: #f0f0f0; }
        .contact-combo-item small { color: #999; }
        .combo-section-header {
            padding: 6px 12px; font-size: 11px; font-weight: 700; text-transform: uppercase;
            letter-spacing: 0.5px; color: #999; background: #fafafa; border-top: 1px solid #eee;
        }
    </style>
</head>
<body>
    <!-- Loading/Error Overlay -->
    <div class="app-overlay" id="appOverlay">
        <div class="overlay-content">
            <div class="overlay-spinner" id="overlaySpinner"></div>
            <div class="overlay-error-icon" id="overlayErrorIcon" style="display:none;">⚠️</div>
            <div class="overlay-title" id="overlayTitle">Chargement de l'application</div>
            <div class="overlay-message" id="overlayMessage">Veuillez patienter...</div>
            <button class="btn-overlay" id="overlayRetryBtn" style="display:none;" onclick="location.reload()">
                Rafraîchir la page
            </button>
        </div>
    </div>

    <!-- Nav bar -->
    <nav class="nav-bar">
        <span class="nav-logo">scopewright</span>
        <a href="app.html" class="nav-back">&larr; Menu</a>
        <div class="data-status" id="dataStatus">
            <span class="status-dot"></span>
            <span class="status-text" id="statusText">Chargement...</span>
        </div>
    </nav>

    <!-- Contenu principal -->
    <div class="main-content">

        <!-- ═══════ VUE 1 : LISTE DES PROJETS ═══════ -->
        <div class="project-list-view active" id="projectListView">
            <div class="project-list-header">
                <h1 class="project-list-title">Mes projets</h1>
                <button class="btn-new-project" onclick="showNewProjectForm()">+ Nouveau projet</button>
            </div>

            <div class="new-project-form" id="newProjectForm">
                <div class="new-project-form-actions">
                    <span style="font-size:13px;color:#666;">Le code projet sera g&eacute;n&eacute;r&eacute; automatiquement.</span>
                    <button class="btn-create-project" id="btnCreateProject" onclick="handleCreateProject()">Cr&eacute;er un projet</button>
                    <button class="btn-cancel-project" onclick="hideNewProjectForm()">Annuler</button>
                </div>
            </div>

            <!-- Pipeline tabs -->
            <div class="pipeline-tabs" id="pipelineTabs">
                <button class="pipeline-tab" data-view="table" onclick="switchPipelineView('table')">Table</button>
                <button class="pipeline-tab active" data-view="cards" onclick="switchPipelineView('cards')">Cartes</button>
                <button class="pipeline-tab" data-view="submissions" onclick="switchPipelineView('submissions')">Soumissions</button>
            </div>

            <!-- Pipeline filters -->
            <div class="pipeline-filters" id="pipelineFilters">
                <button class="pipeline-filter-btn" id="filterFollowsBtn" onclick="toggleFollowsFilter()" title="Afficher seulement les projets suivis">&starf; Suivis</button>
                <button class="pipeline-filter-btn" id="filterArchiveBtn" onclick="toggleArchiveFilter()" title="Afficher les soumissions archiv&eacute;es">Archiv&eacute;es</button>
                <input type="text" id="pipelineSearch" placeholder="Rechercher (nom, client, code, ville...)" oninput="applyPipelineFilters()">
                <select id="pipelineStatusFilter" onchange="applyPipelineFilters()">
                    <option value="">Tous les statuts</option>
                </select>
                <select id="pipelineAssignedFilter" onchange="applyPipelineFilters()">
                    <option value="">Tous les responsables</option>
                </select>
                <select id="pipelineTypeFilter" onchange="applyPipelineFilters()">
                    <option value="">Tous les types</option>
                </select>
            </div>

            <!-- Vue Table -->
            <div id="viewTableContainer" style="display:none;">
                <div class="pipeline-table-wrap">
                    <table class="pipeline-table" id="pipelineTable">
                        <thead id="pipelineTableHead"></thead>
                        <tbody id="pipelineTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Vue Cartes -->
            <div id="projectGrid" class="project-grid">
                <!-- Rempli dynamiquement -->
            </div>

            <!-- Vue Soumissions -->
            <div id="viewSubmissions" style="display:none;">
                <div class="pipeline-table-wrap">
                    <table class="pipeline-table" id="submissionsTable">
                        <thead id="submissionsTableHead"></thead>
                        <tbody id="submissionsTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="project-empty" id="projectEmpty" style="display:none;">
                Aucun projet pour le moment.<br>Cliquez sur &laquo; + Nouveau projet &raquo; pour commencer.
            </div>
        </div>

        <!-- Project detail drawer -->
        <div class="project-drawer-overlay" id="projectDrawerOverlay" onclick="closeProjectDrawer()"></div>
        <div class="project-drawer" id="projectDrawer">
            <div class="project-drawer-head">
                <h3 id="drawerProjectName"></h3>
                <button class="project-drawer-close" onclick="closeProjectDrawer()">&times;</button>
            </div>
            <div class="project-drawer-body" id="drawerBody"></div>
        </div>

        <!-- ═══════ VUE 2 : CALCULATEUR ═══════ -->
        <div class="calculator-view" id="calculatorView">

            <div class="project-header" id="projectHeader">
                <div class="ph-top-bar">
                    <button class="btn-back-projects" id="btnBackProjects" onclick="backToProjectList()">&larr; Projets</button>
                    <div class="ph-top-actions">
                        <button class="btn-header-link" id="btnPreview" onclick="openPreview()">Aper&ccedil;u</button>
                        <button class="btn-header-link" onclick="openRentab('project')">Rentabilit&eacute;</button>
                        <button class="btn-header-link" id="btnPlans" onclick="openPlansModal()">Plans</button>
                        <button class="ai-assistant-btn" id="btnAiAssistant" title="Assistant Scopewright" onclick="openAiDrawer()"></button>
                        <button class="btn-header-link" id="btnContacts" onclick="openContactsModal()">Contacts</button>
                        <div class="kebab-menu" id="headerKebab">
                            <button class="btn-kebab" onclick="toggleHeaderKebab(event)">&middot;&middot;&middot;</button>
                            <div class="kebab-dropdown" id="headerKebabDropdown">
                                <button id="kebabDuplicate" onclick="duplicateSubmission(); closeHeaderKebab()"><span class="kebab-icon">&#9633;</span> Dupliquer</button>
                                <button id="kebabVersions" onclick="openVersionDrawer(); closeHeaderKebab()"><span class="kebab-icon">&#9776;</span> Versions</button>
                                <button id="kebabTimeline" onclick="openTimelineDrawer(); closeHeaderKebab()"><span class="kebab-icon">&#9201;</span> Historique</button>
                                <button id="kebabUnlock" onclick="unlockSubmission(); closeHeaderKebab()" style="display:none;"><span class="kebab-icon">&#128275;</span> D&eacute;verrouiller</button>
                                <button id="kebabArchive" onclick="toggleArchiveSubmission(); closeHeaderKebab()" style="display:none;"><span class="kebab-icon">&#128451;</span> Archiver</button>
                            </div>
                        </div>
                    </div>
                </div>
                <input type="text" class="ph-project-name" id="projName" placeholder="Nom du projet" readonly>
                <span class="ph-sub-number" id="headerSubNumber"></span>
                <span class="save-indicator" id="saveIndicator"></span>
                <div class="ph-info-bloc" id="projInfoBloc">
                    <div id="projInfoText" class="ph-info-empty">Ajouter les infos du projet</div>
                    <button class="btn-edit-info" onclick="openEditInfoModal()" title="Modifier les informations du projet">&#9998;</button>
                </div>
                <div class="ph-contacts-strip" id="projContactsStrip" style="display:none;"></div>
                <div class="ph-status-row">
                    <span class="status-badge" id="subStatusBadge"></span>
                </div>
                <div class="ph-total-section">
                    <div class="ph-total-label">Total estim&eacute;</div>
                    <div class="ph-total-amount" id="headerTotal">0,00 $</div>
                </div>
                <div class="status-timeline" id="statusTimeline"></div>
                <div class="ph-actions" id="mainActions">
                    <button class="btn-main-action" id="btnWfSubmit" onclick="openSubmitModal()">Soumettre</button>
                    <button class="btn-main-action btn-main-green" id="btnWfApprove" onclick="approveSubmission()">Approuver</button>
                    <button class="btn-main-action btn-main-orange" id="btnWfReturn" onclick="returnSubmission()">Retourner</button>
                    <button class="btn-main-action btn-main-purple" id="btnWfSendClient" onclick="sendToClient()">Envoyer au client</button>
                    <button class="btn-main-action btn-main-red" id="btnWfBypass" onclick="bypassApproval()">Envoyer sans approbation</button>
                    <button class="btn-main-action btn-main-green" id="btnWfAcceptOffline" onclick="offlineAcceptance()">Confirmer la vente</button>
                </div>
                <!-- Submission assignment -->
                <div class="sub-assignment-row" id="subAssignmentRow" style="display:none;">
                    <div class="sa-field">
                        <span class="sa-label">Estimateur</span>
                        <div style="display:flex;align-items:center;">
                            <select id="saEstimateur" onchange="saveSubAssignment()" style="flex:1;"><option value="">—</option></select>
                            <button id="saEstimateurAccept" class="sa-accept-btn" onclick="acceptEstimateurAssignment()" style="display:none;">Accepter</button>
                        </div>
                    </div>
                    <div class="sa-field">
                        <span class="sa-label">Vendeur / CP</span>
                        <select id="saVendeur" onchange="saveSubAssignment()"><option value="">—</option></select>
                    </div>
                    <div class="sa-field">
                        <span class="sa-label">Approbateur</span>
                        <select id="saApprobateur" onchange="saveSubAssignment()"><option value="">—</option></select>
                    </div>
                    <div class="sa-field">
                        <span class="sa-label">Remise interne</span>
                        <input type="date" id="saInternalDeadline" onchange="saveSubAssignment()">
                    </div>
                    <div class="sa-field">
                        <span class="sa-label">Remise client</span>
                        <input type="date" id="saClientDeadline" onchange="saveSubAssignment()">
                    </div>
                </div>
                <input type="hidden" id="subTitle" value="">
                <span id="subNumber" style="display:none;"></span>
                <label style="display:none;"><input type="checkbox" id="projInstallation" checked onchange="toggleProjectInstallation()"></label>
            </div>

            <div class="header-sub-panel" id="headerSubPanel">
                <div class="header-sub-label" onclick="toggleSubPanel()"><span class="sub-chevron open" id="subPanelChevron">&#9654;</span> Soumissions du projet</div>
                <div class="header-sub-body" id="headerSubBody">
                    <div id="headerSubList"></div>
                    <button class="btn-add-sub" id="btnAddSubHeader" onclick="handleAddSubmissionFromCalc()">+ Nouvelle soumission</button>
                </div>
            </div>

            <div class="default-materials-panel" id="defaultMaterialsPanel">
                <div class="dm-label" onclick="toggleDefaultMaterials()"><span class="dm-arrow" id="dmArrow">&#9654;</span> Mat&eacute;riaux par d&eacute;faut &mdash; Soumission (mod&egrave;le)</div>
                <div class="dm-sub-hint">Appliqu&eacute; aux pi&egrave;ces sans mat&eacute;riaux sp&eacute;cifiques</div>
                <div class="default-materials-body collapsed" id="dmBody"></div>
            </div>

            <h1 class="page-title">Calculateur</h1>
            <p class="page-subtitle">Calculez des estimations budg&eacute;taires &agrave; partir du catalogue de prix.</p>

            <div class="calculator-container">
            <div class="tag-filter-bar" id="tagFilterBar" style="display:none;">
                <span class="tag-filter-label">Filtrer par tag :</span>
                <span class="tag-filter-chip chip-all active" onclick="filterByTag(null)">Tous</span>
            </div>
            <div id="furnitureGroups">
                <!-- Le premier meuble est cr&eacute;&eacute; par JS au chargement -->
            </div>

            <button class="btn-add-group" onclick="addFurnitureGroup()">+ Ajouter un meuble</button>

            <div id="globalModifierRow" class="global-modifier-row" style="display:none;">
                <span class="global-modifier-label">Modificateur global</span>
                <span class="global-modifier-badge" id="globalModifierDisplay"></span>
                <button class="discount-toggle-btn" onclick="editGlobalModifier()" title="Modifier">&#9998;</button>
                <button class="discount-toggle-btn" onclick="removeGlobalModifier()" title="Retirer">&times;</button>
            </div>
            <div id="discountRow" class="discount-row" style="display:none;">
                <span class="discount-label">Rabais</span>
                <span class="discount-amount" id="discountDisplay"></span>
                <button class="discount-toggle-btn" onclick="editDiscount()" title="Modifier le rabais">&#9998;</button>
                <button class="discount-toggle-btn" onclick="removeDiscount()" title="Retirer le rabais">&times;</button>
            </div>
            <div class="grand-total-container">
                <button class="discount-toggle-btn" id="addGlobalModifierBtn" onclick="editGlobalModifier()" title="Modificateur %" style="margin-right:auto;">% Modificateur</button>
                <button class="discount-toggle-btn" id="addDiscountBtn" onclick="editDiscount()" title="Ajouter un rabais">+ Rabais</button>
                <span class="grand-total-label">Total estim&eacute;</span>
                <span class="grand-total-amount" id="grandTotal">0,00 $</span>
            </div>


            <button class="btn-pdf" id="btnOpenSubmit" onclick="openSubmitModal()">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Soumettre pour approbation
            </button>
        </div>

        </div><!-- fin calculator-view -->

        <!-- ═══════ PREVIEW VIEW (split layout) ═══════ -->
        <div class="preview-view" id="previewView">
            <div class="pv-toolbar">
                <button onclick="closePreview()">&larr; Retour au calculateur</button>
                <span class="pv-toolbar-title">Aper&ccedil;u soumission</span>
                <span class="pv-toolbar-sub" id="pvSubNumber"></span>
                <button class="btn-client-view" id="btnPresentation" onclick="openPresentation()" title="Plein &eacute;cran">Pr&eacute;sentation</button>
                <button class="btn-client-view" id="btnLang" onclick="toggleLang()" title="Changer la langue">EN</button>
            </div>
            <div class="pv-split">
                <div class="pv-left">
                    <div class="pv-content" id="pvContent"></div>
                </div>
                <div class="pv-right" id="pvRight">
                    <div class="pv-tools-header">Outils</div>
                    <div class="pv-tools-section">
                        <h5>Biblioth&egrave;que de clauses</h5>
                        <div class="pv-lib-actions">
                            <button class="pv-btn-add-clause" onclick="showClauseEditor()">+ Nouvelle clause</button>
                        </div>
                        <div id="pvClauseEditZone"></div>
                        <div class="pv-clause-list" id="pvClauseList"></div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Modal Rentabilité -->
    <div class="rentab-overlay" id="rentabModal" onclick="if(event.target===this)closeRentab()">
        <div class="rentab-modal">
            <div class="rentab-header">
                <h2 id="rentabTitle">Rentabilit&eacute;</h2>
                <button class="rentab-close" onclick="closeRentab()">&times;</button>
            </div>
            <div class="rentab-body" id="rentabBody"></div>
            <div class="rentab-footer">
                <button onclick="closeRentab()">Annuler</button>
            </div>
        </div>
    </div>

    <!-- Modal g\u00e9n\u00e9rique (confirm / prompt / alert) -->
    <div class="modal-overlay" id="steleDialogOverlay">
        <div class="modal" style="max-width:440px;">
            <div class="modal-header">
                <h3 class="modal-title" id="steleDialogTitle"></h3>
            </div>
            <div class="modal-body">
                <p id="steleDialogMessage" style="font-size:14px; color:#444; margin-bottom:12px;"></p>
                <div id="steleDialogInputWrap" style="display:none;">
                    <input type="text" class="form-input" id="steleDialogInput" style="font-size:14px;">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" id="steleDialogCancel" onclick="steleDialogResolve(null)" style="display:none;">Annuler</button>
                <button class="btn-generate" id="steleDialogOk" onclick="steleDialogOk()">OK</button>
            </div>
        </div>
    </div>

    <!-- Timeline drawer (historique soumission) -->
    <div class="timeline-drawer-overlay" id="timelineOverlay" onclick="closeTimelineDrawer()"></div>
    <div class="timeline-drawer" id="timelineDrawer">
        <div class="timeline-drawer-header">
            <h3>Historique</h3>
            <button class="timeline-drawer-close" onclick="closeTimelineDrawer()">&times;</button>
        </div>
        <div class="timeline-drawer-body" id="timelineBody">
            <div class="timeline-empty">Aucun historique</div>
        </div>
    </div>

    <!-- AI Assistant Drawer -->
    <div class="ai-drawer-overlay" id="aiOverlay" onclick="closeAiDrawer()"></div>
    <div class="ai-drawer" id="aiDrawer">
        <div class="ai-drawer-header">
            <h3>Assistant Scopewright</h3>
            <div class="ai-scope-badge" id="aiScopeBadge">Projet</div>
            <button class="ai-drawer-close" onclick="closeAiDrawer()">&times;</button>
        </div>
        <div class="ai-messages" id="aiMessages"></div>
        <div class="ai-typing" id="aiTyping">
            <div class="ai-typing-dot"></div>
            <div class="ai-typing-dot"></div>
            <div class="ai-typing-dot"></div>
        </div>
        <div class="ai-quick-actions" id="aiQuickActions">
            <button class="ai-quick-btn" onclick="aiQuickAction('Analyse la rentabilit\u00e9 du projet')">Rentabilit&eacute;</button>
            <button class="ai-quick-btn" onclick="aiQuickAction('R\u00e9sume cette soumission')">R&eacute;sum&eacute;</button>
            <button class="ai-quick-btn" onclick="aiQuickAction('Optimise toutes les descriptions')">Descriptions</button>
            <button class="ai-quick-btn" onclick="aiQuickAction('Sugg\u00e8re des articles pour am\u00e9liorer la marge')">Am&eacute;liorer marge</button>
        </div>
        <div class="ai-img-preview" id="aiImgPreview"></div>
        <div class="ai-input-area" style="position:relative;">
            <div class="ai-drop-zone" id="aiDropZone">D&eacute;posez une image ici</div>
            <textarea id="aiInput" placeholder="Posez une question..." rows="1" onkeydown="aiInputKeydown(event)"></textarea>
            <button class="ai-send-btn" id="aiSendBtn" onclick="sendAiMessage()" title="Envoyer">&uarr;</button>
        </div>
    </div>

    <!-- Modal Soumettre la soumission -->
    <div class="modal-overlay" id="pdfModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="submitModalTitle">Soumettre la soumission</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="projectDate">Date requise</label>
                    <input type="date" class="form-input" id="projectDate">
                </div>
                <div class="form-group">
                    <label class="form-label" for="projectDescription">Message / Notes</label>
                    <textarea class="form-input" id="projectDescription" rows="3" placeholder="Ex: J'en ai besoin pour demain, pr&eacute;voir 2 semaines de d&eacute;lai..." style="resize: vertical; min-height: 60px;"></textarea>
                </div>
                <div id="sendStatus" style="display: none; padding: 10px; border-radius: 4px; font-size: 13px; margin-top: 8px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closePdfModal()">Annuler</button>
                <button class="btn-generate" id="btnSend" onclick="soumettreSoumission()">Soumettre</button>
            </div>
        </div>
    </div>

    <!-- Modal Bypass approbation -->
    <div class="modal-overlay" id="bypassModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" style="color:#c0392b;">Envoi sans approbation</h3>
            </div>
            <div class="modal-body">
                <div style="background:#fff3e0; border:1px solid #e65100; border-radius:6px; padding:14px; margin-bottom:16px; font-size:13px; color:#e65100; line-height:1.5;">
                    <strong>Attention :</strong> Vous vous appr&ecirc;tez &agrave; envoyer cette soumission directement au client <strong>sans approbation interne</strong>. Cette action sera consign&eacute;e avec votre identit&eacute; et votre adresse IP.
                </div>
                <div class="form-group">
                    <label class="form-label" style="display:flex; align-items:flex-start; gap:8px; cursor:pointer;">
                        <input type="checkbox" id="bypassConfirmCheck" style="margin-top:3px;">
                        <span>Je confirme envoyer cette soumission sans approbation interne et j'en assume l'enti&egrave;re responsabilit&eacute;.</span>
                    </label>
                </div>
                <div class="form-group">
                    <label class="form-label" for="bypassReason">Raison du bypass <span style="color:#c0392b;">*</span></label>
                    <textarea class="form-input" id="bypassReason" rows="3" placeholder="Ex: Client en urgence, d&eacute;j&agrave; discut&eacute; avec le directeur..." style="resize:vertical; min-height:60px;" required></textarea>
                </div>
                <div id="bypassStatus" style="display:none; padding:10px; border-radius:4px; font-size:13px; margin-top:8px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeBypassModal()">Annuler</button>
                <button class="btn-generate" id="btnBypassConfirm" style="background:#c0392b;" onclick="executeBypass()">Envoyer sans approbation</button>
            </div>
        </div>
    </div>

    <!-- Modal Acceptation hors-ligne -->
    <div class="modal-overlay" id="offlineAcceptModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" style="color:#2e7d32;">Confirmer la vente (hors-ligne)</h3>
            </div>
            <div class="modal-body">
                <div style="background:#e8f5e9; border:1px solid #2e7d32; border-radius:6px; padding:14px; margin-bottom:16px; font-size:13px; color:#2e7d32; line-height:1.5;">
                    Vous confirmez que le client a accept&eacute; cette soumission <strong>par un autre moyen</strong> que la signature en ligne. Cette action sera consign&eacute;e avec votre identit&eacute; et votre adresse IP.
                </div>
                <div class="form-group">
                    <label class="form-label" for="offlineUserName">Votre nom (charg&eacute; de projet) <span style="color:#c0392b;">*</span></label>
                    <input type="text" class="form-input" id="offlineUserName" placeholder="Pr&eacute;nom Nom">
                </div>
                <div class="form-group">
                    <label class="form-label" for="offlineClientName">Nom du client</label>
                    <input type="text" class="form-input" id="offlineClientName" placeholder="Nom du client">
                </div>
                <div class="form-group">
                    <label class="form-label" for="offlineMethod">M&eacute;thode d'acceptation <span style="color:#c0392b;">*</span></label>
                    <select class="form-input" id="offlineMethod" style="font-size:14px;">
                        <option value="">-- S&eacute;lectionner --</option>
                        <option value="courriel">Courriel</option>
                        <option value="telephone">T&eacute;l&eacute;phone</option>
                        <option value="papier">Papier</option>
                        <option value="autre">Autre</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="offlineDate">Date d'acceptation client <span style="color:#c0392b;">*</span></label>
                    <input type="date" class="form-input" id="offlineDate">
                </div>
                <div class="form-group">
                    <label class="form-label" for="offlineNotes">Notes (optionnel)</label>
                    <textarea class="form-input" id="offlineNotes" rows="2" placeholder="Ex: Le client a confirm&eacute; par courriel le..." style="resize:vertical; min-height:40px;"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label" style="display:flex; align-items:flex-start; gap:8px; cursor:pointer;">
                        <input type="checkbox" id="offlineConfirmCheck" style="margin-top:3px;">
                        <span>Je confirme que le client a accept&eacute; cette soumission par un autre moyen. J'en assume l'enti&egrave;re responsabilit&eacute;.</span>
                    </label>
                </div>
                <div id="offlineAcceptStatus" style="display:none; padding:10px; border-radius:4px; font-size:13px; margin-top:8px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeOfflineAcceptModal()">Annuler</button>
                <button class="btn-generate" id="btnOfflineConfirm" style="background:#2e7d32;" onclick="executeOfflineAcceptance()">Confirmer la vente</button>
            </div>
        </div>
    </div>

    <!-- Modal Marquer comme perdu -->
    <div class="modal-overlay" id="lostModal">
        <div class="modal" style="max-width:480px;">
            <div class="modal-header">
                <h3 class="modal-title" style="color:#c62828;">Marquer comme perdu</h3>
            </div>
            <div class="modal-body">
                <div style="background:#ffebee; border:1px solid #c62828; border-radius:6px; padding:14px; margin-bottom:16px; font-size:13px; color:#c62828; line-height:1.5;">
                    Cette soumission sera marqu&eacute;e comme <strong>perdue</strong>. Vous pourrez la rouvrir ult&eacute;rieurement si n&eacute;cessaire.
                </div>
                <div class="form-group">
                    <label class="form-label" for="lostReason">Raison de la perte (optionnel)</label>
                    <textarea class="form-input" id="lostReason" rows="2" placeholder="Ex: Prix trop &eacute;lev&eacute;, d&eacute;lai trop long, client a choisi un concurrent..." style="resize:vertical; min-height:40px;"></textarea>
                </div>
                <div class="form-group" style="position:relative;">
                    <label class="form-label" for="lostCompetitorSearch">Concurrent (optionnel)</label>
                    <input type="text" class="form-input" id="lostCompetitorSearch" placeholder="Rechercher une entreprise..." oninput="filterLostCompetitors(this)" onfocus="filterLostCompetitors(this)" autocomplete="off">
                    <input type="hidden" id="lostCompetitorId">
                    <div class="contact-combo-dd" id="lostCompetitorDd" style="position:absolute; top:100%; left:0; right:0; z-index:20; max-height:200px; overflow-y:auto;"></div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="lostCompetitorPrice">Prix concurrent (optionnel)</label>
                    <input type="number" class="form-input" id="lostCompetitorPrice" placeholder="0.00" min="0" step="0.01">
                </div>
                <div id="lostStatus" style="display:none; padding:10px; border-radius:4px; font-size:13px; margin-top:8px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeLostModal()">Annuler</button>
                <button class="btn-generate" id="btnLostConfirm" style="background:#c62828;" onclick="executeLostSubmission()">Marquer comme perdu</button>
            </div>
        </div>
    </div>

    <!-- Version Drawer -->
    <div id="versionDrawer" class="version-drawer" style="display:none;">
        <div class="version-drawer-header">
            <h3>Historique des versions</h3>
            <button onclick="closeVersionDrawer()" class="btn-close-drawer">&times;</button>
        </div>
        <div id="versionList" class="version-list"></div>
    </div>

    <!-- Modal Déverrouillage d'urgence -->
    <div class="modal-overlay" id="unlockModal">
        <div class="modal" style="max-width:460px;">
            <div class="modal-header">
                <h3 class="modal-title" style="color:#c62828;">D&eacute;verrouillage d'urgence</h3>
            </div>
            <div class="modal-body">
                <div style="background:#ffebee; border:1px solid #c62828; border-radius:6px; padding:14px; margin-bottom:16px; font-size:13px; color:#c62828; line-height:1.5;">
                    Cette action sera enregistr&eacute;e de fa&ccedil;on <strong>permanente et irr&eacute;versible</strong> dans le journal d'audit. Le contenu actuel sera sauvegard&eacute; en version avant le d&eacute;verrouillage.
                </div>
                <div class="form-group">
                    <label class="form-label" for="unlockUserName">Votre nom complet <span style="color:#c62828;">*</span></label>
                    <input type="text" class="form-input" id="unlockUserName" placeholder="Pr&eacute;nom Nom">
                </div>
                <div class="form-group">
                    <label class="form-label" for="unlockReason">Raison du d&eacute;verrouillage <span style="color:#c62828;">*</span></label>
                    <textarea class="form-input" id="unlockReason" rows="3" placeholder="Expliquer pourquoi cette soumission doit &ecirc;tre d&eacute;verrouill&eacute;e..." style="resize:vertical;"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label" style="display:flex; align-items:flex-start; gap:8px; cursor:pointer;">
                        <input type="checkbox" id="unlockConfirmCheck" style="margin-top:3px;">
                        <span>Je comprends que cette action est permanente et tra&ccedil;able. L'adresse IP sera consign&eacute;e.</span>
                    </label>
                </div>
                <div id="unlockStatus" style="display:none; padding:10px; border-radius:4px; font-size:13px; margin-top:8px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeUnlockModal()">Annuler</button>
                <button class="btn-generate" id="btnUnlockConfirm" style="background:#c62828;" onclick="executeUnlock()">D&eacute;verrouiller</button>
            </div>
        </div>
    </div>

    <!-- Lightbox pour agrandir les images -->
    <div class="lightbox-overlay" id="lightbox" onclick="closeLightbox()">
        <img id="lightboxImg" src="" alt="">
    </div>

    <!-- Modal Annotation -->
    <div class="annotation-overlay" id="annotationModal" onclick="if(event.target===this)closeAnnotationModal()">
        <div class="annotation-box">
            <div class="annotation-header">
                <span class="annotation-title">Annoter l'image</span>
                <select id="annotPrefixSelect" onchange="updateAnnotNext()"></select>
                <span class="annotation-next" id="annotNext"></span>
                <label class="annotation-arrow-toggle">
                    <input type="checkbox" id="annotArrowMode"> Fl&egrave;che
                </label>
                <button class="annotation-close" onclick="closeAnnotationModal()">&times;</button>
            </div>
            <div class="annotation-img-container" id="annotImgContainer">
                <img id="annotImage" src="" onclick="handleAnnotationClick(event)">
                <svg id="annotSvg" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <marker id="annotArrowHead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="var(--sw-navy)"/>
                        </marker>
                    </defs>
                </svg>
            </div>
            <div class="annotation-footer">
                <span class="annotation-hint">Cliquer sur l'image pour placer un tag. Glisser pour d&eacute;placer. Clic droit pour supprimer.</span>
            </div>
        </div>
    </div>

    <!-- Modal Plans architecturaux -->
    <div class="modal-overlay" id="plansModal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title">Plans architecturaux</h3>
                <button class="modal-close" onclick="closePlansModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="plans-upload-zone">
                    <input type="file" id="planFileInput" accept=".pdf" style="display:none;" onchange="handlePlanFileSelect(event)">
                    <button class="btn-upload-plan" id="btnUploadPlan" onclick="document.getElementById('planFileInput').click()">
                        <span style="font-size:20px;">&#128196;</span> T&eacute;l&eacute;verser un nouveau plan
                    </button>
                    <div id="planUploadStatus" style="display:none; margin-top:12px; padding:10px; border-radius:6px; font-size:13px; text-align:center;"></div>
                </div>
                <div id="plansListContainer" class="plans-list">
                    <div class="plans-empty">Aucun plan pour cette soumission</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closePlansModal()">Fermer</button>
            </div>
        </div>
    </div>

    <!-- Edit Project Info Modal -->
    <div class="modal-overlay" id="editInfoModal">
        <div class="modal" style="max-width:520px;">
            <div class="modal-header">
                <h3 class="modal-title">Informations du projet</h3>
                <button class="modal-close" onclick="closeEditInfoModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Client</label>
                    <div class="contact-combo-wrap" id="clientComboWrap">
                        <input type="text" id="infoClientCombo" placeholder="Rechercher un contact ou une entreprise..."
                               autocomplete="off" oninput="filterClientCombo(this)" onfocus="openClientCombo()">
                        <div class="contact-combo-dd" id="clientComboDd"></div>
                    </div>
                    <div id="clientComboSelected" style="font-size:12px; color:var(--sw-navy); margin-top:4px;"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">Adresse du projet</label>
                    <input type="text" class="form-input" id="infoProjectAddress" placeholder="Adresse">
                </div>
                <div class="info-modal-row">
                    <div class="form-group">
                        <label class="form-label">Ville</label>
                        <input type="text" class="form-input" id="infoProjectCity" placeholder="Ville">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Code postal</label>
                        <input type="text" class="form-input" id="infoProjectPostalCode" placeholder="H0H 0H0">
                    </div>
                </div>
                <div id="addrSuggestPanel" style="display:none;"></div>

                <hr style="border:none;border-top:1px solid #eee;margin:16px 0;">
                <div style="font-size:12px;font-weight:600;color:#888;text-transform:uppercase;letter-spacing:0.3px;margin-bottom:10px;">Pipeline commercial</div>

                <div class="info-modal-row">
                    <div class="form-group">
                        <label class="form-label">Statut pipeline</label>
                        <select class="form-input" id="infoPipelineStatus"></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Priorit&eacute;</label>
                        <select class="form-input" id="infoPriority">
                            <option value="normal">Normal</option>
                            <option value="haute">Haute</option>
                            <option value="urgente">Urgente</option>
                        </select>
                    </div>
                </div>
                <div class="info-modal-row">
                    <div class="form-group">
                        <label class="form-label">Source</label>
                        <select class="form-input" id="infoSource"><option value="">—</option></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Type</label>
                        <select class="form-input" id="infoProjectType"><option value="">—</option></select>
                    </div>
                </div>
                <div class="info-modal-row">
                    <div class="form-group">
                        <label class="form-label">Montant estim&eacute; ($)</label>
                        <input type="number" class="form-input" id="infoEstimatedAmount" placeholder="0" min="0" step="100">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Probabilit&eacute; (%)</label>
                        <input type="range" id="infoProbability" min="0" max="100" step="5" value="0" oninput="document.getElementById('infoProbVal').textContent=this.value+'%'" style="width:100%;">
                        <span id="infoProbVal" style="font-size:12px;color:#666;">0%</span>
                    </div>
                </div>
                <div class="info-modal-row">
                    <div class="form-group">
                        <label class="form-label">Responsable</label>
                        <select class="form-input" id="infoAssignedTo"><option value="">—</option></select>
                    </div>
                </div>
                <div class="info-modal-row">
                    <div class="form-group">
                        <label class="form-label">Mois de livraison</label>
                        <input type="month" class="form-input" id="infoDeliveryMonth" placeholder="ex: 2026-05">
                    </div>
                </div>
                <div class="info-modal-row">
                    <div class="form-group">
                        <label class="form-label">Deadline interne</label>
                        <input type="date" class="form-input" id="infoInternalDeadline">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Deadline client</label>
                        <input type="date" class="form-input" id="infoClientDeadline">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeEditInfoModal()">Annuler</button>
                <button class="btn-generate" onclick="saveProjectInfo()">Enregistrer</button>
            </div>
        </div>
    </div>

    <!-- Contacts Modal -->
    <div class="contacts-overlay" id="contactsModal" onclick="if(event.target===this)closeContactsModal()">
        <div class="contacts-modal">
            <div class="contacts-modal-header">
                <h2>Contacts du projet</h2>
                <button class="contacts-modal-close" onclick="closeContactsModal()">&times;</button>
            </div>
            <div class="contacts-modal-body">
                <div class="contact-cards-grid" id="contactCardsGrid"></div>
                <button class="btn-add-contact" onclick="openAddContactModal()">+ Ajouter un contact</button>
            </div>
        </div>
    </div>

    <!-- Add Contact Sub-Modal -->
    <div class="add-contact-overlay" id="addContactOverlay" onclick="if(event.target===this)closeAddContactModal()">
        <div class="modal" style="max-width:460px;">
            <div class="modal-header">
                <h3 class="modal-title">Ajouter un contact</h3>
                <button class="modal-close" onclick="closeAddContactModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">R&ocirc;le</label>
                    <select class="form-input" id="addContactRole" onchange="toggleCustomRole()">
                        <option value="Propri&eacute;taire">Propri&eacute;taire</option>
                        <option value="Entrepreneur">Entrepreneur</option>
                        <option value="Client">Client</option>
                        <option value="Designer">Designer</option>
                        <option value="Architecte">Architecte</option>
                        <option value="Autre">Autre...</option>
                    </select>
                    <input type="text" class="form-input" id="addContactRoleCustom" placeholder="R&ocirc;le personnalis&eacute;..." style="display:none; margin-top:6px;">
                </div>
                <div class="form-group">
                    <label class="form-label">Rechercher un contact</label>
                    <div class="contact-combo-wrap" id="contactComboWrap">
                        <input type="text" id="contactComboInput" placeholder="Taper un nom..." autocomplete="off"
                               oninput="filterContactCombo(this)" onfocus="openContactCombo()">
                        <div class="contact-combo-dd" id="contactComboDd"></div>
                    </div>
                </div>
                <div id="addContactStatus" style="font-size:13px; margin-top:8px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeAddContactModal()">Annuler</button>
                <button class="btn-generate" id="btnConfirmAddContact" onclick="confirmAddContact()" disabled>Ajouter</button>
            </div>
        </div>
    </div>

    <!-- Contact Detail Modal -->
    <div class="modal-overlay" id="contactDetailModal" onclick="if(event.target===this)closeContactDetail()">
        <div class="modal" style="max-width:480px;">
            <div class="modal-header">
                <h3 class="modal-title" id="contactDetailTitle">Contact</h3>
                <button class="modal-close" onclick="closeContactDetail()">&times;</button>
            </div>
            <div class="modal-body" id="contactDetailBody"></div>
            <div class="modal-footer">
                <a id="contactDetailCrmLink" href="#" target="_blank" style="font-size:13px; color:var(--sw-navy); text-decoration:none;">Ouvrir dans le CRM &rarr;</a>
                <button class="btn-cancel" onclick="closeContactDetail()">Fermer</button>
            </div>
        </div>
    </div>

    <!-- PDF Viewer Modal -->
    <div class="pdf-viewer-overlay" id="pdfViewerOverlay">
        <div class="pdf-viewer-container">
            <!-- Header avec contrôles -->
            <div class="pdf-viewer-header">
                <div class="pdf-viewer-title" id="pdfViewerTitle">Plan architectural</div>
                <div class="pdf-viewer-controls">
                    <button class="pdf-control-btn" id="btnPdfPrev" onclick="pdfNavigate(-1)" title="Page pr\u00e9c\u00e9dente">&#9664;</button>
                    <span class="pdf-page-info" id="pdfPageInfo">1 / 1</span>
                    <button class="pdf-control-btn" id="btnPdfNext" onclick="pdfNavigate(1)" title="Page suivante">&#9654;</button>
                    <div class="pdf-control-divider"></div>
                    <button class="pdf-control-btn" onclick="pdfZoom(-0.25)" title="Zoom -">&#8722;</button>
                    <span class="pdf-zoom-info" id="pdfZoomInfo">100%</span>
                    <button class="pdf-control-btn" onclick="pdfZoom(0.25)" title="Zoom +">&#43;</button>
                    <button class="pdf-control-btn" onclick="pdfResetZoom()" title="R\u00e9initialiser zoom">&#8634;</button>
                    <div class="pdf-control-divider"></div>
                    <button class="pdf-control-btn" onclick="pdfRotate()" title="Rotation 90\u00b0">&#8635;</button>
                    <div class="pdf-control-divider"></div>
                    <button class="pdf-action-btn" id="btnCapturePage" onclick="capturePdfPage()" title="Capturer cette page">&#128248; Capturer</button>
                    <button class="pdf-action-btn" onclick="openPdfInNewWindow()" title="Ouvrir dans une nouvelle fenêtre" style="margin-left:8px;">&#8599; Nouvelle fenêtre</button>
                </div>
                <button class="pdf-viewer-close" onclick="closePdfViewer()">&times;</button>
            </div>

            <!-- Content avec sidebar et canvas -->
            <div class="pdf-viewer-content">
                <!-- Sidebar avec thumbnails -->
                <div class="pdf-sidebar" id="pdfSidebar">
                    <div class="pdf-sidebar-title">Pages</div>
                    <div class="pdf-thumbnails" id="pdfThumbnails"></div>
                </div>

                <!-- Main canvas area -->
                <div class="pdf-canvas-container" id="pdfCanvasContainer">
                    <canvas id="pdfCanvas"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Capture Room Selection -->
    <div class="modal-overlay" id="captureRoomModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">Capturer la page du plan</h3>
                <button class="modal-close" onclick="closeCaptureRoomModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="font-size:13px; color:#666; margin-bottom:16px;">
                    S&eacute;lectionnez la pi&egrave;ce/meuble o&ugrave; associer cette capture haute r&eacute;solution.
                </p>
                <div class="form-group">
                    <label class="form-label">Pi&egrave;ce / Meuble</label>
                    <select class="form-input" id="captureRoomSelect">
                        <option value="">-- S&eacute;lectionnez --</option>
                    </select>
                </div>
                <div id="captureStatus" style="display:none; padding:10px; border-radius:4px; font-size:13px; margin-top:12px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeCaptureRoomModal()">Annuler</button>
                <button class="btn-generate" id="btnConfirmCapture" onclick="confirmCapture()">Capturer</button>
            </div>
        </div>
    </div>

    <!-- Crop Modal -->
    <div class="crop-overlay" id="cropModal">
        <div class="crop-box">
            <div class="crop-header">
                <span>Cadrer l'image</span>
                <span id="cropDimensions" style="font-weight:400; font-size:12px; color:#888;"></span>
            </div>
            <div class="crop-error" id="cropError"></div>
            <div class="crop-container" id="cropContainer">
                <img id="cropImage" src="">
            </div>
            <div class="crop-controls">
                <div class="crop-ratios">
                    <button class="crop-ratio-btn active" id="cropRatio169" onclick="setCropRatio('16:9')">16:9</button>
                    <button class="crop-ratio-btn" id="cropRatio916" onclick="setCropRatio('9:16')">9:16</button>
                    <button class="crop-ratio-btn" id="cropRatio11" onclick="setCropRatio('1:1')">1:1</button>
                </div>
                <div class="crop-actions">
                    <button class="crop-btn crop-btn-cancel" onclick="cancelCrop()">Annuler</button>
                    <button class="crop-btn crop-btn-confirm" id="cropConfirmBtn" onclick="confirmCrop()">Valider</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ═══════════════════════════════════════════════════════════════════════
        // UTILITAIRES
        // ═══════════════════════════════════════════════════════════════════════

        function openLightbox(src) {
            document.getElementById('lightboxImg').src = src;
            document.getElementById('lightbox').classList.add('active');
        }

        function closeLightbox() {
            document.getElementById('lightbox').classList.remove('active');
            document.getElementById('lightboxImg').src = '';
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && document.getElementById('lightbox').classList.contains('active')) closeLightbox();
            if (e.key === 'Escape' && document.getElementById('annotationModal').classList.contains('active')) closeAnnotationModal();
        });

        // ═══════════════════════════════════════════════════════════════════════
        // ANNOTATION — TAGS VISUELS SUR IMAGES
        // ═══════════════════════════════════════════════════════════════════════

        var annotState = {
            groupId: null,
            imageIndex: -1,
            annotations: [],
            selectedPrefix: 'C',
            arrowMode: false,
            awaitingArrowTarget: null, // annotation id waiting for arrow click
            dragging: null, // { id, startX, startY, origX, origY }
            mediaId: null
        };
        var annotSaveTimer = null;

        function openAnnotationModal(groupId, index) {
            var imgs = groupImages[groupId] || [];
            var img = imgs[index];
            if (!img || img.isLegacy) return;

            annotState.groupId = groupId;
            annotState.imageIndex = index;
            annotState.mediaId = img.mediaId;
            annotState.annotations = JSON.parse(JSON.stringify(img.annotations || []));
            annotState.awaitingArrowTarget = null;
            annotState.dragging = null;

            // Set image
            var imgEl = document.getElementById('annotImage');
            imgEl.src = img.url || img.dataUrl;

            // Populate prefix dropdown from tagPrefixes
            var sel = document.getElementById('annotPrefixSelect');
            sel.innerHTML = '';
            (tagPrefixes || []).forEach(function(tp) {
                var opt = document.createElement('option');
                opt.value = tp.prefix;
                opt.textContent = tp.prefix + ' — ' + tp.label_fr;
                sel.appendChild(opt);
            });
            if (sel.options.length > 0) {
                annotState.selectedPrefix = sel.options[0].value;
            }

            // Reset arrow mode
            document.getElementById('annotArrowMode').checked = false;
            annotState.arrowMode = false;

            // Show modal
            document.getElementById('annotationModal').classList.add('active');

            // Wait for image to load then sync SVG size and render
            imgEl.onload = function() {
                syncAnnotSvgSize();
                renderAnnotationSVG();
                updateAnnotNext();
            };
            if (imgEl.complete) {
                setTimeout(function() {
                    syncAnnotSvgSize();
                    renderAnnotationSVG();
                    updateAnnotNext();
                }, 50);
            }
        }

        function closeAnnotationModal() {
            saveAnnotationsNow();
            document.getElementById('annotationModal').classList.remove('active');
            document.getElementById('annotImage').src = '';
            // Update in-memory groupImages
            var imgs = groupImages[annotState.groupId] || [];
            if (imgs[annotState.imageIndex]) {
                imgs[annotState.imageIndex].annotations = annotState.annotations;
            }
            renderGroupImagePreviews(annotState.groupId);
        }

        function syncAnnotSvgSize() {
            var imgEl = document.getElementById('annotImage');
            var svg = document.getElementById('annotSvg');
            var rect = imgEl.getBoundingClientRect();
            svg.style.left = imgEl.offsetLeft + 'px';
            svg.style.top = imgEl.offsetTop + 'px';
            svg.style.width = rect.width + 'px';
            svg.style.height = rect.height + 'px';
            svg.setAttribute('viewBox', '0 0 ' + rect.width + ' ' + rect.height);
        }

        function updateAnnotNext() {
            var prefix = document.getElementById('annotPrefixSelect').value;
            annotState.selectedPrefix = prefix;
            var next = getNextTagNumber(prefix);
            document.getElementById('annotNext').textContent = 'Prochain: ' + prefix + next;
        }

        function getNextTagNumber(prefix) {
            var used = {};
            annotState.annotations.forEach(function(a) {
                if (a.prefix === prefix) used[a.number] = true;
            });
            for (var i = 1; i <= 999; i++) {
                if (!used[i]) return i;
            }
            return 999;
        }

        function handleAnnotationClick(e) {
            if (annotState.dragging) return;
            var imgEl = document.getElementById('annotImage');
            var rect = imgEl.getBoundingClientRect();
            var relX = (e.clientX - rect.left) / rect.width;
            var relY = (e.clientY - rect.top) / rect.height;
            relX = Math.max(0, Math.min(1, relX));
            relY = Math.max(0, Math.min(1, relY));

            // If awaiting arrow target placement
            if (annotState.awaitingArrowTarget) {
                var annot = annotState.annotations.find(function(a) { return a.id === annotState.awaitingArrowTarget; });
                if (annot) {
                    annot.hasArrow = true;
                    annot.arrowX = relX;
                    annot.arrowY = relY;
                }
                annotState.awaitingArrowTarget = null;
                renderAnnotationSVG();
                debounceSaveAnnotations();
                return;
            }

            // Place new label
            var prefix = annotState.selectedPrefix;
            var num = getNextTagNumber(prefix);
            var newAnnot = {
                id: prefix + num,
                prefix: prefix,
                number: num,
                x: relX,
                y: relY,
                hasArrow: false,
                arrowX: null,
                arrowY: null
            };
            annotState.annotations.push(newAnnot);

            if (annotState.arrowMode) {
                annotState.awaitingArrowTarget = newAnnot.id;
            }

            renderAnnotationSVG();
            updateAnnotNext();
            debounceSaveAnnotations();
        }

        function renderAnnotationSVG() {
            var svg = document.getElementById('annotSvg');
            var imgEl = document.getElementById('annotImage');
            var rect = imgEl.getBoundingClientRect();
            var w = rect.width;
            var h = rect.height;

            // Keep defs, clear the rest
            var defs = svg.querySelector('defs');
            svg.innerHTML = '';
            svg.appendChild(defs);

            annotState.annotations.forEach(function(a) {
                var px = a.x * w;
                var py = a.y * h;

                // Draw arrow if present
                if (a.hasArrow && a.arrowX != null && a.arrowY != null) {
                    var ax = a.arrowX * w;
                    var ay = a.arrowY * h;
                    var line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', px);
                    line.setAttribute('y1', py);
                    line.setAttribute('x2', ax);
                    line.setAttribute('y2', ay);
                    line.setAttribute('class', 'annot-arrow');
                    svg.appendChild(line);
                }

                // Draw label group
                var g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                g.setAttribute('class', 'annot-label');
                g.setAttribute('data-annot-id', a.id);

                var text = a.id;
                var tw = text.length * 8 + 10;
                var th = 22;

                var r = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                r.setAttribute('x', px - tw / 2);
                r.setAttribute('y', py - th / 2);
                r.setAttribute('width', tw);
                r.setAttribute('height', th);
                r.setAttribute('rx', 4);
                r.setAttribute('fill', '#0B1220');
                r.setAttribute('stroke', 'none');
                g.appendChild(r);

                var t = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                t.setAttribute('x', px);
                t.setAttribute('y', py + 5);
                t.setAttribute('text-anchor', 'middle');
                t.setAttribute('fill', '#fff');
                t.setAttribute('font-size', '13');
                t.setAttribute('font-weight', '700');
                t.setAttribute('font-family', 'inherit');
                t.textContent = text;
                g.appendChild(t);

                // Drag events
                g.addEventListener('mousedown', function(e) {
                    e.stopPropagation();
                    if (e.button === 2) return; // right-click handled by contextmenu
                    annotState.dragging = {
                        id: a.id,
                        startX: e.clientX,
                        startY: e.clientY,
                        origX: a.x,
                        origY: a.y
                    };
                    g.classList.add('dragging');
                });

                // Right-click to delete
                g.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    steleConfirm('Supprimer le tag ' + a.id + ' de cette image ?', 'Supprimer annotation', 'Supprimer', true).then(function(ok) {
                        if (ok) deleteAnnotation(a.id);
                    });
                });

                svg.appendChild(g);
            });

            // Awaiting arrow indicator
            if (annotState.awaitingArrowTarget) {
                var hint = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                hint.setAttribute('x', w / 2);
                hint.setAttribute('y', 20);
                hint.setAttribute('text-anchor', 'middle');
                hint.setAttribute('fill', '#fff');
                hint.setAttribute('font-size', '14');
                hint.setAttribute('font-weight', '600');
                hint.textContent = 'Cliquer pour placer la cible de la fl\u00e8che';
                svg.appendChild(hint);
            }
        }

        // Global mousemove/mouseup for drag
        document.addEventListener('mousemove', function(e) {
            if (!annotState.dragging) return;
            var imgEl = document.getElementById('annotImage');
            var rect = imgEl.getBoundingClientRect();
            var dx = (e.clientX - annotState.dragging.startX) / rect.width;
            var dy = (e.clientY - annotState.dragging.startY) / rect.height;
            var annot = annotState.annotations.find(function(a) { return a.id === annotState.dragging.id; });
            if (annot) {
                annot.x = Math.max(0, Math.min(1, annotState.dragging.origX + dx));
                annot.y = Math.max(0, Math.min(1, annotState.dragging.origY + dy));
                renderAnnotationSVG();
            }
        });

        document.addEventListener('mouseup', function() {
            if (annotState.dragging) {
                annotState.dragging = null;
                debounceSaveAnnotations();
            }
        });

        // Sync SVG size on window resize
        window.addEventListener('resize', function() {
            if (document.getElementById('annotationModal').classList.contains('active')) {
                syncAnnotSvgSize();
                renderAnnotationSVG();
            }
        });

        function deleteAnnotation(annotId) {
            annotState.annotations = annotState.annotations.filter(function(a) { return a.id !== annotId; });
            renderAnnotationSVG();
            updateAnnotNext();
            debounceSaveAnnotations();
        }

        function debounceSaveAnnotations() {
            clearTimeout(annotSaveTimer);
            annotSaveTimer = setTimeout(saveAnnotationsNow, 500);
        }

        function saveAnnotationsNow() {
            clearTimeout(annotSaveTimer);
            if (!annotState.mediaId) return;
            authenticatedFetch(SUPABASE_URL + '/rest/v1/room_media?id=eq.' + annotState.mediaId, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                body: JSON.stringify({ annotations: annotState.annotations })
            }).then(function() {
                showSaveIndicator();
            }).catch(function(e) {
                console.warn('[Annot] Save failed:', e);
            });
        }

        // Arrow mode toggle
        document.getElementById('annotArrowMode').addEventListener('change', function() {
            annotState.arrowMode = this.checked;
        });

        function formatPrice(amount) {
            if (amount === null || amount === undefined) return 'Sur demande';
            if (typeof amount === 'number' && amount < 1 && amount > 0) return (amount * 100).toFixed(0) + '%';
            return amount.toLocaleString('fr-CA', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' $';
        }

        function formatType(type) {
            if (type === '%') return '%';
            return type;
        }

        function updateStatus(status, message) {
            const statusEl = document.getElementById('dataStatus');
            const textEl = document.getElementById('statusText');
            statusEl.className = 'data-status ' + status;
            textEl.textContent = message;
        }

        function formatDate(date) {
            if (!date) return '';
            const options = { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' };
            return date.toLocaleDateString('fr-CA', options);
        }

        function getUserEmail() {
            try {
                const token = localStorage.getItem('sb_access_token');
                if (!token) return '';
                const payload = JSON.parse(atob(token.split('.')[1]));
                return payload.email || '';
            } catch (e) { return ''; }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // CHARGEMENT DES DONN&Eacute;ES
        // ═══════════════════════════════════════════════════════════════════════

        function saveToLocalStorage(data) {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                localStorage.setItem(STORAGE_DATE_KEY, new Date().toISOString());
            } catch (e) { console.warn('Impossible de sauvegarder dans localStorage:', e); }
        }

        function loadFromLocalStorage() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                const date = localStorage.getItem(STORAGE_DATE_KEY);
                if (data) return { data: JSON.parse(data), date: date ? new Date(date) : null };
            } catch (e) { console.warn('Impossible de lire depuis localStorage:', e); }
            return null;
        }

        function loadCatalogueData() {
            return new Promise((resolve) => {
                updateStatus('', 'Chargement...');

                var userEmail = getUserEmail();
                authenticatedFetch(SUPABASE_URL + '/rest/v1/catalogue_items?select=id,category,description,type,price,instruction,image_url,in_calculator,status,proposed_by,labor_minutes,material_costs,calculation_rule_ai,is_default,client_text,presentation_rule,item_type,dims_config,loss_override_pct&or=(status.eq.approved,status.is.null,and(status.eq.pending,proposed_by.eq.' + encodeURIComponent(userEmail) + '))&order=sort_order', {})
                .then(r => {
                    if (!r.ok) throw new Error('HTTP ' + r.status);
                    return r.json();
                })
                .then(data => {
                    if (data.length > 0) {
                        CATALOGUE_DATA = data;
                        saveToLocalStorage(data);
                        updateStatus('online', 'Données à jour');
                        resolve(true);
                    } else {
                        throw new Error('Données vides');
                    }
                })
                .catch(error => {
                    console.warn('Erreur chargement catalogue:', error);
                    loadFallbackData();
                    resolve(false);
                });
            });
        }

        function loadFallbackData() {
            const cached = loadFromLocalStorage();
            if (cached && cached.data && cached.data.length > 0) {
                CATALOGUE_DATA = cached.data;
                const dateStr = cached.date ? formatDate(cached.date) : '';
                updateStatus('offline', 'Hors-ligne' + (dateStr ? ' — ' + dateStr : ''));
            } else {
                updateStatus('error', 'Aucune donnée disponible');
            }
        }

        function loadEmployeesData() {
            return new Promise((resolve) => {
                authenticatedFetch(SUPABASE_URL + '/rest/v1/employees?select=name,email&order=sort_order', {})
                .then(r => {
                    if (!r.ok) throw new Error('HTTP ' + r.status);
                    return r.json();
                })
                .then(data => {
                    EMPLOYEES_DATA = data;
                    resolve(true);
                })
                .catch(error => {
                    console.warn('Erreur chargement employ\u00e9s:', error);
                    resolve(false);
                });
            });
        }

        function loadUserProfilesMap() {
            return authenticatedFetch(SUPABASE_URL + '/rest/v1/user_profiles?select=contacts(first_name,last_name,email)', {})
            .then(function(r) { return r.ok ? r.json() : []; })
            .then(function(profiles) {
                profiles.forEach(function(p) {
                    if (!p.contacts || !p.contacts.email) return;
                    var name = ((p.contacts.first_name || '') + ' ' + (p.contacts.last_name || '')).trim();
                    if (name) USER_PROFILES_MAP[p.contacts.email.toLowerCase()] = name;
                });
            })
            .catch(function(e) { console.warn('Profiles map:', e); });
        }

        // ═══════════════════════════════════════════════════════════════════════
        // CALCULATEUR — SECTIONS PAR MEUBLE
        // ═══════════════════════════════════════════════════════════════════════

        let rowCounter = 0;
        let groupCounter = 0;

        // ── Combobox autocomplete ──
        var _cbActiveRowId = null;
        var _cbIdx = -1; // keyboard navigation index

        function getCatalogueItems() {
            return CATALOGUE_DATA.filter(function(item) {
                return (item.price !== null || item.labor_minutes || item.material_costs) &&
                       item.type !== '%' && item.in_calculator !== false;
            }).sort(function(a, b) { return (a.category || '').localeCompare(b.category || ''); });
        }

        function openCombobox(rowId) {
            if (_cbActiveRowId === rowId) return; // already open
            closeCombobox();
            _cbActiveRowId = rowId;
            _cbIdx = -1;
            var cbInput = document.getElementById(rowId + '-cb');
            if (!cbInput) return;

            // Clear display for search mode
            cbInput.dataset.prevValue = cbInput.value;
            cbInput.value = '';
            cbInput.classList.remove('has-value');

            // Create dropdown
            var dd = document.getElementById('cbDropdown');
            if (!dd) {
                dd = document.createElement('div');
                dd.id = 'cbDropdown';
                dd.className = 'cb-dropdown';
                document.body.appendChild(dd);
            }
            dd.style.display = '';
            dd.innerHTML = '';
            renderComboboxItems(dd, '');
            positionCombobox(dd, cbInput);

            // Keyboard
            cbInput.onkeydown = function(e) { handleComboboxKey(e, rowId); };
            cbInput.oninput = function() { renderComboboxItems(dd, cbInput.value); _cbIdx = -1; };

            // Click outside
            setTimeout(function() {
                document.addEventListener('mousedown', _cbOutsideClick);
            }, 0);
        }

        function _cbOutsideClick(e) {
            var dd = document.getElementById('cbDropdown');
            if (dd && dd.contains(e.target)) return;
            var cbInput = _cbActiveRowId ? document.getElementById(_cbActiveRowId + '-cb') : null;
            if (cbInput && cbInput.contains(e.target)) return;
            closeCombobox();
        }

        function closeCombobox() {
            document.removeEventListener('mousedown', _cbOutsideClick);
            var dd = document.getElementById('cbDropdown');
            if (dd) dd.style.display = 'none';
            // Restore display value if no selection was made
            if (_cbActiveRowId) {
                syncComboboxDisplay(_cbActiveRowId);
            }
            _cbActiveRowId = null;
            _cbIdx = -1;
        }

        function positionCombobox(dd, anchor) {
            var r = anchor.getBoundingClientRect();
            var spaceBelow = window.innerHeight - r.bottom;
            dd.style.left = r.left + 'px';
            dd.style.width = Math.max(r.width, 360) + 'px';
            if (spaceBelow < 200) {
                dd.style.bottom = (window.innerHeight - r.top + 4) + 'px';
                dd.style.top = 'auto';
            } else {
                dd.style.top = (r.bottom + 4) + 'px';
                dd.style.bottom = 'auto';
            }
        }

        function renderComboboxItems(dd, query) {
            var q = (query || '').toLowerCase().trim();
            var items = getCatalogueItems();
            if (q) {
                items = items.filter(function(item) {
                    return (item.description || '').toLowerCase().indexOf(q) !== -1 ||
                           (item.id || '').toLowerCase().indexOf(q) !== -1 ||
                           (item.client_text || '').toLowerCase().indexOf(q) !== -1;
                });
            }
            // Prioritize items matching submission default materials
            var dmIds = {};
            var dm = getDefaultMaterials();
            dm.forEach(function(entry) {
                if (entry.catalogue_item_id) dmIds[entry.catalogue_item_id] = true;
            });
            var hasDmIds = Object.keys(dmIds).length > 0;
            var priorityItems = [];
            var restItems = [];
            if (hasDmIds) {
                items.forEach(function(item) {
                    if (dmIds[item.id]) priorityItems.push(item);
                    else restItems.push(item);
                });
            } else {
                restItems = items;
            }

            var html = '';
            var globalIdx = 0;

            function renderCbItem(item) {
                var isPending = item.status === 'pending';
                var pendingBadge = isPending ? ' <span style="color:#f59e0b;">(en attente)</span>' : '';
                var cls = 'cb-item' + (isPending ? ' cb-pending' : '');
                var click = isPending
                    ? 'showPendingToast(event)'
                    : 'selectComboboxItem(\'' + escapeAttr(item.id) + '\')';
                html += '<div class="' + cls + '" data-id="' + escapeAttr(item.id) + '" data-idx="' + globalIdx + '" onclick="' + click + '" onmouseenter="_cbIdx=' + globalIdx + '">'
                    + '<span class="cb-item-code">' + escapeHtml(item.id) + '</span>'
                    + '<span class="cb-item-desc">' + escapeHtml(item.description) + pendingBadge + '</span>'
                    + '<span class="cb-item-type">' + escapeHtml(item.type || '') + '</span>'
                    + '</div>';
                globalIdx++;
            }

            // Render priority items first
            if (priorityItems.length > 0) {
                html += '<div class="cb-group-label" style="color:#1565C0;font-weight:600;">Matériaux par défaut</div>';
                priorityItems.forEach(renderCbItem);
            }

            // Render rest grouped by category
            var currentCat = '';
            restItems.forEach(function(item) {
                if (item.category !== currentCat) {
                    currentCat = item.category;
                    html += '<div class="cb-group-label">' + escapeHtml(currentCat || 'Autre') + '</div>';
                }
                renderCbItem(item);
            });
            // Special options
            html += '<div class="cb-group-label">Autre</div>';
            html += '<div class="cb-item" onclick="selectComboboxItem(\'__PROPOSER__\')"><span class="cb-item-special">\ud83d\udccb Proposer un nouvel article...</span></div>';
            html += '<div class="cb-item" onclick="selectComboboxItem(\'__AJOUT__\')"><span class="cb-item-special">\u2795 Ajout personnalis\u00e9...</span></div>';

            if (items.length === 0 && q) {
                html = '<div class="cb-empty">Aucun article trouv\u00e9 pour \u00ab ' + escapeHtml(q) + ' \u00bb</div>' + html;
            }
            dd.innerHTML = html;
        }

        function selectComboboxItem(itemId) {
            if (!_cbActiveRowId) return;
            var rowId = _cbActiveRowId;
            var row = document.getElementById(rowId);
            if (!row) return;
            var hidden = row.querySelector('.item-select');
            if (hidden) hidden.value = itemId;
            closeCombobox();
            updateRow(rowId);
        }

        var _pendingToastTimer = null;
        function showPendingToast(e) {
            if (e) e.stopPropagation();
            var dd = document.getElementById('cbDropdown');
            if (!dd) return;
            var existing = dd.querySelector('.cb-pending-toast');
            if (existing) existing.remove();
            clearTimeout(_pendingToastTimer);
            var toast = document.createElement('div');
            toast.className = 'cb-pending-toast';
            toast.textContent = 'Cet article est en attente d\u2019approbation';
            dd.appendChild(toast);
            _pendingToastTimer = setTimeout(function() { if (toast.parentNode) toast.remove(); }, 3000);
        }

        function handleComboboxKey(e, rowId) {
            var dd = document.getElementById('cbDropdown');
            if (!dd) return;
            var allItems = dd.querySelectorAll('.cb-item');
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                _cbIdx = Math.min(_cbIdx + 1, allItems.length - 1);
                allItems.forEach(function(el, i) { el.classList.toggle('cb-active', i === _cbIdx); });
                if (allItems[_cbIdx]) allItems[_cbIdx].scrollIntoView({ block: 'nearest' });
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                _cbIdx = Math.max(_cbIdx - 1, 0);
                allItems.forEach(function(el, i) { el.classList.toggle('cb-active', i === _cbIdx); });
                if (allItems[_cbIdx]) allItems[_cbIdx].scrollIntoView({ block: 'nearest' });
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (_cbIdx >= 0 && allItems[_cbIdx]) {
                    if (allItems[_cbIdx].classList.contains('cb-pending')) {
                        showPendingToast();
                    } else {
                        allItems[_cbIdx].click();
                    }
                }
            } else if (e.key === 'Escape') {
                e.preventDefault();
                closeCombobox();
            }
        }

        function syncComboboxDisplay(rowId) {
            var row = document.getElementById(rowId);
            if (!row) return;
            var hidden = row.querySelector('.item-select');
            var cbInput = document.getElementById(rowId + '-cb');
            var editBtn = document.getElementById(rowId + '-edit-btn');
            if (!hidden || !cbInput) return;
            var val = hidden.value;
            if (val && val !== '__PROPOSER__' && val !== '__AJOUT__') {
                var item = CATALOGUE_DATA.find(function(i) { return i.id === val; });
                cbInput.value = item ? item.description : val;
                cbInput.classList.add('has-value');
                if (editBtn) editBtn.style.display = '';
            } else if (val === '__AJOUT__') {
                cbInput.value = 'Ajout personnalis\u00e9';
                cbInput.classList.add('has-value');
                if (editBtn) editBtn.style.display = 'none';
            } else if (val === '__PROPOSER__') {
                cbInput.value = 'Proposer un article';
                cbInput.classList.add('has-value');
                if (editBtn) editBtn.style.display = 'none';
            } else {
                cbInput.value = '';
                cbInput.classList.remove('has-value');
                if (editBtn) editBtn.style.display = 'none';
            }
        }

        function openCatalogueItem(rowId) {
            var row = document.getElementById(rowId);
            if (!row) return;
            var hidden = row.querySelector('.item-select');
            var val = hidden ? hidden.value : '';
            if (val && val !== '__PROPOSER__' && val !== '__AJOUT__') {
                _catEditRowId = rowId;
                var overlay = document.getElementById('catEditOverlay');
                var iframe = document.getElementById('catEditIframe');
                iframe.src = 'catalogue_prix_stele_complet.html?edit=' + encodeURIComponent(val) + '&embedded=1';
                overlay.classList.add('active');
            }
        }

        function closeCatEditOverlay() {
            document.getElementById('catEditOverlay').classList.remove('active');
            document.getElementById('catEditIframe').src = 'about:blank';
            _catEditRowId = null;
        }

        function updateRowFromCatalogue(rowId, item) {
            if (!item) return;
            var row = document.getElementById(rowId);
            if (!row) return;
            var priceInput = document.getElementById(rowId + '-unit-price');
            if (priceInput && item.price != null) {
                priceInput.value = parseFloat(item.price).toFixed(2);
                priceInput.dispatchEvent(new Event('input', {bubbles: true}));
            }
            var cbInput = document.getElementById(rowId + '-cb');
            if (cbInput && item.description) {
                cbInput.value = item.description;
            }
        }

        window.addEventListener('message', function(e) {
            if (!e.data || !e.data.type) return;
            if (e.data.type === 'catalogue-modal-closed') {
                // If closing a proposer flow, reset the row
                if (_catEditRowId) {
                    var row = document.getElementById(_catEditRowId);
                    if (row) {
                        var hidden = row.querySelector('.item-select');
                        if (hidden && hidden.value === '__PROPOSER__') {
                            hidden.value = '';
                            updateRow(_catEditRowId);
                        }
                    }
                }
                closeCatEditOverlay();
            }
            if (e.data.type === 'catalogue-item-saved') {
                var updated = e.data.item;
                if (updated && updated.id) {
                    var idx = CATALOGUE_DATA.findIndex(function(c) { return c.id === updated.id; });
                    if (idx >= 0) CATALOGUE_DATA[idx] = updated;
                    else CATALOGUE_DATA.push(updated);
                }
                if (_catEditRowId) {
                    var row = document.getElementById(_catEditRowId);
                    if (row && updated && updated.id) {
                        var hidden = row.querySelector('.item-select');
                        if (hidden && (!hidden.value || hidden.value === '__PROPOSER__')) {
                            hidden.value = updated.id;
                        }
                    }
                    updateRowFromCatalogue(_catEditRowId, updated);
                    updateRow(_catEditRowId);
                }
                closeCatEditOverlay();
            }
        });

        function toggleGroup(groupId) {
            document.getElementById(groupId).classList.toggle('collapsed');
        }

        function toggleProjectInstallation() {
            var cb = document.getElementById('projInstallation');
            var checked = cb.checked;
            // Cascade vers toutes les sections
            document.querySelectorAll('.furniture-group').forEach(function(group) {
                var groupId = group.id;
                var sectionCb = document.getElementById(groupId + '-install');
                if (sectionCb && sectionCb.checked !== checked) {
                    sectionCb.checked = checked;
                    toggleInstallation(groupId);
                }
            });
        }

        function toggleInstallation(groupId) {
            var cb = document.getElementById(groupId + '-install');
            // Cascade vers toutes les lignes de ce groupe
            var rows = document.querySelectorAll('#' + groupId + '-rows .calc-row');
            rows.forEach(function(row) {
                var rowCb = document.getElementById(row.id + '-install');
                if (rowCb) rowCb.checked = cb.checked;
                updateRow(row.id);
            });

            // Sauvegarder dans Supabase
            if (roomMap[groupId]) {
                updateRoom(roomMap[groupId], { installation_included: cb.checked });
                showSaveIndicator();
            }
        }

        function toggleRowInstallation(rowId) {
            updateRow(rowId);
            // Sauvegarder dans Supabase
            if (itemMap[rowId]) {
                var cb = document.getElementById(rowId + '-install');
                updateItem(itemMap[rowId], { installation_included: cb.checked });
                showSaveIndicator();
            }
        }

        function addFurnitureGroup(initialName, opts) {
            opts = opts || {};
            groupCounter++;
            const groupId = `group-${groupCounter}`;

            const group = document.createElement('div');
            group.className = 'furniture-group';
            group.id = groupId;

            group.innerHTML = `
                <div class="furniture-group-header">
                    <button class="btn-collapse" onclick="toggleGroup('${groupId}')" title="Réduire / Agrandir">&#9660;</button>
                    <span class="group-label">Meuble :</span>
                    <input type="text" class="furniture-name-input" id="${groupId}-name"
                           placeholder="ex: Cuisine, Salle de bain, Sous-sol..."
                           value="${escapeAttr(initialName || '')}">
                    <label class="install-toggle" title="Inclure l'installation">
                        <input type="checkbox" id="${groupId}-install" checked onchange="toggleInstallation('${groupId}')">
                        <span class="install-label">Installation</span>
                    </label>
                    <button class="btn-rentab" onclick="openRentab('group','${groupId}')">Rentabilit&eacute;</button>
                    <button class="btn-ai-focus" id="${groupId}-aiFocus" onclick="toggleAiFocus('${groupId}')" title="Cibler l'AI sur cette pi&egrave;ce"></button>
                    <button class="btn-remove-group" onclick="removeFurnitureGroup('${groupId}')">Supprimer</button>
                </div>
                <div class="client-description-section">
                    <label class="client-desc-label">Description client</label>
                    <div class="ai-field-wrap">
                        <div class="client-desc-display" id="${groupId}-clientDescDisplay" onclick="editClientDescription('${groupId}')"><span class="desc-placeholder">Description visible par le client...</span></div>
                        <textarea class="client-desc-textarea" id="${groupId}-clientDesc"
                                  placeholder="Description visible par le client pour cette pi&egrave;ce..."
                                  rows="2" style="display:none;"
                                  onblur="finishEditDescription('${groupId}')"></textarea>
                        <button class="btn-ai-dot" id="${groupId}-aiDesc" onclick="aiGenerateDescription('${groupId}')" title="G&eacute;n&eacute;rer ou am&eacute;liorer la description avec l'AI">
                            <span class="ai-dot"></span>
                        </button>
                        <button class="btn-assemble-desc" id="${groupId}-assembleDesc" onclick="onAssembleDescription('${groupId}')" title="Assembler la description &agrave; partir des articles">&#9889;</button>
                    </div>
                </div>
                <div class="room-dm-section" id="${groupId}-dmSection">
                    <div class="room-dm-label" onclick="toggleRoomDm('${groupId}')">
                        <span class="room-dm-arrow" id="${groupId}-dmArrow">&#9654;</span>
                        Mat&eacute;riaux par d&eacute;faut
                        <span class="room-dm-badge" id="${groupId}-dmBadge"></span>
                    </div>
                    <div class="room-dm-body collapsed" id="${groupId}-dmBody"></div>
                </div>
                <div class="calc-header">
                    <span></span>
                    <span class="col-center sortable" onclick="sortGroupRows('${groupId}','tag')">Tag<span class="sort-arrow">&#9650;</span></span>
                    <span class="sortable" onclick="sortGroupRows('${groupId}','article')">Article<span class="sort-arrow">&#9650;</span></span>
                    <span class="col-center">Code</span>
                    <span class="col-center">Type</span>
                    <span class="col-center">L&times;H&times;P</span>
                    <span class="col-right sortable" onclick="sortGroupRows('${groupId}','price')">Prix unit.<span class="sort-arrow">&#9650;</span></span>
                    <span class="col-center sortable" onclick="sortGroupRows('${groupId}','qty')">Quantit&eacute;<span class="sort-arrow">&#9650;</span></span>
                    <span class="col-center" title="Installation incluse">Inst.</span>
                    <span class="col-right sortable" onclick="sortGroupRows('${groupId}','total')">Total<span class="sort-arrow">&#9650;</span></span>
                    <span></span>
                </div>
                <div class="calc-rows" id="${groupId}-rows">
                    <div class="add-row-container">
                        <button class="btn-add" onclick="addRow('${groupId}')" title="Ajouter une ligne">+</button>
                        <span class="add-row-text">Ajouter un article</span>
                    </div>
                </div>
                <div class="group-subtotal-container" style="position:relative;">
                    <span class="group-subtotal-label">Sous-total</span>
                    <span class="group-subtotal-wrap">
                        <span class="group-subtotal-amount" id="${groupId}-subtotal">0,00 $</span>
                        <button class="btn-room-modifier" onclick="editRoomModifier('${groupId}')" title="Modificateur % pièce">%</button>
                    </span>
                </div>
                <div class="group-images-section">
                    <div class="group-images-header">Images / Photos</div>
                    <div class="image-drop-zone group-image-drop-zone" id="${groupId}-imgDrop">
                        <div class="image-drop-zone-text">
                            <strong>Ctrl+V</strong> pour coller &middot; <strong>glisser-d&eacute;poser</strong> &middot; ou <strong>cliquer</strong>
                        </div>
                    </div>
                    <input type="file" id="${groupId}-imgInput" accept="image/png,image/jpeg,image/webp,application/pdf" multiple style="display:none;">
                    <div class="image-previews" id="${groupId}-imgPreviews"></div>
                    <div class="image-count" id="${groupId}-imgCount"></div>
                </div>
            `;

            document.getElementById('furnitureGroups').appendChild(group);
            setupGroupImageHandlers(groupId);
            if (!groupImages[groupId]) groupImages[groupId] = [];

            // Persistance Supabase
            if (opts.existingId) {
                roomMap[groupId] = opts.existingId;
            } else if (currentSubmission && !opts.skipSave) {
                const sortOrder = document.querySelectorAll('.furniture-group').length;
                createRoom(currentSubmission.id, initialName || '', sortOrder).then(room => {
                    if (room) roomMap[groupId] = room.id;
                });
            }

            // Auto-save nom du meuble sur blur
            const nameInput = document.getElementById(`${groupId}-name`);
            nameInput.addEventListener('blur', function() {
                if (roomMap[groupId]) {
                    updateRoom(roomMap[groupId], { name: this.value });
                    showSaveIndicator();
                }
            });

            // Observe header for AI scope tracking
            if (aiScopeObserver) {
                var header = group.querySelector('.furniture-group-header');
                if (header) aiScopeObserver.observe(header);
            }

            return groupId;
        }

        async function removeFurnitureGroup(groupId) {
            if (!(await steleConfirm('Supprimer ce meuble et tous ses articles ?', 'Supprimer', 'Supprimer', true))) return;

            // Supprimer dans Supabase
            if (roomMap[groupId]) {
                deleteRoom(roomMap[groupId]);
                // Nettoyer les itemMap pour les rows de ce groupe
                const group = document.getElementById(groupId);
                if (group) {
                    group.querySelectorAll('.calc-row').forEach(row => {
                        delete itemMap[row.id];
                    });
                }
                delete roomMap[groupId];
            }
            delete groupImages[groupId];

            const group = document.getElementById(groupId);
            if (group) {
                // Unobserve header before removing
                if (aiScopeObserver) {
                    var header = group.querySelector('.furniture-group-header');
                    if (header) aiScopeObserver.unobserve(header);
                }
                group.remove();
                updateGrandTotal();
            }
        }

        function addRow(groupId, opts) {
            opts = opts || {};
            rowCounter++;
            const rowId = `row-${rowCounter}`;

            const row = document.createElement('div');
            row.className = 'calc-row' + (opts.cascade ? ' cascade-child' : '');
            row.id = rowId;
            row.dataset.mode = 'normal';
            row.dataset.group = groupId;
            row.innerHTML = `
                <div class="cell-add">
                    <button class="btn-add" onclick="addRow('${groupId}')" title="Ajouter une ligne">+</button>
                    <button class="btn-revert-cascade" onclick="revertCascadeLock('${rowId}')" title="Rétablir la cascade automatique">↩</button>
                </div>
                <div class="cell-tag">
                    <input type="text" id="${rowId}-tag" placeholder="—" maxlength="4" oninput="this.value=this.value.toUpperCase()" onblur="saveRowTag('${rowId}')">
                </div>
                <div class="cell-select">
                    <div class="combobox">
                        <input type="hidden" class="item-select" value="">
                        <input type="text" class="combobox-input" id="${rowId}-cb" placeholder="Rechercher un article..."
                               autocomplete="off" onclick="openCombobox('${rowId}')" onfocus="openCombobox('${rowId}')">
                        <button class="btn-edit-cat" id="${rowId}-edit-btn" onclick="openCatalogueItem('${rowId}')" title="Ouvrir dans le catalogue" style="display:none;">&#9998;</button>
                    </div>
                </div>
                <div class="cell-code" id="${rowId}-code">—</div>
                <div class="cell-type" id="${rowId}-type">—</div>
                <div class="cell-dims dims-hidden" id="${rowId}-dims">&mdash;</div>
                <div class="cell-unit-price" id="${rowId}-unit-price">—</div>
                <div class="cell-qty">
                    <input type="number" class="qty-input" id="${rowId}-qty" value="1" min="0" step="0.01" oninput="updateRow('${rowId}')" onchange="updateRow('${rowId}'); scheduleCascade('${rowId}', true)">
                </div>
                <div class="install-toggle-row">
                    <input type="checkbox" id="${rowId}-install" checked onchange="toggleRowInstallation('${rowId}')" title="Installation incluse">
                </div>
                <div class="cell-total" id="${rowId}-total">0,00 $</div>
                <div class="cell-remove">
                    <button class="btn-remove" onclick="removeRow('${rowId}')" title="Supprimer">×</button>
                </div>
            `;

            const container = document.getElementById(`${groupId}-rows`);
            const addContainer = container.querySelector('.add-row-container');

            // Cascade children: tag is inherited from parent (readonly)
            if (opts.cascade) {
                var tagEl = document.getElementById(rowId + '-tag');
                if (tagEl) tagEl.readOnly = true;
            }

            // Position cascade children directly after their parent (or after last sibling)
            if (opts.afterRowId) {
                var afterEl = document.getElementById(opts.afterRowId);
                if (afterEl && afterEl.parentNode === container) {
                    container.insertBefore(row, afterEl.nextSibling);
                } else {
                    container.insertBefore(row, addContainer);
                }
            } else {
                container.insertBefore(row, addContainer);
            }

            // ── Insertion animation (skip when loading existing data) ──
            if (!opts.existingId) {
                var staggerMs = (opts.staggerIndex || 0) * 50;
                row.style.opacity = '0';
                setTimeout(function() {
                    row.style.opacity = '';
                    row.classList.add('row-entering');
                    row.addEventListener('animationend', function handler() {
                        row.classList.remove('row-entering');
                        row.removeEventListener('animationend', handler);
                    }, { once: true });
                }, staggerMs);
            }

            // Persistance Supabase
            if (opts.existingId) {
                itemMap[rowId] = opts.existingId;
            } else if (currentSubmission && roomMap[groupId] && !opts.skipSave) {
                const sortOrder = container.querySelectorAll('.calc-row').length;
                createItem(roomMap[groupId], { sort_order: sortOrder }).then(item => {
                    if (item) itemMap[rowId] = item.id;
                });
            }

            if (!opts.skipFocus) { var cbFocus = document.getElementById(rowId + '-cb'); if (cbFocus) cbFocus.focus(); }
            return rowId;
        }

        function transformToAjoutMode(row, rowId) {
            row.dataset.mode = 'ajout';
            row.dataset.ajoutMode = 'fixed';
            row.style.background = '#edf0f5';

            var cd = _customItemDataMap[rowId] || {};
            var desc = cd.description || '';
            var supplierName = (cd.custom_data && cd.custom_data.supplier_name) || '';
            var cost = cd.unit_price || 0;
            var markup = cd.markup || 0;
            var sellPrice = cost * (1 + markup / 100);

            var codeEl = document.getElementById(rowId + '-code');
            var typeEl = document.getElementById(rowId + '-type');
            var unitPriceEl = document.getElementById(rowId + '-unit-price');

            codeEl.innerHTML = '<span style="font-size:11px;color:#64748b;cursor:pointer;" onclick="openCustomItemModal(\'' + rowId + '\')">' +
                escapeHtml(supplierName || 'Personnalis\u00e9') + '</span>';
            codeEl.style.gridColumn = 'span 1';

            typeEl.innerHTML = '<button class="ajout-edit-btn" onclick="openCustomItemModal(\'' + rowId + '\')" title="Modifier">' +
                escapeHtml(desc || 'Cliquer pour configurer...') + '</button>';

            unitPriceEl.textContent = formatPrice(sellPrice);
        }

        function transformToNormalMode(row, rowId) {
            row.dataset.mode = 'normal';
            delete row.dataset.ajoutMode;
            row.style.background = '';
            document.getElementById(rowId + '-code').innerHTML = '\u2014';
            document.getElementById(rowId + '-code').style.gridColumn = '';
            document.getElementById(rowId + '-type').innerHTML = '\u2014';
            document.getElementById(rowId + '-unit-price').innerHTML = '\u2014';
            document.getElementById(rowId + '-total').textContent = '0,00 $';
            delete _customItemDataMap[rowId];
        }

        function getRoomBaseSubtotal(groupEl) {
            var container = document.getElementById(groupEl.id + '-rows');
            if (!container) return 0;
            var total = 0;
            container.querySelectorAll('.calc-row').forEach(function(r) {
                total += getRowTotal(r);
            });
            return total;
        }

        // ═══════════════════════════════════════
        // ── Custom Item Modal (Ajout personnalisé) ──
        // ═══════════════════════════════════════

        function loadSupplierCompanies() {
            return authenticatedFetch(SUPABASE_URL + '/rest/v1/companies?company_type=eq.Fournisseurs&select=id,name&order=name', {})
                .then(function(r) { return r.ok ? r.json() : []; })
                .then(function(data) { SUPPLIER_COMPANIES = data; })
                .catch(function() {});
        }

        function openCustomItemModal(rowId) {
            _cimRowId = rowId;
            var cd = _customItemDataMap[rowId] || { description: '', unit_price: 0, markup: 30, custom_data: {} };
            var cData = cd.custom_data || {};

            // Populate supplier dropdown
            var sel = document.getElementById('cimSupplier');
            sel.innerHTML = '<option value="">\u2014 Aucun \u2014</option>';
            SUPPLIER_COMPANIES.forEach(function(c) {
                var opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = c.name;
                if (cData.supplier_id && cData.supplier_id === c.id) opt.selected = true;
                sel.appendChild(opt);
            });

            // Populate fields
            document.getElementById('cimDescription').value = cd.description || '';
            document.getElementById('cimCost').value = cd.unit_price || 0;
            document.getElementById('cimMarkup').value = cd.markup != null ? cd.markup : 30;
            document.getElementById('cimSupplierNotes').value = cData.supplier_notes || '';

            // Populate attachments
            _cimAttachments = (cData.attachments || []).map(function(a) {
                return { path: a.path, name: a.name, type: a.type, size: a.size, isNew: false };
            });
            _cimAttachmentsToDelete = [];
            renderCimFiles();

            updateCimSellPrice();
            document.getElementById('customItemModal').classList.add('active');

            // Setup drag & drop
            setupCimDragDrop();
        }

        function closeCustomItemModal() {
            document.getElementById('customItemModal').classList.remove('active');
            _cimRowId = null;
            _cimAttachments = [];
            _cimAttachmentsToDelete = [];
        }

        function updateCimSellPrice() {
            var cost = parseFloat(document.getElementById('cimCost').value) || 0;
            var markup = parseFloat(document.getElementById('cimMarkup').value) || 0;
            var sell = cost * (1 + markup / 100);
            document.getElementById('cimSellPrice').textContent = formatPrice(sell);
        }

        async function saveCustomItemModal() {
            if (!_cimRowId) return;
            var rowId = _cimRowId;

            var description = document.getElementById('cimDescription').value.trim();
            var cost = parseFloat(document.getElementById('cimCost').value) || 0;
            var markup = parseFloat(document.getElementById('cimMarkup').value) || 0;
            var supplierId = document.getElementById('cimSupplier').value || null;
            var supplierName = '';
            if (supplierId) {
                var found = SUPPLIER_COMPANIES.find(function(c) { return c.id === supplierId; });
                if (found) supplierName = found.name;
            }
            var supplierNotes = document.getElementById('cimSupplierNotes').value.trim();

            // Upload new files
            var itemId = itemMap[rowId];
            var uploadedAttachments = [];
            for (var i = 0; i < _cimAttachments.length; i++) {
                var att = _cimAttachments[i];
                if (att.isNew && att.file) {
                    var ts = Date.now() + '_' + i;
                    var storagePath = 'custom-attachments/' + itemId + '/' + ts + '_' + att.name.replace(/[^a-zA-Z0-9._-]/g, '_');
                    var uploadResp = await authenticatedFetch(
                        SUPABASE_URL + '/storage/v1/object/room-images/' + storagePath,
                        { method: 'POST', headers: { 'Content-Type': att.type || 'application/octet-stream', 'x-upsert': 'true' }, body: att.file }
                    );
                    if (uploadResp.ok) {
                        uploadedAttachments.push({ path: storagePath, name: att.name, type: att.type, size: att.size });
                    }
                } else if (!att.isNew) {
                    uploadedAttachments.push({ path: att.path, name: att.name, type: att.type, size: att.size });
                }
            }

            // Delete removed files
            for (var d = 0; d < _cimAttachmentsToDelete.length; d++) {
                await authenticatedFetch(
                    SUPABASE_URL + '/storage/v1/object/room-images/' + _cimAttachmentsToDelete[d],
                    { method: 'DELETE' }
                ).catch(function() {});
            }

            var customData = {
                supplier_id: supplierId,
                supplier_name: supplierName,
                supplier_notes: supplierNotes || null,
                attachments: uploadedAttachments
            };

            // Update in-memory map
            _customItemDataMap[rowId] = {
                description: description,
                unit_price: cost,
                markup: markup,
                custom_data: customData
            };

            // Save to DB
            if (itemId) {
                updateItem(itemId, {
                    item_type: 'custom',
                    catalogue_item_id: null,
                    description: description,
                    unit_price: cost,
                    markup: markup,
                    unit_type: '',
                    custom_data: customData
                });
                showSaveIndicator();
            }

            // Update row display
            var row = document.getElementById(rowId);
            if (row) {
                transformToAjoutMode(row, rowId);
                updateRow(rowId);
            }

            closeCustomItemModal();
        }

        // ── Drag & drop + file management ──

        function setupCimDragDrop() {
            var dropZone = document.getElementById('cimDropZone');
            var fileInput = document.getElementById('cimFileInput');

            // Remove old listeners by replacing node
            var newDrop = dropZone.cloneNode(true);
            dropZone.parentNode.replaceChild(newDrop, dropZone);

            newDrop.addEventListener('dragover', function(e) { e.preventDefault(); newDrop.classList.add('dragover'); });
            newDrop.addEventListener('dragleave', function() { newDrop.classList.remove('dragover'); });
            newDrop.addEventListener('drop', function(e) {
                e.preventDefault();
                newDrop.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) addCimFiles(e.dataTransfer.files);
            });

            var newInput = newDrop.querySelector('#cimFileInput');
            if (newInput) {
                newInput.addEventListener('change', function() {
                    if (this.files.length > 0) addCimFiles(this.files);
                    this.value = '';
                });
            }

            var link = newDrop.querySelector('a');
            if (link) {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    var fi = newDrop.querySelector('#cimFileInput');
                    if (fi) fi.click();
                });
            }
        }

        function addCimFiles(fileList) {
            for (var i = 0; i < fileList.length; i++) {
                var f = fileList[i];
                _cimAttachments.push({
                    path: null,
                    name: f.name,
                    type: f.type,
                    size: f.size,
                    isNew: true,
                    file: f
                });
            }
            renderCimFiles();
        }

        function removeCimFile(idx) {
            var att = _cimAttachments[idx];
            if (att && !att.isNew && att.path) {
                _cimAttachmentsToDelete.push(att.path);
            }
            _cimAttachments.splice(idx, 1);
            renderCimFiles();
        }

        function renderCimFiles() {
            var container = document.getElementById('cimFileList');
            container.innerHTML = '';
            _cimAttachments.forEach(function(att, idx) {
                var icon = (att.type || '').indexOf('pdf') >= 0 ? '\uD83D\uDCC4' : '\uD83D\uDDBC';
                var sizeStr = att.size ? (att.size < 1024 ? att.size + ' o' : (att.size / 1024).toFixed(0) + ' Ko') : '';
                var div = document.createElement('div');
                div.className = 'cim-file-item';
                div.innerHTML = '<span class="cim-file-icon">' + icon + '</span>' +
                    '<span class="cim-file-name">' + escapeHtml(att.name) + '</span>' +
                    '<span class="cim-file-size">' + sizeStr + '</span>' +
                    '<button class="cim-file-del" onclick="removeCimFile(' + idx + ')" title="Supprimer">&times;</button>';
                container.appendChild(div);
            });
        }

        let configCategories = [];

        async function loadConfigCategories() {
            try {
                const r = await authenticatedFetch(
                    SUPABASE_URL + '/rest/v1/app_config?key=eq.catalogue_categories&select=value', {}
                );
                if (r.ok) {
                    const rows = await r.json();
                    if (rows.length > 0 && Array.isArray(rows[0].value)) {
                        configCategories = rows[0].value;
                    }
                }
            } catch (e) { /* keep empty */ }
        }

        var tagPrefixes = [
            { prefix: 'C', label_fr: 'Caisson', label_en: 'Cabinet' },
            { prefix: 'F', label_fr: 'Filler', label_en: 'Filler' },
            { prefix: 'P', label_fr: 'Panneau', label_en: 'Panel' },
            { prefix: 'T', label_fr: 'Tiroir', label_en: 'Drawer' },
            { prefix: 'M', label_fr: 'Moulure', label_en: 'Moulding' },
            { prefix: 'A', label_fr: 'Accessoire', label_en: 'Accessory' }
        ];

        var materialGroups = ['Caisson', 'Fa\u00e7ades', 'Panneaux', 'Tiroirs', 'Poign\u00e9es', '\u00c9clairage', 'Autre'];
        var categoryGroupMapping = {};

        async function loadTauxAndExpenses() {
            try {
                const r = await authenticatedFetch(
                    SUPABASE_URL + '/rest/v1/app_config?key=in.(taux_horaires,expense_categories,tag_prefixes,material_groups,category_group_mapping)&select=key,value', {}
                );
                if (r.ok) {
                    const rows = await r.json();
                    rows.forEach(function(row) {
                        if (row.key === 'taux_horaires') tauxHoraires = row.value || [];
                        if (row.key === 'expense_categories') expenseCategories = row.value || [];
                        if (row.key === 'tag_prefixes') tagPrefixes = row.value || tagPrefixes;
                        if (row.key === 'material_groups' && Array.isArray(row.value) && row.value.length) materialGroups = row.value;
                        if (row.key === 'category_group_mapping' && row.value && typeof row.value === 'object') categoryGroupMapping = row.value;
                    });
                }
            } catch (e) { /* keep defaults */ }
        }

        async function loadPipelineConfig() {
            try {
                var r = await authenticatedFetch(
                    SUPABASE_URL + '/rest/v1/app_config?key=in.(pipeline_statuses,project_sources,project_types)&select=key,value', {}
                );
                if (r.ok) {
                    var rows = await r.json();
                    rows.forEach(function(row) {
                        if (row.key === 'pipeline_statuses') pipelineStatuses = row.value || [];
                        if (row.key === 'project_sources') projectSources = row.value || [];
                        if (row.key === 'project_types') projectTypes = row.value || [];
                    });
                }
            } catch (e) { /* keep empty */ }
            // Defaults if nothing loaded
            if (!pipelineStatuses.length) {
                pipelineStatuses = [
                    {slug:'a_contacter',label:'A contacter',color:'#9e9e9e',sort_order:1},
                    {slug:'en_attente_infos',label:'En attente d\'infos',color:'#ff9800',sort_order:2},
                    {slug:'a_soumissionner',label:'A soumissionner',color:'#2196f3',sort_order:3},
                    {slug:'en_revision',label:'En r\u00e9vision',color:'#9c27b0',sort_order:4},
                    {slug:'a_presenter',label:'A pr\u00e9senter',color:'#00bcd4',sort_order:5},
                    {slug:'envoye',label:'Envoy\u00e9',color:'#3f51b5',sort_order:6},
                    {slug:'en_discussions',label:'En discussions',color:'#ff5722',sort_order:7},
                    {slug:'vendu',label:'Vendu',color:'#4caf50',sort_order:8},
                    {slug:'perdu',label:'Perdu',color:'#f44336',sort_order:9}
                ];
            }
            if (!projectTypes.length) {
                projectTypes = ['R\u00e9sidentiel', 'R\u00e9sidentiel d\'envergure', 'Commercial', 'Collaboration', 'Autre'];
            }
        }

        // Calculer le prix composé d'un article catalogue
        function computeComposedPrice(item, includeInstallation) {
            var laborMinutes = item.labor_minutes || {};
            var materialCosts = item.material_costs || {};
            var hasComposed = false;

            // Main-d'œuvre
            var laborTotal = 0;
            for (var i = 0; i < tauxHoraires.length; i++) {
                var dept = tauxHoraires[i].department;
                var minutes = laborMinutes[dept] || 0;
                if (minutes > 0) {
                    hasComposed = true;
                    if (!includeInstallation && dept === 'Installation') continue;
                    laborTotal += (minutes / 60) * (tauxHoraires[i].taux_horaire || 0);
                }
            }

            // Matériaux
            var materialTotal = 0;
            for (var j = 0; j < expenseCategories.length; j++) {
                var cat = expenseCategories[j].name;
                var cost = materialCosts[cat] || 0;
                if (cost > 0) {
                    var markup = (expenseCategories[j].markup || 0) / 100;
                    var waste = (item.loss_override_pct != null ? item.loss_override_pct : (expenseCategories[j].waste || 0)) / 100;
                    materialTotal += cost * (1 + markup + waste);
                    hasComposed = true;
                }
            }

            if (!hasComposed) return null; // pas de prix composé → utiliser item.price
            return laborTotal + materialTotal;
        }

        function getCategories() {
            const cats = new Set();
            CATALOGUE_DATA.forEach(item => { if (item.category) cats.add(item.category); });
            configCategories.forEach(c => cats.add(c));
            return Array.from(cats).sort();
        }

        function generateNextCode(category) {
            const clean = (category || 'XXX').normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            const prefix = clean.substring(0, 3).toUpperCase();
            let maxNum = 0;
            CATALOGUE_DATA.forEach(item => {
                if (item.id && item.id.startsWith(prefix + '-')) {
                    const num = parseInt(item.id.split('-')[1]) || 0;
                    if (num > maxNum) maxNum = num;
                }
            });
            return prefix + '-' + String(maxNum + 1).padStart(3, '0');
        }

        function refreshAllSelects() {
            // Combobox reads from CATALOGUE_DATA live — no rebuild needed
            // Just sync all displays
            document.querySelectorAll('.calc-row').forEach(function(row) {
                syncComboboxDisplay(row.id);
            });
        }

        function updateRow(rowId) {
            const row = document.getElementById(rowId);
            const select = row.querySelector('.item-select');
            const qtyInput = row.querySelector('.qty-input');
            const totalEl = document.getElementById(`${rowId}-total`);

            const selectedId = select.value;
            const qty = parseFloat(qtyInput.value) || 0;
            const currentMode = row.dataset.mode;

            // Cascade : détecter changement d'article → reset enfants
            var prevCatId = row.dataset.lastCatalogueId || '';
            if (prevCatId && prevCatId !== selectedId && !_cascadeRunning) {
                findCascadeChildren(rowId).forEach(function(c) { removeRow(c.rowId); });
            }
            row.dataset.lastCatalogueId = selectedId;

            // Cascade lock: detect manual change on a cascade child
            if (cascadeParentMap[rowId] && prevCatId && prevCatId !== selectedId && !_cascadeRunning) {
                if (!row.classList.contains('cascade-locked')) {
                    row.dataset.cascadeOriginalTarget = prevCatId;
                }
                row.classList.add('cascade-locked');
                if (itemMap[rowId]) {
                    updateItem(itemMap[rowId], { cascade_locked: true });
                }
            }

            if (selectedId === '__PROPOSER__') {
                if (currentMode === 'ajout') transformToNormalMode(row, rowId);
                _catEditRowId = rowId;
                var overlay = document.getElementById('catEditOverlay');
                var iframe = document.getElementById('catEditIframe');
                iframe.src = 'catalogue_prix_stele_complet.html?new=1&embedded=1';
                overlay.classList.add('active');
            } else if (selectedId === '__AJOUT__') {
                if (currentMode !== 'ajout') {
                    transformToAjoutMode(row, rowId);
                    // Open modal immediately for new custom lines
                    setTimeout(function() { openCustomItemModal(rowId); }, 100);
                }
                var cd = _customItemDataMap[rowId] || {};
                var cost = cd.unit_price || 0;
                var markup = cd.markup || 0;
                var ajoutGroup = row.closest('.furniture-group');
                var ajoutMult = ajoutGroup ? getModifierMultiplier(ajoutGroup.id) : 1;
                totalEl.textContent = formatPrice(cost * (1 + markup / 100) * qty * ajoutMult);
            } else {
                if (currentMode === 'ajout') transformToNormalMode(row, rowId);
                const codeEl = document.getElementById(`${rowId}-code`);
                const typeEl = document.getElementById(`${rowId}-type`);
                const unitPriceEl = document.getElementById(`${rowId}-unit-price`);

                if (selectedId) {
                    const item = CATALOGUE_DATA.find(i => i.id === selectedId);
                    if (item) {
                        const tooltipImg = item.image_url ? `<img class="tooltip-img" src="${escapeAttr(item.image_url)}" alt="">` : '';
                        codeEl.innerHTML = `<span class="tooltip-container">${escapeHtml(item.id)}<div class="tooltip">${tooltipImg}<div class="tooltip-title">${escapeHtml(item.description)}</div><div class="tooltip-text">${escapeHtml(item.instruction || '')}</div></div></span>`;
                        typeEl.textContent = formatType(item.type);

                        // Prix composé si disponible, sinon prix catalogue
                        var installCb = document.getElementById(rowId + '-install');
                        var includeInstall = installCb ? installCb.checked : true;
                        var composedPrice = computeComposedPrice(item, includeInstall);
                        var effectivePrice = composedPrice !== null ? composedPrice : (item.price || 0);
                        var rowGroup = row.closest('.furniture-group');
                        var mult = rowGroup ? getModifierMultiplier(rowGroup.id) : 1;
                        unitPriceEl.textContent = formatPrice(effectivePrice * mult);
                        totalEl.textContent = formatPrice(effectivePrice * qty * mult);
                    }
                } else {
                    codeEl.textContent = '—';
                    typeEl.textContent = '—';
                    unitPriceEl.textContent = '—';
                    totalEl.textContent = '0,00 $';
                }
            }

            // Dimensions L×H×P — conditionnel sur item_type === 'fabrication' ou mode ajout
            var dimsEl = document.getElementById(rowId + '-dims');
            if (dimsEl) {
                var showDims = false;
                var dimItem = null;
                if (selectedId === '__AJOUT__') {
                    showDims = true;
                } else if (selectedId && selectedId !== '__PROPOSER__') {
                    dimItem = CATALOGUE_DATA.find(function(i) { return i.id === selectedId; });
                    if (dimItem && dimItem.item_type === 'fabrication') showDims = true;
                }

                if (showDims) {
                    if (dimsEl.classList.contains('dims-hidden')) {
                        dimsEl.classList.remove('dims-hidden');
                        var curL = dimsEl.dataset.l || '';
                        var curH = dimsEl.dataset.h || '';
                        var curP = dimsEl.dataset.p || '';

                        // Lire dims_config du catalogue (null → tout affiché par défaut)
                        var dc = (dimItem && dimItem.dims_config) ? dimItem.dims_config : { l: true, h: true, p: true };

                        var parts = [];
                        if (dc.l) parts.push('<input type="number" id="' + rowId + '-dim-l" placeholder="L" step="0.125" min="0" value="' + curL + '" oninput="updateRow(\'' + rowId + '\')" onchange="updateRow(\'' + rowId + '\'); scheduleCascade(\'' + rowId + '\', true)">');
                        if (dc.l && (dc.h || dc.p)) parts.push('<span class="dim-sep">\u00d7</span>');
                        if (dc.h) parts.push('<input type="number" id="' + rowId + '-dim-h" placeholder="H" step="0.125" min="0" value="' + curH + '" oninput="updateRow(\'' + rowId + '\')" onchange="updateRow(\'' + rowId + '\'); scheduleCascade(\'' + rowId + '\', true)">');
                        if (dc.h && dc.p) parts.push('<span class="dim-sep">\u00d7</span>');
                        if (dc.p) parts.push('<input type="number" id="' + rowId + '-dim-p" placeholder="P" step="0.125" min="0" value="' + curP + '" oninput="updateRow(\'' + rowId + '\')" onchange="updateRow(\'' + rowId + '\'); scheduleCascade(\'' + rowId + '\', true)">');

                        dimsEl.innerHTML = parts.join('');

                        // Caisson fields: Tab. + Part. — only for category "Caisson"
                        if (dimItem && dimItem.category && dimItem.category.toLowerCase() === 'caisson') {
                            var curTab = dimsEl.dataset.tab || '';
                            var curPart = dimsEl.dataset.part || '';
                            dimsEl.innerHTML += '<div class="caisson-sep"></div>'
                                + '<input type="number" class="caisson-input" id="' + rowId + '-n-tab" placeholder="Tab." step="1" min="0" value="' + curTab + '" oninput="updateRow(\'' + rowId + '\')" onchange="updateRow(\'' + rowId + '\'); scheduleCascade(\'' + rowId + '\', true)">'
                                + '<input type="number" class="caisson-input" id="' + rowId + '-n-part" placeholder="Part." step="1" min="0" value="' + curPart + '" oninput="updateRow(\'' + rowId + '\')" onchange="updateRow(\'' + rowId + '\'); scheduleCascade(\'' + rowId + '\', true)">';
                        }
                    }
                } else {
                    // Sauvegarder les valeurs dans dataset avant de détruire les inputs
                    var lInput = document.getElementById(rowId + '-dim-l');
                    if (lInput) {
                        dimsEl.dataset.l = lInput.value;
                    }
                    var hInput = document.getElementById(rowId + '-dim-h');
                    if (hInput) {
                        dimsEl.dataset.h = hInput.value;
                    }
                    var pInput = document.getElementById(rowId + '-dim-p');
                    if (pInput) {
                        dimsEl.dataset.p = pInput.value;
                    }
                    var tabInput = document.getElementById(rowId + '-n-tab');
                    if (tabInput) dimsEl.dataset.tab = tabInput.value;
                    var partInput = document.getElementById(rowId + '-n-part');
                    if (partInput) dimsEl.dataset.part = partInput.value;
                    dimsEl.classList.add('dims-hidden');
                    dimsEl.innerHTML = '\u2014';
                }
            }

            // Auto-quantité : si l'article a calculation_rule_ai.formula ou type pi²/linéaire
            if (selectedId && selectedId !== '__AJOUT__' && selectedId !== '__PROPOSER__') {
                var formulaItem = CATALOGUE_DATA.find(function(i) { return i.id === selectedId; });
                if (formulaItem && formulaItem.item_type === 'fabrication') {
                    var formula = formulaItem.calculation_rule_ai && formulaItem.calculation_rule_ai.formula;
                    // Fallback par type d'unité si pas de formule explicite
                    if (!formula && formulaItem.type === 'pi\u00b2') formula = 'L * H / 144';
                    if (!formula && formulaItem.type === 'lin\u00e9aire') formula = 'L / 12';
                    if (formula) {
                        var fL = document.getElementById(rowId + '-dim-l');
                        var fH = document.getElementById(rowId + '-dim-h');
                        var fP = document.getElementById(rowId + '-dim-p');
                        var fNTab = document.getElementById(rowId + '-n-tab');
                        var fNPart = document.getElementById(rowId + '-n-part');
                        var fVars = {
                            L: fL ? (parseFloat(fL.value) || 0) : 0,
                            H: fH ? (parseFloat(fH.value) || 0) : 0,
                            P: fP ? (parseFloat(fP.value) || 0) : 0,
                            QTY: 1,
                            n_tablettes: fNTab ? (parseInt(fNTab.value) || 0) : 0,
                            n_partitions: fNPart ? (parseInt(fNPart.value) || 0) : 0
                        };
                        if (fVars.L > 0 || fVars.H > 0 || fVars.P > 0) {
                            var autoQty = evalFormula(formula, fVars);
                            if (autoQty !== null && autoQty > 0) {
                                autoQty = Math.round(autoQty * 100) / 100;
                                if (parseFloat(qtyInput.value) !== autoQty) {
                                    qtyInput.value = autoQty;
                                    // Recalculate total with new qty
                                    var installCb2 = document.getElementById(rowId + '-install');
                                    var includeInstall2 = installCb2 ? installCb2.checked : true;
                                    var cp2 = computeComposedPrice(formulaItem, includeInstall2);
                                    var ep2 = cp2 !== null ? cp2 : (formulaItem.price || 0);
                                    var rg2 = row.closest('.furniture-group');
                                    var m2 = rg2 ? getModifierMultiplier(rg2.id) : 1;
                                    totalEl.textContent = formatPrice(ep2 * autoQty * m2);
                                }
                            }
                        }
                    }
                }
            }

            const groupId = row.dataset.group;
            if (groupId) updateGroupSubtotal(groupId);
            updateGrandTotal();

            // Sauvegarder dans Supabase (debounce)
            if (itemMap[rowId]) {
                debouncedSaveItem(rowId, row);
            }

            // Cascade : déclencher quand dimensions/qty changent ou article sélectionné
            if (!_cascadeRunning && selectedId && selectedId !== '__PROPOSER__' && selectedId !== '__AJOUT__') {
                var hasCascadeRules = false;
                var cascadeCatItem = CATALOGUE_DATA.find(function(i) { return i.id === selectedId; });
                if (cascadeCatItem && cascadeCatItem.calculation_rule_ai && cascadeCatItem.calculation_rule_ai.cascade) {
                    hasCascadeRules = true;
                }
                // Déclencher aussi pour les parents qui ont déjà des enfants
                if (hasCascadeRules || findCascadeChildren(rowId).length > 0) {
                    scheduleCascade(rowId);
                }
            }

            // Constraints : process auto_add etc. on first item selection
            if (selectedId && selectedId !== '__PROPOSER__' && selectedId !== '__AJOUT__') {
                processConstraints(rowId);
            }

            // Sync combobox display
            syncComboboxDisplay(rowId);
        }

        const debouncedSaveItem = debounce(function(rowId, row) {
            if (!itemMap[rowId]) return;
            const select = row.querySelector('.item-select');
            const qtyInput = row.querySelector('.qty-input');
            const selectedId = select ? select.value : '';
            const qty = parseFloat(qtyInput ? qtyInput.value : 0) || 0;

            let fields = { quantity: qty };

            if (selectedId === '__PROPOSER__') return;

            if (selectedId === '__AJOUT__') {
                var cd = _customItemDataMap[rowId] || {};
                fields.item_type = 'custom';
                fields.catalogue_item_id = null;
                fields.description = cd.description || '';
                fields.unit_price = cd.unit_price || 0;
                fields.markup = cd.markup || 0;
                fields.unit_type = '';
                fields.custom_data = cd.custom_data || null;
            } else if (selectedId) {
                const item = CATALOGUE_DATA.find(i => i.id === selectedId);
                if (item) {
                    var installCb = document.getElementById(rowId + '-install');
                    var includeInstall = installCb ? installCb.checked : true;
                    var composed = computeComposedPrice(item, includeInstall);
                    fields.item_type = 'catalogue';
                    fields.catalogue_item_id = item.id;
                    fields.description = item.description;
                    fields.unit_type = item.type || '';
                    fields.unit_price = composed !== null ? composed : (item.price || 0);
                    fields.markup = 0;
                }
            } else {
                // Pas de sélection, on sauvegarde quand même la quantité
                fields.item_type = 'catalogue';
                fields.catalogue_item_id = null;
                fields.description = '';
                fields.unit_price = 0;
                fields.markup = 0;
            }

            // Include tag
            var tagInput = document.getElementById(rowId + '-tag');
            if (tagInput) fields.tag = tagInput.value.trim() || null;

            // Dimensions L/H/P
            var dimL = document.getElementById(rowId + '-dim-l');
            var dimH = document.getElementById(rowId + '-dim-h');
            var dimP = document.getElementById(rowId + '-dim-p');
            fields.length_in = dimL ? (parseFloat(dimL.value) || null) : null;
            fields.height_in = dimH ? (parseFloat(dimH.value) || null) : null;
            fields.depth_in = dimP ? (parseFloat(dimP.value) || null) : null;

            // Caisson fields
            var nTab = document.getElementById(rowId + '-n-tab');
            var nPart = document.getElementById(rowId + '-n-part');
            fields.n_tablettes = nTab ? (parseInt(nTab.value) || 0) : 0;
            fields.n_partitions = nPart ? (parseInt(nPart.value) || 0) : 0;

            updateItem(itemMap[rowId], fields);
            showSaveIndicator();
        }, 500);

        function saveRowTag(rowId) {
            if (!itemMap[rowId]) return;
            var tagInput = document.getElementById(rowId + '-tag');
            var tag = tagInput ? tagInput.value.trim().toUpperCase() : null;
            updateItem(itemMap[rowId], { tag: tag || null });
            showSaveIndicator();
            refreshTagFilterBar();
            // Propagate tag to all cascade children (including locked)
            findCascadeChildren(rowId).forEach(function(c) {
                var childTagEl = document.getElementById(c.rowId + '-tag');
                if (childTagEl) {
                    childTagEl.value = tag || '';
                    if (itemMap[c.rowId]) updateItem(itemMap[c.rowId], { tag: tag || null });
                }
            });
        }

        function removeRow(rowId) {
            // Supprimer d'abord les enfants cascade (récursif)
            var cascadeChildren = findCascadeChildren(rowId);
            cascadeChildren.forEach(function(c) { removeRow(c.rowId); });

            const row = document.getElementById(rowId);
            if (row) {
                const groupId = row.dataset.group;
                // Supprimer dans Supabase
                if (itemMap[rowId]) {
                    deleteItem(itemMap[rowId]);
                    delete itemMap[rowId];
                }
                row.remove();
                delete cascadeParentMap[rowId];
                delete _customItemDataMap[rowId];
                if (groupId) updateGroupSubtotal(groupId);
                updateGrandTotal();
            }
        }

        function getRowTotal(row) {
            const select = row.querySelector('.item-select');
            const qtyInput = row.querySelector('.qty-input');
            if (!select || !qtyInput) return 0;
            const selectedId = select.value;
            const qty = parseFloat(qtyInput.value) || 0;

            if (selectedId === '__PROPOSER__') {
                return 0;
            } else if (selectedId === '__AJOUT__') {
                var cd = _customItemDataMap[row.id] || {};
                var ajCost = cd.unit_price || 0;
                var ajMarkup = cd.markup || 0;
                return ajCost * (1 + ajMarkup / 100) * qty;
            } else if (selectedId) {
                const item = CATALOGUE_DATA.find(i => i.id === selectedId);
                if (item) {
                    var installCb = document.getElementById(row.id + '-install');
                    var includeInstall = installCb ? installCb.checked : true;
                    var composed = computeComposedPrice(item, includeInstall);
                    var eff = composed !== null ? composed : (item.price || 0);
                    return eff * qty;
                }
            }
            return 0;
        }

        function updateGroupSubtotal(groupId) {
            let subtotal = 0;
            const container = document.getElementById(`${groupId}-rows`);
            if (!container) return;
            var mult = getModifierMultiplier(groupId);
            container.querySelectorAll('.calc-row').forEach(row => { subtotal += getRowTotal(row); });
            var hasModifier = roomModifiers[groupId] || ((currentSubmission && currentSubmission.global_price_modifier_pct) || 0);
            if (hasModifier) {
                applyRoomModifierDisplay(groupId);
            } else {
                const subtotalEl = document.getElementById(`${groupId}-subtotal`);
                if (subtotalEl) animateValue(subtotalEl, subtotal, 'price');
            }
        }

        // ── Room & global modifier functions ──
        // Modifiers are percentages applied multiplicatively:
        // Displayed per line: unit_price × mult, total × mult
        // Room subtotal = Σ base_lines × mult
        // effective_line = base_line × (1 + global_mod/100) × (1 + room_mod/100)
        // Room subtotal = Σ effective_lines
        // Grand total = subtotal_before_discount − discount

        function getModifierMultiplier(groupId) {
            var globalPct = (currentSubmission && currentSubmission.global_price_modifier_pct) || 0;
            var roomPct = roomModifiers[groupId] || 0;
            return (1 + globalPct / 100) * (1 + roomPct / 100);
        }

        function getRoomCalculatedSubtotal(groupId) {
            var subtotal = 0;
            var container = document.getElementById(groupId + '-rows');
            if (!container) return 0;
            container.querySelectorAll('.calc-row').forEach(function(row) { subtotal += getRowTotal(row); });
            return Math.round(subtotal * 100) / 100;
        }

        function getEffectiveRoomTotal(groupId) {
            var base = getRoomCalculatedSubtotal(groupId);
            return Math.round(base * getModifierMultiplier(groupId) * 100) / 100;
        }

        function refreshGroupRows(groupId) {
            var container = document.getElementById(groupId + '-rows');
            if (!container) return;
            container.querySelectorAll('.calc-row').forEach(function(row) { updateRow(row.id); });
            updateGroupSubtotal(groupId);
        }

        function refreshAllRowsAndSubtotals() {
            document.querySelectorAll('.furniture-group').forEach(function(g) { refreshGroupRows(g.id); });
        }

        // ── Room modifier UI ──

        function editRoomModifier(groupId) {
            if (currentSubmission && !isSubmissionCurrentlyEditable()) return;
            var container = document.querySelector('#' + groupId + ' .group-subtotal-container');
            if (!container) return;
            var wrap = container.querySelector('.group-subtotal-wrap');
            if (!wrap) return;
            var currentPct = roomModifiers[groupId] || 0;
            var subtotalEl = document.getElementById(groupId + '-subtotal');
            var subtotalHtml = subtotalEl ? subtotalEl.outerHTML : '';
            wrap.innerHTML = subtotalHtml +
                '<input class="room-modifier-input" id="' + groupId + '-modInput" type="text" value="' + (currentPct || '') + '" placeholder="0">' +
                '<span style="font-size:12px;color:#1565C0;font-weight:600;">%</span>' +
                '<button class="btn-room-modifier active" onclick="saveRoomModifier(\'' + groupId + '\')" title="Confirmer">&#10003;</button>' +
                '<button class="btn-room-modifier" onclick="cancelRoomModifier(\'' + groupId + '\')" title="Annuler">&times;</button>';
            var input = document.getElementById(groupId + '-modInput');
            input.focus();
            input.select();
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') saveRoomModifier(groupId);
                if (e.key === 'Escape') cancelRoomModifier(groupId);
            });
        }

        async function saveRoomModifier(groupId) {
            var input = document.getElementById(groupId + '-modInput');
            if (!input) return;
            var val = parseFloat(input.value.replace(',', '.'));
            if (isNaN(val)) val = 0;
            roomModifiers[groupId] = val;
            refreshGroupRows(groupId);
            updateGrandTotal();
            if (roomMap[groupId]) {
                await updateRoom(roomMap[groupId], { price_modifier_pct: val || null });
                showSaveIndicator();
            }
        }

        function cancelRoomModifier(groupId) {
            applyRoomModifierDisplay(groupId);
        }

        function applyRoomModifierDisplay(groupId) {
            var container = document.querySelector('#' + groupId + ' .group-subtotal-container');
            if (!container) return;
            var wrap = container.querySelector('.group-subtotal-wrap');
            if (!wrap) return;
            var base = getRoomCalculatedSubtotal(groupId);
            var roomPct = roomModifiers[groupId] || 0;
            var globalPct = (currentSubmission && currentSubmission.global_price_modifier_pct) || 0;
            var effective = getEffectiveRoomTotal(groupId);
            var editable = isSubmissionCurrentlyEditable();
            if (roomPct !== 0) {
                var sign = roomPct > 0 ? '+' : '';
                var tooltipParts = 'Base : ' + formatPrice(base);
                if (globalPct) tooltipParts += ' \u00d7 global ' + (globalPct > 0 ? '+' : '') + globalPct + '%';
                tooltipParts += ' \u00d7 pi\u00e8ce ' + sign + roomPct + '% = ' + formatPrice(effective);
                wrap.innerHTML =
                    '<span class="group-subtotal-amount" id="' + groupId + '-subtotal">' + formatPrice(effective) + '</span>' +
                    '<span class="room-modifier-badge">' + sign + roomPct + '%</span>' +
                    (editable ? '<button class="btn-room-modifier active" onclick="editRoomModifier(\'' + groupId + '\')" title="Modifier le %">&#9998;</button>' : '') +
                    (editable ? '<button class="btn-room-modifier" onclick="removeRoomModifier(\'' + groupId + '\')" title="Retirer le modificateur">&times;</button>' : '') +
                    '<span class="room-modifier-tooltip">' + tooltipParts + '</span>';
            } else {
                // No room modifier, but might have global modifier
                wrap.innerHTML =
                    '<span class="group-subtotal-amount" id="' + groupId + '-subtotal">' + formatPrice(effective) + '</span>' +
                    (editable ? '<button class="btn-room-modifier" onclick="editRoomModifier(\'' + groupId + '\')" title="Modificateur % pi\u00e8ce">%</button>' : '');
            }
        }

        async function removeRoomModifier(groupId) {
            roomModifiers[groupId] = 0;
            refreshGroupRows(groupId);
            updateGrandTotal();
            if (roomMap[groupId]) {
                await updateRoom(roomMap[groupId], { price_modifier_pct: null });
                showSaveIndicator();
            }
        }

        // ── Discount functions ──

        function applySubmissionDiscount(subtotal) {
            if (!currentSubmission) return subtotal;
            var t = currentSubmission.discount_type, v = currentSubmission.discount_value;
            if (!t || !v || v <= 0) return subtotal;
            return t === 'percentage' ? subtotal * (1 - v / 100) : subtotal - v;
        }

        function getDiscountAmount(subtotal) {
            if (!currentSubmission) return 0;
            var t = currentSubmission.discount_type, v = currentSubmission.discount_value;
            if (!t || !v || v <= 0) return 0;
            return t === 'percentage' ? subtotal * v / 100 : v;
        }

        function updateDiscountDisplay() {
            var discountRow = document.getElementById('discountRow');
            var addBtn = document.getElementById('addDiscountBtn');
            var editable = isSubmissionCurrentlyEditable();
            if (!currentSubmission || !currentSubmission.discount_type || !currentSubmission.discount_value || currentSubmission.discount_value <= 0) {
                if (discountRow) discountRow.style.display = 'none';
                if (addBtn) addBtn.style.display = editable ? '' : 'none';
                return;
            }
            if (addBtn) addBtn.style.display = 'none';
            if (discountRow) discountRow.style.display = 'flex';
            var subtotal = calculerSubtotalBeforeDiscount();
            var discountAmt = getDiscountAmount(subtotal);
            var label = currentSubmission.discount_type === 'percentage'
                ? 'Rabais (' + currentSubmission.discount_value + '%)'
                : 'Rabais';
            var labelEl = discountRow.querySelector('.discount-label');
            if (labelEl) labelEl.textContent = label;
            var amtEl = document.getElementById('discountDisplay');
            if (amtEl) amtEl.textContent = '- ' + formatPrice(discountAmt);
            // Hide edit buttons if not editable
            discountRow.querySelectorAll('.discount-toggle-btn').forEach(function(btn) {
                btn.style.display = editable ? '' : 'none';
            });
        }

        function editDiscount() {
            if (currentSubmission && !isSubmissionCurrentlyEditable()) return;
            var discountRow = document.getElementById('discountRow');
            var addBtn = document.getElementById('addDiscountBtn');
            if (addBtn) addBtn.style.display = 'none';
            discountRow.style.display = 'flex';
            var currentType = (currentSubmission && currentSubmission.discount_type) || 'percentage';
            var currentVal = (currentSubmission && currentSubmission.discount_value) || '';
            discountRow.innerHTML =
                '<span class="discount-label">Rabais</span>' +
                '<div style="display:flex;align-items:center;gap:8px;">' +
                '<input class="discount-input" id="discountInput" type="text" value="' + (currentVal || '') + '" placeholder="0">' +
                '<select class="discount-type-select" id="discountTypeSelect">' +
                '<option value="percentage"' + (currentType === 'percentage' ? ' selected' : '') + '>%</option>' +
                '<option value="fixed"' + (currentType === 'fixed' ? ' selected' : '') + '>$</option>' +
                '</select>' +
                '</div>' +
                '<button class="discount-toggle-btn" onclick="saveDiscount()" title="Confirmer">&#10003;</button>' +
                '<button class="discount-toggle-btn" onclick="cancelDiscountEdit()" title="Annuler">&times;</button>';
            var input = document.getElementById('discountInput');
            input.focus();
            input.select();
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') saveDiscount();
                if (e.key === 'Escape') cancelDiscountEdit();
            });
        }

        async function saveDiscount() {
            var input = document.getElementById('discountInput');
            var select = document.getElementById('discountTypeSelect');
            if (!input || !select) return;
            var val = parseFloat(input.value.replace(',', '.'));
            if (isNaN(val) || val <= 0) { removeDiscount(); return; }
            var dtype = select.value;
            currentSubmission.discount_type = dtype;
            currentSubmission.discount_value = val;
            rebuildDiscountRow();
            updateDiscountDisplay();
            updateGrandTotal();
            await updateSubmission(currentSubmission.id, { discount_type: dtype, discount_value: val });
            showSaveIndicator();
        }

        async function removeDiscount() {
            if (!currentSubmission) return;
            currentSubmission.discount_type = null;
            currentSubmission.discount_value = null;
            rebuildDiscountRow();
            updateDiscountDisplay();
            updateGrandTotal();
            await updateSubmission(currentSubmission.id, { discount_type: null, discount_value: null });
            showSaveIndicator();
        }

        function cancelDiscountEdit() {
            rebuildDiscountRow();
            updateDiscountDisplay();
        }

        function rebuildDiscountRow() {
            var discountRow = document.getElementById('discountRow');
            if (!discountRow) return;
            discountRow.innerHTML =
                '<span class="discount-label">Rabais</span>' +
                '<span class="discount-amount" id="discountDisplay"></span>' +
                '<button class="discount-toggle-btn" onclick="editDiscount()" title="Modifier le rabais">&#9998;</button>' +
                '<button class="discount-toggle-btn" onclick="removeDiscount()" title="Retirer le rabais">&times;</button>';
        }

        // ── Global modifier functions ──

        function updateGlobalModifierDisplay() {
            var row = document.getElementById('globalModifierRow');
            var addBtn = document.getElementById('addGlobalModifierBtn');
            var editable = isSubmissionCurrentlyEditable();
            var pct = (currentSubmission && currentSubmission.global_price_modifier_pct) || 0;
            if (!pct) {
                if (row) row.style.display = 'none';
                if (addBtn) addBtn.style.display = editable ? '' : 'none';
                return;
            }
            if (addBtn) addBtn.style.display = 'none';
            if (row) {
                row.style.display = 'flex';
                var sign = pct > 0 ? '+' : '';
                var badge = document.getElementById('globalModifierDisplay');
                if (badge) badge.textContent = sign + pct + '%';
                row.querySelectorAll('.discount-toggle-btn').forEach(function(btn) {
                    btn.style.display = editable ? '' : 'none';
                });
            }
        }

        function editGlobalModifier() {
            if (currentSubmission && !isSubmissionCurrentlyEditable()) return;
            var row = document.getElementById('globalModifierRow');
            var addBtn = document.getElementById('addGlobalModifierBtn');
            if (addBtn) addBtn.style.display = 'none';
            row.style.display = 'flex';
            var currentPct = (currentSubmission && currentSubmission.global_price_modifier_pct) || '';
            row.innerHTML =
                '<span class="global-modifier-label">Modificateur global</span>' +
                '<div style="display:flex;align-items:center;gap:6px;">' +
                '<input class="global-modifier-input" id="globalModInput" type="text" value="' + (currentPct || '') + '" placeholder="0">' +
                '<span style="font-size:13px;color:#42A5F5;font-weight:600;">%</span>' +
                '</div>' +
                '<button class="discount-toggle-btn" onclick="saveGlobalModifier()" title="Confirmer">&#10003;</button>' +
                '<button class="discount-toggle-btn" onclick="cancelGlobalModifier()" title="Annuler">&times;</button>';
            var input = document.getElementById('globalModInput');
            input.focus();
            input.select();
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') saveGlobalModifier();
                if (e.key === 'Escape') cancelGlobalModifier();
            });
        }

        async function saveGlobalModifier() {
            var input = document.getElementById('globalModInput');
            if (!input) return;
            var val = parseFloat(input.value.replace(',', '.'));
            if (isNaN(val)) val = 0;
            if (!currentSubmission) return;
            currentSubmission.global_price_modifier_pct = val || null;
            rebuildGlobalModifierRow();
            updateGlobalModifierDisplay();
            refreshAllRowsAndSubtotals();
            updateGrandTotal();
            await updateSubmission(currentSubmission.id, { global_price_modifier_pct: val || null });
            showSaveIndicator();
        }

        async function removeGlobalModifier() {
            if (!currentSubmission) return;
            currentSubmission.global_price_modifier_pct = null;
            rebuildGlobalModifierRow();
            updateGlobalModifierDisplay();
            refreshAllRowsAndSubtotals();
            updateGrandTotal();
            await updateSubmission(currentSubmission.id, { global_price_modifier_pct: null });
            showSaveIndicator();
        }

        function cancelGlobalModifier() {
            rebuildGlobalModifierRow();
            updateGlobalModifierDisplay();
        }

        function rebuildGlobalModifierRow() {
            var row = document.getElementById('globalModifierRow');
            if (!row) return;
            row.innerHTML =
                '<span class="global-modifier-label">Modificateur global</span>' +
                '<span class="global-modifier-badge" id="globalModifierDisplay"></span>' +
                '<button class="discount-toggle-btn" onclick="editGlobalModifier()" title="Modifier">&#9998;</button>' +
                '<button class="discount-toggle-btn" onclick="removeGlobalModifier()" title="Retirer">&times;</button>';
        }

        // ── Grand total with modifiers + discount ──

        function calculerSubtotalBeforeDiscount() {
            let total = 0;
            document.querySelectorAll('.furniture-group').forEach(function(g) { total += getEffectiveRoomTotal(g.id); });
            return Math.round(total * 100) / 100;
        }

        function updateGrandTotal() {
            var total = calculerGrandTotal();
            var grandEl = document.getElementById('grandTotal');
            if (grandEl) animateValue(grandEl, total, 'price');
            var headerEl = document.getElementById('headerTotal');
            if (headerEl) animateValue(headerEl, total, 'currency');
            updateGlobalModifierDisplay();
            updateDiscountDisplay();
        }

        function calculerGrandTotal() {
            return Math.round(applySubmissionDiscount(calculerSubtotalBeforeDiscount()) * 100) / 100;
        }

        function updateHeaderTotal() {
            var el = document.getElementById('headerTotal');
            if (!el) return;
            var total = calculerGrandTotal();
            el.textContent = total.toLocaleString('fr-CA', { style: 'currency', currency: 'CAD' });
        }

        // ── Animated value interpolation ──
        function _formatAnimPrice(val) {
            // Always format as currency during animation (bypass formatPrice % detection)
            return val.toLocaleString('fr-CA', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' $';
        }
        function animateValue(el, targetVal, mode) {
            // Parse current displayed value — handle fr-CA formatting (spaces, commas)
            var currentText = el.textContent.replace(/[^0-9.,-]/g, '').replace(/\u00a0/g, '').replace(',', '.');
            var fromVal = parseFloat(currentText) || 0;
            targetVal = Math.round(targetVal * 100) / 100;
            if (Math.abs(fromVal - targetVal) < 0.01) {
                if (mode === 'currency') el.textContent = targetVal.toLocaleString('fr-CA', { style: 'currency', currency: 'CAD' });
                else el.textContent = formatPrice(targetVal);
                return;
            }
            if (el._animId) cancelAnimationFrame(el._animId);
            var duration = 500;
            var start = performance.now();
            function tick(now) {
                var t = Math.min((now - start) / duration, 1);
                var ease = 1 - Math.pow(1 - t, 3);
                var val = fromVal + (targetVal - fromVal) * ease;
                if (t >= 1) {
                    // Final frame — use canonical formatters
                    if (mode === 'currency') el.textContent = targetVal.toLocaleString('fr-CA', { style: 'currency', currency: 'CAD' });
                    else el.textContent = formatPrice(targetVal);
                    el._animId = null;
                } else {
                    // Intermediate — always format as dollar amount
                    if (mode === 'currency') el.textContent = val.toLocaleString('fr-CA', { style: 'currency', currency: 'CAD' });
                    else el.textContent = _formatAnimPrice(val);
                    el._animId = requestAnimationFrame(tick);
                }
            }
            el._animId = requestAnimationFrame(tick);
        }

        // ── Pulse on totals after batch insert ──
        function pulseTotals() {
            ['grandTotal', 'headerTotal'].forEach(function(id) {
                var el = document.getElementById(id);
                if (!el) return;
                el.classList.remove('total-pulse');
                void el.offsetWidth; // force reflow to restart animation
                el.classList.add('total-pulse');
                el.addEventListener('animationend', function handler() {
                    el.classList.remove('total-pulse');
                    el.removeEventListener('animationend', handler);
                }, { once: true });
            });
        }

        // ═══════════════════════════════════════════════════════════════════════
        // TAG FILTER — SHOW/HIDE ROWS BY TAG PREFIX
        // ═══════════════════════════════════════════════════════════════════════

        var activeTagFilter = null; // null = show all

        function refreshTagFilterBar() {
            var bar = document.getElementById('tagFilterBar');
            if (!bar) return;
            // Collect all unique tags and prefixes in use
            var usedPrefixes = {};
            var usedTags = {};
            document.querySelectorAll('.calc-row').forEach(function(row) {
                var tagInput = row.querySelector('.cell-tag input');
                if (tagInput && tagInput.value.trim()) {
                    var tag = tagInput.value.trim().toUpperCase();
                    var prefix = tag.replace(/[0-9]/g, '');
                    if (prefix) {
                        usedPrefixes[prefix] = true;
                        usedTags[tag] = prefix;
                    }
                }
            });
            var prefixList = Object.keys(usedPrefixes).sort();
            if (prefixList.length === 0) {
                bar.style.display = 'none';
                return;
            }
            bar.style.display = 'flex';
            var isExactFilter = activeTagFilter && /[0-9]/.test(activeTagFilter);
            var activePrefixFromExact = isExactFilter ? activeTagFilter.replace(/[0-9]/g, '') : null;

            // Rebuild chips
            var html = '<span class="tag-filter-label">Filtrer :</span>';
            html += '<span class="tag-filter-chip chip-all' + (activeTagFilter === null ? ' active' : '') + '" onclick="filterByTag(null)">Tous</span>';
            prefixList.forEach(function(p) {
                var tp = (tagPrefixes || []).find(function(t) { return t.prefix === p; });
                var label = tp ? p + ' ' + tp.label_fr : p;
                var isActivePrefix = activeTagFilter === p || activePrefixFromExact === p;
                html += '<span class="tag-filter-chip' + (isActivePrefix ? ' active' : '') + '" onclick="filterByTag(\'' + escapeAttr(p) + '\')">' + escapeHtml(label) + '</span>';
            });

            // Show granular tags for the active prefix
            var activePrefix = activeTagFilter ? activeTagFilter.replace(/[0-9]/g, '') : null;
            if (activePrefix && usedPrefixes[activePrefix]) {
                var tagsForPrefix = Object.keys(usedTags).filter(function(t) { return usedTags[t] === activePrefix; }).sort(function(a, b) {
                    return a.localeCompare(b, 'fr', { numeric: true });
                });
                if (tagsForPrefix.length > 1) {
                    html += '<span style="color:#ccc;margin:0 2px;">|</span>';
                    tagsForPrefix.forEach(function(tag) {
                        html += '<span class="tag-filter-chip' + (activeTagFilter === tag ? ' active' : '') + '" onclick="filterByTag(\'' + escapeAttr(tag) + '\')" style="font-size:10px;padding:3px 8px;">' + escapeHtml(tag) + '</span>';
                    });
                }
            }
            bar.innerHTML = html;
        }

        function filterByTag(value) {
            // value = null (all), "C" (prefix), or "C1" (exact tag)
            activeTagFilter = value;
            document.querySelectorAll('.calc-row').forEach(function(row) {
                if (value === null) {
                    row.classList.remove('tag-hidden');
                    return;
                }
                var tagInput = row.querySelector('.cell-tag input');
                var tag = tagInput ? tagInput.value.trim().toUpperCase() : '';
                var rowPrefix = tag.replace(/[0-9]/g, '');
                // Check exact match (C1) or prefix match (C)
                var isExact = /[0-9]/.test(value);
                if (isExact) {
                    row.classList.toggle('tag-hidden', tag !== value);
                } else {
                    row.classList.toggle('tag-hidden', !tag || rowPrefix !== value);
                }
            });
            // Auto-sort visible rows by tag within each group
            if (value !== null) {
                document.querySelectorAll('.furniture-group').forEach(function(group) {
                    var container = group.querySelector('.calc-rows');
                    if (!container) return;
                    var rows = Array.from(container.querySelectorAll('.calc-row'));
                    var addRowBtn = container.querySelector('.add-row-container');
                    rows.sort(function(a, b) {
                        var ta = getRowSortValue(a, 'tag');
                        var tb = getRowSortValue(b, 'tag');
                        return String(ta).localeCompare(String(tb), 'fr', { numeric: true });
                    });
                    rows.forEach(function(row) { container.insertBefore(row, addRowBtn); });
                });
            }
            refreshTagFilterBar();
        }

        // ═══════════════════════════════════════════════════════════════════════
        // SORT ROWS IN GROUP
        // ═══════════════════════════════════════════════════════════════════════

        var sortState = {}; // { groupId: { col: 'tag', dir: 'asc' } }

        function sortGroupRows(groupId, col) {
            var prev = sortState[groupId] || {};
            var dir = (prev.col === col && prev.dir === 'asc') ? 'desc' : 'asc';
            sortState[groupId] = { col: col, dir: dir };

            var container = document.getElementById(groupId + '-rows');
            if (!container) return;
            var rows = Array.from(container.querySelectorAll('.calc-row'));
            var addRowBtn = container.querySelector('.add-row-container');

            rows.sort(function(a, b) {
                var va = getRowSortValue(a, col);
                var vb = getRowSortValue(b, col);
                var cmp;
                if (typeof va === 'number' && typeof vb === 'number') {
                    cmp = va - vb;
                } else {
                    cmp = String(va).localeCompare(String(vb), 'fr', { numeric: true });
                }
                return dir === 'desc' ? -cmp : cmp;
            });

            // Re-append in sorted order
            rows.forEach(function(row) { container.insertBefore(row, addRowBtn); });

            // Update sort arrows in the header
            var header = container.parentElement.querySelector('.calc-header');
            if (header) {
                header.querySelectorAll('.sortable').forEach(function(span) {
                    span.classList.remove('sort-active');
                    var arrow = span.querySelector('.sort-arrow');
                    if (arrow) arrow.innerHTML = '&#9650;';
                });
                // Find the clicked column's span
                var colMap = { tag: 1, article: 2, price: 5, qty: 6, total: 8 };
                var idx = colMap[col];
                if (idx !== undefined) {
                    var target = header.querySelectorAll('span')[idx];
                    if (target) {
                        target.classList.add('sort-active');
                        var arrow = target.querySelector('.sort-arrow');
                        if (arrow) arrow.innerHTML = dir === 'asc' ? '&#9650;' : '&#9660;';
                    }
                }
            }
        }

        function getRowSortValue(row, col) {
            if (col === 'tag') {
                var tagInput = row.querySelector('.cell-tag input');
                return tagInput ? tagInput.value.trim().toUpperCase() : '';
            }
            if (col === 'article') {
                var select = row.querySelector('.item-select');
                if (!select) return '';
                var opt = select.options[select.selectedIndex];
                return opt ? opt.textContent.trim() : '';
            }
            if (col === 'price') {
                var priceSpan = row.querySelector('[id$="-unit-price"]');
                if (priceSpan) return parseFloat(priceSpan.textContent.replace(/[^\d.,-]/g, '').replace(',', '.')) || 0;
                // Fallback for custom items: read from in-memory data
                var cdSort = _customItemDataMap[row.id];
                if (cdSort) return (cdSort.unit_price || 0) * (1 + (cdSort.markup || 0) / 100);
                return 0;
            }
            if (col === 'qty') {
                var qtyInput = row.querySelector('.qty-input');
                return qtyInput ? (parseFloat(qtyInput.value) || 0) : 0;
            }
            if (col === 'total') {
                var totalSpan = row.querySelector('[id$="-total"]');
                if (totalSpan) return parseFloat(totalSpan.textContent.replace(/[^\d.,-]/g, '').replace(',', '.')) || 0;
                return 0;
            }
            return '';
        }

        // ═══════════════════════════════════════════════════════════════════════
        // MODAL ENVOI
        // ═══════════════════════════════════════════════════════════════════════

        function openSubmitModal() {
            if (!currentSubmission) return;
            var s = currentSubmission.status;
            if (s !== 'draft' && s !== 'returned') {
                steleAlert('Cette soumission ne peut pas \u00eatre soumise (statut: ' + (STATUS_LABELS[s] || s) + ').');
                return;
            }
            const rows = document.querySelectorAll('.calc-row');
            if (rows.length === 0) {
                steleAlert('Veuillez ajouter au moins un article au calculateur.');
                return;
            }
            document.getElementById('projectDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('projectDescription').value = '';
            // Titre du modal adapté
            document.getElementById('submitModalTitle').textContent = 'Soumettre la soumission #' + currentSubmission.submission_number;
            document.getElementById('btnSend').textContent = 'Soumettre';
            document.getElementById('sendStatus').style.display = 'none';
            document.getElementById('pdfModal').classList.add('active');
        }

        // Legacy alias
        function openPdfModal() { openSubmitModal(); }

        function closePdfModal() {
            document.getElementById('pdfModal').classList.remove('active');
        }

        document.addEventListener('click', function(e) {
            if (e.target === document.getElementById('pdfModal')) closePdfModal();
        });

        // ═══════════════════════════════════════════════════════════════════════
        // GESTION DES IMAGES
        // ═══════════════════════════════════════════════════════════════════════

        // ── Chargement dynamique des librairies ──
        var cropperLoaded = false;
        var pdfJsLoaded = false;
        var currentCropper = null;
        var cropState = {}; // { groupId, originalBlob, existingMediaId, ratio }

        function loadCropperLib() {
            if (cropperLoaded) return Promise.resolve();
            return new Promise(function(resolve, reject) {
                var link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = 'https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.css';
                document.head.appendChild(link);
                var script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.js';
                script.onload = function() { cropperLoaded = true; resolve(); };
                script.onerror = function() { reject(new Error('Impossible de charger Cropper.js')); };
                document.head.appendChild(script);
            });
        }

        function loadPdfLib() {
            if (pdfJsLoaded) return Promise.resolve();
            return new Promise(function(resolve, reject) {
                var script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
                script.onload = function() {
                    window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                    pdfJsLoaded = true;
                    resolve();
                };
                script.onerror = function() { reject(new Error('Impossible de charger pdf.js')); };
                document.head.appendChild(script);
            });
        }

        function convertPdfToImage(file) {
            return new Promise(function(resolve, reject) {
                var reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        var pdf = await window.pdfjsLib.getDocument({ data: new Uint8Array(e.target.result) }).promise;
                        var page = await pdf.getPage(1);
                        var scale = 300 / 72; // 300 DPI
                        var viewport = page.getViewport({ scale: scale });
                        var canvas = document.createElement('canvas');
                        canvas.width = viewport.width;
                        canvas.height = viewport.height;
                        await page.render({ canvasContext: canvas.getContext('2d'), viewport: viewport }).promise;
                        canvas.toBlob(function(blob) {
                            resolve(blob);
                        }, 'image/jpeg', 0.92);
                    } catch (err) {
                        reject(err);
                    }
                };
                reader.readAsArrayBuffer(file);
            });
        }

        // ── Crop Modal ──
        function openCropModal(imageBlob, groupId, existingMediaId) {
            cropState = { groupId: groupId, originalBlob: imageBlob, existingMediaId: existingMediaId || null, ratio: '16:9' };
            var url = URL.createObjectURL(imageBlob);
            var imgEl = document.getElementById('cropImage');
            var modal = document.getElementById('cropModal');
            var errEl = document.getElementById('cropError');
            errEl.style.display = 'none';

            // Check dimensions
            var testImg = new Image();
            testImg.onload = async function() {
                document.getElementById('cropDimensions').textContent = testImg.width + ' × ' + testImg.height + ' px';
                if (testImg.width < 800 || testImg.height < 600) {
                    errEl.textContent = 'Image trop petite pour une présentation professionnelle (minimum 800×600). Celle-ci fait ' + testImg.width + '×' + testImg.height + '.';
                    errEl.style.display = 'block';
                    imgEl.src = url;
                    modal.classList.add('active');
                    document.getElementById('cropConfirmBtn').disabled = true;
                    return;
                }
                document.getElementById('cropConfirmBtn').disabled = false;
                imgEl.src = url;
                modal.classList.add('active');

                await loadCropperLib();
                if (currentCropper) { currentCropper.destroy(); currentCropper = null; }
                currentCropper = new Cropper(imgEl, {
                    aspectRatio: 16 / 9,
                    viewMode: 1,
                    autoCropArea: 0.9,
                    responsive: true,
                    background: false
                });
                // Reset ratio buttons
                document.getElementById('cropRatio169').classList.add('active');
                document.getElementById('cropRatio916').classList.remove('active');
                document.getElementById('cropRatio11').classList.remove('active');
            };
            testImg.src = url;
        }

        function setCropRatio(ratio) {
            cropState.ratio = ratio;
            document.getElementById('cropRatio169').classList.toggle('active', ratio === '16:9');
            document.getElementById('cropRatio916').classList.toggle('active', ratio === '9:16');
            document.getElementById('cropRatio11').classList.toggle('active', ratio === '1:1');
            var numRatio = ratio === '1:1' ? 1 : ratio === '9:16' ? 9 / 16 : 16 / 9;
            if (currentCropper) {
                currentCropper.setAspectRatio(numRatio);
            }
        }

        async function confirmCrop() {
            if (!currentCropper) return;
            var confirmBtn = document.getElementById('cropConfirmBtn');
            confirmBtn.disabled = true;
            confirmBtn.textContent = 'Upload...';

            try {
                var croppedCanvas = currentCropper.getCroppedCanvas({ maxWidth: 2048, maxHeight: 2048, imageSmoothingQuality: 'high' });
                var cropData = currentCropper.getData(true); // rounded
                var croppedBlob = await new Promise(function(resolve) {
                    croppedCanvas.toBlob(function(b) { resolve(b); }, 'image/jpeg', 0.88);
                });

                await uploadToStorage(cropState.originalBlob, croppedBlob, cropState.groupId, cropState.ratio, cropData, cropState.existingMediaId, cropState.sourceMetadata);
                closeCropModal();
            } catch (err) {
                console.error('Crop/upload error:', err);
                alert('Erreur lors de l\'upload : ' + err.message);
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Valider';
            }
        }

        function cancelCrop() {
            closeCropModal();
        }

        function closeCropModal() {
            var modal = document.getElementById('cropModal');
            modal.classList.remove('active');
            if (currentCropper) { currentCropper.destroy(); currentCropper = null; }
            var imgEl = document.getElementById('cropImage');
            if (imgEl.src.startsWith('blob:')) URL.revokeObjectURL(imgEl.src);
            imgEl.src = '';
            var resolve = cropState._resolve;
            cropState = {};
            if (resolve) resolve(); // continue to next image in queue
        }

        // ── Upload vers Supabase Storage + insert room_media ──
        async function uploadToStorage(originalBlob, croppedBlob, groupId, ratio, cropData, existingMediaId, sourceMetadata) {
            var roomId = roomMap[groupId];
            if (!roomId) throw new Error('Room non sauvegardée');
            var ts = Date.now();

            // Upload original (skip if recrop — original already exists)
            var originalUrl;
            if (existingMediaId) {
                // Recrop: find existing media to get original URL
                var existing = (groupImages[groupId] || []).find(function(img) { return img.mediaId === existingMediaId; });
                originalUrl = existing ? existing.originalUrl : null;
                if (!originalUrl) throw new Error('Original introuvable');
            } else {
                var origPath = 'originals/' + roomId + '/' + ts + '.jpg';
                var origResp = await authenticatedFetch(SUPABASE_URL + '/storage/v1/object/room-images/' + origPath, {
                    method: 'POST',
                    headers: { 'Content-Type': 'image/jpeg', 'x-upsert': 'true' },
                    body: originalBlob
                });
                if (!origResp.ok) throw new Error('Upload original échoué: ' + origResp.status);
                originalUrl = SUPABASE_URL + '/storage/v1/object/public/room-images/' + origPath;
            }

            // Upload cropped
            var cropPath = 'cropped/' + roomId + '/' + ts + '_' + ratio.replace(':', 'x') + '.jpg';
            var cropResp = await authenticatedFetch(SUPABASE_URL + '/storage/v1/object/room-images/' + cropPath, {
                method: 'POST',
                headers: { 'Content-Type': 'image/jpeg', 'x-upsert': 'true' },
                body: croppedBlob
            });
            if (!cropResp.ok) throw new Error('Upload crop échoué: ' + cropResp.status);
            var croppedUrl = SUPABASE_URL + '/storage/v1/object/public/room-images/' + cropPath;

            if (existingMediaId) {
                // Recrop: update existing record
                var oldMedia = (groupImages[groupId] || []).find(function(img) { return img.mediaId === existingMediaId; });
                // Delete old cropped file
                if (oldMedia && oldMedia.url) {
                    var oldPath = oldMedia.url.split('/room-images/')[1];
                    if (oldPath) {
                        authenticatedFetch(SUPABASE_URL + '/storage/v1/object/room-images/' + oldPath, { method: 'DELETE' }).catch(function() {});
                    }
                }
                await authenticatedFetch(SUPABASE_URL + '/rest/v1/room_media?id=eq.' + existingMediaId, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                    body: JSON.stringify({ cropped_url: croppedUrl, crop_ratio: ratio, crop_data: cropData })
                });
                // Update in memory
                if (oldMedia) { oldMedia.url = croppedUrl; oldMedia.cropRatio = ratio; }
            } else {
                // New image: insert record
                var sortOrder = (groupImages[groupId] || []).length;
                var insResp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/room_media', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                    body: JSON.stringify(Object.assign({
                        room_id: roomId,
                        original_url: originalUrl,
                        cropped_url: croppedUrl,
                        crop_ratio: ratio,
                        crop_data: cropData,
                        tags: ['presentation_soumission'],
                        sort_order: sortOrder
                    }, sourceMetadata ? { source_metadata: sourceMetadata } : {}))
                });
                if (!insResp.ok) throw new Error('Insert room_media échoué: ' + insResp.status);
                var inserted = await insResp.json();
                var mediaId = Array.isArray(inserted) ? inserted[0].id : inserted.id;

                if (!groupImages[groupId]) groupImages[groupId] = [];
                groupImages[groupId].push({
                    name: 'photo_' + ts + '.jpg',
                    url: croppedUrl,
                    originalUrl: originalUrl,
                    mediaId: mediaId,
                    tags: ['presentation_soumission'],
                    cropRatio: ratio,
                    isLegacy: false,
                    showInQuote: true,
                    annotations: []
                });
            }

            renderGroupImagePreviews(groupId);
            showSaveIndicator();
        }

        // ── Recrop depuis l'original ──
        async function recropImage(groupId, index) {
            if (currentSubmission && !isSubmissionCurrentlyEditable()) return;
            var img = (groupImages[groupId] || [])[index];
            if (!img || img.isLegacy || !img.originalUrl) return;
            try {
                var resp = await fetch(img.originalUrl);
                if (!resp.ok) throw new Error('Fetch original failed');
                var blob = await resp.blob();
                openCropModal(blob, groupId, img.mediaId);
            } catch (err) {
                console.error('Recrop error:', err);
                alert('Impossible de charger l\'image originale.');
            }
        }

        function compressImage(file, maxWidth, quality) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        if (w > maxWidth) { h = Math.round(h * maxWidth / w); w = maxWidth; }
                        canvas.width = w; canvas.height = h;
                        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // ═══════════════════════════════════════════════════════════════════════
        // IMAGES PAR MEUBLE (dans le calculateur)
        // ═══════════════════════════════════════════════════════════════════════

        function setupGroupImageHandlers(groupId) {
            const dropZone = document.getElementById(`${groupId}-imgDrop`);
            const fileInput = document.getElementById(`${groupId}-imgInput`);
            if (!dropZone || !fileInput) return;

            dropZone.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => { handleGroupImageFiles(groupId, e.target.files); fileInput.value = ''; });

            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
            dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('dragover'); });
            dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); handleGroupImageFiles(groupId, e.dataTransfer.files); });

            // Paste: écouter sur le groupe entier
            const groupEl = document.getElementById(groupId);
            groupEl.addEventListener('paste', (e) => {
                const files = [];
                for (let i = 0; i < e.clipboardData.items.length; i++) {
                    if (e.clipboardData.items[i].type.startsWith('image/')) files.push(e.clipboardData.items[i].getAsFile());
                }
                if (files.length > 0) { e.preventDefault(); e.stopPropagation(); handleGroupImageFiles(groupId, files); }
            });
        }

        async function handleGroupImageFiles(groupId, files) {
            // Guard: bloquer si soumission verrouillée
            if (currentSubmission && !isSubmissionCurrentlyEditable()) {
                steleAlert('Soumission verrouillée — impossible d\'ajouter des images.');
                return;
            }
            if (!groupImages[groupId]) groupImages[groupId] = [];
            var remaining = MAX_GROUP_IMAGES - groupImages[groupId].length;
            if (remaining <= 0) { alert('Maximum ' + MAX_GROUP_IMAGES + ' images atteint.'); return; }

            var validFiles = Array.from(files).slice(0, remaining);
            // Process one at a time (crop modal is sequential)
            for (var i = 0; i < validFiles.length; i++) {
                var file = validFiles[i];
                var blob;

                if (file.type === 'application/pdf') {
                    // PDF → image conversion
                    try {
                        await loadPdfLib();
                        blob = await convertPdfToImage(file);
                    } catch (err) {
                        console.error('PDF conversion error:', err);
                        alert('Erreur de conversion PDF : ' + err.message);
                        continue;
                    }
                } else if (file.type.startsWith('image/')) {
                    blob = file;
                } else {
                    continue; // skip unsupported
                }

                // Open crop modal (awaits user action)
                await new Promise(function(resolve) {
                    openCropModal(blob, groupId, null);
                    cropState._resolve = resolve; // must be after openCropModal which resets cropState
                });
            }
        }

        function renderGroupImagePreviews(groupId) {
            const container = document.getElementById(`${groupId}-imgPreviews`);
            const countEl = document.getElementById(`${groupId}-imgCount`);
            const dropZone = document.getElementById(`${groupId}-imgDrop`);
            if (!container) return;

            const imgs = groupImages[groupId] || [];
            container.innerHTML = '';
            imgs.forEach((img, index) => {
                const item = document.createElement('div');
                item.className = 'image-preview-item';
                var imgSrc = img.isLegacy ? img.dataUrl : (img.url || img.dataUrl);
                var checkedAttr = img.showInQuote ? 'checked' : '';
                var canRecrop = !img.isLegacy && img.originalUrl && isSubmissionCurrentlyEditable();
                var recropAttr = canRecrop ? ` onclick="recropImage('${escapeAttr(groupId)}', ${index})" style="cursor:pointer;" title="Cliquer pour recadrer"` : ` ondblclick="openLightbox(this.src)" title="Double-cliquer pour agrandir"`;
                var aiChecked = img.aiReference ? 'checked' : '';
                var annotCount = (img.annotations || []).length;
                var canAnnot = !img.isLegacy && img.mediaId;
                var annotEl = '';
                if (canAnnot && annotCount > 0) {
                    annotEl = `<span class="annotation-badge" onclick="event.stopPropagation();openAnnotationModal('${escapeAttr(groupId)}', ${index})" style="cursor:pointer;" title="${annotCount} tag(s) — cliquer pour annoter">${annotCount}</span>`;
                } else if (canAnnot) {
                    annotEl = `<button class="annotation-btn" onclick="event.stopPropagation();openAnnotationModal('${escapeAttr(groupId)}', ${index})" title="Annoter">&#9998;</button>`;
                }
                item.innerHTML = `<img src="${imgSrc}" alt="${escapeAttr(img.name)}"${recropAttr}>${annotEl}<button class="image-preview-remove" onclick="removeGroupImage('${escapeAttr(groupId)}', ${index})" title="Supprimer">&times;</button><label class="image-quote-toggle" title="Afficher dans la soumission client"><input type="checkbox" ${checkedAttr} onchange="toggleImageShowInQuote('${escapeAttr(groupId)}', ${index}, this.checked)"><span>Client</span></label><label class="image-ai-toggle" title="Envoyer comme r\u00e9f\u00e9rence \u00e0 l'AI"><input type="checkbox" ${aiChecked} onchange="toggleImageAiRef('${escapeAttr(groupId)}', ${index}, this.checked)"><span>AI</span></label>`;
                container.appendChild(item);
            });
            if (countEl) countEl.textContent = imgs.length > 0 ? imgs.length + ' / ' + MAX_GROUP_IMAGES + ' image(s)' : '';
            if (dropZone) dropZone.style.display = imgs.length >= MAX_GROUP_IMAGES ? 'none' : '';
        }

        async function removeGroupImage(groupId, index) {
            if (!groupImages[groupId]) return;
            var img = groupImages[groupId][index];
            if (!img) return;

            // Guard: bloquer si soumission verrouillée
            if (currentSubmission && !isSubmissionCurrentlyEditable()) {
                steleAlert('Soumission verrouillée — impossible de supprimer des images.');
                return;
            }
            // Confirmation avant suppression
            if (!(await steleConfirm('Supprimer cette image ?', 'Supprimer'))) return;

            if (!img.isLegacy && img.mediaId) {
                // Delete from room_media table
                try {
                    await authenticatedFetch(SUPABASE_URL + '/rest/v1/room_media?id=eq.' + img.mediaId, { method: 'DELETE' });
                } catch (e) { console.error('Delete room_media error:', e); }
                // Delete files from Storage (best effort)
                try {
                    if (img.url) {
                        var croppedPath = img.url.split('/room-images/')[1];
                        if (croppedPath) authenticatedFetch(SUPABASE_URL + '/storage/v1/object/room-images/' + croppedPath, { method: 'DELETE' }).catch(function(){});
                    }
                    if (img.originalUrl) {
                        var origPath = img.originalUrl.split('/room-images/')[1];
                        if (origPath) authenticatedFetch(SUPABASE_URL + '/storage/v1/object/room-images/' + origPath, { method: 'DELETE' }).catch(function(){});
                    }
                } catch (e) { console.error('Delete storage files error:', e); }
            }

            groupImages[groupId].splice(index, 1);
            renderGroupImagePreviews(groupId);
            // Only save to JSONB if there are legacy images
            if (img.isLegacy) saveGroupImages(groupId);
            showSaveIndicator();
        }

        const debouncedSaveGroupImages = debounce(function(groupId) {
            if (!roomMap[groupId]) return;
            // Only save legacy (Base64) images to JSONB — new images are in room_media table
            const legacyImgs = (groupImages[groupId] || []).filter(img => img.isLegacy);
            const imgs = legacyImgs.map(img => ({ name: img.name, dataUrl: img.dataUrl, showInQuote: !!img.showInQuote }));
            updateRoom(roomMap[groupId], { images: imgs });
            showSaveIndicator();
        }, 1000);

        function saveGroupImages(groupId) {
            debouncedSaveGroupImages(groupId);
        }

        function saveExclusions() {
            if (!currentSubmission) return;
            var el = document.getElementById('exclusionsText');
            if (!el) return;
            updateSubmission(currentSubmission.id, { exclusions: el.value }).catch(function(e) { console.error('Save exclusions:', e); });
            showSaveIndicator();
        }

        function editClientDescription(groupId) {
            var display = document.getElementById(groupId + '-clientDescDisplay');
            var textarea = document.getElementById(groupId + '-clientDesc');
            if (!display || !textarea) return;
            if (currentSubmission && !isSubmissionCurrentlyEditable()) return;
            display.style.display = 'none';
            textarea.style.display = '';
            textarea.focus();
        }

        function finishEditDescription(groupId) {
            saveClientDescription(groupId);
            var display = document.getElementById(groupId + '-clientDescDisplay');
            var textarea = document.getElementById(groupId + '-clientDesc');
            if (!display || !textarea) return;
            textarea.style.display = 'none';
            display.style.display = '';
            refreshDescriptionDisplay(groupId);
        }

        function refreshDescriptionDisplay(groupId) {
            var display = document.getElementById(groupId + '-clientDescDisplay');
            var textarea = document.getElementById(groupId + '-clientDesc');
            if (!display || !textarea) return;
            var text = textarea.value.trim();
            if (!text) {
                display.innerHTML = '<span class="desc-placeholder">Description visible par le client...</span>';
            } else {
                display.innerHTML = formatDescriptionForDisplay(text);
            }
        }

        function saveClientDescription(groupId) {
            if (!roomMap[groupId]) return;
            var textarea = document.getElementById(groupId + '-clientDesc');
            if (!textarea) return;
            // Convert plain text to HTML for storage, update HTML cache, clear stale EN
            var html = textToHtml(textarea.value);
            roomDescHTML[groupId] = html;
            if (roomDescEN[groupId]) {
                roomDescEN[groupId] = '';
                updateRoom(roomMap[groupId], { client_description: html, client_description_en: '' });
            } else {
                updateRoom(roomMap[groupId], { client_description: html });
            }
            showSaveIndicator();
        }

        /**
         * Assemble a structured room description from presentation_rule of catalogue items.
         * Deterministic: no AI call, uses sections from each item's presentation_rule.
         */
        function assembleRoomDescription(groupId) {
            var group = document.getElementById(groupId);
            if (!group) return '';

            // Default materials (room-level, fallback submission-level)
            var dm = (roomDM[groupId] && roomDM[groupId].length > 0) ? roomDM[groupId] : getDefaultMaterials();

            // Collect articles with their presentation_rule
            var articlesBySection = {};
            var detailTexts = [];

            group.querySelectorAll('.calc-row').forEach(function(row) {
                var sel = row.querySelector('.item-select');
                if (!sel || !sel.value || sel.value === '__AJOUT__' || sel.value === '__PROPOSER__') return;
                var item = CATALOGUE_DATA.find(function(i) { return i.id === sel.value; });
                if (!item) return;

                if (item.presentation_rule && item.presentation_rule.sections) {
                    item.presentation_rule.sections.forEach(function(sec) {
                        if (!articlesBySection[sec.key]) articlesBySection[sec.key] = [];
                        var text = (sec.template || '{client_text}').replace('{client_text}', item.client_text || item.description);
                        // Avoid duplicates
                        var exists = articlesBySection[sec.key].some(function(a) { return a.text === text; });
                        if (!exists) articlesBySection[sec.key].push({ text: text, label: sec.label });
                    });
                } else if (item.client_text) {
                    if (detailTexts.indexOf(item.client_text) === -1) detailTexts.push(item.client_text);
                }
            });

            var SECTION_ORDER = ['CAISSON', 'FAÇADES', 'PANNEAUX', 'COMPTOIR', 'TIROIRS', 'POIGNÉES',
                'QUINCAILLERIE', 'ÉCLAIRAGE', 'FINITION', 'RANGEMENT', 'DÉTAILS',
                'EXCLUSIONS', 'NOTES', 'PARTICULARITÉS'];
            var lines = [];

            // Default materials first
            dm.forEach(function(d) {
                if (d.catalogue_item_id && d.description) {
                    var sectionKey = (d.type || '').toUpperCase();
                    if (!articlesBySection[sectionKey]) {
                        lines.push(toSentenceCase(d.type || '') + ' : ' + d.description);
                    }
                }
            });

            // Sections from presentation_rule
            SECTION_ORDER.forEach(function(key) {
                if (articlesBySection[key] && articlesBySection[key].length > 0) {
                    var label = articlesBySection[key][0].label || key;
                    var texts = articlesBySection[key].map(function(a) { return a.text; });
                    if (texts.length === 1) {
                        lines.push(toSentenceCase(label) + ' : ' + texts[0]);
                    } else {
                        lines.push(toSentenceCase(label) + ' :');
                        texts.forEach(function(t) { lines.push('- ' + t); });
                    }
                }
            });

            // Fallback details for items without presentation_rule
            if (detailTexts.length > 0 && !articlesBySection['DÉTAILS']) {
                lines.push('Détails :');
                detailTexts.forEach(function(d) { lines.push('- ' + d); });
            }

            return lines.join('\n');
        }

        function onAssembleDescription(groupId) {
            var textarea = document.getElementById(groupId + '-clientDesc');
            if (!textarea) return;

            var assembled = assembleRoomDescription(groupId);
            if (!assembled) {
                showConstraintToast('Aucun article avec texte client dans cette pièce');
                return;
            }

            var existing = textarea.value.trim();
            if (existing) {
                showConstraintModal('Remplacer la description ?',
                    'La description actuelle sera remplacée par la version assemblée.',
                    [{ key: 'replace', label: 'Remplacer', primary: true },
                     { key: 'cancel', label: 'Annuler', primary: false }]
                ).then(function(choice) {
                    if (choice === 'replace') applyAssembledDescription(groupId, assembled);
                });
            } else {
                applyAssembledDescription(groupId, assembled);
            }
        }

        function applyAssembledDescription(groupId, text) {
            var textarea = document.getElementById(groupId + '-clientDesc');
            if (!textarea) return;
            textarea.value = text;
            var html = textToHtml(text);
            roomDescHTML[groupId] = html;
            refreshDescriptionDisplay(groupId);
            roomDescEN[groupId] = '';
            if (roomMap[groupId]) {
                updateRoom(roomMap[groupId], { client_description: html, client_description_en: '' });
            }
            showSaveIndicator();
        }

        async function toggleImageShowInQuote(groupId, index, checked) {
            if (!groupImages[groupId] || !groupImages[groupId][index]) return;
            var img = groupImages[groupId][index];
            img.showInQuote = checked;

            if (!img.isLegacy && img.mediaId) {
                // Update tags in room_media
                var newTags = checked
                    ? Array.from(new Set((img.tags || []).concat(['presentation_soumission'])))
                    : (img.tags || []).filter(function(t) { return t !== 'presentation_soumission'; });
                img.tags = newTags;
                try {
                    await authenticatedFetch(SUPABASE_URL + '/rest/v1/room_media?id=eq.' + img.mediaId, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                        body: JSON.stringify({ tags: newTags })
                    });
                } catch (e) { console.error('Update room_media tags error:', e); }
                showSaveIndicator();
            } else {
                saveGroupImages(groupId);
            }
        }

        async function toggleImageAiRef(groupId, index, checked) {
            if (!groupImages[groupId] || !groupImages[groupId][index]) return;
            var img = groupImages[groupId][index];
            img.aiReference = checked;

            if (!img.isLegacy && img.mediaId) {
                var newTags = checked
                    ? Array.from(new Set((img.tags || []).concat(['ai_reference'])))
                    : (img.tags || []).filter(function(t) { return t !== 'ai_reference'; });
                img.tags = newTags;
                try {
                    await authenticatedFetch(SUPABASE_URL + '/rest/v1/room_media?id=eq.' + img.mediaId, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                        body: JSON.stringify({ tags: newTags })
                    });
                } catch (e) { console.error('Update room_media AI tag error:', e); }
                showSaveIndicator();
            } else {
                saveGroupImages(groupId);
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // ENVOI DE L'ESTIMATION
        // ═══════════════════════════════════════════════════════════════════════

        function collecterDonneesCalculateur() {
            const groups = document.querySelectorAll('.furniture-group');
            const meubles = [];
            let grandTotal = 0;

            groups.forEach(group => {
                const nameInput = group.querySelector('.furniture-name-input');
                const meubleName = nameInput ? (nameInput.value.trim() || 'Sans nom') : 'Sans nom';
                const items = [];
                let subtotal = 0;

                group.querySelectorAll('.calc-row').forEach(row => {
                    const select = row.querySelector('.item-select');
                    const qtyInput = row.querySelector('.qty-input');
                    if (!select || !qtyInput || !select.value) return;

                    const selectedId = select.value;
                    const qty = parseFloat(qtyInput.value) || 0;

                    if (selectedId === '__AJOUT__') {
                        var cdExport = _customItemDataMap[row.id] || {};
                        var ajCostE = cdExport.unit_price || 0;
                        var ajMarkE = cdExport.markup || 0;
                        var lineTotalE = ajCostE * qty * (1 + ajMarkE / 100);
                        items.push({ type: 'ajout', description: cdExport.description || 'Ajout sans description', unitPrice: formatPrice(ajCostE), qty: qty, markup: ajMarkE, lineTotal: formatPrice(lineTotalE) });
                        subtotal += lineTotalE;
                    } else {
                        const item = CATALOGUE_DATA.find(i => i.id === selectedId);
                        if (item) {
                            const lineTotal = (item.price || 0) * qty;
                            subtotal += lineTotal;
                            items.push({ type: 'catalogue', code: item.id, description: item.description, itemType: item.type, unitPrice: formatPrice(item.price), qty: qty, lineTotal: formatPrice(lineTotal) });
                        }
                    }
                });

                if (items.length > 0) {
                    const groupId = group.id;
                    var effectiveSubtotal = Math.round(subtotal * getModifierMultiplier(groupId) * 100) / 100;
                    grandTotal += effectiveSubtotal;
                    const imgs = (groupImages[groupId] || []).map(img => ({
                        name: img.name,
                        mimeType: img.dataUrl ? (img.dataUrl.match(/^data:(.*?);/)?.[1] || 'image/jpeg') : 'image/jpeg',
                        data: img.dataUrl ? img.dataUrl.split(',')[1] : null,
                        url: img.url || null
                    }));
                    meubles.push({ name: meubleName, items: items, subtotal: formatPrice(effectiveSubtotal), images: imgs });
                }
            });

            var finalTotal = applySubmissionDiscount(grandTotal);
            var result = { meubles: meubles, total: formatPrice(finalTotal) };
            if (currentSubmission && currentSubmission.discount_type && currentSubmission.discount_value > 0) {
                result.discount = { type: currentSubmission.discount_type, value: currentSubmission.discount_value };
                result.subtotalBeforeDiscount = formatPrice(grandTotal);
            }
            if (currentSubmission) {
                result.submissionNumber = currentSubmission.submission_number;
                result.submissionTitle = currentSubmission.title;
                result.clauses = currentSubmission.clauses || [];
                result.status = currentSubmission.status;
                result.approvedTotal = currentSubmission.approved_total;
            }
            if (currentProject) {
                result.projectName = currentProject.name;
                result.clientName = currentProject.client_name;
                result.clientEmail = currentProject.client_email;
                result.clientAddress = currentProject.client_address;
                result.designer = currentProject.designer;
            }
            // Descriptions client + installation + media URLs par room
            var allGroups = document.querySelectorAll('.furniture-group');
            var mIdx = 0;
            allGroups.forEach(function(group) {
                // Only match groups that produced a meuble (items.length > 0)
                var rows = group.querySelectorAll('.calc-row');
                var hasItems = false;
                rows.forEach(function(row) {
                    var sel = row.querySelector('.item-select');
                    if (sel && sel.value) hasItems = true;
                });
                if (!hasItems) return;
                if (mIdx >= result.meubles.length) return;
                var textarea = group.querySelector('.client-desc-textarea');
                if (textarea) result.meubles[mIdx].clientDescription = textarea.value || '';
                var instCheckbox = group.querySelector('.install-toggle');
                if (instCheckbox) result.meubles[mIdx].installationIncluded = instCheckbox.checked;
                var groupId = group.id;
                result.meubles[mIdx].mediaUrls = (groupImages[groupId] || []).map(function(img) {
                    return { url: img.url || null, originalUrl: img.originalUrl || null, mediaId: img.mediaId || null, cropRatio: img.cropRatio || null, name: img.name };
                });
                mIdx++;
            });
            return result;
        }

        function showSendStatus(message, isError) {
            const statusEl = document.getElementById('sendStatus');
            statusEl.style.display = 'block';
            statusEl.textContent = message;
            statusEl.style.background = isError ? '#ffebee' : '#e8f5e9';
            statusEl.style.color = isError ? '#c62828' : '#2e7d32';
        }

        async function soumettreSoumission() {
            if (!currentSubmission) return;

            const projectDate = document.getElementById('projectDate').value;
            const projectDescription = document.getElementById('projectDescription').value.trim();

            const { meubles, total } = collecterDonneesCalculateur();
            if (meubles.length === 0) { showSendStatus('Aucun article \u00e0 soumettre.', true); return; }

            const btnSend = document.getElementById('btnSend');
            btnSend.disabled = true;
            btnSend.textContent = 'Soumission en cours...';
            showSendStatus('Soumission en cours...', false);

            try {
                // Cr\u00e9er un snapshot avec les notes du modal
                await createVersion(currentSubmission.id);

                // Sauvegarder les notes sur le projet
                if (projectDescription && currentProject) {
                    await updateProject(currentProject.id, { notes: projectDescription });
                }

                var grandTotal = calculerGrandTotal();

                if (canApproveQuotes) {
                    // Auto-approbation en 2 étapes (le trigger DB exige draft→pending→approved)
                    await updateSubmission(currentSubmission.id, {
                        status: 'pending_internal',
                        approved_total: grandTotal
                    });
                    await createSubmissionReview(currentSubmission.id, 'approved', projectDescription || 'Auto-approbation');
                    await updateSubmission(currentSubmission.id, {
                        status: 'approved_internal',
                        approved_by: localStorage.getItem('sb_user_id'),
                        approved_at: new Date().toISOString(),
                        approved_total: grandTotal
                    });
                    currentSubmission.status = 'approved_internal';
                    // Figer le HTML de la soumission
                    await uploadSnapshot(currentSubmission.id);
                    updateStatusBadge('approved_internal');
                    showSendStatus('Soumission approuv\u00e9e!', false);
                } else {
                    // Soumettre pour approbation interne
                    var submitComment = projectDescription || '';
                    if (projectDate) submitComment = 'Date requise: ' + projectDate + (submitComment ? '\n' + submitComment : '');
                    await createSubmissionReview(currentSubmission.id, 'submitted', submitComment || 'Soumis pour approbation');
                    await updateSubmission(currentSubmission.id, {
                        status: 'pending_internal',
                        approved_total: grandTotal
                    });
                    currentSubmission.status = 'pending_internal';
                    updateStatusBadge('pending_internal');
                    showSendStatus('Soumission envoy\u00e9e pour approbation!', false);
                }

                updateWorkflowButtons();
                setEditable(false);
                loadSubmissionReviews(currentSubmission.id);
                btnSend.textContent = 'Soumis!';
                setTimeout(() => {
                    closePdfModal();
                    btnSend.disabled = false;
                    btnSend.textContent = 'Soumettre';
                    document.getElementById('sendStatus').style.display = 'none';
                }, 1500);
            } catch (error) {
                console.error('Erreur soumission:', error);
                showSendStatus('Erreur: ' + error.message, true);
                btnSend.disabled = false;
                btnSend.textContent = 'Soumettre';
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // APERÇU SOUMISSION (PREVIEW VIEW) + BIBLIOTHÈQUE DE CLAUSES
        // ═══════════════════════════════════════════════════════════════════════

        var clauseLibrary = []; // loaded from quote_clauses table
        var clientViewMode = false;
        var currentLang = 'fr';
        var roomDescEN = {}; // { groupDomId: 'english description (HTML)' }
        var introConfigEN = {}; // { presentation_intro_text_1: '...', ... }
        var roomDescHTML = {}; // { groupDomId: 'HTML description from optimizer' }
        var i18n = {
            fr: {
                coverLabel: 'Soumission préparée pour',
                soumission: 'Soumission',
                client: 'Client',
                projet: 'Projet',
                designer: 'Designer',
                clausesTitle: 'Clauses du contrat',
                total: 'Total',
                taxes: '+ taxes applicables',
                footer: 'Stele \u2014 \u00c9b\u00e9nisterie sur mesure',
                descPlaceholder: 'Description visible par le client...',
                dropClause: 'Glissez une clause ici',
                biblio: '\u2191 Bib.',
                introLabel: 'Introduction',
                introAttention: '\u00c0 l\u2019attention de\u2009:',
                introTitle: 'Merci de<br>consid\u00e9rer <strong>stele</strong><br>pour votre projet.',
                introAtelier: 'Atelier',
                introBureau: 'Bureau',
                stepsTitle: '\u00c9tapes d\u2019un projet type',
                steps: [
                    { label: 'Conception', desc: '\u00c0 cette \u00e9tape, nous veillerons \u00e0 rassembler toutes les informations n\u00e9cessaires au bon d\u00e9roulement du projet. Cela inclut le choix des poign\u00e9es, l\u2019approbation des mat\u00e9riaux, ainsi que l\u2019\u00e9tude des d\u00e9fis sp\u00e9cifiques au projet. Nous rassemblerons \u00e9galement les fiches techniques des \u00e9lectrom\u00e9nagers et validerons l\u2019\u00e9ch\u00e9ancier avec le client et l\u2019entrepreneur.' },
                    { label: 'Prise de mesure initiale', desc: 'Typiquement, cette prise de mesures s\u2019effectue sur les colombages et le plancher non fini. Nous tiendrons compte de l\u2019\u00e9paisseur du rev\u00eatement de sol et des murs pr\u00e9vus afin d\u2019\u00e9laborer nos dessins.' },
                    { label: 'Approbation des dessins d\u2019atelier', desc: 'Suite \u00e0 notre premi\u00e8re prise de mesures, les dessins d\u2019atelier vous seront remis pour approbation. Une fois ces dessins approuv\u00e9s, aucune modification ne pourra y \u00eatre apport\u00e9e.' },
                    { label: 'Commande de mat\u00e9riaux', desc: 'Comme nous prenons en compte les \u00e9paisseurs de rev\u00eatement lors de notre prise de mesures sur l\u2019ossature brute, nous sommes en mesure de commander les mat\u00e9riaux, tels que les placages de bois et la quincaillerie sp\u00e9ciale, afin d\u2019\u00e9viter tout d\u00e9lai lors de la mise en production.' },
                    { label: 'Prise de mesure finale', desc: 'La prise de mesures finale s\u2019effectue une fois le plancher fini et les joints ainsi que les coins de fer pos\u00e9s. Apr\u00e8s cette prise de mesures, un d\u00e9lai de 6 semaines est n\u00e9cessaire avant le d\u00e9but de l\u2019installation.' },
                    { label: 'Dessins d\u2019atelier pour production', desc: 'Comme nous avons pr\u00e9alablement ajust\u00e9 la prise de mesures initiale pour qu\u2019elle soit presque conforme au r\u00e9sultat final, les ajustements \u00e0 ce stade sont mineurs. Sauf en cas de changement majeur, les dessins d\u2019atelier ne vous seront pas renvoy\u00e9s pour approbation \u00e0 cette \u00e9tape.' },
                    { label: 'Installation', desc: 'La dur\u00e9e de cette \u00e9tape varie en fonction de l\u2019ampleur du projet, mais elle marque un moment cl\u00e9\u00a0: celui o\u00f9 votre vision prend forme. Il ne restera plus que notre mobilier, pr\u00eat \u00e0 s\u2019int\u00e9grer dans votre quotidien et \u00e0 accompagner vos plus beaux moments \u00e0 la maison.' },
                    { label: 'Contr\u00f4le de qualit\u00e9', desc: 'Une fois l\u2019installation termin\u00e9e, un repr\u00e9sentant Stele effectuera une visite avec vous pour \u00e9tablir ensemble une liste unique d\u2019ajustements, si n\u00e9cessaire. Stele pr\u00e9parera ensuite tout le n\u00e9cessaire et, lors d\u2019une seule visite suppl\u00e9mentaire, apportera les ajustements n\u00e9cessaires pour garantir un r\u00e9sultat final \u00e0 la hauteur de vos attentes.' }
                ]
            },
            en: {
                coverLabel: 'Quote prepared for',
                soumission: 'Quote',
                client: 'Client',
                projet: 'Project',
                designer: 'Designer',
                clausesTitle: 'Contract Terms',
                total: 'Total',
                taxes: '+ applicable taxes',
                footer: 'Stele \u2014 Custom Cabinetry',
                descPlaceholder: 'Client-facing description...',
                dropClause: 'Drag a clause here',
                biblio: '\u2191 Lib.',
                introLabel: 'Introduction',
                introAttention: 'To the attention of:',
                introTitle: 'Thank you for<br>considering <strong>stele</strong><br>for your project.',
                introAtelier: 'Workshop',
                introBureau: 'Office',
                stepsTitle: 'Typical Project Steps',
                steps: [
                    { label: 'Design', desc: 'At this stage, we will gather all the information necessary for the smooth progress of the project. This includes the choice of handles, material approval, and the study of project-specific challenges. We will also collect technical specifications for appliances and validate the timeline with the client and contractor.' },
                    { label: 'Initial Measurement', desc: 'Typically, this measurement is taken on the framing and unfinished floor. We will account for the thickness of the planned flooring and wall coverings in order to develop our drawings.' },
                    { label: 'Shop Drawing Approval', desc: 'Following our initial measurements, the shop drawings will be submitted to you for approval. Once these drawings are approved, no modifications can be made.' },
                    { label: 'Material Ordering', desc: 'Since we account for covering thicknesses during our measurements on the rough framing, we are able to order materials such as wood veneers and specialty hardware, avoiding any delay when production begins.' },
                    { label: 'Final Measurement', desc: 'The final measurement is taken once the finished floor is installed and the joints and corner beads are in place. After this measurement, a 6-week lead time is required before installation begins.' },
                    { label: 'Production Shop Drawings', desc: 'Since we previously adjusted the initial measurements to be nearly consistent with the final result, adjustments at this stage are minor. Unless there is a major change, the shop drawings will not be resubmitted for your approval at this step.' },
                    { label: 'Installation', desc: 'The duration of this stage varies depending on the scope of the project, but it marks a key moment: the one where your vision takes shape. All that will remain is our furniture, ready to integrate into your daily life and accompany your finest moments at home.' },
                    { label: 'Quality Control', desc: 'Once installation is complete, a Stele representative will visit you to establish a single list of adjustments, if necessary. Stele will then prepare everything needed and, in one additional visit, make the necessary adjustments to ensure a final result that meets your expectations.' }
                ]
            }
        };
        function t(key) { return (i18n[currentLang] || i18n.fr)[key] || key; }

        async function openPreview() {
            clientViewMode = false;
            document.getElementById('previewView').classList.remove('pv-client-mode');
            document.getElementById('calculatorView').classList.remove('active');
            document.getElementById('previewView').classList.add('active');
            await loadClauseLibrary();
            renderPreview();
            renderClauseLibrary();
            document.getElementById('pvContent').scrollTop = 0;

            // Hide EN toggle and clause panel when submission is locked
            var isLocked = !isSubmissionCurrentlyEditable();
            var btnLang = document.getElementById('btnLang');
            var pvRight = document.getElementById('pvRight');
            if (btnLang) btnLang.style.display = isLocked ? 'none' : '';
            if (pvRight) pvRight.style.display = isLocked ? 'none' : '';
        }

        function closePreview() {
            document.getElementById('previewView').classList.remove('active');
            document.getElementById('previewView').classList.remove('pv-client-mode');
            document.getElementById('calculatorView').classList.add('active');
            clientViewMode = false;
        }

        // ═══════════════════════════════════════════════════════════════════════
        // Plans architecturaux
        // ═══════════════════════════════════════════════════════════════════════
        async function openPlansModal() {
            if (!currentSubmission) {
                alert('Veuillez ouvrir une soumission d\'abord.');
                return;
            }
            document.getElementById('plansModal').classList.add('active');
            await loadSubmissionPlans();
        }

        function closePlansModal() {
            document.getElementById('plansModal').classList.remove('active');
        }

        async function loadSubmissionPlans() {
            if (!currentSubmission) return;

            var container = document.getElementById('plansListContainer');
            container.innerHTML = '<div class="plans-empty">Chargement...</div>';

            try {
                var response = await authenticatedFetch(
                    SUPABASE_URL + '/rest/v1/submission_plans?submission_id=eq.' + currentSubmission.id + '&order=version_number.desc',
                    { headers: { 'Prefer': 'return=representation' } }
                );

                if (!response.ok) throw new Error('Erreur de chargement des plans');

                var plans = await response.json();

                if (plans.length === 0) {
                    container.innerHTML = '<div class="plans-empty">Aucun plan pour cette soumission</div>';
                    return;
                }

                var html = '';
                for (var i = 0; i < plans.length; i++) {
                    var plan = plans[i];
                    var date = new Date(plan.uploaded_at).toLocaleDateString('fr-CA');
                    var size = (plan.file_size / 1024).toFixed(0) + ' Ko';
                    var pages = plan.page_count ? plan.page_count + ' pages' : '';

                    html += '<div class="plan-item">';
                    html += '  <div class="plan-icon">📄</div>';
                    html += '  <div class="plan-info">';
                    html += '    <div class="plan-version">Version ' + plan.version_number + '</div>';
                    html += '    <div class="plan-filename">' + plan.file_name + '</div>';
                    html += '    <div class="plan-meta">' + date + ' • ' + size + (pages ? ' • ' + pages : '') + '</div>';
                    html += '  </div>';
                    html += '  <div class="plan-actions">';
                    html += '    <button class="plan-action-btn" id="btnView_' + plan.id + '" onclick="openPdfViewer(\'' + plan.id + '\')"><span class="btn-text">Voir</span></button>';
                    html += '    <button class="plan-action-btn" id="btnDownload_' + plan.id + '" onclick="downloadPlan(\'' + plan.id + '\', \'' + plan.file_name + '\')"><span class="btn-text">Télécharger</span></button>';
                    html += '    <button class="plan-action-btn danger" onclick="deletePlan(\'' + plan.id + '\')">Supprimer</button>';
                    html += '  </div>';
                    html += '</div>';
                }

                container.innerHTML = html;
            } catch (err) {
                console.error('Error loading plans:', err);
                container.innerHTML = '<div class="plans-empty">Erreur de chargement</div>';
            }
        }

        async function handlePlanFileSelect(event) {
            var file = event.target.files[0];
            if (!file) return;

            if (file.type !== 'application/pdf') {
                alert('Veuillez sélectionner un fichier PDF.');
                event.target.value = '';
                return;
            }

            await uploadNewPlan(file);
            event.target.value = '';
        }

        async function uploadNewPlan(file) {
            if (!currentSubmission) return;

            var status = document.getElementById('planUploadStatus');
            var btn = document.getElementById('btnUploadPlan');

            try {
                // Show upload status
                btn.disabled = true;
                status.style.display = 'block';
                status.style.background = '#e3f2fd';
                status.style.color = '#1565c0';
                status.innerHTML = '<span style="display:inline-block; animation: pulse 1.5s ease-in-out infinite;">📄</span> Préparation...';

                // Get next version number
                var versionResp = await authenticatedFetch(
                    SUPABASE_URL + '/rest/v1/rpc/get_next_plan_version',
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ p_submission_id: currentSubmission.id })
                    }
                );

                if (!versionResp.ok) throw new Error('Erreur de récupération de la version');
                var nextVersion = await versionResp.json();

                status.innerHTML = '<span style="display:inline-block; animation: pulse 1.5s ease-in-out infinite;">⬆️</span> Upload en cours (' + (file.size / 1024 / 1024).toFixed(1) + ' MB)...';

                // Upload to Storage
                var storagePath = currentSubmission.id + '/v' + nextVersion + '_' + file.name;
                var uploadResp = await authenticatedFetch(
                    SUPABASE_URL + '/storage/v1/object/submission-plans/' + storagePath,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': file.type },
                        body: file
                    }
                );

                if (!uploadResp.ok) {
                    var errData = await uploadResp.text();
                    throw new Error('Erreur d\'upload: ' + errData);
                }

                status.innerHTML = '<span style="display:inline-block; animation: pulse 1.5s ease-in-out infinite;">💾</span> Enregistrement...';

                // Create database record
                var dbResp = await authenticatedFetch(
                    SUPABASE_URL + '/rest/v1/submission_plans',
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify({
                            submission_id: currentSubmission.id,
                            version_number: nextVersion,
                            file_path: storagePath,
                            file_name: file.name,
                            file_size: file.size,
                            status: 'ready'
                        })
                    }
                );

                if (!dbResp.ok) throw new Error('Erreur de création de l\'enregistrement');

                // Success
                status.style.background = '#e8f5e9';
                status.style.color = '#2e7d32';
                status.innerHTML = '✓ Plan téléversé avec succès!';

                // Reload list
                await loadSubmissionPlans();

                // Hide status after 3 seconds
                setTimeout(function() {
                    status.style.display = 'none';
                }, 3000);

            } catch (err) {
                console.error('Upload error:', err);
                status.style.background = '#ffebee';
                status.style.color = '#c62828';
                status.innerHTML = '✗ Erreur: ' + err.message;

                // Keep error visible longer (10 seconds)
                setTimeout(function() {
                    status.style.display = 'none';
                }, 10000);
            } finally {
                btn.disabled = false;
            }
        }

        function setPlanButtonLoading(planId, btnType, isLoading) {
            var btn = document.getElementById('btn' + btnType + '_' + planId);
            if (!btn) return;

            if (isLoading) {
                btn.disabled = true;
                var textSpan = btn.querySelector('.btn-text');
                if (textSpan) {
                    textSpan.style.opacity = '0.6';
                    var loadingText = btnType === 'View' ? 'Ouverture...' : 'Téléchargement...';
                    btn.innerHTML = '<span style="display:inline-block; animation: spin 1s linear infinite;">⟳</span> ' + loadingText;
                }
            } else {
                btn.disabled = false;
                var originalText = btnType === 'View' ? 'Voir' : 'Télécharger';
                btn.innerHTML = '<span class="btn-text">' + originalText + '</span>';
            }
        }

        async function downloadPlan(planId, fileName) {
            setPlanButtonLoading(planId, 'Download', true);
            try {
                // Get plan record to get file_path
                var planResp = await authenticatedFetch(
                    SUPABASE_URL + '/rest/v1/submission_plans?id=eq.' + planId + '&select=file_path',
                    {}
                );

                if (!planResp.ok) throw new Error('Plan introuvable');
                var plans = await planResp.json();
                if (plans.length === 0) throw new Error('Plan introuvable');

                var filePath = plans[0].file_path;

                // Get signed URL for download
                var signResp = await authenticatedFetch(
                    SUPABASE_URL + '/storage/v1/object/sign/submission-plans/' + filePath,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ expiresIn: 60 })
                    }
                );

                if (!signResp.ok) throw new Error('Erreur de génération du lien');
                var signData = await signResp.json();

                // Download file
                var downloadUrl = SUPABASE_URL + '/storage/v1' + signData.signedURL;
                var link = document.createElement('a');
                link.href = downloadUrl;
                link.download = fileName;
                link.click();

            } catch (err) {
                console.error('Download error:', err);
                alert('Erreur de téléchargement: ' + err.message);
            } finally {
                setPlanButtonLoading(planId, 'Download', false);
            }
        }

        async function deletePlan(planId) {
            if (!confirm('Êtes-vous sûr de vouloir supprimer ce plan ?')) return;

            try {
                // Get plan record to get file_path
                var planResp = await authenticatedFetch(
                    SUPABASE_URL + '/rest/v1/submission_plans?id=eq.' + planId + '&select=file_path',
                    {}
                );

                if (!planResp.ok) throw new Error('Plan introuvable');
                var plans = await planResp.json();
                if (plans.length === 0) throw new Error('Plan introuvable');

                var filePath = plans[0].file_path;

                // Delete from Storage
                var deleteStorageResp = await authenticatedFetch(
                    SUPABASE_URL + '/storage/v1/object/submission-plans/' + filePath,
                    { method: 'DELETE' }
                );

                if (!deleteStorageResp.ok) {
                    console.warn('Storage deletion failed, continuing with DB deletion');
                }

                // Delete from database
                var deleteDbResp = await authenticatedFetch(
                    SUPABASE_URL + '/rest/v1/submission_plans?id=eq.' + planId,
                    { method: 'DELETE' }
                );

                if (!deleteDbResp.ok) throw new Error('Erreur de suppression');

                // Reload list
                await loadSubmissionPlans();

            } catch (err) {
                console.error('Delete error:', err);
                alert('Erreur de suppression: ' + err.message);
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // PDF Viewer
        // ═══════════════════════════════════════════════════════════════════════
        var pdfDoc = null;
        var pdfCurrentPage = 1;
        var pdfTotalPages = 0;
        var pdfScale = 1.0;
        var pdfRotation = 0;
        var currentPdfUrl = null;
        var currentPlanRecord = null;
        var currentRenderTask = null; // Track current render task for cancellation

        async function openPdfViewer(planId) {
            setPlanButtonLoading(planId, 'View', true);

            // Open blank window IMMEDIATELY (sync) to preserve user gesture — avoids pop-up blocker
            var newWindow = window.open('about:blank', '_blank', 'width=1200,height=800');

            if (!newWindow) {
                alert('Veuillez autoriser les fenêtres pop-up pour cette fonctionnalité.');
                setPlanButtonLoading(planId, 'View', false);
                return;
            }

            try {
                // Get plan record
                var planResp = await authenticatedFetch(
                    SUPABASE_URL + '/rest/v1/submission_plans?id=eq.' + planId + '&select=*',
                    {}
                );

                if (!planResp.ok) throw new Error('Plan introuvable');
                var plans = await planResp.json();
                if (plans.length === 0) throw new Error('Plan introuvable');

                currentPlanRecord = plans[0];

                // Get signed URL
                var signResp = await authenticatedFetch(
                    SUPABASE_URL + '/storage/v1/object/sign/submission-plans/' + currentPlanRecord.file_path,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ expiresIn: 3600 })
                    }
                );

                if (!signResp.ok) throw new Error('Erreur de génération du lien');
                var signData = await signResp.json();

                currentPdfUrl = SUPABASE_URL + '/storage/v1' + signData.signedURL;

                // Write viewer HTML directly into the window (same origin — avoids blob:null CORS issues)
                var viewerHtml = createStandaloneViewer();
                newWindow.document.open();
                newWindow.document.write(viewerHtml);
                newWindow.document.close();

                // Send PDF data once the viewer scripts are loaded
                function trySendMessage() {
                    newWindow.postMessage({
                        type: 'INIT_PDF',
                        pdfUrl: currentPdfUrl,
                        planRecord: currentPlanRecord,
                        submissionId: currentSubmission.id,
                        supabaseUrl: SUPABASE_URL,
                        accessToken: localStorage.getItem('sb_access_token')
                    }, '*');
                }

                // Retry mechanism: send message multiple times until viewer ACKs
                var sendAttempts = 0;
                var sendInterval = setInterval(function() {
                    if (newWindow.closed) { clearInterval(sendInterval); return; }
                    trySendMessage();
                    sendAttempts++;
                    if (sendAttempts > 30) clearInterval(sendInterval); // stop after 15s
                }, 500);

                // Listen for ACK from viewer to stop retrying
                window.addEventListener('message', function ackHandler(e) {
                    if (e.data && e.data.type === 'PDF_VIEWER_ACK') {
                        clearInterval(sendInterval);
                        window.removeEventListener('message', ackHandler);
                    }
                });

                // Auto-close plans modal when PDF viewer window is closed
                var checkClosed = setInterval(function() {
                    if (newWindow.closed) {
                        clearInterval(checkClosed);
                        closePlansModal();
                    }
                }, 500);

            } catch (err) {
                console.error('PDF viewer error:', err);
                try {
                    newWindow.document.body.innerHTML = '<div style="color:#fff;padding:40px;font-family:sans-serif;">' +
                        '<h2>Erreur</h2><p>' + err.message + '</p></div>';
                } catch (e) { /* window might be closed */ }
            } finally {
                setPlanButtonLoading(planId, 'View', false);
            }
        }

        function closePdfViewer() {
            // Cancel any render in progress
            if (currentRenderTask) {
                try {
                    currentRenderTask.cancel();
                } catch (e) {
                    // Ignore
                }
                currentRenderTask = null;
            }

            document.getElementById('pdfViewerOverlay').classList.remove('active');
            // Don't reset pdfDoc - keep it in memory for captures
            // pdfDoc = null;
            // currentPdfUrl = null;
            // currentPlanRecord = null;
        }

        function openPdfInNewWindow() {
            if (!pdfDoc || !currentPlanRecord) {
                alert('Aucun PDF chargé');
                return;
            }

            // Create standalone viewer page
            var viewerHtml = createStandaloneViewer();
            var blob = new Blob([viewerHtml], { type: 'text/html' });
            var blobUrl = URL.createObjectURL(blob);

            // Open in new window
            var newWindow = window.open(blobUrl, '_blank', 'width=1200,height=800');

            if (!newWindow) {
                alert('Veuillez autoriser les fenêtres pop-up pour cette fonctionnalité.');
            } else {
                // Pass data to new window after it loads
                newWindow.addEventListener('load', function() {
                    newWindow.postMessage({
                        type: 'INIT_PDF',
                        pdfUrl: currentPdfUrl,
                        planRecord: currentPlanRecord,
                        submissionId: currentSubmission.id,
                        supabaseUrl: SUPABASE_URL,
                        accessToken: localStorage.getItem('sb_access_token')
                    }, '*');
                });
            }
        }

        function createStandaloneViewer() {
            var ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJwbHpidGpmbndhaHFvZHJocG55Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NDU2MDEsImV4cCI6MjA4NjIyMTYwMX0.OQAZhc029PbRDSe1b02NDAuOUE8yn-_h3QqSnUDpLeU';
            return '<!DOCTYPE html>' +
'<html><head><meta charset="utf-8"><title>Plan - ' + (currentPlanRecord ? currentPlanRecord.file_name : 'PDF') + '</title>' +
'<scr' + 'ipt src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></' + 'script>' +
'<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.css">' +
'<scr' + 'ipt src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.js"></' + 'script>' +
'<style>' +
'* { margin: 0; padding: 0; box-sizing: border-box; }' +
'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #2b2b2b; color: #fff; overflow: hidden; }' +
'.viewer-header { background: #1a1a1a; padding: 12px 16px; display: flex; align-items: center; gap: 16px; border-bottom: 1px solid #444; }' +
'.viewer-title { font-size: 14px; font-weight: 600; flex: 1; }' +
'.controls { display: flex; align-items: center; gap: 8px; }' +
'.btn { background: #3a3a3a; border: 1px solid #555; color: #fff; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 13px; font-family: inherit; }' +
'.btn:hover { background: #4a4a4a; }' +
'.btn:disabled { opacity: 0.5; cursor: not-allowed; }' +
'.page-info { font-size: 13px; color: #999; }' +
'.canvas-container { position: fixed; top: 60px; left: 0; right: 0; bottom: 0; overflow: auto; display: flex; justify-content: center; align-items: flex-start; padding: 20px; }' +
'canvas { box-shadow: 0 4px 24px rgba(0,0,0,0.5); background: #fff; }' +
'.overlay-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; z-index: 1000; }' +
'.overlay-modal.active { display: flex; }' +
'.modal-content { background: #2b2b2b; border-radius: 8px; padding: 24px; max-width: 500px; width: 90%; border: 1px solid #444; }' +
'.modal-title { font-size: 18px; margin-bottom: 16px; }' +
'.form-group { margin-bottom: 16px; }' +
'.form-label { display: block; font-size: 13px; margin-bottom: 6px; color: #aaa; }' +
'.form-input { width: 100%; padding: 10px; background: #1a1a1a; border: 1px solid #555; border-radius: 4px; color: #fff; font-family: inherit; font-size: 14px; }' +
'.modal-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px; }' +
'.status { margin-top: 12px; padding: 10px; border-radius: 4px; font-size: 13px; display: none; }' +
'.crop-box { background: #2b2b2b; border-radius: 8px; border: 1px solid #444; width: 90vw; max-width: 900px; max-height: 90vh; display: flex; flex-direction: column; overflow: hidden; }' +
'.crop-header { padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #444; }' +
'.crop-header .modal-title { margin-bottom: 0; }' +
'.crop-container { position: relative; flex: 1; min-height: 300px; max-height: 60vh; background: #222; overflow: hidden; }' +
'.crop-container img { display: block; max-width: 100%; }' +
'.crop-controls { padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #444; }' +
'.crop-ratios { display: flex; gap: 6px; }' +
'.ratio-btn { background: #3a3a3a; border: 1px solid #555; color: #fff; padding: 6px 14px; border-radius: 4px; cursor: pointer; font-size: 13px; }' +
'.ratio-btn:hover { background: #4a4a4a; }' +
'.ratio-btn.active { border-color: #0B1220; background: #0B1220; color: #fff; }' +
'.crop-actions { display: flex; gap: 8px; }' +
'.loading-screen { position: fixed; inset: 0; background: #2b2b2b; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 900; transition: opacity .4s ease; }' +
'.loading-screen.hidden { opacity: 0; pointer-events: none; }' +
'.loader-ring { width: 48px; height: 48px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.08); border-top-color: rgba(255,255,255,0.6); animation: spin 0.9s linear infinite; }' +
'@keyframes spin { to { transform: rotate(360deg); } }' +
'.loader-text { margin-top: 20px; font-size: 14px; color: rgba(255,255,255,0.45); letter-spacing: 0.5px; }' +
'.loader-bar { margin-top: 24px; width: 120px; height: 3px; border-radius: 2px; background: rgba(255,255,255,0.08); overflow: hidden; }' +
'.loader-bar-inner { height: 100%; width: 40%; border-radius: 2px; background: rgba(255,255,255,0.3); animation: slide 1.2s ease-in-out infinite; }' +
'@keyframes slide { 0% { transform: translateX(-100%); } 100% { transform: translateX(350%); } }' +
'</style></head><body>' +
'<div class="loading-screen" id="loadingScreen">' +
'  <div class="loader-ring"></div>' +
'  <div class="loader-text">Chargement du plan...</div>' +
'  <div class="loader-bar"><div class="loader-bar-inner"></div></div>' +
'</div>' +
'<div class="viewer-header">' +
'  <div class="viewer-title" id="title">Chargement...</div>' +
'  <div class="controls">' +
'    <button class="btn" id="btnPrev" onclick="navigate(-1)">\u25C0</button>' +
'    <span class="page-info" id="pageInfo">1 / 1</span>' +
'    <button class="btn" id="btnNext" onclick="navigate(1)">\u25B6</button>' +
'    <button class="btn" onclick="zoom(-0.25)">\u2212</button>' +
'    <span class="page-info" id="zoomInfo">100%</span>' +
'    <button class="btn" onclick="zoom(0.25)">+</button>' +
'    <button class="btn" onclick="rotate()">\u21BB</button>' +
'    <button class="btn" onclick="openCaptureModal()">\uD83D\uDCF8 Capturer</button>' +
'  </div>' +
'</div>' +
'<div class="canvas-container" id="canvasContainer"><canvas id="pdfCanvas"></canvas></div>' +
/* Capture modal — room selection */
'<div class="overlay-modal" id="captureModal">' +
'  <div class="modal-content">' +
'    <div class="modal-title">Capturer la page</div>' +
'    <div class="form-group"><label class="form-label">Pi\u00E8ce / Meuble</label><select class="form-input" id="roomSelect"><option value="">-- S\u00E9lectionnez --</option></select></div>' +
'    <div class="status" id="captureStatus"></div>' +
'    <div class="modal-actions"><button class="btn" onclick="closeCaptureModal()">Annuler</button><button class="btn" id="btnCapture" onclick="confirmCapture()">Capturer</button></div>' +
'  </div>' +
'</div>' +
/* Crop modal */
'<div class="overlay-modal" id="cropModal">' +
'  <div class="crop-box">' +
'    <div class="crop-header"><div class="modal-title">Recadrer l\\\'image</div><span id="cropDims" style="font-size:12px;color:#888;"></span></div>' +
'    <div class="crop-container" id="cropContainer"><img id="cropImage" src=""></div>' +
'    <div class="crop-controls">' +
'      <div class="crop-ratios">' +
'        <button class="ratio-btn active" onclick="setCropRatio(16/9,this)">16:9</button>' +
'        <button class="ratio-btn" onclick="setCropRatio(9/16,this)">9:16</button>' +
'        <button class="ratio-btn" onclick="setCropRatio(1,this)">1:1</button>' +
'      </div>' +
'      <div class="crop-actions">' +
'        <button class="btn" onclick="cancelCrop()">Annuler</button>' +
'        <button class="btn" id="btnCropConfirm" style="background:#0B1220;" onclick="confirmCrop()">Valider</button>' +
'      </div>' +
'    </div>' +
'    <div class="status" id="cropStatus" style="margin:0 20px 16px;"></div>' +
'  </div>' +
'</div>' +
'<scr' + 'ipt>' +
'pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";' +
'var pdfDoc = null, currentPage = 1, totalPages = 0, scale = 1.0, rotation = 0;' +
'var planRecord = null, submissionId = null, supabaseUrl = null, accessToken = null;' +
'var ANON_KEY = "' + ANON_KEY + '";' +
'var cropper = null, capturedBlob = null, selectedRoomId = null, cropRatioLabel = "16:9";' +

/* INIT via postMessage */
'var pdfInitialized = false;' +
'window.addEventListener("message", async function(e) {' +
'  if (e.data.type === "INIT_PDF" && !pdfInitialized) {' +
'    pdfInitialized = true;' +
'    if (e.source) e.source.postMessage({ type: "PDF_VIEWER_ACK" }, "*");' +
'    planRecord = e.data.planRecord; submissionId = e.data.submissionId; supabaseUrl = e.data.supabaseUrl; accessToken = e.data.accessToken;' +
'    document.getElementById("title").textContent = planRecord.file_name;' +
'    try {' +
'      var loadingTask = pdfjsLib.getDocument(e.data.pdfUrl);' +
'      pdfDoc = await loadingTask.promise; totalPages = pdfDoc.numPages; await render(); await loadRooms();' +
'      var ls = document.getElementById("loadingScreen"); ls.classList.add("hidden"); setTimeout(function() { ls.remove(); }, 500);' +
'    } catch (err) {' +
'      console.error("PDF load error:", err);' +
'      document.getElementById("loadingScreen").innerHTML = "<div style=\\"color:#fff;padding:40px;text-align:center;\\"><h2>Erreur de chargement</h2><p>" + err.message + "</p><p style=\\"margin-top:16px;color:#999;font-size:13px;\\">V\\u00e9rifiez que le fichier PDF existe dans le stockage.</p></div>";' +
'    }' +
'  }' +
'});' +

/* PDF rendering */
'async function render() {' +
'  if (!pdfDoc) return;' +
'  var page = await pdfDoc.getPage(currentPage);' +
'  var canvas = document.getElementById("pdfCanvas"); var ctx = canvas.getContext("2d");' +
'  var viewport = page.getViewport({ scale: scale, rotation: rotation });' +
'  canvas.width = viewport.width; canvas.height = viewport.height;' +
'  await page.render({ canvasContext: ctx, viewport: viewport }).promise;' +
'  document.getElementById("pageInfo").textContent = currentPage + " / " + totalPages;' +
'  document.getElementById("zoomInfo").textContent = Math.round(scale * 100) + "%";' +
'  document.getElementById("btnPrev").disabled = currentPage <= 1; document.getElementById("btnNext").disabled = currentPage >= totalPages;' +
'}' +
'function navigate(d) { currentPage += d; if (currentPage < 1) currentPage = 1; if (currentPage > totalPages) currentPage = totalPages; render(); }' +
'function zoom(d) { scale += d; if (scale < 0.5) scale = 0.5; if (scale > 3.0) scale = 3.0; render(); }' +
'function rotate() { rotation = (rotation + 90) % 360; render(); }' +
'var scrollCooldown = false;' +
'document.getElementById("canvasContainer").addEventListener("wheel", function(e) {' +
'  if (e.ctrlKey) { e.preventDefault(); zoom(e.deltaY > 0 ? -0.1 : 0.1); return; }' +
'  if (scrollCooldown) return;' +
'  var threshold = 30;' +
'  if (Math.abs(e.deltaY) < threshold) return;' +
'  if (e.deltaY > 0 && currentPage < totalPages) { navigate(1); scrollCooldown = true; setTimeout(function() { scrollCooldown = false; }, 300); }' +
'  else if (e.deltaY < 0 && currentPage > 1) { navigate(-1); scrollCooldown = true; setTimeout(function() { scrollCooldown = false; }, 300); }' +
'}, { passive: false });' +

/* Ctrl+drag pan (hand tool like Adobe) */
'var isPanning = false, panStartX = 0, panStartY = 0, scrollStartX = 0, scrollStartY = 0;' +
'var cc = document.getElementById("canvasContainer");' +
'cc.addEventListener("mousedown", function(e) {' +
'  if (e.ctrlKey && e.button === 0) { e.preventDefault(); isPanning = true; panStartX = e.clientX; panStartY = e.clientY; scrollStartX = cc.scrollLeft; scrollStartY = cc.scrollTop; cc.style.cursor = "grabbing"; }' +
'});' +
'window.addEventListener("mousemove", function(e) {' +
'  if (!isPanning) return; cc.scrollLeft = scrollStartX - (e.clientX - panStartX); cc.scrollTop = scrollStartY - (e.clientY - panStartY);' +
'});' +
'window.addEventListener("mouseup", function() { if (isPanning) { isPanning = false; cc.style.cursor = ""; } });' +
'document.addEventListener("keydown", function(e) { if (e.key === "Control") cc.style.cursor = "grab"; });' +
'document.addEventListener("keyup", function(e) { if (e.key === "Control" && !isPanning) cc.style.cursor = ""; });' +

/* Load rooms dropdown */
'async function loadRooms() {' +
'  try {' +
'    var r = await fetch(supabaseUrl + "/rest/v1/project_rooms?submission_id=eq." + submissionId + "&select=id,name&order=sort_order.asc", { headers: { "apikey": ANON_KEY, "Authorization": "Bearer " + accessToken } });' +
'    var rooms = await r.json(); var sel = document.getElementById("roomSelect");' +
'    rooms.forEach(function(rm) { var opt = document.createElement("option"); opt.value = rm.id; opt.textContent = rm.name; sel.appendChild(opt); });' +
'  } catch (e) { console.error(e); }' +
'}' +

/* Capture modal */
'function openCaptureModal() { document.getElementById("captureModal").classList.add("active"); refreshRooms(); }' +
'async function refreshRooms() {' +
'  var sel = document.getElementById("roomSelect"); var prev = sel.value;' +
'  sel.innerHTML = "<option value=\\"\\">-- S\\u00E9lectionnez --</option>";' +
'  await loadRooms();' +
'  if (prev) sel.value = prev;' +
'}' +
'function closeCaptureModal() { document.getElementById("captureModal").classList.remove("active"); document.getElementById("captureStatus").style.display = "none"; }' +

/* Step 1: confirmCapture — render page then open crop */
'async function confirmCapture() {' +
'  selectedRoomId = document.getElementById("roomSelect").value;' +
'  if (!selectedRoomId) { alert("S\\u00E9lectionnez une pi\\u00E8ce"); return; }' +
'  var status = document.getElementById("captureStatus"); var btn = document.getElementById("btnCapture");' +
'  status.style.display = "block"; status.style.background = "#e3f2fd"; status.style.color = "#1565c0"; status.textContent = "Capture haute r\\u00E9solution...";' +
'  btn.disabled = true;' +
'  try {' +
'    var page = await pdfDoc.getPage(currentPage);' +
'    var viewport = page.getViewport({ scale: 3.0, rotation: rotation });' +
'    var canvas = document.createElement("canvas"); canvas.width = viewport.width; canvas.height = viewport.height;' +
'    await page.render({ canvasContext: canvas.getContext("2d"), viewport: viewport }).promise;' +
'    capturedBlob = await new Promise(function(res) { canvas.toBlob(function(b) { res(b); }, "image/jpeg", 0.9); });' +
'    closeCaptureModal();' +
'    openCropModal(capturedBlob);' +
'  } catch (e) { console.error(e); status.style.background = "#ffebee"; status.style.color = "#c62828"; status.textContent = "Erreur: " + e.message; }' +
'  finally { btn.disabled = false; }' +
'}' +

/* Step 2: Crop modal */
'function openCropModal(blob) {' +
'  var url = URL.createObjectURL(blob);' +
'  var imgEl = document.getElementById("cropImage");' +
'  var testImg = new Image();' +
'  testImg.onload = function() {' +
'    document.getElementById("cropDims").textContent = testImg.width + " \\u00D7 " + testImg.height + " px";' +
'    imgEl.src = url;' +
'    document.getElementById("cropModal").classList.add("active");' +
'    if (cropper) { cropper.destroy(); cropper = null; }' +
'    cropper = new Cropper(imgEl, { aspectRatio: 16/9, viewMode: 1, autoCropArea: 1, responsive: true, background: false, dragMode: "move", cropBoxMovable: false, cropBoxResizable: false, toggleDragModeOnDblclick: false });' +
'    cropRatioLabel = "16:9";' +
'    document.querySelectorAll(".ratio-btn").forEach(function(b) { b.classList.remove("active"); });' +
'    document.querySelector(".ratio-btn").classList.add("active");' +
'  };' +
'  testImg.src = url;' +
'}' +

'function setCropRatio(ratio, btn) {' +
'  if (cropper) cropper.setAspectRatio(ratio);' +
'  cropRatioLabel = ratio === 1 ? "1:1" : (ratio < 1 ? "9:16" : "16:9");' +
'  document.querySelectorAll(".ratio-btn").forEach(function(b) { b.classList.remove("active"); });' +
'  btn.classList.add("active");' +
'}' +

'function cancelCrop() {' +
'  document.getElementById("cropModal").classList.remove("active");' +
'  if (cropper) { cropper.destroy(); cropper = null; }' +
'  document.getElementById("cropImage").src = "";' +
'  document.getElementById("cropStatus").style.display = "none";' +
'}' +

/* Step 3: confirmCrop — upload original + cropped */
'async function confirmCrop() {' +
'  if (!cropper || !capturedBlob || !selectedRoomId) return;' +
'  var confirmBtn = document.getElementById("btnCropConfirm");' +
'  var status = document.getElementById("cropStatus");' +
'  confirmBtn.disabled = true; confirmBtn.textContent = "Upload...";' +
'  status.style.display = "block"; status.style.background = "#e3f2fd"; status.style.color = "#1565c0"; status.textContent = "Upload en cours...";' +
'  try {' +
'    var croppedCanvas = cropper.getCroppedCanvas({ maxWidth: 2048, maxHeight: 2048, imageSmoothingQuality: "high" });' +
'    var cropData = cropper.getData(true);' +
'    var croppedBlob = await new Promise(function(res) { croppedCanvas.toBlob(function(b) { res(b); }, "image/jpeg", 0.88); });' +
'    var ts = Date.now();' +
'    var headers = { "apikey": ANON_KEY, "Authorization": "Bearer " + accessToken };' +

/* Upload original to room-images */
'    var origPath = "originals/" + selectedRoomId + "/" + ts + ".jpg";' +
'    var origResp = await fetch(supabaseUrl + "/storage/v1/object/room-images/" + origPath, { method: "POST", headers: Object.assign({}, headers, { "Content-Type": "image/jpeg", "x-upsert": "true" }), body: capturedBlob });' +
'    if (!origResp.ok) throw new Error("Upload original: " + origResp.status);' +
'    var originalUrl = supabaseUrl + "/storage/v1/object/public/room-images/" + origPath;' +

/* Upload cropped to room-images */
'    status.textContent = "Upload recadrage...";' +
'    var ratioFile = cropRatioLabel.replace(":", "x");' +
'    var cropPath = "cropped/" + selectedRoomId + "/" + ts + "_" + ratioFile + ".jpg";' +
'    var cropResp = await fetch(supabaseUrl + "/storage/v1/object/room-images/" + cropPath, { method: "POST", headers: Object.assign({}, headers, { "Content-Type": "image/jpeg", "x-upsert": "true" }), body: croppedBlob });' +
'    if (!cropResp.ok) throw new Error("Upload crop: " + cropResp.status);' +
'    var croppedUrl = supabaseUrl + "/storage/v1/object/public/room-images/" + cropPath;' +

/* Insert room_media record (same schema as calculateur) */
'    status.textContent = "Enregistrement...";' +
'    var meta = { type: "pdf_plan", plan_id: planRecord.id, page_number: currentPage, pdf_filename: planRecord.file_name, pdf_version: planRecord.version_number, captured_at: new Date().toISOString(), scale: 3.0 };' +
'    var insResp = await fetch(supabaseUrl + "/rest/v1/room_media", { method: "POST", headers: Object.assign({}, headers, { "Content-Type": "application/json", "Prefer": "return=representation" }), body: JSON.stringify({ room_id: selectedRoomId, original_url: originalUrl, cropped_url: croppedUrl, crop_ratio: cropRatioLabel, crop_data: cropData, tags: ["presentation_soumission"], source_metadata: meta }) });' +
'    if (!insResp.ok) throw new Error("Insert record: " + insResp.status);' +
'    var inserted = await insResp.json();' +
'    var newMediaId = Array.isArray(inserted) ? inserted[0].id : inserted.id;' +

'    status.style.background = "#e8f5e9"; status.style.color = "#2e7d32"; status.textContent = "\\u2713 Capture r\\u00E9ussie!";' +
'    if (window.opener) { window.opener.postMessage({ type: "PLAN_CAPTURE_DONE", roomId: selectedRoomId, croppedUrl: croppedUrl, originalUrl: originalUrl, cropRatio: cropRatioLabel, mediaId: newMediaId }, "*"); }' +
'    setTimeout(cancelCrop, 1500);' +
'  } catch (e) {' +
'    console.error(e); status.style.background = "#ffebee"; status.style.color = "#c62828"; status.textContent = "Erreur: " + e.message;' +
'  } finally { confirmBtn.disabled = false; confirmBtn.textContent = "Valider"; }' +
'}' +
'</' + 'script></body></html>';
        }

        async function renderPdfPage() {
            if (!pdfDoc) return;

            // Cancel previous render if still in progress
            if (currentRenderTask) {
                try {
                    currentRenderTask.cancel();
                } catch (e) {
                    // Ignore cancel errors
                }
                currentRenderTask = null;
            }

            try {
                var page = await pdfDoc.getPage(pdfCurrentPage);
                var canvas = document.getElementById('pdfCanvas');
                var ctx = canvas.getContext('2d');

                var viewport = page.getViewport({ scale: pdfScale, rotation: pdfRotation });

                // Update zoom info immediately for better UX
                document.getElementById('pdfZoomInfo').textContent = Math.round(pdfScale * 100) + '%';

                // Only update canvas dimensions if they changed (prevents flickering)
                if (canvas.width !== viewport.width || canvas.height !== viewport.height) {
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                }

                var renderContext = {
                    canvasContext: ctx,
                    viewport: viewport
                };

                // Store render task so we can cancel it if needed
                currentRenderTask = page.render(renderContext);
                await currentRenderTask.promise;
                currentRenderTask = null;

                // Update UI
                document.getElementById('pdfPageInfo').textContent = pdfCurrentPage + ' / ' + pdfTotalPages;

                // Update prev/next buttons
                document.getElementById('btnPdfPrev').disabled = (pdfCurrentPage <= 1);
                document.getElementById('btnPdfNext').disabled = (pdfCurrentPage >= pdfTotalPages);

                // Update active thumbnail
                var thumbs = document.querySelectorAll('.pdf-thumb');
                for (var i = 0; i < thumbs.length; i++) {
                    thumbs[i].classList.remove('active');
                }
                var activeThumb = document.querySelector('.pdf-thumb[data-page="' + pdfCurrentPage + '"]');
                if (activeThumb) activeThumb.classList.add('active');
            } catch (err) {
                // Ignore render cancellation errors
                if (err.name === 'RenderingCancelledException') {
                    console.log('PDF render cancelled');
                } else {
                    console.error('PDF render error:', err);
                }
            }
        }

        async function renderPdfThumbnails() {
            if (!pdfDoc) return;

            var container = document.getElementById('pdfThumbnails');
            container.innerHTML = '';

            for (var pageNum = 1; pageNum <= pdfTotalPages; pageNum++) {
                var page = await pdfDoc.getPage(pageNum);
                var viewport = page.getViewport({ scale: 0.3 });

                var thumbDiv = document.createElement('div');
                thumbDiv.className = 'pdf-thumb';
                thumbDiv.setAttribute('data-page', pageNum);
                thumbDiv.onclick = (function(num) {
                    return function() { pdfGoToPage(num); };
                })(pageNum);

                var canvas = document.createElement('canvas');
                canvas.width = viewport.width;
                canvas.height = viewport.height;

                var ctx = canvas.getContext('2d');
                await page.render({
                    canvasContext: ctx,
                    viewport: viewport
                }).promise;

                var label = document.createElement('div');
                label.className = 'pdf-thumb-label';
                label.textContent = pageNum;

                thumbDiv.appendChild(canvas);
                thumbDiv.appendChild(label);
                container.appendChild(thumbDiv);
            }

            // Mark first as active
            var firstThumb = container.querySelector('.pdf-thumb[data-page="1"]');
            if (firstThumb) firstThumb.classList.add('active');
        }

        function pdfNavigate(delta) {
            pdfCurrentPage += delta;
            if (pdfCurrentPage < 1) pdfCurrentPage = 1;
            if (pdfCurrentPage > pdfTotalPages) pdfCurrentPage = pdfTotalPages;
            renderPdfPage();
        }

        function pdfGoToPage(pageNum) {
            pdfCurrentPage = pageNum;
            renderPdfPage();
        }

        function pdfZoom(delta) {
            pdfScale += delta;
            if (pdfScale < 0.5) pdfScale = 0.5;
            if (pdfScale > 3.0) pdfScale = 3.0;
            renderPdfPage();
        }

        function pdfResetZoom() {
            pdfScale = 1.0;
            renderPdfPage();
        }

        function pdfRotate() {
            pdfRotation = (pdfRotation + 90) % 360;
            renderPdfPage();
        }

        // ═══════════════════════════════════════════════════════════════════════
        // Capture PDF Page → Room Media
        // ═══════════════════════════════════════════════════════════════════════
        var capturedImageBlob = null;

        async function capturePdfPage() {
            if (!currentSubmission) {
                alert('Aucune soumission ouverte');
                return;
            }

            // Load rooms and open modal
            await loadRoomsForCapture();
            document.getElementById('captureRoomModal').classList.add('active');
        }

        async function loadRoomsForCapture() {
            var select = document.getElementById('captureRoomSelect');
            select.innerHTML = '<option value="">-- Sélectionnez --</option>';

            if (!currentSubmission) return;

            try {
                var response = await authenticatedFetch(
                    SUPABASE_URL + '/rest/v1/project_rooms?submission_id=eq.' + currentSubmission.id + '&select=id,name&order=sort_order.asc',
                    {}
                );

                if (!response.ok) throw new Error('Erreur de chargement des pièces');

                var rooms = await response.json();

                for (var i = 0; i < rooms.length; i++) {
                    var option = document.createElement('option');
                    option.value = rooms[i].id;
                    option.textContent = rooms[i].name;
                    select.appendChild(option);
                }

            } catch (err) {
                console.error('Error loading rooms:', err);
                alert('Erreur de chargement des pièces');
            }
        }

        function closeCaptureRoomModal() {
            document.getElementById('captureRoomModal').classList.remove('active');
            capturedImageBlob = null;
            document.getElementById('captureStatus').style.display = 'none';
        }

        async function confirmCapture() {
            var roomId = document.getElementById('captureRoomSelect').value;
            if (!roomId) {
                alert('Veuillez sélectionner une pièce');
                return;
            }

            // Validate PDF is loaded
            if (!pdfDoc || !currentPlanRecord) {
                alert('Erreur: Le PDF n\'est pas chargé correctement. Veuillez fermer et rouvrir le PDF.');
                return;
            }

            // Find the groupId from roomId (reverse lookup of roomMap)
            var targetGroupId = null;
            for (var gId in roomMap) {
                if (roomMap[gId] === roomId) { targetGroupId = gId; break; }
            }
            if (!targetGroupId) {
                alert('Erreur: Pièce introuvable dans le calculateur');
                return;
            }

            var status = document.getElementById('captureStatus');
            var btn = document.getElementById('btnConfirmCapture');

            try {
                btn.disabled = true;
                status.style.display = 'block';
                status.style.background = '#e3f2fd';
                status.style.color = '#1565c0';
                status.textContent = 'Capture en cours...';

                // Render page at high resolution (scale=3 for ~300 DPI)
                var page = await pdfDoc.getPage(pdfCurrentPage);
                var viewport = page.getViewport({ scale: 3.0, rotation: pdfRotation });

                var canvas = document.createElement('canvas');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                var ctx = canvas.getContext('2d');

                await page.render({ canvasContext: ctx, viewport: viewport }).promise;

                status.textContent = 'Compression de l\'image...';

                var blob = await new Promise(function(resolve) {
                    canvas.toBlob(function(b) { resolve(b); }, 'image/jpeg', 0.85);
                });

                // Close the capture modal and open the crop modal
                closeCaptureRoomModal();

                // Store source metadata for the upload
                var sourceMetadata = {
                    type: 'pdf_plan',
                    plan_id: currentPlanRecord.id,
                    page_number: pdfCurrentPage,
                    pdf_filename: currentPlanRecord.file_name,
                    pdf_version: currentPlanRecord.version_number,
                    captured_at: new Date().toISOString(),
                    scale: 3.0
                };

                // Open the main crop modal — reuses existing crop + upload flow
                openCropModal(blob, targetGroupId);
                cropState.sourceMetadata = sourceMetadata;

            } catch (err) {
                console.error('Capture error:', err);
                status.style.background = '#ffebee';
                status.style.color = '#c62828';
                status.textContent = 'Erreur: ' + err.message;
                btn.disabled = false;
            }
        }

        // toggleClientView removed — Présentation handles client mode directly

        async function toggleLang() {
            var btn = document.getElementById('btnLang');
            if (currentLang === 'fr') {
                // Switching to EN — check if translation needed
                var stale = collectStaleFrTexts();
                if (stale.length > 0) {
                    if (btn) { btn.disabled = true; btn.textContent = 'Traduction...'; }
                    try {
                        var results = await callEdgeFunction(stale, 'translate');
                        applyTranslations(results);
                        showSaveIndicator();
                    } catch (err) {
                        console.error('Translation error:', err);
                        var tMsg = err.message || '';
                        if (/overload/i.test(tMsg) || /529/.test(tMsg)) tMsg = 'Le service AI est temporairement surchargé. Réessayez dans quelques secondes.';
                        steleAlert(tMsg, 'Erreur de traduction');
                        if (btn) { btn.disabled = false; btn.textContent = 'EN'; }
                        return; // stay on FR
                    }
                }
                currentLang = 'en';
            } else {
                currentLang = 'fr';
            }
            if (btn) {
                btn.textContent = currentLang === 'fr' ? 'EN' : 'FR';
                btn.classList.toggle('active', currentLang === 'en');
                btn.disabled = false;
            }
            renderPreview();
        }

        // Collect only FR texts that have no EN translation (stale or missing)
        function collectStaleFrTexts() {
            var texts = [];
            var groups = document.querySelectorAll('#calculatorView .furniture-group');
            groups.forEach(function(g) {
                var gid = g.id;
                if (roomDescEN[gid]) return; // already has EN translation
                var frText;
                if (roomDescHTML[gid]) {
                    frText = roomDescHTML[gid];
                } else {
                    var descEl = document.getElementById(gid + '-clientDesc');
                    frText = descEl ? descEl.value.trim() : '';
                }
                if (frText) {
                    texts.push({ key: 'room_' + gid, text: frText });
                }
            });
            var clauses = getSubmissionClauses();
            clauses.forEach(function(c, i) {
                if (c.content && c.content.trim() && !c.content_en) {
                    texts.push({ key: 'clause_' + i, text: c.content });
                }
            });
            // Intro page paragraphs
            ['presentation_intro_text_1', 'presentation_intro_text_2', 'presentation_intro_text_3'].forEach(function(k) {
                var fr = introConfig[k] || '';
                if (fr && !introConfigEN[k]) {
                    texts.push({ key: k, text: fr });
                }
            });
            return texts;
        }

        // Apply translation results to memory + DB
        function applyTranslations(results) {
            var groups = document.querySelectorAll('#calculatorView .furniture-group');
            groups.forEach(function(g) {
                var gid = g.id;
                var key = 'room_' + gid;
                if (results[key]) {
                    roomDescEN[gid] = results[key];
                    if (roomMap[gid]) {
                        updateRoom(roomMap[gid], { client_description_en: results[key] });
                    }
                }
            });
            var clauses = getSubmissionClauses();
            var updated = clauses.slice();
            var changed = false;
            clauses.forEach(function(c, i) {
                var key = 'clause_' + i;
                if (results[key]) {
                    updated[i].content_en = results[key];
                    changed = true;
                }
            });
            if (changed) saveSubmissionClauses(updated);
            // Intro page paragraphs
            ['presentation_intro_text_1', 'presentation_intro_text_2', 'presentation_intro_text_3'].forEach(function(k) {
                if (results[k]) introConfigEN[k] = results[k];
            });
        }

        // ── Edge Function helper ──
        async function callEdgeFunction(texts, action) {
            console.log('[AI] Calling edge function:', action, 'with', texts.length, 'texts');
            var resp = await authenticatedFetch(SUPABASE_URL + '/functions/v1/translate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ texts: texts, action: action })
            });
            if (!resp.ok) {
                var errText = await resp.text().catch(function() { return ''; });
                console.error('[AI] Edge function error:', resp.status, errText);
                try { var errObj = JSON.parse(errText); throw new Error(errObj.error || 'Erreur ' + resp.status); }
                catch(e) { if (e.message) throw e; throw new Error('Erreur ' + resp.status + ': ' + errText.substring(0, 200)); }
            }
            var data = await resp.json();
            console.log('[AI] Edge function response:', JSON.stringify(data).substring(0, 500));
            if (!data.translations || Object.keys(data.translations).length === 0) {
                throw new Error('Aucun résultat retourné par l\'AI');
            }
            return data.translations;
        }

        // ── AI Generate / Revise client description ──
        async function aiGenerateDescription(groupId) {
            var btn = document.getElementById(groupId + '-aiDesc');
            if (!btn) return;
            var textarea = document.getElementById(groupId + '-clientDesc');
            if (!textarea) return;

            var existingHTML = roomDescHTML[groupId] || '';
            var existingText = textarea.value.trim();
            var detail = collectRoomDetail(groupId);
            if (!detail) return;

            var prompt = '';
            var itemLines = '';
            detail.items.forEach(function(item) {
                itemLines += '- ' + item.description + ' (x' + item.qty + ')';
                if (item.catalogueId) {
                    var catItem = CATALOGUE_DATA.find(function(c) { return c.id === item.catalogueId; });
                    if (catItem && catItem.client_text) itemLines += ' [client: ' + catItem.client_text + ']';
                    if (catItem && catItem.presentation_rule_human) itemLines += ' [règle: ' + catItem.presentation_rule_human + ']';
                }
                if (item.tag) itemLines += ' [tag: ' + item.tag + ']';
                itemLines += '\n';
            });
            if (!itemLines) itemLines = '(aucun article)\n';

            if (existingText || existingHTML) {
                var textToRevise = existingHTML || existingText;
                prompt = '<context>\nPièce : ' + detail.name + '\nArticles :\n' + itemLines + '</context>\n\n';
                prompt += 'Révise et améliore cette description client existante :\n' + textToRevise;
            } else {
                prompt = '<context>\nPièce : ' + detail.name + '\n';
                prompt += 'Installation incluse : ' + (detail.installationIncluded ? 'oui' : 'non') + '\n';
                prompt += 'Articles :\n' + itemLines + '</context>\n\n';
                prompt += 'Génère une description client complète pour cette pièce à partir des articles listés.';
            }

            btn.disabled = true;
            btn.classList.add('ai-active');

            try {
                var results = await callEdgeFunction([{ key: 'desc', text: prompt }], 'calculateur_description');
                if (results['desc']) {
                    var html = results['desc'];
                    roomDescHTML[groupId] = html;
                    textarea.value = htmlToText(html);
                    refreshDescriptionDisplay(groupId);
                    roomDescEN[groupId] = '';
                    if (roomMap[groupId]) {
                        authenticatedFetch(SUPABASE_URL + '/rest/v1/project_rooms?id=eq.' + roomMap[groupId], {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                            body: JSON.stringify({ client_description: html, client_description_en: '' })
                        });
                    }
                    showSaveIndicator();
                }
            } catch (err) {
                var msg = err.message || '';
                if (/overload/i.test(msg) || /529/.test(msg)) msg = 'Le service AI est temporairement surcharg\u00e9. R\u00e9essayez dans quelques secondes.';
                steleAlert(msg, 'Erreur AI');
            } finally {
                btn.disabled = false;
                btn.classList.remove('ai-active');
            }
        }

        // ── Collect all FR texts (useHtml=true sends HTML for translate, plain for optimize) ──
        function collectFrTexts(useHtml) {
            var texts = [];
            var groups = document.querySelectorAll('#calculatorView .furniture-group');
            groups.forEach(function(g) {
                var gid = g.id;
                var frText;
                if (useHtml && roomDescHTML[gid]) {
                    frText = roomDescHTML[gid]; // HTML for translation
                } else {
                    var descEl = document.getElementById(gid + '-clientDesc');
                    frText = descEl ? descEl.value.trim() : '';
                }
                if (frText) {
                    texts.push({ key: 'room_' + gid, text: frText });
                }
            });
            var clauses = getSubmissionClauses();
            clauses.forEach(function(c, i) {
                if (c.content && c.content.trim()) {
                    texts.push({ key: 'clause_' + i, text: c.content });
                }
            });
            return texts;
        }

        // ── Optimiser tout (FR) ──
        async function optimizeAll() {
            var btn = document.getElementById('btnOptimizeAll');
            if (!btn) return;
            var origText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Optimisation...';

            try {
                var texts = collectFrTexts();
                if (texts.length === 0) { showSaveIndicator(); return; }

                var results = await callEdgeFunction(texts, 'optimize');
                var groups = document.querySelectorAll('#calculatorView .furniture-group');

                // Apply optimized room descriptions (HTML)
                groups.forEach(function(g) {
                    var gid = g.id;
                    var key = 'room_' + gid;
                    if (results[key]) {
                        // Store HTML in memory
                        roomDescHTML[gid] = results[key];
                        if (roomMap[gid]) {
                            updateRoom(roomMap[gid], { client_description: results[key], client_description_en: '' });
                        }
                        // Sync calc textarea + display with plain text
                        var calcDesc = document.getElementById(gid + '-clientDesc');
                        if (calcDesc) { calcDesc.value = htmlToText(results[key]); refreshDescriptionDisplay(gid); }
                        // Clear stale EN
                        roomDescEN[gid] = '';
                    }
                });

                // Apply optimized clause texts
                var clauses = getSubmissionClauses();
                var updated = clauses.slice();
                var changed = false;
                clauses.forEach(function(c, i) {
                    var key = 'clause_' + i;
                    if (results[key]) {
                        updated[i].content = results[key];
                        updated[i].content_en = ''; // clear stale EN
                        changed = true;
                    }
                });
                if (changed) await saveSubmissionClauses(updated);

                showSaveIndicator();
                renderPreview();
            } catch (err) {
                console.error('Optimize error:', err);
                var msg = err.message || '';
                if (/overload/i.test(msg) || /529/.test(msg)) msg = 'Le service AI est temporairement surchargé. Réessayez dans quelques secondes.';
                steleAlert(msg, 'Erreur d\'optimisation');
            } finally {
                btn.disabled = false;
                btn.textContent = origText;
            }
        }

        // ── Optimiser un seul champ (bouton ✨ par champ) ──
        async function optimizeText(btnEl) {
            var gid = btnEl.getAttribute('data-group-id');
            if (!gid) return;
            var descDiv = btnEl.parentElement.querySelector('.pv-page-room-desc');
            if (!descDiv || !descDiv.textContent.trim()) return;

            btnEl.disabled = true;
            var origText = btnEl.textContent;
            btnEl.textContent = '...';

            try {
                // Send plain text to AI, receive HTML back
                var results = await callEdgeFunction(
                    [{ key: 'room_' + gid, text: descDiv.textContent }],
                    'optimize'
                );
                var optimized = results['room_' + gid];
                console.log('[AI] Optimize result for', gid, ':', optimized ? optimized.substring(0, 200) : 'EMPTY');
                if (optimized) {
                    // Save optimized HTML to memory + DB
                    roomDescHTML[gid] = optimized;
                    if (roomMap[gid]) {
                        updateRoom(roomMap[gid], { client_description: optimized, client_description_en: '' });
                    }
                    // Sync calculator textarea + display
                    var descTA = document.getElementById(gid + '-clientDesc');
                    if (descTA) { descTA.value = htmlToText(optimized); refreshDescriptionDisplay(gid); }
                    // Clear stale EN
                    roomDescEN[gid] = '';
                    showSaveIndicator();
                    // Re-render to show optimized HTML
                    renderPreview();
                } else {
                    alert('L\'AI n\'a retourné aucun texte. Vérifiez la console (F12).');
                }
            } catch (err) {
                console.error('Optimize error:', err);
                var oMsg = err.message || '';
                if (/overload/i.test(oMsg) || /529/.test(oMsg)) oMsg = 'Le service AI est temporairement surchargé. Réessayez dans quelques secondes.';
                steleAlert(oMsg, 'Erreur d\'optimisation');
            } finally {
                btnEl.disabled = false;
                btnEl.textContent = origText;
            }
        }

        // ── Traduire tout (FR → EN) ──

        function removePreviewImage(groupId, index) {
            removeGroupImage(groupId, index);
            renderPreview();
        }

        // ── Clause Library CRUD ──

        async function loadClauseLibrary() {
            try {
                var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/quote_clauses?order=sort_order.asc,title.asc&select=*', {});
                if (r.ok) clauseLibrary = await r.json();
            } catch (e) { console.error('loadClauseLibrary error:', e); }
        }

        function renderClauseLibrary() {
            var container = document.getElementById('pvClauseList');
            if (!container) return;

            if (clauseLibrary.length === 0) {
                container.innerHTML = '<p class="pv-clause-empty">Aucune clause dans la biblioth\u00e8que. Cliquez + pour en cr\u00e9er.</p>';
                return;
            }

            var html = '';
            clauseLibrary.forEach(function(clause, idx) {
                html += '<div class="pv-clause-item" draggable="true" data-clause-idx="' + idx + '"';
                html += ' ondragstart="onClauseDragStart(event, ' + idx + ')">';
                html += '<div class="pv-clause-item-header">';
                html += '<span class="pv-clause-item-title">' + escapeHtml(clause.title) + '</span>';
                html += '<span class="pv-clause-item-btns">';
                html += '<button class="pv-clause-item-btn add-to-sub" onclick="event.stopPropagation(); addClauseToSubmission(' + idx + ')" title="Ajouter \u00e0 la soumission">+</button>';
                html += '<button class="pv-clause-item-btn" onclick="showClauseEditor(\'' + clause.id + '\')" title="Modifier">\u270E</button>';
                html += '<button class="pv-clause-item-btn delete" onclick="deleteLibraryClause(\'' + clause.id + '\')" title="Supprimer">\u2715</button>';
                html += '</span>';
                html += '</div>';
                var preview = (clause.content_fr || '').substring(0, 120);
                if (preview) html += '<div class="pv-clause-item-preview">' + escapeHtml(preview) + '</div>';
                html += '</div>';
            });
            container.innerHTML = html;
        }

        function showClauseEditor(clauseId) {
            var zone = document.getElementById('pvClauseEditZone');
            if (!zone) return;

            var clause = clauseId ? clauseLibrary.find(function(c) { return c.id === clauseId; }) : null;
            var isNew = !clause;

            zone.innerHTML = '<div class="pv-clause-edit">' +
                '<label>Titre</label>' +
                '<input type="text" id="ceTitle" value="' + escapeAttr(clause ? clause.title : '') + '" placeholder="Ex: Dessins d\'atelier">' +
                '<label>Contenu</label>' +
                '<textarea id="ceFr" rows="5" placeholder="Texte de la clause...">' + escapeHtml(clause ? clause.content_fr : '') + '</textarea>' +
                '<div class="pv-clause-edit-btns">' +
                '<button class="cancel" onclick="closeClauseEditor()">Annuler</button>' +
                '<button class="save" onclick="saveLibraryClause(' + (isNew ? 'null' : "'" + clauseId + "'") + ')">' + (isNew ? 'Cr\u00e9er' : 'Sauvegarder') + '</button>' +
                '</div></div>';

            zone.querySelector('#ceTitle').focus();
        }

        function closeClauseEditor() {
            var zone = document.getElementById('pvClauseEditZone');
            if (zone) zone.innerHTML = '';
        }

        async function saveLibraryClause(clauseId) {
            var title = document.getElementById('ceTitle').value.trim();
            var fr = document.getElementById('ceFr').value.trim();
            if (!title) { document.getElementById('ceTitle').focus(); return; }

            var payload = { title: title, content_fr: fr };

            try {
                var r;
                if (clauseId) {
                    r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/quote_clauses?id=eq.' + clauseId, {
                        method: 'PATCH', headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                        body: JSON.stringify(payload)
                    });
                } else {
                    r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/quote_clauses', {
                        method: 'POST', headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                        body: JSON.stringify(payload)
                    });
                }

                if (r.ok) {
                    closeClauseEditor();
                    await loadClauseLibrary();
                    renderClauseLibrary();
                    showSaveIndicator();
                }
            } catch (e) { console.error('saveLibraryClause error:', e); }
        }

        async function deleteLibraryClause(clauseId) {
            if (!confirm('Supprimer cette clause de la biblioth\u00e8que ?')) return;
            try {
                var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/quote_clauses?id=eq.' + clauseId, { method: 'DELETE' });
                if (r.ok) {
                    await loadClauseLibrary();
                    renderClauseLibrary();
                    showSaveIndicator();
                }
            } catch (e) { console.error('deleteLibraryClause error:', e); }
        }

        // ── Submission Clauses (JSONB on submissions) ──

        function getSubmissionClauses() {
            if (!currentSubmission) return [];
            return currentSubmission.clauses || [];
        }

        async function saveSubmissionClauses(clauses) {
            if (!currentSubmission) return;
            currentSubmission.clauses = clauses;
            await updateSubmission(currentSubmission.id, { clauses: clauses });
            showSaveIndicator();
        }

        async function addClauseToSubmission(clauseIdx) {
            var lib = clauseLibrary[clauseIdx];
            if (!lib) return;
            var clauses = getSubmissionClauses().slice();
            // Avoid duplicate by id
            if (clauses.some(function(c) { return c.clause_id === lib.id; })) return;
            clauses.push({
                clause_id: lib.id,
                title: lib.title,
                content: lib.content_fr,
                content_en: lib.content_en || '',
                sort_order: clauses.length
            });
            await saveSubmissionClauses(clauses);
            renderPreview();
        }

        async function removeClauseFromSubmission(idx) {
            var clauses = getSubmissionClauses().slice();
            clauses.splice(idx, 1);
            // Re-index sort_order
            clauses.forEach(function(c, i) { c.sort_order = i; });
            await saveSubmissionClauses(clauses);
            renderPreview();
        }

        async function updateClauseText(idx, newText) {
            var clauses = getSubmissionClauses().slice();
            if (clauses[idx]) {
                clauses[idx].content = newText;
                await saveSubmissionClauses(clauses);
            }
        }

        async function updateClauseTextEN(idx, newText) {
            var clauses = getSubmissionClauses().slice();
            if (clauses[idx]) {
                clauses[idx].content_en = newText;
                await saveSubmissionClauses(clauses);
            }
        }

        async function saveClauseBackToLibrary(idx) {
            var clauses = getSubmissionClauses();
            var c = clauses[idx];
            if (!c) return;

            // If came from library, update it; otherwise create new
            if (c.clause_id) {
                var existing = clauseLibrary.find(function(lib) { return lib.id === c.clause_id; });
                if (existing) {
                    await authenticatedFetch(SUPABASE_URL + '/rest/v1/quote_clauses?id=eq.' + c.clause_id, {
                        method: 'PATCH', headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                        body: JSON.stringify({ title: c.title, content_fr: c.content, content_en: c.content_en || '' })
                    });
                    await loadClauseLibrary();
                    renderClauseLibrary();
                    showSaveIndicator();
                    return;
                }
            }

            // Create new in library
            await authenticatedFetch(SUPABASE_URL + '/rest/v1/quote_clauses', {
                method: 'POST', headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                body: JSON.stringify({ title: c.title, content_fr: c.content, content_en: c.content_en || '' })
            });
            await loadClauseLibrary();
            renderClauseLibrary();
            showSaveIndicator();
        }

        // ── Drag and Drop ──

        var draggedClauseIdx = null;

        function onClauseDragStart(e, idx) {
            draggedClauseIdx = idx;
            e.dataTransfer.effectAllowed = 'copy';
            e.dataTransfer.setData('text/plain', idx.toString());
            e.target.classList.add('dragging');
            setTimeout(function() { e.target.classList.remove('dragging'); }, 200);
        }

        function onClauseDropZoneDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
            e.currentTarget.classList.add('drag-over');
        }

        function onClauseDropZoneDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function onClauseDropZoneDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            var idx = parseInt(e.dataTransfer.getData('text/plain'), 10);
            if (!isNaN(idx)) addClauseToSubmission(idx);
            draggedClauseIdx = null;
        }

        // ── Render Preview ──

        async function loadAcceptanceProof(submissionId) {
            if (!currentSubmission) return null;
            var s = currentSubmission.status;
            if (s !== 'accepted') return null;

            try {
                // Essayer acceptation en ligne (public_quote_tokens)
                var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/public_quote_tokens?submission_id=eq.' + submissionId + '&select=accepted_at,accepted_by_name,accepted_by_email,accepted_from_ip,signature_data');
                if (r.ok) {
                    var tokens = await r.json();
                    var accepted = tokens.find(function(t) { return t.accepted_at; });
                    if (accepted) return Object.assign({ method: 'online' }, accepted);
                }

                // Essayer acceptation hors-ligne via submission_reviews
                var r2 = await authenticatedFetch(SUPABASE_URL + '/rest/v1/submission_reviews?submission_id=eq.' + submissionId + '&action=eq.offline_accepted&order=created_at.desc&limit=1&select=comment,created_at');
                if (r2.ok) {
                    var reviews = await r2.json();
                    if (reviews.length > 0) return { method: 'offline', comment: reviews[0].comment, created_at: reviews[0].created_at };
                }
            } catch (e) {
                console.error('Erreur chargement preuve acceptation:', e);
            }
            return null;
        }

        // ═══════════════════════════════════════════════════════════════════════
        // SNAPSHOT — Fige le HTML de la soumission à l'approbation/envoi
        // ═══════════════════════════════════════════════════════════════════════

        var SNAPSHOT_CSS = ':root{--sw-navy:#0B1220;--sw-text:#0F172A;--sw-border:#E2E8F0}\n' +
            '*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}\n' +
            'body{font-family:Inter,-apple-system,sans-serif;background:#fff;color:#1A1A1A;line-height:1.5}\n' +
            '.pv-content{display:flex;flex-direction:column;gap:40px;max-width:1200px;margin:0 auto;padding:40px 0}\n' +
            '.pv-page{background:#fff;padding:36px 48px;aspect-ratio:11/8.5;overflow:hidden;position:relative;display:flex;flex-direction:column}\n' +
            '.pv-page-title{position:relative;padding:32px;overflow:hidden;background:#fff}\n' +
            '.pv-cover-right{position:absolute;inset:32px;z-index:0;background:#0F1C2D;overflow:hidden;border-radius:8px}\n' +
            '.pv-cover-right img{width:100%;height:100%;object-fit:cover;display:block;filter:none;opacity:1}\n' +
            '.pv-cover-right .pv-cover-overlay{display:none}\n' +
            '.pv-cover-left{position:relative;z-index:1;width:320px;display:flex;flex-direction:column;justify-content:flex-start;padding:48px;min-height:100%;background:transparent;text-align:left}\n' +
            '.pv-cover-brand{position:absolute;bottom:49px;left:56px;z-index:1;font-family:Inter,-apple-system,sans-serif;font-size:40px;font-weight:400;letter-spacing:-0.01em;text-transform:lowercase;color:white;opacity:0.9;margin:0;line-height:1}\n' +
            '.pv-cover-label{font-family:Cormorant Garamond,Georgia,serif;font-style:italic;font-size:13px;color:rgba(255,255,255,0.75);line-height:1.2;margin-bottom:10px}\n' +
            '.pv-cover-left .pv-client-name{font-family:Inter,-apple-system,sans-serif;font-size:15px;font-weight:400;color:white;opacity:0.85;line-height:1.5;margin-bottom:0}\n' +
            '.pv-cover-left .pv-client-address{font-family:Inter,-apple-system,sans-serif;font-size:15px;font-weight:400;color:white;opacity:0.85;line-height:1.5;margin-bottom:0}\n' +
            '.pv-cover-left .pv-project-name{font-family:Inter,-apple-system,sans-serif;font-size:56px;font-weight:400;color:#FFFFFF;line-height:1.1;letter-spacing:-0.02em;margin-top:28px;margin-bottom:0}\n' +
            '.pv-cover-left .pv-cover-divider{width:32px;height:1px;background:rgba(255,255,255,0.25);margin:14px 0}\n' +
            '.pv-cover-left .pv-sub-number{font-family:Inter,-apple-system,sans-serif;font-size:13px;font-weight:400;color:white;opacity:0.7;margin-bottom:2px}\n' +
            '.pv-cover-left .pv-sub-date{font-family:Inter,-apple-system,sans-serif;font-size:13px;font-weight:400;color:white;opacity:0.7}\n' +
            '.pv-cover-logo{display:none}\n' +
            '.pv-install-banner{font-size:12px;color:rgba(255,255,255,0.7);margin-top:60px;letter-spacing:0.3px}\n' +
            '.pv-install-room-note{font-size:11px;color:#888;font-style:italic;margin-top:-30px;margin-bottom:20px;padding-left:20px}\n' +
            '.pv-install-total-note{font-size:13px;color:#888;margin-bottom:16px;letter-spacing:0.3px}\n' +
            '.pv-page-room-header{display:flex;align-items:baseline;justify-content:space-between;padding:10px 0;background:transparent;color:#1A1A1A;border-radius:0;margin:0;flex-shrink:0;border-bottom:1px solid #1A1A1A}\n' +
            '.pv-room-separator{border-bottom:1px solid #E5E5E5;flex-shrink:0}\n' +
            '.pv-page-room-name{font-family:Inter,-apple-system,sans-serif;font-size:12px;font-weight:500;letter-spacing:0.05em;text-transform:uppercase;color:#1A1A1A}\n' +
            '.pv-page-room-subtotal{font-family:Inter,-apple-system,sans-serif;font-size:17px;font-weight:600;letter-spacing:-0.01em;color:#1A1A1A}\n' +
            '.pv-page-room-body{flex:1;display:flex;gap:56px;overflow:hidden;min-height:0;padding-top:32px}\n' +
            '.pv-page-room-text{flex:0 1 440px;max-width:440px;display:flex;flex-direction:column;overflow:hidden;justify-content:center}\n' +
            '.pv-page-room-media{flex:1.3;display:grid;grid-template-columns:repeat(2,1fr);gap:12px;align-content:center;max-height:100%}\n' +
            '.pv-page-room-media.imgs-1{grid-template-columns:1fr}\n' +
            '.pv-page-room-media.imgs-2{grid-template-columns:1fr;gap:20px}\n' +
            '.pv-page-room-media.imgs-3{gap:12px}\n' +
            '.pv-page-room-media.imgs-3 .pv-img-wrap:first-child{grid-column:1/-1}\n' +
            '.pv-page-room-media .pv-img-wrap{overflow:hidden;min-height:0;border-radius:0;background:transparent;border:none;padding:0;box-shadow:none}\n' +
            '.pv-page-room-media .pv-img-wrap img{width:100%;height:100%;object-fit:cover;display:block;border-radius:0}\n' +
            '.pv-page-room-desc{width:100%;border:none;border-radius:0;padding:0;font-family:Inter,-apple-system,sans-serif;font-size:14px;font-weight:400;line-height:1.6;color:#2B2B2B;flex:initial;min-height:auto;background:transparent}\n' +
            '.pv-page-room-desc p{margin:0 0 8px 0}\n' +
            '.pv-page-room-desc ul{margin:6px 0 12px 0;padding-left:18px}\n' +
            '.pv-page-room-desc li{margin-bottom:6px;color:#555555;font-size:14px;line-height:1.6}\n' +
            '.pv-page-room-desc li::marker{color:#B0B0B0}\n' +
            '.pv-page-room-desc ul+p{margin-top:16px}\n' +
            '.pv-page-room-desc strong{font-weight:500;color:#1A1A1A;letter-spacing:0.01em}\n' +
            '.pv-page-clauses-header{font-family:Inter,-apple-system,sans-serif;font-size:12px;text-transform:uppercase;letter-spacing:1px;color:#1A1A1A;font-weight:500;margin-bottom:14px;padding-bottom:6px;border-bottom:1px solid #1A1A1A}\n' +
            '.pv-page-clauses-body{flex:1;overflow:hidden}\n' +
            '.pv-page-clause{margin-bottom:8px;padding:6px 14px;border-left:1px solid #1A1A1A;background:#fafafa;border-radius:0}\n' +
            '.pv-page-clause-title{font-family:Inter,-apple-system,sans-serif;font-size:11px;font-weight:500;text-transform:uppercase;letter-spacing:0.3px;margin-bottom:2px;color:#1A1A1A}\n' +
            '.pv-page-clause-text{width:100%;border:none;border-radius:3px;padding:2px 4px;font-family:Inter,-apple-system,sans-serif;font-size:12px;line-height:1.3;color:#555555;resize:none;background:transparent}\n' +
            '.pv-page-clause-actions{display:none}\n' +
            '.pv-page-total{justify-content:center;align-items:center;text-align:center}\n' +
            '.pv-total-box{padding:36px 56px;background:#1A1A1A;color:#fff;border-radius:0}\n' +
            '.pv-total-box .total-label{font-family:Inter,-apple-system,sans-serif;font-size:12px;font-weight:400;text-transform:uppercase;letter-spacing:2px;margin-bottom:10px;opacity:0.8}\n' +
            '.pv-total-box .total-amount{font-family:Inter,-apple-system,sans-serif;font-size:42px;font-weight:400;letter-spacing:-0.02em}\n' +
            '.pv-total-box .total-taxes{font-size:13px;opacity:0.6;margin-top:6px}\n' +
            '.pv-total-breakdown{margin-bottom:12px}\n' +
            '.pv-total-subtotal-line,.pv-total-discount-line{display:flex;justify-content:space-between;font-size:16px;padding:4px 0;opacity:0.8}\n' +
            '.pv-total-discount-line{color:#ef5350}\n' +
            '.pv-total-divider{border-top:1px solid rgba(255,255,255,0.2);margin:8px 0}\n' +
            '.pv-page-footer-text{margin-top:32px;font-family:Inter,-apple-system,sans-serif;font-size:12px;font-weight:400;color:#888888;letter-spacing:0.02em;text-transform:uppercase}\n' +
            '.pv-page-steps{padding:32px 48px}\n' +
            '.pv-steps-title{font-family:Inter,-apple-system,sans-serif;font-size:12px;text-transform:uppercase;letter-spacing:1px;color:#1A1A1A;font-weight:500;margin-bottom:20px;padding-bottom:6px;border-bottom:1px solid #1A1A1A}\n' +
            '.pv-steps-grid{flex:1;display:grid;grid-template-columns:1fr 1fr;grid-template-rows:repeat(4,1fr);gap:10px 48px;grid-auto-flow:column}\n' +
            '.pv-step{display:flex;gap:16px;align-items:flex-start}\n' +
            '.pv-step-circle{width:64px;height:64px;min-width:64px;border-radius:50%;color:#fff;display:flex;align-items:center;justify-content:center;font-family:Inter,-apple-system,sans-serif;font-size:24px;font-weight:400;margin-top:2px}\n' +
            '.pv-step-content{flex:1;min-width:0}\n' +
            '.pv-step-label{font-family:Inter,-apple-system,sans-serif;font-size:12px;font-weight:500;text-transform:uppercase;letter-spacing:0.3px;color:#1A1A1A;margin-bottom:4px}\n' +
            '.pv-step-desc{font-family:Inter,-apple-system,sans-serif;font-size:11px;font-weight:400;line-height:1.45;color:#555555}\n' +
            '.pv-page-intro{padding:32px;display:grid;grid-template-columns:42% 1fr;grid-template-rows:1fr;overflow:hidden;position:relative}\n' +
            '.pv-intro-section-label{display:none}\n' +
            '.pv-intro-image{grid-row:1;grid-column:1;overflow:hidden;border-radius:8px;min-height:0;background:#f0f0f0}\n' +
            '.pv-intro-image img{width:100%;height:100%;object-fit:cover;object-position:center;display:block;border-radius:8px}\n' +
            '.pv-intro-content{grid-column:2;grid-row:1;padding:40px 24px 32px 48px;display:flex;flex-direction:column;justify-content:flex-start;overflow:hidden}\n' +
            '.pv-intro-attention-label{font-family:Inter,-apple-system,sans-serif;font-style:italic;font-weight:400;font-size:13px;color:#888888;margin-bottom:6px;letter-spacing:0.05em}\n' +
            '.pv-intro-attention-name{font-family:Inter,-apple-system,sans-serif;font-weight:400;font-size:14px;color:#1a1a1a;letter-spacing:0.01em;margin-bottom:52px;line-height:1.6}\n' +
            '.pv-intro-rule{width:48px;height:1px;background:#1A1A1A;margin-bottom:52px}\n' +
            '.pv-intro-title{font-family:Inter,-apple-system,sans-serif;font-weight:400;font-size:28px;line-height:1.3;letter-spacing:-0.02em;color:#1A1A1A;margin-bottom:48px}\n' +
            '.pv-intro-title strong{font-weight:600}\n' +
            '.pv-intro-body{max-width:460px}\n' +
            '.pv-intro-body p{font-family:Inter,-apple-system,sans-serif;font-weight:400;font-size:14px;line-height:1.7;color:#555555;margin-bottom:20px}\n' +
            '.pv-intro-body p:last-child{margin-bottom:0}\n' +
            '.pv-intro-footer{position:absolute;bottom:24px;left:32px;right:56px;display:flex;justify-content:space-between;align-items:flex-end}\n' +
            '.pv-intro-footer-addresses{display:flex;gap:48px}\n' +
            '.pv-intro-footer-block{display:flex;gap:8px;align-items:baseline}\n' +
            '.pv-intro-footer-label{font-family:Inter,-apple-system,sans-serif;font-weight:500;font-size:11px;text-transform:uppercase;letter-spacing:0.08em;color:#888888}\n' +
            '.pv-intro-footer-value{font-family:Inter,-apple-system,sans-serif;font-weight:400;font-size:10px;color:#888888}\n' +
            '.pv-intro-footer-right{text-align:right}\n' +
            '.pv-intro-footer-name{font-family:Inter,-apple-system,sans-serif;font-weight:400;font-size:11px;color:#1a1a1a;margin-bottom:2px}\n' +
            '.pv-intro-footer-email{font-family:Inter,-apple-system,sans-serif;font-weight:400;font-size:10px;color:#888888}\n' +
            '.pv-intro-bottom{position:absolute;bottom:8px;left:32px;right:56px;display:flex;justify-content:space-between;align-items:center}\n' +
            '.pv-intro-bottom-url{font-family:Inter,-apple-system,sans-serif;font-weight:400;font-size:9px;color:#1a1a1a;text-decoration:none;letter-spacing:0.02em}\n' +
            '.pv-intro-bottom-page{font-family:Inter,-apple-system,sans-serif;font-weight:400;font-size:9px;color:#888}\n' +
            '.pv-page-why{display:grid;grid-template-columns:42% 1fr;grid-template-rows:1fr;padding:32px;overflow:hidden;position:relative}\n' +
            '.pv-why-image{grid-row:1;grid-column:1;overflow:hidden;border-radius:8px;min-height:0;background:#f0f0f0}\n' +
            '.pv-why-image img{width:100%;height:100%;object-fit:cover;object-position:center;display:block;border-radius:8px;filter:grayscale(100%) contrast(1.05);box-shadow:none}\n' +
            '.pv-why-content{grid-row:1;grid-column:2;padding:40px 24px 32px 48px;display:flex;flex-direction:column;justify-content:center}\n' +
            '.pv-why-rule{width:48px;height:1px;background:#1A1A1A;margin-bottom:52px}\n' +
            '.pv-why-title{font-family:Inter,-apple-system,sans-serif;font-size:28px;font-weight:400;letter-spacing:-0.02em;line-height:1.3;color:#1A1A1A;margin-bottom:48px}\n' +
            '.pv-why-title strong{font-weight:600}\n' +
            '.pv-why-body{max-width:460px}\n' +
            '.pv-why-body p{font-family:Inter,-apple-system,sans-serif;font-size:14px;font-weight:400;line-height:1.7;color:#555555;margin-bottom:20px}\n' +
            '.pv-why-body p:last-child{margin-bottom:0}\n' +
            '.pv-why-bottom{position:absolute;bottom:8px;left:32px;right:56px;display:flex;justify-content:space-between;align-items:center}\n' +
            '.pv-why-bottom-url{font-family:Inter,-apple-system,sans-serif;font-size:9px;font-weight:400;letter-spacing:0.02em;color:#1a1a1a}\n' +
            '.pv-why-bottom-page{font-family:Inter,-apple-system,sans-serif;font-size:9px;font-weight:400;color:#888}\n' +
            '@media print{.pv-page{page-break-after:always} .pv-page-room-media .pv-img-wrap{box-shadow:none} .pv-page-why{page-break-after:always;break-inside:avoid}}';

        function generateSnapshotHtml(pagesHtml) {
            return '<!DOCTYPE html>\n<html lang="fr">\n<head>\n' +
                '<meta charset="UTF-8">\n' +
                '<meta name="viewport" content="width=device-width, initial-scale=1.0">\n' +
                '<title>Soumission #' + escapeHtml((currentSubmission ? currentSubmission.submission_number : '') + '') + '</title>\n' +
                '<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;1,300;1,400&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">\n' +
                '<style>\n' + SNAPSHOT_CSS + '\n</style>\n' +
                '</head>\n<body>\n' +
                '<div class="pv-content">\n' + pagesHtml + '\n</div>\n' +
                '</body>\n</html>';
        }

        async function uploadSnapshot(submissionId) {
            if (!submissionId) return;
            try {
                // Render preview to get HTML
                await loadCoverImage();
                await renderPreview();
                var container = document.getElementById('pvContent');
                if (!container) return;
                var pagesHtml = container.innerHTML;

                // Remove interactive elements from snapshot
                var tempDiv = document.createElement('div');
                tempDiv.innerHTML = pagesHtml;
                // Remove edit buttons, delete buttons, dropzones, optimize buttons
                tempDiv.querySelectorAll('.pv-img-delete, .pv-img-badge-client, .pv-page-clause-actions, .pv-clause-dropzone, .pv-optimize-btn, button').forEach(function(el) { el.remove(); });
                // Make contenteditable divs static
                tempDiv.querySelectorAll('[contenteditable]').forEach(function(el) { el.removeAttribute('contenteditable'); });
                // Make textareas into divs
                tempDiv.querySelectorAll('textarea').forEach(function(ta) {
                    var div = document.createElement('div');
                    div.className = ta.className;
                    div.textContent = ta.value;
                    ta.parentNode.replaceChild(div, ta);
                });
                var cleanHtml = tempDiv.innerHTML;

                var snapshotHtml = generateSnapshotHtml(cleanHtml);
                var blob = new Blob([snapshotHtml], { type: 'text/html' });

                // Upload to Storage
                var filePath = submissionId + '.html';
                var r = await authenticatedFetch(SUPABASE_URL + '/storage/v1/object/submission-snapshots/' + filePath, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'text/html', 'x-upsert': 'true' },
                    body: blob
                });
                if (!r.ok) {
                    // Try POST if PUT fails
                    r = await authenticatedFetch(SUPABASE_URL + '/storage/v1/object/submission-snapshots/' + filePath, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/html', 'x-upsert': 'true' },
                        body: blob
                    });
                }
                if (r.ok) {
                    console.log('Snapshot saved for submission', submissionId);
                } else {
                    console.warn('Snapshot upload failed:', await r.text());
                }
            } catch (e) {
                console.warn('Error creating snapshot:', e);
            }
        }

        function getSnapshotUrl(submissionId) {
            return SUPABASE_URL + '/storage/v1/object/public/submission-snapshots/' + submissionId + '.html';
        }

        function cleanConfigValue(val) {
            if (typeof val === 'string' && val.length >= 2 && val[0] === '"' && val[val.length - 1] === '"') {
                try { return JSON.parse(val); } catch (e) {}
            }
            return val;
        }

        async function loadCoverImage() {
            if (coverImageUrl !== null) return; // already loaded
            try {
                var configKeys = 'cover_image,intro_image,presentation_intro_text_1,presentation_intro_text_2,presentation_intro_text_3,presentation_intro_atelier,presentation_intro_bureau,presentation_intro_phone,presentation_intro_url';
                var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/app_config?key=in.(' + configKeys + ')&select=key,value', {});
                if (r.ok) {
                    var rows = await r.json();
                    rows.forEach(function(row) { introConfig[row.key] = cleanConfigValue(row.value); });
                    console.log('[intro] Config loaded:', JSON.stringify(introConfig));
                    if (introConfig.cover_image) coverImageUrl = introConfig.cover_image;
                    else coverImageUrl = '';
                }
            } catch (e) { coverImageUrl = ''; }
            // Load project manager email
            if (currentProject && currentProject.assigned_to) {
                try {
                    var empResp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/employees?name=eq.' + encodeURIComponent(currentProject.assigned_to) + '&select=email&limit=1', {});
                    if (empResp.ok) {
                        var empRows = await empResp.json();
                        if (empRows.length > 0 && empRows[0].email) projectManagerEmail = empRows[0].email;
                    }
                } catch (e) { /* graceful */ }
            }
        }

        var _snapshotRendered = false; // flag to prevent snapshot re-render loop from uploadSnapshot

        async function renderPreview() {
            await loadCoverImage();
            var container = document.getElementById('pvContent');
            var subLabel = document.getElementById('pvSubNumber');
            if (!container) return;

            if (subLabel && currentSubmission) {
                subLabel.textContent = t('soumission') + ' #' + (currentSubmission.submission_number || '');
            }

            // For approved+ submissions in client view, try to load snapshot
            var s = currentSubmission ? currentSubmission.status : 'draft';
            var isLocked = s !== 'draft' && s !== 'returned' && s !== 'pending_internal';
            if (isLocked && clientViewMode && !_snapshotRendered) {
                try {
                    var snapUrl = getSnapshotUrl(currentSubmission.id);
                    var snapResp = await fetch(snapUrl, { method: 'GET' });
                    if (snapResp.ok) {
                        var snapHtml = await snapResp.text();
                        // Extract body content from snapshot
                        var bodyMatch = snapHtml.match(/<body[^>]*>([\s\S]*)<\/body>/i);
                        if (bodyMatch) {
                            container.innerHTML = bodyMatch[1];
                            _snapshotRendered = true;
                            return;
                        }
                    }
                } catch (e) { /* snapshot not available, render live */ }
            }
            _snapshotRendered = false;

            var html = '';
            var editable = currentSubmission && (currentSubmission.status === 'draft' || currentSubmission.status === 'returned');

            // ── Load acceptance proof ──
            var acceptanceProofHtml = '';
            if (currentSubmission) {
                var proof = await loadAcceptanceProof(currentSubmission.id);
                if (proof) {
                    acceptanceProofHtml += '<div style="position:absolute;top:10px;left:20px;background:#e8f5e9;border:1px solid var(--sw-navy);border-radius:8px;padding:12px 16px;max-width:320px;font-size:11px;line-height:1.6;z-index:1;">';
                    acceptanceProofHtml += '<div style="font-weight:700;font-size:13px;color:var(--sw-navy);margin-bottom:6px;">Soumission accept\u00e9e</div>';
                    if (proof.method === 'online') {
                        acceptanceProofHtml += '<div><strong>M\u00e9thode :</strong> Signature en ligne</div>';
                        if (proof.accepted_by_name) acceptanceProofHtml += '<div><strong>Nom :</strong> ' + escapeHtml(proof.accepted_by_name) + '</div>';
                        if (proof.accepted_by_email) acceptanceProofHtml += '<div><strong>Courriel :</strong> ' + escapeHtml(proof.accepted_by_email) + '</div>';
                        if (proof.accepted_at) acceptanceProofHtml += '<div><strong>Date :</strong> ' + new Date(proof.accepted_at).toLocaleString('fr-CA') + '</div>';
                        if (proof.accepted_from_ip) acceptanceProofHtml += '<div><strong>IP :</strong> ' + escapeHtml(proof.accepted_from_ip) + '</div>';
                        if (proof.signature_data) acceptanceProofHtml += '<div style="margin-top:8px;"><img src="' + proof.signature_data + '" style="max-width:200px;border:1px solid #ccc;border-radius:4px;" alt="Signature"></div>';
                    } else {
                        acceptanceProofHtml += '<div><strong>M\u00e9thode :</strong> Hors-ligne</div>';
                        if (proof.comment) acceptanceProofHtml += '<div style="margin-top:2px;color:#555;">' + escapeHtml(proof.comment) + '</div>';
                        if (proof.created_at) acceptanceProofHtml += '<div><strong>Date :</strong> ' + new Date(proof.created_at).toLocaleString('fr-CA') + '</div>';
                    }
                    acceptanceProofHtml += '</div>';
                }
            }

            // ── Pre-scan installation status ──
            var pvGroups = document.querySelectorAll('#calculatorView .furniture-group');
            var installExcludedIds = {};
            var totalGroups = 0;
            pvGroups.forEach(function(g) {
                totalGroups++;
                var cb = document.getElementById(g.id + '-install');
                if (cb && !cb.checked) installExcludedIds[g.id] = true;
            });
            var excludedCount = Object.keys(installExcludedIds).length;
            var allInstallExcluded = totalGroups > 0 && excludedCount === totalGroups;
            var someInstallExcluded = excludedCount > 0 && !allInstallExcluded;

            // ── Page 1: Title ──
            var subNum = currentSubmission ? currentSubmission.submission_number : '';
            var subDate = '';
            if (currentSubmission) {
                var d = currentSubmission.sent_at || currentSubmission.approved_at || currentSubmission.created_at;
                if (d) {
                    var dt = new Date(d);
                    var loc = currentLang === 'en' ? 'en-CA' : 'fr-CA';
                    subDate = dt.toLocaleDateString(loc, { year: 'numeric', month: 'long', day: 'numeric' });
                }
            }
            // Build address from new columns with fallback
            var coverAddr = '';
            if (currentProject) {
                var ap = [];
                var pa = currentProject.project_address || currentProject._address || '';
                var pc = currentProject.project_city || currentProject._city || '';
                var pp = currentProject.project_postal_code || currentProject._postal || '';
                if (!pa && !pc && !pp && currentProject.client_address) pa = currentProject.client_address;
                if (pa) ap.push(escapeHtml(pa));
                if (pc) ap.push(escapeHtml(pc));
                if (pp) ap.push(escapeHtml(pp));
                coverAddr = ap.join(', ');
            }

            // Build separate address lines
            var coverAddrLine = '';
            var coverCityPostal = '';
            if (currentProject) {
                var pa = currentProject.project_address || currentProject._address || '';
                var pcity = currentProject.project_city || currentProject._city || '';
                var ppost = currentProject.project_postal_code || currentProject._postal || '';
                if (!pa && !pcity && !ppost && currentProject.client_address) pa = currentProject.client_address;
                coverAddrLine = pa;
                var cp = [];
                if (pcity) cp.push(pcity);
                if (ppost) cp.push(ppost);
                coverCityPostal = cp.join(', ');
            }

            html += '<div class="pv-page pv-page-title">';
            html += '<div class="pv-cover-right">';
            if (coverImageUrl) {
                html += '<img src="' + escapeAttr(coverImageUrl) + '" alt="">';
            }
            html += '<div class="pv-cover-overlay"></div>';
            html += '</div>';
            html += '<div class="pv-cover-left">';
            html += acceptanceProofHtml;
            if (currentProject) {
                html += '<div class="pv-cover-label">' + t('coverLabel') + '</div>';
                html += '<div class="pv-client-name">' + escapeHtml(currentProject.client_name || '') + '</div>';
                if (coverAddrLine) html += '<div class="pv-client-address">' + escapeHtml(coverAddrLine) + '</div>';
                if (coverCityPostal) html += '<div class="pv-client-address">' + escapeHtml(coverCityPostal) + '</div>';
                html += '<div class="pv-project-name">' + escapeHtml(currentProject.name || '') + '</div>';
            }
            html += '<div class="pv-cover-divider"></div>';
            html += '<div class="pv-sub-number">' + t('soumission') + ' #' + escapeHtml(subNum + '') + '</div>';
            if (subDate) html += '<div class="pv-sub-date">' + escapeHtml(subDate) + '</div>';
            if (allInstallExcluded) html += '<div class="pv-install-banner">' + (currentLang === 'en' ? 'Installation not included' : 'Installation non incluse') + '</div>';
            html += '</div>';
            html += '<div class="pv-cover-brand">stele</div>';
            html += '</div>';

            // ── Introduction page (skip for locked submissions — those are frozen like a PDF) ──
            var introImageUrl = !isLocked ? (introConfig.intro_image || '') : '';
            var introText1fr = !isLocked ? (introConfig.presentation_intro_text_1 || '') : '';
            var introText2fr = !isLocked ? (introConfig.presentation_intro_text_2 || '') : '';
            var introText3fr = !isLocked ? (introConfig.presentation_intro_text_3 || '') : '';
            var introText1 = currentLang === 'en' ? (introConfigEN.presentation_intro_text_1 || introText1fr) : introText1fr;
            var introText2 = currentLang === 'en' ? (introConfigEN.presentation_intro_text_2 || introText2fr) : introText2fr;
            var introText3 = currentLang === 'en' ? (introConfigEN.presentation_intro_text_3 || introText3fr) : introText3fr;
            var introAtelier = !isLocked ? (introConfig.presentation_intro_atelier || '') : '';
            var introBureau = !isLocked ? (introConfig.presentation_intro_bureau || '') : '';
            var introPhone = !isLocked ? (introConfig.presentation_intro_phone || '') : '';
            var introUrl = !isLocked ? (introConfig.presentation_intro_url || '') : '';

            if (introImageUrl || introText1 || introText2 || introText3) {
                html += '<div class="pv-page pv-page-intro">';
                html += '<span class="pv-intro-section-label">' + t('introLabel') + '</span>';

                html += '<div class="pv-intro-image">';
                if (introImageUrl) html += '<img src="' + escapeAttr(introImageUrl) + '" alt="">';
                html += '</div>';

                html += '<div class="pv-intro-content">';
                html += '<div class="pv-intro-attention-label">' + t('introAttention') + '</div>';

                var introClientParts = [];
                if (currentProject && currentProject.client_name) introClientParts.push(escapeHtml(currentProject.client_name));
                if (coverAddrLine) introClientParts.push(escapeHtml(coverAddrLine));
                if (coverCityPostal) introClientParts.push(escapeHtml(coverCityPostal));
                if (introClientParts.length > 0) {
                    html += '<div class="pv-intro-attention-name">' + introClientParts.join('<br>') + '</div>';
                }

                html += '<div class="pv-intro-rule"></div>';
                html += '<h2 class="pv-intro-title">' + t('introTitle') + '</h2>';

                html += '<div class="pv-intro-body">';
                if (introText1) html += '<p>' + escapeHtml(introText1) + '</p>';
                if (introText2) html += '<p>' + escapeHtml(introText2) + '</p>';
                if (introText3) html += '<p>' + escapeHtml(introText3) + '</p>';
                html += '</div>';
                html += '</div>'; // end pv-intro-content

                html += '<div class="pv-intro-footer">';
                html += '<div class="pv-intro-footer-addresses">';
                if (introAtelier) {
                    html += '<div class="pv-intro-footer-block"><span class="pv-intro-footer-label">' + t('introAtelier') + '</span><span class="pv-intro-footer-value">' + escapeHtml(introAtelier) + '</span></div>';
                }
                if (introBureau) {
                    html += '<div class="pv-intro-footer-block"><span class="pv-intro-footer-label">' + t('introBureau') + '</span><span class="pv-intro-footer-value">' + escapeHtml(introBureau) + '</span></div>';
                }
                if (introPhone) {
                    html += '<div class="pv-intro-footer-block"><span class="pv-intro-footer-value">' + escapeHtml(introPhone) + '</span></div>';
                }
                html += '</div>';

                var pmName = (currentProject && currentProject.assigned_to) || '';
                html += '<div class="pv-intro-footer-right">';
                if (pmName) {
                    html += '<div class="pv-intro-footer-name">' + escapeHtml(pmName) + '</div>';
                    if (projectManagerEmail) html += '<div class="pv-intro-footer-email">' + escapeHtml(projectManagerEmail) + '</div>';
                }
                html += '</div>';
                html += '</div>'; // end pv-intro-footer

                html += '<div class="pv-intro-bottom">';
                html += '<span class="pv-intro-bottom-url">' + escapeHtml(introUrl || 'stele.ca') + '</span>';
                html += '<span class="pv-intro-bottom-page">1</span>';
                html += '</div>';

                html += '</div>'; // end pv-page-intro
            }

            // ── Page "Pourquoi stele" ──
            var whyArchName = '';
            if (currentProject && currentProject.project_contacts) {
                var archPC = currentProject.project_contacts.find(function(pc) {
                    var r = (pc.role || '').toLowerCase();
                    return r.indexOf('architecte') >= 0 || r.indexOf('architect') >= 0 || r.indexOf('designer') >= 0;
                });
                if (archPC && archPC.contacts) {
                    var ac = archPC.contacts;
                    whyArchName = ((ac.first_name || '') + ' ' + (ac.last_name || '')).trim();
                }
            }
            var whyDesignerFr = whyArchName || 'votre architecte';
            var whyDesignerEn = whyArchName || 'your architect';
            var whyEn = currentLang === 'en';
            var whyDesigner = whyEn ? whyDesignerEn : whyDesignerFr;
            var whyTitle = whyEn ? 'Why' : 'Pourquoi';
            var whyP1 = whyEn
                ? 'Because, like you, we value and admire the work of ' + escapeHtml(whyDesigner) + ', and wish to honour their vision with the same dedication.'
                : 'Parce que, comme vous, nous estimons et admirons le travail de ' + escapeHtml(whyDesigner) + ', et souhaitons rendre hommage \u00e0 leur vision avec la m\u00eame exigence.';
            var whyP2 = whyEn
                ? 'Because our years of experience in executing large-scale cabinetry projects have taught us to master complexity, and our team stands out through its craftsmanship where technology reaches its limits.'
                : 'Parce que nos ann\u00e9es d\u2019exp\u00e9rience dans la r\u00e9alisation de projets d\u2019\u00e9b\u00e9nisterie d\u2019envergure nous ont appris \u00e0 ma\u00eetriser la complexit\u00e9, et que notre \u00e9quipe se distingue par son habilet\u00e9 l\u00e0 o\u00f9 la technologie atteint ses limites.';
            var whyP3 = whyEn
                ? 'Because stele is above all a team of passionate people, driven by the desire to create unique pieces. While every project brings its own challenges, we are ready to meet them so that every step unfolds seamlessly.'
                : 'Parce que stele, c\u2019est avant tout une \u00e9quipe de gens passionn\u00e9s, anim\u00e9s par le d\u00e9sir de cr\u00e9er des pi\u00e8ces uniques. Si chaque projet apporte son lot de d\u00e9fis, nous sommes pr\u00eats \u00e0 les relever pour que chaque \u00e9tape se fasse en toute simplicit\u00e9.';
            html += '<div class="pv-page pv-page-why">';
            html += '<div class="pv-why-image">';
            html += '<img src="images/why-stele.jpg" alt="Atelier stele" onerror="this.style.display=\'none\'" />';
            html += '</div>';
            html += '<div class="pv-why-content">';
            html += '<div class="pv-why-rule"></div>';
            html += '<h2 class="pv-why-title">' + whyTitle + ' <strong>stele</strong></h2>';
            html += '<div class="pv-why-body">';
            html += '<p>' + whyP1 + '</p>';
            html += '<p>' + whyP2 + '</p>';
            html += '<p>' + whyP3 + '</p>';
            html += '</div>';
            html += '</div>';
            html += '<div class="pv-why-bottom">';
            html += '<span class="pv-why-bottom-url">stele.ca</span>';
            html += '<span class="pv-why-bottom-page">2</span>';
            html += '</div>';
            html += '</div>'; // end pv-page-why

            // ── Room pages (one per room) — text left, images right ──
            var grandTotal = 0;
            var groups = document.querySelectorAll('#calculatorView .furniture-group');
            groups.forEach(function(group) {
                var groupId = group.id;
                var nameInput = group.querySelector('.furniture-name-input');
                var roomName = nameInput ? nameInput.value : 'Sans nom';

                var calculatedSubtotal = 0;
                group.querySelectorAll('.calc-row').forEach(function(row) {
                    calculatedSubtotal += getRowTotal(row);
                });
                var subtotal = Math.round(calculatedSubtotal * getModifierMultiplier(groupId) * 100) / 100;
                grandTotal += subtotal;

                var allImgs = groupImages[groupId] || [];
                var imgs = allImgs.filter(function(img) { return img.showInQuote; });
                var descEl = document.getElementById(groupId + '-clientDesc');
                var descPlain = descEl ? descEl.value : '';
                var descFr = roomDescHTML[groupId] || descPlain;
                var descEn = roomDescEN[groupId] || '';
                var desc = currentLang === 'en' ? (descEn || descFr) : descFr;
                var hasImages = imgs.length > 0;

                html += '<div class="pv-page" data-group-id="' + escapeAttr(groupId) + '">';
                html += '<div class="pv-page-room-header"><span class="pv-page-room-name">' + escapeHtml(roomName) + '</span><span class="pv-page-room-subtotal">' + formatPrice(subtotal) + '</span></div>';
                if (someInstallExcluded && installExcludedIds[groupId]) {
                    html += '<div class="pv-install-room-note">' + (currentLang === 'en' ? '* Installation not included for this section' : '* Installation non incluse pour cette section') + '</div>';
                }
                html += '<div class="pv-page-room-body">';

                // Left column: description
                if (hasImages) {
                    html += '<div class="pv-page-room-text" style="position:relative;">';
                    if (editable && currentLang === 'fr') {
                        html += '<button class="pv-optimize-btn" onclick="optimizeText(this)" data-group-id="' + escapeAttr(groupId) + '">&#10024;</button>';
                    }
                    html += '<div class="pv-page-room-desc" data-group-id="' + escapeAttr(groupId) + '"';
                    html += ' data-placeholder="' + escapeAttr(t('descPlaceholder')) + '"';
                    html += ' contenteditable="' + (editable ? 'true' : 'false') + '">';
                    html += textToHtml(desc);
                    html += '</div>';
                    html += '</div>';

                    // Right column: images
                    var imgCount = Math.min(imgs.length, 4);
                    html += '<div class="pv-page-room-media imgs-' + imgCount + '">';
                    imgs.forEach(function(img) {
                        var realIdx = allImgs.indexOf(img);
                        var imgSrc = img.isLegacy ? img.dataUrl : (img.url || img.dataUrl);
                        var ratio = img.cropRatio === '1:1' ? '1/1' : img.cropRatio === '9:16' ? '9/16' : '16/9';
                        html += '<div class="pv-img-wrap">';
                        html += '<img src="' + imgSrc + '" alt="' + escapeAttr(img.name) + '" style="aspect-ratio:' + ratio + ';" onclick="openLightbox(this.src)">';
                        if (editable && !clientViewMode) {
                            html += '<button class="pv-img-delete" onclick="removePreviewImage(\'' + escapeAttr(groupId) + '\', ' + realIdx + ')" title="Supprimer">&times;</button>';
                        }
                        html += '</div>';
                    });
                    html += '</div>';
                } else {
                    // No images — description takes full width
                    html += '<div class="pv-page-room-text" style="flex:1; position:relative;">';
                    if (editable && currentLang === 'fr') {
                        html += '<button class="pv-optimize-btn" onclick="optimizeText(this)" data-group-id="' + escapeAttr(groupId) + '">&#10024;</button>';
                    }
                    html += '<div class="pv-page-room-desc" data-group-id="' + escapeAttr(groupId) + '"';
                    html += ' data-placeholder="' + escapeAttr(t('descPlaceholder')) + '"';
                    html += ' contenteditable="' + (editable ? 'true' : 'false') + '">';
                    html += textToHtml(desc);
                    html += '</div>';
                    html += '</div>';
                }

                html += '</div>';
                html += '<div class="pv-room-separator"></div>';
                html += '</div>';
            });

            // ── Clauses page (compact) ──
            var subClauses = getSubmissionClauses();
            if (subClauses.length > 0 || editable) {
                html += '<div class="pv-page">';
                html += '<div class="pv-page-clauses-header">' + t('clausesTitle') + '</div>';
                html += '<div class="pv-page-clauses-body">';

                subClauses.forEach(function(clause, idx) {
                    html += '<div class="pv-page-clause" data-clause-idx="' + idx + '">';
                    html += '<div class="pv-page-clause-title">' + escapeHtml(clause.title) + '</div>';
                    var clauseText = currentLang === 'en' ? (clause.content_en || clause.content || '') : (clause.content || '');
                    html += '<textarea class="pv-page-clause-text" data-clause-idx="' + idx + '"';
                    html += ' rows="2"' + (editable ? '' : ' disabled') + '>' + escapeHtml(clauseText) + '</textarea>';
                    if (editable) {
                        html += '<div class="pv-page-clause-actions">';
                        html += '<button class="pv-doc-clause-btn save-lib" onclick="saveClauseBackToLibrary(' + idx + ')" title="Sauvegarder dans la biblioth\u00e8que">' + t('biblio') + '</button>';
                        html += '<button class="pv-doc-clause-btn remove" onclick="removeClauseFromSubmission(' + idx + ')" title="Retirer">\u2715</button>';
                        html += '</div>';
                    }
                    html += '</div>';
                });

                if (editable) {
                    html += '<div class="pv-clause-dropzone" id="pvClauseDropZone"';
                    html += ' ondragover="onClauseDropZoneDragOver(event)"';
                    html += ' ondragleave="onClauseDropZoneDragLeave(event)"';
                    html += ' ondrop="onClauseDropZoneDrop(event)">';
                    html += t('dropClause');
                    html += '</div>';
                }

                html += '</div></div>';
            }

            // ── Total page (last) ──
            html += '<div class="pv-page pv-page-total">';
            if (allInstallExcluded) {
                html += '<div class="pv-install-total-note">' + (currentLang === 'en' ? 'Installation not included' : 'Installation non incluse') + '</div>';
            }
            html += '<div class="pv-total-box">';
            var discountType = currentSubmission ? currentSubmission.discount_type : null;
            var discountValue = currentSubmission ? currentSubmission.discount_value : null;
            if (discountType && discountValue > 0) {
                var discountAmt = discountType === 'percentage' ? grandTotal * discountValue / 100 : discountValue;
                var finalTotal = grandTotal - discountAmt;
                var discountLabel = discountType === 'percentage'
                    ? (currentLang === 'en' ? 'Discount (' + discountValue + '%)' : 'Rabais (' + discountValue + '%)')
                    : (currentLang === 'en' ? 'Discount' : 'Rabais');
                html += '<div class="pv-total-breakdown">';
                html += '<div class="pv-total-subtotal-line"><span>' + (currentLang === 'en' ? 'Subtotal' : 'Sous-total') + '</span><span>' + formatPrice(grandTotal) + '</span></div>';
                html += '<div class="pv-total-discount-line"><span>' + escapeHtml(discountLabel) + '</span><span>- ' + formatPrice(discountAmt) + '</span></div>';
                html += '<div class="pv-total-divider"></div>';
                html += '</div>';
                html += '<div class="total-label">' + t('total') + '</div>';
                html += '<div class="total-amount">' + formatPrice(finalTotal) + '</div>';
            } else {
                html += '<div class="total-label">' + t('total') + '</div>';
                html += '<div class="total-amount">' + formatPrice(grandTotal) + '</div>';
            }
            html += '<div class="total-taxes">' + t('taxes') + '</div>';
            html += '</div>';
            // footer text removed
            html += '</div>';

            // ── Steps page ──
            var steps = t('steps');
            if (steps && Array.isArray(steps)) {
                // Gradient from dark green to light green
                var stepColors = ['#2f3e34','#3a4b3f','#45584a','#4b6050','#5e7462','#718874','#849c86','#97b098'];
                html += '<div class="pv-page pv-page-steps">';
                html += '<div class="pv-steps-title">' + escapeHtml(t('stepsTitle')) + '</div>';
                html += '<div class="pv-steps-grid">';
                steps.forEach(function(step, i) {
                    html += '<div class="pv-step">';
                    html += '<div class="pv-step-circle" style="background:' + stepColors[i] + '">' + (i + 1) + '</div>';
                    html += '<div class="pv-step-content">';
                    html += '<div class="pv-step-label">' + escapeHtml(step.label) + '</div>';
                    html += '<div class="pv-step-desc">' + escapeHtml(step.desc) + '</div>';
                    html += '</div></div>';
                });
                html += '</div></div>';
            }

            // (acceptance proof is on the title page)

            container.innerHTML = html;
            wirePreviewSaveHandlers();
        }

        function wirePreviewSaveHandlers() {
            // Room descriptions — save HTML to correct lang field + stale detection
            document.querySelectorAll('#pvContent .pv-page-room-desc').forEach(function(el) {
                el.addEventListener('blur', function() {
                    var gid = this.getAttribute('data-group-id');
                    if (!gid || !roomMap[gid]) return;
                    var htmlContent = this.innerHTML.trim();
                    if (currentLang === 'en') {
                        roomDescEN[gid] = htmlContent;
                        updateRoom(roomMap[gid], { client_description_en: htmlContent });
                    } else {
                        roomDescHTML[gid] = htmlContent;
                        updateRoom(roomMap[gid], { client_description: htmlContent });
                        var calcDesc = document.getElementById(gid + '-clientDesc');
                        if (calcDesc) calcDesc.value = this.textContent; // plain text for calc textarea
                        // Stale detection: FR changed → clear EN
                        if (roomDescEN[gid]) {
                            roomDescEN[gid] = '';
                            updateRoom(roomMap[gid], { client_description_en: '' });
                        }
                    }
                    showSaveIndicator();
                });
            });

            // Auto-resize clause textareas to fit content
            document.querySelectorAll('#pvContent .pv-page-clause-text').forEach(function(ta) {
                ta.style.height = 'auto';
                ta.style.height = ta.scrollHeight + 'px';
                ta.addEventListener('input', function() { this.style.height = 'auto'; this.style.height = this.scrollHeight + 'px'; });
            });

            // Clause texts — save to correct lang field + stale detection
            document.querySelectorAll('#pvContent .pv-page-clause-text').forEach(function(textarea) {
                textarea.addEventListener('blur', function() {
                    var idx = parseInt(this.getAttribute('data-clause-idx'), 10);
                    if (isNaN(idx)) return;
                    if (currentLang === 'en') {
                        updateClauseTextEN(idx, this.value);
                    } else {
                        updateClauseText(idx, this.value);
                        // Stale detection: FR changed → clear EN
                        var clauses = getSubmissionClauses();
                        if (clauses[idx] && clauses[idx].content_en) {
                            clauses[idx].content_en = '';
                            saveSubmissionClauses(clauses);
                        }
                    }
                });
            });
        }

        // ═══════════════════════════════════════════════════════════════════════
        // MODE PRÉSENTATION (IFRAME quote.html)
        // ═══════════════════════════════════════════════════════════════════════

        async function openPresentation() {
            if (!currentSubmission) return;

            // Fetch existing token, or create one on-the-fly for preview
            var r = await authenticatedFetch(
                SUPABASE_URL + '/rest/v1/public_quote_tokens?submission_id=eq.' + currentSubmission.id + '&order=created_at.desc&limit=1', {}
            );
            if (!r.ok) { steleAlert('Erreur chargement du token.'); return; }
            var tokens = await r.json();
            var token;

            if (tokens.length > 0) {
                token = tokens[0].token;
            } else {
                // No token yet — create a preview token (no status change, no notification)
                var cr = await authenticatedFetch(SUPABASE_URL + '/rest/v1/public_quote_tokens', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                    body: JSON.stringify({ submission_id: currentSubmission.id })
                });
                if (!cr.ok) { steleAlert('Erreur cr\u00e9ation du lien de pr\u00e9visualisation.'); return; }
                var created = await cr.json();
                token = created[0].token;
            }

            var url = window.location.origin + '/quote.html?token=' + token;

            // Build overlay
            var overlay = document.createElement('div');
            overlay.className = 'pres-iframe-overlay';
            overlay.id = 'presIframeOverlay';
            overlay.innerHTML =
                '<div class="pres-iframe-toolbar">' +
                    '<button onclick="closePresentation()">&larr; Fermer</button>' +
                    '<span>Pr\u00e9sentation client</span>' +
                '</div>' +
                '<iframe src="' + escapeAttr(url) + '"></iframe>';
            document.body.appendChild(overlay);

            // Escape to close
            document.addEventListener('keydown', presEscHandler);
        }

        function closePresentation() {
            var overlay = document.getElementById('presIframeOverlay');
            if (overlay) overlay.remove();
            document.removeEventListener('keydown', presEscHandler);
        }

        function presEscHandler(e) {
            if (e.key === 'Escape') closePresentation();
        }

        // ═══════════════════════════════════════════════════════════════════════
        // NAVIGATION ENTRE VUES
        // ═══════════════════════════════════════════════════════════════════════

        function showProjectList() {
            document.getElementById('projectListView').classList.add('active');
            document.getElementById('calculatorView').classList.remove('active');
            document.getElementById('previewView').classList.remove('active');
            currentProject = null;
            currentSubmission = null;
            roomMap = {};
            itemMap = {};
            groupImages = {};
            roomModifiers = {};
            roomDM = {};
            dmChoiceCache = {};
            roomDescEN = {};
            roomDescHTML = {};
            renderProjectList();
        }

        function showCalculator() {
            document.getElementById('projectListView').classList.remove('active');
            document.getElementById('calculatorView').classList.add('active');
            document.getElementById('previewView').classList.remove('active');
        }

        function backToProjectList() {
            if (isApprovalMode) {
                window.location.href = 'approbation.html';
                return;
            }
            showProjectList();
        }

        // ── Kebab menu ──
        function toggleHeaderKebab(e) {
            e.stopPropagation();
            var dropdown = document.getElementById('headerKebabDropdown');
            var btn = e.currentTarget;
            var isOpen = dropdown.classList.contains('open');
            dropdown.classList.toggle('open');
            btn.classList.toggle('active');
            if (!isOpen) {
                setTimeout(function() {
                    document.addEventListener('click', closeHeaderKebabOnOutside, { once: true });
                }, 0);
            }
        }
        function closeHeaderKebab() {
            var dd = document.getElementById('headerKebabDropdown');
            if (dd) dd.classList.remove('open');
            var btn = document.querySelector('.btn-kebab');
            if (btn) btn.classList.remove('active');
        }
        function closeHeaderKebabOnOutside(e) {
            if (!e.target.closest('.kebab-menu')) closeHeaderKebab();
        }

        function showSaveIndicator() {
            const el = document.getElementById('saveIndicator');
            el.textContent = 'Sauvegardé ✓';
            el.className = 'save-indicator saving';
            clearTimeout(el._timeout);
            el._timeout = setTimeout(() => { el.textContent = ''; el.className = 'save-indicator'; }, 2000);
        }

        // ═══════════════════════════════════════════════════════════════════════
        // RENDU LISTE DE PROJETS
        // ═══════════════════════════════════════════════════════════════════════

        var STATUS_LABELS = {
            'draft': 'Brouillon', 'pending_internal': 'En approbation', 'returned': 'Retourn\u00e9e',
            'approved_internal': 'Pr\u00eate \u00e0 envoyer', 'sent_client': 'Envoy\u00e9e', 'accepted': 'Vendue',
            'lost': 'Perdue',
            // Legacy
            'brouillon': 'Brouillon', 'soumis': 'Soumis', 'approuv\u00e9': 'Approuv\u00e9',
            'envoy\u00e9': 'Envoy\u00e9', 'sign\u00e9': 'Sign\u00e9'
        };

        function updateStatusBadge(status) {
            var badge = document.getElementById('subStatusBadge');
            if (!badge) return;
            var label = STATUS_LABELS[status] || status;
            badge.className = 'status-badge status-' + status;
            var locked = !isSubmissionCurrentlyEditable();
            var prefix = locked ? '\uD83D\uDD12 ' : '';
            if (currentSubmission && currentSubmission.bypass_approval) {
                badge.innerHTML = escapeHtml(prefix + label) + ' <span class="bypass-badge">BYPASS</span>';
            } else {
                badge.textContent = prefix + label;
            }
        }

        function updateStatusTimeline() {
            var container = document.getElementById('statusTimeline');
            if (!container || !currentSubmission) {
                if (container) container.innerHTML = '';
                return;
            }

            var status = currentSubmission.status;

            // Define 6 timeline steps (last step is dynamic: Vendue or Perdue)
            var lastStep = status === 'lost'
                ? { key: 'lost', label: 'Perdue' }
                : { key: 'accepted', label: 'Vendue' };
            var steps = [
                { key: 'draft', label: 'Brouillon' },
                { key: 'pending_internal', label: 'En approbation' },
                { key: 'returned', label: 'Retourn\u00e9e' },
                { key: 'approved_internal', label: 'Pr\u00eate \u00e0 envoyer' },
                { key: 'sent_client', label: 'Envoy\u00e9e' },
                lastStep
            ];

            // Determine step state for each step
            function getStepState(stepKey) {
                if (stepKey === status) return 'active';

                // Special: "returned" is only active when status is returned, otherwise always future
                if (stepKey === 'returned') {
                    return (status === 'returned') ? 'active' : 'future';
                }

                // Linear progression for other steps
                switch (status) {
                    case 'draft':
                        return 'future';
                    case 'pending_internal':
                        return (stepKey === 'draft') ? 'completed' : 'future';
                    case 'returned':
                        return (stepKey === 'draft' || stepKey === 'pending_internal') ? 'completed' : 'future';
                    case 'approved_internal':
                        return (stepKey === 'draft' || stepKey === 'pending_internal') ? 'completed' : 'future';
                    case 'sent_client':
                        return (stepKey === 'draft' || stepKey === 'pending_internal' || stepKey === 'approved_internal') ? 'completed' : 'future';
                    case 'accepted':
                        return (stepKey === 'draft' || stepKey === 'pending_internal' || stepKey === 'approved_internal' || stepKey === 'sent_client') ? 'completed' : 'future';
                    case 'lost':
                        return (stepKey === 'draft' || stepKey === 'pending_internal' || stepKey === 'approved_internal' || stepKey === 'sent_client') ? 'completed' : 'future';
                    default:
                        return 'future';
                }
            }

            var html = '';
            steps.forEach(function(step) {
                var stepState = getStepState(step.key);
                var classNames = 'timeline-step ' + stepState;
                if (step.key === 'returned' && stepState === 'active') classNames += ' returned';
                if (step.key === 'lost' && stepState === 'active') classNames += ' lost';

                // Rendre "Envoyée" cliquable pour copier le lien client
                var isClickable = (status === 'sent_client' && step.key === 'sent_client');
                if (isClickable) classNames += ' clickable';

                var onclick = isClickable ? ' onclick="copyQuoteLink()" title="Cliquer pour copier le lien client"' : '';

                html += '<div class="' + classNames + '"' + onclick + '>';
                html += '<div class="timeline-circle">';
                if (stepState === 'completed') {
                    html += '\u2713'; // checkmark
                } else {
                    html += '&nbsp;';
                }
                html += '</div>';
                html += '<span class="timeline-label">' + escapeHtml(step.label) + '</span>';
                html += '</div>';
            });

            // CTA button at the end
            var cta = null;
            if (status === 'draft' || status === 'returned') {
                if (canBypassApproval) {
                    cta = { text: 'Envoyer au client', action: 'bypassApproval()', className: '', secondaryText: status === 'returned' ? 'Resoumettre' : 'Soumettre', secondaryAction: 'openSubmitModal()', secondaryClassName: status === 'returned' ? 'btn-outline-orange' : 'btn-outline' };
                } else {
                    cta = { text: status === 'returned' ? 'Resoumettre' : 'Soumettre', action: 'openSubmitModal()', className: status === 'returned' ? 'btn-orange' : '' };
                }
            } else if (status === 'pending_internal' && canApproveQuotes) {
                cta = { text: 'Approuver', action: 'approveSubmission()', className: '', secondaryText: 'Retourner', secondaryAction: 'returnSubmission()', secondaryClassName: 'btn-outline-orange' };
            } else if (status === 'approved_internal') {
                cta = { text: 'Envoyer au client', action: 'sendToClient()', className: '' };
            } else if (status === 'sent_client') {
                cta = { text: 'Confirmer la vente', action: 'offlineAcceptance()', className: '', secondaryText: 'Marquer comme perdu', secondaryAction: 'openLostModal()', secondaryClassName: 'btn-outline-red' };
            } else if (status === 'lost') {
                cta = { text: 'Rouvrir', action: 'reopenLostSubmission()', className: 'btn-outline' };
            }

            if (cta) {
                html += '<div class="timeline-cta">';
                if (cta.secondaryText) {
                    html += '<button onclick="' + cta.secondaryAction + '" class="' + (cta.secondaryClassName || '') + '">' + escapeHtml(cta.secondaryText) + '</button> ';
                }
                html += '<button onclick="' + cta.action + '" class="' + (cta.className || '') + '">' + escapeHtml(cta.text) + '</button>';
                html += '</div>';
            }

            container.innerHTML = html;
        }

        // ── Pipeline helpers ──

        function getPipelineStatus(slug) {
            return pipelineStatuses.find(function(s) { return s.slug === slug; }) || { slug: slug, label: slug || '—', color: '#9e9e9e' };
        }

        function getContactByRole(proj, role) {
            if (!proj.project_contacts) return '';
            var candidates = proj.project_contacts.filter(function(pc) { return pc.role === role && pc.contacts; });
            if (candidates.length === 0) return '';
            // Prefer is_primary; if none marked, take first
            var match = candidates.find(function(pc) { return pc.is_primary; }) || candidates[0];
            var c = match.contacts;
            // If contact has a company, show company name
            var companies = (c.contact_companies || []).map(function(cc) { return cc.companies ? cc.companies.name : ''; }).filter(Boolean);
            if (companies.length > 0) return companies[0];
            return ((c.first_name || '') + ' ' + (c.last_name || '')).trim();
        }

        // Full tooltip: contact name + company
        function getContactTooltipByRole(proj, role) {
            if (!proj.project_contacts) return '';
            var candidates = proj.project_contacts.filter(function(pc) { return pc.role === role && pc.contacts; });
            if (candidates.length === 0) return '';
            var match = candidates.find(function(pc) { return pc.is_primary; }) || candidates[0];
            var c = match.contacts;
            var name = ((c.first_name || '') + ' ' + (c.last_name || '')).trim();
            var companies = (c.contact_companies || []).map(function(cc) { return cc.companies ? cc.companies.name : ''; }).filter(Boolean);
            if (companies.length > 0) return name + ' — ' + companies[0];
            return name;
        }

        function getClosestDeadline(proj) {
            var dates = [];
            if (proj.internal_deadline) dates.push(proj.internal_deadline);
            if (proj.client_deadline) dates.push(proj.client_deadline);
            (proj.submissions || []).forEach(function(s) {
                if (s.internal_deadline) dates.push(s.internal_deadline);
                if (s.client_deadline) dates.push(s.client_deadline);
            });
            if (dates.length === 0) return null;
            dates.sort();
            return dates[0];
        }

        function formatMoney(n) {
            if (n == null || isNaN(n)) return '—';
            return parseFloat(n).toLocaleString('fr-CA', { style: 'currency', currency: 'CAD', minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }

        function formatDateShort(d) {
            if (!d) return '\u2014';
            var parts = d.split('-');
            if (parts.length === 3) return parts[2] + '/' + parts[1];
            return d;
        }

        var MONTH_NAMES_FR = ['janv.','f\u00e9vr.','mars','avr.','mai','juin','juil.','ao\u00fbt','sept.','oct.','nov.','d\u00e9c.'];
        function formatMonthYear(m) {
            if (!m) return '\u2014';
            var parts = m.split('-');
            if (parts.length >= 2) {
                var mi = parseInt(parts[1], 10) - 1;
                return (MONTH_NAMES_FR[mi] || parts[1]) + ' ' + parts[0];
            }
            return m;
        }

        // Returns { value: number|null, isOverride: boolean } for a project's display amount
        function getProjectDisplayAmount(p) {
            if (p.amount_override != null) return { value: parseFloat(p.amount_override), isOverride: true };
            // Sum approved_total across submissions
            var total = 0; var hasAny = false;
            (p.submissions || []).forEach(function(s) {
                if (s.approved_total) { total += parseFloat(s.approved_total); hasAny = true; }
            });
            if (hasAny) return { value: total, isOverride: false };
            if (p.estimated_amount != null) return { value: parseFloat(p.estimated_amount), isOverride: false };
            return { value: null, isOverride: false };
        }

        function renderAmountCell(p) {
            var da = getProjectDisplayAmount(p);
            if (da.isOverride) {
                return '<span class="amount-override" data-tooltip="Montant estim\u00e9 manuellement">' + formatMoney(da.value) + '</span>';
            }
            return formatMoney(da.value);
        }

        function startAmountEdit(td, projectId, evt) {
            evt.stopPropagation();
            if (td.querySelector('.amount-inline-input')) return;
            var proj = cachedProjects.find(function(p) { return p.id === projectId; });
            var current = proj && proj.amount_override != null ? String(Math.round(proj.amount_override)) : '';
            td.innerHTML = '<input class="amount-inline-input" type="text" value="' + current + '" placeholder="Montant...">';
            var input = td.querySelector('input');
            input.focus();
            input.select();
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') { input.blur(); }
                if (e.key === 'Escape') { renderCurrentView(); }
            });
            input.addEventListener('blur', function() {
                saveAmountOverride(projectId, input.value.trim());
            });
        }

        async function saveAmountOverride(projectId, rawValue) {
            var val = rawValue.replace(/[^0-9.,]/g, '').replace(',', '.');
            var numericVal = val === '' ? null : parseFloat(val);
            if (val !== '' && isNaN(numericVal)) { renderCurrentView(); return; }
            var proj = cachedProjects.find(function(p) { return p.id === projectId; });
            if (proj) proj.amount_override = numericVal;
            renderCurrentView();
            await updateProject(projectId, { amount_override: numericVal });
        }

        // ── Inline edit helpers ──

        function inlineEditSelect(td, projectId, field, options, currentVal, evt) {
            evt.stopPropagation();
            if (td.querySelector('select')) return;
            var html = '<select class="inline-edit-select">';
            options.forEach(function(opt) {
                var val = typeof opt === 'object' ? opt.value : opt;
                var label = typeof opt === 'object' ? opt.label : opt;
                html += '<option value="' + escapeAttr(val) + '"' + (val === currentVal ? ' selected' : '') + '>' + escapeHtml(label) + '</option>';
            });
            html += '</select>';
            td.innerHTML = html;
            var sel = td.querySelector('select');
            sel.focus();
            sel.addEventListener('change', function() { saveInlineField(projectId, field, sel.value); });
            sel.addEventListener('blur', function() { saveInlineField(projectId, field, sel.value); });
            sel.addEventListener('keydown', function(e) { if (e.key === 'Escape') renderCurrentView(); });
        }

        function inlineEditText(td, projectId, field, currentVal, inputType, evt) {
            evt.stopPropagation();
            if (td.querySelector('input')) return;
            td.innerHTML = '<input class="inline-edit-input" type="' + (inputType || 'text') + '" value="' + escapeAttr(currentVal || '') + '">';
            var input = td.querySelector('input');
            input.focus();
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') input.blur();
                if (e.key === 'Escape') renderCurrentView();
            });
            input.addEventListener('blur', function() { saveInlineField(projectId, field, input.value.trim() || null); });
        }

        function openPriorityDropdown(el, projectId, evt) {
            evt.stopPropagation();
            evt.preventDefault();
            // Close any existing dropdown
            var existing = document.querySelector('.prio-dropdown');
            if (existing) existing.remove();

            var container = el.closest('.name-cell-inner');
            if (!container) return;

            var dd = document.createElement('div');
            dd.className = 'prio-dropdown';
            dd.innerHTML =
                '<div class="prio-dropdown-item" data-val="normal"><span class="prio-dropdown-dot" style="background:#ccc;"></span> Normal</div>' +
                '<div class="prio-dropdown-item" data-val="haute"><span class="prio-dropdown-dot" style="background:#F59E0B;"></span> Haute</div>' +
                '<div class="prio-dropdown-item" data-val="urgente"><span class="prio-dropdown-dot" style="background:#EF4444;"></span> Urgente</div>';
            container.appendChild(dd);

            dd.querySelectorAll('.prio-dropdown-item').forEach(function(item) {
                item.addEventListener('click', function(e) {
                    e.stopPropagation();
                    var val = item.getAttribute('data-val');
                    var proj = cachedProjects.find(function(p) { return p.id === projectId; });
                    if (proj) proj.priority = val;
                    dd.remove();
                    renderCurrentView();
                    updateProject(projectId, { priority: val });
                });
            });

            // Close on outside click
            setTimeout(function() {
                document.addEventListener('click', function closePrio(e) {
                    if (!dd.contains(e.target)) {
                        dd.remove();
                        document.removeEventListener('click', closePrio);
                    }
                });
            }, 0);
        }

        function openStatusDropdown(td, projectId, currentSlug, evt) {
            evt.stopPropagation();
            // Close any existing status dropdown
            var existing = document.querySelector('.status-dropdown');
            if (existing) existing.remove();

            var badge = td.querySelector('.pipeline-badge') || td;
            var rect = badge.getBoundingClientRect();

            var dd = document.createElement('div');
            dd.className = 'status-dropdown';
            dd.setAttribute('tabindex', '-1');

            var focusIdx = -1;
            var items = [];

            pipelineStatuses.forEach(function(s, idx) {
                var isActive = s.slug === currentSlug;
                if (isActive) focusIdx = idx;
                var item = document.createElement('div');
                item.className = 'status-dropdown-item' + (isActive ? ' sd-focused' : '');
                item.setAttribute('data-val', s.slug);
                item.setAttribute('data-idx', idx);
                item.innerHTML =
                    '<span class="sd-dot" style="background:' + s.color + ';"></span>' +
                    '<span class="sd-label">' + escapeHtml(s.label) + '</span>' +
                    '<span class="sd-check">' + (isActive ? '✓' : '') + '</span>';
                dd.appendChild(item);
                items.push(item);

                item.addEventListener('click', function(e) {
                    e.stopPropagation();
                    closeDD();
                    if (s.slug !== currentSlug) saveInlineField(projectId, 'pipeline_status', s.slug);
                });
                item.addEventListener('mouseenter', function() {
                    setFocus(idx);
                });
            });

            function setFocus(idx) {
                items.forEach(function(it) { it.classList.remove('sd-focused'); });
                if (idx >= 0 && idx < items.length) {
                    focusIdx = idx;
                    items[idx].classList.add('sd-focused');
                    items[idx].scrollIntoView({ block: 'nearest' });
                }
            }

            function closeDD() {
                dd.remove();
                document.removeEventListener('click', onOutsideClick);
                document.removeEventListener('keydown', onKeyDown);
            }

            function onOutsideClick(e) {
                if (!dd.contains(e.target)) closeDD();
            }

            function onKeyDown(e) {
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    setFocus(Math.min(focusIdx + 1, items.length - 1));
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    setFocus(Math.max(focusIdx - 1, 0));
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (focusIdx >= 0 && items[focusIdx]) items[focusIdx].click();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    closeDD();
                }
            }

            document.body.appendChild(dd);

            // Position: below badge, flip up if near bottom
            var ddRect = dd.getBoundingClientRect();
            var top = rect.bottom + 4;
            var left = rect.left;
            if (top + ddRect.height > window.innerHeight - 8) {
                top = rect.top - ddRect.height - 4;
            }
            if (left + ddRect.width > window.innerWidth - 8) {
                left = window.innerWidth - ddRect.width - 8;
            }
            dd.style.top = top + 'px';
            dd.style.left = left + 'px';

            dd.focus();

            setTimeout(function() {
                document.addEventListener('click', onOutsideClick);
                document.addEventListener('keydown', onKeyDown);
            }, 0);
        }

        // ── Generic inline dropdown (same style as status) ──
        function openInlineDropdown(td, projectId, field, options, currentVal, evt) {
            evt.stopPropagation();
            var existing = document.querySelector('.status-dropdown');
            if (existing) existing.remove();

            var rect = td.getBoundingClientRect();

            var dd = document.createElement('div');
            dd.className = 'status-dropdown';
            dd.setAttribute('tabindex', '-1');

            var focusIdx = -1;
            var items = [];

            options.forEach(function(opt, idx) {
                var val = typeof opt === 'object' ? opt.value : opt;
                var label = typeof opt === 'object' ? opt.label : opt;
                var isActive = val === currentVal;
                if (isActive) focusIdx = idx;
                var item = document.createElement('div');
                item.className = 'status-dropdown-item' + (isActive ? ' sd-focused' : '');
                item.setAttribute('data-val', val);
                item.setAttribute('data-idx', idx);
                item.innerHTML =
                    '<span class="sd-label">' + escapeHtml(label) + '</span>' +
                    '<span class="sd-check">' + (isActive ? '\u2713' : '') + '</span>';
                dd.appendChild(item);
                items.push(item);

                item.addEventListener('click', function(e) {
                    e.stopPropagation();
                    closeDD();
                    if (val !== currentVal) saveInlineField(projectId, field, val);
                });
                item.addEventListener('mouseenter', function() {
                    setFocus(idx);
                });
            });

            function setFocus(idx) {
                items.forEach(function(it) { it.classList.remove('sd-focused'); });
                if (idx >= 0 && idx < items.length) {
                    focusIdx = idx;
                    items[idx].classList.add('sd-focused');
                    items[idx].scrollIntoView({ block: 'nearest' });
                }
            }

            function closeDD() {
                dd.remove();
                document.removeEventListener('click', onOutsideClick);
                document.removeEventListener('keydown', onKeyDown);
            }

            function onOutsideClick(e) {
                if (!dd.contains(e.target)) closeDD();
            }

            function onKeyDown(e) {
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    setFocus(Math.min(focusIdx + 1, items.length - 1));
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    setFocus(Math.max(focusIdx - 1, 0));
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (focusIdx >= 0 && items[focusIdx]) items[focusIdx].click();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    closeDD();
                }
            }

            document.body.appendChild(dd);

            var ddRect = dd.getBoundingClientRect();
            var top = rect.bottom + 4;
            var left = rect.left;
            if (top + ddRect.height > window.innerHeight - 8) {
                top = rect.top - ddRect.height - 4;
            }
            if (left + ddRect.width > window.innerWidth - 8) {
                left = window.innerWidth - ddRect.width - 8;
            }
            dd.style.top = top + 'px';
            dd.style.left = left + 'px';

            dd.focus();
            setTimeout(function() {
                document.addEventListener('click', onOutsideClick);
                document.addEventListener('keydown', onKeyDown);
            }, 0);
        }

        // ── Date Picker (Apple/Linear style) ──
        var DP_MONTHS_FR = ['Janvier','Février','Mars','Avril','Mai','Juin','Juillet','Août','Septembre','Octobre','Novembre','Décembre'];
        var DP_MONTHS_EN = ['January','February','March','April','May','June','July','August','September','October','November','December'];
        var DP_DAYS_FR = ['Lu','Ma','Me','Je','Ve','Sa','Di'];
        var DP_DAYS_EN = ['Mo','Tu','We','Th','Fr','Sa','Su'];

        // ── Date picker global state (for inline onclick handlers) ──
        var _dp = null; // { el, projectId, field, selectedDate, viewDate, onOutside, onKey }

        function _dpClose() {
            if (!_dp) return;
            _dp.el.remove();
            document.removeEventListener('mousedown', _dp.onOutside);
            document.removeEventListener('keydown', _dp.onKey);
            _dp = null;
        }

        function _dpNav(dir) {
            if (!_dp) return;
            _dp.viewDate.setMonth(_dp.viewDate.getMonth() + dir);
            _dpRender();
        }

        function _dpSelect(iso) {
            if (!_dp) return;
            var projectId = _dp.projectId;
            var field = _dp.field;
            _dpClose();
            saveInlineField(projectId, field, iso);
        }

        function _dpToday() {
            var d = new Date();
            var pad = function(n) { return n < 10 ? '0' + n : '' + n; };
            _dpSelect(d.getFullYear() + '-' + pad(d.getMonth() + 1) + '-' + pad(d.getDate()));
        }

        function _dpClear() {
            if (!_dp) return;
            var projectId = _dp.projectId;
            var field = _dp.field;
            _dpClose();
            saveInlineField(projectId, field, null);
        }

        function _dpRender() {
            if (!_dp) return;
            var y = _dp.viewDate.getFullYear();
            var m = _dp.viewDate.getMonth();
            var months = DP_MONTHS_FR;
            var dayNames = DP_DAYS_FR;
            var today = new Date();
            var sel = _dp.selectedDate;

            function pad(n) { return n < 10 ? '0' + n : '' + n; }
            function toISO(d) { return d.getFullYear() + '-' + pad(d.getMonth() + 1) + '-' + pad(d.getDate()); }
            function isSameDay(a, b) { return a && b && a.getFullYear() === b.getFullYear() && a.getMonth() === b.getMonth() && a.getDate() === b.getDate(); }

            var html = '<div class="dp-header">';
            html += '<span class="dp-header-title">' + escapeHtml(months[m]) + ' ' + y + '</span>';
            html += '<div class="dp-nav">';
            html += '<button type="button" class="dp-nav-btn" onclick="_dpNav(-1);event.stopPropagation()">&#8249;</button>';
            html += '<button type="button" class="dp-nav-btn" onclick="_dpNav(1);event.stopPropagation()">&#8250;</button>';
            html += '</div></div>';

            html += '<div class="dp-weekdays">';
            dayNames.forEach(function(d) { html += '<span>' + d + '</span>'; });
            html += '</div>';

            html += '<div class="dp-grid">';

            var firstDay = new Date(y, m, 1).getDay();
            var startOffset = (firstDay + 6) % 7;
            var daysInMonth = new Date(y, m + 1, 0).getDate();

            // Previous month days
            for (var i = startOffset - 1; i >= 0; i--) {
                var dt = new Date(y, m, -i);
                html += '<button type="button" class="dp-day outside" onclick="_dpSelect(\'' + toISO(dt) + '\');event.stopPropagation()">' + dt.getDate() + '</button>';
            }

            // Current month days
            for (var d = 1; d <= daysInMonth; d++) {
                var dt = new Date(y, m, d);
                var cls = 'dp-day';
                if (isSameDay(dt, today)) cls += ' today';
                if (isSameDay(dt, sel)) cls += ' selected';
                html += '<button type="button" class="' + cls + '" onclick="_dpSelect(\'' + toISO(dt) + '\');event.stopPropagation()">' + d + '</button>';
            }

            // Next month days
            var totalCells = startOffset + daysInMonth;
            var remaining = (7 - (totalCells % 7)) % 7;
            for (var d = 1; d <= remaining; d++) {
                var dt = new Date(y, m + 1, d);
                html += '<button type="button" class="dp-day outside" onclick="_dpSelect(\'' + toISO(dt) + '\');event.stopPropagation()">' + d + '</button>';
            }

            html += '</div>';

            // Footer
            html += '<div class="dp-footer">';
            html += '<button type="button" class="dp-footer-btn dp-today-btn" onclick="_dpToday();event.stopPropagation()">Aujourd\'hui</button>';
            if (sel) {
                html += '<button type="button" class="dp-footer-btn" onclick="_dpClear();event.stopPropagation()">Effacer</button>';
            }
            html += '</div>';

            _dp.el.innerHTML = html;
        }

        function openDatePicker(td, projectId, currentVal, field, evt) {
            evt.stopPropagation();
            _dpClose(); // close any existing

            var selectedDate = currentVal ? new Date(currentVal + 'T00:00:00') : null;
            var viewDate = selectedDate ? new Date(selectedDate) : new Date();
            viewDate.setDate(1);

            var dp = document.createElement('div');
            dp.className = 'dp-popover';
            dp.setAttribute('tabindex', '-1');
            document.body.appendChild(dp);

            function onOutside(e) {
                if (!dp.contains(e.target)) _dpClose();
            }
            function onKey(e) {
                if (e.key === 'Escape') { e.preventDefault(); _dpClose(); }
            }

            _dp = { el: dp, projectId: projectId, field: field, selectedDate: selectedDate, viewDate: viewDate, onOutside: onOutside, onKey: onKey };

            _dpRender();

            // Position
            var rect = td.getBoundingClientRect();
            var dpRect = dp.getBoundingClientRect();
            var top = rect.bottom + 4;
            var left = rect.left;
            if (top + dpRect.height > window.innerHeight - 8) {
                top = rect.top - dpRect.height - 4;
            }
            if (left + dpRect.width > window.innerWidth - 8) {
                left = window.innerWidth - dpRect.width - 8;
            }
            dp.style.top = top + 'px';
            dp.style.left = left + 'px';

            dp.focus();
            setTimeout(function() {
                document.addEventListener('mousedown', onOutside);
                document.addEventListener('keydown', onKey);
            }, 0);
        }

        async function saveInlineField(projectId, field, value) {
            var proj = cachedProjects.find(function(p) { return p.id === projectId; });
            if (proj) proj[field] = value;
            renderCurrentView();
            var patch = {};
            if (field === 'probability') {
                patch[field] = value ? parseInt(value) : 0;
            } else {
                patch[field] = value || null;
            }
            await updateProject(projectId, patch);
        }

        // ── Pipeline view switching ──

        function switchPipelineView(view) {
            // Auto-switch to cards on mobile if table requested
            if (view === 'table' && window.innerWidth < 768) view = 'cards';
            currentPipelineView = view;
            document.querySelectorAll('.pipeline-tab').forEach(function(t) {
                t.classList.toggle('active', t.getAttribute('data-view') === view);
            });
            document.getElementById('viewTableContainer').style.display = view === 'table' ? '' : 'none';
            document.getElementById('projectGrid').style.display = view === 'cards' ? '' : 'none';
            document.getElementById('viewSubmissions').style.display = view === 'submissions' ? '' : 'none';
            // Clean up colgroup when leaving table view to avoid stale widths
            if (view !== 'table') {
                var cg = document.querySelector('#pipelineTable colgroup');
                if (cg) cg.remove();
            }
            populateFilterDropdowns();
            renderCurrentView();
        }

        function populateFilterDropdowns() {
            // Status filter
            var sf = document.getElementById('pipelineStatusFilter');
            var currentVal = sf.value;
            sf.innerHTML = '<option value="">Tous les statuts</option>';
            if (currentPipelineView === 'submissions') {
                var subStatuses = [['draft','Brouillon'],['pending_internal','En approbation'],['returned','Retourn\u00e9e'],['approved_internal','Pr\u00eate'],['sent_client','Envoy\u00e9e'],['accepted','Vendue'],['lost','Perdue']];
                subStatuses.forEach(function(s) { sf.innerHTML += '<option value="' + s[0] + '">' + escapeHtml(s[1]) + '</option>'; });
            } else {
                pipelineStatuses.forEach(function(s) { sf.innerHTML += '<option value="' + escapeAttr(s.slug) + '">' + escapeHtml(s.label) + '</option>'; });
            }
            sf.value = currentVal;

            // Assigned filter
            var af = document.getElementById('pipelineAssignedFilter');
            var aVal = af.value;
            af.innerHTML = '<option value="">Tous les responsables</option>';
            EMPLOYEES_DATA.forEach(function(e) { af.innerHTML += '<option value="' + escapeAttr(e.name) + '">' + escapeHtml(e.name) + '</option>'; });
            af.value = aVal;

            // Type filter
            var tf = document.getElementById('pipelineTypeFilter');
            var tVal = tf.value;
            tf.innerHTML = '<option value="">Tous les types</option>';
            projectTypes.forEach(function(t) { tf.innerHTML += '<option value="' + escapeAttr(t) + '">' + escapeHtml(t) + '</option>'; });
            tf.value = tVal;

            // Hide type filter for submissions view
            tf.style.display = currentPipelineView === 'submissions' ? 'none' : '';
        }

        function applyPipelineFilters() {
            pipelineFilters.search = (document.getElementById('pipelineSearch').value || '').toLowerCase();
            pipelineFilters.status = document.getElementById('pipelineStatusFilter').value;
            pipelineFilters.assigned = document.getElementById('pipelineAssignedFilter').value;
            pipelineFilters.type = document.getElementById('pipelineTypeFilter').value;
            renderCurrentView();
        }

        function filterProjects(projects) {
            return projects.filter(function(p) {
                if (pipelineFilters.search) {
                    var s = pipelineFilters.search;
                    var haystack = [p.name, p.client_name, p.project_code, p.project_city, p.assigned_to].filter(Boolean).join(' ').toLowerCase();
                    if (haystack.indexOf(s) === -1) return false;
                }
                if (pipelineFilters.status && (p.pipeline_status || 'a_contacter') !== pipelineFilters.status) return false;
                if (pipelineFilters.assigned && p.assigned_to !== pipelineFilters.assigned) return false;
                if (pipelineFilters.type && p.project_type !== pipelineFilters.type) return false;
                if (pipelineFilters.followsOnly && !userFollows[p.id]) return false;
                return true;
            });
        }

        function renderCurrentView() {
            var filtered = filterProjects(cachedProjects);
            var empty = document.getElementById('projectEmpty');
            if (cachedProjects.length === 0) {
                empty.style.display = 'block';
                return;
            }
            empty.style.display = 'none';

            if (currentPipelineView === 'table') renderTableView(filtered);
            else if (currentPipelineView === 'cards') renderCardView(filtered);
            else if (currentPipelineView === 'submissions') renderSubmissionsView(filtered);
        }

        // ── Table view ──

        // Column definitions: hide = CSS class that hides at breakpoint, wCls = width class
        var TABLE_COLUMNS = [
            { key: 'follow',          label: '★',          wCls: 'col-w-follow',   hide: '' },
            { key: 'name',            label: 'Nom',        wCls: 'col-w-name',     hide: '' },
            { key: 'architecte',      label: 'Archit.',    wCls: 'col-w-contact',  hide: 'col-hide-md', computed: true },
            { key: 'entrepreneur',    label: 'Entrep.',    wCls: 'col-w-contact',  hide: 'col-hide-lg', computed: true },
            { key: 'display_amount',  label: 'Montant',    wCls: 'col-w-amount',   hide: '',            cls: 'col-amount' },
            { key: 'probability',     label: 'Prob%',      wCls: 'col-w-prob',     hide: 'col-always-hidden', cls: 'col-amount' },
            { key: 'pipeline_status', label: 'Statut',     wCls: 'col-w-status',   hide: '' },
            { key: 'deadline',        label: 'Remise',     wCls: 'col-w-deadline', hide: 'col-hide-lg', computed: true },
            { key: 'assigned_to',     label: 'Resp.',      wCls: 'col-w-resp',     hide: 'col-hide-lg' },
            { key: 'project_type',    label: 'Type',       wCls: 'col-w-type',     hide: 'col-hide-xl' }
        ];

        function renderTableView(projects) {
            var tbl = document.getElementById('pipelineTable');

            // Colgroup
            var cg = tbl.querySelector('colgroup');
            if (cg) cg.remove();
            var cgHtml = '<colgroup>';
            TABLE_COLUMNS.forEach(function(col) { cgHtml += '<col class="' + col.wCls + (col.hide ? ' ' + col.hide : '') + '">'; });
            cgHtml += '<col class="col-w-more">';
            cgHtml += '</colgroup>';
            tbl.insertAdjacentHTML('afterbegin', cgHtml);

            // Header
            var head = document.getElementById('pipelineTableHead');
            var hHtml = '<tr>';
            TABLE_COLUMNS.forEach(function(col) {
                var arrow = '';
                var sorted = pipelineSortColumn === col.key ? ' sorted' : '';
                if (pipelineSortColumn === col.key) {
                    arrow = pipelineSortDir === 'asc' ? '\u25B2' : '\u25BC';
                }
                hHtml += '<th class="' + sorted + (col.hide ? ' ' + col.hide : '') + '" onclick="sortPipelineTable(\'' + col.key + '\')"><span>' + col.label + '</span><span class="sort-arrow">' + arrow + '</span></th>';
            });
            hHtml += '<th class="col-w-more"></th>';
            hHtml += '</tr>';
            head.innerHTML = hHtml;

            // Sort
            var sorted = sortProjects(projects.slice());

            // Body
            var body = document.getElementById('pipelineTableBody');
            var bHtml = '';
            sorted.forEach(function(p) {
                var ps = getPipelineStatus(p.pipeline_status);
                var prob = p.probability || 0;
                var architecte = getContactByRole(p, 'Architecte');
                var architecteTip = getContactTooltipByRole(p, 'Architecte');
                var entrepreneur = getContactByRole(p, 'Entrepreneur');
                var entrepreneurTip = getContactTooltipByRole(p, 'Entrepreneur');
                var isFollowed = userFollows[p.id] ? ' active' : '';

                var pid = escapeAttr(p.id);

                var respOpts = [{value:'', label:'\u2014'}].concat(EMPLOYEES_DATA.map(function(e) { return {value: e.name, label: e.name}; }));
                var typeOpts = [{value:'', label:'\u2014'}].concat(projectTypes.map(function(t) { return {value: t, label: t}; }));

                // Priority indicator class
                var prioCls = p.priority === 'urgente' ? ' urgente' : (p.priority === 'haute' ? ' haute' : ' normal');
                var prioTitle = p.priority === 'urgente' ? 'Urgente' : (p.priority === 'haute' ? 'Haute' : '');

                var tblAlert = getProjectAlerts(p, (localStorage.getItem('sb_user_email') || '').toLowerCase());
                bHtml += '<tr onclick="pipelineRowClick(\'' + pid + '\')">';
                // ★ Follow
                bHtml += '<td><span class="follow-star' + isFollowed + '" onclick="toggleFollow(\'' + pid + '\',event)">\u2605</span></td>';
                // Nom with priority indicator + alert dot
                bHtml += '<td class="col-name"><div class="name-cell-inner">';
                bHtml += '<span class="prio-indicator' + prioCls + '" onclick="openPriorityDropdown(this,\'' + pid + '\',event)"' + (prioTitle ? ' title="' + prioTitle + '"' : '') + '></span>';
                if (tblAlert) bHtml += '<span class="project-alert-dot project-alert-dot--' + tblAlert.top.level + '" title="' + escapeAttr(tblAlert.top.msg) + '"></span>';
                bHtml += '<span title="' + escapeAttr(p.name || '') + '">' + escapeHtml(p.name || '\u2014') + '</span>';
                bHtml += '</div></td>';
                // Architecte
                bHtml += '<td class="col-hide-md" title="' + escapeAttr(architecteTip) + '">' + escapeHtml(architecte || '\u2014') + '</td>';
                // Entrepreneur
                bHtml += '<td class="col-hide-lg" title="' + escapeAttr(entrepreneurTip) + '">' + escapeHtml(entrepreneur || '\u2014') + '</td>';
                // Montant
                bHtml += '<td class="col-amount amount-cell" onclick="startAmountEdit(this,\'' + pid + '\',event)">' + renderAmountCell(p) + '</td>';
                // Prob% (always hidden in table, visible in drawer)
                bHtml += '<td class="col-always-hidden">' + (prob || '\u2014') + '</td>';
                // Statut pipeline
                bHtml += '<td class="inline-editable" onclick="openStatusDropdown(this,\'' + pid + '\',\'' + escapeAttr(p.pipeline_status || 'a_contacter') + '\',event)"><span class="pipeline-badge" style="background:' + ps.color + '20;color:' + ps.color + ';">' + escapeHtml(ps.label) + '</span></td>';
                // Remise
                var projDeadline = p.client_deadline || '';
                bHtml += '<td class="col-hide-lg inline-editable' + (projDeadline ? ' project-card-deadline' : '') + '" onclick="openDatePicker(this,\'' + pid + '\',\'' + escapeAttr(projDeadline) + '\',\'client_deadline\',event)">' + formatDateShort(projDeadline) + '</td>';
                // Responsable
                bHtml += '<td class="col-hide-lg inline-editable" onclick="openInlineDropdown(this,\'' + pid + '\',\'assigned_to\',' + escapeAttr(JSON.stringify(respOpts)) + ',\'' + escapeAttr(p.assigned_to || '') + '\',event)">' + escapeHtml(p.assigned_to || '\u2014') + '</td>';
                // Type
                bHtml += '<td class="col-hide-xl inline-editable" onclick="openInlineDropdown(this,\'' + pid + '\',\'project_type\',' + escapeAttr(JSON.stringify(typeOpts)) + ',\'' + escapeAttr(p.project_type || '') + '\',event)">' + escapeHtml(p.project_type || '\u2014') + '</td>';
                // More button
                bHtml += '<td class="col-w-more"><button class="tbl-more-btn" onclick="openProjectDrawer(\'' + pid + '\',event)" title="D\u00e9tails">\u2026</button></td>';
                bHtml += '</tr>';
            });
            body.innerHTML = bHtml || '<tr><td colspan="' + (TABLE_COLUMNS.length + 1) + '" style="text-align:center;color:#888;padding:24px;">Aucun projet ne correspond aux filtres.</td></tr>';
        }

        function sortProjects(arr) {
            var col = pipelineSortColumn;
            var dir = pipelineSortDir === 'asc' ? 1 : -1;
            return arr.sort(function(a, b) {
                var va, vb;
                if (col === 'follow') {
                    va = userFollows[a.id] ? 0 : 1;
                    vb = userFollows[b.id] ? 0 : 1;
                } else if (col === 'priority') {
                    var prioOrder = { urgente: 0, haute: 1, normal: 2 };
                    va = prioOrder[a.priority] != null ? prioOrder[a.priority] : 2;
                    vb = prioOrder[b.priority] != null ? prioOrder[b.priority] : 2;
                } else if (col === 'display_amount') {
                    va = (getProjectDisplayAmount(a).value || 0);
                    vb = (getProjectDisplayAmount(b).value || 0);
                } else if (col === 'deadline') {
                    va = a.client_deadline || 'zzzz';
                    vb = b.client_deadline || 'zzzz';
                } else if (col === 'architecte') {
                    va = getContactByRole(a, 'Architecte') || '';
                    vb = getContactByRole(b, 'Architecte') || '';
                } else if (col === 'entrepreneur') {
                    va = getContactByRole(a, 'Entrepreneur') || '';
                    vb = getContactByRole(b, 'Entrepreneur') || '';
                } else {
                    va = a[col]; vb = b[col];
                }
                if (va == null) va = '';
                if (vb == null) vb = '';
                if (typeof va === 'string') return va.localeCompare(vb) * dir;
                return (va - vb) * dir;
            });
        }

        function sortPipelineTable(col) {
            if (pipelineSortColumn === col) {
                pipelineSortDir = pipelineSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                pipelineSortColumn = col;
                pipelineSortDir = 'asc';
            }
            renderCurrentView();
        }

        function pipelineRowClick(projectId) {
            var proj = cachedProjects.find(function(p) { return p.id === projectId; });
            if (!proj) return;
            var subs = proj.submissions || [];
            if (subs.length > 0) {
                openSubmission(subs[0].id);
            } else {
                openProject(projectId);
            }
        }

        // ── Project detail drawer ──

        var _drawerProjectId = null;

        function drawerSave(field, value) {
            if (!_drawerProjectId) return;
            var proj = cachedProjects.find(function(p) { return p.id === _drawerProjectId; });
            if (proj) proj[field] = value;
            var patch = {};
            if (field === 'probability') patch[field] = value ? parseInt(value) : 0;
            else patch[field] = value || null;
            updateProject(_drawerProjectId, patch).then(function() { renderCurrentView(); });
        }

        function drawerSaveCity(value) {
            if (!_drawerProjectId) return;
            var proj = cachedProjects.find(function(p) { return p.id === _drawerProjectId; });
            if (!proj) return;
            proj.project_city = value;
            var newName = proj.project_code ? (value ? proj.project_code + ' ' + value : proj.project_code) : proj.name;
            proj.name = newName;
            document.getElementById('drawerProjectName').textContent = newName || 'Projet';
            var patch = { project_city: value || null, name: newName };
            updateProject(_drawerProjectId, patch).then(function() { renderCurrentView(); });
        }

        function openProjectDrawer(projectId, evt) {
            evt.stopPropagation();
            var p = cachedProjects.find(function(pr) { return pr.id === projectId; });
            if (!p) return;
            _drawerProjectId = projectId;
            document.getElementById('drawerProjectName').textContent = p.name || 'Projet';
            var ps = getPipelineStatus(p.pipeline_status);
            var da = getProjectDisplayAmount(p);
            var deadline = getClosestDeadline(p);
            var entrepreneur = getContactTooltipByRole(p, 'Entrepreneur');
            var architecte = getContactTooltipByRole(p, 'Architecte');
            var prob = p.probability || 0;

            // Build select options
            var statusOptions = pipelineStatuses.map(function(s) {
                return '<option value="' + escapeAttr(s.slug) + '"' + (s.slug === p.pipeline_status ? ' selected' : '') + '>' + escapeHtml(s.label) + '</option>';
            }).join('');

            var respOptions = '<option value="">—</option>' + EMPLOYEES_DATA.map(function(e) {
                return '<option value="' + escapeAttr(e.name) + '"' + (e.name === p.assigned_to ? ' selected' : '') + '>' + escapeHtml(e.name) + '</option>';
            }).join('');

            var prioOptions = ['normal', 'haute', 'urgente'].map(function(v) {
                var lbl = v === 'urgente' ? 'Urgente' : (v === 'haute' ? 'Haute' : 'Normal');
                return '<option value="' + v + '"' + (v === (p.priority || 'normal') ? ' selected' : '') + '>' + lbl + '</option>';
            }).join('');

            var typeOptions = '<option value="">—</option>' + projectTypes.map(function(t) {
                return '<option value="' + escapeAttr(t) + '"' + (t === p.project_type ? ' selected' : '') + '>' + escapeHtml(t) + '</option>';
            }).join('');

            var html = '';

            // Code (readonly)
            html += '<div class="drawer-field"><div class="drawer-field-label">Code</div><div class="drawer-field-value readonly">' + escapeHtml(p.project_code || '—') + '</div></div>';
            // Client (readonly — via contacts)
            html += '<div class="drawer-field"><div class="drawer-field-label">Client</div><div class="drawer-field-value readonly">' + escapeHtml(p.client_name || '—') + '</div></div>';
            // Entrepreneur (readonly — via contacts)
            html += '<div class="drawer-field"><div class="drawer-field-label">Entrepreneur</div><div class="drawer-field-value readonly">' + escapeHtml(entrepreneur || '—') + '</div></div>';
            // Architecte (readonly — via contacts)
            html += '<div class="drawer-field"><div class="drawer-field-label">Architecte</div><div class="drawer-field-value readonly">' + escapeHtml(architecte || '—') + '</div></div>';
            // Montant (readonly — calculated)
            html += '<div class="drawer-field"><div class="drawer-field-label">Montant</div><div class="drawer-field-value readonly">' + (da.value != null ? formatMoney(da.value) + (da.isOverride ? ' (estim\u00e9)' : '') : '—') + '</div></div>';
            // Probabilité
            html += '<div class="drawer-field"><div class="drawer-field-label">Probabilit\u00e9</div><input type="number" class="drawer-edit" min="0" max="100" value="' + (prob || '') + '" onchange="drawerSave(\'probability\',this.value)"></div>';
            // Responsable
            html += '<div class="drawer-field"><div class="drawer-field-label">Responsable</div><select class="drawer-edit" onchange="drawerSave(\'assigned_to\',this.value)">' + respOptions + '</select></div>';
            // Priorité
            html += '<div class="drawer-field"><div class="drawer-field-label">Priorit\u00e9</div><select class="drawer-edit" onchange="drawerSave(\'priority\',this.value)">' + prioOptions + '</select></div>';
            // Statut pipeline
            html += '<div class="drawer-field"><div class="drawer-field-label">Statut pipeline</div><select class="drawer-edit" onchange="drawerSave(\'pipeline_status\',this.value)">' + statusOptions + '</select></div>';
            // Type
            html += '<div class="drawer-field"><div class="drawer-field-label">Type</div><select class="drawer-edit" onchange="drawerSave(\'project_type\',this.value)">' + typeOptions + '</select></div>';
            // Ville
            html += '<div class="drawer-field"><div class="drawer-field-label">Ville</div><input type="text" class="drawer-edit" value="' + escapeAttr(p.project_city || '') + '" onchange="drawerSaveCity(this.value.trim())"></div>';
            // Source
            html += '<div class="drawer-field"><div class="drawer-field-label">Source</div><input type="text" class="drawer-edit" value="' + escapeAttr(p.source || '') + '" onchange="drawerSave(\'source\',this.value.trim())"></div>';
            // Livraison
            html += '<div class="drawer-field"><div class="drawer-field-label">Livraison</div><input type="month" class="drawer-edit" value="' + escapeAttr(p.delivery_month || '') + '" onchange="drawerSave(\'delivery_month\',this.value)"></div>';
            // Deadline interne
            html += '<div class="drawer-field"><div class="drawer-field-label">Deadline interne</div><input type="date" class="drawer-edit" value="' + escapeAttr(p.internal_deadline || '') + '" onchange="drawerSave(\'internal_deadline\',this.value)"></div>';
            // Deadline client
            html += '<div class="drawer-field"><div class="drawer-field-label">Deadline client</div><input type="date" class="drawer-edit" value="' + escapeAttr(p.client_deadline || '') + '" onchange="drawerSave(\'client_deadline\',this.value)"></div>';
            // Date remise (readonly — computed)
            if (deadline) {
                html += '<div class="drawer-field"><div class="drawer-field-label">Date remise</div><div class="drawer-field-value readonly">' + formatDateShort(deadline) + '</div></div>';
            }

            document.getElementById('drawerBody').innerHTML = html;
            document.getElementById('projectDrawerOverlay').classList.add('open');
            document.getElementById('projectDrawer').classList.add('open');
        }

        function closeProjectDrawer() {
            document.getElementById('projectDrawerOverlay').classList.remove('open');
            document.getElementById('projectDrawer').classList.remove('open');
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && document.getElementById('projectDrawer').classList.contains('open')) {
                closeProjectDrawer();
            }
        });

        // ── Deadline alert engine ──

        function getSubAlerts(sub, userEmail, today) {
            var alerts = [];
            if (!sub || !userEmail) return alerts;
            var s = sub.status;
            if (s === 'accepted' || s === 'lost' || sub.is_archived) return alerts;

            var email = userEmail.toLowerCase();
            var isEst = (sub.estimateur || '').toLowerCase() === email;
            var isVen = (sub.vendeur_cp || '').toLowerCase() === email;
            var isApp = (sub.approbateur || '').toLowerCase() === email;

            function daysDiff(dateStr) {
                if (!dateStr) return null;
                var d = new Date(dateStr + 'T00:00:00');
                return Math.ceil((d - today) / 86400000);
            }
            function fmtDate(dateStr) {
                if (!dateStr) return '';
                var d = new Date(dateStr + 'T00:00:00');
                return d.toLocaleDateString('fr-CA', { day: 'numeric', month: 'long' });
            }

            // Estimateur alerts
            if (isEst) {
                if (!sub.estimateur_accepted_at) {
                    alerts.push({ level: 'orange', msg: 'Nouvelle assignation', detail: 'Soumission #' + sub.submission_number + ' — nouvelle assignation' });
                }
                var dInt = daysDiff(sub.internal_deadline);
                if (dInt !== null) {
                    if (dInt < 0) alerts.push({ level: 'red', msg: 'En retard', detail: 'Remise interne d\u00e9pass\u00e9e (' + fmtDate(sub.internal_deadline) + ')' });
                    else if (dInt === 0) alerts.push({ level: 'red', msg: 'Remise aujourd\'hui', detail: 'Remise interne aujourd\'hui' });
                    else if (dInt <= 3) alerts.push({ level: 'orange', msg: 'Remise dans ' + dInt + 'j', detail: 'Remise interne dans ' + dInt + ' jour' + (dInt > 1 ? 's' : '') + ' (' + fmtDate(sub.internal_deadline) + ')' });
                }
            }

            // Vendeur alerts
            if (isVen) {
                var dInt2 = daysDiff(sub.internal_deadline);
                if (dInt2 !== null && dInt2 === 0) {
                    alerts.push({ level: 'orange', msg: 'V\u00e9rifier soumission', detail: 'Remise interne aujourd\'hui \u2014 v\u00e9rifier #' + sub.submission_number });
                }
                var dCli = daysDiff(sub.client_deadline);
                if (dCli !== null) {
                    if (dCli < 0) alerts.push({ level: 'red', msg: 'Remise client d\u00e9pass\u00e9e', detail: 'Remise client d\u00e9pass\u00e9e (' + fmtDate(sub.client_deadline) + ')' });
                    else if (dCli <= 1) alerts.push({ level: 'red', msg: 'Remise client imminente', detail: 'Remise client ' + (dCli === 0 ? 'aujourd\'hui' : 'demain') + ' (' + fmtDate(sub.client_deadline) + ')' });
                }
            }

            // Approbateur alerts
            if (isApp && s === 'pending_internal') {
                alerts.push({ level: 'orange', msg: 'En attente d\'approbation', detail: 'Soumission #' + sub.submission_number + ' en attente d\'approbation' });
            }

            return alerts;
        }

        function getProjectAlerts(proj, userEmail) {
            var subs = proj.submissions || [];
            var today = new Date(); today.setHours(0, 0, 0, 0);
            var all = [];
            subs.forEach(function(sub) {
                all = all.concat(getSubAlerts(sub, userEmail, today));
            });
            if (all.length === 0) return null;
            // Sort: red first, then orange
            all.sort(function(a, b) {
                return (a.level === 'red' ? 0 : 1) - (b.level === 'red' ? 0 : 1);
            });
            return { top: all[0], all: all };
        }

        function buildAlertBadgeHtml(projAlert) {
            if (!projAlert) return '';
            var top = projAlert.top;
            var tooltipLines = projAlert.all.map(function(a) { return escapeHtml(a.detail); }).join('<br>');
            return '<div class="project-alert-badge project-alert-badge--' + top.level + '">' +
                escapeHtml(top.msg) +
                '<div class="alert-tooltip">' + tooltipLines + '</div>' +
                '</div>';
        }

        // ── Card view (enriched) ──

        function renderCardView(projects) {
            var grid = document.getElementById('projectGrid');
            grid.innerHTML = '';

            projects.forEach(function(proj) {
                var card = document.createElement('div');
                card.className = 'project-card' + (proj.priority === 'urgente' ? ' project-card-urgent' : '');

                var subs = proj.submissions || [];
                var ps = getPipelineStatus(proj.pipeline_status);
                var deadline = proj.client_deadline || '';

                var subsHtml = '';
                var archivedCount = 0;
                subs.forEach(function(sub) {
                    if (sub.is_archived && !pipelineFilters.showArchived) { archivedCount++; return; }
                    var label = STATUS_LABELS[sub.status] || sub.status || 'Brouillon';
                    var lineClass = 'sub-line' + (sub.is_archived ? ' archived' : '');
                    subsHtml += '<div class="' + lineClass + '" data-subid="' + escapeAttr(sub.id) + '" data-projid="' + escapeAttr(proj.id) + '">' +
                        '<span class="sub-number">#' + escapeHtml(String(sub.submission_number)) + '</span> ' +
                        '<span class="sub-title">' + escapeHtml(sub.title || 'Sans titre') + '</span>' +
                        '<span class="project-status-badge status-' + escapeAttr(sub.status) + '">' + escapeHtml(label) + (sub.bypass_approval ? ' <span class="bypass-badge">BYPASS</span>' : '') + '</span>' +
                        '</div>';
                });
                if (archivedCount > 0) {
                    subsHtml += '<div style="font-size:11px;color:#999;padding:2px 10px;">' + archivedCount + ' archiv\u00e9e(s)</div>';
                }

                var cardDa = getProjectDisplayAmount(proj);
                var cardAmountHtml = '';
                if (cardDa.value != null) {
                    cardAmountHtml = cardDa.isOverride
                        ? '<span class="project-card-amount" style="color:#c62828;" title="Montant estim\u00e9 manuellement">' + formatMoney(cardDa.value) + '</span>'
                        : '<span class="project-card-amount">' + formatMoney(cardDa.value) + '</span>';
                }
                var metaHtml = '';
                var metaParts = [];
                if (proj.assigned_to) metaParts.push(escapeHtml(proj.assigned_to));
                if (proj.project_type) metaParts.push(escapeHtml(proj.project_type));
                if (deadline) metaParts.push('<span class="project-card-deadline">' + formatDateShort(deadline) + '</span>');
                if (metaParts.length) metaHtml = '<div class="project-card-meta-row">' + metaParts.join(' &middot; ') + '</div>';

                var followCls = userFollows[proj.id] ? ' active' : '';

                var followStarHtml = '<span class="follow-star card-follow' + followCls + '" onclick="toggleFollow(\'' + escapeAttr(proj.id) + '\',event)" title="Suivre">\u2605</span>';
                var pipelineWithStar = '<div class="project-card-pipeline">' +
                    followStarHtml +
                    '<span class="pipeline-badge" style="background:' + ps.color + '20;color:' + ps.color + ';">' + escapeHtml(ps.label) + '</span>' +
                    cardAmountHtml +
                    '</div>';

                var projAlert = getProjectAlerts(proj, (localStorage.getItem('sb_user_email') || '').toLowerCase());
                var alertBadgeHtml = buildAlertBadgeHtml(projAlert);

                card.innerHTML =
                    '<button class="project-card-delete" onclick="handleDeleteProject(\'' + escapeAttr(proj.id) + '\', event)" title="Supprimer">&times;</button>' +
                    alertBadgeHtml +
                    pipelineWithStar +
                    '<div class="project-card-name">' + escapeHtml(proj.name || 'Sans nom') + '</div>' +
                    '<div class="project-card-client">' + escapeHtml(proj.client_name || '') + '</div>' +
                    metaHtml +
                    '<div class="project-subs">' + (subsHtml || '<div class="sub-empty">Aucune soumission</div>') + '</div>' +
                    '<button class="btn-add-sub" onclick="handleAddSubmission(\'' + escapeAttr(proj.id) + '\', event)">+ Nouvelle soumission</button>';

                card.addEventListener('click', function(e) {
                    if (e.target.closest('.project-card-delete') || e.target.closest('.btn-add-sub') || e.target.closest('.follow-star') || e.target.closest('.project-alert-badge')) return;
                    var subLine = e.target.closest('.sub-line');
                    if (subLine) {
                        openSubmission(subLine.getAttribute('data-subid'));
                        return;
                    }
                    if (subs.length > 0) openSubmission(subs[0].id);
                    else openProject(proj.id);
                });

                grid.appendChild(card);
            });
        }

        // ── Submissions view ──

        var SUB_STATUSES_ORDER = ['draft', 'pending_internal', 'returned', 'approved_internal', 'sent_client', 'accepted'];

        var SUB_STATUS_LABELS = {
            draft: 'Brouillon',
            pending_internal: 'En approbation interne',
            returned: 'Retourné',
            approved_internal: 'Approuvé',
            sent_client: 'Envoyé au client',
            accepted: 'Accepté',
            lost: 'Perdue'
        };

        function buildMiniTimeline(status) {
            var isLost = (status === 'lost');
            var idx = isLost ? (SUB_STATUSES_ORDER.length - 1) : SUB_STATUSES_ORDER.indexOf(status);
            if (idx === -1) idx = 0;
            var html = '<span class="pipeline-mini-timeline">';
            for (var i = 0; i < SUB_STATUSES_ORDER.length; i++) {
                var isFilled = (i <= idx);
                var isLastAndLost = isLost && (i === SUB_STATUSES_ORDER.length - 1);
                if (i > 0) html += '<span class="tl-line' + (isFilled ? ' filled' : '') + '"></span>';
                var label = isLastAndLost ? 'Perdue' : (SUB_STATUS_LABELS[SUB_STATUSES_ORDER[i]] || '');
                html += '<span class="tl-dot' + (isFilled ? ' filled' : '') + (isLastAndLost ? ' lost' : '') + '" data-label="' + label + '"></span>';
            }
            html += '</span>';
            return html;
        }

        function renderSubmissionsView(projects) {
            // Flatten all submissions
            var allSubs = [];
            projects.forEach(function(p) {
                (p.submissions || []).forEach(function(s) {
                    s._project = p;
                    allSubs.push(s);
                });
            });

            // Apply submission-specific filters
            if (pipelineFilters.search) {
                var q = pipelineFilters.search;
                allSubs = allSubs.filter(function(s) {
                    var haystack = [s.title, s._project.name, s._project.client_name, String(s.submission_number)].filter(Boolean).join(' ').toLowerCase();
                    return haystack.indexOf(q) !== -1;
                });
            }
            if (pipelineFilters.status) {
                allSubs = allSubs.filter(function(s) { return s.status === pipelineFilters.status; });
            }
            if (pipelineFilters.assigned) {
                allSubs = allSubs.filter(function(s) { return s.estimateur === pipelineFilters.assigned || s.vendeur_cp === pipelineFilters.assigned; });
            }
            if (!pipelineFilters.showArchived) {
                allSubs = allSubs.filter(function(s) { return !s.is_archived; });
            }

            // Sort by updated_at desc
            allSubs.sort(function(a, b) { return (b.updated_at || '').localeCompare(a.updated_at || ''); });

            // Header
            var head = document.getElementById('submissionsTableHead');
            head.innerHTML = '<tr><th>#</th><th>Titre</th><th>Projet</th><th>Client</th><th>Montant</th><th>Estimateur</th><th>Vendeur</th><th>Statut</th><th>Remise</th></tr>';

            // Body
            var body = document.getElementById('submissionsTableBody');
            var html = '';
            var subUserEmail = (localStorage.getItem('sb_user_email') || '').toLowerCase();
            var subToday = new Date(); subToday.setHours(0, 0, 0, 0);
            allSubs.forEach(function(s) {
                var deadline = s.internal_deadline || s.client_deadline || '';
                var subAlerts = getSubAlerts(s, subUserEmail, subToday);
                var subDot = '';
                if (subAlerts.length > 0) {
                    var topLevel = subAlerts.some(function(a) { return a.level === 'red'; }) ? 'red' : 'orange';
                    subDot = '<span class="project-alert-dot project-alert-dot--' + topLevel + '" title="' + escapeAttr(subAlerts[0].msg) + '"></span>';
                }
                html += '<tr onclick="openSubmission(\'' + escapeAttr(s.id) + '\')">';
                html += '<td style="font-weight:700;color:var(--sw-navy);">' + subDot + '#' + escapeHtml(String(s.submission_number)) + '</td>';
                html += '<td class="col-name">' + escapeHtml(s.title || 'Sans titre') + '</td>';
                html += '<td>' + escapeHtml(s._project.name || '—') + '</td>';
                html += '<td>' + escapeHtml(s._project.client_name || '—') + '</td>';
                html += '<td class="col-amount">' + (s.approved_total ? formatMoney(s.approved_total) : '—') + '</td>';
                html += '<td>' + escapeHtml(s.estimateur || '—') + '</td>';
                html += '<td>' + escapeHtml(s.vendeur_cp || '—') + '</td>';
                html += '<td>' + buildMiniTimeline(s.status) + '</td>';
                html += '<td' + (deadline ? ' class="project-card-deadline"' : '') + '>' + formatDateShort(deadline) + '</td>';
                html += '</tr>';
            });
            body.innerHTML = html || '<tr><td colspan="9" style="text-align:center;color:#888;padding:24px;">Aucune soumission ne correspond aux filtres.</td></tr>';
        }

        // ── Main renderProjectList — loads data then renders current view ──

        async function renderProjectList() {
            cachedProjects = await loadProjects();
            await loadUserFollows();
            populateFilterDropdowns();
            renderCurrentView();
        }

        async function handleAddSubmission(projectId, event) {
            if (event) event.stopPropagation();
            var title = await stelePrompt('Titre de la nouvelle soumission :', 'Nouvelle soumission');
            if (title === null) return;
            try {
                var sub = await createSubmission(projectId, title || '');
                await openSubmission(sub.id);
            } catch (e) {
                console.error('Erreur cr\u00e9ation soumission:', e);
                steleAlert('Erreur lors de la cr\u00e9ation de la soumission.');
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // FORMULAIRE NOUVEAU PROJET
        // ═══════════════════════════════════════════════════════════════════════

        function showNewProjectForm() {
            document.getElementById('newProjectForm').classList.add('active');
        }

        function hideNewProjectForm() {
            document.getElementById('newProjectForm').classList.remove('active');
        }

        async function handleCreateProject() {
            const btn = document.getElementById('btnCreateProject');
            btn.disabled = true;
            btn.textContent = 'Création...';

            try {
                // Name & code auto-generated by DB trigger
                const project = await createProject('', '');
                hideNewProjectForm();
                await openProject(project.id);
            } catch (e) {
                console.error('Erreur création projet:', e);
                steleAlert('Erreur lors de la cr\u00e9ation du projet.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Créer';
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // OUVRIR / CHARGER UN PROJET
        // ═══════════════════════════════════════════════════════════════════════

        async function openSubmission(submissionId, project) {
            // Charger la soumission
            const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/submissions?id=eq.' + submissionId + '&select=*', {});
            if (!r.ok) return;
            const subData = await r.json();
            if (subData.length === 0) return;

            currentSubmission = subData[0];

            // Charger le projet parent si pas déjà fourni
            if (project) {
                currentProject = project;
            } else {
                const pr = await authenticatedFetch(SUPABASE_URL + '/rest/v1/projects?id=eq.' + currentSubmission.project_id + '&select=*', {});
                if (pr.ok) {
                    const pData = await pr.json();
                    if (pData.length > 0) currentProject = pData[0];
                }
            }

            roomMap = {};
            itemMap = {};
            groupImages = {};
            roomModifiers = {};
            roomDM = {};
            dmChoiceCache = {};
            roomDescEN = {};
            roomDescHTML = {};
            resetAiChat();

            // Remplir le header
            document.getElementById('projName').value = currentProject ? (currentProject.name || '') : '';
            document.getElementById('subTitle').value = currentSubmission.title || '';
            var exclEl = document.getElementById('exclusionsText');
            if (exclEl) exclEl.value = currentSubmission.exclusions || '';
            updateStatusBadge(currentSubmission.status || 'draft');
            document.getElementById('subNumber').textContent = '#' + currentSubmission.submission_number;
            document.getElementById('headerSubNumber').textContent = 'Soumission #' + currentSubmission.submission_number;
            document.getElementById('projInstallation').checked = true;
            renderProjectInfoBloc();

            // Charger les contacts projet pour les badges header
            loadProjectContacts().then(function() { renderContactBadges(); });

            // Vider le calculateur
            document.getElementById('furnitureGroups').innerHTML = '';
            cascadeParentMap = {};
            _cascadeRunning = false;
            _isLoadingSubmission = true;
            matchDefaults = currentSubmission.match_defaults || {};

            // Charger les pièces et items via submission_id
            const rooms = await loadSubmissionRooms(submissionId);

            if (rooms.length === 0) {
                addFurnitureGroup('');
            } else {
                for (const room of rooms) {
                    const groupId = addFurnitureGroup(room.name, { existingId: room.id, skipSave: true });

                    if (room.installation_included === false) {
                        var installCb = document.getElementById(groupId + '-install');
                        if (installCb) installCb.checked = false;
                    }

                    if (room.client_description) {
                        var descEl = document.getElementById(groupId + '-clientDesc');
                        if (descEl) descEl.value = htmlToText(room.client_description);
                        roomDescHTML[groupId] = room.client_description;
                        refreshDescriptionDisplay(groupId);
                    }
                    if (room.client_description_en) {
                        roomDescEN[groupId] = room.client_description_en;
                    }

                    // Load room price modifier
                    if (room.price_modifier_pct != null) {
                        roomModifiers[groupId] = parseFloat(room.price_modifier_pct);
                    }

                    // Load room-level default materials
                    roomDM[groupId] = room.default_materials || [];
                    updateRoomDmBadge(groupId);

                    // Load legacy images from JSONB
                    if (room.images && Array.isArray(room.images) && room.images.length > 0) {
                        groupImages[groupId] = room.images.map(img => ({ name: img.name, dataUrl: img.dataUrl, showInQuote: !!img.showInQuote, isLegacy: true }));
                    }

                    // Load room_media from dedicated table
                    try {
                        var mediaResp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/room_media?room_id=eq.' + room.id + '&order=sort_order.asc', {});
                        if (mediaResp.ok) {
                            var mediaRows = await mediaResp.json();
                            if (mediaRows.length > 0) {
                                if (!groupImages[groupId]) groupImages[groupId] = [];
                                mediaRows.forEach(function(m) {
                                    groupImages[groupId].push({
                                        name: m.cropped_url.split('/').pop() || 'image.jpg',
                                        url: m.cropped_url,
                                        originalUrl: m.original_url,
                                        mediaId: m.id,
                                        tags: m.tags || ['presentation_soumission'],
                                        cropRatio: m.crop_ratio,
                                        isLegacy: false,
                                        showInQuote: (m.tags || []).includes('presentation_soumission'),
                                        aiReference: (m.tags || []).includes('ai_reference'),
                                        annotations: m.annotations || []
                                    });
                                });
                            }
                        }
                    } catch (e) { console.error('Load room_media error:', e); }

                    if (groupImages[groupId] && groupImages[groupId].length > 0) {
                        renderGroupImagePreviews(groupId);
                    }

                    if (room.room_items && room.room_items.length > 0) {
                        var _loadedCascadeItems = []; // pour la 2e passe
                        room.room_items.forEach(item => {
                            var isCascade = !!item.parent_item_id;
                            const rowId = addRow(groupId, { existingId: item.id, skipSave: true, skipFocus: true, cascade: isCascade });

                            const row = document.getElementById(rowId);
                            const select = row.querySelector('.item-select');
                            const qtyInput = row.querySelector('.qty-input');

                            // Restore cascade_locked state
                            if (isCascade && item.cascade_locked) {
                                row.classList.add('cascade-locked');
                            }

                            qtyInput.value = item.quantity || 1;

                            if (item.installation_included === false) {
                                var rowInstCb = document.getElementById(rowId + '-install');
                                if (rowInstCb) rowInstCb.checked = false;
                            }

                            if (item.item_type === 'custom') {
                                select.value = '__AJOUT__';
                                _customItemDataMap[rowId] = {
                                    description: item.description || '',
                                    unit_price: item.unit_price || 0,
                                    markup: item.markup || 0,
                                    custom_data: item.custom_data || {}
                                };
                                transformToAjoutMode(row, rowId);
                            } else if (item.catalogue_item_id) {
                                select.value = item.catalogue_item_id;
                            }

                            // Mark constraints as already processed (data already loaded — don't re-trigger auto_add)
                            if (item.catalogue_item_id) {
                                row.dataset.constraintsProcessed = item.catalogue_item_id;
                            }

                            // Restore tag
                            if (item.tag) {
                                var tagInput = document.getElementById(rowId + '-tag');
                                if (tagInput) tagInput.value = item.tag;
                            }

                            // Restore dimensions L/H/P + caisson fields
                            if (item.length_in || item.height_in || item.depth_in) {
                                var dimsEl = document.getElementById(rowId + '-dims');
                                if (dimsEl) {
                                    dimsEl.dataset.l = item.length_in || '';
                                    dimsEl.dataset.h = item.height_in || '';
                                    dimsEl.dataset.p = item.depth_in || '';
                                }
                            }
                            if (item.n_tablettes || item.n_partitions) {
                                var dimsEl2 = document.getElementById(rowId + '-dims');
                                if (dimsEl2) {
                                    dimsEl2.dataset.tab = item.n_tablettes || '';
                                    dimsEl2.dataset.part = item.n_partitions || '';
                                }
                            }

                            // Mémoriser pour la 2e passe cascade
                            if (isCascade) _loadedCascadeItems.push({ rowId: rowId, parentItemId: item.parent_item_id });

                            updateRow(rowId);
                        });

                        // 2e passe : restaurer cascadeParentMap
                        _loadedCascadeItems.forEach(function(ci) {
                            var parentRowId = Object.keys(itemMap).find(function(k) { return itemMap[k] === ci.parentItemId; });
                            if (parentRowId) cascadeParentMap[ci.rowId] = parentRowId;
                        });
                    }
                }
            }

            _isLoadingSubmission = false;

            updateWorkflowButtons();
            populateSubAssignment();
            loadSubmissionReviews(submissionId);
            // Refresh default materials UI + tag filter
            restoreDmPanelState();
            activeTagFilter = null;
            refreshTagFilterBar();
            var isEditable = isSubmissionCurrentlyEditable();
            setEditable(isEditable);

            // Apply room modifier displays after all rows loaded
            Object.keys(roomModifiers).forEach(function(gid) {
                if (roomModifiers[gid]) applyRoomModifierDisplay(gid);
            });
            updateGlobalModifierDisplay();
            updateDiscountDisplay();

            showCalculator();

            // Init AI scope observer and observe all rendered group headers
            initAiScopeObserver();
            document.querySelectorAll('#calculatorView .furniture-group-header').forEach(function(h) {
                aiScopeObserver.observe(h);
            });

            if (isApprovalMode) {
                // Hide submission panel and project name edit in approval mode
                document.getElementById('headerSubPanel').style.display = 'none';
                document.getElementById('projName').readOnly = true;
                document.getElementById('btnBackProjects').innerHTML = '&larr; Approbations';
            } else {
                renderHeaderSubmissionList();
            }
        }

        // ── Submission assignment ──

        function populateSubAssignment() {
            var row = document.getElementById('subAssignmentRow');
            if (!currentSubmission) { row.style.display = 'none'; return; }
            row.style.display = '';

            // Build user lists from _allUserRoles
            var allUsers = [];
            var approvers = [];
            Object.keys(_allUserRoles).forEach(function(email) {
                var roleName = _allUserRoles[email];
                var displayName = USER_PROFILES_MAP[email.toLowerCase()] || email;
                var entry = { value: email, label: displayName };
                allUsers.push(entry);
                var rolePerms = _allPermissions[roleName] || {};
                if (rolePerms.can_approve_quotes || rolePerms.admin) {
                    approvers.push(entry);
                }
            });

            var sortFn = function(a, b) { return a.label.localeCompare(b.label, 'fr'); };
            allUsers.sort(sortFn);
            approvers.sort(sortFn);

            function fillSelect(sel, entries, currentVal) {
                sel.innerHTML = '<option value="">—</option>';
                entries.forEach(function(e) {
                    sel.innerHTML += '<option value="' + escapeAttr(e.value) + '">' + escapeHtml(e.label) + '</option>';
                });
                sel.value = currentVal || '';
            }

            fillSelect(document.getElementById('saEstimateur'), allUsers, currentSubmission.estimateur);
            fillSelect(document.getElementById('saVendeur'), allUsers, currentSubmission.vendeur_cp);
            fillSelect(document.getElementById('saApprobateur'), approvers, currentSubmission.approbateur);

            document.getElementById('saInternalDeadline').value = currentSubmission.internal_deadline || '';
            document.getElementById('saClientDeadline').value = currentSubmission.client_deadline || '';

            // Show accept button if current user is the assigned estimateur and hasn't accepted yet
            var acceptBtn = document.getElementById('saEstimateurAccept');
            if (acceptBtn) {
                var curEmail = (localStorage.getItem('sb_user_email') || '').toLowerCase();
                if (currentSubmission.estimateur && currentSubmission.estimateur.toLowerCase() === curEmail && !currentSubmission.estimateur_accepted_at) {
                    acceptBtn.style.display = '';
                } else {
                    acceptBtn.style.display = 'none';
                }
            }
        }

        function acceptEstimateurAssignment() {
            if (!currentSubmission) return;
            var now = new Date().toISOString();
            currentSubmission.estimateur_accepted_at = now;
            updateSubmission(currentSubmission.id, { estimateur_accepted_at: now });
            document.getElementById('saEstimateurAccept').style.display = 'none';
            showSaveIndicator();
        }

        function saveSubAssignment() {
            if (!currentSubmission) return;
            var newEstimateur = document.getElementById('saEstimateur').value || null;
            var fields = {
                estimateur: newEstimateur,
                vendeur_cp: document.getElementById('saVendeur').value || null,
                approbateur: document.getElementById('saApprobateur').value || null,
                internal_deadline: document.getElementById('saInternalDeadline').value || null,
                client_deadline: document.getElementById('saClientDeadline').value || null
            };
            // Reset accepted_at if estimateur changed
            if (newEstimateur !== currentSubmission.estimateur) {
                fields.estimateur_accepted_at = null;
                var acceptBtn = document.getElementById('saEstimateurAccept');
                if (acceptBtn) {
                    var curEmail = (localStorage.getItem('sb_user_email') || '').toLowerCase();
                    acceptBtn.style.display = (newEstimateur && newEstimateur.toLowerCase() === curEmail) ? '' : 'none';
                }
            }
            Object.assign(currentSubmission, fields);
            updateSubmission(currentSubmission.id, fields).catch(function(e) { console.error('Save sub assignment:', e); });
            showSaveIndicator();
        }

        // Panneau de soumissions dans le calculateur
        async function renderHeaderSubmissionList() {
            var panel = document.getElementById('headerSubPanel');
            var list = document.getElementById('headerSubList');
            if (!currentProject) { panel.style.display = 'none'; return; }

            var subs = await loadSubmissions(currentProject.id);
            var html = '';
            subs.forEach(function(sub) {
                if (sub.is_archived && !pipelineFilters.showArchived) return;
                var label = STATUS_LABELS[sub.status] || sub.status || 'Brouillon';
                var isActive = currentSubmission && currentSubmission.id === sub.id;
                var lineClass = 'sub-line' + (isActive ? ' active' : '') + (sub.is_archived ? ' archived' : '');
                html += '<div class="' + lineClass + '" data-subid="' + escapeAttr(sub.id) + '">' +
                    '<span class="sub-number">#' + escapeHtml(String(sub.submission_number)) + '</span> ' +
                    '<span class="sub-title">' + escapeHtml(sub.title || 'Sans titre') + '</span>' +
                    '<span class="project-status-badge status-' + escapeAttr(sub.status) + '">' + escapeHtml(label) + (sub.bypass_approval ? ' <span class="bypass-badge">BYPASS</span>' : '') + '</span>' +
                    '</div>';
            });
            list.innerHTML = html || '<div class="sub-empty">Aucune soumission</div>';
            panel.style.display = 'block';
            restoreSubPanelState();

            list.querySelectorAll('.sub-line').forEach(function(el) {
                el.addEventListener('click', function() {
                    var subId = el.getAttribute('data-subid');
                    if (currentSubmission && currentSubmission.id === subId) return;
                    openSubmission(subId);
                });
            });
        }

        function toggleSubPanel() {
            var body = document.getElementById('headerSubBody');
            var chevron = document.getElementById('subPanelChevron');
            var collapsed = !body.classList.contains('collapsed');
            body.classList.toggle('collapsed', collapsed);
            chevron.classList.toggle('open', !collapsed);
            localStorage.setItem('subPanelCollapsed', collapsed ? '1' : '');
        }

        // Restore collapse state on panel show
        function restoreSubPanelState() {
            if (localStorage.getItem('subPanelCollapsed') === '1') {
                var body = document.getElementById('headerSubBody');
                var chevron = document.getElementById('subPanelChevron');
                if (body) body.classList.add('collapsed');
                if (chevron) chevron.classList.remove('open');
            }
        }

        async function handleAddSubmissionFromCalc() {
            if (!currentProject) return;
            var title = await stelePrompt('Titre de la nouvelle soumission :', 'Nouvelle soumission');
            if (title === null) return;
            try {
                var sub = await createSubmission(currentProject.id, title || '');
                await openSubmission(sub.id);
            } catch (e) {
                console.error('Erreur cr\u00e9ation soumission:', e);
                steleAlert('Erreur lors de la cr\u00e9ation de la soumission.');
            }
        }

        // Legacy wrapper pour compatibilité — ouvre la première soumission du projet
        async function openProject(projectId) {
            const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/projects?id=eq.' + projectId + '&select=*,submissions(id,submission_number,title,status,updated_at,is_archived)', {});
            if (!r.ok) return;
            const data = await r.json();
            if (data.length === 0) return;

            var project = data[0];
            var subs = project.submissions || [];
            if (subs.length === 0) {
                // Pas de soumission → en créer une
                var newSub = await createSubmission(projectId, project.name || 'Soumission initiale');
                await openSubmission(newSub.id, project);
            } else {
                // Ouvrir la plus récente
                subs.sort(function(a, b) { return (b.updated_at || '').localeCompare(a.updated_at || ''); });
                await openSubmission(subs[0].id, project);
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // SAUVEGARDER CHAMPS HEADER PROJET
        // ═══════════════════════════════════════════════════════════════════════

        function saveProjectField() {
            // Name is now auto-generated by DB trigger (readonly field)
            // Kept for backward compatibility but does nothing
        }

        function saveSubmissionField() {
            if (!currentSubmission) return;
            var title = document.getElementById('subTitle').value.trim();
            currentSubmission.title = title;
            updateSubmission(currentSubmission.id, { title: title }).catch(function(e) { console.error('Save title:', e); });
            showSaveIndicator();
        }

        // ═══════════════════════════════════════════════════════════════════════
        // VERROUILLAGE ÉDITION
        // ═══════════════════════════════════════════════════════════════════════

        function isSubmissionCurrentlyEditable() {
            if (!currentSubmission) return true;
            var s = currentSubmission.status;
            return s === 'draft' || s === 'returned' ||
                   (s === 'pending_internal' && canApproveQuotes);
        }

        function setEditable(editable) {
            // Inputs et selects du calculateur
            var container = document.getElementById('calculatorView');
            if (!container) return;

            container.querySelectorAll('.item-select, .qty-input, .markup-input, .ajout-edit-btn, .client-desc-textarea').forEach(function(el) {
                el.disabled = !editable;
                el.style.opacity = editable ? '' : '0.6';
            });

            // Boutons ajouter meuble/ligne, supprimer
            container.querySelectorAll('.btn-add-group, .btn-add, .btn-remove, .btn-remove-group, .furniture-name-input').forEach(function(el) {
                if (el.tagName === 'BUTTON') {
                    el.disabled = !editable;
                    el.style.opacity = editable ? '' : '0.4';
                } else {
                    el.readOnly = !editable;
                    el.style.opacity = editable ? '' : '0.6';
                }
            });

            // Installation toggles
            container.querySelectorAll('input[type="checkbox"]').forEach(function(el) {
                el.disabled = !editable;
            });

            // Bouton "Soumettre pour approbation" en bas
            var btnOpenSubmit = document.getElementById('btnOpenSubmit');
            if (btnOpenSubmit) {
                btnOpenSubmit.disabled = !editable;
                btnOpenSubmit.style.opacity = editable ? '' : '0.4';
            }

            // Header fields
            var subTitle = document.getElementById('subTitle');
            if (subTitle) subTitle.readOnly = !editable;

            // Image drop zones + file inputs
            container.querySelectorAll('.drop-zone, .image-upload-input').forEach(function(el) {
                if (el.tagName === 'INPUT') {
                    el.disabled = !editable;
                }
                el.style.pointerEvents = editable ? '' : 'none';
                el.style.opacity = editable ? '' : '0.4';
            });

            // Bannière de statut
            var banner = document.getElementById('lockBanner');
            if (!editable && currentSubmission) {
                var label = STATUS_LABELS[currentSubmission.status] || currentSubmission.status;
                if (!banner) {
                    banner = document.createElement('div');
                    banner.id = 'lockBanner';
                    banner.style.cssText = 'background:#fff3e0; color:#e65100; padding:10px 16px; border-radius:6px; font-size:13px; font-weight:600; margin-bottom:12px; text-align:center;';
                    var calcContainer = document.querySelector('.calculator-container');
                    if (calcContainer) calcContainer.parentNode.insertBefore(banner, calcContainer);
                }
                banner.textContent = 'Soumission verrouill\u00e9e \u2014 Statut : ' + label;
                banner.style.display = '';
            } else if (banner) {
                banner.style.display = 'none';
            }

            // Room modifier + discount buttons
            container.querySelectorAll('.btn-room-modifier').forEach(function(el) {
                el.style.display = editable ? '' : 'none';
            });
            var addGlobalModBtn = document.getElementById('addGlobalModifierBtn');
            if (addGlobalModBtn) addGlobalModBtn.style.display = editable ? '' : 'none';
            var globalModRow = document.getElementById('globalModifierRow');
            if (globalModRow) {
                globalModRow.querySelectorAll('.discount-toggle-btn').forEach(function(btn) {
                    btn.style.display = editable ? '' : 'none';
                });
            }
            var addDiscountBtn = document.getElementById('addDiscountBtn');
            if (addDiscountBtn) addDiscountBtn.style.display = editable ? '' : 'none';
            var discountRow = document.getElementById('discountRow');
            if (discountRow) {
                discountRow.querySelectorAll('.discount-toggle-btn').forEach(function(btn) {
                    btn.style.display = editable ? '' : 'none';
                });
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // HISTORIQUE DES VERSIONS
        // ═══════════════════════════════════════════════════════════════════════

        async function openVersionDrawer() {
            var drawer = document.getElementById('versionDrawer');
            drawer.style.display = 'flex';
            var list = document.getElementById('versionList');
            list.innerHTML = '<div style="text-align:center;padding:20px;color:#999;">Chargement...</div>';
            if (!currentSubmission) { list.innerHTML = '<p style="text-align:center;color:#999;">Aucune soumission</p>'; return; }

            try {
                var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/project_versions?submission_id=eq.' + currentSubmission.id + '&order=version_number.desc&select=id,version_number,status_at_save,created_at,created_by', {});
                if (!r.ok) throw new Error(r.status);
                var versions = await r.json();

                if (versions.length === 0) {
                    list.innerHTML = '<p style="text-align:center;color:#999;padding:20px;">Aucune version enregistr\u00e9e</p>';
                    return;
                }

                list.innerHTML = versions.map(function(v) {
                    var label = STATUS_LABELS[v.status_at_save] || v.status_at_save;
                    var date = new Date(v.created_at).toLocaleString('fr-CA');
                    return '<div class="version-card" onclick="viewVersion(\'' + v.id + '\')">' +
                        '<div style="font-weight:600;">Version ' + v.version_number + '</div>' +
                        '<div style="font-size:12px;color:#666;">' + date + ' \u2014 ' + label + '</div></div>';
                }).join('');
            } catch (e) {
                console.error('Erreur chargement versions:', e);
                list.innerHTML = '<p style="text-align:center;color:#c62828;">Erreur chargement</p>';
            }
        }

        function closeVersionDrawer() {
            document.getElementById('versionDrawer').style.display = 'none';
        }

        async function viewVersion(versionId) {
            try {
                var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/project_versions?id=eq.' + versionId + '&select=snapshot,version_number,status_at_save,created_at', {});
                if (!r.ok) return;
                var data = (await r.json())[0];
                if (!data) return;
                renderVersionSnapshot(data);
            } catch (e) {
                console.error('Erreur affichage version:', e);
            }
        }

        function renderVersionSnapshot(data) {
            var snap = data.snapshot;
            if (!snap) { steleAlert('Snapshot vide'); return; }
            var overlay = document.createElement('div');
            overlay.className = 'version-snapshot-overlay';
            overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };

            var html = '<div style="max-width:900px;margin:auto;background:#fff;border-radius:12px;padding:32px;">';
            html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">';
            html += '<h2 style="margin:0;">Version ' + data.version_number + ' \u2014 ' + (STATUS_LABELS[data.status_at_save] || data.status_at_save) + '</h2>';
            html += '<button onclick="this.closest(\'.version-snapshot-overlay\').remove()" style="font-size:24px;background:none;border:none;cursor:pointer;color:#666;">&times;</button></div>';

            // Infos projet/client si disponibles
            if (snap.projectName || snap.clientName) {
                html += '<div style="margin-bottom:16px;padding:12px;background:#f5f5f5;border-radius:8px;font-size:13px;">';
                if (snap.projectName) html += '<div><strong>Projet :</strong> ' + escapeHtml(snap.projectName) + '</div>';
                if (snap.clientName) html += '<div><strong>Client :</strong> ' + escapeHtml(snap.clientName) + '</div>';
                if (snap.designer) html += '<div><strong>Designer :</strong> ' + escapeHtml(snap.designer) + '</div>';
                html += '</div>';
            }

            // Render chaque meuble
            (snap.meubles || []).forEach(function(m) {
                html += '<div style="border:1px solid #e0e0e0;border-radius:8px;margin-bottom:16px;overflow:hidden;">';
                html += '<div style="background:var(--sw-navy);color:#fff;padding:10px 16px;font-weight:600;">' + escapeHtml(m.name) + ' \u2014 ' + m.subtotal + ' $</div>';
                html += '<table style="width:100%;border-collapse:collapse;font-size:13px;">';
                html += '<thead><tr style="background:#f5f5f5;"><th style="padding:6px 12px;text-align:left;">Description</th><th style="padding:6px;text-align:right;">Qt\u00e9</th><th style="padding:6px;text-align:right;">Prix unit.</th><th style="padding:6px;text-align:right;">Total</th></tr></thead>';
                (m.items || []).forEach(function(it) {
                    html += '<tr style="border-bottom:1px solid #f0f0f0;"><td style="padding:6px 12px;">' + escapeHtml(it.description) + '</td>';
                    html += '<td style="padding:6px;text-align:right;">' + it.qty + '</td>';
                    html += '<td style="padding:6px;text-align:right;">' + it.unitPrice + ' $</td>';
                    html += '<td style="padding:6px;text-align:right;font-weight:600;">' + it.lineTotal + ' $</td></tr>';
                });
                html += '</table>';
                if (m.clientDescription) {
                    html += '<div style="padding:10px 16px;border-top:1px solid #e0e0e0;font-size:13px;color:#555;"><strong>Description client :</strong> ' + escapeHtml(m.clientDescription).replace(/\n/g, '<br>') + '</div>';
                }
                html += '</div>';
            });

            html += '<div style="text-align:right;font-size:20px;font-weight:700;margin-top:16px;">Total : ' + snap.total + ' $</div>';
            html += '</div>';
            overlay.innerHTML = html;
            document.body.appendChild(overlay);
        }

        // ═══════════════════════════════════════════════════════════════════════
        // DUPLICATION DE SOUMISSION
        // ═══════════════════════════════════════════════════════════════════════

        async function duplicateSubmission() {
            if (!currentSubmission) return;
            if (!(await steleConfirm('Dupliquer cette soumission en nouveau brouillon ?\nLes pi\u00e8ces, articles et images seront copi\u00e9s.', 'Dupliquer la soumission', 'Dupliquer'))) return;
            try {
                var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/rpc/duplicate_submission', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ p_submission_id: currentSubmission.id })
                });
                if (!r.ok) throw new Error('Erreur duplication: ' + r.status);
                var newSubId = await r.json();

                await createSubmissionReview(currentSubmission.id, 'duplicated', 'Soumission dupliqu\u00e9e \u2192 nouveau brouillon');
                steleAlert('Soumission dupliqu\u00e9e avec succ\u00e8s!');
                openSubmission(newSubId);
            } catch (e) {
                console.error('Erreur duplication:', e);
                steleAlert('Erreur: ' + e.message);
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // DÉVERROUILLAGE D'URGENCE
        // ═══════════════════════════════════════════════════════════════════════

        function unlockSubmission() {
            if (!currentSubmission || !canUnlockSubmission) return;
            document.getElementById('unlockUserName').value = '';
            document.getElementById('unlockReason').value = '';
            document.getElementById('unlockConfirmCheck').checked = false;
            document.getElementById('unlockStatus').style.display = 'none';
            document.getElementById('btnUnlockConfirm').disabled = false;
            document.getElementById('unlockModal').classList.add('active');
        }

        function closeUnlockModal() {
            document.getElementById('unlockModal').classList.remove('active');
        }

        function showUnlockStatus(msg, isError) {
            var el = document.getElementById('unlockStatus');
            el.style.display = 'block';
            el.textContent = msg;
            el.style.background = isError ? '#ffebee' : '#e8f5e9';
            el.style.color = isError ? '#c62828' : '#2e7d32';
        }

        async function executeUnlock() {
            var userName = document.getElementById('unlockUserName').value.trim();
            var reason = document.getElementById('unlockReason').value.trim();

            if (!userName) { showUnlockStatus('Le nom est obligatoire.', true); return; }
            if (!reason) { showUnlockStatus('La raison est obligatoire.', true); return; }
            if (!document.getElementById('unlockConfirmCheck').checked) {
                showUnlockStatus('Vous devez cocher la case de confirmation.', true);
                return;
            }

            var btn = document.getElementById('btnUnlockConfirm');
            btn.disabled = true;
            showUnlockStatus('D\u00e9verrouillage en cours...', false);

            try {
                // 1. Snapshot avant d\u00e9verrouillage
                await createVersion(currentSubmission.id);

                // 2. Log immuable via RPC (IP captur\u00e9e c\u00f4t\u00e9 serveur)
                var rpcResp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/rpc/log_submission_unlock', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        p_submission_id: currentSubmission.id,
                        p_user_name: userName,
                        p_reason: reason,
                        p_previous_status: currentSubmission.status
                    })
                });
                if (!rpcResp.ok) throw new Error('Erreur journalisation: ' + rpcResp.status);

                // 3. Remettre en brouillon
                await updateSubmission(currentSubmission.id, { status: 'draft' });

                // 4. Timeline
                await createSubmissionReview(currentSubmission.id, 'unlocked',
                    'D\u00c9VERROUILLAGE par ' + userName + ' \u2014 Raison: ' + reason);

                // 5. UI
                currentSubmission.status = 'draft';
                updateStatusBadge('draft');
                updateWorkflowButtons();
                setEditable(true);
                loadSubmissionReviews(currentSubmission.id);

                showUnlockStatus('Soumission d\u00e9verrouill\u00e9e!', false);
                setTimeout(function() { closeUnlockModal(); }, 1000);
            } catch (e) {
                console.error('Erreur d\u00e9verrouillage:', e);
                showUnlockStatus('Erreur: ' + e.message, true);
                btn.disabled = false;
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // PROJECT INFO BLOC
        // ═══════════════════════════════════════════════════════════════════════

        function renderProjectInfoBloc() {
            var el = document.getElementById('projInfoText');
            if (!el || !currentProject) { if (el) { el.className = 'ph-info-empty'; el.textContent = ''; } return; }

            var parts = [];
            if (currentProject.client_name) parts.push(escapeHtml(currentProject.client_name));

            // Read from new columns, fallback to local cache, fallback to legacy
            var addr = currentProject.project_address || currentProject._address || '';
            var city = currentProject.project_city || currentProject._city || '';
            var postal = currentProject.project_postal_code || currentProject._postal || '';
            if (!addr && !city && !postal && currentProject.client_address) {
                var parsed = currentProject.client_address.split(',').map(function(s) { return s.trim(); });
                addr = parsed[0] || '';
                city = parsed[1] || '';
                postal = parsed[2] || '';
            }

            var addrParts = [];
            if (addr) addrParts.push(escapeHtml(addr));
            if (city) addrParts.push(escapeHtml(city));
            if (postal) addrParts.push(escapeHtml(postal));

            if (addrParts.length > 0) parts.push('<span>' + addrParts.join(', ') + '</span>');

            if (parts.length === 0) {
                el.className = 'ph-info-empty';
                el.textContent = 'Ajouter les infos du projet';
            } else {
                el.className = 'ph-info-text';
                el.innerHTML = parts.join(' \u2014 ');
            }
        }

        async function openEditInfoModal() {
            if (!currentProject) return;
            document.getElementById('editInfoModal').classList.add('active');
            // Read from new columns, fallback to legacy client_address, fallback to local cache
            var addr = currentProject.project_address || currentProject._address || '';
            var city = currentProject.project_city || currentProject._city || '';
            var postal = currentProject.project_postal_code || currentProject._postal || '';
            // If new columns empty but legacy client_address has data, parse it
            if (!addr && !city && !postal && currentProject.client_address) {
                var parts = currentProject.client_address.split(',').map(function(s) { return s.trim(); });
                addr = parts[0] || '';
                city = parts[1] || '';
                postal = parts[2] || '';
            }
            document.getElementById('infoProjectAddress').value = addr;
            document.getElementById('infoProjectCity').value = city;
            document.getElementById('infoProjectPostalCode').value = postal;
            document.getElementById('addrSuggestPanel').style.display = 'none';

            // Init client combobox
            selectedClientType = null;
            selectedClientId = null;
            var comboInput = document.getElementById('infoClientCombo');
            var selDiv = document.getElementById('clientComboSelected');
            comboInput.value = currentProject.client_name || '';
            selDiv.textContent = '';

            // Pre-select existing client link
            if (currentProject.client_contact_id) {
                selectedClientType = 'contact';
                selectedClientId = currentProject.client_contact_id;
                selDiv.textContent = '\u2713 Contact li\u00e9';
            } else if (currentProject.client_company_id) {
                selectedClientType = 'company';
                selectedClientId = currentProject.client_company_id;
                selDiv.textContent = '\u2713 Entreprise li\u00e9e';
            }

            await loadAllContactsForCombo();
            await loadAllCompaniesForCombo();

            // Pipeline fields
            var psSelect = document.getElementById('infoPipelineStatus');
            psSelect.innerHTML = '';
            pipelineStatuses.forEach(function(s) {
                psSelect.innerHTML += '<option value="' + escapeAttr(s.slug) + '">' + escapeHtml(s.label) + '</option>';
            });
            psSelect.value = currentProject.pipeline_status || 'a_contacter';

            document.getElementById('infoPriority').value = currentProject.priority || 'normal';

            var srcSelect = document.getElementById('infoSource');
            srcSelect.innerHTML = '<option value="">—</option>';
            projectSources.forEach(function(s) { srcSelect.innerHTML += '<option value="' + escapeAttr(s) + '">' + escapeHtml(s) + '</option>'; });
            srcSelect.value = currentProject.source || '';

            var typeSelect = document.getElementById('infoProjectType');
            typeSelect.innerHTML = '<option value="">—</option>';
            projectTypes.forEach(function(t) { typeSelect.innerHTML += '<option value="' + escapeAttr(t) + '">' + escapeHtml(t) + '</option>'; });
            typeSelect.value = currentProject.project_type || '';

            document.getElementById('infoEstimatedAmount').value = currentProject.estimated_amount || '';

            var probSlider = document.getElementById('infoProbability');
            probSlider.value = currentProject.probability || 0;
            document.getElementById('infoProbVal').textContent = (currentProject.probability || 0) + '%';

            var assignSelect = document.getElementById('infoAssignedTo');
            assignSelect.innerHTML = '<option value="">—</option>';
            EMPLOYEES_DATA.forEach(function(e) { assignSelect.innerHTML += '<option value="' + escapeAttr(e.name) + '">' + escapeHtml(e.name) + '</option>'; });
            assignSelect.value = currentProject.assigned_to || '';

            document.getElementById('infoDeliveryMonth').value = currentProject.delivery_month || '';
            document.getElementById('infoInternalDeadline').value = currentProject.internal_deadline || '';
            document.getElementById('infoClientDeadline').value = currentProject.client_deadline || '';
        }

        function closeEditInfoModal() {
            document.getElementById('editInfoModal').classList.remove('active');
            closeClientCombo();
        }

        async function saveProjectInfo() {
            if (!currentProject) return;
            var address = document.getElementById('infoProjectAddress').value.trim();
            var city = document.getElementById('infoProjectCity').value.trim();
            var postal = document.getElementById('infoProjectPostalCode').value.trim();
            var clientName = document.getElementById('infoClientCombo').value.trim();

            // Build full address for client_address fallback
            var fullAddr = [address, city, postal].filter(Boolean).join(', ');

            // Pipeline fields
            var pipelineStatus = document.getElementById('infoPipelineStatus').value;
            var priority = document.getElementById('infoPriority').value;
            var source = document.getElementById('infoSource').value || null;
            var projectType = document.getElementById('infoProjectType').value || null;
            var estimatedAmount = parseFloat(document.getElementById('infoEstimatedAmount').value) || null;
            var probability = parseInt(document.getElementById('infoProbability').value) || 0;
            var assignedTo = document.getElementById('infoAssignedTo').value || null;
            var deliveryMonth = document.getElementById('infoDeliveryMonth').value || null;
            var internalDeadline = document.getElementById('infoInternalDeadline').value || null;
            var clientDeadline = document.getElementById('infoClientDeadline').value || null;

            // Compute name from code + city (trigger does this too, but safeguard client-side)
            var computedName = currentProject.project_code
                ? (city ? currentProject.project_code + ' ' + city : currentProject.project_code)
                : (currentProject.name || '');

            // Try with new columns first, fallback to legacy columns
            var updateObj = {
                name: computedName,
                client_name: clientName,
                project_address: address,
                project_city: city,
                project_postal_code: postal,
                client_contact_id: selectedClientType === 'contact' ? selectedClientId : null,
                client_company_id: selectedClientType === 'company' ? selectedClientId : null,
                pipeline_status: pipelineStatus,
                priority: priority,
                source: source,
                project_type: projectType,
                estimated_amount: estimatedAmount,
                probability: probability,
                assigned_to: assignedTo,
                delivery_month: deliveryMonth,
                internal_deadline: internalDeadline,
                client_deadline: clientDeadline
            };

            try {
                var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/projects?id=eq.' + currentProject.id, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                    body: JSON.stringify(updateObj)
                });
                if (!r.ok) {
                    // New columns probably don't exist yet — fallback to legacy columns
                    var fallbackObj = {
                        client_name: clientName,
                        client_address: fullAddr
                    };
                    var r2 = await authenticatedFetch(SUPABASE_URL + '/rest/v1/projects?id=eq.' + currentProject.id, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                        body: JSON.stringify(fallbackObj)
                    });
                    if (r2.ok) {
                        var rows2 = await r2.json();
                        if (rows2.length > 0) {
                            currentProject = rows2[0];
                            // Store parsed values locally for display
                            currentProject._address = address;
                            currentProject._city = city;
                            currentProject._postal = postal;
                        }
                        renderProjectInfoBloc();
                        closeEditInfoModal();
                        console.warn('Saved with legacy columns. Run sql/project_info_columns.sql to enable full support.');
                    } else {
                        var errText = await r2.text();
                        console.error('Save project info fallback failed:', errText);
                        alert('Erreur lors de la sauvegarde : ' + errText);
                    }
                    return;
                }
                var rows = await r.json();
                if (rows.length > 0) {
                    currentProject = rows[0];
                    // Update header with trigger-generated name (code + city)
                    document.getElementById('projName').value = currentProject.name || '';
                }
                renderProjectInfoBloc();
                closeEditInfoModal();
            } catch (e) {
                console.error('Error saving project info:', e);
                alert('Erreur lors de la sauvegarde des infos projet.');
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // CLIENT COMBOBOX (in edit info modal)
        // ═══════════════════════════════════════════════════════════════════════

        async function loadAllContactsForCombo() {
            try {
                var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/contacts?select=id,first_name,last_name,email,phone,contact_companies(companies(id,name))&order=last_name', {});
                if (r.ok) allContactsCache = await r.json();
            } catch (e) { console.warn('Error loading contacts for combo:', e); }
        }

        async function loadAllCompaniesForCombo() {
            try {
                var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/companies?select=id,name,contact_companies(contacts(id,first_name,last_name))&order=name', {});
                if (r.ok) allCompaniesCache = await r.json();
            } catch (e) { console.warn('Error loading companies for combo:', e); }
        }

        function openClientCombo() {
            var dd = document.getElementById('clientComboDd');
            populateClientCombo(dd, '');
            dd.classList.add('open');
        }

        function filterClientCombo(input) {
            var dd = document.getElementById('clientComboDd');
            populateClientCombo(dd, input.value);
            dd.classList.add('open');
        }

        function populateClientCombo(dd, filter) {
            var html = '';
            var f = (filter || '').toLowerCase();

            // Contacts section
            var contacts = allContactsCache.filter(function(c) {
                var name = ((c.first_name || '') + ' ' + (c.last_name || '')).toLowerCase();
                return !f || name.indexOf(f) !== -1 || (c.email || '').toLowerCase().indexOf(f) !== -1;
            });
            if (contacts.length > 0) {
                html += '<div class="combo-section-header">Contacts</div>';
                for (var i = 0; i < Math.min(contacts.length, 10); i++) {
                    var c = contacts[i];
                    var name = ((c.first_name || '') + ' ' + (c.last_name || '')).trim();
                    html += '<div class="contact-combo-item" onclick="selectClient(this)" data-type="contact" data-id="' + escapeAttr(c.id) + '" data-name="' + escapeAttr(name) + '">' +
                        escapeHtml(name) + (c.email ? ' <small>' + escapeHtml(c.email) + '</small>' : '') + '</div>';
                }
            }

            // Companies section
            var companies = allCompaniesCache.filter(function(co) {
                return !f || (co.name || '').toLowerCase().indexOf(f) !== -1;
            });
            if (companies.length > 0) {
                html += '<div class="combo-section-header">Entreprises</div>';
                for (var j = 0; j < Math.min(companies.length, 10); j++) {
                    var co = companies[j];
                    html += '<div class="contact-combo-item" onclick="selectClient(this)" data-type="company" data-id="' + escapeAttr(co.id) + '" data-name="' + escapeAttr(co.name) + '">' +
                        escapeHtml(co.name) + '</div>';
                }
            }

            dd.innerHTML = html || '<div class="contact-combo-item" style="color:#999;">Aucun contact trouv\u00e9</div>';
        }

        function selectClient(el) {
            var type = el.getAttribute('data-type');
            var id = el.getAttribute('data-id');
            var name = el.getAttribute('data-name');
            selectedClientType = type;
            selectedClientId = id;
            document.getElementById('infoClientCombo').value = name;
            document.getElementById('clientComboSelected').textContent = '\u2713 ' + (type === 'contact' ? 'Contact' : 'Entreprise') + ' li\u00e9(e)';
            closeClientCombo();
            promptClientAddress();
        }

        function closeClientCombo() {
            var dd = document.getElementById('clientComboDd');
            if (dd) dd.classList.remove('open');
        }

        function promptClientAddress() {
            var panel = document.getElementById('addrSuggestPanel');
            if (!panel) return;
            var addresses = [];
            if (selectedClientType === 'contact') {
                var c = allContactsCache.find(function(x) { return x.id === selectedClientId; });
                if (c && Array.isArray(c.addresses)) addresses = c.addresses;
            } else if (selectedClientType === 'company') {
                var co = allCompaniesCache.find(function(x) { return x.id === selectedClientId; });
                if (co && Array.isArray(co.addresses)) addresses = co.addresses;
            }
            if (addresses.length === 0) { panel.style.display = 'none'; return; }
            var html = '<div style="margin-top:8px; padding:8px 12px; background:#f9f9f9; border-radius:6px; border:1px solid #eee;">';
            html += '<div style="font-size:12px; font-weight:600; color:#666; margin-bottom:6px;">Utiliser une adresse existante ?</div>';
            for (var i = 0; i < addresses.length; i++) {
                var a = addresses[i];
                var parts = [a.line1, a.city, a.postal_code].filter(Boolean).join(', ');
                html += '<div style="padding:4px 0; cursor:pointer; color:var(--sw-navy); font-size:13px;" onclick="applyClientAddress(' + i + ')">' +
                    (a.label ? '<strong>' + escapeHtml(a.label) + ':</strong> ' : '') + escapeHtml(parts) + '</div>';
            }
            html += '</div>';
            panel.innerHTML = html;
            panel.style.display = 'block';
        }

        function applyClientAddress(idx) {
            var addresses = [];
            if (selectedClientType === 'contact') {
                var c = allContactsCache.find(function(x) { return x.id === selectedClientId; });
                if (c && Array.isArray(c.addresses)) addresses = c.addresses;
            } else if (selectedClientType === 'company') {
                var co = allCompaniesCache.find(function(x) { return x.id === selectedClientId; });
                if (co && Array.isArray(co.addresses)) addresses = co.addresses;
            }
            if (!addresses[idx]) return;
            var a = addresses[idx];
            document.getElementById('infoProjectAddress').value = a.line1 || '';
            document.getElementById('infoProjectCity').value = a.city || '';
            document.getElementById('infoProjectPostalCode').value = a.postal_code || '';
            document.getElementById('addrSuggestPanel').style.display = 'none';
        }

        async function createNewClientContact() {
            closeClientCombo();
            var firstName = await stelePrompt('Pr\u00e9nom du nouveau contact :', 'Nouveau contact', 'Cr\u00e9er');
            if (!firstName || !firstName.trim()) return;
            var lastName = await stelePrompt('Nom de famille :', 'Nouveau contact', 'Cr\u00e9er');
            if (!lastName || !lastName.trim()) return;
            try {
                var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/contacts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                    body: JSON.stringify({ first_name: firstName.trim(), last_name: lastName.trim(), created_by: localStorage.getItem('sb_user_id') })
                });
                if (r.ok) {
                    var res = await r.json();
                    if (res.length > 0) {
                        allContactsCache.push(res[0]);
                        selectedClientType = 'contact';
                        selectedClientId = res[0].id;
                        document.getElementById('infoClientCombo').value = firstName.trim() + ' ' + lastName.trim();
                        document.getElementById('clientComboSelected').textContent = '\u2713 Contact cr\u00e9\u00e9 et li\u00e9';
                    }
                }
            } catch (e) { console.warn('Error creating contact:', e); }
        }

        async function createNewClientCompany() {
            closeClientCombo();
            var name = await stelePrompt('Nom de l\'entreprise :', 'Nouvelle entreprise', 'Cr\u00e9er');
            if (!name || !name.trim()) return;
            try {
                var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/companies', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                    body: JSON.stringify({ name: name.trim(), created_by: localStorage.getItem('sb_user_id') })
                });
                if (r.ok) {
                    var res = await r.json();
                    if (res.length > 0) {
                        allCompaniesCache.push(res[0]);
                        selectedClientType = 'company';
                        selectedClientId = res[0].id;
                        document.getElementById('infoClientCombo').value = name.trim();
                        document.getElementById('clientComboSelected').textContent = '\u2713 Entreprise cr\u00e9\u00e9e et li\u00e9e';
                    }
                }
            } catch (e) { console.warn('Error creating company:', e); }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // CONTACTS MODAL
        // ═══════════════════════════════════════════════════════════════════════

        async function openContactsModal() {
            if (!currentProject) { steleAlert('Veuillez ouvrir un projet d\'abord.'); return; }
            document.getElementById('contactsModal').classList.add('active');
            await loadProjectContacts();
            renderContactCards();
        }

        function closeContactsModal() {
            document.getElementById('contactsModal').classList.remove('active');
        }

        async function loadProjectContacts() {
            if (!currentProject) { projectContacts = []; return; }
            try {
                var r = await authenticatedFetch(
                    SUPABASE_URL + '/rest/v1/project_contacts?project_id=eq.' + currentProject.id +
                    '&select=*,contacts(id,first_name,last_name,email,phone,address,notes,contact_companies(companies(id,name)))' +
                    '&order=sort_order', {}
                );
                if (r.ok) {
                    projectContacts = await r.json();
                } else {
                    projectContacts = [];
                }
            } catch (e) {
                console.warn('Error loading project contacts:', e);
                projectContacts = [];
            }
        }

        async function loadContactRoles() {
            try {
                var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/app_config?key=eq.contact_roles&select=value', {});
                if (r.ok) {
                    var rows = await r.json();
                    if (rows.length > 0 && Array.isArray(rows[0].value)) configContactRoles = rows[0].value;
                }
            } catch (e) { /* keep defaults */ }
            var dl = document.getElementById('contactRoleOptions');
            if (dl) {
                dl.innerHTML = '';
                for (var i = 0; i < configContactRoles.length; i++) {
                    var opt = document.createElement('option');
                    opt.value = configContactRoles[i];
                    dl.appendChild(opt);
                }
            }
        }

        function renderContactBadges() {
            var strip = document.getElementById('projContactsStrip');
            if (!strip) return;
            if (!projectContacts || projectContacts.length === 0) {
                strip.innerHTML = '<span class="ph-contact-badge" onclick="openContactsModal()" style="border-style:dashed;">+ Contacts</span>';
                return;
            }
            var MAX_BADGES = 4;
            var html = '';
            var shown = Math.min(projectContacts.length, MAX_BADGES);
            for (var i = 0; i < shown; i++) {
                var pc = projectContacts[i];
                var c = pc.contacts;
                if (!c) continue;
                var name = ((c.first_name || '') + ' ' + (c.last_name || '')).trim();
                var companies = (c.contact_companies || []).map(function(cc) { return cc.companies ? cc.companies.name : ''; }).filter(Boolean);
                var displayName = companies.length > 0 ? name + ' \u00b7 ' + companies[0] : name;
                html += '<span class="ph-contact-badge" onclick="openContactsModal()" title="' + escapeAttr(name) + '">' +
                    '<span class="ph-contact-badge-role">' + escapeHtml(pc.role) + '</span> ' +
                    escapeHtml(displayName) +
                '</span>';
            }
            if (projectContacts.length > MAX_BADGES) {
                html += '<span class="ph-contacts-more" onclick="openContactsModal()">+' + (projectContacts.length - MAX_BADGES) + '</span>';
            }
            strip.innerHTML = html;
        }

        function renderContactCards() {
            var grid = document.getElementById('contactCardsGrid');
            var html = '';
            var usedRoles = {};

            // Count contacts per role to decide whether to show star
            var roleCounts = {};
            projectContacts.forEach(function(pc) { roleCounts[pc.role] = (roleCounts[pc.role] || 0) + 1; });

            for (var i = 0; i < projectContacts.length; i++) {
                var pc = projectContacts[i];
                var c = pc.contacts;
                if (!c) continue;
                usedRoles[pc.role] = true;

                var fullName = ((c.first_name || '') + ' ' + (c.last_name || '')).trim();
                var companiesData = (c.contact_companies || []).map(function(cc) {
                    return cc.companies ? { id: cc.companies.id, name: cc.companies.name } : null;
                }).filter(Boolean);
                var companyStr = companiesData.map(function(co) { return escapeHtml(co.name); }).join(', ');

                var starHtml = '';
                if (roleCounts[pc.role] > 1) {
                    var starCls = pc.is_primary ? 'contact-primary-star active' : 'contact-primary-star';
                    var starIcon = pc.is_primary ? '&#9733;' : '&#9734;';
                    starHtml = '<span class="' + starCls + '" onclick="togglePrimaryContact(\'' + escapeAttr(pc.id) + '\',\'' + escapeAttr(pc.role) + '\')" title="' + (pc.is_primary ? 'Contact principal' : 'Définir comme principal') + '">' + starIcon + '</span>';
                }

                html += '<div class="contact-card">' +
                    '<button class="contact-card-remove" onclick="removeProjectContact(\'' + escapeAttr(pc.id) + '\')" title="Retirer">&times;</button>' +
                    '<div class="contact-card-role">' + escapeHtml(pc.role) + starHtml + '</div>' +
                    '<div class="contact-card-name"><span class="contact-card-name-link" onclick="openContactDetail(\'' + escapeAttr(c.id) + '\')">' + escapeHtml(fullName) + '</span></div>' +
                    (companyStr ? '<div class="contact-card-company">' + companyStr + '</div>' : '') +
                    '<div class="contact-card-details">' +
                        (c.phone ? '&#128222; ' + escapeHtml(c.phone) + '<br>' : '') +
                        (c.email ? '&#9993; ' + escapeHtml(c.email) : '') +
                    '</div>' +
                    '<div class="contact-card-actions">' +
                        (c.phone ? '<button class="contact-card-btn" onclick="window.open(\'tel:' + escapeAttr(c.phone) + '\')">Appeler</button>' : '') +
                        (c.email ? '<button class="contact-card-btn" onclick="window.open(\'mailto:' + escapeAttr(c.email) + '\')">Courriel</button>' : '') +
                        '<button class="contact-card-btn" onclick="copyContactInfo(\'' + escapeAttr(c.id) + '\')">Copier</button>' +
                    '</div>' +
                '</div>';
            }

            // Single placeholder card at the end
            html += '<div class="contact-card-placeholder" onclick="openAddContactModal()">' +
                '<span>+ Ajouter un contact</span>' +
            '</div>';

            grid.innerHTML = html;
        }

        function copyContactInfo(contactId) {
            var pc = projectContacts.find(function(p) { return p.contacts && p.contacts.id === contactId; });
            if (!pc || !pc.contacts) return;
            var c = pc.contacts;
            var text = ((c.first_name || '') + ' ' + (c.last_name || '')).trim();
            if (c.phone) text += '\n' + c.phone;
            if (c.email) text += '\n' + c.email;
            navigator.clipboard.writeText(text.trim());
        }

        function openContactDetail(contactId) {
            var pc = projectContacts.find(function(p) { return p.contacts && p.contacts.id === contactId; });
            if (!pc || !pc.contacts) return;
            var c = pc.contacts;
            var fullName = ((c.first_name || '') + ' ' + (c.last_name || '')).trim();
            var companies = (c.contact_companies || []).map(function(cc) { return cc.companies ? cc.companies.name : ''; }).filter(Boolean);

            document.getElementById('contactDetailTitle').textContent = fullName;
            document.getElementById('contactDetailCrmLink').href = 'clients.html#contact-' + contactId;

            var html = '';
            if (pc.role) html += '<div style="font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; color:var(--sw-navy); margin-bottom:12px;">' + escapeHtml(pc.role) + '</div>';
            if (companies.length > 0) html += '<div style="font-size:14px; color:#666; margin-bottom:12px;">' + escapeHtml(companies.join(', ')) + '</div>';

            if (c.phone) html += '<div style="font-size:14px; margin-bottom:8px;">&#128222; <a href="tel:' + escapeAttr(c.phone) + '" style="color:inherit; text-decoration:none;">' + escapeHtml(c.phone) + '</a></div>';
            if (c.email) html += '<div style="font-size:14px; margin-bottom:8px;">&#9993; <a href="mailto:' + escapeAttr(c.email) + '" style="color:inherit; text-decoration:none;">' + escapeHtml(c.email) + '</a></div>';
            if (c.address) html += '<div style="font-size:14px; margin-bottom:8px; color:#666;">&#128205; ' + escapeHtml(c.address) + '</div>';
            if (c.notes) html += '<div style="font-size:13px; margin-top:12px; padding:10px; background:#f8f8f8; border-radius:8px; color:#555; line-height:1.5;">' + escapeHtml(c.notes) + '</div>';

            if (!c.phone && !c.email && !c.address && !c.notes) {
                html += '<div style="font-size:13px; color:#999; font-style:italic;">Aucun d\u00e9tail suppl\u00e9mentaire.</div>';
            }

            document.getElementById('contactDetailBody').innerHTML = html;
            document.getElementById('contactDetailModal').classList.add('active');
        }

        function closeContactDetail() {
            document.getElementById('contactDetailModal').classList.remove('active');
        }

        async function removeProjectContact(pcId) {
            var ok = await steleConfirm('Retirer ce contact du projet ?', 'Retirer', 'Retirer', true);
            if (!ok) return;
            try {
                await authenticatedFetch(SUPABASE_URL + '/rest/v1/project_contacts?id=eq.' + pcId, { method: 'DELETE' });
                await loadProjectContacts();
                renderContactCards();
                renderContactBadges();
            } catch (e) { console.warn('Error removing project contact:', e); }
        }

        async function togglePrimaryContact(pcId, role) {
            if (!currentProject) return;
            try {
                // Clear is_primary for all contacts of this role in this project
                await authenticatedFetch(
                    SUPABASE_URL + '/rest/v1/project_contacts?project_id=eq.' + currentProject.id + '&role=eq.' + encodeURIComponent(role),
                    { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ is_primary: false }) }
                );
                // Set this one as primary
                await authenticatedFetch(
                    SUPABASE_URL + '/rest/v1/project_contacts?id=eq.' + pcId,
                    { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ is_primary: true }) }
                );
                await loadProjectContacts();
                renderContactCards();
            } catch (e) { console.warn('Error toggling primary contact:', e); }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // ADD CONTACT SUB-MODAL + COMBOBOX
        // ═══════════════════════════════════════════════════════════════════════

        function openAddContactModal(preselectedRole) {
            selectedComboContactId = null;
            document.getElementById('contactComboInput').value = '';
            document.getElementById('addContactStatus').textContent = '';
            document.getElementById('btnConfirmAddContact').disabled = true;
            var roleSelect = document.getElementById('addContactRole');
            var customInput = document.getElementById('addContactRoleCustom');
            customInput.style.display = 'none';
            customInput.value = '';
            roleSelect.value = preselectedRole || 'Entrepreneur';
            if (preselectedRole && !Array.from(roleSelect.options).some(function(o) { return o.value === preselectedRole; })) {
                roleSelect.value = 'Autre';
                customInput.style.display = 'block';
                customInput.value = preselectedRole;
            }
            document.getElementById('addContactOverlay').classList.add('active');
            loadAllContactsForCombo();
            loadAllCompaniesForCombo();
            setTimeout(function() { document.getElementById('contactComboInput').focus(); }, 100);
        }

        function toggleCustomRole() {
            var sel = document.getElementById('addContactRole');
            var custom = document.getElementById('addContactRoleCustom');
            if (sel.value === 'Autre') {
                custom.style.display = 'block';
                custom.focus();
            } else {
                custom.style.display = 'none';
                custom.value = '';
            }
        }

        function closeAddContactModal() {
            document.getElementById('addContactOverlay').classList.remove('active');
            var dd = document.getElementById('contactComboDd');
            if (dd) dd.classList.remove('open');
        }

        function openContactCombo() {
            var dd = document.getElementById('contactComboDd');
            populateContactCombo(dd, '');
            dd.classList.add('open');
        }

        function filterContactCombo(input) {
            var dd = document.getElementById('contactComboDd');
            populateContactCombo(dd, input.value);
            dd.classList.add('open');
        }

        function populateContactCombo(dd, filter) {
            var html = '';
            var f = (filter || '').toLowerCase();

            // Contacts section
            var filtered = allContactsCache.filter(function(c) {
                var name = ((c.first_name || '') + ' ' + (c.last_name || '')).toLowerCase();
                return !f || name.indexOf(f) !== -1 || (c.email || '').toLowerCase().indexOf(f) !== -1;
            });
            if (filtered.length > 0) {
                html += '<div class="combo-section-header">Contacts</div>';
                for (var i = 0; i < Math.min(filtered.length, 10); i++) {
                    var c = filtered[i];
                    var name = ((c.first_name || '') + ' ' + (c.last_name || '')).trim();
                    html += '<div class="contact-combo-item" onclick="selectComboContact(this)" data-id="' + escapeAttr(c.id) + '">' +
                        escapeHtml(name) + (c.email ? ' <small>' + escapeHtml(c.email) + '</small>' : '') + '</div>';
                }
            }

            // Companies section
            var coFiltered = allCompaniesCache.filter(function(co) {
                return !f || (co.name || '').toLowerCase().indexOf(f) !== -1;
            });
            if (coFiltered.length > 0) {
                html += '<div class="combo-section-header">Entreprises</div>';
                for (var j = 0; j < Math.min(coFiltered.length, 10); j++) {
                    var co = coFiltered[j];
                    html += '<div class="contact-combo-item" onclick="selectComboCompany(this)" data-id="' + escapeAttr(co.id) + '" data-name="' + escapeAttr(co.name) + '">' +
                        escapeHtml(co.name) + '</div>';
                }
            }

            dd.innerHTML = html || '<div class="contact-combo-item" style="color:#999;">Aucun contact trouv\u00e9</div>';
        }

        function selectComboContact(el) {
            var id = el.getAttribute('data-id');
            selectedComboContactId = id;
            var c = allContactsCache.find(function(x) { return x.id === id; });
            var name = c ? ((c.first_name || '') + ' ' + (c.last_name || '')).trim() : '';
            document.getElementById('contactComboInput').value = name;
            document.getElementById('addContactStatus').textContent = '\u2713 ' + name;
            document.getElementById('addContactStatus').style.color = 'var(--sw-navy)';
            document.getElementById('btnConfirmAddContact').disabled = false;
            document.getElementById('contactComboDd').classList.remove('open');
        }

        async function selectComboCompany(el) {
            var coId = el.getAttribute('data-id');
            var coName = el.getAttribute('data-name');
            var co = allCompaniesCache.find(function(x) { return x.id === coId; });
            var linkedContacts = (co && co.contact_companies) ? co.contact_companies.map(function(cc) { return cc.contacts; }).filter(Boolean) : [];

            if (linkedContacts.length === 0) {
                // No contacts linked, offer to create one
                document.getElementById('contactComboDd').classList.remove('open');
                var ok = await steleConfirm('L\'entreprise "' + coName + '" n\'a aucun contact li\u00e9. Cr\u00e9er un contact ?', 'Cr\u00e9er un contact', 'Cr\u00e9er');
                if (ok) {
                    var firstName = await stelePrompt('Pr\u00e9nom :', 'Nouveau contact', 'Cr\u00e9er');
                    if (!firstName || !firstName.trim()) return;
                    var lastName = await stelePrompt('Nom :', 'Nouveau contact', 'Cr\u00e9er');
                    if (!lastName || !lastName.trim()) return;
                    try {
                        var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/contacts', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                            body: JSON.stringify({ first_name: firstName.trim(), last_name: lastName.trim(), created_by: localStorage.getItem('sb_user_id') })
                        });
                        if (r.ok) {
                            var res = await r.json();
                            if (res.length > 0) {
                                // Link contact to company
                                await authenticatedFetch(SUPABASE_URL + '/rest/v1/contact_companies', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                                    body: JSON.stringify({ contact_id: res[0].id, company_id: coId })
                                });
                                allContactsCache.push(res[0]);
                                selectedComboContactId = res[0].id;
                                var fullName = firstName.trim() + ' ' + lastName.trim();
                                document.getElementById('contactComboInput').value = fullName;
                                document.getElementById('addContactStatus').textContent = '\u2713 ' + fullName + ' (' + coName + ')';
                                document.getElementById('addContactStatus').style.color = 'var(--sw-navy)';
                                document.getElementById('btnConfirmAddContact').disabled = false;
                            }
                        }
                    } catch (e) { console.warn('Error creating contact:', e); }
                }
            } else if (linkedContacts.length === 1) {
                // Auto-select the single linked contact
                selectedComboContactId = linkedContacts[0].id;
                var n = ((linkedContacts[0].first_name || '') + ' ' + (linkedContacts[0].last_name || '')).trim();
                document.getElementById('contactComboInput').value = n;
                document.getElementById('addContactStatus').textContent = '\u2713 ' + n + ' (' + coName + ')';
                document.getElementById('addContactStatus').style.color = 'var(--sw-navy)';
                document.getElementById('btnConfirmAddContact').disabled = false;
                document.getElementById('contactComboDd').classList.remove('open');
            } else {
                // Show linked contacts as sub-items
                var dd = document.getElementById('contactComboDd');
                var html = '<div class="combo-section-header">Contacts de ' + escapeHtml(coName) + '</div>';
                linkedContacts.forEach(function(lc) {
                    var lcName = ((lc.first_name || '') + ' ' + (lc.last_name || '')).trim();
                    html += '<div class="contact-combo-item" onclick="selectComboContact(this)" data-id="' + escapeAttr(lc.id) + '">' + escapeHtml(lcName) + '</div>';
                });
                dd.innerHTML = html;
            }
        }

        async function createNewContactFromCombo() {
            document.getElementById('contactComboDd').classList.remove('open');
            var firstName = await stelePrompt('Pr\u00e9nom du nouveau contact :', 'Nouveau contact', 'Cr\u00e9er');
            if (!firstName || !firstName.trim()) return;
            var lastName = await stelePrompt('Nom de famille :', 'Nouveau contact', 'Cr\u00e9er');
            if (!lastName || !lastName.trim()) return;
            try {
                var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/contacts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                    body: JSON.stringify({ first_name: firstName.trim(), last_name: lastName.trim(), created_by: localStorage.getItem('sb_user_id') })
                });
                if (r.ok) {
                    var res = await r.json();
                    if (res.length > 0) {
                        allContactsCache.push(res[0]);
                        selectedComboContactId = res[0].id;
                        var fullName = firstName.trim() + ' ' + lastName.trim();
                        document.getElementById('contactComboInput').value = fullName;
                        document.getElementById('addContactStatus').textContent = '\u2713 ' + fullName + ' cr\u00e9\u00e9';
                        document.getElementById('addContactStatus').style.color = 'var(--sw-navy)';
                        document.getElementById('btnConfirmAddContact').disabled = false;
                    }
                }
            } catch (e) { console.warn('Error creating contact:', e); }
        }

        async function confirmAddContact() {
            if (!selectedComboContactId || !currentProject) return;
            var roleVal = document.getElementById('addContactRole').value;
            var role = roleVal === 'Autre' ? document.getElementById('addContactRoleCustom').value.trim() : roleVal;
            if (!role) { document.getElementById('addContactStatus').textContent = 'Veuillez sp\u00e9cifier un r\u00f4le.'; document.getElementById('addContactStatus').style.color = '#c62828'; return; }
            try {
                var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/project_contacts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                    body: JSON.stringify({
                        project_id: currentProject.id,
                        contact_id: selectedComboContactId,
                        role: role.trim()
                    })
                });
                if (r.ok) {
                    closeAddContactModal();
                    await loadProjectContacts();
                    renderContactCards();
                    renderContactBadges();

                    // Propose to use contact's address as project address
                    await promptContactAddressForProject(selectedComboContactId);
                } else {
                    var errText = await r.text();
                    var statusEl = document.getElementById('addContactStatus');
                    if (errText.indexOf('unique') !== -1 || errText.indexOf('duplicate') !== -1) {
                        statusEl.textContent = 'Ce contact a d\u00e9j\u00e0 ce r\u00f4le dans ce projet.';
                    } else {
                        statusEl.textContent = 'Erreur lors de l\'ajout.';
                    }
                    statusEl.style.color = '#c62828';
                }
            } catch (e) { console.warn('Error adding project contact:', e); }
        }

        async function promptContactAddressForProject(contactId) {
            if (!currentProject || !contactId) return;
            // Already has a project address? Skip.
            var hasAddr = currentProject.project_address || currentProject._address || currentProject.client_address;
            if (hasAddr) return;
            // Fetch the contact's address
            try {
                var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/contacts?id=eq.' + contactId + '&select=first_name,last_name,address', {});
                if (!r.ok) return;
                var rows = await r.json();
                if (rows.length === 0 || !rows[0].address) return;
                var c = rows[0];
                var name = ((c.first_name || '') + ' ' + (c.last_name || '')).trim();
                var useIt = await steleConfirm(
                    'L\'adresse de ' + name + ' est :\n' + c.address + '\n\nUtiliser comme adresse du projet ?',
                    'Adresse du projet', 'Utiliser', false
                );
                if (useIt) {
                    await saveProjectAddress(c.address);
                } else {
                    var addr = await stelePrompt('Quelle est l\'adresse du projet ?', 'Adresse du projet', 'Enregistrer');
                    if (addr && addr.trim()) {
                        await saveProjectAddress(addr.trim());
                    }
                }
            } catch (e) { console.warn('Error prompting contact address:', e); }
        }

        async function saveProjectAddress(address) {
            // Try new column first, fallback to legacy
            var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/projects?id=eq.' + currentProject.id, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                body: JSON.stringify({ project_address: address })
            });
            if (!r.ok) {
                r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/projects?id=eq.' + currentProject.id, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                    body: JSON.stringify({ client_address: address })
                });
            }
            if (r.ok) {
                var updated = await r.json();
                if (updated.length > 0) currentProject = updated[0];
                if (!currentProject.project_address) currentProject._address = address;
                renderProjectInfoBloc();
            }
        }

        // Close combos on click outside
        document.addEventListener('click', function(e) {
            var clientWrap = document.getElementById('clientComboWrap');
            if (clientWrap && !clientWrap.contains(e.target)) closeClientCombo();
            var contactWrap = document.getElementById('contactComboWrap');
            if (contactWrap && !contactWrap.contains(e.target)) {
                var dd = document.getElementById('contactComboDd');
                if (dd) dd.classList.remove('open');
            }
        });

        // ═══════════════════════════════════════════════════════════════════════
        // WORKFLOW : SOUMETTRE / APPROUVER / RETOURNER
        // ═══════════════════════════════════════════════════════════════════════

        function updateWorkflowButtons() {
            var btnSubmit = document.getElementById('btnWfSubmit');
            var btnApprove = document.getElementById('btnWfApprove');
            var btnReturn = document.getElementById('btnWfReturn');
            var btnSendClient = document.getElementById('btnWfSendClient');
            var btnBypass = document.getElementById('btnWfBypass');
            var btnAcceptOffline = document.getElementById('btnWfAcceptOffline');

            // Hide all main action buttons
            btnSubmit.style.display = 'none';
            btnApprove.style.display = 'none';
            btnReturn.style.display = 'none';
            if (btnSendClient) { btnSendClient.style.display = 'none'; btnSendClient.textContent = 'Envoyer au client'; btnSendClient.onclick = function() { sendToClient(); }; }
            if (btnBypass) { btnBypass.style.display = 'none'; btnBypass.textContent = 'Envoyer sans approbation'; btnBypass.className = 'btn-main-action btn-main-red'; }
            if (btnAcceptOffline) btnAcceptOffline.style.display = 'none';

            if (!currentSubmission) return;

            var s = currentSubmission.status;
            if (s === 'draft' || s === 'returned') {
                btnSubmit.style.display = 'inline-block';
                btnSubmit.textContent = s === 'returned' ? 'Resoumettre' : 'Soumettre';
                if (canBypassApproval && btnBypass) {
                    btnBypass.style.display = 'inline-block';
                    if (s === 'returned') {
                        btnBypass.textContent = 'Envoyer au client';
                        btnBypass.className = 'btn-main-action btn-main-green';
                    } else {
                        btnBypass.textContent = 'Envoyer sans approbation';
                        btnBypass.className = 'btn-main-action btn-main-red';
                    }
                }
            }
            if (s === 'pending_internal' && canApproveQuotes) {
                btnApprove.style.display = 'inline-block';
                btnReturn.style.display = 'inline-block';
            }
            if (s === 'approved_internal' && btnSendClient) {
                btnSendClient.style.display = 'inline-block';
            }
            if (s === 'sent_client') {
                if (btnSendClient) {
                    btnSendClient.style.display = 'inline-block';
                    btnSendClient.textContent = 'Copier le lien';
                    btnSendClient.onclick = function() { copyQuoteLink(); };
                }
                // Vérifier si déjà acceptée (unlock → re-cycle)
                if (btnAcceptOffline) {
                    wasAlreadyAccepted(currentSubmission.id).then(function(already) {
                        if (already) {
                            btnAcceptOffline.style.display = 'inline-block';
                            btnAcceptOffline.textContent = 'Déjà vendue';
                            btnAcceptOffline.disabled = true;
                            btnAcceptOffline.title = 'Cette soumission a déjà été acceptée une fois. Contactez un administrateur.';
                            btnAcceptOffline.onclick = function() {
                                steleAlert('Cette soumission a déjà été acceptée une fois. Contactez un administrateur.');
                            };
                        } else {
                            btnAcceptOffline.style.display = 'inline-block';
                            btnAcceptOffline.textContent = 'Confirmer la vente';
                            btnAcceptOffline.disabled = false;
                            btnAcceptOffline.title = '';
                            btnAcceptOffline.onclick = function() { offlineAcceptance(); };
                        }
                    });
                }
            }

            // Kebab: Déverrouiller — visible pour statuts verrouillés si permission
            var kebabUnlock = document.getElementById('kebabUnlock');
            if (kebabUnlock) {
                kebabUnlock.style.display = 'none';
                if (canUnlockSubmission) {
                    var lockedStatuses = ['pending_internal','approved_internal','sent_client','accepted','lost'];
                    if (lockedStatuses.includes(s)) kebabUnlock.style.display = '';
                }
            }

            // Kebab archive button
            var kebabArchive = document.getElementById('kebabArchive');
            if (kebabArchive) {
                kebabArchive.style.display = 'none';
                if (currentSubmission && (s === 'accepted' || s === 'lost')) {
                    kebabArchive.style.display = '';
                    if (currentSubmission.is_archived) {
                        kebabArchive.innerHTML = '<span class="kebab-icon">&#128194;</span> D\u00e9sarchiver';
                    } else {
                        kebabArchive.innerHTML = '<span class="kebab-icon">&#128451;</span> Archiver';
                    }
                }
            }

            // Update header total
            updateHeaderTotal();
            updateStatusTimeline();
        }

        // submitForApproval() redirigé vers le modal
        function submitForApproval() { openSubmitModal(); }

        // ═══════════════════════════════════════════════════════════════════════
        // ENVOI AU CLIENT — LIEN PUBLIC
        // ═══════════════════════════════════════════════════════════════════════

        async function sendToClient() {
            if (!currentSubmission) return;
            if (currentSubmission.status !== 'approved_internal') {
                steleAlert('La soumission doit \u00eatre approuv\u00e9e avant l\'envoi au client.');
                return;
            }
            if (!(await steleConfirm('G\u00e9n\u00e9rer un lien de soumission pour le client ?\nLe statut passera \u00e0 \u00abEnvoy\u00e9e\u00bb.', 'Envoyer au client', 'G\u00e9n\u00e9rer le lien'))) return;

            try {
                // Snapshot avant envoi
                await createVersion(currentSubmission.id);

                var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/public_quote_tokens', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                    body: JSON.stringify({ submission_id: currentSubmission.id })
                });
                if (!r.ok) throw new Error('Erreur cr\u00e9ation token: ' + r.status);
                var tokenData = (await r.json())[0];

                await updateSubmission(currentSubmission.id, {
                    status: 'sent_client',
                    sent_at: new Date().toISOString()
                });
                await createSubmissionReview(currentSubmission.id, 'sent', 'Lien client g\u00e9n\u00e9r\u00e9');

                currentSubmission.status = 'sent_client';
                // Regénérer le snapshot (au cas où données ont changé depuis approbation)
                await uploadSnapshot(currentSubmission.id);
                updateStatusBadge('sent_client');
                updateWorkflowButtons();
                setEditable(false);
                loadSubmissionReviews(currentSubmission.id);

                var link = window.location.origin + '/quote.html?token=' + tokenData.token;
                showQuoteLinkModal(link);
            } catch (e) {
                console.error('Erreur envoi client:', e);
                steleAlert('Erreur: ' + e.message);
            }
        }

        function showQuoteLinkModal(link) {
            document.getElementById('steleDialogTitle').textContent = 'Lien de soumission';
            document.getElementById('steleDialogMessage').textContent = 'Copiez ce lien et envoyez-le au client par courriel :';
            document.getElementById('steleDialogInputWrap').style.display = '';
            var input = document.getElementById('steleDialogInput');
            input.value = link;
            input.readOnly = true;
            input.style.fontSize = '12px';
            document.getElementById('steleDialogCancel').style.display = 'none';
            document.getElementById('steleDialogOk').textContent = 'Copier & Fermer';
            document.getElementById('steleDialogOk').className = 'btn-generate';
            document.getElementById('steleDialogOverlay').classList.add('active');

            _steleDialogResolve = function() {
                navigator.clipboard.writeText(link).catch(function() {});
                document.getElementById('steleDialogOverlay').classList.remove('active');
                input.readOnly = false;
                input.style.fontSize = '';
            };
            setTimeout(function() { input.select(); }, 100);
        }

        async function copyQuoteLink() {
            if (!currentSubmission) return;
            var r = await authenticatedFetch(
                SUPABASE_URL + '/rest/v1/public_quote_tokens?submission_id=eq.' + currentSubmission.id + '&order=created_at.desc&limit=1', {}
            );
            if (!r.ok) { steleAlert('Erreur chargement du lien.'); return; }
            var tokens = await r.json();
            if (tokens.length === 0) { steleAlert('Aucun lien trouv\u00e9 pour cette soumission.'); return; }
            var link = window.location.origin + '/quote.html?token=' + tokens[0].token;
            showQuoteLinkModal(link);
        }

        async function approveSubmission() {
            if (!currentSubmission || !canApproveQuotes) return;
            var comment = await stelePrompt('Commentaire d\'approbation (optionnel) :', 'Approuver la soumission');
            if (comment === null) return;
            try {
                // Snapshot avant approbation
                await createVersion(currentSubmission.id);
                await createSubmissionReview(currentSubmission.id, 'approved', comment);
                var total = calculerGrandTotal();
                await updateSubmission(currentSubmission.id, {
                    status: 'approved_internal',
                    approved_by: localStorage.getItem('sb_user_id'),
                    approved_at: new Date().toISOString(),
                    approved_total: total
                });
                currentSubmission.status = 'approved_internal';
                // Figer le HTML de la soumission
                await uploadSnapshot(currentSubmission.id);
                updateStatusBadge('approved_internal');
                updateWorkflowButtons();
                setEditable(false);
                showSaveIndicator();
                loadSubmissionReviews(currentSubmission.id);
            } catch (e) {
                console.error('Erreur approbation:', e);
                steleAlert('Erreur approbation: ' + e.message);
            }
        }

        async function returnSubmission() {
            if (!currentSubmission || !canApproveQuotes) return;
            var comment = await stelePrompt('Raison du retour :', 'Retourner la soumission', 'Ex: Revoir les prix du meuble X...');
            if (comment === null) return;
            if (!comment.trim()) { steleAlert('Veuillez indiquer une raison.'); return; }
            try {
                await createSubmissionReview(currentSubmission.id, 'returned', comment);
                await updateSubmission(currentSubmission.id, { status: 'returned' });
                currentSubmission.status = 'returned';
                updateStatusBadge('returned');
                updateWorkflowButtons();
                setEditable(true);
                showSaveIndicator();
                loadSubmissionReviews(currentSubmission.id);
            } catch (e) {
                console.error('Erreur retour:', e);
                steleAlert('Erreur retour: ' + e.message);
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // BYPASS APPROBATION
        // ═══════════════════════════════════════════════════════════════════════

        function bypassApproval() {
            if (!currentSubmission) return;
            var s = currentSubmission.status;
            if (s !== 'draft' && s !== 'returned') {
                steleAlert('Seules les soumissions en brouillon ou retournées peuvent utiliser le bypass.');
                return;
            }
            if (!canBypassApproval) {
                steleAlert('Vous n\'avez pas la permission de contourner l\'approbation.');
                return;
            }
            var rows = document.querySelectorAll('.calc-row');
            if (rows.length === 0) {
                steleAlert('Veuillez ajouter au moins un article au calculateur.');
                return;
            }
            document.getElementById('bypassConfirmCheck').checked = false;
            document.getElementById('bypassReason').value = '';
            document.getElementById('bypassStatus').style.display = 'none';
            document.getElementById('btnBypassConfirm').disabled = false;
            document.getElementById('btnBypassConfirm').textContent = 'Envoyer sans approbation';
            document.getElementById('bypassModal').classList.add('active');
        }

        function closeBypassModal() {
            document.getElementById('bypassModal').classList.remove('active');
        }

        function showBypassStatus(msg, isError) {
            var el = document.getElementById('bypassStatus');
            el.style.display = 'block';
            el.textContent = msg;
            el.style.background = isError ? '#ffebee' : '#e8f5e9';
            el.style.color = isError ? '#c62828' : '#2e7d32';
        }

        async function executeBypass() {
            if (!document.getElementById('bypassConfirmCheck').checked) {
                showBypassStatus('Vous devez cocher la case de confirmation.', true);
                return;
            }
            var reason = document.getElementById('bypassReason').value.trim();
            if (!reason) {
                showBypassStatus('La raison est obligatoire.', true);
                return;
            }
            if (reason.length < 10) {
                showBypassStatus('La raison doit contenir au moins 10 caractères.', true);
                return;
            }

            var btn = document.getElementById('btnBypassConfirm');
            btn.disabled = true;
            btn.textContent = 'Envoi en cours...';
            showBypassStatus('Traitement en cours...', false);

            try {
                var statusBefore = currentSubmission.status;

                // 1. Snapshot
                await createVersion(currentSubmission.id);

                // 2. Log immutable via RPC (capture IP serveur)
                var rpcResp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/rpc/log_bypass_approval', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        p_submission_id: currentSubmission.id,
                        p_reason: reason,
                        p_status_before: statusBefore,
                        p_status_after: 'sent_client'
                    })
                });
                if (!rpcResp.ok) throw new Error('Erreur journalisation bypass: ' + rpcResp.status);

                // 3. Générer token client (même logique que sendToClient)
                var tokenResp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/public_quote_tokens', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                    body: JSON.stringify({ submission_id: currentSubmission.id })
                });
                if (!tokenResp.ok) throw new Error('Erreur création token: ' + tokenResp.status);
                var tokenData = (await tokenResp.json())[0];

                // 4. Mettre à jour la soumission
                var grandTotal = calculerGrandTotal();
                await updateSubmission(currentSubmission.id, {
                    status: 'sent_client',
                    sent_at: new Date().toISOString(),
                    bypass_approval: true,
                    approved_total: grandTotal
                });

                // 5. Entrée timeline
                await createSubmissionReview(currentSubmission.id, 'bypass', 'BYPASS: ' + reason);

                // 6. Figer le HTML de la soumission
                currentSubmission.status = 'sent_client';
                currentSubmission.bypass_approval = true;
                await uploadSnapshot(currentSubmission.id);

                // 7. Mettre à jour l'UI
                updateStatusBadge('sent_client');
                updateWorkflowButtons();
                setEditable(false);
                loadSubmissionReviews(currentSubmission.id);

                showBypassStatus('Soumission envoyée au client (bypass approbation).', false);

                // 7. Afficher le lien client
                var link = window.location.origin + '/quote.html?token=' + tokenData.token;
                setTimeout(function() {
                    closeBypassModal();
                    showQuoteLinkModal(link);
                }, 1500);

            } catch (e) {
                console.error('Erreur bypass:', e);
                showBypassStatus('Erreur: ' + e.message, true);
                btn.disabled = false;
                btn.textContent = 'Envoyer sans approbation';
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // ACCEPTATION HORS-LIGNE (Chemin B)
        // ═══════════════════════════════════════════════════════════════════════

        async function offlineAcceptance() {
            if (!currentSubmission) return;
            if (currentSubmission.status !== 'sent_client') {
                steleAlert('Seules les soumissions envoyées au client peuvent être confirmées.');
                return;
            }
            // Guard: double acceptation
            if (await wasAlreadyAccepted(currentSubmission.id)) {
                steleAlert('Cette soumission a déjà été acceptée une fois. Contactez un administrateur.');
                return;
            }
            // Reset modal
            document.getElementById('offlineUserName').value = '';
            document.getElementById('offlineClientName').value = currentProject ? (currentProject.client_name || '') : '';
            document.getElementById('offlineMethod').value = 'courriel';
            document.getElementById('offlineDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('offlineNotes').value = '';
            document.getElementById('offlineConfirmCheck').checked = false;
            document.getElementById('btnOfflineConfirm').disabled = false;
            document.getElementById('btnOfflineConfirm').textContent = 'Confirmer la vente';
            document.getElementById('offlineAcceptStatus').style.display = 'none';
            document.getElementById('offlineAcceptModal').classList.add('active');
        }

        function closeOfflineAcceptModal() {
            document.getElementById('offlineAcceptModal').classList.remove('active');
        }

        function showOfflineAcceptStatus(msg, isError) {
            var el = document.getElementById('offlineAcceptStatus');
            el.style.display = 'block';
            el.textContent = msg;
            el.style.background = isError ? '#ffebee' : '#e8f5e9';
            el.style.color = isError ? '#c62828' : '#2e7d32';
        }

        async function executeOfflineAcceptance() {
            var userName = document.getElementById('offlineUserName').value.trim();
            var clientName = document.getElementById('offlineClientName').value.trim();
            var method = document.getElementById('offlineMethod').value;
            var acceptDate = document.getElementById('offlineDate').value;
            var notes = document.getElementById('offlineNotes').value.trim();
            var checked = document.getElementById('offlineConfirmCheck').checked;

            if (!userName) {
                showOfflineAcceptStatus('Le nom du chargé de projet est obligatoire.', true);
                return;
            }
            if (!clientName) {
                showOfflineAcceptStatus('Le nom du client est obligatoire.', true);
                return;
            }
            if (!acceptDate) {
                showOfflineAcceptStatus('La date d\'acceptation est obligatoire.', true);
                return;
            }
            if (!checked) {
                showOfflineAcceptStatus('Vous devez cocher la case de confirmation.', true);
                return;
            }

            var btn = document.getElementById('btnOfflineConfirm');
            btn.disabled = true;
            btn.textContent = 'Traitement en cours...';
            showOfflineAcceptStatus('Vérification...', false);

            // Double acceptance guard
            if (await wasAlreadyAccepted(currentSubmission.id)) {
                showOfflineAcceptStatus('Cette soumission a déjà été acceptée une fois. Impossible de ré-accepter.', true);
                btn.disabled = false;
                btn.textContent = 'Confirmer la vente';
                return;
            }

            showOfflineAcceptStatus('Enregistrement...', false);

            try {
                // 0. Snapshot avant acceptation
                await createVersion(currentSubmission.id);

                // 1. Log immutable via RPC (capture IP serveur)
                var rpcResp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/rpc/log_offline_acceptance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        p_submission_id: currentSubmission.id,
                        p_user_name: userName,
                        p_acceptance_method: method,
                        p_acceptance_date: acceptDate,
                        p_client_name: clientName,
                        p_notes: notes || null
                    })
                });
                if (!rpcResp.ok) throw new Error('Erreur journalisation acceptation: ' + rpcResp.status);

                // 2. Mettre à jour la soumission (statut + date seulement)
                await updateSubmission(currentSubmission.id, {
                    status: 'accepted',
                    accepted_at: new Date(acceptDate).toISOString()
                });

                // 2b. Best-effort: accepted_by_name (colonne optionnelle)
                try {
                    await authenticatedFetch(SUPABASE_URL + '/rest/v1/submissions?id=eq.' + currentSubmission.id, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                        body: JSON.stringify({ accepted_by_name: clientName })
                    });
                } catch (e) { /* colonne peut ne pas exister */ }

                // 3. Entrée timeline
                var methodLabels = { courriel: 'Courriel', telephone: 'Téléphone', papier: 'Papier', autre: 'Autre' };
                var comment = 'Acceptation hors-ligne par ' + userName + ' — Méthode: ' + (methodLabels[method] || method) + ', Client: ' + clientName;
                if (notes) comment += ', Notes: ' + notes;
                await createSubmissionReview(currentSubmission.id, 'offline_accepted', comment);

                // 4. Mettre à jour l'UI
                currentSubmission.status = 'accepted';
                currentSubmission.accepted_at = acceptDate;
                currentSubmission.accepted_by_name = clientName;
                updateStatusBadge('accepted');
                updateWorkflowButtons();
                setEditable(false);
                loadSubmissionReviews(currentSubmission.id);

                showOfflineAcceptStatus('Vente confirmée avec succès!', false);

                setTimeout(function() {
                    closeOfflineAcceptModal();
                }, 1500);

            } catch (e) {
                console.error('Erreur acceptation hors-ligne:', e);
                showOfflineAcceptStatus('Erreur: ' + e.message, true);
                btn.disabled = false;
                btn.textContent = 'Confirmer la vente';
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // MARQUER COMME PERDU (LOST)
        // ═══════════════════════════════════════════════════════════════════════

        function openLostModal() {
            if (!currentSubmission) return;
            if (currentSubmission.status !== 'sent_client') {
                steleAlert('Seules les soumissions envoy\u00e9es au client peuvent \u00eatre marqu\u00e9es comme perdues.');
                return;
            }
            document.getElementById('lostReason').value = '';
            document.getElementById('lostCompetitorSearch').value = '';
            document.getElementById('lostCompetitorId').value = '';
            document.getElementById('lostCompetitorPrice').value = '';
            document.getElementById('lostStatus').style.display = 'none';
            document.getElementById('btnLostConfirm').disabled = false;
            document.getElementById('btnLostConfirm').textContent = 'Marquer comme perdu';
            document.getElementById('lostCompetitorDd').classList.remove('open');
            document.getElementById('lostModal').classList.add('active');
        }

        function closeLostModal() {
            document.getElementById('lostModal').classList.remove('active');
        }

        document.addEventListener('click', function(e) {
            if (e.target === document.getElementById('lostModal')) closeLostModal();
        });

        function showLostStatus(msg, isError) {
            var el = document.getElementById('lostStatus');
            el.style.display = 'block';
            el.textContent = msg;
            el.style.background = isError ? '#ffebee' : '#e8f5e9';
            el.style.color = isError ? '#c62828' : '#2e7d32';
        }

        function filterLostCompetitors(input) {
            var dd = document.getElementById('lostCompetitorDd');
            var f = (input.value || '').toLowerCase();
            // Clear hidden id when user types
            document.getElementById('lostCompetitorId').value = '';
            var filtered = allCompaniesCache.filter(function(co) {
                return !f || (co.name || '').toLowerCase().indexOf(f) !== -1;
            });
            var html = '';
            for (var i = 0; i < Math.min(filtered.length, 10); i++) {
                var co = filtered[i];
                html += '<div class="contact-combo-item" onclick="selectLostCompetitor(this)" data-id="' + escapeAttr(co.id) + '" data-name="' + escapeAttr(co.name) + '">' +
                    escapeHtml(co.name) + (co.is_competitor ? ' <small style="color:#c62828;">\u2022 concurrent</small>' : '') + '</div>';
            }
            dd.innerHTML = html || '<div class="contact-combo-item" style="color:#999;">Aucune entreprise trouv\u00e9e</div>';
            dd.classList.add('open');
        }

        function selectLostCompetitor(el) {
            document.getElementById('lostCompetitorSearch').value = el.getAttribute('data-name');
            document.getElementById('lostCompetitorId').value = el.getAttribute('data-id');
            document.getElementById('lostCompetitorDd').classList.remove('open');
        }

        // Close competitor dropdown on outside click
        document.addEventListener('click', function(e) {
            var dd = document.getElementById('lostCompetitorDd');
            if (dd && !e.target.closest('#lostCompetitorSearch') && !e.target.closest('#lostCompetitorDd')) {
                dd.classList.remove('open');
            }
        });

        async function executeLostSubmission() {
            var reason = document.getElementById('lostReason').value.trim();
            var competitorId = document.getElementById('lostCompetitorId').value || null;
            var competitorPrice = document.getElementById('lostCompetitorPrice').value.trim();
            competitorPrice = competitorPrice ? parseFloat(competitorPrice) : null;

            var btn = document.getElementById('btnLostConfirm');
            btn.disabled = true;
            btn.textContent = 'Traitement en cours...';
            showLostStatus('Enregistrement...', false);

            try {
                // 1. Snapshot before marking as lost
                await createVersion(currentSubmission.id);

                // 2. Update submission with lost fields
                await updateSubmission(currentSubmission.id, {
                    status: 'lost',
                    lost_at: new Date().toISOString(),
                    lost_reason: reason || null,
                    lost_competitor_company_id: competitorId,
                    lost_competitor_price: competitorPrice
                });

                // 3. Mark competitor company if selected (non-blocking)
                if (competitorId) {
                    try {
                        await authenticatedFetch(SUPABASE_URL + '/rest/v1/companies?id=eq.' + competitorId, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                            body: JSON.stringify({ is_competitor: true })
                        });
                    } catch (e) { /* non-blocking */ }
                }

                // 4. Review timeline entry
                var comment = 'Soumission marqu\u00e9e comme perdue.';
                if (reason) comment += ' Raison: ' + reason;
                if (competitorId) {
                    var coName = document.getElementById('lostCompetitorSearch').value;
                    if (coName) comment += ' Concurrent: ' + coName;
                }
                if (competitorPrice) comment += ' Prix concurrent: ' + formatPrice(competitorPrice);
                await createSubmissionReview(currentSubmission.id, 'lost', comment);

                // 5. Update UI
                currentSubmission.status = 'lost';
                currentSubmission.lost_at = new Date().toISOString();
                updateStatusBadge('lost');
                updateWorkflowButtons();
                setEditable(false);
                loadSubmissionReviews(currentSubmission.id);

                showLostStatus('Soumission marqu\u00e9e comme perdue.', false);
                setTimeout(function() { closeLostModal(); }, 1500);

            } catch (e) {
                console.error('Erreur marquage perdu:', e);
                showLostStatus('Erreur: ' + e.message, true);
                btn.disabled = false;
                btn.textContent = 'Marquer comme perdu';
            }
        }

        async function reopenLostSubmission() {
            if (!currentSubmission || currentSubmission.status !== 'lost') return;
            if (!(await steleConfirm(
                'Rouvrir cette soumission perdue ?\nElle repassera au statut \u00abEnvoy\u00e9e au client\u00bb.',
                'Rouvrir la soumission', 'Rouvrir'
            ))) return;

            try {
                await createVersion(currentSubmission.id);
                await updateSubmission(currentSubmission.id, {
                    status: 'sent_client',
                    lost_at: null,
                    lost_reason: null,
                    lost_competitor_company_id: null,
                    lost_competitor_price: null
                });
                await createSubmissionReview(currentSubmission.id, 'reopened', 'Soumission rouverte depuis le statut perdu');

                currentSubmission.status = 'sent_client';
                updateStatusBadge('sent_client');
                updateWorkflowButtons();
                setEditable(false);
                loadSubmissionReviews(currentSubmission.id);
            } catch (e) {
                console.error('Erreur r\u00e9ouverture:', e);
                steleAlert('Erreur: ' + e.message);
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // ARCHIVAGE DES SOUMISSIONS
        // ═══════════════════════════════════════════════════════════════════════

        function toggleArchiveFilter() {
            pipelineFilters.showArchived = !pipelineFilters.showArchived;
            var btn = document.getElementById('filterArchiveBtn');
            if (btn) btn.classList.toggle('active', pipelineFilters.showArchived);
            applyPipelineFilters();
        }

        async function toggleArchiveSubmission() {
            if (!currentSubmission) return;
            var newVal = !currentSubmission.is_archived;
            try {
                await authenticatedFetch(SUPABASE_URL + '/rest/v1/submissions?id=eq.' + currentSubmission.id, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                    body: JSON.stringify({ is_archived: newVal })
                });
                currentSubmission.is_archived = newVal;
                updateWorkflowButtons();
                renderProjectList();
                showSaveIndicator();
            } catch (e) {
                console.error('Erreur archivage:', e);
                steleAlert('Erreur: ' + e.message);
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // SUPPRIMER UN PROJET
        // ═══════════════════════════════════════════════════════════════════════

        async function handleDeleteProject(projectId, event) {
            event.stopPropagation();
            if (!(await steleConfirm('Supprimer ce projet et toutes ses donn\u00e9es ?', 'Supprimer le projet', 'Supprimer', true))) return;
            await deleteProject(projectId);
            renderProjectList();
        }

        // ═══════════════════════════════════════════════════════════════════════
        // RENTABILITÉ
        // ═══════════════════════════════════════════════════════════════════════

        function openRentab(scope, groupId) {
            // scope = 'project' ou 'group'
            var title = scope === 'project' ? 'Rentabilit\u00e9 — Projet complet' : 'Rentabilit\u00e9 — ' + (document.getElementById(groupId + '-name').value || 'Meuble');
            document.getElementById('rentabTitle').textContent = title;

            // Collecter les lignes en scope
            var rows;
            if (scope === 'project') {
                rows = document.querySelectorAll('.calc-row');
            } else {
                rows = document.querySelectorAll('#' + groupId + '-rows .calc-row');
            }

            // Accumulateurs
            var deptMinutes = {};
            var matCoutant = {};
            var totalMatMarkup = 0;
            var totalMatWaste = 0;
            var totalMatCoutant = 0;
            var totalHeuresCharge = 0;
            var totalSalaires = 0;
            var totalFraisFixes = 0;
            var totalProfitMO = 0;
            var totalPrixVente = 0;
            var totalAjout = 0;

            // Init départements
            tauxHoraires.forEach(function(t) { deptMinutes[t.department] = 0; });

            // Init matériaux
            expenseCategories.forEach(function(c) { matCoutant[c.name] = 0; });

            // Per-tag accumulator
            var tagData = {}; // { "C": { label, prixVente, heures, matCout, profit, count }, ... }

            rows.forEach(function(row) {
                var select = row.querySelector('.item-select');
                var qtyInput = row.querySelector('.qty-input');
                if (!select || !qtyInput) return;
                var selectedId = select.value;
                var qty = parseFloat(qtyInput.value) || 0;

                // Get tag for this row
                var tagInput = row.querySelector('.cell-tag input');
                var tag = tagInput ? tagInput.value.trim().toUpperCase() : '';
                var tagPrefix = tag ? tag.replace(/[0-9]/g, '') : '';

                if (!selectedId || selectedId === '__AJOUT__' || selectedId === '__PROPOSER__') {
                    if (selectedId === '__AJOUT__') {
                        var ajoutTotal = getRowTotal(row);
                        totalPrixVente += ajoutTotal;
                        totalAjout += ajoutTotal;
                        if (tagPrefix) {
                            if (!tagData[tagPrefix]) tagData[tagPrefix] = { prixVente: 0, heures: 0, matCout: 0, profit: 0, count: 0 };
                            tagData[tagPrefix].prixVente += ajoutTotal;
                            tagData[tagPrefix].count++;
                        }
                    }
                    return;
                }
                var item = CATALOGUE_DATA.find(function(i) { return i.id === selectedId; });
                if (!item) return;

                var installCb = document.getElementById(row.id + '-install');
                var includeInstall = installCb ? installCb.checked : true;
                var laborMinutes = item.labor_minutes || {};
                var materialCosts = item.material_costs || {};

                var rowHeures = 0, rowMatCout = 0, rowProfit = 0, rowPrixVente = 0;

                // Départements
                tauxHoraires.forEach(function(t) {
                    var dept = t.department;
                    var mins = (laborMinutes[dept] || 0) * qty;
                    if (!includeInstall && dept === 'Installation') return;
                    deptMinutes[dept] = (deptMinutes[dept] || 0) + mins;
                    var hours = mins / 60;
                    totalHeuresCharge += hours * (t.taux_horaire || 0);
                    totalSalaires += hours * (t.salaire || 0);
                    totalFraisFixes += hours * (t.frais_fixe || 0);
                    totalProfitMO += hours * ((t.taux_horaire || 0) - (t.salaire || 0) - (t.frais_fixe || 0));
                    rowHeures += hours;
                    rowPrixVente += hours * (t.taux_horaire || 0);
                    rowProfit += hours * ((t.taux_horaire || 0) - (t.salaire || 0) - (t.frais_fixe || 0));
                });

                // Matériaux
                expenseCategories.forEach(function(c) {
                    var cost = (materialCosts[c.name] || 0) * qty;
                    matCoutant[c.name] = (matCoutant[c.name] || 0) + cost;
                    totalMatCoutant += cost;
                    totalMatMarkup += cost * ((c.markup || 0) / 100);
                    var wasteRate = item.loss_override_pct != null ? item.loss_override_pct : (c.waste || 0);
                    totalMatWaste += cost * (wasteRate / 100);
                    rowMatCout += cost;
                    rowPrixVente += cost + cost * ((c.markup || 0) / 100) + cost * (wasteRate / 100);
                    rowProfit += cost * ((c.markup || 0) / 100);
                });

                // Fallback: si pas de données composées, utiliser item.price
                var composedPrice = computeComposedPrice(item, includeInstall);
                if (composedPrice === null) {
                    var flatTotal = (item.price || 0) * qty;
                    totalPrixVente += flatTotal;
                    rowPrixVente += flatTotal;
                }

                // Accumulate per-tag
                if (tagPrefix) {
                    if (!tagData[tagPrefix]) tagData[tagPrefix] = { prixVente: 0, heures: 0, matCout: 0, profit: 0, count: 0 };
                    tagData[tagPrefix].prixVente += rowPrixVente;
                    tagData[tagPrefix].heures += rowHeures;
                    tagData[tagPrefix].matCout += rowMatCout;
                    tagData[tagPrefix].profit += rowProfit;
                    tagData[tagPrefix].count++;
                }
            });

            totalPrixVente += totalHeuresCharge + totalMatCoutant + totalMatWaste + totalMatMarkup;

            // Marges
            var profitNet = totalProfitMO + totalMatMarkup;
            var prixVenteSansAjout = totalPrixVente - totalAjout;
            var margeBrutReelPct = prixVenteSansAjout > 0 ? (profitNet / prixVenteSansAjout * 100) : 0;
            var profitNetAvecAjout = profitNet + totalAjout;
            var margeBrutAvecAjoutPct = totalPrixVente > 0 ? (profitNetAvecAjout / totalPrixVente * 100) : 0;
            var margeVisee = 38; // %
            var margeViseeMontant = totalPrixVente * margeVisee / 100;

            // Total minutes
            var totalMinutes = 0;
            tauxHoraires.forEach(function(t) { totalMinutes += (deptMinutes[t.department] || 0); });

            // Render
            var f = function(v) { return Math.round(v).toLocaleString('fr-CA') + ' $'; };
            var fPct = function(v) { return v.toFixed(1) + ' %'; };
            var fNum = function(v) { return v.toLocaleString('fr-CA', { minimumFractionDigits: 1, maximumFractionDigits: 1 }); };

            var html = '';

            // ── 2 colonnes : résumé | ventilation + marges ──
            html += '<div class="rentab-columns">';

            // Colonne gauche — Résumé
            html += '<div>';
            html += '<div class="rentab-section">';
            html += '<div class="rentab-section-title">R\u00e9sum\u00e9</div>';
            html += '<table class="rentab-table">';
            html += '<tr class="highlight"><td>Prix de vente total</td><td>' + f(totalPrixVente) + '</td></tr>';
            html += '<tr class="spacer"><td></td><td></td></tr>';
            html += '<tr><td>Prix co\u00fbtant mat\u00e9riaux (base)</td><td>' + f(totalMatCoutant) + '</td></tr>';
            html += '<tr><td>Perte mat\u00e9riaux</td><td>' + f(totalMatWaste) + '</td></tr>';
            html += '<tr><td>Mark up mat\u00e9riaux</td><td>' + f(totalMatMarkup) + '</td></tr>';
            html += '<tr class="spacer"><td></td><td></td></tr>';
            html += '<tr class="highlight"><td>Total heures charg\u00e9</td><td>' + f(totalHeuresCharge) + '</td></tr>';
            html += '<tr><td>Total salaires</td><td>' + f(totalSalaires) + '</td></tr>';
            html += '<tr><td>Total frais fixes</td><td>' + f(totalFraisFixes) + '</td></tr>';
            html += '<tr><td>Profit sur taux horaire</td><td>' + f(totalProfitMO) + '</td></tr>';
            if (totalAjout > 0) {
                html += '<tr class="spacer"><td></td><td></td></tr>';
                html += '<tr><td>Ajouts personnalis\u00e9s</td><td style="color:#1565C0;">' + f(totalAjout) + '</td></tr>';
            }
            html += '</table>';
            html += '</div>';
            html += '</div>';

            // Colonne droite — Ventilation + Marges
            html += '<div>';

            // Départements
            html += '<div class="rentab-section">';
            html += '<div class="rentab-section-title">Ventilation main-d\u2019\u0153uvre</div>';
            html += '<table class="rentab-dept-table">';
            html += '<tr><th></th>';
            tauxHoraires.forEach(function(t) {
                var short = t.department.split('/')[0].substring(0, 6);
                html += '<th>' + escapeHtml(short) + '</th>';
            });
            html += '</tr>';
            // Heures
            html += '<tr><td>Heures</td>';
            var totalHeures = 0;
            tauxHoraires.forEach(function(t) {
                var h = (deptMinutes[t.department] || 0) / 60;
                totalHeures += h;
                html += '<td>' + fNum(h) + '</td>';
            });
            html += '</tr>';
            html += '</table>';
            html += '</div>';

            // Marges
            html += '<div class="rentab-section">';
            html += '<div class="rentab-section-title">Marges</div>';
            html += '<div class="rentab-margins">';
            html += '<div class="rentab-margins-row"><span>Marge brut vis\u00e9e</span><span>' + fPct(margeVisee) + '</span></div>';
            html += '<div class="rentab-margins-row"><span>Marge brut r\u00e9elle</span><span>' + fPct(margeBrutReelPct) + '</span></div>';
            if (totalAjout > 0) {
                html += '<div class="rentab-margins-row"><span>Marge brut avec ajouts</span><span style="color:#1565C0;font-weight:600;">' + fPct(margeBrutAvecAjoutPct) + '</span></div>';
            }
            html += '<div class="rentab-margins-row profit-row"><span>Profit net estim\u00e9</span><span>' + f(profitNetAvecAjout) + '</span></div>';
            html += '</div>';
            html += '</div>';

            html += '</div>';
            html += '</div>'; // fin rentab-columns

            // ── Pleine largeur : Coûtant matériaux ──
            html += '<div class="rentab-section" style="margin-top:8px;">';
            html += '<div class="rentab-section-title">Co\u00fbtant mat\u00e9riaux</div>';
            html += '<table class="rentab-table">';
            var hasMatRows = false;
            expenseCategories.forEach(function(c) {
                var costVal = matCoutant[c.name] || 0;
                if (costVal > 0) {
                    html += '<tr><td>' + escapeHtml(c.name) + '</td><td>' + f(costVal) + '</td></tr>';
                    hasMatRows = true;
                }
            });
            if (!hasMatRows) html += '<tr><td colspan="2" style="color:#999;">Aucun mat\u00e9riau</td></tr>';
            html += '<tr class="total"><td>Total</td><td>' + f(totalMatCoutant) + '</td></tr>';
            html += '</table>';
            html += '</div>';

            // ── Ventilation par tag ──
            var tagPrefixKeys = Object.keys(tagData).sort();
            if (tagPrefixKeys.length > 0) {
                html += '<div class="rentab-section rentab-tag-section">';
                html += '<div class="rentab-section-title">Ventilation par tag</div>';
                html += '<div class="rentab-tag-grid">';
                tagPrefixKeys.forEach(function(prefix) {
                    var td = tagData[prefix];
                    var tp = (tagPrefixes || []).find(function(t) { return t.prefix === prefix; });
                    var label = tp ? prefix + ' — ' + tp.label_fr : prefix;
                    var marge = td.prixVente > 0 ? (td.profit / td.prixVente * 100) : 0;
                    html += '<div class="rentab-tag-card">';
                    html += '<div class="rentab-tag-card-title">' + escapeHtml(label) + ' (' + td.count + ' ligne' + (td.count > 1 ? 's' : '') + ')</div>';
                    html += '<table>';
                    html += '<tr><td>Prix de vente</td><td>' + f(td.prixVente) + '</td></tr>';
                    html += '<tr><td>Heures</td><td>' + fNum(td.heures) + ' h</td></tr>';
                    html += '<tr><td>Mat\u00e9riaux (co\u00fbt)</td><td>' + f(td.matCout) + '</td></tr>';
                    html += '<tr class="tag-card-total"><td>Profit</td><td>' + f(td.profit) + '</td></tr>';
                    html += '<tr><td>Marge</td><td>' + fPct(marge) + '</td></tr>';
                    html += '</table>';
                    html += '</div>';
                });
                html += '</div>';
                html += '</div>';
            }

            document.getElementById('rentabBody').innerHTML = html;
            document.getElementById('rentabModal').classList.add('active');
        }

        function closeRentab() {
            document.getElementById('rentabModal').classList.remove('active');
        }

        // ═══════════════════════════════════════════════════════════════════════
        // VÉRIFICATION DES PERMISSIONS
        // ═══════════════════════════════════════════════════════════════════════

        const DEFAULT_PERMISSIONS = {
            'Admin': { calculateur: true }, 'Vente': { calculateur: true },
            'Charg\u00e9 de projet': { calculateur: true }, 'Achat': { calculateur: false },
            'Atelier': { calculateur: false }, 'Client': { calculateur: false }
        };
        const DEFAULT_USER_ROLES = { 'hubert@stele.ca': 'Admin' };

        async function checkPageAccess() {
            try {
                const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/app_config?key=in.(permissions,user_roles)&select=key,value', {});
                let perms = DEFAULT_PERMISSIONS, roles = DEFAULT_USER_ROLES;
                if (r.ok) {
                    const rows = await r.json();
                    rows.forEach(row => {
                        if (row.key === 'permissions') perms = row.value;
                        if (row.key === 'user_roles') roles = row.value;
                    });
                }
                _allUserRoles = roles;
                _allPermissions = perms;
                const email = (localStorage.getItem('sb_user_email') || '').toLowerCase();
                const role = roles[email] || 'Client';
                const defaults = DEFAULT_PERMISSIONS[role] || {};
                const saved = perms[role] || {};
                const allowed = Object.assign({}, defaults, saved);
                canEditMinutes = !!allowed.edit_minutes;
                canEditMaterials = !!allowed.edit_materials;
                canApproveQuotes = !!allowed.can_approve_quotes;
                canBypassApproval = !!allowed.can_bypass_approval;
                canUnlockSubmission = !!allowed.can_unlock_submission;
                var hasSubParam = new URLSearchParams(window.location.search).has('submission');
                if (!allowed.calculateur && !(hasSubParam && (allowed.approbation || allowed.can_approve_quotes))) {
                    window.location.href = 'app.html'; return false;
                }
            } catch (e) {
                const email = (localStorage.getItem('sb_user_email') || '').toLowerCase();
                const role = DEFAULT_USER_ROLES[email] || 'Client';
                var defPerms = DEFAULT_PERMISSIONS[role] || {};
                canEditMinutes = !!defPerms.edit_minutes;
                canEditMaterials = !!defPerms.edit_materials;
                canApproveQuotes = !!defPerms.can_approve_quotes;
                canBypassApproval = !!defPerms.can_bypass_approval;
                canUnlockSubmission = !!defPerms.can_unlock_submission;
                if (!defPerms.calculateur) { window.location.href = 'app.html'; return false; }
            }
            return true;
        }

        async function loadMediaTags() {
            try {
                const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/app_config?key=eq.media_tags&select=value', {});
                if (r.ok) {
                    const rows = await r.json();
                    if (rows.length > 0 && Array.isArray(rows[0].value)) {
                        mediaTagsList = rows[0].value;
                    }
                }
            } catch (e) { /* keep defaults */ }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // ═══════════════════════════════════════════════════════════════════════
        // Listen for captures from standalone PDF viewer window
        // ═══════════════════════════════════════════════════════════════════════
        window.addEventListener('message', function(e) {
            if (e.data && e.data.type === 'PLAN_CAPTURE_DONE') {
                var roomId = e.data.roomId;
                // Find groupDomId from roomMap (reverse lookup)
                var groupId = null;
                for (var key in roomMap) {
                    if (roomMap[key] === roomId) { groupId = key; break; }
                }
                if (!groupId) return;

                if (!groupImages[groupId]) groupImages[groupId] = [];
                groupImages[groupId].push({
                    name: (e.data.croppedUrl || '').split('/').pop() || 'capture.jpg',
                    url: e.data.croppedUrl,
                    originalUrl: e.data.originalUrl,
                    mediaId: e.data.mediaId,
                    tags: ['presentation_soumission'],
                    cropRatio: e.data.cropRatio,
                    isLegacy: false,
                    showInQuote: true,
                    annotations: []
                });
                renderGroupImagePreviews(groupId);
                showSaveIndicator();
            }
        });

        // INITIALISATION
        // ═══════════════════════════════════════════════════════════════════════

        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Verify PDF.js loaded
                if (!scriptsLoaded.pdfjs && typeof pdfjsLib === 'undefined') {
                    throw new Error('PDF.js failed to load');
                }

                if (!(await checkPageAccess())) return;
                await loadCatalogueData();
                await loadConfigCategories();
                await loadTauxAndExpenses();
                await loadMediaTags();
                await loadEmployeesData();
                loadUserProfilesMap(); // non-blocking, populates USER_PROFILES_MAP
                loadSupplierCompanies(); // non-blocking, populates SUPPLIER_COMPANIES
                await loadPipelineConfig();

                // Setup PDF viewer Ctrl+scroll zoom
                var pdfCanvasContainer = document.getElementById('pdfCanvasContainer');
                if (pdfCanvasContainer) {
                    pdfCanvasContainer.addEventListener('wheel', function(e) {
                        if (e.ctrlKey) {
                            e.preventDefault();
                            var delta = e.deltaY > 0 ? -0.1 : 0.1;
                            pdfZoom(delta);
                        }
                    }, { passive: false });
                }

                // Check for direct submission opening (from approbation page)
                var params = new URLSearchParams(window.location.search);
                var submissionParam = params.get('submission');
                if (submissionParam) {
                    isApprovalMode = true;
                    await openSubmission(submissionParam);
                } else {
                    renderProjectList();
                }

                // App is ready - hide overlay
                appReady = true;
                hideOverlay();

            } catch (error) {
                console.error('Application initialization error:', error);
                var errorMsg = 'Une erreur est survenue lors du chargement de l\'application.';
                if (error && error.message) {
                    errorMsg += '\n\nDétails techniques: ' + error.message;
                }
                showOverlayError(
                    'Erreur de chargement',
                    errorMsg
                );
            }
        });
    </script>

<!-- Custom item modal -->
<div id="customItemModal" class="modal-overlay" onclick="if(event.target===this)closeCustomItemModal()">
  <div class="custom-item-modal">
    <div class="cim-header">
      <h3>Ajout personnalis&eacute;</h3>
      <button class="cim-close" onclick="closeCustomItemModal()">&times;</button>
    </div>
    <div class="cim-body">
      <label class="cim-label">Description</label>
      <textarea id="cimDescription" rows="2" placeholder="Description de l'article..."></textarea>

      <label class="cim-label">Fournisseur</label>
      <select id="cimSupplier"><option value="">— Aucun —</option></select>

      <div class="cim-row">
        <div class="cim-field">
          <label class="cim-label">Co&ucirc;t fournisseur ($)</label>
          <input id="cimCost" type="number" min="0" step="0.01" value="0" oninput="updateCimSellPrice()">
        </div>
        <div class="cim-field">
          <label class="cim-label">Marge (%)</label>
          <input id="cimMarkup" type="number" min="0" step="1" value="30" oninput="updateCimSellPrice()">
        </div>
        <div class="cim-field">
          <label class="cim-label">Prix de vente</label>
          <div id="cimSellPrice" class="cim-computed">0,00 $</div>
        </div>
      </div>

      <label class="cim-label">Notes / Soumission fournisseur</label>
      <textarea id="cimSupplierNotes" rows="3" placeholder="D&eacute;tails de la soumission, conditions, d&eacute;lais..."></textarea>

      <label class="cim-label">Pi&egrave;ces jointes</label>
      <div id="cimDropZone" class="cim-dropzone">
        <input type="file" id="cimFileInput" multiple accept="image/*,.pdf" style="display:none">
        <span>Glisser un fichier ou <a href="#" onclick="event.preventDefault();document.getElementById('cimFileInput').click()">parcourir</a></span>
      </div>
      <div id="cimFileList" class="cim-file-list"></div>
    </div>
    <div class="cim-footer">
      <button class="cim-btn-cancel" onclick="closeCustomItemModal()">Annuler</button>
      <button class="cim-btn-save" onclick="saveCustomItemModal()">Enregistrer</button>
    </div>
  </div>
</div>

<!-- Catalogue edit overlay (iframe) -->
<div class="cat-edit-overlay" id="catEditOverlay" onclick="if(event.target===this)closeCatEditOverlay()">
    <div class="cat-edit-frame-wrap">
        <iframe id="catEditIframe" class="cat-edit-iframe" src="about:blank"></iframe>
    </div>
</div>

</body>
</html>
