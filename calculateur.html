<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stele — Calculateur</title>

    <script>
    // Vérifier la connexion
    if (!localStorage.getItem('sb_access_token')) {
        window.location.href = 'login.html';
    }

    const SUPABASE_URL = 'https://rplzbtjfnwahqodrhpny.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJwbHpidGpmbndhaHFvZHJocG55Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NDU2MDEsImV4cCI6MjA4NjIyMTYwMX0.OQAZhc029PbRDSe1b02NDAuOUE8yn-_h3QqSnUDpLeU';

    const STORAGE_KEY = 'stele_catalogue_data';
    const STORAGE_DATE_KEY = 'stele_catalogue_date';

    // GAS retiré — workflow interne via soumissions

    let EMPLOYEES_DATA = [];
    let CATALOGUE_DATA = [];
    let tauxHoraires = [];
    let expenseCategories = [];
    let canEditMinutes = false;
    let canEditMaterials = false;
    let mediaTagsList = ['fiche_client', 'catalogue', 'technique', 'dessin'];
    let propMedia = [];

    // ═══════════════════════════════════════════════════════════════════════
    // PROJETS — ÉTAT GLOBAL
    // ═══════════════════════════════════════════════════════════════════════

    let currentProject = null;      // objet projet courant { id, name, client_name, ... }
    let currentSubmission = null;   // objet soumission courante { id, submission_number, title, status, ... }
    let canApproveQuotes = false;   // permission can_approve_quotes
    let isApprovalMode = false;     // true when opened from approbation.html via ?submission=
    let roomMap = {};               // { groupDomId: supabaseRoomUUID }
    let itemMap = {};               // { rowDomId: supabaseItemUUID }
    let groupImages = {};        // { groupDomId: [{ name, dataUrl }] }
    let saveTimeout = null;      // pour le debounce
    const MAX_GROUP_IMAGES = 8;

    // ═══════════════════════════════════════════════════════════════════════
    // DIALOGUES CUSTOM (remplace alert/confirm/prompt natifs)
    // ═══════════════════════════════════════════════════════════════════════

    var _steleDialogResolve = null;
    function steleDialogResolve(val) {
        document.getElementById('steleDialogOverlay').classList.remove('active');
        if (_steleDialogResolve) { var fn = _steleDialogResolve; _steleDialogResolve = null; fn(val); }
    }
    function steleDialogOk() {
        var input = document.getElementById('steleDialogInput');
        var wrap = document.getElementById('steleDialogInputWrap');
        steleDialogResolve(wrap.style.display === 'none' ? true : input.value);
    }

    function steleAlert(msg, title) {
        return new Promise(function(resolve) {
            _steleDialogResolve = resolve;
            document.getElementById('steleDialogTitle').textContent = title || '';
            document.getElementById('steleDialogMessage').textContent = msg;
            document.getElementById('steleDialogInputWrap').style.display = 'none';
            document.getElementById('steleDialogCancel').style.display = 'none';
            document.getElementById('steleDialogOk').textContent = 'OK';
            document.getElementById('steleDialogOk').className = 'btn-generate';
            document.getElementById('steleDialogOverlay').classList.add('active');
        });
    }

    function steleConfirm(msg, title, okLabel, danger) {
        return new Promise(function(resolve) {
            _steleDialogResolve = resolve;
            document.getElementById('steleDialogTitle').textContent = title || 'Confirmation';
            document.getElementById('steleDialogMessage').textContent = msg;
            document.getElementById('steleDialogInputWrap').style.display = 'none';
            document.getElementById('steleDialogCancel').style.display = '';
            document.getElementById('steleDialogOk').textContent = okLabel || 'Confirmer';
            document.getElementById('steleDialogOk').className = danger ? 'btn-generate' : 'btn-generate';
            if (danger) document.getElementById('steleDialogOk').style.background = '#c0392b';
            else document.getElementById('steleDialogOk').style.background = '';
            document.getElementById('steleDialogOverlay').classList.add('active');
        });
    }

    function stelePrompt(msg, title, placeholder, required) {
        return new Promise(function(resolve) {
            _steleDialogResolve = resolve;
            document.getElementById('steleDialogTitle').textContent = title || '';
            document.getElementById('steleDialogMessage').textContent = msg;
            document.getElementById('steleDialogInputWrap').style.display = '';
            var input = document.getElementById('steleDialogInput');
            input.value = '';
            input.placeholder = placeholder || '';
            document.getElementById('steleDialogCancel').style.display = '';
            document.getElementById('steleDialogOk').textContent = 'OK';
            document.getElementById('steleDialogOk').className = 'btn-generate';
            document.getElementById('steleDialogOk').style.background = '';
            document.getElementById('steleDialogOverlay').classList.add('active');
            setTimeout(function() { input.focus(); }, 100);
        });
    }

    // ═══════════════════════════════════════════════════════════════════════

    function escapeHtml(str) {
        if (!str) return '';
        var div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    function escapeAttr(str) {
        return (str || '').replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;');
    }

    // Convert plain text (legacy) to basic HTML; if already HTML, return as-is
    function textToHtml(str) {
        if (!str) return '';
        if (str.indexOf('<p>') !== -1 || str.indexOf('<strong>') !== -1 || str.indexOf('<ul>') !== -1) {
            return str; // already HTML
        }
        // Legacy plain text: escape then convert newlines to <br>
        return escapeHtml(str).replace(/\n/g, '<br>');
    }

    function debounce(fn, delay) {
        let timer;
        return function(...args) {
            clearTimeout(timer);
            timer = setTimeout(() => fn.apply(this, args), delay);
        };
    }

    // ═══════════════════════════════════════════════════════════════════════
    // PROJETS — CRUD SUPABASE
    // ═══════════════════════════════════════════════════════════════════════

    async function loadProjects() {
        const userId = localStorage.getItem('sb_user_id');
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/projects?user_id=eq.' + userId + '&order=updated_at.desc&select=*,submissions(id,submission_number,title,status,current_version,updated_at)', {});
        if (!r.ok) return [];
        var projects = await r.json();
        projects.forEach(function(p) {
            if (p.submissions) p.submissions.sort(function(a, b) { return b.submission_number - a.submission_number; });
        });
        return projects;
    }

    async function createProject(name, clientName) {
        const userId = localStorage.getItem('sb_user_id');
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/projects', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
            body: JSON.stringify({ user_id: userId, name: name, client_name: clientName || '' })
        });
        if (!r.ok) throw new Error('Erreur création projet: ' + r.status);
        const data = await r.json();
        return data[0];
    }

    async function updateProject(projectId, fields) {
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/projects?id=eq.' + projectId, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
            body: JSON.stringify(fields)
        });
        return r.ok;
    }

    async function deleteProject(projectId) {
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/projects?id=eq.' + projectId, {
            method: 'DELETE'
        });
        return r.ok;
    }

    // ═══════════════════════════════════════════════════════════════════════
    // SOUMISSIONS — CRUD SUPABASE
    // ═══════════════════════════════════════════════════════════════════════

    async function loadSubmissions(projectId) {
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/submissions?project_id=eq.' + projectId + '&order=submission_number.desc&select=*', {});
        if (!r.ok) return [];
        return await r.json();
    }

    async function createSubmission(projectId, title) {
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/submissions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
            body: JSON.stringify({ project_id: projectId, title: title || '' })
        });
        if (!r.ok) throw new Error('Erreur cr\u00e9ation soumission: ' + r.status);
        const data = await r.json();
        return data[0];
    }

    async function updateSubmission(submissionId, fields) {
        fields.updated_at = new Date().toISOString();
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/submissions?id=eq.' + submissionId, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
            body: JSON.stringify(fields)
        });
        return r.ok;
    }

    async function deleteSubmission(submissionId) {
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/submissions?id=eq.' + submissionId, {
            method: 'DELETE'
        });
        return r.ok;
    }

    // ═══════════════════════════════════════════════════════════════════════
    // REVIEWS — CRUD SUPABASE
    // ═══════════════════════════════════════════════════════════════════════

    async function createSubmissionReview(submissionId, action, comment) {
        const userId = localStorage.getItem('sb_user_id');
        var versionAt = currentSubmission ? currentSubmission.current_version : null;
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/submission_reviews', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
            body: JSON.stringify({
                submission_id: submissionId,
                reviewer_id: userId,
                action: action,
                comment: comment || '',
                version_at_review: versionAt
            })
        });
        if (!r.ok) {
            var errText = await r.text().catch(function() { return ''; });
            console.error('createSubmissionReview failed:', r.status, errText);
            throw new Error('Erreur review: ' + r.status + ' ' + errText);
        }
        return (await r.json())[0];
    }

    // ═══════════════════════════════════════════════════════════════════════
    // TIMELINE DRAWER — HISTORIQUE SOUMISSION
    // ═══════════════════════════════════════════════════════════════════════

    var timelineReviews = [];

    async function loadSubmissionReviews(submissionId) {
        var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/submission_reviews?submission_id=eq.' + submissionId + '&order=created_at.asc&select=*', {});
        if (!r.ok) { timelineReviews = []; return; }
        timelineReviews = await r.json();
        renderTimelineDrawer();
        // Show button if there are reviews
        var btn = document.getElementById('btnTimeline');
        btn.style.display = '';
    }

    function renderTimelineDrawer() {
        var body = document.getElementById('timelineBody');
        if (timelineReviews.length === 0) {
            body.innerHTML = '<div class="timeline-empty">Aucun historique pour cette soumission.</div>';
            return;
        }

        var actionLabels = {
            'submitted': 'Soumis pour approbation',
            'approved': 'Approuv\u00e9',
            'returned': 'Retourn\u00e9',
            'sent': 'Envoy\u00e9 au client'
        };

        var html = '';
        timelineReviews.forEach(function(rev) {
            var action = rev.action || 'submitted';
            var label = actionLabels[action] || action;
            var date = rev.created_at ? new Date(rev.created_at) : null;
            var dateStr = date ? date.toLocaleDateString('fr-CA', { year: 'numeric', month: 'short', day: 'numeric' }) + ' \u00e0 ' + date.toLocaleTimeString('fr-CA', { hour: '2-digit', minute: '2-digit' }) : '';
            var version = rev.version_at_review ? 'V' + rev.version_at_review : '';

            html += '<div class="timeline-entry">';
            html += '<div class="timeline-dot timeline-dot-' + action + '"></div>';
            html += '<div class="timeline-entry-header">';
            html += '<span class="timeline-action timeline-action-' + action + '">' + label + '</span>';
            if (version) html += '<span class="timeline-version">' + version + '</span>';
            html += '</div>';
            html += '<div class="timeline-date">' + dateStr + '</div>';
            if (rev.comment) {
                html += '<div class="timeline-comment timeline-comment-' + action + '">' + escapeHtml(rev.comment) + '</div>';
            }
            html += '</div>';
        });

        body.innerHTML = html;
    }

    function openTimelineDrawer() {
        document.getElementById('timelineOverlay').classList.add('active');
        document.getElementById('timelineDrawer').classList.add('active');
    }

    function closeTimelineDrawer() {
        document.getElementById('timelineOverlay').classList.remove('active');
        document.getElementById('timelineDrawer').classList.remove('active');
    }

    // ═══════════════════════════════════════════════════════════════════════
    // PIÈCES & ARTICLES — CRUD SUPABASE
    // ═══════════════════════════════════════════════════════════════════════

    async function loadSubmissionRooms(submissionId) {
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/project_rooms?submission_id=eq.' + submissionId + '&order=sort_order&select=*,room_items(*)', {});
        if (!r.ok) return [];
        const rooms = await r.json();
        rooms.forEach(room => {
            if (room.room_items) room.room_items.sort((a, b) => a.sort_order - b.sort_order);
        });
        return rooms;
    }

    // Legacy — keep for transition
    async function loadProjectRooms(projectId) {
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/project_rooms?project_id=eq.' + projectId + '&order=sort_order&select=*,room_items(*)', {});
        if (!r.ok) return [];
        const rooms = await r.json();
        rooms.forEach(room => {
            if (room.room_items) room.room_items.sort((a, b) => a.sort_order - b.sort_order);
        });
        return rooms;
    }

    async function createRoom(submissionId, name, sortOrder) {
        var payload = { submission_id: submissionId, name: name || '', sort_order: sortOrder || 0 };
        // Also set project_id for transition period
        if (currentProject) payload.project_id = currentProject.id;
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/project_rooms', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
            body: JSON.stringify(payload)
        });
        if (!r.ok) return null;
        const data = await r.json();
        return data[0];
    }

    async function updateRoom(roomId, fields) {
        await authenticatedFetch(SUPABASE_URL + '/rest/v1/project_rooms?id=eq.' + roomId, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
            body: JSON.stringify(fields)
        });
    }

    async function deleteRoom(roomId) {
        await authenticatedFetch(SUPABASE_URL + '/rest/v1/project_rooms?id=eq.' + roomId, {
            method: 'DELETE'
        });
    }

    async function createItem(roomId, itemData) {
        const payload = Object.assign({ room_id: roomId }, itemData);
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/room_items', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
            body: JSON.stringify(payload)
        });
        if (!r.ok) return null;
        const data = await r.json();
        return data[0];
    }

    async function updateItem(itemId, fields) {
        await authenticatedFetch(SUPABASE_URL + '/rest/v1/room_items?id=eq.' + itemId, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
            body: JSON.stringify(fields)
        });
    }

    async function deleteItem(itemId) {
        await authenticatedFetch(SUPABASE_URL + '/rest/v1/room_items?id=eq.' + itemId, {
            method: 'DELETE'
        });
    }

    async function createVersion(submissionId) {
        // Trouver le prochain numéro de version (par project_id pour respecter la contrainte unique)
        var versionQuery = currentProject
            ? SUPABASE_URL + '/rest/v1/project_versions?project_id=eq.' + currentProject.id + '&order=version_number.desc&limit=1&select=version_number'
            : SUPABASE_URL + '/rest/v1/project_versions?submission_id=eq.' + submissionId + '&order=version_number.desc&limit=1&select=version_number';
        const r = await authenticatedFetch(versionQuery, {});
        let nextVersion = 1;
        if (r.ok) {
            const data = await r.json();
            if (data.length > 0) nextVersion = data[0].version_number + 1;
        }

        const snapshot = collecterDonneesCalculateur();
        const userId = localStorage.getItem('sb_user_id');

        var payload = {
            submission_id: submissionId,
            version_number: nextVersion,
            snapshot: snapshot,
            status_at_save: currentSubmission ? currentSubmission.status : 'draft',
            created_by: userId
        };
        // Also set project_id for transition period
        if (currentProject) payload.project_id = currentProject.id;

        var vr = await authenticatedFetch(SUPABASE_URL + '/rest/v1/project_versions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
            body: JSON.stringify(payload)
        });
        if (!vr.ok) {
            var errText = await vr.text().catch(function() { return ''; });
            console.error('createVersion failed:', vr.status, errText);
            throw new Error('Erreur version: ' + vr.status + ' ' + errText);
        }

        // Update current_version on submission
        await updateSubmission(submissionId, { current_version: nextVersion });
        if (currentSubmission) currentSubmission.current_version = nextVersion;
    }

    // ═══════════════════════════════════════════════════════════════════════
    // REFRESH AUTOMATIQUE DU TOKEN
    // ═══════════════════════════════════════════════════════════════════════

    async function refreshAccessToken() {
        const refreshToken = localStorage.getItem('sb_refresh_token');
        if (!refreshToken) return false;

        try {
            const response = await fetch(SUPABASE_URL + '/auth/v1/token?grant_type=refresh_token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'apikey': SUPABASE_KEY
                },
                body: JSON.stringify({ refresh_token: refreshToken })
            });

            if (!response.ok) return false;

            const data = await response.json();
            if (data.access_token) {
                localStorage.setItem('sb_access_token', data.access_token);
                localStorage.setItem('sb_refresh_token', data.refresh_token);
                return true;
            }
            return false;
        } catch (e) {
            console.warn('Échec du refresh token:', e);
            return false;
        }
    }

    async function authenticatedFetch(url, options) {
        const token = localStorage.getItem('sb_access_token');
        const headers = Object.assign({}, options.headers || {}, {
            'apikey': SUPABASE_KEY,
            'Authorization': 'Bearer ' + token
        });

        let response = await fetch(url, Object.assign({}, options, { headers: headers }));

        // Si 401 → tenter un refresh et réessayer une fois
        if (response.status === 401) {
            const refreshed = await refreshAccessToken();
            if (refreshed) {
                const newToken = localStorage.getItem('sb_access_token');
                headers['Authorization'] = 'Bearer ' + newToken;
                response = await fetch(url, Object.assign({}, options, { headers: headers }));
            } else {
                // Refresh échoué → session expirée, rediriger vers login
                localStorage.removeItem('sb_access_token');
                localStorage.removeItem('sb_refresh_token');
                window.location.href = 'login.html';
                return response;
            }
        }

        return response;
    }
    </script>

    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --stele-black: #0A0203;
            --stele-green: #4b6050;
            --stele-gray: #C8C8C8;
            --stele-light-gray: #F8F8F8;
            --stele-white: #FFFFFF;
        }

        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            font-size: 16px;
            line-height: 1.5;
            color: var(--stele-black);
            background: var(--stele-white);
        }

        /* Nav bar */
        .nav-bar {
            position: fixed;
            top: 0; left: 0; right: 0;
            background: var(--stele-white);
            border-bottom: 1px solid var(--stele-gray);
            padding: 12px 60px;
            display: flex;
            align-items: center;
            gap: 32px;
            z-index: 100;
            height: 56px;
        }

        .nav-logo {
            font-size: 20px;
            font-weight: 400;
            color: var(--stele-black);
        }

        .nav-links {
            display: flex;
            gap: 24px;
        }

        .nav-links a {
            color: var(--stele-black);
            text-decoration: none;
            font-size: 13px;
            transition: opacity 0.2s;
        }

        .nav-links a:hover { opacity: 0.6; }

        .nav-back {
            opacity: 0.4;
            border-right: 1px solid var(--stele-gray);
            padding-right: 24px;
            margin-right: 0;
        }

        .nav-back:hover { opacity: 0.7; }

        .data-status {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            font-weight: 600;
            color: #888;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #888;
        }

        .data-status.online .status-dot { background: #2ecc40; }
        .data-status.online { color: #2ecc40; }
        .data-status.offline .status-dot { background: #e67e22; }
        .data-status.offline { color: #e67e22; }
        .data-status.error .status-dot { background: #e74c3c; }
        .data-status.error { color: #e74c3c; }

        /* Main content */
        .main-content {
            margin-top: 56px;
            padding: 40px 60px 60px;
            max-width: 1200px;
        }

        .page-title {
            font-size: 32px;
            font-weight: 400;
            margin-bottom: 8px;
        }

        .page-subtitle {
            font-size: 14px;
            color: #666;
            margin-bottom: 32px;
        }

        /* ═══════════════════════════════════════════════════════════════
           CALCULATEUR STYLES
           ═══════════════════════════════════════════════════════════════ */

        .calculator-container {
            max-width: 1200px;
        }

        .calc-header {
            display: grid;
            grid-template-columns: 30px 1fr 90px 90px 110px 100px 30px 120px 30px;
            gap: 6px;
            padding: 6px 10px;
            background-color: var(--stele-black);
            color: var(--stele-white);
            font-weight: 700;
            font-size: 12px;
            border-radius: 4px 4px 0 0;
        }

        .calc-header span {
            display: flex;
            align-items: center;
        }

        .calc-header .col-center { justify-content: center; }
        .calc-header .col-right { justify-content: flex-end; }

        .calc-rows {
            border: 1px solid var(--stele-gray);
            border-top: none;
            border-radius: 0 0 4px 4px;
        }

        .calc-row {
            display: grid;
            grid-template-columns: 30px 1fr 90px 90px 110px 100px 30px 120px 30px;
            gap: 6px;
            padding: 3px 10px;
            align-items: center;
            border-bottom: 1px solid var(--stele-gray);
            background: var(--stele-white);
            transition: background-color 0.15s ease;
        }

        .calc-row:nth-child(even) { background: var(--stele-light-gray); }
        .calc-row:last-child { border-bottom: none; }
        .calc-row:hover { background: #f0f0f0; }

        .btn-add {
            width: 20px;
            height: 20px;
            border: 1.5px solid var(--stele-green);
            background: var(--stele-white);
            color: var(--stele-green);
            border-radius: 50%;
            font-size: 14px;
            font-weight: 400;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
            line-height: 1;
        }

        .btn-add:hover {
            background: var(--stele-green);
            color: var(--stele-white);
        }

        .btn-remove {
            width: 20px;
            height: 20px;
            border: none;
            background: transparent;
            color: var(--stele-gray);
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.15s ease;
            border-radius: 4px;
        }

        .btn-remove:hover {
            color: #c0392b;
            background: #fdeaea;
        }

        .item-select {
            width: 100%;
            padding: 4px 8px;
            font-size: 11px;
            font-family: inherit;
            border: 1px solid var(--stele-gray);
            border-radius: 4px;
            background: var(--stele-white);
            color: var(--stele-black);
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%230A0203' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            padding-right: 28px;
        }

        .item-select:focus {
            outline: none;
            border-color: var(--stele-green);
        }

        .cell-code, .cell-type, .cell-unit-price {
            font-size: 11px;
            color: var(--stele-black);
        }

        .cell-code {
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            font-size: 11px;
            color: #666;
            position: relative;
            cursor: help;
        }

        .cell-type { text-align: center; }
        .cell-unit-price { text-align: right; }

        /* Tooltip styles */
        .tooltip-container {
            position: relative;
            cursor: help;
        }

        .tooltip {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--stele-black);
            color: var(--stele-white);
            padding: 10px 14px;
            border-radius: 4px;
            font-size: 12px;
            line-height: 1.5;
            white-space: normal;
            width: 240px;
            text-align: left;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: opacity 0.2s ease, visibility 0.2s ease;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }

        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--stele-black);
        }

        .tooltip-container:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        .tooltip-img {
            width: 100%;
            border-radius: 3px;
            margin-bottom: 8px;
        }

        .tooltip-title { font-weight: 700; margin-bottom: 4px; font-size: 12px; }
        .tooltip-text { font-weight: 400; color: rgba(255,255,255,0.85); }

        .qty-input {
            width: 100%;
            padding: 4px 8px;
            font-size: 12px;
            font-family: inherit;
            border: 1px solid var(--stele-gray);
            border-radius: 4px;
            text-align: center;
        }

        .qty-input:focus { outline: none; border-color: var(--stele-green); }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }

        .cell-total {
            font-size: 12px;
            font-weight: 600;
            text-align: right;
            color: var(--stele-black);
        }

        .add-row-container {
            padding: 14px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid var(--stele-gray);
            background: var(--stele-white);
        }

        .add-row-text { font-size: 13px; color: #666; }

        .grand-total-container {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 20px 16px;
            background: var(--stele-black);
            border-radius: 0 0 4px 4px;
            margin-top: -1px;
        }

        .grand-total-label {
            font-size: 16px;
            font-weight: 700;
            color: var(--stele-white);
            margin-right: 24px;
        }

        .grand-total-amount {
            font-size: 24px;
            font-weight: 700;
            color: var(--stele-white);
            min-width: 140px;
            text-align: right;
        }

        /* Sections meuble */
        .furniture-group {
            margin-bottom: 24px;
            border-radius: 4px;
        }

        .btn-collapse {
            background: none;
            border: none;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            font-size: 12px;
            padding: 4px;
            transition: transform 0.2s;
            line-height: 1;
        }

        .btn-collapse:hover { color: #fff; }

        .furniture-group.collapsed .btn-collapse {
            transform: rotate(-90deg);
        }

        .furniture-group.collapsed .calc-header,
        .furniture-group.collapsed .calc-rows,
        .furniture-group.collapsed .group-images-section,
        .furniture-group.collapsed .client-description-section {
            display: none;
        }

        .furniture-group-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--stele-green);
            color: var(--stele-white);
        }

        .furniture-group-header .group-label {
            font-size: 13px;
            font-weight: 700;
            white-space: nowrap;
        }

        .furniture-name-input {
            flex: 1;
            padding: 7px 12px;
            font-size: 14px;
            font-family: inherit;
            font-weight: 600;
            border: none;
            border-radius: 4px;
            background: rgba(255,255,255,0.2);
            color: var(--stele-white);
        }

        .furniture-name-input::placeholder { color: rgba(255,255,255,0.6); }
        .furniture-name-input:focus { outline: none; background: rgba(255,255,255,0.3); }

        .install-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            white-space: nowrap;
            font-size: 12px;
            color: rgba(255,255,255,0.85);
        }
        .install-toggle input[type="checkbox"] {
            width: 14px;
            height: 14px;
            cursor: pointer;
            accent-color: var(--stele-white);
        }
        .install-label {
            font-weight: 500;
        }
        .install-toggle-project {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            white-space: nowrap;
            font-size: 12px;
            font-weight: 500;
        }
        .install-toggle-project input[type="checkbox"] {
            width: 14px;
            height: 14px;
            cursor: pointer;
            accent-color: var(--stele-green);
        }
        .install-toggle-row {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .install-toggle-row input[type="checkbox"] {
            width: 12px;
            height: 12px;
            cursor: pointer;
            accent-color: var(--stele-green);
        }

        .btn-remove-group {
            padding: 5px 12px;
            background: transparent;
            color: rgba(255,255,255,0.7);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.15s;
        }

        .btn-remove-group:hover {
            background: rgba(255,255,255,0.15);
            color: var(--stele-white);
            border-color: rgba(255,255,255,0.6);
        }

        .group-subtotal-container {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 12px 16px;
            background: #e8ece9;
            border: 1px solid var(--stele-gray);
            border-top: none;
        }

        .group-subtotal-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--stele-black);
            margin-right: 20px;
        }

        .group-subtotal-amount {
            font-size: 16px;
            font-weight: 700;
            color: var(--stele-black);
            min-width: 120px;
            text-align: right;
        }

        .group-images-section {
            padding: 12px 16px;
            background: #f8f8f8;
            border: 1px solid var(--stele-gray);
            border-top: none;
        }

        .group-images-header {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            margin-bottom: 8px;
        }

        .group-image-drop-zone {
            padding: 12px;
        }

        .group-image-drop-zone .image-drop-zone-text {
            font-size: 11px;
        }

        /* Description client par pièce */
        .client-description-section {
            padding: 6px 16px 10px; background: #fafaf8; border-top: 1px solid #eee;
        }
        .client-desc-label {
            display: block; font-size: 10px; font-weight: 600; color: #999;
            text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 3px;
        }
        .client-desc-textarea {
            width: 100%; padding: 6px 10px; border: 1px solid #e0e0e0; border-radius: 4px;
            font-family: inherit; font-size: 12px; resize: vertical; min-height: 36px;
        }
        .client-desc-textarea:focus { outline: none; border-color: var(--stele-green); }

        /* Toggle showInQuote sur images */
        .image-quote-toggle {
            position: absolute; bottom: 2px; left: 2px; display: flex; align-items: center; gap: 2px;
            background: rgba(0,0,0,0.6); color: #fff; padding: 1px 4px; border-radius: 3px;
            font-size: 9px; cursor: pointer;
        }
        .image-quote-toggle input[type="checkbox"] { width: 11px; height: 11px; margin: 0; }

        /* Exclusions */
        .exclusions-section {
            margin-top: 16px; padding: 14px 16px; background: #fafaf8;
            border: 1px solid #e0e0e0; border-radius: 4px;
        }

        .btn-add-group {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            margin-bottom: 20px;
            background: var(--stele-white);
            color: var(--stele-green);
            border: 2px dashed var(--stele-green);
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            width: 100%;
            justify-content: center;
        }

        .btn-add-group:hover { background: #eef2ef; }

        .calc-disclaimer {
            margin-top: 24px;
            padding: 16px;
            background: var(--stele-light-gray);
            border-radius: 4px;
            font-size: 13px;
            color: #666;
            font-style: italic;
        }

        .btn-pdf {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: var(--stele-green);
            color: var(--stele-white);
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            margin-top: 16px;
        }

        .btn-pdf:hover { background: #3d4f42; }
        .btn-pdf svg { width: 18px; height: 18px; }

        /* Ajout personnalis&eacute; */
        .ajout-description:focus,
        .ajout-price:focus,
        .ajout-markup:focus { outline: none; border-color: var(--stele-green); }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--stele-white);
            border-radius: 8px;
            width: 100%;
            max-width: 450px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--stele-gray);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--stele-black);
        }

        .modal-body { padding: 24px; }

        .form-group { margin-bottom: 16px; }
        .form-group:last-child { margin-bottom: 0; }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--stele-black);
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            font-size: 14px;
            font-family: inherit;
            border: 1px solid var(--stele-gray);
            border-radius: 4px;
            background: var(--stele-white);
        }

        .form-input:focus { outline: none; border-color: var(--stele-green); }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--stele-gray);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .btn-cancel {
            padding: 10px 20px;
            background: transparent;
            color: var(--stele-black);
            border: 1px solid var(--stele-gray);
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-cancel:hover { background: var(--stele-light-gray); }

        .btn-generate {
            padding: 10px 20px;
            background: var(--stele-green);
            color: var(--stele-white);
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-generate:hover { background: #3d4f42; }

        /* Modal edit (large) */
        .modal.modal-edit {
            max-width: 800px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        .modal.modal-edit .modal-body { overflow-y: auto; }
        .edit-row { display: flex; gap: 12px; }
        .edit-row .form-group { flex: 1; }

        /* Prix composé */
        .composed-price-section { display: flex; gap: 16px; margin-top: 8px; }
        .cp-table-wrap { flex: 1; min-width: 0; }
        .cp-section-title {
            font-size: 12px; font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.5px; color: var(--stele-green);
            margin-bottom: 10px; padding-bottom: 6px; border-bottom: 1px solid #f0f0f0;
        }
        .cp-sub-title { font-size: 11px; font-weight: 600; color: #555; margin-bottom: 6px; }
        .cp-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .cp-table th { text-align: left; font-weight: 600; font-size: 11px; color: #888; padding: 4px 6px; border-bottom: 1px solid #e0e0e0; }
        .cp-table th:last-child { text-align: right; }
        .cp-table td { padding: 3px 6px; }
        .cp-table td:first-child { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 140px; font-size: 11px; }
        .cp-table input[type="number"] { width: 100%; padding: 4px 6px; border: 1px solid #e0e0e0; border-radius: 3px; font-size: 12px; text-align: right; font-family: inherit; }
        .cp-table input[type="number"]:focus { outline: none; border-color: var(--stele-green); }
        .cp-table input[type="number"]:disabled { background: #f0f0f0; color: #999; cursor: not-allowed; }
        .cp-calculated {
            margin-top: 12px; padding: 10px 14px; background: #f8f8f4;
            border-radius: 6px; display: flex; justify-content: space-between;
            align-items: center; font-size: 14px;
        }
        .cp-calculated .cp-total-label { font-weight: 600; color: #555; }
        .cp-calculated .cp-total-value { font-weight: 700; font-size: 16px; color: var(--stele-green); }
        .cp-calculated .cp-breakdown { font-size: 11px; color: #888; margin-left: 8px; }

        /* Médias tagués */
        .cat-media-title {
            font-size: 12px; font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.5px; color: var(--stele-green);
            margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #f0f0f0;
        }
        .cat-dropzone {
            border: 2px dashed var(--stele-gray); border-radius: 6px; padding: 16px;
            text-align: center; cursor: pointer; transition: border-color 0.2s;
            font-size: 13px; color: #888; margin-bottom: 12px;
        }
        .cat-dropzone:hover, .cat-dropzone.dragover { border-color: var(--stele-green); color: var(--stele-green); }
        .cat-media-list { display: flex; flex-direction: column; gap: 10px; }
        .cat-media-item { display: flex; gap: 10px; padding: 10px; background: #f8f8f8; border-radius: 6px; align-items: flex-start; }
        .cat-media-item img { width: 80px; height: 60px; object-fit: cover; border-radius: 4px; border: 1px solid var(--stele-gray); flex-shrink: 0; }
        .cat-pdf-icon { width: 80px; height: 60px; background: #e8e8e8; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; color: #999; flex-shrink: 0; }
        .cat-media-info { flex: 1; min-width: 0; }
        .cat-media-tags { display: flex; flex-wrap: wrap; gap: 5px; }
        .cat-tag { display: inline-block; font-size: 11px; padding: 3px 8px; border-radius: 12px; cursor: pointer; border: 1px solid var(--stele-gray); background: #fff; color: #666; transition: all 0.15s; user-select: none; }
        .cat-tag.active { background: var(--stele-green); color: #fff; border-color: var(--stele-green); }
        .cat-media-remove { background: none; border: none; color: #c62828; cursor: pointer; font-size: 18px; padding: 0 4px; flex-shrink: 0; opacity: 0.5; transition: opacity 0.15s; }
        .cat-media-remove:hover { opacity: 1; }

        /* Toggle switch */
        .edit-toggle-row { display: flex; align-items: center; gap: 10px; }
        .edit-toggle { position: relative; display: inline-block; width: 38px; height: 22px; }
        .edit-toggle input { opacity: 0; width: 0; height: 0; }
        .edit-toggle .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #ddd; border-radius: 22px; transition: background 0.25s; }
        .edit-toggle .slider::before { content: ''; position: absolute; height: 16px; width: 16px; left: 3px; bottom: 3px; background: #fff; border-radius: 50%; transition: transform 0.25s; box-shadow: 0 1px 3px rgba(0,0,0,0.15); }
        .edit-toggle input:checked + .slider { background: var(--stele-green); }
        .edit-toggle input:checked + .slider::before { transform: translateX(16px); }
        .edit-toggle-label { font-size: 13px; color: var(--stele-black); }

        .edit-status { font-size: 13px; padding: 8px 12px; border-radius: 4px; margin-top: 8px; display: none; }
        .edit-status.success { display: block; background: #e8f5e9; color: #2e7d32; }
        .edit-status.error { display: block; background: #ffebee; color: #c62828; }

        @media (max-width: 768px) {
            .composed-price-section { flex-direction: column; }
            .modal.modal-edit { max-width: 98vw; }
        }

        /* Image zone */
        .image-drop-zone {
            border: 2px dashed #C8C8C8;
            border-radius: 6px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
            margin-top: 4px;
        }

        .image-drop-zone:hover,
        .image-drop-zone.dragover {
            border-color: var(--stele-green);
            background: #f0f7f1;
        }

        .image-drop-zone-text { font-size: 12px; color: #888; }
        .image-drop-zone-text strong { color: #555; }

        .image-previews {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .image-preview-item {
            position: relative;
            width: 90px;
            height: 90px;
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid #ddd;
        }

        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-preview-remove {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(0,0,0,0.6);
            color: #fff;
            border: none;
            cursor: pointer;
            font-size: 12px;
            line-height: 20px;
            text-align: center;
            padding: 0;
        }

        .image-preview-remove:hover { background: rgba(200,0,0,0.8); }
        .image-count { font-size: 11px; color: #888; margin-top: 4px; }

        .image-preview-item img { cursor: pointer; }

        /* Lightbox */
        .lightbox-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }

        .lightbox-overlay.active { display: flex; }

        .lightbox-overlay img {
            max-width: 90vw;
            max-height: 90vh;
            object-fit: contain;
            border-radius: 4px;
            box-shadow: 0 4px 30px rgba(0,0,0,0.4);
        }

        /* Crop Modal */
        .crop-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.88); z-index: 3000;
            justify-content: center; align-items: center; flex-direction: column;
        }
        .crop-overlay.active { display: flex; }
        .crop-box {
            background: #fff; border-radius: 8px; overflow: hidden;
            width: 90vw; max-width: 800px; max-height: 90vh; display: flex; flex-direction: column;
        }
        .crop-header {
            padding: 14px 20px; font-weight: 700; font-size: 15px;
            border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between;
        }
        .crop-container { position: relative; flex: 1; min-height: 300px; max-height: 60vh; background: #222; overflow: hidden; }
        .crop-container img { display: block; max-width: 100%; }
        .crop-controls {
            padding: 12px 20px; display: flex; gap: 10px; align-items: center;
            border-top: 1px solid #eee; justify-content: space-between;
        }
        .crop-controls .crop-ratios { display: flex; gap: 6px; }
        .crop-controls .crop-ratio-btn {
            padding: 6px 16px; border: 2px solid #ccc; border-radius: 4px;
            background: #fff; cursor: pointer; font-size: 13px; font-weight: 600;
        }
        .crop-controls .crop-ratio-btn.active { border-color: var(--stele-green); background: var(--stele-green); color: #fff; }
        .crop-controls .crop-actions { display: flex; gap: 8px; }
        .crop-controls .crop-btn {
            padding: 8px 20px; border: none; border-radius: 4px;
            cursor: pointer; font-size: 13px; font-weight: 600;
        }
        .crop-btn-cancel { background: #eee; color: #555; }
        .crop-btn-confirm { background: var(--stele-green); color: #fff; }
        .crop-btn-confirm:disabled { opacity: 0.5; cursor: not-allowed; }
        .crop-error { padding: 10px 20px; background: #fee; color: #c00; font-size: 13px; display: none; }
        .crop-loading { padding: 20px; text-align: center; color: #888; font-size: 14px; }

        /* ═══════════════════════════════════════════════════════════════
           VUE LISTE DE PROJETS
           ═══════════════════════════════════════════════════════════════ */

        .project-list-view { display: none; }
        .project-list-view.active { display: block; }
        .calculator-view { display: none; }
        .calculator-view.active { display: block; }

        /* ═══════════════════════════════════════════════════════════════
           PREVIEW VIEW (Aperçu soumission)
           ═══════════════════════════════════════════════════════════════ */
        /* Preview — split layout (document gauche, outils droite) */
        .preview-view {
            display: none; position: fixed; top: 56px; left: 0; right: 0; bottom: 0;
            z-index: 50; background: #fff;
        }
        .preview-view.active { display: flex; flex-direction: column; }

        .pv-toolbar {
            display: flex; align-items: center; gap: 16px; flex-wrap: wrap;
            padding: 10px 24px; border-bottom: 2px solid var(--stele-black);
            background: #fff; flex-shrink: 0;
        }
        .pv-toolbar button {
            background: none; border: 1px solid var(--stele-green); color: var(--stele-green);
            padding: 6px 14px; border-radius: 4px; font-size: 12px; cursor: pointer; font-weight: 500;
        }
        .pv-toolbar button:hover { background: var(--stele-green); color: #fff; }
        .pv-toolbar-title { font-size: 16px; font-weight: 600; color: var(--stele-black); }
        .pv-toolbar-sub { font-size: 13px; color: var(--stele-green); font-weight: 600; margin-left: auto; }

        /* Split panels */
        .pv-split { flex: 1; display: flex; overflow: hidden; }
        .pv-left { flex: 1; overflow-y: auto; padding: 4px 0; background: #ddd; }
        .pv-right {
            width: 360px; min-width: 360px; overflow-y: auto;
            background: #f8f8f8; border-left: 1px solid rgba(0,0,0,0.1);
        }

        .pv-content {
            display: flex; flex-direction: column; gap: 4px;
        }

        /* ── Landscape pages (11 × 8.5 in) ── */
        .pv-page {
            background: #fff; padding: 36px 48px;
            aspect-ratio: 11 / 8.5;
            overflow: hidden; position: relative;
            display: flex; flex-direction: column;
        }

        /* Title page */
        .pv-page-title { justify-content: center; align-items: center; text-align: center; }
        .pv-page-title .pv-logo { height: 64px; margin-bottom: 32px; }
        .pv-page-title .pv-sub-number { font-size: 24px; font-weight: 700; color: var(--stele-green); margin-bottom: 6px; }
        .pv-page-title .pv-sub-date { font-size: 14px; color: #888; margin-bottom: 32px; }
        .pv-page-title .pv-client-name { font-size: 32px; font-weight: 300; color: var(--stele-black); margin-bottom: 6px; }
        .pv-page-title .pv-project-name { font-size: 18px; color: #666; }
        .pv-page-title .pv-designer { font-size: 14px; color: #999; margin-top: 4px; }
        .pv-page-title .pv-client-address { font-size: 14px; color: #999; margin-top: 2px; }

        /* Room page — landscape layout */
        .pv-page-room-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 20px; background: var(--stele-green); color: #fff;
            border-radius: 4px; margin-bottom: 14px; flex-shrink: 0;
        }
        .pv-page-room-name { font-size: 17px; font-weight: 600; letter-spacing: 0.3px; }
        .pv-page-room-subtotal { font-size: 17px; font-weight: 700; }
        .pv-page-room-body { flex: 1; display: flex; gap: 24px; overflow: hidden; min-height: 0; }
        .pv-page-room-text { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .pv-page-room-media {
            flex: 1; display: grid; grid-template-columns: repeat(2, 1fr);
            gap: 8px; align-content: start;
        }
        .pv-page-room-media.cols-1 { grid-template-columns: 1fr; }
        .pv-page-room-media .pv-img-wrap { border-radius: 4px; overflow: hidden; }
        .pv-page-room-media .pv-img-wrap img {
            width: 100%; aspect-ratio: 4/3; object-fit: cover; display: block;
            border: 1px solid rgba(0,0,0,0.08); cursor: pointer;
        }
        .pv-page-room-desc {
            width: 100%; border: 1px dashed #ccc; border-radius: 4px;
            padding: 10px 12px; font-size: 13px; line-height: 1.5; color: #444;
            font-family: inherit; flex: 1; min-height: 60px;
            background: #fafafa; transition: border-color 0.2s;
            overflow-y: auto; white-space: normal; word-wrap: break-word;
        }
        .pv-page-room-desc:focus { outline: none; border-color: var(--stele-green); background: #fff; }
        .pv-page-room-desc[contenteditable="false"] { background: transparent; border-color: transparent; cursor: default; }
        .pv-page-room-desc:empty::before { content: attr(data-placeholder); color: #aaa; font-style: italic; }
        .pv-page-room-desc p { margin: 0 0 6px 0; }
        .pv-page-room-desc ul { margin: 4px 0 8px 0; padding-left: 20px; }
        .pv-page-room-desc li { margin-bottom: 2px; }
        .pv-page-room-desc strong { font-weight: 700; }

        /* Clauses page — compact */
        .pv-page-clauses-header {
            font-size: 12px; text-transform: uppercase; letter-spacing: 1px;
            color: var(--stele-green); font-weight: 700; margin-bottom: 14px;
            padding-bottom: 6px; border-bottom: 2px solid var(--stele-green);
        }
        .pv-page-clauses-body { flex: 1; overflow: hidden; }
        .pv-page-clause {
            margin-bottom: 8px; padding: 6px 14px;
            border-left: 3px solid var(--stele-green); background: #fafafa;
            border-radius: 0 3px 3px 0;
        }
        .pv-page-clause-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 2px; }
        .pv-page-clause-text {
            width: 100%; border: 1px dashed transparent; border-radius: 3px;
            padding: 2px 4px; font-size: 12px; line-height: 1.3; color: #555;
            font-family: inherit; resize: none; background: transparent;
        }
        .pv-page-clause-text:focus { outline: none; border-color: var(--stele-green); background: #fff; }
        .pv-page-clause-text:disabled { border-color: transparent; background: transparent; }
        .pv-page-clause-actions { display: flex; gap: 6px; margin-top: 2px; justify-content: flex-end; }

        /* Total page */
        .pv-page-total { justify-content: center; align-items: center; text-align: center; }
        .pv-total-box {
            padding: 36px 56px; background: var(--stele-black); color: #fff; border-radius: 6px;
        }
        .pv-total-box .total-label { font-size: 16px; font-weight: 300; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 10px; opacity: 0.8; }
        .pv-total-box .total-amount { font-size: 42px; font-weight: 700; }
        .pv-total-box .total-taxes { font-size: 13px; opacity: 0.6; margin-top: 6px; }
        .pv-page-footer-text { margin-top: 32px; font-size: 12px; color: #aaa; letter-spacing: 0.5px; }

        /* Tools panel */
        .pv-tools-header {
            padding: 14px 20px; font-size: 13px; font-weight: 700;
            text-transform: uppercase; letter-spacing: 1px; color: var(--stele-black);
            border-bottom: 1px solid rgba(0,0,0,0.08); background: #f0f0f0;
            position: sticky; top: 0; z-index: 1;
        }
        .pv-tools-section { padding: 16px 20px; border-bottom: 1px solid rgba(0,0,0,0.06); }
        .pv-tools-section h5 {
            font-size: 11px; text-transform: uppercase; letter-spacing: 0.6px;
            color: var(--stele-green); margin-bottom: 10px; font-weight: 600;
        }
        .pv-tools-placeholder { font-size: 13px; color: #888; line-height: 1.4; font-style: italic; }

        .pv-clause-list { display: flex; flex-direction: column; gap: 6px; }
        .pv-clause-item {
            padding: 10px 12px; background: #fff; border: 1px solid rgba(0,0,0,0.08);
            border-radius: 4px; font-size: 13px; color: #333; cursor: grab;
            transition: box-shadow 0.15s, border-color 0.15s;
        }
        .pv-clause-item:hover { border-color: var(--stele-green); box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .pv-clause-item .clause-title { font-weight: 600; margin-bottom: 2px; }
        .pv-clause-item .clause-preview {
            font-size: 12px; color: #888; overflow: hidden;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
        }

        /* Image wrap (used in room pages) */
        .pv-img-wrap { position: relative; border-radius: 4px; overflow: hidden; }
        .pv-img-delete {
            position: absolute; top: 6px; right: 6px; width: 24px; height: 24px;
            border-radius: 50%; background: rgba(0,0,0,0.6); color: #fff;
            border: none; cursor: pointer; font-size: 14px; line-height: 24px;
            text-align: center; padding: 0; transition: background 0.15s;
            display: none;
        }
        .pv-img-wrap:hover .pv-img-delete { display: block; }
        .pv-img-delete:hover { background: rgba(200,0,0,0.85); }
        .pv-img-badge-client {
            position: absolute; bottom: 6px; left: 6px;
            background: rgba(75,96,80,0.85); color: #fff; font-size: 8px;
            padding: 2px 5px; border-radius: 3px; font-weight: 600;
            letter-spacing: 0.3px; text-transform: uppercase;
        }

        /* Client / presentation mode — hide edit UI */
        .pv-toolbar .btn-client-view {
            background: none; border: 1px solid #333; color: #333;
            padding: 6px 14px; border-radius: 4px; font-size: 12px;
            cursor: pointer; font-weight: 500; margin-left: 8px;
        }
        .pv-toolbar .btn-client-view:hover { background: #333; color: #fff; }
        .pv-toolbar .btn-client-view.active { background: #333; color: #fff; }
        .pv-optimize-btn {
            position: absolute; top: 6px; right: 6px; z-index: 2;
            background: var(--stele-green); color: #fff; border: none; border-radius: 4px;
            padding: 3px 10px; font-size: 11px; cursor: pointer; font-weight: 500; opacity: 0.8;
        }
        .pv-optimize-btn:hover { opacity: 1; }
        .pv-client-mode .pv-optimize-btn { display: none !important; }
        .pv-client-mode .pv-right { display: none; }
        .pv-client-mode .pv-page-room-desc { border-color: transparent; background: transparent; padding: 0; }
        .pv-client-mode .pv-page-clause-text { border-color: transparent; background: transparent; padding: 0; }
        .pv-client-mode .pv-page-clause-actions,
        .pv-client-mode .pv-clause-dropzone,
        .pv-client-mode .pv-img-delete { display: none !important; }

        /* Clause action buttons (in document) */
        .pv-doc-clause-btn {
            background: none; border: none; font-size: 10px; cursor: pointer;
            font-family: inherit; padding: 2px 5px; border-radius: 3px; transition: all 0.15s;
        }
        .pv-doc-clause-btn.remove { color: #c62828; }
        .pv-doc-clause-btn.remove:hover { background: #ffebee; }
        .pv-doc-clause-btn.save-lib { color: var(--stele-green); }
        .pv-doc-clause-btn.save-lib:hover { background: #e8f5e9; }

        /* Drop zone for clauses */
        .pv-clause-dropzone {
            padding: 10px; border: 2px dashed #ccc; border-radius: 4px;
            text-align: center; color: #aaa; font-size: 12px; font-style: italic;
            transition: all 0.2s; margin-top: 6px;
        }
        .pv-clause-dropzone.drag-over {
            border-color: var(--stele-green); background: #f0f7f1; color: var(--stele-green);
        }

        /* Fullscreen presentation mode */
        .pv-fullscreen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 9999; }
        .pv-fullscreen .pv-toolbar { display: none; }
        .pv-fullscreen .pv-right { display: none; }
        .pv-fullscreen .pv-left { padding: 4px 0; background: #ddd; }
        .pv-fullscreen .pv-page-room-desc { border-color: transparent; background: transparent; padding: 0; }
        .pv-fullscreen .pv-page-clause-text { border-color: transparent; background: transparent; padding: 0; }
        .pv-fullscreen .pv-page-clause-actions,
        .pv-fullscreen .pv-clause-dropzone,
        .pv-fullscreen .pv-img-delete,
        .pv-fullscreen .pv-img-badge-client { display: none !important; }

        /* Tools panel — clause library items */
        .pv-lib-actions { display: flex; gap: 6px; margin-bottom: 10px; }
        .pv-btn-add-clause {
            background: var(--stele-green); color: #fff; border: none;
            padding: 6px 12px; border-radius: 4px; font-size: 11px;
            cursor: pointer; font-family: inherit; font-weight: 500;
        }
        .pv-btn-add-clause:hover { background: #3d5043; }
        .pv-clause-item {
            padding: 10px 12px; background: #fff; border: 1px solid rgba(0,0,0,0.08);
            border-radius: 4px; font-size: 13px; color: #333; cursor: grab;
            transition: box-shadow 0.15s, border-color 0.15s; margin-bottom: 6px;
        }
        .pv-clause-item:hover { border-color: var(--stele-green); box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .pv-clause-item.dragging { opacity: 0.5; }
        .pv-clause-item-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px;
        }
        .pv-clause-item-title { font-weight: 600; font-size: 12px; }
        .pv-clause-item-btns { display: flex; gap: 4px; }
        .pv-clause-item-btn {
            background: none; border: none; font-size: 11px; cursor: pointer;
            color: #888; padding: 1px 4px; border-radius: 2px;
        }
        .pv-clause-item-btn:hover { color: var(--stele-black); background: rgba(0,0,0,0.05); }
        .pv-clause-item-btn.delete:hover { color: #c62828; background: #ffebee; }
        .pv-clause-item-preview {
            font-size: 11px; color: #999; overflow: hidden;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
            line-height: 1.3;
        }
        .pv-clause-empty { font-size: 12px; color: #aaa; font-style: italic; padding: 8px 0; }

        /* Clause edit modal (inline in tools panel) */
        .pv-clause-edit {
            padding: 12px; background: #fff; border: 2px solid var(--stele-green);
            border-radius: 6px; margin-bottom: 10px;
        }
        .pv-clause-edit label { font-size: 11px; font-weight: 600; color: #666; display: block; margin-bottom: 3px; }
        .pv-clause-edit input, .pv-clause-edit textarea {
            width: 100%; border: 1px solid #ddd; border-radius: 4px;
            padding: 6px 8px; font-size: 12px; font-family: inherit; margin-bottom: 8px;
        }
        .pv-clause-edit input:focus, .pv-clause-edit textarea:focus { outline: none; border-color: var(--stele-green); }
        .pv-clause-edit textarea { resize: vertical; min-height: 60px; line-height: 1.35; }
        .pv-clause-edit-btns { display: flex; gap: 6px; justify-content: flex-end; }
        .pv-clause-edit-btns button {
            padding: 5px 12px; border-radius: 4px; font-size: 11px;
            cursor: pointer; font-family: inherit; border: none;
        }
        .pv-clause-edit-btns .save { background: var(--stele-green); color: #fff; }
        .pv-clause-edit-btns .save:hover { background: #3d5043; }
        .pv-clause-edit-btns .cancel { background: #eee; color: #666; }
        .pv-clause-edit-btns .cancel:hover { background: #ddd; }

        /* Responsive — tools panel collapses on small screens */
        @media (max-width: 1100px) {
            .pv-right { width: 300px; min-width: 300px; }
        }
        @media (max-width: 900px) {
            .pv-split { flex-direction: column; }
            .pv-left { padding: 2px 0; }
            .pv-right { width: 100%; min-width: 100%; max-height: 240px; border-left: none; border-top: 1px solid rgba(0,0,0,0.1); }
            .pv-page-room-body { flex-direction: column; }
            .pv-page-room-media { grid-template-columns: 1fr 1fr; }
        }

        .btn-preview {
            background: none; border: 1px solid #6a5acd; color: #6a5acd;
            padding: 3px 10px; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: 500;
        }
        .btn-preview:hover { background: #6a5acd; color: #fff; }

        .project-list-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 24px; flex-wrap: wrap; gap: 12px;
        }
        .project-list-title { font-size: 28px; font-weight: 400; }

        .btn-new-project {
            background: var(--stele-green); color: #fff; border: none;
            padding: 10px 20px; font-size: 14px; cursor: pointer;
            border-radius: 6px; font-family: inherit; transition: background 0.15s;
        }
        .btn-new-project:hover { background: #3d4f41; }

        .project-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }

        .project-card {
            background: #fff; border: 1px solid #e0e0e0; border-radius: 8px;
            padding: 20px; cursor: pointer; transition: all 0.2s; position: relative;
        }
        .project-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.1); transform: translateY(-2px); }

        .project-card-name { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
        .project-card-client { font-size: 13px; color: #666; margin-bottom: 10px; }
        .project-card-meta { display: flex; align-items: center; justify-content: space-between; gap: 8px; }
        .project-card-date { font-size: 11px; color: #999; }

        .project-status-badge {
            display: inline-block; padding: 2px 10px; border-radius: 12px;
            font-size: 11px; font-weight: 600; text-transform: capitalize;
        }
        /* Nouveau workflow */
        .status-draft { background: #f0f0f0; color: #666; }
        .status-pending_internal { background: #e3f2fd; color: #1565c0; }
        .status-returned { background: #fff3e0; color: #e65100; }
        .status-approved_internal { background: #e8f5e9; color: #2e7d32; }
        .status-sent_client { background: #ede7f6; color: #4527a0; }
        .status-accepted { background: #e8f5e9; color: #1b5e20; }
        .status-invoiced { background: #fce4ec; color: #880e4f; }
        /* Legacy */
        .status-brouillon { background: #f0f0f0; color: #666; }
        .status-soumis { background: #e3f2fd; color: #1565c0; }
        .status-approuvé { background: #e8f5e9; color: #2e7d32; }
        .status-envoyé { background: #fff3e0; color: #e65100; }
        .status-signé { background: #e8f5e9; color: #1b5e20; }

        /* Soumissions dans la carte projet */
        .project-subs { margin: 10px 0 8px; }
        .sub-line {
            display: flex; align-items: center; gap: 8px; padding: 6px 10px;
            border-radius: 6px; cursor: pointer; transition: background 0.15s;
        }
        .sub-line:hover { background: #f5f5f5; }
        .sub-number { font-size: 12px; font-weight: 700; color: var(--stele-green); min-width: 40px; }
        .sub-title { font-size: 13px; color: #333; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .sub-empty { font-size: 12px; color: #aaa; padding: 8px 10px; font-style: italic; }
        .btn-add-sub {
            display: block; width: 100%; padding: 6px 0; margin-top: 4px;
            background: none; border: 1px dashed #ccc; border-radius: 6px;
            color: #888; font-size: 12px; cursor: pointer; transition: all 0.15s;
        }
        .btn-add-sub:hover { border-color: var(--stele-green); color: var(--stele-green); background: #f9faf9; }

        /* Panneau soumissions dans le calculateur */
        .header-sub-panel {
            display: none; background: #fff; border: 1px solid #e0e0e0; border-radius: 8px;
            padding: 10px 14px; margin: -8px 0 16px;
        }
        .header-sub-panel .sub-line.active { background: #eef3ef; }
        .header-sub-panel .sub-line.active .sub-number { color: var(--stele-black); }
        .header-sub-panel .header-sub-label {
            font-size: 11px; font-weight: 600; color: #888; text-transform: uppercase;
            letter-spacing: 0.5px; margin-bottom: 6px;
        }

        /* Workflow action buttons */
        .workflow-actions { display: flex; gap: 6px; align-items: flex-end; }
        .btn-wf {
            display: none; padding: 6px 14px; font-size: 12px; font-weight: 600;
            border: none; border-radius: 6px; cursor: pointer; white-space: nowrap;
            transition: opacity 0.15s;
        }
        .btn-wf:hover { opacity: 0.85; }
        .btn-wf-submit { background: #1565c0; color: #fff; }
        .btn-wf-approve { background: #2e7d32; color: #fff; }
        .btn-wf-return { background: #e65100; color: #fff; }
        .btn-wf-send-client { background: #4527a0; color: #fff; }
        .status-badge {
            display: inline-block; padding: 5px 12px; font-size: 11px; font-weight: 700;
            border-radius: 12px; text-transform: uppercase; letter-spacing: 0.3px;
        }
        .status-draft { background: #f0f0f0; color: #666; }
        .status-pending_internal { background: #fff3e0; color: #e65100; }
        .status-returned { background: #fce4ec; color: #c62828; }
        .status-approved_internal { background: #e8f5e9; color: #2e7d32; }
        .status-sent_client { background: #e3f2fd; color: #1565c0; }
        .status-accepted { background: #e8f5e9; color: #1b5e20; }
        .status-invoiced { background: #ede7f6; color: #4527a0; }

        .project-card-delete {
            position: absolute; top: 8px; right: 8px; background: none; border: none;
            color: #ccc; cursor: pointer; font-size: 18px; padding: 4px 8px;
            border-radius: 4px; transition: all 0.15s; line-height: 1;
        }
        .project-card-delete:hover { color: #c62828; background: #ffebee; }

        .project-empty {
            text-align: center; padding: 60px 20px; color: #999; font-size: 15px;
        }

        /* Formulaire nouveau projet (inline) */
        .new-project-form {
            display: none; background: #f8f8f8; border: 1px solid #e0e0e0;
            border-radius: 8px; padding: 20px; margin-bottom: 20px;
        }
        .new-project-form.active { display: block; }
        .new-project-form .form-row {
            display: flex; gap: 12px; margin-bottom: 12px; flex-wrap: wrap;
        }
        .new-project-form input {
            flex: 1; min-width: 200px; padding: 10px 14px; font-size: 14px;
            border: 1px solid #ccc; border-radius: 6px; font-family: inherit;
        }
        .new-project-form input:focus { outline: none; border-color: var(--stele-green); }
        .new-project-form-actions { display: flex; gap: 8px; }
        .btn-create-project {
            background: var(--stele-green); color: #fff; border: none;
            padding: 10px 20px; font-size: 14px; cursor: pointer;
            border-radius: 6px; font-family: inherit;
        }
        .btn-create-project:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-cancel-project {
            background: #fff; color: #666; border: 1px solid #ccc;
            padding: 10px 20px; font-size: 14px; cursor: pointer;
            border-radius: 6px; font-family: inherit;
        }

        /* ═══════════════════════════════════════════════════════════════
           HEADER PROJET (dans le calculateur)
           ═══════════════════════════════════════════════════════════════ */

        .project-header {
            background: #fff; border: 1px solid #e0e0e0; border-radius: 8px;
            padding: 16px 20px; margin-bottom: 24px; position: relative;
            display: flex; align-items: center; gap: 16px; flex-wrap: wrap;
        }
        .btn-back-projects {
            background: none; border: none; color: var(--stele-green);
            cursor: pointer; font-size: 14px; font-family: inherit;
            padding: 6px 0; white-space: nowrap;
        }
        .btn-back-projects:hover { text-decoration: underline; }

        .project-header-fields {
            display: flex; align-items: center; gap: 12px; flex: 1; flex-wrap: wrap;
        }
        .project-header-field {
            display: flex; flex-direction: column; gap: 2px;
        }
        .project-header-field label {
            font-size: 10px; text-transform: uppercase; color: #999; letter-spacing: 0.5px;
        }
        .project-header-field input,
        .project-header-field select {
            border: 1px solid transparent; border-radius: 4px; padding: 4px 8px;
            font-size: 14px; font-family: inherit; background: transparent;
            transition: border-color 0.15s;
        }
        .project-header-field input:hover,
        .project-header-field select:hover { border-color: #e0e0e0; }
        .project-header-field input:focus,
        .project-header-field select:focus { outline: none; border-color: var(--stele-green); background: #fff; }

        .project-header-field input.field-name { font-weight: 600; font-size: 16px; min-width: 200px; }
        .project-header-field input.field-client { min-width: 150px; }
        .project-header-field input.field-code { width: 130px; }

        .save-indicator {
            font-size: 11px; color: #999; white-space: nowrap;
            position: absolute; top: 8px; right: 12px;
        }
        .save-indicator.saving { color: var(--stele-green); }

        /* Modal Rentabilité */
        .rentab-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 9000; justify-content: center; align-items: flex-start; padding: 40px 20px;
        }
        .rentab-overlay.active { display: flex; }
        .rentab-modal {
            background: #fff; border-radius: 8px; max-width: 1100px; width: 100%;
            max-height: 90vh; overflow-y: auto; box-shadow: 0 8px 40px rgba(0,0,0,0.3);
        }
        .rentab-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 24px; border-bottom: 2px solid var(--stele-green); background: #fafafa;
            border-radius: 8px 8px 0 0;
        }
        .rentab-header h2 { font-size: 16px; font-weight: 700; color: var(--stele-black); margin: 0; }
        .rentab-close { background: none; border: none; font-size: 22px; cursor: pointer; color: #666; padding: 0 4px; }
        .rentab-close:hover { color: var(--stele-black); }
        .rentab-body { padding: 20px 24px; display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .rentab-section { margin-bottom: 16px; }
        .rentab-section-title {
            font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
            color: var(--stele-green); margin-bottom: 8px; padding-bottom: 4px; border-bottom: 1px solid #e0e0e0;
        }
        .rentab-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .rentab-table td { padding: 3px 8px; }
        .rentab-table td:first-child { color: #555; font-weight: 500; }
        .rentab-table td:last-child { text-align: right; font-weight: 600; font-family: 'SF Mono', monospace; }
        .rentab-table tr.highlight td { background: #f0f5f1; font-weight: 700; color: var(--stele-black); }
        .rentab-table tr.total td { border-top: 2px solid var(--stele-black); font-weight: 700; font-size: 13px; padding-top: 6px; }
        .rentab-table tr.spacer td { padding: 6px 0; }
        .rentab-dept-table { width: 100%; border-collapse: collapse; font-size: 11px; }
        .rentab-dept-table th {
            background: var(--stele-black); color: #fff; padding: 4px 6px;
            font-weight: 600; font-size: 10px; text-align: center;
        }
        .rentab-dept-table td { padding: 3px 6px; text-align: right; border-bottom: 1px solid #eee; font-family: 'SF Mono', monospace; }
        .rentab-dept-table td:first-child { text-align: left; font-family: inherit; color: #555; }
        .rentab-dept-table tr:last-child td { font-weight: 700; background: #f5f5f5; }
        .rentab-margins {
            margin-top: 16px; border: 1px solid #ddd; border-radius: 4px; overflow: hidden;
        }
        .rentab-margins-row {
            display: grid; grid-template-columns: 1fr 80px 120px; padding: 6px 12px;
            font-size: 12px; border-bottom: 1px solid #eee; align-items: center;
        }
        .rentab-margins-row:last-child { border-bottom: none; }
        .rentab-margins-row.profit-row { background: #f0f5f1; font-weight: 700; font-size: 13px; }
        .rentab-margins-row span:nth-child(2) { text-align: center; }
        .rentab-margins-row span:last-child { text-align: right; font-family: 'SF Mono', monospace; font-weight: 600; }
        .rentab-full { grid-column: 1 / -1; }
        .btn-rentab {
            background: none; border: 1px solid rgba(255,255,255,0.4); color: rgba(255,255,255,0.85);
            padding: 2px 8px; border-radius: 3px; font-size: 11px; cursor: pointer; white-space: nowrap;
        }
        .btn-rentab:hover { background: rgba(255,255,255,0.15); border-color: rgba(255,255,255,0.7); }
        .btn-rentab-project {
            background: none; border: 1px solid var(--stele-green); color: var(--stele-green);
            padding: 3px 10px; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: 500;
        }
        .btn-rentab-project:hover { background: var(--stele-green); color: #fff; }

        /* Print */
        @media print {
            .nav-bar { display: none; }
            .btn-add, .btn-remove, .add-row-container, .group-images-section { display: none !important; }
            .item-select { border: none; background: none; padding: 0; appearance: none; background-image: none; }
            .qty-input, .ajout-description, .ajout-price, .ajout-markup { border: none; background: none; }
            .calculator-container { page-break-inside: avoid; }
        }

        /* Responsive */
        @media (max-width: 900px) {
            .nav-bar { padding: 12px 20px; gap: 16px; }
            .main-content { padding: 24px 16px; }
            .calc-header, .calc-row {
                grid-template-columns: 24px 1fr 70px 70px 90px 80px 24px 100px 24px;
                gap: 4px;
                padding: 3px 8px;
                font-size: 10px;
            }
            .btn-add, .btn-remove, .btn-add-group { font-size: 12px; }
            .ajout-description, .ajout-price, .ajout-markup { font-size: 11px !important; }
            .calculator-container { font-size: 13px; }
        }

        /* ═══════════════════════════════════════════════════════════════
           TIMELINE DRAWER (historique soumission)
           ═══════════════════════════════════════════════════════════════ */
        .timeline-drawer-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.3); z-index: 8500;
        }
        .timeline-drawer-overlay.active { display: block; }
        .timeline-drawer {
            position: fixed; top: 0; right: -420px; width: 400px; height: 100%;
            background: #fff; box-shadow: -4px 0 20px rgba(0,0,0,0.15);
            z-index: 8600; transition: right 0.3s ease; overflow-y: auto;
        }
        .timeline-drawer.active { right: 0; }
        .timeline-drawer-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 20px; border-bottom: 2px solid var(--stele-green);
            background: #fafafa; position: sticky; top: 0; z-index: 1;
        }
        .timeline-drawer-header h3 { font-size: 15px; font-weight: 700; margin: 0; color: var(--stele-black); }
        .timeline-drawer-close {
            background: none; border: none; font-size: 20px; cursor: pointer; color: #666; padding: 0 4px;
        }
        .timeline-drawer-close:hover { color: var(--stele-black); }
        .timeline-drawer-body { padding: 20px; }
        .timeline-empty { text-align: center; color: #999; font-size: 13px; padding: 40px 0; font-style: italic; }

        .timeline-entry { position: relative; padding-left: 28px; margin-bottom: 20px; }
        .timeline-entry::before {
            content: ''; position: absolute; left: 8px; top: 24px; bottom: -20px;
            width: 2px; background: #e0e0e0;
        }
        .timeline-entry:last-child::before { display: none; }
        .timeline-dot {
            position: absolute; left: 2px; top: 6px; width: 14px; height: 14px;
            border-radius: 50%; border: 2px solid #fff;
        }
        .timeline-dot-submitted { background: #1565c0; }
        .timeline-dot-approved { background: #2e7d32; }
        .timeline-dot-returned { background: #e65100; }
        .timeline-dot-sent { background: #4527a0; }
        .timeline-entry-header {
            display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 4px;
        }
        .timeline-action {
            font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px;
        }
        .timeline-action-submitted { color: #1565c0; }
        .timeline-action-approved { color: #2e7d32; }
        .timeline-action-returned { color: #e65100; }
        .timeline-action-sent { color: #4527a0; }
        .timeline-date { font-size: 11px; color: #999; }
        .timeline-reviewer { font-size: 12px; color: #666; margin-bottom: 4px; }
        .timeline-comment {
            font-size: 13px; color: #444; background: #f8f8f8;
            border-radius: 6px; padding: 8px 12px; border-left: 3px solid #e0e0e0;
        }
        .timeline-comment-submitted { border-left-color: #1565c0; }
        .timeline-comment-approved { border-left-color: #2e7d32; }
        .timeline-comment-returned { border-left-color: #e65100; }
        .timeline-comment-sent { border-left-color: #4527a0; }
        .timeline-version { font-size: 10px; color: #aaa; margin-top: 4px; }

        .btn-timeline {
            background: none; border: 1px solid #ddd; border-radius: 6px;
            padding: 6px 12px; font-size: 12px; cursor: pointer;
            color: #666; font-family: inherit; white-space: nowrap; transition: all 0.15s;
        }
        .btn-timeline:hover { border-color: var(--stele-green); color: var(--stele-green); background: #f9faf9; }

        @media (max-width: 600px) {
            .timeline-drawer { width: 100%; right: -100%; }
        }
    </style>
</head>
<body>

    <!-- Nav bar -->
    <nav class="nav-bar">
        <span class="nav-logo">stele</span>
        <div class="nav-links">
            <a href="app.html" class="nav-back">&larr; Menu</a>
        </div>
        <div class="data-status" id="dataStatus">
            <span class="status-dot"></span>
            <span class="status-text" id="statusText">Chargement...</span>
        </div>
    </nav>

    <!-- Contenu principal -->
    <div class="main-content">

        <!-- ═══════ VUE 1 : LISTE DES PROJETS ═══════ -->
        <div class="project-list-view active" id="projectListView">
            <div class="project-list-header">
                <h1 class="project-list-title">Mes projets</h1>
                <button class="btn-new-project" onclick="showNewProjectForm()">+ Nouveau projet</button>
            </div>

            <div class="new-project-form" id="newProjectForm">
                <div class="form-row">
                    <input type="text" id="newProjectName" placeholder="Nom du projet (ex: R&eacute;sidence Tremblay)" onkeydown="if(event.key==='Enter')handleCreateProject()">
                </div>
                <div class="new-project-form-actions">
                    <button class="btn-create-project" id="btnCreateProject" onclick="handleCreateProject()">Cr&eacute;er</button>
                    <button class="btn-cancel-project" onclick="hideNewProjectForm()">Annuler</button>
                </div>
            </div>

            <div id="projectGrid" class="project-grid">
                <!-- Rempli dynamiquement -->
            </div>
            <div class="project-empty" id="projectEmpty" style="display:none;">
                Aucun projet pour le moment.<br>Cliquez sur &laquo; + Nouveau projet &raquo; pour commencer.
            </div>
        </div>

        <!-- ═══════ VUE 2 : CALCULATEUR ═══════ -->
        <div class="calculator-view" id="calculatorView">

            <div class="project-header" id="projectHeader">
                <button class="btn-back-projects" id="btnBackProjects" onclick="backToProjectList()">&larr; Projets</button>
                <div class="project-header-fields">
                    <div class="project-header-field">
                        <label>Projet</label>
                        <input type="text" class="field-name" id="projName" placeholder="Nom du projet" onblur="saveProjectField()">
                    </div>
                    <div class="project-header-field">
                        <label>Soumission <span id="subNumber" style="font-weight:700; color:var(--stele-green);"></span></label>
                        <input type="text" class="field-name" id="subTitle" placeholder="Titre de la soumission" onblur="saveSubmissionField()">
                    </div>
                    <div class="project-header-field workflow-actions" id="workflowActions">
                        <span class="status-badge" id="subStatusBadge"></span>
                        <button class="btn-wf btn-wf-submit" id="btnWfSubmit" onclick="openSubmitModal()">Soumettre</button>
                        <button class="btn-wf btn-wf-approve" id="btnWfApprove" onclick="approveSubmission()">Approuver</button>
                        <button class="btn-wf btn-wf-return" id="btnWfReturn" onclick="returnSubmission()">Retourner</button>
                        <button class="btn-wf btn-wf-send-client" id="btnWfSendClient" onclick="sendToClient()">Envoyer au client</button>
                    </div>
                    <div class="project-header-field">
                        <label class="install-toggle-project">
                            <input type="checkbox" id="projInstallation" checked onchange="toggleProjectInstallation()">
                            <span>Installation (tout)</span>
                        </label>
                    </div>
                </div>
                <button class="btn-timeline" id="btnTimeline" onclick="openTimelineDrawer()" style="display:none;">Historique</button>
                <button class="btn-preview" id="btnPreview" onclick="openPreview()">Aper&ccedil;u</button>
                <button class="btn-rentab-project" onclick="openRentab('project')">Rentabilit&eacute;</button>
                <span class="save-indicator" id="saveIndicator"></span>
            </div>

            <div class="header-sub-panel" id="headerSubPanel">
                <div class="header-sub-label">Soumissions du projet</div>
                <div id="headerSubList"></div>
                <button class="btn-add-sub" id="btnAddSubHeader" onclick="handleAddSubmissionFromCalc()">+ Nouvelle soumission</button>
            </div>

            <h1 class="page-title">Calculateur</h1>
            <p class="page-subtitle">Calculez des estimations budg&eacute;taires &agrave; partir du catalogue de prix.</p>

            <div class="calculator-container">
            <div id="furnitureGroups">
                <!-- Le premier meuble est cr&eacute;&eacute; par JS au chargement -->
            </div>

            <button class="btn-add-group" onclick="addFurnitureGroup()">+ Ajouter un meuble</button>

            <div class="grand-total-container">
                <span class="grand-total-label">Total estim&eacute;</span>
                <span class="grand-total-amount" id="grandTotal">0,00 $</span>
            </div>


            <button class="btn-pdf" id="btnOpenSubmit" onclick="openSubmitModal()">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Soumettre pour approbation
            </button>
        </div>

        </div><!-- fin calculator-view -->

        <!-- ═══════ PREVIEW VIEW (split layout) ═══════ -->
        <div class="preview-view" id="previewView">
            <div class="pv-toolbar">
                <button onclick="closePreview()">&larr; Retour au calculateur</button>
                <span class="pv-toolbar-title">Aper&ccedil;u soumission</span>
                <span class="pv-toolbar-sub" id="pvSubNumber"></span>
                <button class="btn-client-view" id="btnClientView" onclick="toggleClientView()">Vue client</button>
                <button class="btn-client-view" id="btnPresentation" onclick="openPresentation()" title="Plein &eacute;cran">Pr&eacute;sentation</button>
                <button class="btn-client-view" id="btnLang" onclick="toggleLang()" title="Changer la langue">EN</button>
            </div>
            <div class="pv-split">
                <div class="pv-left">
                    <div class="pv-content" id="pvContent"></div>
                </div>
                <div class="pv-right" id="pvRight">
                    <div class="pv-tools-header">Outils</div>
                    <div class="pv-tools-section">
                        <h5>Biblioth&egrave;que de clauses</h5>
                        <div class="pv-lib-actions">
                            <button class="pv-btn-add-clause" onclick="showClauseEditor()">+ Nouvelle clause</button>
                        </div>
                        <div id="pvClauseEditZone"></div>
                        <div class="pv-clause-list" id="pvClauseList"></div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Modal Rentabilité -->
    <div class="rentab-overlay" id="rentabModal" onclick="if(event.target===this)closeRentab()">
        <div class="rentab-modal">
            <div class="rentab-header">
                <h2 id="rentabTitle">Rentabilit&eacute;</h2>
                <button class="rentab-close" onclick="closeRentab()">&times;</button>
            </div>
            <div class="rentab-body" id="rentabBody"></div>
        </div>
    </div>

    <!-- Modal g\u00e9n\u00e9rique (confirm / prompt / alert) -->
    <div class="modal-overlay" id="steleDialogOverlay">
        <div class="modal" style="max-width:440px;">
            <div class="modal-header">
                <h3 class="modal-title" id="steleDialogTitle"></h3>
            </div>
            <div class="modal-body">
                <p id="steleDialogMessage" style="font-size:14px; color:#444; margin-bottom:12px;"></p>
                <div id="steleDialogInputWrap" style="display:none;">
                    <input type="text" class="form-input" id="steleDialogInput" style="font-size:14px;">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" id="steleDialogCancel" onclick="steleDialogResolve(null)" style="display:none;">Annuler</button>
                <button class="btn-generate" id="steleDialogOk" onclick="steleDialogOk()">OK</button>
            </div>
        </div>
    </div>

    <!-- Timeline drawer (historique soumission) -->
    <div class="timeline-drawer-overlay" id="timelineOverlay" onclick="closeTimelineDrawer()"></div>
    <div class="timeline-drawer" id="timelineDrawer">
        <div class="timeline-drawer-header">
            <h3>Historique</h3>
            <button class="timeline-drawer-close" onclick="closeTimelineDrawer()">&times;</button>
        </div>
        <div class="timeline-drawer-body" id="timelineBody">
            <div class="timeline-empty">Aucun historique</div>
        </div>
    </div>

    <!-- Modal Soumettre la soumission -->
    <div class="modal-overlay" id="pdfModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="submitModalTitle">Soumettre la soumission</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="projectDate">Date requise</label>
                    <input type="date" class="form-input" id="projectDate">
                </div>
                <div class="form-group">
                    <label class="form-label" for="projectDescription">Message / Notes</label>
                    <textarea class="form-input" id="projectDescription" rows="3" placeholder="Ex: J'en ai besoin pour demain, pr&eacute;voir 2 semaines de d&eacute;lai..." style="resize: vertical; min-height: 60px;"></textarea>
                </div>
                <div id="sendStatus" style="display: none; padding: 10px; border-radius: 4px; font-size: 13px; margin-top: 8px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closePdfModal()">Annuler</button>
                <button class="btn-generate" id="btnSend" onclick="soumettreSoumission()">Soumettre</button>
            </div>
        </div>
    </div>

    <!-- Modal Proposer un article -->
    <div class="modal-overlay" id="proposerModal">
        <div class="modal modal-edit">
            <div class="modal-header">
                <h3 class="modal-title">Proposer un nouvel article</h3>
            </div>
            <div class="modal-body">
                <div class="edit-row">
                    <div class="form-group">
                        <label class="form-label">Code</label>
                        <input type="text" class="form-input" id="propCode" readonly style="background:#f5f5f5; color:#888;">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Cat&eacute;gorie</label>
                        <select class="form-input" id="propCategory" onchange="updatePropCode()"></select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <input type="text" class="form-input" id="propDescription" placeholder="ex: Poign&eacute;e en bois massif...">
                </div>
                <div class="edit-row">
                    <div class="form-group">
                        <label class="form-label">Type</label>
                        <select class="form-input" id="propType"></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Prix</label>
                        <input type="hidden" id="propPrice">
                        <div class="form-input" id="propPriceDisplay" style="background:#f5f5f5; color:#888; min-height:38px; display:flex; align-items:center;">Calcul&eacute; automatiquement</div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Instruction</label>
                    <textarea class="form-input" id="propInstruction" rows="2" style="resize:vertical;" placeholder="Instructions sp&eacute;ciales..."></textarea>
                </div>

                <!-- Prix composé — Minutes & Matériaux -->
                <div class="form-group" id="propComposedPriceGroup">
                    <div class="cp-section-title">Prix compos&eacute;</div>
                    <div class="composed-price-section">
                        <div class="cp-table-wrap">
                            <div class="cp-sub-title">Minutes main-d'&oelig;uvre</div>
                            <table class="cp-table">
                                <thead><tr><th>D&eacute;partement</th><th style="width:70px">Min.</th></tr></thead>
                                <tbody id="propCpMinutesBody"></tbody>
                            </table>
                        </div>
                        <div class="cp-table-wrap">
                            <div class="cp-sub-title">Mat&eacute;riaux</div>
                            <table class="cp-table">
                                <thead><tr><th>Cat&eacute;gorie</th><th style="width:80px">Co&ucirc;t ($)</th></tr></thead>
                                <tbody id="propCpMaterialsBody"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="cp-calculated">
                        <div>
                            <span class="cp-total-label">Prix calcul&eacute;</span>
                            <span class="cp-breakdown" id="propCpBreakdown"></span>
                        </div>
                        <span class="cp-total-value" id="propCpTotalValue">&mdash;</span>
                    </div>
                </div>

                <!-- Médias tagués -->
                <div class="form-group">
                    <div class="cat-media-title">M&eacute;dias</div>
                    <div class="cat-dropzone" id="propDropzone">
                        Cliquer ou glisser des images / PDFs ici
                    </div>
                    <input type="file" id="propMediaInput" accept="image/*,.pdf,application/pdf" multiple style="display:none;">
                    <div class="cat-media-list" id="propMediaList"></div>
                </div>

                <div class="form-group" style="margin-bottom:0;">
                    <div class="edit-toggle-row">
                        <label class="edit-toggle">
                            <input type="checkbox" id="propInCalculator" checked>
                            <span class="slider"></span>
                        </label>
                        <span class="edit-toggle-label">Visible dans le calculateur</span>
                    </div>
                </div>

                <div class="edit-status" id="propStatus"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeProposerModal()">Annuler</button>
                <button class="btn-generate" id="btnProposerSave" onclick="saveProposedItem()">Enregistrer</button>
            </div>
        </div>
    </div>

    <!-- Lightbox pour agrandir les images -->
    <div class="lightbox-overlay" id="lightbox" onclick="closeLightbox()">
        <img id="lightboxImg" src="" alt="">
    </div>

    <!-- Crop Modal -->
    <div class="crop-overlay" id="cropModal">
        <div class="crop-box">
            <div class="crop-header">
                <span>Cadrer l'image</span>
                <span id="cropDimensions" style="font-weight:400; font-size:12px; color:#888;"></span>
            </div>
            <div class="crop-error" id="cropError"></div>
            <div class="crop-container" id="cropContainer">
                <img id="cropImage" src="">
            </div>
            <div class="crop-controls">
                <div class="crop-ratios">
                    <button class="crop-ratio-btn active" id="cropRatio43" onclick="setCropRatio('4:3')">4:3</button>
                    <button class="crop-ratio-btn" id="cropRatio11" onclick="setCropRatio('1:1')">1:1</button>
                </div>
                <div class="crop-actions">
                    <button class="crop-btn crop-btn-cancel" onclick="cancelCrop()">Annuler</button>
                    <button class="crop-btn crop-btn-confirm" id="cropConfirmBtn" onclick="confirmCrop()">Valider</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ═══════════════════════════════════════════════════════════════════════
        // UTILITAIRES
        // ═══════════════════════════════════════════════════════════════════════

        function openLightbox(src) {
            document.getElementById('lightboxImg').src = src;
            document.getElementById('lightbox').classList.add('active');
        }

        function closeLightbox() {
            document.getElementById('lightbox').classList.remove('active');
            document.getElementById('lightboxImg').src = '';
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && document.getElementById('lightbox').classList.contains('active')) closeLightbox();
        });

        function formatPrice(amount) {
            if (amount === null || amount === undefined) return 'Sur demande';
            if (typeof amount === 'number' && amount < 1 && amount > 0) return (amount * 100).toFixed(0) + '%';
            return amount.toLocaleString('fr-CA', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' $';
        }

        function formatType(type) {
            if (type === '%') return '%';
            return type;
        }

        function updateStatus(status, message) {
            const statusEl = document.getElementById('dataStatus');
            const textEl = document.getElementById('statusText');
            statusEl.className = 'data-status ' + status;
            textEl.textContent = message;
        }

        function formatDate(date) {
            if (!date) return '';
            const options = { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' };
            return date.toLocaleDateString('fr-CA', options);
        }

        function getUserEmail() {
            try {
                const token = localStorage.getItem('sb_access_token');
                if (!token) return '';
                const payload = JSON.parse(atob(token.split('.')[1]));
                return payload.email || '';
            } catch (e) { return ''; }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // CHARGEMENT DES DONN&Eacute;ES
        // ═══════════════════════════════════════════════════════════════════════

        function saveToLocalStorage(data) {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                localStorage.setItem(STORAGE_DATE_KEY, new Date().toISOString());
            } catch (e) { console.warn('Impossible de sauvegarder dans localStorage:', e); }
        }

        function loadFromLocalStorage() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                const date = localStorage.getItem(STORAGE_DATE_KEY);
                if (data) return { data: JSON.parse(data), date: date ? new Date(date) : null };
            } catch (e) { console.warn('Impossible de lire depuis localStorage:', e); }
            return null;
        }

        function loadCatalogueData() {
            return new Promise((resolve) => {
                updateStatus('', 'Chargement...');

                var userEmail = getUserEmail();
                authenticatedFetch(SUPABASE_URL + '/rest/v1/catalogue_items?select=id,category,description,type,price,instruction,image_url,in_calculator,status,proposed_by,labor_minutes,material_costs&or=(status.eq.approved,status.is.null,and(status.eq.pending,proposed_by.eq.' + encodeURIComponent(userEmail) + '))&order=sort_order', {})
                .then(r => {
                    if (!r.ok) throw new Error('HTTP ' + r.status);
                    return r.json();
                })
                .then(data => {
                    if (data.length > 0) {
                        CATALOGUE_DATA = data;
                        saveToLocalStorage(data);
                        updateStatus('online', 'Données à jour');
                        resolve(true);
                    } else {
                        throw new Error('Données vides');
                    }
                })
                .catch(error => {
                    console.warn('Erreur chargement catalogue:', error);
                    loadFallbackData();
                    resolve(false);
                });
            });
        }

        function loadFallbackData() {
            const cached = loadFromLocalStorage();
            if (cached && cached.data && cached.data.length > 0) {
                CATALOGUE_DATA = cached.data;
                const dateStr = cached.date ? formatDate(cached.date) : '';
                updateStatus('offline', 'Hors-ligne' + (dateStr ? ' — ' + dateStr : ''));
            } else {
                updateStatus('error', 'Aucune donnée disponible');
            }
        }

        function loadEmployeesData() {
            return new Promise((resolve) => {
                authenticatedFetch(SUPABASE_URL + '/rest/v1/employees?select=name,email&order=sort_order', {})
                .then(r => {
                    if (!r.ok) throw new Error('HTTP ' + r.status);
                    return r.json();
                })
                .then(data => {
                    EMPLOYEES_DATA = data;
                    resolve(true);
                })
                .catch(error => {
                    console.warn('Erreur chargement employ\u00e9s:', error);
                    resolve(false);
                });
            });
        }

        // ═══════════════════════════════════════════════════════════════════════
        // CALCULATEUR — SECTIONS PAR MEUBLE
        // ═══════════════════════════════════════════════════════════════════════

        let rowCounter = 0;
        let groupCounter = 0;

        function buildSelectOptions() {
            let options = '<option value="">— Sélectionner un article —</option>';
            let currentCategory = '';

            const itemsWithPrice = CATALOGUE_DATA.filter(item =>
                item.price !== null &&
                item.type !== '%' &&
                item.in_calculator !== false
            ).sort((a, b) => (a.category || '').localeCompare(b.category || ''));

            itemsWithPrice.forEach(item => {
                if (item.category !== currentCategory) {
                    if (currentCategory !== '') options += '</optgroup>';
                    options += `<optgroup label="${escapeAttr(item.category)}">`;
                    currentCategory = item.category;
                }
                const pendingLabel = (item.status === 'pending') ? ' (en attente)' : '';
                options += `<option value="${escapeAttr(item.id)}">${escapeHtml(item.description)}${pendingLabel}</option>`;
            });
            options += '</optgroup>';
            options += '<optgroup label="Autre">';
            options += '<option value="__PROPOSER__">📋 Proposer un nouvel article...</option>';
            options += '<option value="__AJOUT__">➕ Ajout personnalisé...</option>';
            options += '</optgroup>';
            return options;
        }

        function toggleGroup(groupId) {
            document.getElementById(groupId).classList.toggle('collapsed');
        }

        function toggleProjectInstallation() {
            var cb = document.getElementById('projInstallation');
            var checked = cb.checked;
            // Cascade vers toutes les sections
            document.querySelectorAll('.furniture-group').forEach(function(group) {
                var groupId = group.id;
                var sectionCb = document.getElementById(groupId + '-install');
                if (sectionCb && sectionCb.checked !== checked) {
                    sectionCb.checked = checked;
                    toggleInstallation(groupId);
                }
            });
        }

        function toggleInstallation(groupId) {
            var cb = document.getElementById(groupId + '-install');
            // Cascade vers toutes les lignes de ce groupe
            var rows = document.querySelectorAll('#' + groupId + '-rows .calc-row');
            rows.forEach(function(row) {
                var rowCb = document.getElementById(row.id + '-install');
                if (rowCb) rowCb.checked = cb.checked;
                updateRow(row.id);
            });

            // Sauvegarder dans Supabase
            if (roomMap[groupId]) {
                updateRoom(roomMap[groupId], { installation_included: cb.checked });
                showSaveIndicator();
            }
        }

        function toggleRowInstallation(rowId) {
            updateRow(rowId);
            // Sauvegarder dans Supabase
            if (itemMap[rowId]) {
                var cb = document.getElementById(rowId + '-install');
                updateItem(itemMap[rowId], { installation_included: cb.checked });
                showSaveIndicator();
            }
        }

        function addFurnitureGroup(initialName, opts) {
            opts = opts || {};
            groupCounter++;
            const groupId = `group-${groupCounter}`;

            const group = document.createElement('div');
            group.className = 'furniture-group';
            group.id = groupId;

            group.innerHTML = `
                <div class="furniture-group-header">
                    <button class="btn-collapse" onclick="toggleGroup('${groupId}')" title="Réduire / Agrandir">&#9660;</button>
                    <span class="group-label">Meuble :</span>
                    <input type="text" class="furniture-name-input" id="${groupId}-name"
                           placeholder="ex: Cuisine, Salle de bain, Sous-sol..."
                           value="${escapeAttr(initialName || '')}">
                    <label class="install-toggle" title="Inclure l'installation">
                        <input type="checkbox" id="${groupId}-install" checked onchange="toggleInstallation('${groupId}')">
                        <span class="install-label">Installation</span>
                    </label>
                    <button class="btn-rentab" onclick="openRentab('group','${groupId}')">Rentabilit&eacute;</button>
                    <button class="btn-remove-group" onclick="removeFurnitureGroup('${groupId}')">Supprimer</button>
                </div>
                <div class="client-description-section">
                    <label class="client-desc-label">Description client (visible sur la soumission)</label>
                    <textarea class="client-desc-textarea" id="${groupId}-clientDesc"
                              placeholder="Description visible par le client pour cette pi&egrave;ce..."
                              rows="2"
                              onblur="saveClientDescription('${groupId}')"></textarea>
                </div>
                <div class="calc-header">
                    <span></span>
                    <span>Article</span>
                    <span class="col-center">Code</span>
                    <span class="col-center">Type</span>
                    <span class="col-right">Prix unit.</span>
                    <span class="col-center">Quantité</span>
                    <span class="col-center" title="Installation incluse">Inst.</span>
                    <span class="col-right">Total</span>
                    <span></span>
                </div>
                <div class="calc-rows" id="${groupId}-rows">
                    <div class="add-row-container">
                        <button class="btn-add" onclick="addRow('${groupId}')" title="Ajouter une ligne">+</button>
                        <span class="add-row-text">Ajouter un article</span>
                    </div>
                </div>
                <div class="group-subtotal-container">
                    <span class="group-subtotal-label">Sous-total</span>
                    <span class="group-subtotal-amount" id="${groupId}-subtotal">0,00 $</span>
                </div>
                <div class="group-images-section">
                    <div class="group-images-header">Images / Photos</div>
                    <div class="image-drop-zone group-image-drop-zone" id="${groupId}-imgDrop">
                        <div class="image-drop-zone-text">
                            <strong>Ctrl+V</strong> pour coller &middot; <strong>glisser-d&eacute;poser</strong> &middot; ou <strong>cliquer</strong>
                        </div>
                    </div>
                    <input type="file" id="${groupId}-imgInput" accept="image/png,image/jpeg,image/webp,application/pdf" multiple style="display:none;">
                    <div class="image-previews" id="${groupId}-imgPreviews"></div>
                    <div class="image-count" id="${groupId}-imgCount"></div>
                </div>
            `;

            document.getElementById('furnitureGroups').appendChild(group);
            setupGroupImageHandlers(groupId);
            if (!groupImages[groupId]) groupImages[groupId] = [];

            // Persistance Supabase
            if (opts.existingId) {
                roomMap[groupId] = opts.existingId;
            } else if (currentSubmission && !opts.skipSave) {
                const sortOrder = document.querySelectorAll('.furniture-group').length;
                createRoom(currentSubmission.id, initialName || '', sortOrder).then(room => {
                    if (room) roomMap[groupId] = room.id;
                });
            }

            // Auto-save nom du meuble sur blur
            const nameInput = document.getElementById(`${groupId}-name`);
            nameInput.addEventListener('blur', function() {
                if (roomMap[groupId]) {
                    updateRoom(roomMap[groupId], { name: this.value });
                    showSaveIndicator();
                }
            });

            return groupId;
        }

        async function removeFurnitureGroup(groupId) {
            const groups = document.querySelectorAll('.furniture-group');
            if (groups.length <= 1) return;
            if (!(await steleConfirm('Supprimer ce meuble et tous ses articles ?', 'Supprimer', 'Supprimer', true))) return;

            // Supprimer dans Supabase
            if (roomMap[groupId]) {
                deleteRoom(roomMap[groupId]);
                // Nettoyer les itemMap pour les rows de ce groupe
                const group = document.getElementById(groupId);
                if (group) {
                    group.querySelectorAll('.calc-row').forEach(row => {
                        delete itemMap[row.id];
                    });
                }
                delete roomMap[groupId];
            }
            delete groupImages[groupId];

            const group = document.getElementById(groupId);
            if (group) { group.remove(); updateGrandTotal(); }
        }

        function addRow(groupId, opts) {
            opts = opts || {};
            rowCounter++;
            const rowId = `row-${rowCounter}`;

            const row = document.createElement('div');
            row.className = 'calc-row';
            row.id = rowId;
            row.dataset.mode = 'normal';
            row.dataset.group = groupId;
            row.innerHTML = `
                <div class="cell-add">
                    <button class="btn-add" onclick="addRow('${groupId}')" title="Ajouter une ligne">+</button>
                </div>
                <div class="cell-select">
                    <select class="item-select" onchange="updateRow('${rowId}')">
                        ${buildSelectOptions()}
                    </select>
                </div>
                <div class="cell-code" id="${rowId}-code">—</div>
                <div class="cell-type" id="${rowId}-type">—</div>
                <div class="cell-unit-price" id="${rowId}-unit-price">—</div>
                <div class="cell-qty">
                    <input type="number" class="qty-input" id="${rowId}-qty" value="1" min="0" step="0.01" onchange="updateRow('${rowId}')" oninput="updateRow('${rowId}')">
                </div>
                <div class="install-toggle-row">
                    <input type="checkbox" id="${rowId}-install" checked onchange="toggleRowInstallation('${rowId}')" title="Installation incluse">
                </div>
                <div class="cell-total" id="${rowId}-total">0,00 $</div>
                <div class="cell-remove">
                    <button class="btn-remove" onclick="removeRow('${rowId}')" title="Supprimer">×</button>
                </div>
            `;

            const container = document.getElementById(`${groupId}-rows`);
            const addContainer = container.querySelector('.add-row-container');
            container.insertBefore(row, addContainer);

            // Persistance Supabase
            if (opts.existingId) {
                itemMap[rowId] = opts.existingId;
            } else if (currentSubmission && roomMap[groupId] && !opts.skipSave) {
                const sortOrder = container.querySelectorAll('.calc-row').length;
                createItem(roomMap[groupId], { sort_order: sortOrder }).then(item => {
                    if (item) itemMap[rowId] = item.id;
                });
            }

            if (!opts.skipFocus) row.querySelector('.item-select').focus();
            return rowId;
        }

        function transformToAjoutMode(row, rowId) {
            row.dataset.mode = 'ajout';
            row.style.background = '#eef2ef';

            const codeEl = document.getElementById(`${rowId}-code`);
            const typeEl = document.getElementById(`${rowId}-type`);
            const unitPriceEl = document.getElementById(`${rowId}-unit-price`);

            codeEl.innerHTML = `<input type="text" class="ajout-description" id="${rowId}-desc" placeholder="Description..." oninput="updateRow('${rowId}')" style="width: 100%; padding: 6px 8px; font-size: 12px; border: 1px solid #C8C8C8; border-radius: 4px;">`;
            codeEl.style.gridColumn = 'span 1';
            typeEl.innerHTML = `<input type="number" class="ajout-price" id="${rowId}-price" placeholder="Prix" value="0" min="0" step="0.01" oninput="updateRow('${rowId}')" style="width: 100%; padding: 6px 8px; font-size: 12px; border: 1px solid #C8C8C8; border-radius: 4px; text-align: right; -moz-appearance: textfield;" onwheel="this.blur()">`;
            unitPriceEl.innerHTML = `<div style="display: flex; align-items: center; gap: 4px;"><input type="number" class="ajout-markup" id="${rowId}-markup" value="30" min="0" step="1" oninput="updateRow('${rowId}')" style="width: 60px; padding: 6px 8px; font-size: 12px; border: 1px solid #C8C8C8; border-radius: 4px; text-align: right; -moz-appearance: textfield;" onwheel="this.blur()"><span style="font-size: 11px; color: #666;">%</span></div>`;

            setTimeout(() => {
                const descInput = document.getElementById(`${rowId}-desc`);
                if (descInput) descInput.focus();
            }, 50);
        }

        function transformToNormalMode(row, rowId) {
            row.dataset.mode = 'normal';
            row.style.background = '';
            document.getElementById(`${rowId}-code`).innerHTML = '—';
            document.getElementById(`${rowId}-code`).style.gridColumn = '';
            document.getElementById(`${rowId}-type`).innerHTML = '—';
            document.getElementById(`${rowId}-unit-price`).innerHTML = '—';
            document.getElementById(`${rowId}-total`).textContent = '0,00 $';
        }

        let configCategories = [];

        async function loadConfigCategories() {
            try {
                const r = await authenticatedFetch(
                    SUPABASE_URL + '/rest/v1/app_config?key=eq.catalogue_categories&select=value', {}
                );
                if (r.ok) {
                    const rows = await r.json();
                    if (rows.length > 0 && Array.isArray(rows[0].value)) {
                        configCategories = rows[0].value;
                    }
                }
            } catch (e) { /* keep empty */ }
        }

        async function loadTauxAndExpenses() {
            try {
                const r = await authenticatedFetch(
                    SUPABASE_URL + '/rest/v1/app_config?key=in.(taux_horaires,expense_categories)&select=key,value', {}
                );
                if (r.ok) {
                    const rows = await r.json();
                    rows.forEach(function(row) {
                        if (row.key === 'taux_horaires') tauxHoraires = row.value || [];
                        if (row.key === 'expense_categories') expenseCategories = row.value || [];
                    });
                }
            } catch (e) { /* keep defaults */ }
        }

        // Calculer le prix composé d'un article catalogue
        function computeComposedPrice(item, includeInstallation) {
            var laborMinutes = item.labor_minutes || {};
            var materialCosts = item.material_costs || {};
            var hasComposed = false;

            // Main-d'œuvre
            var laborTotal = 0;
            for (var i = 0; i < tauxHoraires.length; i++) {
                var dept = tauxHoraires[i].department;
                var minutes = laborMinutes[dept] || 0;
                if (minutes > 0) {
                    if (!includeInstallation && dept === 'Installation') continue;
                    laborTotal += (minutes / 60) * (tauxHoraires[i].taux_horaire || 0);
                    hasComposed = true;
                }
            }

            // Matériaux
            var materialTotal = 0;
            for (var j = 0; j < expenseCategories.length; j++) {
                var cat = expenseCategories[j].name;
                var cost = materialCosts[cat] || 0;
                if (cost > 0) {
                    materialTotal += cost * (1 + (expenseCategories[j].markup || 0) / 100);
                    hasComposed = true;
                }
            }

            if (!hasComposed) return null; // pas de prix composé → utiliser item.price
            return laborTotal + materialTotal;
        }

        function getCategories() {
            const cats = new Set();
            CATALOGUE_DATA.forEach(item => { if (item.category) cats.add(item.category); });
            configCategories.forEach(c => cats.add(c));
            return Array.from(cats).sort();
        }

        function generateNextCode(category) {
            const clean = (category || 'XXX').normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            const prefix = clean.substring(0, 3).toUpperCase();
            let maxNum = 0;
            CATALOGUE_DATA.forEach(item => {
                if (item.id && item.id.startsWith(prefix + '-')) {
                    const num = parseInt(item.id.split('-')[1]) || 0;
                    if (num > maxNum) maxNum = num;
                }
            });
            return prefix + '-' + String(maxNum + 1).padStart(3, '0');
        }

        let proposerRowId = null; // rowId en cours de proposition

        function transformToProposerMode(row, rowId) {
            row.dataset.mode = 'proposer';
            proposerRowId = rowId;
            openProposerModal();
        }

        function updatePropCode() {
            var cat = document.getElementById('propCategory').value;
            document.getElementById('propCode').value = generateNextCode(cat);
        }

        function openProposerModal() {
            // Remplir le dropdown catégories
            const catSelect = document.getElementById('propCategory');
            const categories = getCategories();
            catSelect.innerHTML = categories.map(c => `<option value="${escapeAttr(c)}">${escapeHtml(c)}</option>`).join('');

            // Remplir le dropdown types
            const typeSelect = document.getElementById('propType');
            const types = new Set(['pi\u00b2', 'unitaire', 'lin\u00e9aire', '%']);
            CATALOGUE_DATA.forEach(function(i) { if (i.type) types.add(i.type); });
            typeSelect.innerHTML = Array.from(types).map(t => `<option value="${escapeAttr(t)}">${escapeHtml(t)}</option>`).join('');

            // Réinitialiser les champs
            document.getElementById('propDescription').value = '';
            document.getElementById('propType').value = 'unitaire';
            document.getElementById('propPrice').value = '';
            document.getElementById('propPriceDisplay').textContent = 'Calcul\u00e9 automatiquement';
            document.getElementById('propInstruction').value = '';
            document.getElementById('propInCalculator').checked = true;

            // Code auto-généré
            updatePropCode();

            // Tableaux prix composé
            renderPropComposedTables();

            // Médias
            propMedia = [];
            renderPropMedia();

            // Reset status
            var status = document.getElementById('propStatus');
            status.className = 'edit-status';
            status.style.display = 'none';
            document.getElementById('btnProposerSave').disabled = false;
            document.getElementById('btnProposerSave').textContent = 'Enregistrer';

            document.getElementById('proposerModal').classList.add('active');
            setTimeout(() => document.getElementById('propDescription').focus(), 100);
        }

        function closeProposerModal() {
            document.getElementById('proposerModal').classList.remove('active');

            // Si on ferme sans sauvegarder, remettre la row en mode normal
            if (proposerRowId) {
                const row = document.getElementById(proposerRowId);
                if (row && row.dataset.mode === 'proposer') {
                    const select = row.querySelector('.item-select');
                    select.value = '';
                    transformToNormalMode(row, proposerRowId);
                    updateRow(proposerRowId);
                }
                proposerRowId = null;
            }
        }

        // ── Prix composé pour le modal de proposition ──

        function renderPropComposedTables() {
            var mBody = document.getElementById('propCpMinutesBody');
            var mHtml = '';
            for (var i = 0; i < tauxHoraires.length; i++) {
                var dept = tauxHoraires[i].department;
                mHtml += '<tr><td>' + escapeHtml(dept) + '</td>' +
                    '<td><input type="number" step="0.1" placeholder="0" value=""' +
                    ' data-dept="' + escapeAttr(dept) + '"' +
                    (canEditMinutes ? '' : ' disabled') +
                    ' oninput="updatePropComposedPrice()"></td></tr>';
            }
            mBody.innerHTML = mHtml;

            var cBody = document.getElementById('propCpMaterialsBody');
            var cHtml = '';
            for (var j = 0; j < expenseCategories.length; j++) {
                var cat = expenseCategories[j].name;
                cHtml += '<tr><td title="' + escapeAttr(cat) + '">' + escapeHtml(cat) + '</td>' +
                    '<td><input type="number" step="0.01" placeholder="0.00" value=""' +
                    ' data-cat="' + escapeAttr(cat) + '"' +
                    (canEditMaterials ? '' : ' disabled') +
                    ' oninput="updatePropComposedPrice()"></td></tr>';
            }
            cBody.innerHTML = cHtml;

            updatePropComposedPrice();
        }

        function updatePropComposedPrice() {
            var laborTotal = 0;
            var mInputs = document.querySelectorAll('#propCpMinutesBody input[type="number"]');
            for (var i = 0; i < mInputs.length; i++) {
                var minutes = parseFloat(mInputs[i].value) || 0;
                var dept = mInputs[i].getAttribute('data-dept');
                var taux = tauxHoraires.find(function(t) { return t.department === dept; });
                laborTotal += (minutes / 60) * (taux ? (taux.taux_horaire || 0) : 0);
            }

            var materialTotal = 0;
            var cInputs = document.querySelectorAll('#propCpMaterialsBody input[type="number"]');
            for (var j = 0; j < cInputs.length; j++) {
                var cost = parseFloat(cInputs[j].value) || 0;
                var catName = cInputs[j].getAttribute('data-cat');
                var expCat = expenseCategories.find(function(c) { return c.name === catName; });
                materialTotal += cost * (1 + (expCat ? (expCat.markup || 0) : 0) / 100);
            }

            var total = laborTotal + materialTotal;
            var totalEl = document.getElementById('propCpTotalValue');
            var breakdownEl = document.getElementById('propCpBreakdown');
            var priceField = document.getElementById('propPrice');
            var priceDisplay = document.getElementById('propPriceDisplay');

            if (total > 0) {
                totalEl.textContent = total.toFixed(2) + ' $';
                breakdownEl.textContent = '(MO: ' + laborTotal.toFixed(2) + ' + Mat: ' + materialTotal.toFixed(2) + ')';
                priceField.value = total.toFixed(2);
                priceDisplay.textContent = total.toFixed(2) + ' $';
            } else {
                totalEl.textContent = '\u2014';
                breakdownEl.textContent = '';
                priceField.value = '';
                priceDisplay.textContent = 'Calcul\u00e9 automatiquement';
            }
        }

        function collectPropLaborMinutes() {
            var data = {};
            var inputs = document.querySelectorAll('#propCpMinutesBody input[type="number"]');
            for (var i = 0; i < inputs.length; i++) {
                var val = parseFloat(inputs[i].value) || 0;
                if (val > 0) data[inputs[i].getAttribute('data-dept')] = val;
            }
            return data;
        }

        function collectPropMaterialCosts() {
            var data = {};
            var inputs = document.querySelectorAll('#propCpMaterialsBody input[type="number"]');
            for (var i = 0; i < inputs.length; i++) {
                var val = parseFloat(inputs[i].value) || 0;
                if (val > 0) data[inputs[i].getAttribute('data-cat')] = val;
            }
            return data;
        }

        // ── Médias pour le modal de proposition ──

        function setupProposerMediaHandlers() {
            var dropzone = document.getElementById('propDropzone');
            var fileInput = document.getElementById('propMediaInput');
            if (!dropzone || !fileInput) return;

            dropzone.addEventListener('click', function() { fileInput.click(); });
            dropzone.addEventListener('dragover', function(e) { e.preventDefault(); dropzone.classList.add('dragover'); });
            dropzone.addEventListener('dragleave', function() { dropzone.classList.remove('dragover'); });
            dropzone.addEventListener('drop', function(e) {
                e.preventDefault();
                dropzone.classList.remove('dragover');
                handlePropMediaFiles(e.dataTransfer.files);
            });
            fileInput.addEventListener('change', function() {
                handlePropMediaFiles(fileInput.files);
                fileInput.value = '';
            });
        }

        function handlePropMediaFiles(files) {
            Array.from(files).forEach(function(file) {
                var isPdf = file.type === 'application/pdf';
                var isImage = file.type.startsWith('image/');
                if (!isPdf && !isImage) return;

                var mediaEntry = {
                    id: null, file_url: null, previewUrl: null,
                    file_type: isPdf ? 'pdf' : 'image',
                    tags: [], isNew: true, file: file
                };

                if (isImage) {
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        mediaEntry.previewUrl = e.target.result;
                        propMedia.push(mediaEntry);
                        renderPropMedia();
                    };
                    reader.readAsDataURL(file);
                } else {
                    propMedia.push(mediaEntry);
                    renderPropMedia();
                }
            });
        }

        function renderPropMedia() {
            var list = document.getElementById('propMediaList');
            list.innerHTML = '';

            propMedia.forEach(function(media, index) {
                var item = document.createElement('div');
                item.className = 'cat-media-item';

                if (media.file_type === 'pdf') {
                    var pdfIcon = document.createElement('div');
                    pdfIcon.className = 'cat-pdf-icon';
                    pdfIcon.textContent = 'PDF';
                    item.appendChild(pdfIcon);
                } else {
                    var img = document.createElement('img');
                    img.src = media.file_url || media.previewUrl || '';
                    img.alt = '';
                    item.appendChild(img);
                }

                var info = document.createElement('div');
                info.className = 'cat-media-info';
                var tags = document.createElement('div');
                tags.className = 'cat-media-tags';

                mediaTagsList.forEach(function(tag) {
                    var chip = document.createElement('span');
                    chip.className = 'cat-tag' + (media.tags.indexOf(tag) !== -1 ? ' active' : '');
                    chip.textContent = tag.replace(/_/g, ' ');
                    chip.onclick = function() {
                        var idx = media.tags.indexOf(tag);
                        if (idx !== -1) media.tags.splice(idx, 1);
                        else media.tags.push(tag);
                        chip.classList.toggle('active');
                    };
                    tags.appendChild(chip);
                });

                info.appendChild(tags);
                item.appendChild(info);

                var removeBtn = document.createElement('button');
                removeBtn.className = 'cat-media-remove';
                removeBtn.innerHTML = '&times;';
                removeBtn.title = 'Supprimer';
                removeBtn.onclick = function() {
                    propMedia.splice(index, 1);
                    renderPropMedia();
                };
                item.appendChild(removeBtn);

                list.appendChild(item);
            });
        }

        // ── Sauvegarde ──

        async function saveProposedItem() {
            if (!proposerRowId) return;

            const category = document.getElementById('propCategory').value;
            const description = document.getElementById('propDescription').value.trim();
            const type = document.getElementById('propType').value;
            const priceVal = document.getElementById('propPrice').value;
            const price = priceVal !== '' ? parseFloat(priceVal) : null;
            const instruction = document.getElementById('propInstruction').value.trim();
            const inCalculator = document.getElementById('propInCalculator').checked;
            const laborMinutes = collectPropLaborMinutes();
            const materialCosts = collectPropMaterialCosts();

            if (!description) { document.getElementById('propDescription').focus(); return; }
            if (!price || price <= 0) {
                // Vérifier s'il y a des données composées
                if (Object.keys(laborMinutes).length === 0 && Object.keys(materialCosts).length === 0) {
                    steleAlert('Veuillez remplir les minutes ou mat\u00e9riaux pour calculer le prix.');
                    return;
                }
            }

            const btn = document.getElementById('btnProposerSave');
            btn.disabled = true;
            btn.textContent = 'Enregistrement...';

            const newId = document.getElementById('propCode').value || generateNextCode(category);
            const email = getUserEmail();

            const payload = {
                id: newId,
                category: category,
                description: description,
                type: type,
                price: price,
                instruction: instruction || null,
                labor_minutes: Object.keys(laborMinutes).length > 0 ? laborMinutes : null,
                material_costs: Object.keys(materialCosts).length > 0 ? materialCosts : null,
                status: 'pending',
                proposed_by: email,
                in_calculator: inCalculator,
                sort_order: 9999
            };

            try {
                const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/catalogue_items', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                    body: JSON.stringify(payload)
                });
                if (!r.ok) throw new Error('HTTP ' + r.status);
                const data = await r.json();
                const newItem = data[0] || payload;

                // Upload des médias
                for (var mi = 0; mi < propMedia.length; mi++) {
                    var m = propMedia[mi];
                    if (m.isNew && m.file) {
                        var ext = m.file.name.split('.').pop().toLowerCase() || 'bin';
                        var path = newId + '/' + Date.now() + '_' + mi + '.' + ext;
                        var uploadResp = await authenticatedFetch(SUPABASE_URL + '/storage/v1/object/fiche-images/' + path, {
                            method: 'POST',
                            headers: { 'Content-Type': m.file.type, 'x-upsert': 'true' },
                            body: m.file
                        });
                        if (uploadResp.ok) {
                            var fileUrl = SUPABASE_URL + '/storage/v1/object/public/fiche-images/' + path;
                            await authenticatedFetch(SUPABASE_URL + '/rest/v1/item_media', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                                body: JSON.stringify({
                                    catalogue_item_id: newId,
                                    file_url: fileUrl,
                                    file_type: m.file_type,
                                    tags: m.tags,
                                    sort_order: mi
                                })
                            });
                            // Auto-sync image_url si tag "catalogue"
                            if (mi === 0 || m.tags.indexOf('catalogue') !== -1) {
                                if (m.file_type === 'image' && m.tags.indexOf('catalogue') !== -1) {
                                    await authenticatedFetch(SUPABASE_URL + '/rest/v1/catalogue_items?id=eq.' + encodeURIComponent(newId), {
                                        method: 'PATCH',
                                        headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                                        body: JSON.stringify({ image_url: fileUrl })
                                    });
                                    newItem.image_url = fileUrl;
                                }
                            }
                        }
                    }
                }

                CATALOGUE_DATA.push(newItem);

                // Mettre à jour la row
                const rowId = proposerRowId;
                const row = document.getElementById(rowId);
                if (row) {
                    transformToNormalMode(row, rowId);
                    refreshAllSelects();
                    const select = row.querySelector('.item-select');
                    select.value = newId;
                    updateRow(rowId);
                }

                proposerRowId = null;
                showSaveIndicator();

                // Afficher le message de confirmation
                const statusEl = document.getElementById('propStatus');
                statusEl.style.display = 'block';
                statusEl.className = 'edit-status success';
                statusEl.textContent = 'Votre article a \u00e9t\u00e9 ajout\u00e9 \u00e0 votre soumission mais est en attente d\u2019approbation pour \u00eatre ajout\u00e9 au catalogue officiellement.';
                btn.textContent = 'Enregistr\u00e9!';

                setTimeout(() => {
                    document.getElementById('proposerModal').classList.remove('active');
                }, 3000);
            } catch (e) {
                console.error('Erreur proposition article:', e);
                const statusEl = document.getElementById('propStatus');
                statusEl.style.display = 'block';
                statusEl.className = 'edit-status error';
                statusEl.textContent = 'Erreur lors de la proposition. V\u00e9rifiez votre connexion.';
                btn.disabled = false;
                btn.textContent = 'Enregistrer';
            }
        }

        function refreshAllSelects() {
            const newOptions = buildSelectOptions();
            document.querySelectorAll('.item-select').forEach(select => {
                const currentValue = select.value;
                select.innerHTML = newOptions;
                if (currentValue) select.value = currentValue;
            });
        }

        function updateRow(rowId) {
            const row = document.getElementById(rowId);
            const select = row.querySelector('.item-select');
            const qtyInput = row.querySelector('.qty-input');
            const totalEl = document.getElementById(`${rowId}-total`);

            const selectedId = select.value;
            const qty = parseFloat(qtyInput.value) || 0;
            const currentMode = row.dataset.mode;

            if (selectedId === '__PROPOSER__') {
                if (currentMode !== 'proposer') {
                    if (currentMode === 'ajout') transformToNormalMode(row, rowId);
                    transformToProposerMode(row, rowId);
                }
            } else if (selectedId === '__AJOUT__') {
                if (currentMode !== 'ajout') {
                    if (currentMode === 'proposer') transformToNormalMode(row, rowId);
                    transformToAjoutMode(row, rowId);
                }
                const priceInput = document.getElementById(`${rowId}-price`);
                const markupInput = document.getElementById(`${rowId}-markup`);
                if (priceInput && markupInput) {
                    const price = parseFloat(priceInput.value) || 0;
                    const markup = parseFloat(markupInput.value) || 0;
                    totalEl.textContent = formatPrice(price * qty * (1 + markup / 100));
                }
            } else {
                if (currentMode === 'ajout' || currentMode === 'proposer') transformToNormalMode(row, rowId);
                const codeEl = document.getElementById(`${rowId}-code`);
                const typeEl = document.getElementById(`${rowId}-type`);
                const unitPriceEl = document.getElementById(`${rowId}-unit-price`);

                if (selectedId) {
                    const item = CATALOGUE_DATA.find(i => i.id === selectedId);
                    if (item) {
                        const tooltipImg = item.image_url ? `<img class="tooltip-img" src="${escapeAttr(item.image_url)}" alt="">` : '';
                        codeEl.innerHTML = `<span class="tooltip-container">${escapeHtml(item.id)}<div class="tooltip">${tooltipImg}<div class="tooltip-title">${escapeHtml(item.description)}</div><div class="tooltip-text">${escapeHtml(item.instruction || '')}</div></div></span>`;
                        typeEl.textContent = formatType(item.type);

                        // Prix composé si disponible, sinon prix catalogue
                        var installCb = document.getElementById(rowId + '-install');
                        var includeInstall = installCb ? installCb.checked : true;
                        var composedPrice = computeComposedPrice(item, includeInstall);
                        var effectivePrice = composedPrice !== null ? composedPrice : (item.price || 0);
                        unitPriceEl.textContent = formatPrice(effectivePrice);
                        totalEl.textContent = formatPrice(effectivePrice * qty);
                    }
                } else {
                    codeEl.textContent = '—';
                    typeEl.textContent = '—';
                    unitPriceEl.textContent = '—';
                    totalEl.textContent = '0,00 $';
                }
            }

            const groupId = row.dataset.group;
            if (groupId) updateGroupSubtotal(groupId);
            updateGrandTotal();

            // Sauvegarder dans Supabase (debounce) — pas en mode proposer
            if (itemMap[rowId] && row.dataset.mode !== 'proposer') {
                debouncedSaveItem(rowId, row);
            }
        }

        const debouncedSaveItem = debounce(function(rowId, row) {
            if (!itemMap[rowId]) return;
            const select = row.querySelector('.item-select');
            const qtyInput = row.querySelector('.qty-input');
            const selectedId = select ? select.value : '';
            const qty = parseFloat(qtyInput ? qtyInput.value : 0) || 0;

            let fields = { quantity: qty };

            if (selectedId === '__PROPOSER__') return;

            if (selectedId === '__AJOUT__') {
                const descInput = row.querySelector('.ajout-description');
                const priceInput = row.querySelector('.ajout-price');
                const markupInput = row.querySelector('.ajout-markup');
                fields.item_type = 'custom';
                fields.catalogue_item_id = null;
                fields.description = descInput ? descInput.value : '';
                fields.unit_price = parseFloat(priceInput ? priceInput.value : 0) || 0;
                fields.markup = parseFloat(markupInput ? markupInput.value : 0) || 0;
                fields.unit_type = '';
            } else if (selectedId) {
                const item = CATALOGUE_DATA.find(i => i.id === selectedId);
                if (item) {
                    var installCb = document.getElementById(rowId + '-install');
                    var includeInstall = installCb ? installCb.checked : true;
                    var composed = computeComposedPrice(item, includeInstall);
                    fields.item_type = 'catalogue';
                    fields.catalogue_item_id = item.id;
                    fields.description = item.description;
                    fields.unit_type = item.type || '';
                    fields.unit_price = composed !== null ? composed : (item.price || 0);
                    fields.markup = 0;
                }
            } else {
                // Pas de sélection, on sauvegarde quand même la quantité
                fields.item_type = 'catalogue';
                fields.catalogue_item_id = null;
                fields.description = '';
                fields.unit_price = 0;
                fields.markup = 0;
            }

            updateItem(itemMap[rowId], fields);
            showSaveIndicator();
        }, 500);

        function removeRow(rowId) {
            const row = document.getElementById(rowId);
            if (row) {
                const groupId = row.dataset.group;
                // Supprimer dans Supabase
                if (itemMap[rowId]) {
                    deleteItem(itemMap[rowId]);
                    delete itemMap[rowId];
                }
                row.remove();
                if (groupId) updateGroupSubtotal(groupId);
                updateGrandTotal();
            }
        }

        function getRowTotal(row) {
            const select = row.querySelector('.item-select');
            const qtyInput = row.querySelector('.qty-input');
            if (!select || !qtyInput) return 0;
            const selectedId = select.value;
            const qty = parseFloat(qtyInput.value) || 0;

            if (selectedId === '__PROPOSER__') {
                return 0;
            } else if (selectedId === '__AJOUT__') {
                const priceInput = row.querySelector('.ajout-price');
                const markupInput = row.querySelector('.ajout-markup');
                if (priceInput && markupInput) {
                    return (parseFloat(priceInput.value) || 0) * qty * (1 + (parseFloat(markupInput.value) || 0) / 100);
                }
            } else if (selectedId) {
                const item = CATALOGUE_DATA.find(i => i.id === selectedId);
                if (item && item.price) return item.price * qty;
            }
            return 0;
        }

        function updateGroupSubtotal(groupId) {
            let subtotal = 0;
            const container = document.getElementById(`${groupId}-rows`);
            if (!container) return;
            container.querySelectorAll('.calc-row').forEach(row => { subtotal += getRowTotal(row); });
            const subtotalEl = document.getElementById(`${groupId}-subtotal`);
            if (subtotalEl) subtotalEl.textContent = formatPrice(subtotal);
        }

        function updateGrandTotal() {
            let total = 0;
            document.querySelectorAll('.calc-row').forEach(row => { total += getRowTotal(row); });
            document.getElementById('grandTotal').textContent = formatPrice(total);
        }

        function calculerGrandTotal() {
            let total = 0;
            document.querySelectorAll('.calc-row').forEach(row => { total += getRowTotal(row); });
            return Math.round(total * 100) / 100;
        }

        // ═══════════════════════════════════════════════════════════════════════
        // MODAL ENVOI
        // ═══════════════════════════════════════════════════════════════════════

        function openSubmitModal() {
            if (!currentSubmission) return;
            var s = currentSubmission.status;
            if (s !== 'draft' && s !== 'returned') {
                steleAlert('Cette soumission ne peut pas \u00eatre soumise (statut: ' + (STATUS_LABELS[s] || s) + ').');
                return;
            }
            const rows = document.querySelectorAll('.calc-row');
            if (rows.length === 0) {
                steleAlert('Veuillez ajouter au moins un article au calculateur.');
                return;
            }
            document.getElementById('projectDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('projectDescription').value = '';
            // Titre du modal adapté
            document.getElementById('submitModalTitle').textContent = canApproveQuotes
                ? 'Approuver & soumettre la soumission #' + currentSubmission.submission_number
                : 'Soumettre la soumission #' + currentSubmission.submission_number;
            document.getElementById('btnSend').textContent = canApproveQuotes ? 'Approuver & Soumettre' : 'Soumettre';
            document.getElementById('sendStatus').style.display = 'none';
            document.getElementById('pdfModal').classList.add('active');
        }

        // Legacy alias
        function openPdfModal() { openSubmitModal(); }

        function closePdfModal() {
            document.getElementById('pdfModal').classList.remove('active');
        }

        document.addEventListener('click', function(e) {
            if (e.target === document.getElementById('pdfModal')) closePdfModal();
            if (e.target === document.getElementById('proposerModal')) closeProposerModal();
        });

        // ═══════════════════════════════════════════════════════════════════════
        // GESTION DES IMAGES
        // ═══════════════════════════════════════════════════════════════════════

        // ── Chargement dynamique des librairies ──
        var cropperLoaded = false;
        var pdfJsLoaded = false;
        var currentCropper = null;
        var cropState = {}; // { groupId, originalBlob, existingMediaId, ratio }

        function loadCropperLib() {
            if (cropperLoaded) return Promise.resolve();
            return new Promise(function(resolve, reject) {
                var link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = 'https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.css';
                document.head.appendChild(link);
                var script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.js';
                script.onload = function() { cropperLoaded = true; resolve(); };
                script.onerror = function() { reject(new Error('Impossible de charger Cropper.js')); };
                document.head.appendChild(script);
            });
        }

        function loadPdfLib() {
            if (pdfJsLoaded) return Promise.resolve();
            return new Promise(function(resolve, reject) {
                var script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
                script.onload = function() {
                    window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                    pdfJsLoaded = true;
                    resolve();
                };
                script.onerror = function() { reject(new Error('Impossible de charger pdf.js')); };
                document.head.appendChild(script);
            });
        }

        function convertPdfToImage(file) {
            return new Promise(function(resolve, reject) {
                var reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        var pdf = await window.pdfjsLib.getDocument({ data: new Uint8Array(e.target.result) }).promise;
                        var page = await pdf.getPage(1);
                        var scale = 300 / 72; // 300 DPI
                        var viewport = page.getViewport({ scale: scale });
                        var canvas = document.createElement('canvas');
                        canvas.width = viewport.width;
                        canvas.height = viewport.height;
                        await page.render({ canvasContext: canvas.getContext('2d'), viewport: viewport }).promise;
                        canvas.toBlob(function(blob) {
                            resolve(blob);
                        }, 'image/jpeg', 0.92);
                    } catch (err) {
                        reject(err);
                    }
                };
                reader.readAsArrayBuffer(file);
            });
        }

        // ── Crop Modal ──
        function openCropModal(imageBlob, groupId, existingMediaId) {
            cropState = { groupId: groupId, originalBlob: imageBlob, existingMediaId: existingMediaId || null, ratio: '4:3' };
            var url = URL.createObjectURL(imageBlob);
            var imgEl = document.getElementById('cropImage');
            var modal = document.getElementById('cropModal');
            var errEl = document.getElementById('cropError');
            errEl.style.display = 'none';

            // Check dimensions
            var testImg = new Image();
            testImg.onload = async function() {
                document.getElementById('cropDimensions').textContent = testImg.width + ' × ' + testImg.height + ' px';
                if (testImg.width < 800 || testImg.height < 600) {
                    errEl.textContent = 'Image trop petite pour une présentation professionnelle (minimum 800×600). Celle-ci fait ' + testImg.width + '×' + testImg.height + '.';
                    errEl.style.display = 'block';
                    imgEl.src = url;
                    modal.classList.add('active');
                    document.getElementById('cropConfirmBtn').disabled = true;
                    return;
                }
                document.getElementById('cropConfirmBtn').disabled = false;
                imgEl.src = url;
                modal.classList.add('active');

                await loadCropperLib();
                if (currentCropper) { currentCropper.destroy(); currentCropper = null; }
                currentCropper = new Cropper(imgEl, {
                    aspectRatio: 4 / 3,
                    viewMode: 1,
                    autoCropArea: 0.9,
                    responsive: true,
                    background: false
                });
                // Reset ratio buttons
                document.getElementById('cropRatio43').classList.add('active');
                document.getElementById('cropRatio11').classList.remove('active');
            };
            testImg.src = url;
        }

        function setCropRatio(ratio) {
            cropState.ratio = ratio;
            document.getElementById('cropRatio43').classList.toggle('active', ratio === '4:3');
            document.getElementById('cropRatio11').classList.toggle('active', ratio === '1:1');
            if (currentCropper) {
                currentCropper.setAspectRatio(ratio === '1:1' ? 1 : 4 / 3);
            }
        }

        async function confirmCrop() {
            if (!currentCropper) return;
            var confirmBtn = document.getElementById('cropConfirmBtn');
            confirmBtn.disabled = true;
            confirmBtn.textContent = 'Upload...';

            try {
                var croppedCanvas = currentCropper.getCroppedCanvas({ maxWidth: 2048, maxHeight: 2048, imageSmoothingQuality: 'high' });
                var cropData = currentCropper.getData(true); // rounded
                var croppedBlob = await new Promise(function(resolve) {
                    croppedCanvas.toBlob(function(b) { resolve(b); }, 'image/jpeg', 0.88);
                });

                await uploadToStorage(cropState.originalBlob, croppedBlob, cropState.groupId, cropState.ratio, cropData, cropState.existingMediaId);
                closeCropModal();
            } catch (err) {
                console.error('Crop/upload error:', err);
                alert('Erreur lors de l\'upload : ' + err.message);
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Valider';
            }
        }

        function cancelCrop() {
            closeCropModal();
        }

        function closeCropModal() {
            var modal = document.getElementById('cropModal');
            modal.classList.remove('active');
            if (currentCropper) { currentCropper.destroy(); currentCropper = null; }
            var imgEl = document.getElementById('cropImage');
            if (imgEl.src.startsWith('blob:')) URL.revokeObjectURL(imgEl.src);
            imgEl.src = '';
            var resolve = cropState._resolve;
            cropState = {};
            if (resolve) resolve(); // continue to next image in queue
        }

        // ── Upload vers Supabase Storage + insert room_media ──
        async function uploadToStorage(originalBlob, croppedBlob, groupId, ratio, cropData, existingMediaId) {
            var roomId = roomMap[groupId];
            if (!roomId) throw new Error('Room non sauvegardée');
            var ts = Date.now();

            // Upload original (skip if recrop — original already exists)
            var originalUrl;
            if (existingMediaId) {
                // Recrop: find existing media to get original URL
                var existing = (groupImages[groupId] || []).find(function(img) { return img.mediaId === existingMediaId; });
                originalUrl = existing ? existing.originalUrl : null;
                if (!originalUrl) throw new Error('Original introuvable');
            } else {
                var origPath = 'originals/' + roomId + '/' + ts + '.jpg';
                var origResp = await authenticatedFetch(SUPABASE_URL + '/storage/v1/object/room-images/' + origPath, {
                    method: 'POST',
                    headers: { 'Content-Type': 'image/jpeg', 'x-upsert': 'true' },
                    body: originalBlob
                });
                if (!origResp.ok) throw new Error('Upload original échoué: ' + origResp.status);
                originalUrl = SUPABASE_URL + '/storage/v1/object/public/room-images/' + origPath;
            }

            // Upload cropped
            var cropPath = 'cropped/' + roomId + '/' + ts + '_' + ratio.replace(':', 'x') + '.jpg';
            var cropResp = await authenticatedFetch(SUPABASE_URL + '/storage/v1/object/room-images/' + cropPath, {
                method: 'POST',
                headers: { 'Content-Type': 'image/jpeg', 'x-upsert': 'true' },
                body: croppedBlob
            });
            if (!cropResp.ok) throw new Error('Upload crop échoué: ' + cropResp.status);
            var croppedUrl = SUPABASE_URL + '/storage/v1/object/public/room-images/' + cropPath;

            if (existingMediaId) {
                // Recrop: update existing record
                var oldMedia = (groupImages[groupId] || []).find(function(img) { return img.mediaId === existingMediaId; });
                // Delete old cropped file
                if (oldMedia && oldMedia.url) {
                    var oldPath = oldMedia.url.split('/room-images/')[1];
                    if (oldPath) {
                        authenticatedFetch(SUPABASE_URL + '/storage/v1/object/room-images/' + oldPath, { method: 'DELETE' }).catch(function() {});
                    }
                }
                await authenticatedFetch(SUPABASE_URL + '/rest/v1/room_media?id=eq.' + existingMediaId, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                    body: JSON.stringify({ cropped_url: croppedUrl, crop_ratio: ratio, crop_data: cropData })
                });
                // Update in memory
                if (oldMedia) { oldMedia.url = croppedUrl; oldMedia.cropRatio = ratio; }
            } else {
                // New image: insert record
                var sortOrder = (groupImages[groupId] || []).length;
                var insResp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/room_media', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                    body: JSON.stringify({
                        room_id: roomId,
                        original_url: originalUrl,
                        cropped_url: croppedUrl,
                        crop_ratio: ratio,
                        crop_data: cropData,
                        tags: ['presentation_soumission'],
                        sort_order: sortOrder
                    })
                });
                if (!insResp.ok) throw new Error('Insert room_media échoué: ' + insResp.status);
                var inserted = await insResp.json();
                var mediaId = Array.isArray(inserted) ? inserted[0].id : inserted.id;

                if (!groupImages[groupId]) groupImages[groupId] = [];
                groupImages[groupId].push({
                    name: 'photo_' + ts + '.jpg',
                    url: croppedUrl,
                    originalUrl: originalUrl,
                    mediaId: mediaId,
                    tags: ['presentation_soumission'],
                    cropRatio: ratio,
                    isLegacy: false,
                    showInQuote: true // compat
                });
            }

            renderGroupImagePreviews(groupId);
            showSaveIndicator();
        }

        // ── Recrop depuis l'original ──
        async function recropImage(groupId, index) {
            var img = (groupImages[groupId] || [])[index];
            if (!img || img.isLegacy || !img.originalUrl) return;
            try {
                var resp = await fetch(img.originalUrl);
                if (!resp.ok) throw new Error('Fetch original failed');
                var blob = await resp.blob();
                openCropModal(blob, groupId, img.mediaId);
            } catch (err) {
                console.error('Recrop error:', err);
                alert('Impossible de charger l\'image originale.');
            }
        }

        function compressImage(file, maxWidth, quality) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        if (w > maxWidth) { h = Math.round(h * maxWidth / w); w = maxWidth; }
                        canvas.width = w; canvas.height = h;
                        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // ═══════════════════════════════════════════════════════════════════════
        // IMAGES PAR MEUBLE (dans le calculateur)
        // ═══════════════════════════════════════════════════════════════════════

        function setupGroupImageHandlers(groupId) {
            const dropZone = document.getElementById(`${groupId}-imgDrop`);
            const fileInput = document.getElementById(`${groupId}-imgInput`);
            if (!dropZone || !fileInput) return;

            dropZone.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => { handleGroupImageFiles(groupId, e.target.files); fileInput.value = ''; });

            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
            dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('dragover'); });
            dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); handleGroupImageFiles(groupId, e.dataTransfer.files); });

            // Paste: écouter sur le groupe entier
            const groupEl = document.getElementById(groupId);
            groupEl.addEventListener('paste', (e) => {
                const files = [];
                for (let i = 0; i < e.clipboardData.items.length; i++) {
                    if (e.clipboardData.items[i].type.startsWith('image/')) files.push(e.clipboardData.items[i].getAsFile());
                }
                if (files.length > 0) { e.preventDefault(); e.stopPropagation(); handleGroupImageFiles(groupId, files); }
            });
        }

        async function handleGroupImageFiles(groupId, files) {
            if (!groupImages[groupId]) groupImages[groupId] = [];
            var remaining = MAX_GROUP_IMAGES - groupImages[groupId].length;
            if (remaining <= 0) { alert('Maximum ' + MAX_GROUP_IMAGES + ' images atteint.'); return; }

            var validFiles = Array.from(files).slice(0, remaining);
            // Process one at a time (crop modal is sequential)
            for (var i = 0; i < validFiles.length; i++) {
                var file = validFiles[i];
                var blob;

                if (file.type === 'application/pdf') {
                    // PDF → image conversion
                    try {
                        await loadPdfLib();
                        blob = await convertPdfToImage(file);
                    } catch (err) {
                        console.error('PDF conversion error:', err);
                        alert('Erreur de conversion PDF : ' + err.message);
                        continue;
                    }
                } else if (file.type.startsWith('image/')) {
                    blob = file;
                } else {
                    continue; // skip unsupported
                }

                // Open crop modal (awaits user action)
                await new Promise(function(resolve) {
                    openCropModal(blob, groupId, null);
                    cropState._resolve = resolve; // must be after openCropModal which resets cropState
                });
            }
        }

        function renderGroupImagePreviews(groupId) {
            const container = document.getElementById(`${groupId}-imgPreviews`);
            const countEl = document.getElementById(`${groupId}-imgCount`);
            const dropZone = document.getElementById(`${groupId}-imgDrop`);
            if (!container) return;

            const imgs = groupImages[groupId] || [];
            container.innerHTML = '';
            imgs.forEach((img, index) => {
                const item = document.createElement('div');
                item.className = 'image-preview-item';
                var imgSrc = img.isLegacy ? img.dataUrl : (img.url || img.dataUrl);
                var checkedAttr = img.showInQuote ? 'checked' : '';
                var recropAttr = (!img.isLegacy && img.originalUrl) ? ` onclick="recropImage('${escapeAttr(groupId)}', ${index})" style="cursor:pointer;" title="Cliquer pour recadrer"` : ` ondblclick="openLightbox(this.src)" title="Double-cliquer pour agrandir"`;
                item.innerHTML = `<img src="${imgSrc}" alt="${escapeAttr(img.name)}"${recropAttr}><button class="image-preview-remove" onclick="removeGroupImage('${escapeAttr(groupId)}', ${index})" title="Supprimer">&times;</button><label class="image-quote-toggle" title="Afficher dans la soumission client"><input type="checkbox" ${checkedAttr} onchange="toggleImageShowInQuote('${escapeAttr(groupId)}', ${index}, this.checked)"><span>Client</span></label>`;
                container.appendChild(item);
            });
            if (countEl) countEl.textContent = imgs.length > 0 ? imgs.length + ' / ' + MAX_GROUP_IMAGES + ' image(s)' : '';
            if (dropZone) dropZone.style.display = imgs.length >= MAX_GROUP_IMAGES ? 'none' : '';
        }

        async function removeGroupImage(groupId, index) {
            if (!groupImages[groupId]) return;
            var img = groupImages[groupId][index];
            if (!img) return;

            if (!img.isLegacy && img.mediaId) {
                // Delete from room_media table
                try {
                    await authenticatedFetch(SUPABASE_URL + '/rest/v1/room_media?id=eq.' + img.mediaId, { method: 'DELETE' });
                } catch (e) { console.error('Delete room_media error:', e); }
                // Delete files from Storage (best effort)
                try {
                    if (img.url) {
                        var croppedPath = img.url.split('/room-images/')[1];
                        if (croppedPath) authenticatedFetch(SUPABASE_URL + '/storage/v1/object/room-images/' + croppedPath, { method: 'DELETE' }).catch(function(){});
                    }
                    if (img.originalUrl) {
                        var origPath = img.originalUrl.split('/room-images/')[1];
                        if (origPath) authenticatedFetch(SUPABASE_URL + '/storage/v1/object/room-images/' + origPath, { method: 'DELETE' }).catch(function(){});
                    }
                } catch (e) { console.error('Delete storage files error:', e); }
            }

            groupImages[groupId].splice(index, 1);
            renderGroupImagePreviews(groupId);
            // Only save to JSONB if there are legacy images
            if (img.isLegacy) saveGroupImages(groupId);
            showSaveIndicator();
        }

        const debouncedSaveGroupImages = debounce(function(groupId) {
            if (!roomMap[groupId]) return;
            // Only save legacy (Base64) images to JSONB — new images are in room_media table
            const legacyImgs = (groupImages[groupId] || []).filter(img => img.isLegacy);
            const imgs = legacyImgs.map(img => ({ name: img.name, dataUrl: img.dataUrl, showInQuote: !!img.showInQuote }));
            updateRoom(roomMap[groupId], { images: imgs });
            showSaveIndicator();
        }, 1000);

        function saveGroupImages(groupId) {
            debouncedSaveGroupImages(groupId);
        }

        function saveExclusions() {
            if (!currentSubmission) return;
            var el = document.getElementById('exclusionsText');
            if (!el) return;
            updateSubmission(currentSubmission.id, { exclusions: el.value });
            showSaveIndicator();
        }

        function saveClientDescription(groupId) {
            if (!roomMap[groupId]) return;
            var textarea = document.getElementById(groupId + '-clientDesc');
            if (!textarea) return;
            // Plain text from calculator — clear HTML cache + stale EN
            roomDescHTML[groupId] = '';
            if (roomDescEN[groupId]) {
                roomDescEN[groupId] = '';
                updateRoom(roomMap[groupId], { client_description: textarea.value, client_description_en: '' });
            } else {
                updateRoom(roomMap[groupId], { client_description: textarea.value });
            }
            showSaveIndicator();
        }

        async function toggleImageShowInQuote(groupId, index, checked) {
            if (!groupImages[groupId] || !groupImages[groupId][index]) return;
            var img = groupImages[groupId][index];
            img.showInQuote = checked;

            if (!img.isLegacy && img.mediaId) {
                // Update tags in room_media
                var newTags = checked
                    ? Array.from(new Set((img.tags || []).concat(['presentation_soumission'])))
                    : (img.tags || []).filter(function(t) { return t !== 'presentation_soumission'; });
                img.tags = newTags;
                try {
                    await authenticatedFetch(SUPABASE_URL + '/rest/v1/room_media?id=eq.' + img.mediaId, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                        body: JSON.stringify({ tags: newTags })
                    });
                } catch (e) { console.error('Update room_media tags error:', e); }
                showSaveIndicator();
            } else {
                saveGroupImages(groupId);
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // ENVOI DE L'ESTIMATION
        // ═══════════════════════════════════════════════════════════════════════

        function collecterDonneesCalculateur() {
            const groups = document.querySelectorAll('.furniture-group');
            const meubles = [];
            let grandTotal = 0;

            groups.forEach(group => {
                const nameInput = group.querySelector('.furniture-name-input');
                const meubleName = nameInput ? (nameInput.value.trim() || 'Sans nom') : 'Sans nom';
                const items = [];
                let subtotal = 0;

                group.querySelectorAll('.calc-row').forEach(row => {
                    const select = row.querySelector('.item-select');
                    const qtyInput = row.querySelector('.qty-input');
                    if (!select || !qtyInput || !select.value) return;

                    const selectedId = select.value;
                    const qty = parseFloat(qtyInput.value) || 0;

                    if (selectedId === '__AJOUT__') {
                        const descInput = row.querySelector('.ajout-description');
                        const priceInput = row.querySelector('.ajout-price');
                        const markupInput = row.querySelector('.ajout-markup');
                        if (descInput && priceInput && markupInput) {
                            const price = parseFloat(priceInput.value) || 0;
                            const markup = parseFloat(markupInput.value) || 0;
                            const lineTotal = price * qty * (1 + markup / 100);
                            subtotal += lineTotal;
                            items.push({ type: 'ajout', description: descInput.value || 'Ajout sans description', unitPrice: formatPrice(price), qty: qty, markup: markup, lineTotal: formatPrice(lineTotal) });
                        }
                    } else {
                        const item = CATALOGUE_DATA.find(i => i.id === selectedId);
                        if (item) {
                            const lineTotal = (item.price || 0) * qty;
                            subtotal += lineTotal;
                            items.push({ type: 'catalogue', code: item.id, description: item.description, itemType: item.type, unitPrice: formatPrice(item.price), qty: qty, lineTotal: formatPrice(lineTotal) });
                        }
                    }
                });

                if (items.length > 0) {
                    grandTotal += subtotal;
                    const groupId = group.id;
                    const imgs = (groupImages[groupId] || []).map(img => ({
                        name: img.name,
                        mimeType: img.dataUrl.match(/^data:(.*?);/)?.[1] || 'image/jpeg',
                        data: img.dataUrl.split(',')[1]
                    }));
                    meubles.push({ name: meubleName, items: items, subtotal: formatPrice(subtotal), images: imgs });
                }
            });

            var result = { meubles: meubles, total: formatPrice(grandTotal) };
            if (currentSubmission) {
                result.submissionNumber = currentSubmission.submission_number;
                result.submissionTitle = currentSubmission.title;
            }
            return result;
        }

        function showSendStatus(message, isError) {
            const statusEl = document.getElementById('sendStatus');
            statusEl.style.display = 'block';
            statusEl.textContent = message;
            statusEl.style.background = isError ? '#ffebee' : '#e8f5e9';
            statusEl.style.color = isError ? '#c62828' : '#2e7d32';
        }

        async function soumettreSoumission() {
            if (!currentSubmission) return;

            const projectDate = document.getElementById('projectDate').value;
            const projectDescription = document.getElementById('projectDescription').value.trim();

            const { meubles, total } = collecterDonneesCalculateur();
            if (meubles.length === 0) { showSendStatus('Aucun article \u00e0 soumettre.', true); return; }

            const btnSend = document.getElementById('btnSend');
            btnSend.disabled = true;
            btnSend.textContent = 'Soumission en cours...';
            showSendStatus('Soumission en cours...', false);

            try {
                // Cr\u00e9er un snapshot avec les notes du modal
                await createVersion(currentSubmission.id);

                // Sauvegarder les notes sur le projet
                if (projectDescription && currentProject) {
                    await updateProject(currentProject.id, { notes: projectDescription });
                }

                var grandTotal = calculerGrandTotal();

                if (canApproveQuotes) {
                    // Auto-approbation
                    await createSubmissionReview(currentSubmission.id, 'approved', projectDescription || 'Auto-approbation');
                    await updateSubmission(currentSubmission.id, {
                        status: 'approved_internal',
                        approved_by: localStorage.getItem('sb_user_id'),
                        approved_at: new Date().toISOString(),
                        approved_total: grandTotal
                    });
                    currentSubmission.status = 'approved_internal';
                    updateStatusBadge('approved_internal');
                    showSendStatus('Soumission approuv\u00e9e!', false);
                } else {
                    // Soumettre pour approbation interne
                    var submitComment = projectDescription || '';
                    if (projectDate) submitComment = 'Date requise: ' + projectDate + (submitComment ? '\n' + submitComment : '');
                    await createSubmissionReview(currentSubmission.id, 'submitted', submitComment || 'Soumis pour approbation');
                    await updateSubmission(currentSubmission.id, {
                        status: 'pending_internal',
                        approved_total: grandTotal
                    });
                    currentSubmission.status = 'pending_internal';
                    updateStatusBadge('pending_internal');
                    showSendStatus('Soumission envoy\u00e9e pour approbation!', false);
                }

                updateWorkflowButtons();
                setEditable(false);
                loadSubmissionReviews(currentSubmission.id);
                btnSend.textContent = 'Soumis!';
                setTimeout(() => {
                    closePdfModal();
                    btnSend.disabled = false;
                    btnSend.textContent = 'Soumettre';
                    document.getElementById('sendStatus').style.display = 'none';
                }, 1500);
            } catch (error) {
                console.error('Erreur soumission:', error);
                showSendStatus('Erreur: ' + error.message, true);
                btnSend.disabled = false;
                btnSend.textContent = 'Soumettre';
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // APERÇU SOUMISSION (PREVIEW VIEW) + BIBLIOTHÈQUE DE CLAUSES
        // ═══════════════════════════════════════════════════════════════════════

        var clauseLibrary = []; // loaded from quote_clauses table
        var clientViewMode = false;
        var currentLang = 'fr';
        var roomDescEN = {}; // { groupDomId: 'english description (HTML)' }
        var roomDescHTML = {}; // { groupDomId: 'HTML description from optimizer' }
        var i18n = {
            fr: {
                soumission: 'Soumission',
                client: 'Client',
                projet: 'Projet',
                designer: 'Designer',
                clausesTitle: 'Clauses du contrat',
                total: 'Total',
                taxes: '+ taxes applicables',
                footer: 'Stele \u2014 \u00c9b\u00e9nisterie sur mesure',
                descPlaceholder: 'Description visible par le client...',
                dropClause: 'Glissez une clause ici',
                biblio: '\u2191 Bib.'
            },
            en: {
                soumission: 'Quote',
                client: 'Client',
                projet: 'Project',
                designer: 'Designer',
                clausesTitle: 'Contract Terms',
                total: 'Total',
                taxes: '+ applicable taxes',
                footer: 'Stele \u2014 Custom Cabinetry',
                descPlaceholder: 'Client-facing description...',
                dropClause: 'Drag a clause here',
                biblio: '\u2191 Lib.'
            }
        };
        function t(key) { return (i18n[currentLang] || i18n.fr)[key] || key; }

        async function openPreview() {
            clientViewMode = false;
            document.getElementById('previewView').classList.remove('pv-client-mode');
            var btn = document.getElementById('btnClientView');
            if (btn) btn.classList.remove('active');
            document.getElementById('calculatorView').classList.remove('active');
            document.getElementById('previewView').classList.add('active');
            await loadClauseLibrary();
            renderPreview();
            renderClauseLibrary();
        }

        function closePreview() {
            document.getElementById('previewView').classList.remove('active');
            document.getElementById('previewView').classList.remove('pv-client-mode');
            document.getElementById('calculatorView').classList.add('active');
            clientViewMode = false;
        }

        function toggleClientView() {
            clientViewMode = !clientViewMode;
            var pv = document.getElementById('previewView');
            var btn = document.getElementById('btnClientView');
            if (clientViewMode) {
                pv.classList.add('pv-client-mode');
                if (btn) { btn.classList.add('active'); btn.textContent = 'Mode \u00e9dition'; }
            } else {
                pv.classList.remove('pv-client-mode');
                if (btn) { btn.classList.remove('active'); btn.textContent = 'Vue client'; }
            }
            renderPreview();
        }

        async function toggleLang() {
            var btn = document.getElementById('btnLang');
            if (currentLang === 'fr') {
                // Switching to EN — check if translation needed
                var stale = collectStaleFrTexts();
                if (stale.length > 0) {
                    if (btn) { btn.disabled = true; btn.textContent = 'Traduction...'; }
                    try {
                        var results = await callEdgeFunction(stale, 'translate');
                        applyTranslations(results);
                        showSaveIndicator();
                    } catch (err) {
                        console.error('Translation error:', err);
                        alert('Erreur de traduction : ' + err.message);
                        if (btn) { btn.disabled = false; btn.textContent = 'EN'; }
                        return; // stay on FR
                    }
                }
                currentLang = 'en';
            } else {
                currentLang = 'fr';
            }
            if (btn) {
                btn.textContent = currentLang === 'fr' ? 'EN' : 'FR';
                btn.classList.toggle('active', currentLang === 'en');
                btn.disabled = false;
            }
            renderPreview();
        }

        // Collect only FR texts that have no EN translation (stale or missing)
        function collectStaleFrTexts() {
            var texts = [];
            var groups = document.querySelectorAll('#calculatorView .furniture-group');
            groups.forEach(function(g) {
                var gid = g.id;
                if (roomDescEN[gid]) return; // already has EN translation
                var frText;
                if (roomDescHTML[gid]) {
                    frText = roomDescHTML[gid];
                } else {
                    var descEl = document.getElementById(gid + '-clientDesc');
                    frText = descEl ? descEl.value.trim() : '';
                }
                if (frText) {
                    texts.push({ key: 'room_' + gid, text: frText });
                }
            });
            var clauses = getSubmissionClauses();
            clauses.forEach(function(c, i) {
                if (c.content && c.content.trim() && !c.content_en) {
                    texts.push({ key: 'clause_' + i, text: c.content });
                }
            });
            return texts;
        }

        // Apply translation results to memory + DB
        function applyTranslations(results) {
            var groups = document.querySelectorAll('#calculatorView .furniture-group');
            groups.forEach(function(g) {
                var gid = g.id;
                var key = 'room_' + gid;
                if (results[key]) {
                    roomDescEN[gid] = results[key];
                    if (roomMap[gid]) {
                        updateRoom(roomMap[gid], { client_description_en: results[key] });
                    }
                }
            });
            var clauses = getSubmissionClauses();
            var updated = clauses.slice();
            var changed = false;
            clauses.forEach(function(c, i) {
                var key = 'clause_' + i;
                if (results[key]) {
                    updated[i].content_en = results[key];
                    changed = true;
                }
            });
            if (changed) saveSubmissionClauses(updated);
        }

        // ── Edge Function helper ──
        async function callEdgeFunction(texts, action) {
            var token = localStorage.getItem('sb_access_token') || '';
            console.log('[AI] Calling edge function:', action, 'with', texts.length, 'texts');
            var resp = await fetch(SUPABASE_URL + '/functions/v1/translate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token,
                    'apikey': SUPABASE_KEY
                },
                body: JSON.stringify({ texts: texts, action: action })
            });
            if (!resp.ok) {
                var errText = await resp.text().catch(function() { return ''; });
                console.error('[AI] Edge function error:', resp.status, errText);
                try { var errObj = JSON.parse(errText); throw new Error(errObj.error || 'Erreur ' + resp.status); }
                catch(e) { if (e.message) throw e; throw new Error('Erreur ' + resp.status + ': ' + errText.substring(0, 200)); }
            }
            var data = await resp.json();
            console.log('[AI] Edge function response:', JSON.stringify(data).substring(0, 500));
            if (!data.translations || Object.keys(data.translations).length === 0) {
                throw new Error('Aucun résultat retourné par l\'AI');
            }
            return data.translations;
        }

        // ── Collect all FR texts (useHtml=true sends HTML for translate, plain for optimize) ──
        function collectFrTexts(useHtml) {
            var texts = [];
            var groups = document.querySelectorAll('#calculatorView .furniture-group');
            groups.forEach(function(g) {
                var gid = g.id;
                var frText;
                if (useHtml && roomDescHTML[gid]) {
                    frText = roomDescHTML[gid]; // HTML for translation
                } else {
                    var descEl = document.getElementById(gid + '-clientDesc');
                    frText = descEl ? descEl.value.trim() : '';
                }
                if (frText) {
                    texts.push({ key: 'room_' + gid, text: frText });
                }
            });
            var clauses = getSubmissionClauses();
            clauses.forEach(function(c, i) {
                if (c.content && c.content.trim()) {
                    texts.push({ key: 'clause_' + i, text: c.content });
                }
            });
            return texts;
        }

        // ── Optimiser tout (FR) ──
        async function optimizeAll() {
            var btn = document.getElementById('btnOptimizeAll');
            if (!btn) return;
            var origText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Optimisation...';

            try {
                var texts = collectFrTexts();
                if (texts.length === 0) { showSaveIndicator(); return; }

                var results = await callEdgeFunction(texts, 'optimize');
                var groups = document.querySelectorAll('#calculatorView .furniture-group');

                // Apply optimized room descriptions (HTML)
                groups.forEach(function(g) {
                    var gid = g.id;
                    var key = 'room_' + gid;
                    if (results[key]) {
                        // Store HTML in memory
                        roomDescHTML[gid] = results[key];
                        if (roomMap[gid]) {
                            updateRoom(roomMap[gid], { client_description: results[key], client_description_en: '' });
                        }
                        // Clear stale EN
                        roomDescEN[gid] = '';
                    }
                });

                // Apply optimized clause texts
                var clauses = getSubmissionClauses();
                var updated = clauses.slice();
                var changed = false;
                clauses.forEach(function(c, i) {
                    var key = 'clause_' + i;
                    if (results[key]) {
                        updated[i].content = results[key];
                        updated[i].content_en = ''; // clear stale EN
                        changed = true;
                    }
                });
                if (changed) await saveSubmissionClauses(updated);

                showSaveIndicator();
                renderPreview();
            } catch (err) {
                console.error('Optimize error:', err);
                alert('Erreur d\'optimisation : ' + err.message);
            } finally {
                btn.disabled = false;
                btn.textContent = origText;
            }
        }

        // ── Optimiser un seul champ (bouton ✨ par champ) ──
        async function optimizeText(btnEl) {
            var gid = btnEl.getAttribute('data-group-id');
            if (!gid) return;
            var descDiv = btnEl.parentElement.querySelector('.pv-page-room-desc');
            if (!descDiv || !descDiv.textContent.trim()) return;

            btnEl.disabled = true;
            var origText = btnEl.textContent;
            btnEl.textContent = '...';

            try {
                // Send plain text to AI, receive HTML back
                var results = await callEdgeFunction(
                    [{ key: 'room_' + gid, text: descDiv.textContent }],
                    'optimize'
                );
                var optimized = results['room_' + gid];
                console.log('[AI] Optimize result for', gid, ':', optimized ? optimized.substring(0, 200) : 'EMPTY');
                if (optimized) {
                    // Save optimized HTML to memory + DB
                    roomDescHTML[gid] = optimized;
                    if (roomMap[gid]) {
                        updateRoom(roomMap[gid], { client_description: optimized, client_description_en: '' });
                    }
                    // Clear stale EN
                    roomDescEN[gid] = '';
                    showSaveIndicator();
                    // Re-render to show optimized HTML
                    renderPreview();
                } else {
                    alert('L\'AI n\'a retourné aucun texte. Vérifiez la console (F12).');
                }
            } catch (err) {
                console.error('Optimize error:', err);
                alert('Erreur d\'optimisation : ' + err.message);
            } finally {
                btnEl.disabled = false;
                btnEl.textContent = origText;
            }
        }

        // ── Traduire tout (FR → EN) ──

        function removePreviewImage(groupId, index) {
            removeGroupImage(groupId, index);
            renderPreview();
        }

        // ── Clause Library CRUD ──

        async function loadClauseLibrary() {
            try {
                var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/quote_clauses?order=sort_order.asc,title.asc&select=*', {});
                if (r.ok) clauseLibrary = await r.json();
            } catch (e) { console.error('loadClauseLibrary error:', e); }
        }

        function renderClauseLibrary() {
            var container = document.getElementById('pvClauseList');
            if (!container) return;

            if (clauseLibrary.length === 0) {
                container.innerHTML = '<p class="pv-clause-empty">Aucune clause dans la biblioth\u00e8que. Cliquez + pour en cr\u00e9er.</p>';
                return;
            }

            var html = '';
            clauseLibrary.forEach(function(clause, idx) {
                html += '<div class="pv-clause-item" draggable="true" data-clause-idx="' + idx + '"';
                html += ' ondragstart="onClauseDragStart(event, ' + idx + ')">';
                html += '<div class="pv-clause-item-header">';
                html += '<span class="pv-clause-item-title">' + escapeHtml(clause.title) + '</span>';
                html += '<span class="pv-clause-item-btns">';
                html += '<button class="pv-clause-item-btn" onclick="showClauseEditor(\'' + clause.id + '\')" title="Modifier">\u270E</button>';
                html += '<button class="pv-clause-item-btn delete" onclick="deleteLibraryClause(\'' + clause.id + '\')" title="Supprimer">\u2715</button>';
                html += '</span>';
                html += '</div>';
                var preview = (clause.content_fr || '').substring(0, 120);
                if (preview) html += '<div class="pv-clause-item-preview">' + escapeHtml(preview) + '</div>';
                html += '</div>';
            });
            container.innerHTML = html;
        }

        function showClauseEditor(clauseId) {
            var zone = document.getElementById('pvClauseEditZone');
            if (!zone) return;

            var clause = clauseId ? clauseLibrary.find(function(c) { return c.id === clauseId; }) : null;
            var isNew = !clause;

            zone.innerHTML = '<div class="pv-clause-edit">' +
                '<label>Titre</label>' +
                '<input type="text" id="ceTitle" value="' + escapeAttr(clause ? clause.title : '') + '" placeholder="Ex: Dessins d\'atelier">' +
                '<label>Contenu</label>' +
                '<textarea id="ceFr" rows="5" placeholder="Texte de la clause...">' + escapeHtml(clause ? clause.content_fr : '') + '</textarea>' +
                '<div class="pv-clause-edit-btns">' +
                '<button class="cancel" onclick="closeClauseEditor()">Annuler</button>' +
                '<button class="save" onclick="saveLibraryClause(' + (isNew ? 'null' : "'" + clauseId + "'") + ')">' + (isNew ? 'Cr\u00e9er' : 'Sauvegarder') + '</button>' +
                '</div></div>';

            zone.querySelector('#ceTitle').focus();
        }

        function closeClauseEditor() {
            var zone = document.getElementById('pvClauseEditZone');
            if (zone) zone.innerHTML = '';
        }

        async function saveLibraryClause(clauseId) {
            var title = document.getElementById('ceTitle').value.trim();
            var fr = document.getElementById('ceFr').value.trim();
            if (!title) { document.getElementById('ceTitle').focus(); return; }

            var payload = { title: title, content_fr: fr };

            try {
                var r;
                if (clauseId) {
                    r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/quote_clauses?id=eq.' + clauseId, {
                        method: 'PATCH', headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                        body: JSON.stringify(payload)
                    });
                } else {
                    r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/quote_clauses', {
                        method: 'POST', headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                        body: JSON.stringify(payload)
                    });
                }

                if (r.ok) {
                    closeClauseEditor();
                    await loadClauseLibrary();
                    renderClauseLibrary();
                    showSaveIndicator();
                }
            } catch (e) { console.error('saveLibraryClause error:', e); }
        }

        async function deleteLibraryClause(clauseId) {
            if (!confirm('Supprimer cette clause de la biblioth\u00e8que ?')) return;
            try {
                var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/quote_clauses?id=eq.' + clauseId, { method: 'DELETE' });
                if (r.ok) {
                    await loadClauseLibrary();
                    renderClauseLibrary();
                    showSaveIndicator();
                }
            } catch (e) { console.error('deleteLibraryClause error:', e); }
        }

        // ── Submission Clauses (JSONB on submissions) ──

        function getSubmissionClauses() {
            if (!currentSubmission) return [];
            return currentSubmission.clauses || [];
        }

        async function saveSubmissionClauses(clauses) {
            if (!currentSubmission) return;
            currentSubmission.clauses = clauses;
            await updateSubmission(currentSubmission.id, { clauses: clauses });
            showSaveIndicator();
        }

        async function addClauseToSubmission(clauseIdx) {
            var lib = clauseLibrary[clauseIdx];
            if (!lib) return;
            var clauses = getSubmissionClauses().slice();
            // Avoid duplicate by id
            if (clauses.some(function(c) { return c.clause_id === lib.id; })) return;
            clauses.push({
                clause_id: lib.id,
                title: lib.title,
                content: lib.content_fr,
                content_en: lib.content_en || '',
                sort_order: clauses.length
            });
            await saveSubmissionClauses(clauses);
            renderPreview();
        }

        async function removeClauseFromSubmission(idx) {
            var clauses = getSubmissionClauses().slice();
            clauses.splice(idx, 1);
            // Re-index sort_order
            clauses.forEach(function(c, i) { c.sort_order = i; });
            await saveSubmissionClauses(clauses);
            renderPreview();
        }

        async function updateClauseText(idx, newText) {
            var clauses = getSubmissionClauses().slice();
            if (clauses[idx]) {
                clauses[idx].content = newText;
                await saveSubmissionClauses(clauses);
            }
        }

        async function updateClauseTextEN(idx, newText) {
            var clauses = getSubmissionClauses().slice();
            if (clauses[idx]) {
                clauses[idx].content_en = newText;
                await saveSubmissionClauses(clauses);
            }
        }

        async function saveClauseBackToLibrary(idx) {
            var clauses = getSubmissionClauses();
            var c = clauses[idx];
            if (!c) return;

            // If came from library, update it; otherwise create new
            if (c.clause_id) {
                var existing = clauseLibrary.find(function(lib) { return lib.id === c.clause_id; });
                if (existing) {
                    await authenticatedFetch(SUPABASE_URL + '/rest/v1/quote_clauses?id=eq.' + c.clause_id, {
                        method: 'PATCH', headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                        body: JSON.stringify({ title: c.title, content_fr: c.content, content_en: c.content_en || '' })
                    });
                    await loadClauseLibrary();
                    renderClauseLibrary();
                    showSaveIndicator();
                    return;
                }
            }

            // Create new in library
            await authenticatedFetch(SUPABASE_URL + '/rest/v1/quote_clauses', {
                method: 'POST', headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                body: JSON.stringify({ title: c.title, content_fr: c.content, content_en: c.content_en || '' })
            });
            await loadClauseLibrary();
            renderClauseLibrary();
            showSaveIndicator();
        }

        // ── Drag and Drop ──

        var draggedClauseIdx = null;

        function onClauseDragStart(e, idx) {
            draggedClauseIdx = idx;
            e.dataTransfer.effectAllowed = 'copy';
            e.dataTransfer.setData('text/plain', idx.toString());
            e.target.classList.add('dragging');
            setTimeout(function() { e.target.classList.remove('dragging'); }, 200);
        }

        function onClauseDropZoneDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
            e.currentTarget.classList.add('drag-over');
        }

        function onClauseDropZoneDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function onClauseDropZoneDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            var idx = parseInt(e.dataTransfer.getData('text/plain'), 10);
            if (!isNaN(idx)) addClauseToSubmission(idx);
            draggedClauseIdx = null;
        }

        // ── Render Preview ──

        function renderPreview() {
            var container = document.getElementById('pvContent');
            var subLabel = document.getElementById('pvSubNumber');
            if (!container) return;

            if (subLabel && currentSubmission) {
                subLabel.textContent = t('soumission') + ' #' + (currentSubmission.submission_number || '');
            }

            var html = '';
            var editable = currentSubmission && (currentSubmission.status === 'draft' || currentSubmission.status === 'returned');

            // ── Page 1: Title ──
            var subNum = currentSubmission ? currentSubmission.submission_number : '';
            var subDate = '';
            if (currentSubmission) {
                var d = currentSubmission.sent_at || currentSubmission.approved_at || currentSubmission.created_at;
                if (d) {
                    var dt = new Date(d);
                    var loc = currentLang === 'en' ? 'en-CA' : 'fr-CA';
                    subDate = dt.toLocaleDateString(loc, { year: 'numeric', month: 'long', day: 'numeric' });
                }
            }
            html += '<div class="pv-page pv-page-title">';
            html += '<img class="pv-logo" src="https://rplzbtjfnwahqodrhpny.supabase.co/storage/v1/object/public/assets/stele_logo_noir.png" alt="Stele">';
            html += '<div class="pv-sub-number">' + t('soumission') + ' #' + escapeHtml(subNum + '') + '</div>';
            if (subDate) html += '<div class="pv-sub-date">' + escapeHtml(subDate) + '</div>';
            if (currentProject) {
                html += '<div class="pv-client-name">' + escapeHtml(currentProject.client_name || '') + '</div>';
                if (currentProject.client_address) html += '<div class="pv-client-address">' + escapeHtml(currentProject.client_address) + '</div>';
                html += '<div class="pv-project-name">' + escapeHtml(currentProject.name || '') + '</div>';
                if (currentProject.designer) html += '<div class="pv-designer">' + t('designer') + ' : ' + escapeHtml(currentProject.designer) + '</div>';
            }
            html += '</div>';

            // ── Room pages (one per room) — text left, images right ──
            var grandTotal = 0;
            var groups = document.querySelectorAll('#calculatorView .furniture-group');
            groups.forEach(function(group) {
                var groupId = group.id;
                var nameInput = group.querySelector('.furniture-name-input');
                var roomName = nameInput ? nameInput.value : 'Sans nom';

                var subtotal = 0;
                group.querySelectorAll('.calc-row').forEach(function(row) {
                    subtotal += getRowTotal(row);
                });
                grandTotal += subtotal;

                var allImgs = groupImages[groupId] || [];
                var imgs = clientViewMode ? allImgs.filter(function(img) { return img.showInQuote; }) : allImgs;
                var descEl = document.getElementById(groupId + '-clientDesc');
                var descPlain = descEl ? descEl.value : '';
                var descFr = roomDescHTML[groupId] || descPlain;
                var descEn = roomDescEN[groupId] || '';
                var desc = currentLang === 'en' ? (descEn || descFr) : descFr;
                var hasImages = imgs.length > 0;

                html += '<div class="pv-page" data-group-id="' + escapeAttr(groupId) + '">';
                html += '<div class="pv-page-room-header"><span class="pv-page-room-name">' + escapeHtml(roomName) + '</span><span class="pv-page-room-subtotal">' + formatPrice(subtotal) + '</span></div>';
                html += '<div class="pv-page-room-body">';

                // Left column: description
                if (hasImages) {
                    html += '<div class="pv-page-room-text" style="position:relative;">';
                    if (editable && currentLang === 'fr') {
                        html += '<button class="pv-optimize-btn" onclick="optimizeText(this)" data-group-id="' + escapeAttr(groupId) + '">&#10024;</button>';
                    }
                    html += '<div class="pv-page-room-desc" data-group-id="' + escapeAttr(groupId) + '"';
                    html += ' data-placeholder="' + escapeAttr(t('descPlaceholder')) + '"';
                    html += ' contenteditable="' + (editable ? 'true' : 'false') + '">';
                    html += textToHtml(desc);
                    html += '</div>';
                    html += '</div>';

                    // Right column: images
                    var mediaCols = imgs.length === 1 ? ' cols-1' : '';
                    html += '<div class="pv-page-room-media' + mediaCols + '">';
                    imgs.forEach(function(img) {
                        var realIdx = allImgs.indexOf(img);
                        var imgSrc = img.isLegacy ? img.dataUrl : (img.url || img.dataUrl);
                        html += '<div class="pv-img-wrap">';
                        html += '<img src="' + imgSrc + '" alt="' + escapeAttr(img.name) + '" onclick="openLightbox(this.src)">';
                        if (editable && !clientViewMode) {
                            html += '<button class="pv-img-delete" onclick="removePreviewImage(\'' + escapeAttr(groupId) + '\', ' + realIdx + ')" title="Supprimer">&times;</button>';
                        }
                        if (img.showInQuote && !clientViewMode) {
                            html += '<span class="pv-img-badge-client">Client</span>';
                        }
                        html += '</div>';
                    });
                    html += '</div>';
                } else {
                    // No images — description takes full width
                    html += '<div class="pv-page-room-text" style="flex:1; position:relative;">';
                    if (editable && currentLang === 'fr') {
                        html += '<button class="pv-optimize-btn" onclick="optimizeText(this)" data-group-id="' + escapeAttr(groupId) + '">&#10024;</button>';
                    }
                    html += '<div class="pv-page-room-desc" data-group-id="' + escapeAttr(groupId) + '"';
                    html += ' data-placeholder="' + escapeAttr(t('descPlaceholder')) + '"';
                    html += ' contenteditable="' + (editable ? 'true' : 'false') + '">';
                    html += textToHtml(desc);
                    html += '</div>';
                    html += '</div>';
                }

                html += '</div></div>';
            });

            // ── Clauses page (compact) ──
            var subClauses = getSubmissionClauses();
            if (subClauses.length > 0 || editable) {
                html += '<div class="pv-page">';
                html += '<div class="pv-page-clauses-header">' + t('clausesTitle') + '</div>';
                html += '<div class="pv-page-clauses-body">';

                subClauses.forEach(function(clause, idx) {
                    html += '<div class="pv-page-clause" data-clause-idx="' + idx + '">';
                    html += '<div class="pv-page-clause-title">' + escapeHtml(clause.title) + '</div>';
                    var clauseText = currentLang === 'en' ? (clause.content_en || clause.content || '') : (clause.content || '');
                    html += '<textarea class="pv-page-clause-text" data-clause-idx="' + idx + '"';
                    html += ' rows="2"' + (editable ? '' : ' disabled') + '>' + escapeHtml(clauseText) + '</textarea>';
                    if (editable) {
                        html += '<div class="pv-page-clause-actions">';
                        html += '<button class="pv-doc-clause-btn save-lib" onclick="saveClauseBackToLibrary(' + idx + ')" title="Sauvegarder dans la biblioth\u00e8que">' + t('biblio') + '</button>';
                        html += '<button class="pv-doc-clause-btn remove" onclick="removeClauseFromSubmission(' + idx + ')" title="Retirer">\u2715</button>';
                        html += '</div>';
                    }
                    html += '</div>';
                });

                if (editable) {
                    html += '<div class="pv-clause-dropzone" id="pvClauseDropZone"';
                    html += ' ondragover="onClauseDropZoneDragOver(event)"';
                    html += ' ondragleave="onClauseDropZoneDragLeave(event)"';
                    html += ' ondrop="onClauseDropZoneDrop(event)">';
                    html += t('dropClause');
                    html += '</div>';
                }

                html += '</div></div>';
            }

            // ── Total page (last) ──
            html += '<div class="pv-page pv-page-total">';
            html += '<div class="pv-total-box">';
            html += '<div class="total-label">' + t('total') + '</div>';
            html += '<div class="total-amount">' + formatPrice(grandTotal) + '</div>';
            html += '<div class="total-taxes">' + t('taxes') + '</div>';
            html += '</div>';
            html += '<div class="pv-page-footer-text">' + t('footer') + '</div>';
            html += '</div>';

            container.innerHTML = html;
            wirePreviewSaveHandlers();
        }

        function wirePreviewSaveHandlers() {
            // Room descriptions — save HTML to correct lang field + stale detection
            document.querySelectorAll('#pvContent .pv-page-room-desc').forEach(function(el) {
                el.addEventListener('blur', function() {
                    var gid = this.getAttribute('data-group-id');
                    if (!gid || !roomMap[gid]) return;
                    var htmlContent = this.innerHTML.trim();
                    if (currentLang === 'en') {
                        roomDescEN[gid] = htmlContent;
                        updateRoom(roomMap[gid], { client_description_en: htmlContent });
                    } else {
                        roomDescHTML[gid] = htmlContent;
                        updateRoom(roomMap[gid], { client_description: htmlContent });
                        var calcDesc = document.getElementById(gid + '-clientDesc');
                        if (calcDesc) calcDesc.value = this.textContent; // plain text for calc textarea
                        // Stale detection: FR changed → clear EN
                        if (roomDescEN[gid]) {
                            roomDescEN[gid] = '';
                            updateRoom(roomMap[gid], { client_description_en: '' });
                        }
                    }
                    showSaveIndicator();
                });
            });

            // Clause texts — save to correct lang field + stale detection
            document.querySelectorAll('#pvContent .pv-page-clause-text').forEach(function(textarea) {
                textarea.addEventListener('blur', function() {
                    var idx = parseInt(this.getAttribute('data-clause-idx'), 10);
                    if (isNaN(idx)) return;
                    if (currentLang === 'en') {
                        updateClauseTextEN(idx, this.value);
                    } else {
                        updateClauseText(idx, this.value);
                        // Stale detection: FR changed → clear EN
                        var clauses = getSubmissionClauses();
                        if (clauses[idx] && clauses[idx].content_en) {
                            clauses[idx].content_en = '';
                            saveSubmissionClauses(clauses);
                        }
                    }
                });
            });
        }

        // ═══════════════════════════════════════════════════════════════════════
        // MODE PRÉSENTATION (PLEIN ÉCRAN + NAVIGATION PAR PAGE)
        // ═══════════════════════════════════════════════════════════════════════

        var presActive = false;

        function openPresentation() {
            presActive = true;
            // Force client view + render
            clientViewMode = true;
            var pv = document.getElementById('previewView');
            pv.classList.add('pv-client-mode');
            pv.classList.add('pv-fullscreen');
            var btn = document.getElementById('btnClientView');
            if (btn) { btn.classList.add('active'); btn.textContent = 'Mode \u00e9dition'; }
            renderPreview();

            // Request fullscreen on the preview view
            if (pv.requestFullscreen) pv.requestFullscreen();
            else if (pv.webkitRequestFullscreen) pv.webkitRequestFullscreen();
            else if (pv.msRequestFullscreen) pv.msRequestFullscreen();

            document.addEventListener('keydown', presPageNav);
            document.getElementById('pvContent').addEventListener('click', presClickNav);
        }

        function closePresentation() {
            presActive = false;
            var pv = document.getElementById('previewView');
            pv.classList.remove('pv-fullscreen');
            if (document.fullscreenElement) document.exitFullscreen();
            else if (document.webkitFullscreenElement) document.webkitExitFullscreen();
            document.removeEventListener('keydown', presPageNav);
            var pvContent = document.getElementById('pvContent');
            if (pvContent) pvContent.removeEventListener('click', presClickNav);
        }

        function presPageNav(e) {
            if (e.key === 'Escape') { closePresentation(); return; }
            var scrollEl = document.querySelector('#previewView .pv-left');
            if (!scrollEl) return;
            var pages = scrollEl.querySelectorAll('.pv-page');
            if (pages.length === 0) return;

            if (e.key === 'ArrowDown' || e.key === 'Enter' || e.key === ' ' || e.key === 'ArrowRight') {
                e.preventDefault();
                presScrollToNext(scrollEl, pages, 1);
            }
            if (e.key === 'ArrowUp' || e.key === 'Backspace' || e.key === 'ArrowLeft') {
                e.preventDefault();
                presScrollToNext(scrollEl, pages, -1);
            }
        }

        function presClickNav(e) {
            // Don't navigate if clicking on interactive elements
            if (e.target.closest('textarea, button, a, input, .pv-img-wrap')) return;
            var scrollEl = document.querySelector('#previewView .pv-left');
            var pages = scrollEl ? scrollEl.querySelectorAll('.pv-page') : [];
            if (pages.length > 0) presScrollToNext(scrollEl, pages, 1);
        }

        function presScrollToNext(scrollEl, pages, direction) {
            var scrollTop = scrollEl.scrollTop;
            var threshold = 20;
            for (var i = 0; i < pages.length; i++) {
                var top = pages[i].offsetTop - scrollEl.offsetTop;
                if (direction > 0 && top > scrollTop + threshold) {
                    pages[i].scrollIntoView({ behavior: 'smooth', block: 'start' });
                    return;
                }
                if (direction < 0 && i > 0 && top >= scrollTop - threshold) {
                    pages[i - 1].scrollIntoView({ behavior: 'smooth', block: 'start' });
                    return;
                }
            }
            // Edge cases: last page forward or first page backward
            if (direction < 0) pages[0].scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Exit presentation when leaving fullscreen
        document.addEventListener('fullscreenchange', function() {
            if (!document.fullscreenElement && presActive) {
                closePresentation();
            }
        });

        // ═══════════════════════════════════════════════════════════════════════
        // NAVIGATION ENTRE VUES
        // ═══════════════════════════════════════════════════════════════════════

        function showProjectList() {
            document.getElementById('projectListView').classList.add('active');
            document.getElementById('calculatorView').classList.remove('active');
            document.getElementById('previewView').classList.remove('active');
            currentProject = null;
            currentSubmission = null;
            roomMap = {};
            itemMap = {};
            groupImages = {};
            roomDescEN = {};
            roomDescHTML = {};
            renderProjectList();
        }

        function showCalculator() {
            document.getElementById('projectListView').classList.remove('active');
            document.getElementById('calculatorView').classList.add('active');
            document.getElementById('previewView').classList.remove('active');
        }

        function backToProjectList() {
            if (isApprovalMode) {
                window.location.href = 'approbation.html';
                return;
            }
            showProjectList();
        }

        function showSaveIndicator() {
            const el = document.getElementById('saveIndicator');
            el.textContent = 'Sauvegardé ✓';
            el.className = 'save-indicator saving';
            clearTimeout(el._timeout);
            el._timeout = setTimeout(() => { el.textContent = ''; el.className = 'save-indicator'; }, 2000);
        }

        // ═══════════════════════════════════════════════════════════════════════
        // RENDU LISTE DE PROJETS
        // ═══════════════════════════════════════════════════════════════════════

        var STATUS_LABELS = {
            'draft': 'Brouillon', 'pending_internal': 'En approbation', 'returned': 'Retourn\u00e9e',
            'approved_internal': 'Approuv\u00e9e', 'sent_client': 'Envoy\u00e9e', 'accepted': 'Vendu',
            'invoiced': 'Factur\u00e9e',
            // Legacy
            'brouillon': 'Brouillon', 'soumis': 'Soumis', 'approuv\u00e9': 'Approuv\u00e9',
            'envoy\u00e9': 'Envoy\u00e9', 'sign\u00e9': 'Sign\u00e9'
        };

        function updateStatusBadge(status) {
            var badge = document.getElementById('subStatusBadge');
            if (!badge) return;
            var label = STATUS_LABELS[status] || status;
            badge.textContent = label;
            badge.className = 'status-badge status-' + status;
        }

        async function renderProjectList() {
            const grid = document.getElementById('projectGrid');
            const empty = document.getElementById('projectEmpty');
            grid.innerHTML = '';

            const projects = await loadProjects();

            if (projects.length === 0) {
                empty.style.display = 'block';
                return;
            }
            empty.style.display = 'none';

            projects.forEach(proj => {
                const card = document.createElement('div');
                card.className = 'project-card';

                const subs = proj.submissions || [];
                const subCount = subs.length;

                var subsHtml = '';
                subs.forEach(function(sub) {
                    var label = STATUS_LABELS[sub.status] || sub.status || 'Brouillon';
                    subsHtml += '<div class="sub-line" data-subid="' + escapeAttr(sub.id) + '" data-projid="' + escapeAttr(proj.id) + '">' +
                        '<span class="sub-number">#' + escapeHtml(String(sub.submission_number)) + '</span> ' +
                        '<span class="sub-title">' + escapeHtml(sub.title || 'Sans titre') + '</span>' +
                        '<span class="project-status-badge status-' + escapeAttr(sub.status) + '">' + escapeHtml(label) + '</span>' +
                        '</div>';
                });

                card.innerHTML =
                    '<button class="project-card-delete" onclick="handleDeleteProject(\'' + escapeAttr(proj.id) + '\', event)" title="Supprimer">&times;</button>' +
                    '<div class="project-card-name">' + escapeHtml(proj.name || 'Sans nom') + '</div>' +
                    '<div class="project-card-client">' + escapeHtml(proj.client_name || 'Aucun client') + '</div>' +
                    '<div class="project-subs">' + (subsHtml || '<div class="sub-empty">Aucune soumission</div>') + '</div>' +
                    '<button class="btn-add-sub" onclick="handleAddSubmission(\'' + escapeAttr(proj.id) + '\', event)">+ Nouvelle soumission</button>';

                // Click on a submission line → open it
                card.addEventListener('click', function(e) {
                    if (e.target.closest('.project-card-delete') || e.target.closest('.btn-add-sub')) return;
                    var subLine = e.target.closest('.sub-line');
                    if (subLine) {
                        var subId = subLine.getAttribute('data-subid');
                        openSubmission(subId);
                        return;
                    }
                    // Click on card header (project name) → open first submission
                    if (subs.length > 0) {
                        openSubmission(subs[0].id);
                    } else {
                        openProject(proj.id); // creates default submission
                    }
                });

                grid.appendChild(card);
            });
        }

        async function handleAddSubmission(projectId, event) {
            if (event) event.stopPropagation();
            var title = await stelePrompt('Titre de la nouvelle soumission :', 'Nouvelle soumission');
            if (title === null) return;
            try {
                var sub = await createSubmission(projectId, title || '');
                await openSubmission(sub.id);
            } catch (e) {
                console.error('Erreur cr\u00e9ation soumission:', e);
                steleAlert('Erreur lors de la cr\u00e9ation de la soumission.');
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // FORMULAIRE NOUVEAU PROJET
        // ═══════════════════════════════════════════════════════════════════════

        function showNewProjectForm() {
            document.getElementById('newProjectForm').classList.add('active');
            document.getElementById('newProjectName').focus();
        }

        function hideNewProjectForm() {
            document.getElementById('newProjectForm').classList.remove('active');
            document.getElementById('newProjectName').value = '';
        }

        async function handleCreateProject() {
            const nameInput = document.getElementById('newProjectName');
            const name = nameInput.value.trim();
            if (!name) { nameInput.focus(); return; }

            const btn = document.getElementById('btnCreateProject');
            btn.disabled = true;
            btn.textContent = 'Création...';

            try {
                const project = await createProject(name, '');
                hideNewProjectForm();
                await openProject(project.id);
            } catch (e) {
                console.error('Erreur création projet:', e);
                steleAlert('Erreur lors de la cr\u00e9ation du projet.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Créer';
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // OUVRIR / CHARGER UN PROJET
        // ═══════════════════════════════════════════════════════════════════════

        async function openSubmission(submissionId, project) {
            // Charger la soumission
            const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/submissions?id=eq.' + submissionId + '&select=*', {});
            if (!r.ok) return;
            const subData = await r.json();
            if (subData.length === 0) return;

            currentSubmission = subData[0];

            // Charger le projet parent si pas déjà fourni
            if (project) {
                currentProject = project;
            } else {
                const pr = await authenticatedFetch(SUPABASE_URL + '/rest/v1/projects?id=eq.' + currentSubmission.project_id + '&select=*', {});
                if (pr.ok) {
                    const pData = await pr.json();
                    if (pData.length > 0) currentProject = pData[0];
                }
            }

            roomMap = {};
            itemMap = {};
            groupImages = {};
            roomDescEN = {};
            roomDescHTML = {};

            // Remplir le header
            document.getElementById('projName').value = currentProject ? (currentProject.name || '') : '';
            document.getElementById('subTitle').value = currentSubmission.title || '';
            var exclEl = document.getElementById('exclusionsText');
            if (exclEl) exclEl.value = currentSubmission.exclusions || '';
            updateStatusBadge(currentSubmission.status || 'draft');
            document.getElementById('subNumber').textContent = '#' + currentSubmission.submission_number;
            document.getElementById('projInstallation').checked = true;

            // Vider le calculateur
            document.getElementById('furnitureGroups').innerHTML = '';

            // Charger les pièces et items via submission_id
            const rooms = await loadSubmissionRooms(submissionId);

            if (rooms.length === 0) {
                addFurnitureGroup('');
            } else {
                for (const room of rooms) {
                    const groupId = addFurnitureGroup(room.name, { existingId: room.id, skipSave: true });

                    if (room.installation_included === false) {
                        var installCb = document.getElementById(groupId + '-install');
                        if (installCb) installCb.checked = false;
                    }

                    if (room.client_description) {
                        var descEl = document.getElementById(groupId + '-clientDesc');
                        if (descEl) descEl.value = room.client_description;
                        roomDescHTML[groupId] = room.client_description;
                    }
                    if (room.client_description_en) {
                        roomDescEN[groupId] = room.client_description_en;
                    }

                    // Load legacy images from JSONB
                    if (room.images && Array.isArray(room.images) && room.images.length > 0) {
                        groupImages[groupId] = room.images.map(img => ({ name: img.name, dataUrl: img.dataUrl, showInQuote: !!img.showInQuote, isLegacy: true }));
                    }

                    // Load room_media from dedicated table
                    try {
                        var mediaResp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/room_media?room_id=eq.' + room.id + '&order=sort_order.asc', {});
                        if (mediaResp.ok) {
                            var mediaRows = await mediaResp.json();
                            if (mediaRows.length > 0) {
                                if (!groupImages[groupId]) groupImages[groupId] = [];
                                mediaRows.forEach(function(m) {
                                    groupImages[groupId].push({
                                        name: m.cropped_url.split('/').pop() || 'image.jpg',
                                        url: m.cropped_url,
                                        originalUrl: m.original_url,
                                        mediaId: m.id,
                                        tags: m.tags || ['presentation_soumission'],
                                        cropRatio: m.crop_ratio,
                                        isLegacy: false,
                                        showInQuote: (m.tags || []).includes('presentation_soumission')
                                    });
                                });
                            }
                        }
                    } catch (e) { console.error('Load room_media error:', e); }

                    if (groupImages[groupId] && groupImages[groupId].length > 0) {
                        renderGroupImagePreviews(groupId);
                    }

                    if (room.room_items && room.room_items.length > 0) {
                        room.room_items.forEach(item => {
                            const rowId = addRow(groupId, { existingId: item.id, skipSave: true, skipFocus: true });

                            const row = document.getElementById(rowId);
                            const select = row.querySelector('.item-select');
                            const qtyInput = row.querySelector('.qty-input');

                            qtyInput.value = item.quantity || 1;

                            if (item.installation_included === false) {
                                var rowInstCb = document.getElementById(rowId + '-install');
                                if (rowInstCb) rowInstCb.checked = false;
                            }

                            if (item.item_type === 'custom') {
                                select.value = '__AJOUT__';
                                transformToAjoutMode(row, rowId);
                                const descInput = document.getElementById(`${rowId}-desc`);
                                const priceInput = document.getElementById(`${rowId}-price`);
                                const markupInput = document.getElementById(`${rowId}-markup`);
                                if (descInput) descInput.value = item.description || '';
                                if (priceInput) priceInput.value = item.unit_price || 0;
                                if (markupInput) markupInput.value = item.markup || 0;
                            } else if (item.catalogue_item_id) {
                                select.value = item.catalogue_item_id;
                            }

                            updateRow(rowId);
                        });
                    }
                }
            }

            updateWorkflowButtons();
            loadSubmissionReviews(submissionId);
            var isEditable = (currentSubmission.status === 'draft' || currentSubmission.status === 'returned' || (currentSubmission.status === 'pending_internal' && (canApproveQuotes || isApprovalMode)));
            setEditable(isEditable);
            showCalculator();
            if (isApprovalMode) {
                // Hide submission panel and project name edit in approval mode
                document.getElementById('headerSubPanel').style.display = 'none';
                document.getElementById('projName').readOnly = true;
                document.getElementById('btnBackProjects').innerHTML = '&larr; Approbations';
            } else {
                renderHeaderSubmissionList();
            }
        }

        // Panneau de soumissions dans le calculateur
        async function renderHeaderSubmissionList() {
            var panel = document.getElementById('headerSubPanel');
            var list = document.getElementById('headerSubList');
            if (!currentProject) { panel.style.display = 'none'; return; }

            var subs = await loadSubmissions(currentProject.id);
            var html = '';
            subs.forEach(function(sub) {
                var label = STATUS_LABELS[sub.status] || sub.status || 'Brouillon';
                var isActive = currentSubmission && currentSubmission.id === sub.id;
                html += '<div class="sub-line' + (isActive ? ' active' : '') + '" data-subid="' + escapeAttr(sub.id) + '">' +
                    '<span class="sub-number">#' + escapeHtml(String(sub.submission_number)) + '</span> ' +
                    '<span class="sub-title">' + escapeHtml(sub.title || 'Sans titre') + '</span>' +
                    '<span class="project-status-badge status-' + escapeAttr(sub.status) + '">' + escapeHtml(label) + '</span>' +
                    '</div>';
            });
            list.innerHTML = html || '<div class="sub-empty">Aucune soumission</div>';
            panel.style.display = 'block';

            list.querySelectorAll('.sub-line').forEach(function(el) {
                el.addEventListener('click', function() {
                    var subId = el.getAttribute('data-subid');
                    if (currentSubmission && currentSubmission.id === subId) return;
                    openSubmission(subId);
                });
            });
        }

        async function handleAddSubmissionFromCalc() {
            if (!currentProject) return;
            var title = await stelePrompt('Titre de la nouvelle soumission :', 'Nouvelle soumission');
            if (title === null) return;
            try {
                var sub = await createSubmission(currentProject.id, title || '');
                await openSubmission(sub.id);
            } catch (e) {
                console.error('Erreur cr\u00e9ation soumission:', e);
                steleAlert('Erreur lors de la cr\u00e9ation de la soumission.');
            }
        }

        // Legacy wrapper pour compatibilité — ouvre la première soumission du projet
        async function openProject(projectId) {
            const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/projects?id=eq.' + projectId + '&select=*,submissions(id,submission_number,title,status,updated_at)', {});
            if (!r.ok) return;
            const data = await r.json();
            if (data.length === 0) return;

            var project = data[0];
            var subs = project.submissions || [];
            if (subs.length === 0) {
                // Pas de soumission → en créer une
                var newSub = await createSubmission(projectId, project.name || 'Soumission initiale');
                await openSubmission(newSub.id, project);
            } else {
                // Ouvrir la plus récente
                subs.sort(function(a, b) { return (b.updated_at || '').localeCompare(a.updated_at || ''); });
                await openSubmission(subs[0].id, project);
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // SAUVEGARDER CHAMPS HEADER PROJET
        // ═══════════════════════════════════════════════════════════════════════

        function saveProjectField() {
            if (!currentProject) return;
            var name = document.getElementById('projName').value.trim();
            currentProject.name = name;
            updateProject(currentProject.id, { name: name });
            showSaveIndicator();
        }

        function saveSubmissionField() {
            if (!currentSubmission) return;
            var title = document.getElementById('subTitle').value.trim();
            currentSubmission.title = title;
            updateSubmission(currentSubmission.id, { title: title });
            showSaveIndicator();
        }

        // ═══════════════════════════════════════════════════════════════════════
        // VERROUILLAGE ÉDITION
        // ═══════════════════════════════════════════════════════════════════════

        function setEditable(editable) {
            // Inputs et selects du calculateur
            var container = document.getElementById('calculatorView');
            if (!container) return;

            container.querySelectorAll('.item-select, .qty-input, .markup-input, .ajout-desc, .ajout-price, .ajout-markup, .client-desc-textarea').forEach(function(el) {
                el.disabled = !editable;
                el.style.opacity = editable ? '' : '0.6';
            });

            // Boutons ajouter meuble/ligne, supprimer
            container.querySelectorAll('.btn-add-group, .btn-add, .btn-remove, .btn-remove-group, .furniture-name-input').forEach(function(el) {
                if (el.tagName === 'BUTTON') {
                    el.disabled = !editable;
                    el.style.opacity = editable ? '' : '0.4';
                } else {
                    el.readOnly = !editable;
                    el.style.opacity = editable ? '' : '0.6';
                }
            });

            // Installation toggles
            container.querySelectorAll('input[type="checkbox"]').forEach(function(el) {
                el.disabled = !editable;
            });

            // Bouton "Soumettre pour approbation" en bas
            var btnOpenSubmit = document.getElementById('btnOpenSubmit');
            if (btnOpenSubmit) {
                btnOpenSubmit.disabled = !editable;
                btnOpenSubmit.style.opacity = editable ? '' : '0.4';
            }

            // Header fields
            var subTitle = document.getElementById('subTitle');
            if (subTitle) subTitle.readOnly = !editable;

            // Bannière de statut
            var banner = document.getElementById('lockBanner');
            if (!editable && currentSubmission) {
                var label = STATUS_LABELS[currentSubmission.status] || currentSubmission.status;
                if (!banner) {
                    banner = document.createElement('div');
                    banner.id = 'lockBanner';
                    banner.style.cssText = 'background:#fff3e0; color:#e65100; padding:10px 16px; border-radius:6px; font-size:13px; font-weight:600; margin-bottom:12px; text-align:center;';
                    var calcContainer = document.querySelector('.calculator-container');
                    if (calcContainer) calcContainer.parentNode.insertBefore(banner, calcContainer);
                }
                banner.textContent = 'Soumission verrouill\u00e9e \u2014 Statut : ' + label;
                banner.style.display = '';
            } else if (banner) {
                banner.style.display = 'none';
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // WORKFLOW : SOUMETTRE / APPROUVER / RETOURNER
        // ═══════════════════════════════════════════════════════════════════════

        function updateWorkflowButtons() {
            var btnSubmit = document.getElementById('btnWfSubmit');
            var btnApprove = document.getElementById('btnWfApprove');
            var btnReturn = document.getElementById('btnWfReturn');
            var btnSendClient = document.getElementById('btnWfSendClient');
            btnSubmit.style.display = 'none';
            btnApprove.style.display = 'none';
            btnReturn.style.display = 'none';
            if (btnSendClient) { btnSendClient.style.display = 'none'; btnSendClient.textContent = 'Envoyer au client'; btnSendClient.onclick = function() { sendToClient(); }; }
            if (!currentSubmission) return;

            var s = currentSubmission.status;
            if (s === 'draft' || s === 'returned') {
                btnSubmit.style.display = 'inline-block';
                btnSubmit.textContent = canApproveQuotes ? 'Approuver & Soumettre' : 'Soumettre';
            }
            if (s === 'pending_internal' && (canApproveQuotes || isApprovalMode)) {
                btnApprove.style.display = 'inline-block';
                btnReturn.style.display = 'inline-block';
            }
            if (s === 'approved_internal' && btnSendClient) {
                btnSendClient.style.display = 'inline-block';
            }
            if (s === 'sent_client' && btnSendClient) {
                btnSendClient.style.display = 'inline-block';
                btnSendClient.textContent = 'Copier le lien';
                btnSendClient.onclick = function() { copyQuoteLink(); };
            }
        }

        // submitForApproval() redirigé vers le modal
        function submitForApproval() { openSubmitModal(); }

        // ═══════════════════════════════════════════════════════════════════════
        // ENVOI AU CLIENT — LIEN PUBLIC
        // ═══════════════════════════════════════════════════════════════════════

        async function sendToClient() {
            if (!currentSubmission) return;
            if (currentSubmission.status !== 'approved_internal') {
                steleAlert('La soumission doit \u00eatre approuv\u00e9e avant l\'envoi au client.');
                return;
            }
            if (!(await steleConfirm('G\u00e9n\u00e9rer un lien de soumission pour le client ?\nLe statut passera \u00e0 \u00abEnvoy\u00e9e\u00bb.', 'Envoyer au client', 'G\u00e9n\u00e9rer le lien'))) return;

            try {
                var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/public_quote_tokens', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                    body: JSON.stringify({ submission_id: currentSubmission.id })
                });
                if (!r.ok) throw new Error('Erreur cr\u00e9ation token: ' + r.status);
                var tokenData = (await r.json())[0];

                await updateSubmission(currentSubmission.id, {
                    status: 'sent_client',
                    sent_at: new Date().toISOString()
                });
                await createSubmissionReview(currentSubmission.id, 'sent', 'Lien client g\u00e9n\u00e9r\u00e9');

                currentSubmission.status = 'sent_client';
                updateStatusBadge('sent_client');
                updateWorkflowButtons();
                setEditable(false);
                loadSubmissionReviews(currentSubmission.id);

                var link = window.location.origin + '/quote.html?token=' + tokenData.token;
                showQuoteLinkModal(link);
            } catch (e) {
                console.error('Erreur envoi client:', e);
                steleAlert('Erreur: ' + e.message);
            }
        }

        function showQuoteLinkModal(link) {
            document.getElementById('steleDialogTitle').textContent = 'Lien de soumission';
            document.getElementById('steleDialogMessage').textContent = 'Copiez ce lien et envoyez-le au client par courriel :';
            document.getElementById('steleDialogInputWrap').style.display = '';
            var input = document.getElementById('steleDialogInput');
            input.value = link;
            input.readOnly = true;
            input.style.fontSize = '12px';
            document.getElementById('steleDialogCancel').style.display = 'none';
            document.getElementById('steleDialogOk').textContent = 'Copier & Fermer';
            document.getElementById('steleDialogOk').className = 'btn-generate';
            document.getElementById('steleDialogOverlay').classList.add('active');

            _steleDialogResolve = function() {
                navigator.clipboard.writeText(link).catch(function() {});
                document.getElementById('steleDialogOverlay').classList.remove('active');
                input.readOnly = false;
                input.style.fontSize = '';
            };
            setTimeout(function() { input.select(); }, 100);
        }

        async function copyQuoteLink() {
            if (!currentSubmission) return;
            var r = await authenticatedFetch(
                SUPABASE_URL + '/rest/v1/public_quote_tokens?submission_id=eq.' + currentSubmission.id + '&order=created_at.desc&limit=1', {}
            );
            if (!r.ok) { steleAlert('Erreur chargement du lien.'); return; }
            var tokens = await r.json();
            if (tokens.length === 0) { steleAlert('Aucun lien trouv\u00e9 pour cette soumission.'); return; }
            var link = window.location.origin + '/quote.html?token=' + tokens[0].token;
            showQuoteLinkModal(link);
        }

        async function approveSubmission() {
            if (!currentSubmission || !(canApproveQuotes || isApprovalMode)) return;
            var comment = await stelePrompt('Commentaire d\'approbation (optionnel) :', 'Approuver la soumission');
            if (comment === null) return;
            try {
                await createSubmissionReview(currentSubmission.id, 'approved', comment);
                var total = calculerGrandTotal();
                await updateSubmission(currentSubmission.id, {
                    status: 'approved_internal',
                    approved_by: localStorage.getItem('sb_user_id'),
                    approved_at: new Date().toISOString(),
                    approved_total: total
                });
                currentSubmission.status = 'approved_internal';
                updateStatusBadge('approved_internal');
                updateWorkflowButtons();
                setEditable(false);
                showSaveIndicator();
                loadSubmissionReviews(currentSubmission.id);
            } catch (e) {
                console.error('Erreur approbation:', e);
                steleAlert('Erreur approbation: ' + e.message);
            }
        }

        async function returnSubmission() {
            if (!currentSubmission || !(canApproveQuotes || isApprovalMode)) return;
            var comment = await stelePrompt('Raison du retour :', 'Retourner la soumission', 'Ex: Revoir les prix du meuble X...');
            if (comment === null) return;
            if (!comment.trim()) { steleAlert('Veuillez indiquer une raison.'); return; }
            try {
                await createSubmissionReview(currentSubmission.id, 'returned', comment);
                await updateSubmission(currentSubmission.id, { status: 'returned' });
                currentSubmission.status = 'returned';
                updateStatusBadge('returned');
                updateWorkflowButtons();
                setEditable(true);
                showSaveIndicator();
                loadSubmissionReviews(currentSubmission.id);
            } catch (e) {
                console.error('Erreur retour:', e);
                steleAlert('Erreur retour: ' + e.message);
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // SUPPRIMER UN PROJET
        // ═══════════════════════════════════════════════════════════════════════

        async function handleDeleteProject(projectId, event) {
            event.stopPropagation();
            if (!(await steleConfirm('Supprimer ce projet et toutes ses donn\u00e9es ?', 'Supprimer le projet', 'Supprimer', true))) return;
            await deleteProject(projectId);
            renderProjectList();
        }

        // ═══════════════════════════════════════════════════════════════════════
        // RENTABILITÉ
        // ═══════════════════════════════════════════════════════════════════════

        function openRentab(scope, groupId) {
            // scope = 'project' ou 'group'
            var title = scope === 'project' ? 'Rentabilit\u00e9 — Projet complet' : 'Rentabilit\u00e9 — ' + (document.getElementById(groupId + '-name').value || 'Meuble');
            document.getElementById('rentabTitle').textContent = title;

            // Collecter les lignes en scope
            var rows;
            if (scope === 'project') {
                rows = document.querySelectorAll('.calc-row');
            } else {
                rows = document.querySelectorAll('#' + groupId + '-rows .calc-row');
            }

            // Accumulateurs
            var deptMinutes = {};
            var matCoutant = {};
            var totalMatMarkup = 0;
            var totalMatCoutant = 0;
            var totalHeuresCharge = 0;
            var totalSalaires = 0;
            var totalFraisFixes = 0;
            var totalProfitMO = 0;
            var totalPrixVente = 0;

            // Init départements
            tauxHoraires.forEach(function(t) { deptMinutes[t.department] = 0; });

            // Init matériaux
            expenseCategories.forEach(function(c) { matCoutant[c.name] = 0; });

            rows.forEach(function(row) {
                var select = row.querySelector('.item-select');
                var qtyInput = row.querySelector('.qty-input');
                if (!select || !qtyInput) return;
                var selectedId = select.value;
                var qty = parseFloat(qtyInput.value) || 0;
                if (!selectedId || selectedId === '__AJOUT__' || selectedId === '__PROPOSER__') {
                    // Ajout personnalisé — ajouter au prix de vente
                    if (selectedId === '__AJOUT__') {
                        var priceInput = row.querySelector('.ajout-price');
                        var markupInput = row.querySelector('.ajout-markup');
                        var p = parseFloat(priceInput ? priceInput.value : 0) || 0;
                        var m = parseFloat(markupInput ? markupInput.value : 0) || 0;
                        totalPrixVente += p * qty * (1 + m / 100);
                    }
                    return;
                }
                var item = CATALOGUE_DATA.find(function(i) { return i.id === selectedId; });
                if (!item) return;

                var installCb = document.getElementById(row.id + '-install');
                var includeInstall = installCb ? installCb.checked : true;
                var laborMinutes = item.labor_minutes || {};
                var materialCosts = item.material_costs || {};

                // Départements
                tauxHoraires.forEach(function(t) {
                    var dept = t.department;
                    var mins = (laborMinutes[dept] || 0) * qty;
                    if (!includeInstall && dept === 'Installation') return;
                    deptMinutes[dept] = (deptMinutes[dept] || 0) + mins;
                    var hours = mins / 60;
                    totalHeuresCharge += hours * (t.taux_horaire || 0);
                    totalSalaires += hours * (t.salaire || 0);
                    totalFraisFixes += hours * (t.frais_fixe || 0);
                    totalProfitMO += hours * ((t.taux_horaire || 0) - (t.salaire || 0) - (t.frais_fixe || 0));
                });

                // Matériaux
                expenseCategories.forEach(function(c) {
                    var cost = (materialCosts[c.name] || 0) * qty;
                    matCoutant[c.name] = (matCoutant[c.name] || 0) + cost;
                    totalMatCoutant += cost;
                    totalMatMarkup += cost * ((c.markup || 0) / 100);
                });
            });

            totalPrixVente += totalHeuresCharge + totalMatCoutant + totalMatMarkup;

            // Marges
            var profitNet = totalProfitMO + totalMatMarkup;
            var margeBrutReelPct = totalPrixVente > 0 ? (profitNet / totalPrixVente * 100) : 0;
            var margeVisee = 38; // %
            var margeViseeMontant = totalPrixVente * margeVisee / 100;

            // Total minutes
            var totalMinutes = 0;
            tauxHoraires.forEach(function(t) { totalMinutes += (deptMinutes[t.department] || 0); });

            // Render
            var f = function(v) { return v.toLocaleString('fr-CA', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' $'; };
            var fPct = function(v) { return v.toFixed(2) + ' %'; };
            var fNum = function(v) { return v.toLocaleString('fr-CA', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); };

            var html = '';

            // Colonne gauche
            html += '<div>';

            // Résumé prix
            html += '<div class="rentab-section">';
            html += '<div class="rentab-section-title">R\u00e9sum\u00e9</div>';
            html += '<table class="rentab-table">';
            html += '<tr class="highlight"><td>PRIX DE VENTE TOTAL</td><td>' + f(totalPrixVente) + '</td></tr>';
            html += '<tr class="spacer"><td></td><td></td></tr>';
            html += '<tr><td>Prix co\u00fbtant mat\u00e9riaux</td><td>' + f(totalMatCoutant) + '</td></tr>';
            html += '<tr><td>Mark up mat\u00e9riaux</td><td>' + f(totalMatMarkup) + '</td></tr>';
            html += '<tr class="spacer"><td></td><td></td></tr>';
            html += '<tr class="highlight"><td>TOTAL HEURES CHARG\u00c9</td><td>' + f(totalHeuresCharge) + '</td></tr>';
            html += '<tr><td>Total salaires</td><td>' + f(totalSalaires) + '</td></tr>';
            html += '<tr><td>Total frais fixes</td><td>' + f(totalFraisFixes) + '</td></tr>';
            html += '<tr><td>Profit sur taux horaire</td><td>' + f(totalProfitMO) + '</td></tr>';
            html += '</table>';
            html += '</div>';

            // Matériaux détail
            html += '<div class="rentab-section">';
            html += '<div class="rentab-section-title">Co\u00fbtant mat\u00e9riaux</div>';
            html += '<table class="rentab-table">';
            var hasMatRows = false;
            expenseCategories.forEach(function(c) {
                if (matCoutant[c.name] > 0) {
                    html += '<tr><td>' + escapeHtml(c.name) + '</td><td>' + f(matCoutant[c.name]) + '</td></tr>';
                    hasMatRows = true;
                }
            });
            if (!hasMatRows) html += '<tr><td colspan="2" style="color:#999;">Aucun mat\u00e9riau</td></tr>';
            html += '<tr class="total"><td>Total</td><td>' + f(totalMatCoutant) + '</td></tr>';
            html += '</table>';
            html += '</div>';

            html += '</div>';

            // Colonne droite
            html += '<div>';

            // Départements
            html += '<div class="rentab-section">';
            html += '<div class="rentab-section-title">Ventilation main-d\u2019\u0153uvre</div>';
            html += '<table class="rentab-dept-table">';
            html += '<tr><th></th>';
            tauxHoraires.forEach(function(t) {
                var short = t.department.split('/')[0].substring(0, 6);
                html += '<th>' + escapeHtml(short) + '</th>';
            });
            html += '<th style="background:var(--stele-green)">TOTAL</th></tr>';
            // Heures
            html += '<tr><td>Heures</td>';
            var totalHeures = 0;
            tauxHoraires.forEach(function(t) {
                var h = (deptMinutes[t.department] || 0) / 60;
                totalHeures += h;
                html += '<td>' + fNum(h) + '</td>';
            });
            html += '<td>' + fNum(totalHeures) + '</td></tr>';
            html += '</table>';
            html += '</div>';

            // Marges
            html += '<div class="rentab-section">';
            html += '<div class="rentab-section-title">Marges</div>';
            html += '<div class="rentab-margins">';
            html += '<div class="rentab-margins-row"><span>Marge brut vis\u00e9e</span><span>' + fPct(margeVisee) + '</span><span>' + f(margeViseeMontant) + '</span></div>';
            html += '<div class="rentab-margins-row"><span>Marge brut r\u00e9elle</span><span>' + fPct(margeBrutReelPct) + '</span><span>' + f(profitNet) + '</span></div>';
            html += '<div class="rentab-margins-row profit-row"><span>Profit net estim\u00e9</span><span></span><span>' + f(profitNet) + '</span></div>';
            html += '</div>';
            html += '</div>';

            html += '</div>';

            document.getElementById('rentabBody').innerHTML = html;
            document.getElementById('rentabModal').classList.add('active');
        }

        function closeRentab() {
            document.getElementById('rentabModal').classList.remove('active');
        }

        // ═══════════════════════════════════════════════════════════════════════
        // VÉRIFICATION DES PERMISSIONS
        // ═══════════════════════════════════════════════════════════════════════

        const DEFAULT_PERMISSIONS = {
            'Admin': { calculateur: true }, 'Vente': { calculateur: true },
            'Charg\u00e9 de projet': { calculateur: true }, 'Achat': { calculateur: false },
            'Atelier': { calculateur: false }, 'Client': { calculateur: false }
        };
        const DEFAULT_USER_ROLES = { 'hubert@stele.ca': 'Admin' };

        async function checkPageAccess() {
            try {
                const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/app_config?key=in.(permissions,user_roles)&select=key,value', {});
                let perms = DEFAULT_PERMISSIONS, roles = DEFAULT_USER_ROLES;
                if (r.ok) {
                    const rows = await r.json();
                    rows.forEach(row => {
                        if (row.key === 'permissions') perms = row.value;
                        if (row.key === 'user_roles') roles = row.value;
                    });
                }
                const email = (localStorage.getItem('sb_user_email') || '').toLowerCase();
                const role = roles[email] || 'Client';
                const defaults = DEFAULT_PERMISSIONS[role] || {};
                const saved = perms[role] || {};
                const allowed = Object.assign({}, defaults, saved);
                canEditMinutes = !!allowed.edit_minutes;
                canEditMaterials = !!allowed.edit_materials;
                canApproveQuotes = !!allowed.can_approve_quotes;
                var hasSubParam = new URLSearchParams(window.location.search).has('submission');
                if (!allowed.calculateur && !(hasSubParam && (allowed.approbation || allowed.can_approve_quotes))) {
                    window.location.href = 'app.html'; return false;
                }
            } catch (e) {
                const email = (localStorage.getItem('sb_user_email') || '').toLowerCase();
                const role = DEFAULT_USER_ROLES[email] || 'Client';
                var defPerms = DEFAULT_PERMISSIONS[role] || {};
                canEditMinutes = !!defPerms.edit_minutes;
                canEditMaterials = !!defPerms.edit_materials;
                canApproveQuotes = !!defPerms.can_approve_quotes;
                if (!defPerms.calculateur) { window.location.href = 'app.html'; return false; }
            }
            return true;
        }

        async function loadMediaTags() {
            try {
                const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/app_config?key=eq.media_tags&select=value', {});
                if (r.ok) {
                    const rows = await r.json();
                    if (rows.length > 0 && Array.isArray(rows[0].value)) {
                        mediaTagsList = rows[0].value;
                    }
                }
            } catch (e) { /* keep defaults */ }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // INITIALISATION
        // ═══════════════════════════════════════════════════════════════════════

        document.addEventListener('DOMContentLoaded', async function() {
            if (!(await checkPageAccess())) return;
            await loadCatalogueData();
            await loadConfigCategories();
            await loadTauxAndExpenses();
            await loadMediaTags();
            await loadEmployeesData();
            setupProposerMediaHandlers();

            // Check for direct submission opening (from approbation page)
            var params = new URLSearchParams(window.location.search);
            var submissionParam = params.get('submission');
            if (submissionParam) {
                isApprovalMode = true;
                await openSubmission(submissionParam);
            } else {
                renderProjectList();
            }
        });
    </script>

</body>
</html>
