<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stele — Calculateur</title>

    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <script>
    // Vérifier la connexion
    if (!localStorage.getItem('sb_access_token')) {
        window.location.href = 'login.html';
    }

    const SUPABASE_URL = 'https://rplzbtjfnwahqodrhpny.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJwbHpidGpmbndhaHFvZHJocG55Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NDU2MDEsImV4cCI6MjA4NjIyMTYwMX0.OQAZhc029PbRDSe1b02NDAuOUE8yn-_h3QqSnUDpLeU';

    const STORAGE_KEY = 'stele_catalogue_data';
    const STORAGE_DATE_KEY = 'stele_catalogue_date';

    // GAS retiré — workflow interne via soumissions

    let EMPLOYEES_DATA = [];
    let CATALOGUE_DATA = [];
    let tauxHoraires = [];
    let expenseCategories = [];
    let canEditMinutes = false;
    let canEditMaterials = false;
    let mediaTagsList = ['fiche_client', 'catalogue', 'technique', 'dessin'];
    let propMedia = [];

    // Configure PDF.js worker
    if (typeof pdfjsLib !== 'undefined') {
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }

    // ═══════════════════════════════════════════════════════════════════════
    // PROJETS — ÉTAT GLOBAL
    // ═══════════════════════════════════════════════════════════════════════

    let currentProject = null;      // objet projet courant { id, name, client_name, ... }
    let currentSubmission = null;   // objet soumission courante { id, submission_number, title, status, ... }
    let canApproveQuotes = false;   // permission can_approve_quotes
    let canBypassApproval = false;  // permission can_bypass_approval
    let canUnlockSubmission = false; // permission can_unlock_submission
    let isApprovalMode = false;     // true when opened from approbation.html via ?submission=
    let roomMap = {};               // { groupDomId: supabaseRoomUUID }
    let itemMap = {};               // { rowDomId: supabaseItemUUID }
    let groupImages = {};        // { groupDomId: [{ name, dataUrl }] }
    let saveTimeout = null;      // pour le debounce
    const MAX_GROUP_IMAGES = 8;

    // ═══════════════════════════════════════════════════════════════════════
    // DIALOGUES CUSTOM (remplace alert/confirm/prompt natifs)
    // ═══════════════════════════════════════════════════════════════════════

    var _steleDialogResolve = null;
    function steleDialogResolve(val) {
        document.getElementById('steleDialogOverlay').classList.remove('active');
        if (_steleDialogResolve) { var fn = _steleDialogResolve; _steleDialogResolve = null; fn(val); }
    }
    function steleDialogOk() {
        var input = document.getElementById('steleDialogInput');
        var wrap = document.getElementById('steleDialogInputWrap');
        steleDialogResolve(wrap.style.display === 'none' ? true : input.value);
    }

    function steleAlert(msg, title) {
        return new Promise(function(resolve) {
            _steleDialogResolve = resolve;
            document.getElementById('steleDialogTitle').textContent = title || '';
            document.getElementById('steleDialogMessage').textContent = msg;
            document.getElementById('steleDialogInputWrap').style.display = 'none';
            document.getElementById('steleDialogCancel').style.display = 'none';
            document.getElementById('steleDialogOk').textContent = 'OK';
            document.getElementById('steleDialogOk').className = 'btn-generate';
            document.getElementById('steleDialogOverlay').classList.add('active');
        });
    }

    function steleConfirm(msg, title, okLabel, danger) {
        return new Promise(function(resolve) {
            _steleDialogResolve = resolve;
            document.getElementById('steleDialogTitle').textContent = title || 'Confirmation';
            document.getElementById('steleDialogMessage').textContent = msg;
            document.getElementById('steleDialogInputWrap').style.display = 'none';
            document.getElementById('steleDialogCancel').style.display = '';
            document.getElementById('steleDialogOk').textContent = okLabel || 'Confirmer';
            document.getElementById('steleDialogOk').className = danger ? 'btn-generate' : 'btn-generate';
            if (danger) document.getElementById('steleDialogOk').style.background = '#c0392b';
            else document.getElementById('steleDialogOk').style.background = '';
            document.getElementById('steleDialogOverlay').classList.add('active');
        });
    }

    function stelePrompt(msg, title, placeholder, required) {
        return new Promise(function(resolve) {
            _steleDialogResolve = resolve;
            document.getElementById('steleDialogTitle').textContent = title || '';
            document.getElementById('steleDialogMessage').textContent = msg;
            document.getElementById('steleDialogInputWrap').style.display = '';
            var input = document.getElementById('steleDialogInput');
            input.value = '';
            input.placeholder = placeholder || '';
            document.getElementById('steleDialogCancel').style.display = '';
            document.getElementById('steleDialogOk').textContent = 'OK';
            document.getElementById('steleDialogOk').className = 'btn-generate';
            document.getElementById('steleDialogOk').style.background = '';
            document.getElementById('steleDialogOverlay').classList.add('active');
            setTimeout(function() { input.focus(); }, 100);
        });
    }

    // ═══════════════════════════════════════════════════════════════════════

    function escapeHtml(str) {
        if (!str) return '';
        var div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    function escapeAttr(str) {
        return (str || '').replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;');
    }

    // Convert plain text (legacy) to basic HTML; if already HTML, return as-is
    function textToHtml(str) {
        if (!str) return '';
        if (str.indexOf('<p>') !== -1 || str.indexOf('<strong>') !== -1 || str.indexOf('<ul>') !== -1) {
            return str; // already HTML
        }
        // Legacy plain text: escape then convert newlines to <br>
        return escapeHtml(str).replace(/\n/g, '<br>');
    }

    function debounce(fn, delay) {
        let timer;
        return function(...args) {
            clearTimeout(timer);
            timer = setTimeout(() => fn.apply(this, args), delay);
        };
    }

    // ═══════════════════════════════════════════════════════════════════════
    // PROJETS — CRUD SUPABASE
    // ═══════════════════════════════════════════════════════════════════════

    async function loadProjects() {
        const userId = localStorage.getItem('sb_user_id');
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/projects?user_id=eq.' + userId + '&order=updated_at.desc&select=*,submissions(id,submission_number,title,status,current_version,updated_at,bypass_approval)', {});
        if (!r.ok) return [];
        var projects = await r.json();
        projects.forEach(function(p) {
            if (p.submissions) p.submissions.sort(function(a, b) { return b.submission_number - a.submission_number; });
        });
        return projects;
    }

    async function createProject(name, clientName) {
        const userId = localStorage.getItem('sb_user_id');
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/projects', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
            body: JSON.stringify({ user_id: userId, name: name, client_name: clientName || '' })
        });
        if (!r.ok) throw new Error('Erreur création projet: ' + r.status);
        const data = await r.json();
        return data[0];
    }

    async function updateProject(projectId, fields) {
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/projects?id=eq.' + projectId, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
            body: JSON.stringify(fields)
        });
        return r.ok;
    }

    async function deleteProject(projectId) {
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/projects?id=eq.' + projectId, {
            method: 'DELETE'
        });
        return r.ok;
    }

    // ═══════════════════════════════════════════════════════════════════════
    // SOUMISSIONS — CRUD SUPABASE
    // ═══════════════════════════════════════════════════════════════════════

    async function loadSubmissions(projectId) {
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/submissions?project_id=eq.' + projectId + '&order=submission_number.desc&select=*', {});
        if (!r.ok) return [];
        return await r.json();
    }

    async function createSubmission(projectId, title) {
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/submissions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
            body: JSON.stringify({ project_id: projectId, title: title || '' })
        });
        if (!r.ok) throw new Error('Erreur cr\u00e9ation soumission: ' + r.status);
        const data = await r.json();
        return data[0];
    }

    async function updateSubmission(submissionId, fields) {
        fields.updated_at = new Date().toISOString();
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/submissions?id=eq.' + submissionId, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
            body: JSON.stringify(fields)
        });
        return r.ok;
    }

    async function deleteSubmission(submissionId) {
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/submissions?id=eq.' + submissionId, {
            method: 'DELETE'
        });
        return r.ok;
    }

    // ═══════════════════════════════════════════════════════════════════════
    // REVIEWS — CRUD SUPABASE
    // ═══════════════════════════════════════════════════════════════════════

    async function createSubmissionReview(submissionId, action, comment) {
        const userId = localStorage.getItem('sb_user_id');
        var versionAt = currentSubmission ? currentSubmission.current_version : null;
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/submission_reviews', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
            body: JSON.stringify({
                submission_id: submissionId,
                reviewer_id: userId,
                action: action,
                comment: comment || '',
                version_at_review: versionAt
            })
        });
        if (!r.ok) {
            var errText = await r.text().catch(function() { return ''; });
            console.error('createSubmissionReview failed:', r.status, errText);
            throw new Error('Erreur review: ' + r.status + ' ' + errText);
        }
        return (await r.json())[0];
    }

    // ═══════════════════════════════════════════════════════════════════════
    // TIMELINE DRAWER — HISTORIQUE SOUMISSION
    // ═══════════════════════════════════════════════════════════════════════

    var timelineReviews = [];

    async function loadSubmissionReviews(submissionId) {
        var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/submission_reviews?submission_id=eq.' + submissionId + '&order=created_at.asc&select=*', {});
        if (!r.ok) { timelineReviews = []; return; }
        timelineReviews = await r.json();
        renderTimelineDrawer();
        // Show button if there are reviews (now in kebab menu, always visible)
        var btn = document.getElementById('btnTimeline');
        if (btn) btn.style.display = '';
    }

    function renderTimelineDrawer() {
        var body = document.getElementById('timelineBody');
        if (timelineReviews.length === 0) {
            body.innerHTML = '<div class="timeline-empty">Aucun historique pour cette soumission.</div>';
            return;
        }

        var actionLabels = {
            'submitted': 'Soumis pour approbation',
            'approved': 'Approuv\u00e9',
            'returned': 'Retourn\u00e9',
            'sent': 'Envoy\u00e9 au client',
            'bypass': 'Bypass approbation',
            'offline_accepted': 'Vente confirmée (hors-ligne)',
            'invoiced': 'Marquée facturée',
            'duplicated': 'Soumission dupliquée',
            'unlocked': 'DÉVERROUILLÉ'
        };

        var html = '';
        timelineReviews.forEach(function(rev) {
            var action = rev.action || 'submitted';
            var label = actionLabels[action] || action;
            var date = rev.created_at ? new Date(rev.created_at) : null;
            var dateStr = date ? date.toLocaleDateString('fr-CA', { year: 'numeric', month: 'short', day: 'numeric' }) + ' \u00e0 ' + date.toLocaleTimeString('fr-CA', { hour: '2-digit', minute: '2-digit' }) : '';
            var version = rev.version_at_review ? 'V' + rev.version_at_review : '';

            html += '<div class="timeline-entry">';
            html += '<div class="timeline-dot timeline-dot-' + action + '"></div>';
            html += '<div class="timeline-entry-header">';
            html += '<span class="timeline-action timeline-action-' + action + '">' + label + '</span>';
            if (version) html += '<span class="timeline-version">' + version + '</span>';
            html += '</div>';
            html += '<div class="timeline-date">' + dateStr + '</div>';
            if (rev.comment) {
                html += '<div class="timeline-comment timeline-comment-' + action + '">' + escapeHtml(rev.comment) + '</div>';
            }
            html += '</div>';
        });

        body.innerHTML = html;
    }

    function openTimelineDrawer() {
        document.getElementById('timelineOverlay').classList.add('active');
        document.getElementById('timelineDrawer').classList.add('active');
    }

    function closeTimelineDrawer() {
        document.getElementById('timelineOverlay').classList.remove('active');
        document.getElementById('timelineDrawer').classList.remove('active');
    }

    // ═══════════════════════════════════════════════════════════════════════
    // PIÈCES & ARTICLES — CRUD SUPABASE
    // ═══════════════════════════════════════════════════════════════════════

    async function loadSubmissionRooms(submissionId) {
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/project_rooms?submission_id=eq.' + submissionId + '&order=sort_order&select=*,room_items(*)', {});
        if (!r.ok) return [];
        const rooms = await r.json();
        rooms.forEach(room => {
            if (room.room_items) room.room_items.sort((a, b) => a.sort_order - b.sort_order);
        });
        return rooms;
    }

    // Legacy — keep for transition
    async function loadProjectRooms(projectId) {
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/project_rooms?project_id=eq.' + projectId + '&order=sort_order&select=*,room_items(*)', {});
        if (!r.ok) return [];
        const rooms = await r.json();
        rooms.forEach(room => {
            if (room.room_items) room.room_items.sort((a, b) => a.sort_order - b.sort_order);
        });
        return rooms;
    }

    async function createRoom(submissionId, name, sortOrder) {
        var payload = { submission_id: submissionId, name: name || '', sort_order: sortOrder || 0 };
        // Also set project_id for transition period
        if (currentProject) payload.project_id = currentProject.id;
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/project_rooms', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
            body: JSON.stringify(payload)
        });
        if (!r.ok) return null;
        const data = await r.json();
        return data[0];
    }

    async function updateRoom(roomId, fields) {
        await authenticatedFetch(SUPABASE_URL + '/rest/v1/project_rooms?id=eq.' + roomId, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
            body: JSON.stringify(fields)
        });
    }

    async function deleteRoom(roomId) {
        await authenticatedFetch(SUPABASE_URL + '/rest/v1/project_rooms?id=eq.' + roomId, {
            method: 'DELETE'
        });
    }

    async function createItem(roomId, itemData) {
        const payload = Object.assign({ room_id: roomId }, itemData);
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/room_items', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
            body: JSON.stringify(payload)
        });
        if (!r.ok) return null;
        const data = await r.json();
        return data[0];
    }

    async function updateItem(itemId, fields) {
        await authenticatedFetch(SUPABASE_URL + '/rest/v1/room_items?id=eq.' + itemId, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
            body: JSON.stringify(fields)
        });
    }

    async function deleteItem(itemId) {
        await authenticatedFetch(SUPABASE_URL + '/rest/v1/room_items?id=eq.' + itemId, {
            method: 'DELETE'
        });
    }

    async function createVersion(submissionId) {
        // Trouver le prochain numéro de version (par project_id pour respecter la contrainte unique)
        var versionQuery = currentProject
            ? SUPABASE_URL + '/rest/v1/project_versions?project_id=eq.' + currentProject.id + '&order=version_number.desc&limit=1&select=version_number'
            : SUPABASE_URL + '/rest/v1/project_versions?submission_id=eq.' + submissionId + '&order=version_number.desc&limit=1&select=version_number';
        const r = await authenticatedFetch(versionQuery, {});
        let nextVersion = 1;
        if (r.ok) {
            const data = await r.json();
            if (data.length > 0) nextVersion = data[0].version_number + 1;
        }

        const snapshot = collecterDonneesCalculateur();
        const userId = localStorage.getItem('sb_user_id');

        var payload = {
            submission_id: submissionId,
            version_number: nextVersion,
            snapshot: snapshot,
            status_at_save: currentSubmission ? currentSubmission.status : 'draft',
            created_by: userId
        };
        // Also set project_id for transition period
        if (currentProject) payload.project_id = currentProject.id;

        var vr = await authenticatedFetch(SUPABASE_URL + '/rest/v1/project_versions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
            body: JSON.stringify(payload)
        });
        if (!vr.ok) {
            var errText = await vr.text().catch(function() { return ''; });
            console.error('createVersion failed:', vr.status, errText);
            throw new Error('Erreur version: ' + vr.status + ' ' + errText);
        }

        // Update current_version on submission
        await updateSubmission(submissionId, { current_version: nextVersion });
        if (currentSubmission) currentSubmission.current_version = nextVersion;
    }

    // ═══════════════════════════════════════════════════════════════════════
    // REFRESH AUTOMATIQUE DU TOKEN
    // ═══════════════════════════════════════════════════════════════════════

    async function refreshAccessToken() {
        const refreshToken = localStorage.getItem('sb_refresh_token');
        if (!refreshToken) return false;

        try {
            const response = await fetch(SUPABASE_URL + '/auth/v1/token?grant_type=refresh_token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'apikey': SUPABASE_KEY
                },
                body: JSON.stringify({ refresh_token: refreshToken })
            });

            if (!response.ok) return false;

            const data = await response.json();
            if (data.access_token) {
                localStorage.setItem('sb_access_token', data.access_token);
                localStorage.setItem('sb_refresh_token', data.refresh_token);
                return true;
            }
            return false;
        } catch (e) {
            console.warn('Échec du refresh token:', e);
            return false;
        }
    }

    async function authenticatedFetch(url, options) {
        options = options || {};
        const token = localStorage.getItem('sb_access_token');
        const headers = Object.assign({}, options.headers || {}, {
            'apikey': SUPABASE_KEY,
            'Authorization': 'Bearer ' + token
        });

        let response = await fetch(url, Object.assign({}, options, { headers: headers }));

        // Si 401 → tenter un refresh et réessayer une fois
        if (response.status === 401) {
            const refreshed = await refreshAccessToken();
            if (refreshed) {
                const newToken = localStorage.getItem('sb_access_token');
                headers['Authorization'] = 'Bearer ' + newToken;
                response = await fetch(url, Object.assign({}, options, { headers: headers }));
            } else {
                // Refresh échoué → session expirée, rediriger vers login
                localStorage.removeItem('sb_access_token');
                localStorage.removeItem('sb_refresh_token');
                window.location.href = 'login.html';
                return response;
            }
        }

        return response;
    }
    </script>

    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --stele-black: #0A0203;
            --stele-green: #4b6050;
            --stele-gray: #C8C8C8;
            --stele-light-gray: #F8F8F8;
            --stele-white: #FFFFFF;
        }

        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            font-size: 16px;
            line-height: 1.5;
            color: var(--stele-black);
            background: var(--stele-white);
        }

        /* Nav bar */
        .nav-bar {
            position: fixed;
            top: 0; left: 0; right: 0;
            background: var(--stele-white);
            border-bottom: 1px solid var(--stele-gray);
            padding: 12px 60px;
            display: flex;
            align-items: center;
            gap: 32px;
            z-index: 100;
            height: 56px;
        }

        .nav-logo {
            font-size: 20px;
            font-weight: 400;
            color: var(--stele-black);
        }

        .nav-links {
            display: flex;
            gap: 24px;
        }

        .nav-links a {
            color: var(--stele-black);
            text-decoration: none;
            font-size: 13px;
            transition: opacity 0.2s;
        }

        .nav-links a:hover { opacity: 0.6; }

        .nav-back {
            opacity: 0.4;
            border-right: 1px solid var(--stele-gray);
            padding-right: 24px;
            margin-right: 0;
        }

        .nav-back:hover { opacity: 0.7; }

        .data-status {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            font-weight: 600;
            color: #888;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #888;
        }

        .data-status.online .status-dot { background: #2ecc40; }
        .data-status.online { color: #2ecc40; }
        .data-status.offline .status-dot { background: #e67e22; }
        .data-status.offline { color: #e67e22; }
        .data-status.error .status-dot { background: #e74c3c; }
        .data-status.error { color: #e74c3c; }

        /* Main content */
        .main-content {
            margin-top: 56px;
            padding: 40px 60px 60px;
            max-width: 1200px;
        }

        .page-title {
            font-size: 32px;
            font-weight: 400;
            margin-bottom: 8px;
        }

        .page-subtitle {
            font-size: 14px;
            color: #666;
            margin-bottom: 32px;
        }

        /* ═══════════════════════════════════════════════════════════════
           CALCULATEUR STYLES
           ═══════════════════════════════════════════════════════════════ */

        .calculator-container {
            max-width: 1200px;
        }

        .calc-header {
            display: grid;
            grid-template-columns: 30px 1fr 90px 90px 110px 100px 30px 120px 30px;
            gap: 6px;
            padding: 8px 10px;
            background: transparent;
            color: #888;
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            border-bottom: 1px solid #e0e0e0;
        }

        .calc-header span {
            display: flex;
            align-items: center;
        }

        .calc-header .col-center { justify-content: center; }
        .calc-header .col-right { justify-content: flex-end; }

        .calc-rows {
            border-top: none;
        }

        .calc-row {
            display: grid;
            grid-template-columns: 30px 1fr 90px 90px 110px 100px 30px 120px 30px;
            gap: 6px;
            padding: 6px 10px;
            align-items: center;
            border-bottom: 1px solid #eee;
            background: var(--stele-white);
            transition: background-color 0.15s ease;
        }

        .calc-row:nth-child(even) { background: #fafafa; }
        .calc-row:last-child { border-bottom: none; }
        .calc-row:hover { background: #f5f5f5; }

        .btn-add {
            width: 20px;
            height: 20px;
            border: 1.5px solid var(--stele-green);
            background: var(--stele-white);
            color: var(--stele-green);
            border-radius: 50%;
            font-size: 14px;
            font-weight: 400;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
            line-height: 1;
        }

        .btn-add:hover {
            background: var(--stele-green);
            color: var(--stele-white);
        }

        .btn-remove {
            width: 20px;
            height: 20px;
            border: none;
            background: transparent;
            color: var(--stele-gray);
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.15s ease;
            border-radius: 4px;
        }

        .btn-remove:hover {
            color: #c0392b;
            background: #fdeaea;
        }

        .item-select {
            width: 100%;
            padding: 4px 8px;
            font-size: 11px;
            font-family: inherit;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #fff;
            color: var(--stele-black);
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%230A0203' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            padding-right: 28px;
        }

        .item-select:focus {
            outline: none;
            border-color: var(--stele-green);
        }

        .cell-code, .cell-type, .cell-unit-price {
            font-size: 11px;
            color: var(--stele-black);
        }

        .cell-code {
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            font-size: 11px;
            color: #666;
            position: relative;
            cursor: help;
        }

        .cell-type { text-align: center; }
        .cell-unit-price { text-align: right; }

        /* Tooltip styles */
        .tooltip-container {
            position: relative;
            cursor: help;
        }

        .tooltip {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--stele-black);
            color: var(--stele-white);
            padding: 10px 14px;
            border-radius: 4px;
            font-size: 12px;
            line-height: 1.5;
            white-space: normal;
            width: 240px;
            text-align: left;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: opacity 0.2s ease, visibility 0.2s ease;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }

        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--stele-black);
        }

        .tooltip-container:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        .tooltip-img {
            width: 100%;
            border-radius: 3px;
            margin-bottom: 8px;
        }

        .tooltip-title { font-weight: 700; margin-bottom: 4px; font-size: 12px; }
        .tooltip-text { font-weight: 400; color: rgba(255,255,255,0.85); }

        .qty-input {
            width: 100%;
            padding: 5px 8px;
            font-size: 12px;
            font-family: inherit;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            background: #fff;
        }

        .qty-input:focus { outline: none; border-color: var(--stele-green); }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }

        .cell-total {
            font-size: 12px;
            font-weight: 600;
            text-align: right;
            color: var(--stele-black);
        }

        .add-row-container {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: none;
            background: var(--stele-white);
        }

        .add-row-text { font-size: 13px; color: #999; }

        .grand-total-container {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 20px 16px;
            background: var(--stele-black);
            border-radius: 0 0 4px 4px;
            margin-top: -1px;
        }

        .grand-total-label {
            font-size: 16px;
            font-weight: 700;
            color: var(--stele-white);
            margin-right: 24px;
        }

        .grand-total-amount {
            font-size: 24px;
            font-weight: 700;
            color: var(--stele-white);
            min-width: 140px;
            text-align: right;
        }

        /* Sections meuble */
        .furniture-group {
            margin-bottom: 28px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e0e0e0;
            border-top: none;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
        }

        .btn-collapse {
            background: none;
            border: none;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            font-size: 12px;
            padding: 4px;
            transition: transform 0.2s;
            line-height: 1;
        }

        .btn-collapse:hover { color: #fff; }

        .furniture-group.collapsed .btn-collapse {
            transform: rotate(-90deg);
        }

        .furniture-group.collapsed .calc-header,
        .furniture-group.collapsed .calc-rows,
        .furniture-group.collapsed .group-images-section,
        .furniture-group.collapsed .client-description-section {
            display: none;
        }

        .furniture-group-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: var(--stele-green);
            color: var(--stele-white);
            border-radius: 8px 8px 0 0;
        }

        .furniture-group-header .group-label {
            font-size: 13px;
            font-weight: 700;
            white-space: nowrap;
        }

        .furniture-name-input {
            flex: 1;
            padding: 7px 12px;
            font-size: 14px;
            font-family: inherit;
            font-weight: 600;
            border: none;
            border-radius: 4px;
            background: rgba(255,255,255,0.2);
            color: var(--stele-white);
        }

        .furniture-name-input::placeholder { color: rgba(255,255,255,0.6); }
        .furniture-name-input:focus { outline: none; background: rgba(255,255,255,0.3); }

        .install-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            white-space: nowrap;
            font-size: 12px;
            color: rgba(255,255,255,0.85);
        }
        .install-toggle input[type="checkbox"] {
            width: 14px;
            height: 14px;
            cursor: pointer;
            accent-color: var(--stele-white);
        }
        .install-label {
            font-weight: 500;
        }
        .install-toggle-project {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            white-space: nowrap;
            font-size: 12px;
            font-weight: 500;
        }
        .install-toggle-project input[type="checkbox"] {
            width: 14px;
            height: 14px;
            cursor: pointer;
            accent-color: var(--stele-green);
        }
        .install-toggle-row {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .install-toggle-row input[type="checkbox"] {
            width: 12px;
            height: 12px;
            cursor: pointer;
            accent-color: var(--stele-green);
        }

        .btn-remove-group {
            padding: 5px 12px;
            background: transparent;
            color: rgba(255,255,255,0.7);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            font-size: 12px;
            font-family: inherit;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.15s;
        }

        .btn-remove-group:hover {
            background: rgba(255,255,255,0.15);
            color: var(--stele-white);
            border-color: rgba(255,255,255,0.6);
        }

        .group-subtotal-container {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 14px 16px;
            background: #f5f7f5;
            border-top: 1px solid #e8e8e8;
        }

        .group-subtotal-label {
            font-size: 13px;
            font-weight: 600;
            color: #666;
            margin-right: 20px;
        }

        .group-subtotal-amount {
            font-size: 17px;
            font-weight: 700;
            color: var(--stele-black);
            min-width: 120px;
            text-align: right;
        }

        .group-images-section {
            padding: 14px 16px;
            background: #f9f9f9;
            border-top: 1px solid #eee;
        }

        .group-images-header {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            margin-bottom: 8px;
        }

        .group-image-drop-zone {
            padding: 12px;
        }

        .group-image-drop-zone .image-drop-zone-text {
            font-size: 11px;
        }

        /* Description client par pièce */
        .client-description-section {
            padding: 10px 16px 12px; background: #fff; border-top: 1px solid #eee;
        }
        .client-desc-label {
            display: block; font-size: 12px; font-weight: 600; color: #444;
            margin-bottom: 6px;
        }
        .client-desc-textarea {
            width: 100%; padding: 8px 12px; border: 1px solid #e8e8e8; border-radius: 6px;
            font-family: inherit; font-size: 13px; resize: vertical; min-height: 40px;
            background: #fafafa; color: #333; line-height: 1.5;
        }
        .client-desc-textarea:focus { outline: none; border-color: var(--stele-green); background: #fff; }

        /* Toggle showInQuote sur images */
        .image-quote-toggle {
            position: absolute; bottom: 2px; left: 2px; display: flex; align-items: center; gap: 2px;
            background: rgba(0,0,0,0.6); color: #fff; padding: 1px 4px; border-radius: 3px;
            font-size: 9px; cursor: pointer;
        }
        .image-quote-toggle input[type="checkbox"] { width: 11px; height: 11px; margin: 0; }

        /* Exclusions */
        .exclusions-section {
            margin-top: 16px; padding: 14px 16px; background: #fafafa;
            border: 1px solid #e8e8e8; border-radius: 8px;
        }

        .btn-add-group {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 14px 20px;
            margin-bottom: 20px;
            background: var(--stele-white);
            color: var(--stele-green);
            border: 2px dashed #b5c4b8;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            width: 100%;
            justify-content: center;
        }

        .btn-add-group:hover { background: #eef2ef; border-color: var(--stele-green); }

        .calc-disclaimer {
            margin-top: 24px;
            padding: 16px;
            background: var(--stele-light-gray);
            border-radius: 4px;
            font-size: 13px;
            color: #666;
            font-style: italic;
        }

        .btn-pdf {
            display: none; /* Hidden - replaced by timeline CTA */
        }

        /* Ajout personnalis&eacute; */
        .ajout-description:focus,
        .ajout-price:focus,
        .ajout-markup:focus { outline: none; border-color: var(--stele-green); }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--stele-white);
            border-radius: 8px;
            width: 100%;
            max-width: 450px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--stele-gray);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--stele-black);
        }

        .modal-body { padding: 24px; }

        .form-group { margin-bottom: 16px; }
        .form-group:last-child { margin-bottom: 0; }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--stele-black);
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            font-size: 14px;
            font-family: inherit;
            border: 1px solid var(--stele-gray);
            border-radius: 4px;
            background: var(--stele-white);
        }

        .form-input:focus { outline: none; border-color: var(--stele-green); }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--stele-gray);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .btn-cancel {
            padding: 10px 20px;
            background: transparent;
            color: var(--stele-black);
            border: 1px solid var(--stele-gray);
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-cancel:hover { background: var(--stele-light-gray); }

        .btn-generate {
            padding: 10px 20px;
            background: var(--stele-green);
            color: var(--stele-white);
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-generate:hover { background: #3d4f42; }

        /* Modal edit (large) */
        .modal.modal-edit {
            max-width: 800px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        .modal.modal-edit .modal-body { overflow-y: auto; }
        .edit-row { display: flex; gap: 12px; }
        .edit-row .form-group { flex: 1; }

        /* Prix composé */
        .composed-price-section { display: flex; gap: 16px; margin-top: 8px; }
        .cp-table-wrap { flex: 1; min-width: 0; }
        .cp-section-title {
            font-size: 12px; font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.5px; color: var(--stele-green);
            margin-bottom: 10px; padding-bottom: 6px; border-bottom: 1px solid #f0f0f0;
        }
        .cp-sub-title { font-size: 11px; font-weight: 600; color: #555; margin-bottom: 6px; }
        .cp-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .cp-table th { text-align: left; font-weight: 600; font-size: 11px; color: #888; padding: 4px 6px; border-bottom: 1px solid #e0e0e0; }
        .cp-table th:last-child { text-align: right; }
        .cp-table td { padding: 3px 6px; }
        .cp-table td:first-child { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 140px; font-size: 11px; }
        .cp-table input[type="number"] { width: 100%; padding: 4px 6px; border: 1px solid #e0e0e0; border-radius: 3px; font-size: 12px; text-align: right; font-family: inherit; }
        .cp-table input[type="number"]:focus { outline: none; border-color: var(--stele-green); }
        .cp-table input[type="number"]:disabled { background: #f0f0f0; color: #999; cursor: not-allowed; }
        .cp-calculated {
            margin-top: 12px; padding: 10px 14px; background: #f8f8f4;
            border-radius: 6px; display: flex; justify-content: space-between;
            align-items: center; font-size: 14px;
        }
        .cp-calculated .cp-total-label { font-weight: 600; color: #555; }
        .cp-calculated .cp-total-value { font-weight: 700; font-size: 16px; color: var(--stele-green); }
        .cp-calculated .cp-breakdown { font-size: 11px; color: #888; margin-left: 8px; }

        /* Médias tagués */
        .cat-media-title {
            font-size: 12px; font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.5px; color: var(--stele-green);
            margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #f0f0f0;
        }
        .cat-dropzone {
            border: 2px dashed var(--stele-gray); border-radius: 6px; padding: 16px;
            text-align: center; cursor: pointer; transition: border-color 0.2s;
            font-size: 13px; color: #888; margin-bottom: 12px;
        }
        .cat-dropzone:hover, .cat-dropzone.dragover { border-color: var(--stele-green); color: var(--stele-green); }
        .cat-media-list { display: flex; flex-direction: column; gap: 10px; }
        .cat-media-item { display: flex; gap: 10px; padding: 10px; background: #f8f8f8; border-radius: 6px; align-items: flex-start; }
        .cat-media-item img { width: 80px; height: 60px; object-fit: cover; border-radius: 4px; border: 1px solid var(--stele-gray); flex-shrink: 0; }
        .cat-pdf-icon { width: 80px; height: 60px; background: #e8e8e8; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; color: #999; flex-shrink: 0; }
        .cat-media-info { flex: 1; min-width: 0; }
        .cat-media-tags { display: flex; flex-wrap: wrap; gap: 5px; }
        .cat-tag { display: inline-block; font-size: 11px; padding: 3px 8px; border-radius: 12px; cursor: pointer; border: 1px solid var(--stele-gray); background: #fff; color: #666; transition: all 0.15s; user-select: none; }
        .cat-tag.active { background: var(--stele-green); color: #fff; border-color: var(--stele-green); }
        .cat-media-remove { background: none; border: none; color: #c62828; cursor: pointer; font-size: 18px; padding: 0 4px; flex-shrink: 0; opacity: 0.5; transition: opacity 0.15s; }
        .cat-media-remove:hover { opacity: 1; }

        /* Toggle switch */
        .edit-toggle-row { display: flex; align-items: center; gap: 10px; }
        .edit-toggle { position: relative; display: inline-block; width: 38px; height: 22px; }
        .edit-toggle input { opacity: 0; width: 0; height: 0; }
        .edit-toggle .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #ddd; border-radius: 22px; transition: background 0.25s; }
        .edit-toggle .slider::before { content: ''; position: absolute; height: 16px; width: 16px; left: 3px; bottom: 3px; background: #fff; border-radius: 50%; transition: transform 0.25s; box-shadow: 0 1px 3px rgba(0,0,0,0.15); }
        .edit-toggle input:checked + .slider { background: var(--stele-green); }
        .edit-toggle input:checked + .slider::before { transform: translateX(16px); }
        .edit-toggle-label { font-size: 13px; color: var(--stele-black); }

        .edit-status { font-size: 13px; padding: 8px 12px; border-radius: 4px; margin-top: 8px; display: none; }
        .edit-status.success { display: block; background: #e8f5e9; color: #2e7d32; }
        .edit-status.error { display: block; background: #ffebee; color: #c62828; }

        @media (max-width: 768px) {
            .composed-price-section { flex-direction: column; }
            .modal.modal-edit { max-width: 98vw; }
        }

        /* Image zone */
        .image-drop-zone {
            border: 2px dashed #C8C8C8;
            border-radius: 6px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
            margin-top: 4px;
        }

        .image-drop-zone:hover,
        .image-drop-zone.dragover {
            border-color: var(--stele-green);
            background: #f0f7f1;
        }

        .image-drop-zone-text { font-size: 12px; color: #888; }
        .image-drop-zone-text strong { color: #555; }

        .image-previews {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .image-preview-item {
            position: relative;
            width: 90px;
            height: 90px;
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid #ddd;
        }

        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-preview-remove {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(0,0,0,0.6);
            color: #fff;
            border: none;
            cursor: pointer;
            font-size: 12px;
            line-height: 20px;
            text-align: center;
            padding: 0;
        }

        .image-preview-remove:hover { background: rgba(200,0,0,0.8); }
        .image-count { font-size: 11px; color: #888; margin-top: 4px; }

        .image-preview-item img { cursor: pointer; }

        /* Lightbox */
        .lightbox-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }

        .lightbox-overlay.active { display: flex; }

        .lightbox-overlay img {
            max-width: 90vw;
            max-height: 90vh;
            object-fit: contain;
            border-radius: 4px;
            box-shadow: 0 4px 30px rgba(0,0,0,0.4);
        }

        /* Modal Plans */
        .modal-close {
            position: absolute;
            top: 20px;
            right: 24px;
            background: none;
            border: none;
            font-size: 28px;
            line-height: 1;
            color: #888;
            cursor: pointer;
            transition: color 0.15s;
        }
        .modal-close:hover { color: var(--stele-black); }

        .plans-upload-zone {
            margin-bottom: 20px;
            padding: 16px;
            background: #f9f9f9;
            border: 1px dashed #ccc;
            border-radius: 6px;
            text-align: center;
        }

        .btn-upload-plan {
            padding: 12px 24px;
            background: var(--stele-green);
            color: var(--stele-white);
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            font-family: inherit;
        }
        .btn-upload-plan:hover { background: #3d4f42; }

        .plans-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .plans-empty {
            padding: 40px 20px;
            text-align: center;
            color: #888;
            font-size: 14px;
        }

        .plan-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            margin-bottom: 8px;
            transition: background 0.15s;
        }
        .plan-item:hover { background: #f9f9f9; }

        .plan-icon {
            font-size: 32px;
            color: #c62828;
        }

        .plan-info {
            flex: 1;
            min-width: 0;
        }

        .plan-version {
            font-size: 11px;
            font-weight: 700;
            color: var(--stele-green);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }

        .plan-filename {
            font-size: 14px;
            font-weight: 600;
            color: var(--stele-black);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .plan-meta {
            font-size: 11px;
            color: #888;
        }

        .plan-actions {
            display: flex;
            gap: 6px;
        }

        .plan-action-btn {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.15s;
            color: #555;
            font-family: inherit;
        }
        .plan-action-btn:hover {
            background: #f0f0f0;
            border-color: #b0b0b0;
            color: var(--stele-black);
        }
        .plan-action-btn.danger {
            color: #c62828;
            border-color: #ffcdd2;
        }
        .plan-action-btn.danger:hover {
            background: #ffebee;
            border-color: #ef9a9a;
        }

        /* PDF Viewer */
        .pdf-viewer-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 5000;
            justify-content: center;
            align-items: center;
        }
        .pdf-viewer-overlay.active { display: flex; }

        .pdf-viewer-container {
            width: 95vw;
            height: 95vh;
            background: #2b2b2b;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
        }

        .pdf-viewer-header {
            background: #1e1e1e;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #3a3a3a;
        }

        .pdf-viewer-title {
            font-size: 15px;
            font-weight: 600;
            color: #fff;
        }

        .pdf-viewer-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pdf-control-btn, .pdf-action-btn {
            background: #3a3a3a;
            border: 1px solid #4a4a4a;
            color: #e0e0e0;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-family: inherit;
            transition: all 0.15s;
        }
        .pdf-control-btn:hover, .pdf-action-btn:hover {
            background: #4a4a4a;
            border-color: #5a5a5a;
        }
        .pdf-control-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .pdf-action-btn {
            background: var(--stele-green);
            border-color: var(--stele-green);
            color: #fff;
            font-weight: 600;
        }
        .pdf-action-btn:hover {
            background: #3d4f42;
            border-color: #3d4f42;
        }

        .pdf-page-info, .pdf-zoom-info {
            color: #b0b0b0;
            font-size: 13px;
            min-width: 60px;
            text-align: center;
        }

        .pdf-control-divider {
            width: 1px;
            height: 20px;
            background: #4a4a4a;
            margin: 0 4px;
        }

        .pdf-viewer-close {
            background: none;
            border: none;
            color: #b0b0b0;
            font-size: 32px;
            line-height: 1;
            cursor: pointer;
            padding: 0;
            margin-left: 12px;
            transition: color 0.15s;
        }
        .pdf-viewer-close:hover { color: #fff; }

        .pdf-viewer-content {
            flex: 1;
            display: flex;
            overflow: hidden;
            background: #2b2b2b;
        }

        .pdf-sidebar {
            width: 180px;
            background: #1e1e1e;
            border-right: 1px solid #3a3a3a;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .pdf-sidebar-title {
            padding: 12px 16px;
            font-size: 11px;
            font-weight: 700;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #3a3a3a;
        }

        .pdf-thumbnails {
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .pdf-thumb {
            background: #2b2b2b;
            border: 2px solid transparent;
            border-radius: 4px;
            cursor: pointer;
            overflow: hidden;
            transition: all 0.15s;
            position: relative;
        }
        .pdf-thumb:hover {
            border-color: #5a5a5a;
        }
        .pdf-thumb.active {
            border-color: var(--stele-green);
            box-shadow: 0 0 0 1px var(--stele-green);
        }

        .pdf-thumb canvas {
            display: block;
            width: 100%;
            height: auto;
        }

        .pdf-thumb-label {
            position: absolute;
            bottom: 4px;
            right: 4px;
            background: rgba(0,0,0,0.7);
            color: #fff;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .pdf-canvas-container {
            flex: 1;
            overflow: auto;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        #pdfCanvas {
            display: block;
            max-width: 100%;
            height: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        /* Crop Modal */
        .crop-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.88); z-index: 3000;
            justify-content: center; align-items: center; flex-direction: column;
        }
        .crop-overlay.active { display: flex; }
        .crop-box {
            background: #fff; border-radius: 8px; overflow: hidden;
            width: 90vw; max-width: 800px; max-height: 90vh; display: flex; flex-direction: column;
        }
        .crop-header {
            padding: 14px 20px; font-weight: 700; font-size: 15px;
            border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between;
        }
        .crop-container { position: relative; flex: 1; min-height: 300px; max-height: 60vh; background: #222; overflow: hidden; }
        .crop-container img { display: block; max-width: 100%; }
        .crop-controls {
            padding: 12px 20px; display: flex; gap: 10px; align-items: center;
            border-top: 1px solid #eee; justify-content: space-between;
        }
        .crop-controls .crop-ratios { display: flex; gap: 6px; }
        .crop-controls .crop-ratio-btn {
            padding: 6px 16px; border: 2px solid #ccc; border-radius: 4px;
            background: #fff; cursor: pointer; font-size: 13px; font-weight: 600;
        }
        .crop-controls .crop-ratio-btn.active { border-color: var(--stele-green); background: var(--stele-green); color: #fff; }
        .crop-controls .crop-actions { display: flex; gap: 8px; }
        .crop-controls .crop-btn {
            padding: 8px 20px; border: none; border-radius: 4px;
            cursor: pointer; font-size: 13px; font-weight: 600;
        }
        .crop-btn-cancel { background: #eee; color: #555; }
        .crop-btn-confirm { background: var(--stele-green); color: #fff; }
        .crop-btn-confirm:disabled { opacity: 0.5; cursor: not-allowed; }
        .crop-error { padding: 10px 20px; background: #fee; color: #c00; font-size: 13px; display: none; }
        .crop-loading { padding: 20px; text-align: center; color: #888; font-size: 14px; }

        /* ═══════════════════════════════════════════════════════════════
           VUE LISTE DE PROJETS
           ═══════════════════════════════════════════════════════════════ */

        .project-list-view { display: none; }
        .project-list-view.active { display: block; }
        .calculator-view { display: none; }
        .calculator-view.active { display: block; }

        /* ═══════════════════════════════════════════════════════════════
           PREVIEW VIEW (Aperçu soumission)
           ═══════════════════════════════════════════════════════════════ */
        /* Preview — split layout (document gauche, outils droite) */
        .preview-view {
            display: none; position: fixed; top: 56px; left: 0; right: 0; bottom: 0;
            z-index: 50; background: #fff;
        }
        .preview-view.active { display: flex; flex-direction: column; }

        .pv-toolbar {
            display: flex; align-items: center; gap: 16px; flex-wrap: wrap;
            padding: 10px 24px; border-bottom: 2px solid var(--stele-black);
            background: #fff; flex-shrink: 0;
        }
        .pv-toolbar button {
            background: none; border: 1px solid var(--stele-green); color: var(--stele-green);
            padding: 6px 14px; border-radius: 4px; font-size: 12px; cursor: pointer; font-weight: 500;
        }
        .pv-toolbar button:hover { background: var(--stele-green); color: #fff; }
        .pv-toolbar-title { font-size: 16px; font-weight: 600; color: var(--stele-black); }
        .pv-toolbar-sub { font-size: 13px; color: var(--stele-green); font-weight: 600; margin-left: auto; }

        /* Split panels */
        .pv-split { flex: 1; display: flex; overflow: hidden; }
        .pv-left { flex: 1; overflow-y: auto; padding: 4px 0; background: #ddd; }
        .pv-right {
            width: 360px; min-width: 360px; overflow-y: auto;
            background: #f8f8f8; border-left: 1px solid rgba(0,0,0,0.1);
        }

        .pv-content {
            display: flex; flex-direction: column; gap: 4px;
        }

        /* ── Landscape pages (11 × 8.5 in) ── */
        .pv-page {
            background: #fff; padding: 36px 48px;
            aspect-ratio: 11 / 8.5;
            overflow: hidden; position: relative;
            display: flex; flex-direction: column;
        }

        /* Title page */
        .pv-page-title { justify-content: center; align-items: center; text-align: center; }
        .pv-page-title .pv-logo { height: 64px; margin-bottom: 32px; }
        .pv-page-title .pv-sub-number { font-size: 24px; font-weight: 700; color: var(--stele-green); margin-bottom: 6px; }
        .pv-page-title .pv-sub-date { font-size: 14px; color: #888; margin-bottom: 32px; }
        .pv-page-title .pv-client-name { font-size: 32px; font-weight: 300; color: var(--stele-black); margin-bottom: 6px; }
        .pv-page-title .pv-project-name { font-size: 18px; color: #666; }
        .pv-page-title .pv-designer { font-size: 14px; color: #999; margin-top: 4px; }
        .pv-page-title .pv-client-address { font-size: 14px; color: #999; margin-top: 2px; }

        /* Room page — landscape layout */
        .pv-page-room-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 20px; background: var(--stele-green); color: #fff;
            border-radius: 4px; margin-bottom: 38px; flex-shrink: 0;
        }
        .pv-page-room-name { font-size: 17px; font-weight: 600; letter-spacing: 0.3px; }
        .pv-page-room-subtotal { font-size: 17px; font-weight: 700; }
        .pv-page-room-body { flex: 1; display: flex; gap: 38px; overflow: hidden; min-height: 0; }
        .pv-page-room-text { flex: 1; display: flex; flex-direction: column; overflow: hidden; justify-content: center; }
        .pv-page-room-media {
            flex: 1; display: grid; grid-template-columns: repeat(2, 1fr);
            gap: 8px; align-content: center; max-height: 100%;
        }
        /* 1 image: single column, centered */
        .pv-page-room-media.imgs-1 { grid-template-columns: 1fr; }
        /* 2 images: stacked vertically, gap = header height */
        .pv-page-room-media.imgs-2 { grid-template-columns: 1fr; gap: 38px; }
        /* 3 images: first spans full width, 2 below side by side */
        .pv-page-room-media.imgs-3 { gap: 8px; }
        .pv-page-room-media.imgs-3 .pv-img-wrap:first-child { grid-column: 1 / -1; }
        .pv-page-room-media .pv-img-wrap { overflow: hidden; min-height: 0; }
        .pv-page-room-media .pv-img-wrap img {
            width: 100%; height: 100%; object-fit: cover; display: block; cursor: pointer;
        }
        .pv-page-room-desc {
            width: 100%; border: 1px dashed #ccc; border-radius: 4px;
            padding: 10px 12px; font-size: 13px; line-height: 1.5; color: #444;
            font-family: inherit; flex: 1; min-height: 60px;
            background: #fafafa; transition: border-color 0.2s;
            overflow-y: auto; white-space: normal; word-wrap: break-word;
        }
        .pv-page-room-desc:focus { outline: none; border-color: var(--stele-green); background: #fff; }
        .pv-page-room-desc[contenteditable="false"] { background: transparent; border-color: transparent; cursor: default; }
        .pv-page-room-desc:empty::before { content: attr(data-placeholder); color: #aaa; font-style: italic; }
        .pv-page-room-desc p { margin: 0 0 6px 0; }
        .pv-page-room-desc ul { margin: 4px 0 8px 0; padding-left: 20px; }
        .pv-page-room-desc li { margin-bottom: 2px; }
        .pv-page-room-desc strong { font-weight: 700; }

        /* Clauses page — compact */
        .pv-page-clauses-header {
            font-size: 12px; text-transform: uppercase; letter-spacing: 1px;
            color: var(--stele-green); font-weight: 700; margin-bottom: 14px;
            padding-bottom: 6px; border-bottom: 2px solid var(--stele-green);
        }
        .pv-page-clauses-body { flex: 1; overflow: hidden; }
        .pv-page-clause {
            margin-bottom: 8px; padding: 6px 14px;
            border-left: 3px solid var(--stele-green); background: #fafafa;
            border-radius: 0 3px 3px 0;
        }
        .pv-page-clause-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 2px; }
        .pv-page-clause-text {
            width: 100%; border: 1px dashed transparent; border-radius: 3px;
            padding: 2px 4px; font-size: 12px; line-height: 1.3; color: #555;
            font-family: inherit; resize: none; background: transparent;
        }
        .pv-page-clause-text:focus { outline: none; border-color: var(--stele-green); background: #fff; }
        .pv-page-clause-text:disabled { border-color: transparent; background: transparent; }
        .pv-page-clause-actions { display: flex; gap: 6px; margin-top: 2px; justify-content: flex-end; }

        /* Total page */
        .pv-page-total { justify-content: center; align-items: center; text-align: center; }
        .pv-total-box {
            padding: 36px 56px; background: var(--stele-black); color: #fff; border-radius: 6px;
        }
        .pv-total-box .total-label { font-size: 16px; font-weight: 300; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 10px; opacity: 0.8; }
        .pv-total-box .total-amount { font-size: 42px; font-weight: 700; }
        .pv-total-box .total-taxes { font-size: 13px; opacity: 0.6; margin-top: 6px; }
        .pv-page-footer-text { margin-top: 32px; font-size: 12px; color: #aaa; letter-spacing: 0.5px; }

        /* Steps page */
        .pv-page-steps { padding: 32px 48px; }
        .pv-steps-title {
            font-size: 12px; text-transform: uppercase; letter-spacing: 1px;
            color: var(--stele-green); font-weight: 700; margin-bottom: 20px;
            padding-bottom: 6px; border-bottom: 2px solid var(--stele-green);
        }
        .pv-steps-grid {
            flex: 1; display: grid; grid-template-columns: 1fr 1fr;
            grid-template-rows: repeat(4, 1fr); gap: 10px 48px;
            grid-auto-flow: column;
        }
        .pv-step { display: flex; gap: 16px; align-items: flex-start; }
        .pv-step-circle {
            width: 64px; height: 64px; min-width: 64px; border-radius: 50%;
            color: #fff; display: flex; align-items: center; justify-content: center;
            font-size: 24px; font-weight: 700; margin-top: 2px;
        }
        .pv-step-content { flex: 1; min-width: 0; }
        .pv-step-label {
            font-size: 12px; font-weight: 700; text-transform: uppercase;
            letter-spacing: 0.3px; color: var(--stele-black); margin-bottom: 4px;
        }
        .pv-step-desc { font-size: 11px; line-height: 1.45; color: #555; }

        /* Tools panel */
        .pv-tools-header {
            padding: 14px 20px; font-size: 13px; font-weight: 700;
            text-transform: uppercase; letter-spacing: 1px; color: var(--stele-black);
            border-bottom: 1px solid rgba(0,0,0,0.08); background: #f0f0f0;
            position: sticky; top: 0; z-index: 1;
        }
        .pv-tools-section { padding: 16px 20px; border-bottom: 1px solid rgba(0,0,0,0.06); }
        .pv-tools-section h5 {
            font-size: 11px; text-transform: uppercase; letter-spacing: 0.6px;
            color: var(--stele-green); margin-bottom: 10px; font-weight: 600;
        }
        .pv-tools-placeholder { font-size: 13px; color: #888; line-height: 1.4; font-style: italic; }

        .pv-clause-list { display: flex; flex-direction: column; gap: 6px; }
        .pv-clause-item {
            padding: 10px 12px; background: #fff; border: 1px solid rgba(0,0,0,0.08);
            border-radius: 4px; font-size: 13px; color: #333; cursor: grab;
            transition: box-shadow 0.15s, border-color 0.15s;
        }
        .pv-clause-item:hover { border-color: var(--stele-green); box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .pv-clause-item .clause-title { font-weight: 600; margin-bottom: 2px; }
        .pv-clause-item .clause-preview {
            font-size: 12px; color: #888; overflow: hidden;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
        }

        /* Image wrap (used in room pages) */
        .pv-img-wrap { position: relative; border-radius: 4px; overflow: hidden; }
        .pv-img-delete {
            position: absolute; top: 6px; right: 6px; width: 24px; height: 24px;
            border-radius: 50%; background: rgba(0,0,0,0.6); color: #fff;
            border: none; cursor: pointer; font-size: 14px; line-height: 24px;
            text-align: center; padding: 0; transition: background 0.15s;
            display: none;
        }
        .pv-img-wrap:hover .pv-img-delete { display: block; }
        .pv-img-delete:hover { background: rgba(200,0,0,0.85); }
        .pv-img-badge-client {
            position: absolute; bottom: 6px; left: 6px;
            background: rgba(75,96,80,0.85); color: #fff; font-size: 8px;
            padding: 2px 5px; border-radius: 3px; font-weight: 600;
            letter-spacing: 0.3px; text-transform: uppercase;
        }

        /* Client / presentation mode — hide edit UI */
        .pv-toolbar .btn-client-view {
            background: none; border: 1px solid #333; color: #333;
            padding: 6px 14px; border-radius: 4px; font-size: 12px;
            cursor: pointer; font-weight: 500; margin-left: 8px;
        }
        .pv-toolbar .btn-client-view:hover { background: #333; color: #fff; }
        .pv-toolbar .btn-client-view.active { background: #333; color: #fff; }
        .pv-optimize-btn {
            position: absolute; top: 6px; right: 6px; z-index: 2;
            background: var(--stele-green); color: #fff; border: none; border-radius: 4px;
            padding: 3px 10px; font-size: 11px; cursor: pointer; font-weight: 500; opacity: 0.8;
        }
        .pv-optimize-btn:hover { opacity: 1; }
        .pv-client-mode .pv-optimize-btn { display: none !important; }
        .pv-client-mode .pv-right { display: none; }
        .pv-client-mode .pv-page-room-desc { border-color: transparent; background: transparent; padding: 0; flex: initial; min-height: auto; }
        .pv-client-mode .pv-page-clause { background: transparent; border-left: 3px solid var(--stele-green); border: 1px solid #e0e0e0; border-left: 3px solid var(--stele-green); }
        .pv-client-mode .pv-page-clause-text { border-color: transparent; background: transparent; padding: 0; height: auto !important; overflow: visible; }
        .pv-client-mode .pv-page-clause-actions,
        .pv-client-mode .pv-clause-dropzone,
        .pv-client-mode .pv-img-delete { display: none !important; }

        /* Clause action buttons (in document) */
        .pv-doc-clause-btn {
            background: none; border: none; font-size: 10px; cursor: pointer;
            font-family: inherit; padding: 2px 5px; border-radius: 3px; transition: all 0.15s;
        }
        .pv-doc-clause-btn.remove { color: #c62828; }
        .pv-doc-clause-btn.remove:hover { background: #ffebee; }
        .pv-doc-clause-btn.save-lib { color: var(--stele-green); }
        .pv-doc-clause-btn.save-lib:hover { background: #e8f5e9; }

        /* Drop zone for clauses */
        .pv-clause-dropzone {
            padding: 10px; border: 2px dashed #ccc; border-radius: 4px;
            text-align: center; color: #aaa; font-size: 12px; font-style: italic;
            transition: all 0.2s; margin-top: 6px;
        }
        .pv-clause-dropzone.drag-over {
            border-color: var(--stele-green); background: #f0f7f1; color: var(--stele-green);
        }

        /* Fullscreen presentation mode */
        .pv-fullscreen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 9999; }
        .pv-fullscreen .pv-toolbar { display: none; }
        .pv-fullscreen .pv-right { display: none; }
        .pv-fullscreen .pv-left { padding: 0; background: #fff; scroll-snap-type: y mandatory; }
        .pv-fullscreen .pv-content { gap: 0; }
        .pv-fullscreen .pv-page {
            scroll-snap-align: start;
            height: 100vh; max-height: 100vh;
            width: calc(100vh * 11 / 8.5); max-width: 100vw;
            margin: 0 auto; box-sizing: border-box;
            aspect-ratio: auto;
        }
        .pv-fullscreen .pv-page-room-desc { border-color: transparent; background: transparent; padding: 0; flex: initial; min-height: auto; }
        .pv-fullscreen .pv-page-clause { background: transparent; border: 1px solid #e0e0e0; border-left: 3px solid var(--stele-green); }
        .pv-fullscreen .pv-page-clause-text { border-color: transparent; background: transparent; padding: 0; height: auto !important; overflow: visible; }
        .pv-fullscreen .pv-page-clause-actions,
        .pv-fullscreen .pv-clause-dropzone,
        .pv-fullscreen .pv-img-delete,
        .pv-fullscreen .pv-img-badge-client { display: none !important; }

        /* Tools panel — clause library items */
        .pv-lib-actions { display: flex; gap: 6px; margin-bottom: 10px; }
        .pv-btn-add-clause {
            background: var(--stele-green); color: #fff; border: none;
            padding: 6px 12px; border-radius: 4px; font-size: 11px;
            cursor: pointer; font-family: inherit; font-weight: 500;
        }
        .pv-btn-add-clause:hover { background: #3d5043; }
        .pv-clause-item {
            padding: 10px 12px; background: #fff; border: 1px solid rgba(0,0,0,0.08);
            border-radius: 4px; font-size: 13px; color: #333; cursor: grab;
            transition: box-shadow 0.15s, border-color 0.15s; margin-bottom: 6px;
        }
        .pv-clause-item:hover { border-color: var(--stele-green); box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .pv-clause-item.dragging { opacity: 0.5; }
        .pv-clause-item-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px;
        }
        .pv-clause-item-title { font-weight: 600; font-size: 12px; }
        .pv-clause-item-btns { display: flex; gap: 4px; }
        .pv-clause-item-btn {
            background: none; border: none; font-size: 11px; cursor: pointer;
            color: #888; padding: 1px 4px; border-radius: 2px;
        }
        .pv-clause-item-btn:hover { color: var(--stele-black); background: rgba(0,0,0,0.05); }
        .pv-clause-item-btn.add-to-sub { color: var(--stele-green); font-size: 14px; font-weight: 700; }
        .pv-clause-item-btn.add-to-sub:hover { background: #e8f5e9; }
        .pv-clause-item-btn.delete:hover { color: #c62828; background: #ffebee; }
        .pv-clause-item-preview {
            font-size: 11px; color: #999; overflow: hidden;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
            line-height: 1.3;
        }
        .pv-clause-empty { font-size: 12px; color: #aaa; font-style: italic; padding: 8px 0; }

        /* Clause edit modal (inline in tools panel) */
        .pv-clause-edit {
            padding: 12px; background: #fff; border: 2px solid var(--stele-green);
            border-radius: 6px; margin-bottom: 10px;
        }
        .pv-clause-edit label { font-size: 11px; font-weight: 600; color: #666; display: block; margin-bottom: 3px; }
        .pv-clause-edit input, .pv-clause-edit textarea {
            width: 100%; border: 1px solid #ddd; border-radius: 4px;
            padding: 6px 8px; font-size: 12px; font-family: inherit; margin-bottom: 8px;
        }
        .pv-clause-edit input:focus, .pv-clause-edit textarea:focus { outline: none; border-color: var(--stele-green); }
        .pv-clause-edit textarea { resize: vertical; min-height: 60px; line-height: 1.35; }
        .pv-clause-edit-btns { display: flex; gap: 6px; justify-content: flex-end; }
        .pv-clause-edit-btns button {
            padding: 5px 12px; border-radius: 4px; font-size: 11px;
            cursor: pointer; font-family: inherit; border: none;
        }
        .pv-clause-edit-btns .save { background: var(--stele-green); color: #fff; }
        .pv-clause-edit-btns .save:hover { background: #3d5043; }
        .pv-clause-edit-btns .cancel { background: #eee; color: #666; }
        .pv-clause-edit-btns .cancel:hover { background: #ddd; }

        /* Responsive — tools panel collapses on small screens */
        @media (max-width: 1100px) {
            .pv-right { width: 300px; min-width: 300px; }
        }
        @media (max-width: 900px) {
            .pv-split { flex-direction: column; }
            .pv-left { padding: 2px 0; }
            .pv-right { width: 100%; min-width: 100%; max-height: 240px; border-left: none; border-top: 1px solid rgba(0,0,0,0.1); }
            .pv-page-room-body { flex-direction: column; }
            .pv-page-room-media { grid-template-columns: 1fr 1fr; }
        }

        .project-list-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 24px; flex-wrap: wrap; gap: 12px;
        }
        .project-list-title { font-size: 28px; font-weight: 400; }

        .btn-new-project {
            background: var(--stele-green); color: #fff; border: none;
            padding: 10px 20px; font-size: 14px; cursor: pointer;
            border-radius: 6px; font-family: inherit; transition: background 0.15s;
        }
        .btn-new-project:hover { background: #3d4f41; }

        .project-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }

        .project-card {
            background: #fff; border: 1px solid #e0e0e0; border-radius: 8px;
            padding: 20px; cursor: pointer; transition: all 0.2s; position: relative;
        }
        .project-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.1); transform: translateY(-2px); }

        .project-card-name { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
        .project-card-client { font-size: 13px; color: #666; margin-bottom: 10px; }
        .project-card-meta { display: flex; align-items: center; justify-content: space-between; gap: 8px; }
        .project-card-date { font-size: 11px; color: #999; }

        .project-status-badge {
            display: inline-block; padding: 2px 10px; border-radius: 12px;
            font-size: 11px; font-weight: 600; text-transform: capitalize;
        }
        /* Nouveau workflow */
        .status-draft { background: #f0f0f0; color: #666; }
        .status-pending_internal { background: #e3f2fd; color: #1565c0; }
        .status-returned { background: #fff3e0; color: #e65100; }
        .status-approved_internal { background: #e8f5e9; color: #2e7d32; }
        .status-sent_client { background: #ede7f6; color: #4527a0; }
        .status-accepted { background: #e8f5e9; color: #1b5e20; }
        .status-invoiced { background: #fce4ec; color: #880e4f; }
        /* Legacy */
        .status-brouillon { background: #f0f0f0; color: #666; }
        .status-soumis { background: #e3f2fd; color: #1565c0; }
        .status-approuvé { background: #e8f5e9; color: #2e7d32; }
        .status-envoyé { background: #fff3e0; color: #e65100; }
        .status-signé { background: #e8f5e9; color: #1b5e20; }

        /* Soumissions dans la carte projet */
        .project-subs { margin: 10px 0 8px; }
        .sub-line {
            display: flex; align-items: center; gap: 8px; padding: 6px 10px;
            border-radius: 6px; cursor: pointer; transition: background 0.15s;
        }
        .sub-line:hover { background: #f5f5f5; }
        .sub-number { font-size: 12px; font-weight: 700; color: var(--stele-green); min-width: 40px; }
        .sub-title { font-size: 13px; color: #333; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .sub-empty { font-size: 12px; color: #aaa; padding: 8px 10px; font-style: italic; }
        .btn-add-sub {
            display: block; width: 100%; padding: 6px 0; margin-top: 4px;
            background: none; border: 1px dashed #ccc; border-radius: 6px;
            color: #888; font-size: 12px; cursor: pointer; transition: all 0.15s;
        }
        .btn-add-sub:hover { border-color: var(--stele-green); color: var(--stele-green); background: #f9faf9; }

        /* Panneau soumissions dans le calculateur */
        .header-sub-panel {
            display: none; background: #fff; border: 1px solid #e0e0e0; border-radius: 8px;
            padding: 10px 14px; margin: -8px 0 16px;
        }
        .header-sub-panel .sub-line {
            display: flex; align-items: center; gap: 8px;
            padding: 6px 8px; border-radius: 4px; cursor: pointer;
        }
        .header-sub-panel .sub-line:hover { background: #f5f5f5; }
        .header-sub-panel .sub-line.active { background: #eef3ef; }
        .header-sub-panel .sub-line.active .sub-number { color: var(--stele-black); }
        .header-sub-panel .sub-line .sub-kebab {
            margin-left: auto; background: none; border: none;
            color: #999; cursor: pointer; font-size: 16px; padding: 2px 6px;
            font-family: inherit; border-radius: 4px;
        }
        .header-sub-panel .sub-line .sub-kebab:hover { color: #333; background: #e0e0e0; }
        .header-sub-panel .header-sub-label {
            font-size: 11px; font-weight: 600; color: #888; text-transform: uppercase;
            letter-spacing: 0.5px; margin-bottom: 6px;
        }

        /* ── Main action buttons ── */
        .ph-actions { display: none; /* replaced by timeline CTA */ }
        .btn-main-action {
            display: none; padding: 12px 28px; font-size: 15px; font-weight: 600;
            border: none; border-radius: 8px; cursor: pointer; font-family: inherit;
            transition: opacity 0.15s; background: #1565c0; color: #fff;
        }
        .btn-main-action:hover { opacity: 0.85; }
        .btn-main-green { background: var(--stele-green); color: #fff; }
        .btn-main-orange { background: #e65100; color: #fff; }
        .btn-main-purple { background: #4527a0; color: #fff; }
        .btn-main-red { background: #c0392b; color: #fff; }

        /* ── Kebab menu ── */
        .kebab-menu { position: relative; }
        .btn-kebab {
            background: #f5f5f5; border: 1px solid #e0e0e0; border-radius: 50%;
            width: 32px; height: 32px; font-size: 16px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            color: #666; transition: all 0.15s; font-family: inherit;
        }
        .btn-kebab:hover { background: #eee; border-color: #ccc; }
        .btn-kebab.active { background: var(--stele-green); color: #fff; border-color: var(--stele-green); }
        .kebab-dropdown {
            display: none; position: absolute; top: 100%; right: 0; margin-top: 4px;
            background: #fff; border: 1px solid #e0e0e0; border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1); min-width: 180px; z-index: 100;
            padding: 4px 0;
        }
        .kebab-dropdown.open { display: block; }
        .kebab-dropdown button {
            display: flex; align-items: center; gap: 10px; width: 100%;
            background: none; border: none; padding: 10px 16px; font-size: 13px;
            font-family: inherit; cursor: pointer; color: #333; text-align: left;
        }
        .kebab-dropdown button:hover { background: #f5f5f5; }
        .kebab-icon { font-size: 15px; width: 20px; text-align: center; }

        /* Version Drawer */
        .version-drawer { position:fixed; right:0; top:0; width:360px; height:100vh; background:#fff; box-shadow:-4px 0 20px rgba(0,0,0,.15); z-index:1000; display:flex; flex-direction:column; transition:transform .3s ease; }
        .version-drawer-header { padding:16px 20px; border-bottom:1px solid #e0e0e0; display:flex; justify-content:space-between; align-items:center; }
        .version-drawer-header h3 { margin:0; font-size:16px; }
        .btn-close-drawer { background:none; border:none; font-size:22px; cursor:pointer; color:#666; padding:4px 8px; }
        .btn-close-drawer:hover { color:#000; }
        .version-list { flex:1; overflow-y:auto; padding:12px; }
        .version-card { padding:12px; border:1px solid #e0e0e0; border-radius:8px; margin-bottom:8px; cursor:pointer; transition:all .15s; }
        .version-card:hover { background:#f5f5f5; border-color:#bbb; }
        .version-snapshot-overlay { position:fixed; inset:0; background:rgba(0,0,0,.85); z-index:1100; overflow-y:auto; padding:40px; }

        .bypass-badge {
            display: inline-block; background: #ffebee; color: #c0392b;
            font-size: 9px; font-weight: 700; padding: 2px 6px;
            border-radius: 3px; margin-left: 6px; text-transform: uppercase;
            letter-spacing: 0.3px; vertical-align: middle;
        }
        .timeline-dot-bypass { background: #c0392b; }
        .timeline-action-bypass { color: #c0392b; font-weight: 700; }
        .timeline-comment-bypass { background: #ffebee; border-left: 3px solid #c0392b; padding: 6px 10px; border-radius: 4px; }
        .timeline-dot-offline_accepted { background: #2e7d32; }
        .timeline-action-offline_accepted { color: #2e7d32; font-weight: 700; }
        .timeline-comment-offline_accepted { background: #e8f5e9; border-left: 3px solid #2e7d32; padding: 6px 10px; border-radius: 4px; }
        .timeline-dot-invoiced { background: #4527a0; }
        .timeline-action-invoiced { color: #4527a0; font-weight: 700; }
        .timeline-dot-duplicated { background: #546e7a; }
        .timeline-action-duplicated { color: #546e7a; font-weight: 700; }
        .timeline-dot-unlocked { background: #c62828; }
        .timeline-action-unlocked { color: #c62828; font-weight: 700; text-transform: uppercase; }
        .timeline-comment-unlocked { background: #ffebee; border-left: 3px solid #c62828; padding: 6px 10px; border-radius: 4px; font-weight: 600; }
        .status-badge {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 5px 12px; font-size: 11px; font-weight: 700;
            border-radius: 12px; text-transform: uppercase; letter-spacing: 0.3px;
        }
        .status-draft { background: #f0f0f0; color: #666; }
        .status-pending_internal { background: #fff3e0; color: #e65100; }
        .status-returned { background: #fce4ec; color: #c62828; }
        .status-approved_internal { background: #e8f5e9; color: #2e7d32; }
        .status-sent_client { background: #e3f2fd; color: #1565c0; }
        .status-accepted { background: #e8f5e9; color: #1b5e20; }
        .status-invoiced { background: #ede7f6; color: #4527a0; }

        .project-card-delete {
            position: absolute; top: 8px; right: 8px; background: none; border: none;
            color: #ccc; cursor: pointer; font-size: 18px; padding: 4px 8px;
            border-radius: 4px; transition: all 0.15s; line-height: 1;
        }
        .project-card-delete:hover { color: #c62828; background: #ffebee; }

        .project-empty {
            text-align: center; padding: 60px 20px; color: #999; font-size: 15px;
        }

        /* Formulaire nouveau projet (inline) */
        .new-project-form {
            display: none; background: #f8f8f8; border: 1px solid #e0e0e0;
            border-radius: 8px; padding: 20px; margin-bottom: 20px;
        }
        .new-project-form.active { display: block; }
        .new-project-form .form-row {
            display: flex; gap: 12px; margin-bottom: 12px; flex-wrap: wrap;
        }
        .new-project-form input {
            flex: 1; min-width: 200px; padding: 10px 14px; font-size: 14px;
            border: 1px solid #ccc; border-radius: 6px; font-family: inherit;
        }
        .new-project-form input:focus { outline: none; border-color: var(--stele-green); }
        .new-project-form-actions { display: flex; gap: 8px; }
        .btn-create-project {
            background: var(--stele-green); color: #fff; border: none;
            padding: 10px 20px; font-size: 14px; cursor: pointer;
            border-radius: 6px; font-family: inherit;
        }
        .btn-create-project:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-cancel-project {
            background: #fff; color: #666; border: 1px solid #ccc;
            padding: 10px 20px; font-size: 14px; cursor: pointer;
            border-radius: 6px; font-family: inherit;
        }

        /* ═══════════════════════════════════════════════════════════════
           HEADER PROJET (dans le calculateur)
           ═══════════════════════════════════════════════════════════════ */

        .project-header {
            background: #fff; border: 1px solid #e0e0e0; border-radius: 8px;
            padding: 20px 24px; margin-bottom: 16px; position: relative;
            display: flex; flex-direction: column; gap: 4px;
        }
        .ph-top-bar {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 8px;
        }
        .ph-top-actions { display: flex; align-items: center; gap: 8px; }
        .btn-back-projects {
            background: none; border: none; color: var(--stele-green);
            cursor: pointer; font-size: 14px; font-family: inherit;
            padding: 6px 0; white-space: nowrap;
        }
        .btn-back-projects:hover { text-decoration: underline; }
        .btn-header-link {
            background: none; border: none; color: #555; font-size: 13px;
            font-family: inherit; cursor: pointer; padding: 4px 8px;
            transition: color 0.15s;
        }
        .btn-header-link:hover { color: var(--stele-green); }
        .ph-project-name {
            font-size: 26px; font-weight: 700; border: none; outline: none;
            background: transparent; font-family: inherit; color: var(--stele-black);
            padding: 0; width: 100%;
        }
        .ph-project-name:hover { background: #fafafa; }
        .ph-project-name:focus { background: #fff; box-shadow: 0 0 0 2px rgba(75,96,80,0.15); border-radius: 4px; }
        .ph-status-row { margin: 4px 0; }
        .ph-total-section { margin: 12px 0 4px; }
        .ph-total-label { font-size: 12px; color: #888; margin-bottom: 2px; }
        .ph-total-amount { font-size: 28px; font-weight: 700; color: var(--stele-black); }
        .save-indicator {
            font-size: 11px; color: #999; white-space: nowrap;
            position: absolute; top: 8px; right: 12px;
        }
        .save-indicator.saving { color: var(--stele-green); }

        /* Status Timeline */
        .status-timeline {
            margin: 16px 0 4px; display: flex; align-items: center; gap: 0;
            position: relative;
        }
        .timeline-step {
            display: flex; align-items: center; gap: 6px; position: relative; flex: 0 0 auto;
            padding-right: 16px;
        }
        .timeline-step:last-child { padding-right: 0; }
        .timeline-step::after {
            content: ''; position: absolute; right: -1px; top: 50%;
            transform: translateY(-50%); width: 24px; height: 1px; background: #ddd;
        }
        .timeline-step:last-child::after { display: none; }
        .timeline-step.completed::after { background: #4caf50; }
        .timeline-circle {
            width: 20px; height: 20px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; font-size: 11px; flex-shrink: 0;
        }
        .timeline-step.completed .timeline-circle {
            background: #4caf50; color: #fff;
        }
        .timeline-step.active .timeline-circle {
            background: var(--stele-green); color: #fff; box-shadow: 0 0 0 3px rgba(75,96,80,0.15);
        }
        .timeline-step.active.returned .timeline-circle {
            background: #ff9800; box-shadow: 0 0 0 3px rgba(255,152,0,0.15);
        }
        .timeline-step.future .timeline-circle {
            background: #f0f0f0; color: #bbb; border: 1px solid #ddd;
        }
        .timeline-label {
            font-size: 12px; color: #666; white-space: nowrap;
        }
        .timeline-step.active .timeline-label {
            font-weight: 700; color: var(--stele-black);
        }
        .timeline-step.completed .timeline-label {
            color: #666;
        }
        .timeline-cta {
            margin-left: auto; padding-left: 16px;
        }
        .timeline-cta button {
            background: var(--stele-green); color: #fff; border: none; padding: 8px 20px;
            border-radius: 6px; font-size: 13px; font-weight: 600; font-family: inherit;
            cursor: pointer; transition: all 0.15s; white-space: nowrap;
        }
        .timeline-cta button:hover {
            background: #3e4f42; transform: translateY(-1px); box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        .timeline-cta button.btn-orange {
            background: #ff9800;
        }
        .timeline-cta button.btn-orange:hover {
            background: #f57c00;
        }

        /* Timeline step clickable (pour copier lien client) */
        .timeline-step.clickable {
            cursor: pointer;
        }
        .timeline-step.clickable .timeline-circle {
            animation: heartbeat 2s ease-in-out infinite;
        }
        .timeline-step.clickable:hover .timeline-circle {
            transform: scale(1.1);
            box-shadow: 0 0 0 4px rgba(75,96,80,0.25);
        }
        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            14% { transform: scale(1.15); }
            28% { transform: scale(1); }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Modal Rentabilité */
        /* ── Rentabilité modal ── */
        .rentab-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4); z-index: 9000; justify-content: center; align-items: flex-start; padding: 40px 20px;
        }
        .rentab-overlay.active { display: flex; }
        .rentab-modal {
            background: #fff; border-radius: 10px; max-width: 1100px; width: 100%;
            max-height: 90vh; overflow-y: auto; box-shadow: 0 8px 40px rgba(0,0,0,0.2);
        }
        .rentab-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px 32px; border-bottom: 1px solid #e8e8e8;
        }
        .rentab-header h2 { font-size: 18px; font-weight: 600; color: var(--stele-black); margin: 0; }
        .rentab-close {
            background: none; border: none; font-size: 24px; cursor: pointer; color: #999;
            padding: 4px 8px; transition: color 0.15s;
        }
        .rentab-close:hover { color: var(--stele-black); }
        .rentab-body { padding: 28px 32px; }
        .rentab-columns { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; }
        .rentab-section { margin-bottom: 24px; }
        .rentab-section-title {
            font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
            color: #666; margin-bottom: 10px; padding-bottom: 6px; border-bottom: 1px solid #e8e8e8;
        }
        .rentab-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .rentab-table td { padding: 6px 10px; }
        .rentab-table td:first-child { color: #555; font-weight: 400; }
        .rentab-table td:last-child { text-align: right; font-weight: 600; font-family: 'SF Mono', 'Consolas', monospace; color: var(--stele-black); }
        .rentab-table tr.highlight td { background: #f5f5f5; font-weight: 700; color: var(--stele-black); border-radius: 4px; }
        .rentab-table tr.highlight td:first-child { font-size: 12px; text-transform: uppercase; letter-spacing: 0.3px; }
        .rentab-table tr.total td { border-top: 1px solid #ccc; font-weight: 700; font-size: 14px; padding-top: 10px; }
        .rentab-table tr.spacer td { padding: 8px 0; }
        .rentab-dept-table { width: 100%; border-collapse: collapse; font-size: 12px; border: 1px solid #e8e8e8; border-radius: 6px; overflow: hidden; }
        .rentab-dept-table th {
            background: #f5f5f5; color: #666; padding: 8px 8px;
            font-weight: 600; font-size: 11px; text-align: center; border-bottom: 1px solid #e8e8e8;
        }
        .rentab-dept-table td { padding: 8px 8px; text-align: right; font-family: 'SF Mono', 'Consolas', monospace; color: var(--stele-black); }
        .rentab-dept-table td:first-child { text-align: left; font-family: inherit; color: #555; font-weight: 500; }
        .rentab-margins {
            margin-top: 8px; border: 1px solid #e8e8e8; border-radius: 6px; overflow: hidden;
        }
        .rentab-margins-row {
            display: flex; justify-content: space-between; padding: 8px 14px;
            font-size: 13px; border-bottom: 1px solid #eee; align-items: center;
        }
        .rentab-margins-row:last-child { border-bottom: none; }
        .rentab-margins-row.profit-row { background: #f5f5f5; font-weight: 700; }
        .rentab-margins-row span:first-child { color: #555; }
        .rentab-margins-row span:last-child { font-weight: 600; font-family: 'SF Mono', 'Consolas', monospace; color: var(--stele-black); }
        .rentab-full { grid-column: 1 / -1; }
        .rentab-footer {
            padding: 16px 32px 24px; display: flex; justify-content: flex-end;
        }
        .rentab-footer button {
            padding: 10px 28px; background: #fff; border: 1px solid #ddd; border-radius: 6px;
            font-size: 14px; font-family: inherit; cursor: pointer; color: #333; transition: all 0.15s;
        }
        .rentab-footer button:hover { background: #f5f5f5; border-color: #bbb; }
        .btn-rentab {
            background: none; border: 1px solid rgba(255,255,255,0.4); color: rgba(255,255,255,0.85);
            padding: 4px 10px; border-radius: 4px; font-size: 11px; cursor: pointer; white-space: nowrap;
            font-family: inherit; transition: all 0.15s;
        }
        .btn-rentab:hover { background: rgba(255,255,255,0.15); border-color: rgba(255,255,255,0.7); }
        /* Print */
        @media print {
            .nav-bar { display: none; }
            .btn-add, .btn-remove, .add-row-container, .group-images-section { display: none !important; }
            .item-select { border: none; background: none; padding: 0; appearance: none; background-image: none; }
            .qty-input, .ajout-description, .ajout-price, .ajout-markup { border: none; background: none; }
            .calculator-container { page-break-inside: avoid; }
        }

        /* Responsive */
        @media (max-width: 900px) {
            .nav-bar { padding: 12px 20px; gap: 16px; }
            .main-content { padding: 24px 16px; }
            .calc-header, .calc-row {
                grid-template-columns: 24px 1fr 70px 70px 90px 80px 24px 100px 24px;
                gap: 4px;
                padding: 3px 8px;
                font-size: 10px;
            }
            .btn-add, .btn-remove, .btn-add-group { font-size: 12px; }
            .ajout-description, .ajout-price, .ajout-markup { font-size: 11px !important; }
            .calculator-container { font-size: 13px; }
        }

        /* ═══════════════════════════════════════════════════════════════
           TIMELINE DRAWER (historique soumission)
           ═══════════════════════════════════════════════════════════════ */
        .timeline-drawer-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.3); z-index: 8500;
        }
        .timeline-drawer-overlay.active { display: block; }
        .timeline-drawer {
            position: fixed; top: 0; right: -420px; width: 400px; height: 100%;
            background: #fff; box-shadow: -4px 0 20px rgba(0,0,0,0.15);
            z-index: 8600; transition: right 0.3s ease; overflow-y: auto;
        }
        .timeline-drawer.active { right: 0; }
        .timeline-drawer-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 20px; border-bottom: 2px solid var(--stele-green);
            background: #fafafa; position: sticky; top: 0; z-index: 1;
        }
        .timeline-drawer-header h3 { font-size: 15px; font-weight: 700; margin: 0; color: var(--stele-black); }
        .timeline-drawer-close {
            background: none; border: none; font-size: 20px; cursor: pointer; color: #666; padding: 0 4px;
        }
        .timeline-drawer-close:hover { color: var(--stele-black); }
        .timeline-drawer-body { padding: 20px; }
        .timeline-empty { text-align: center; color: #999; font-size: 13px; padding: 40px 0; font-style: italic; }

        .timeline-entry { position: relative; padding-left: 28px; margin-bottom: 20px; }
        .timeline-entry::before {
            content: ''; position: absolute; left: 8px; top: 24px; bottom: -20px;
            width: 2px; background: #e0e0e0;
        }
        .timeline-entry:last-child::before { display: none; }
        .timeline-dot {
            position: absolute; left: 2px; top: 6px; width: 14px; height: 14px;
            border-radius: 50%; border: 2px solid #fff;
        }
        .timeline-dot-submitted { background: #1565c0; }
        .timeline-dot-approved { background: #2e7d32; }
        .timeline-dot-returned { background: #e65100; }
        .timeline-dot-sent { background: #4527a0; }
        .timeline-entry-header {
            display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 4px;
        }
        .timeline-action {
            font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px;
        }
        .timeline-action-submitted { color: #1565c0; }
        .timeline-action-approved { color: #2e7d32; }
        .timeline-action-returned { color: #e65100; }
        .timeline-action-sent { color: #4527a0; }
        .timeline-date { font-size: 11px; color: #999; }
        .timeline-reviewer { font-size: 12px; color: #666; margin-bottom: 4px; }
        .timeline-comment {
            font-size: 13px; color: #444; background: #f8f8f8;
            border-radius: 6px; padding: 8px 12px; border-left: 3px solid #e0e0e0;
        }
        .timeline-comment-submitted { border-left-color: #1565c0; }
        .timeline-comment-approved { border-left-color: #2e7d32; }
        .timeline-comment-returned { border-left-color: #e65100; }
        .timeline-comment-sent { border-left-color: #4527a0; }
        .timeline-version { font-size: 10px; color: #aaa; margin-top: 4px; }

        @media (max-width: 600px) {
            .timeline-drawer { width: 100%; right: -100%; }
        }
    </style>
</head>
<body>

    <!-- Nav bar -->
    <nav class="nav-bar">
        <span class="nav-logo">stele</span>
        <div class="nav-links">
            <a href="app.html" class="nav-back">&larr; Menu</a>
        </div>
        <div class="data-status" id="dataStatus">
            <span class="status-dot"></span>
            <span class="status-text" id="statusText">Chargement...</span>
        </div>
    </nav>

    <!-- Contenu principal -->
    <div class="main-content">

        <!-- ═══════ VUE 1 : LISTE DES PROJETS ═══════ -->
        <div class="project-list-view active" id="projectListView">
            <div class="project-list-header">
                <h1 class="project-list-title">Mes projets</h1>
                <button class="btn-new-project" onclick="showNewProjectForm()">+ Nouveau projet</button>
            </div>

            <div class="new-project-form" id="newProjectForm">
                <div class="form-row">
                    <input type="text" id="newProjectName" placeholder="Nom du projet (ex: R&eacute;sidence Tremblay)" onkeydown="if(event.key==='Enter')handleCreateProject()">
                </div>
                <div class="new-project-form-actions">
                    <button class="btn-create-project" id="btnCreateProject" onclick="handleCreateProject()">Cr&eacute;er</button>
                    <button class="btn-cancel-project" onclick="hideNewProjectForm()">Annuler</button>
                </div>
            </div>

            <div id="projectGrid" class="project-grid">
                <!-- Rempli dynamiquement -->
            </div>
            <div class="project-empty" id="projectEmpty" style="display:none;">
                Aucun projet pour le moment.<br>Cliquez sur &laquo; + Nouveau projet &raquo; pour commencer.
            </div>
        </div>

        <!-- ═══════ VUE 2 : CALCULATEUR ═══════ -->
        <div class="calculator-view" id="calculatorView">

            <div class="project-header" id="projectHeader">
                <div class="ph-top-bar">
                    <button class="btn-back-projects" id="btnBackProjects" onclick="backToProjectList()">&larr; Projets</button>
                    <div class="ph-top-actions">
                        <button class="btn-header-link" id="btnPreview" onclick="openPreview()">Aper&ccedil;u</button>
                        <button class="btn-header-link" onclick="openRentab('project')">Rentabilit&eacute;</button>
                        <button class="btn-header-link" id="btnPlans" onclick="openPlansModal()">Plans</button>
                        <div class="kebab-menu" id="headerKebab">
                            <button class="btn-kebab" onclick="toggleHeaderKebab(event)">&middot;&middot;&middot;</button>
                            <div class="kebab-dropdown" id="headerKebabDropdown">
                                <button id="kebabDuplicate" onclick="duplicateSubmission(); closeHeaderKebab()"><span class="kebab-icon">&#9633;</span> Dupliquer</button>
                                <button id="kebabVersions" onclick="openVersionDrawer(); closeHeaderKebab()"><span class="kebab-icon">&#9776;</span> Versions</button>
                                <button id="kebabTimeline" onclick="openTimelineDrawer(); closeHeaderKebab()"><span class="kebab-icon">&#9201;</span> Historique</button>
                                <button id="kebabUnlock" onclick="unlockSubmission(); closeHeaderKebab()" style="display:none;"><span class="kebab-icon">&#128275;</span> D&eacute;verrouiller</button>
                            </div>
                        </div>
                    </div>
                </div>
                <input type="text" class="ph-project-name" id="projName" placeholder="Nom du projet" onblur="saveProjectField()">
                <span class="save-indicator" id="saveIndicator"></span>
                <div class="ph-status-row">
                    <span class="status-badge" id="subStatusBadge"></span>
                </div>
                <div class="ph-total-section">
                    <div class="ph-total-label">Total estim&eacute;</div>
                    <div class="ph-total-amount" id="headerTotal">0,00 $</div>
                </div>
                <div class="status-timeline" id="statusTimeline"></div>
                <div class="ph-actions" id="mainActions">
                    <button class="btn-main-action" id="btnWfSubmit" onclick="openSubmitModal()">Soumettre</button>
                    <button class="btn-main-action btn-main-green" id="btnWfApprove" onclick="approveSubmission()">Approuver</button>
                    <button class="btn-main-action btn-main-orange" id="btnWfReturn" onclick="returnSubmission()">Retourner</button>
                    <button class="btn-main-action btn-main-purple" id="btnWfSendClient" onclick="sendToClient()">Envoyer au client</button>
                    <button class="btn-main-action btn-main-red" id="btnWfBypass" onclick="bypassApproval()">Envoyer sans approbation</button>
                    <button class="btn-main-action btn-main-green" id="btnWfAcceptOffline" onclick="offlineAcceptance()">Confirmer la vente</button>
                    <button class="btn-main-action btn-main-purple" id="btnWfInvoiced" onclick="markInvoiced()">Marquer factur&eacute;e</button>
                </div>
                <input type="hidden" id="subTitle" value="">
                <span id="subNumber" style="display:none;"></span>
                <label style="display:none;"><input type="checkbox" id="projInstallation" checked onchange="toggleProjectInstallation()"></label>
            </div>

            <div class="header-sub-panel" id="headerSubPanel">
                <div class="header-sub-label">Soumissions du projet</div>
                <div id="headerSubList"></div>
                <button class="btn-add-sub" id="btnAddSubHeader" onclick="handleAddSubmissionFromCalc()">+ Nouvelle soumission</button>
            </div>

            <h1 class="page-title">Calculateur</h1>
            <p class="page-subtitle">Calculez des estimations budg&eacute;taires &agrave; partir du catalogue de prix.</p>

            <div class="calculator-container">
            <div id="furnitureGroups">
                <!-- Le premier meuble est cr&eacute;&eacute; par JS au chargement -->
            </div>

            <button class="btn-add-group" onclick="addFurnitureGroup()">+ Ajouter un meuble</button>

            <div class="grand-total-container">
                <span class="grand-total-label">Total estim&eacute;</span>
                <span class="grand-total-amount" id="grandTotal">0,00 $</span>
            </div>


            <button class="btn-pdf" id="btnOpenSubmit" onclick="openSubmitModal()">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Soumettre pour approbation
            </button>
        </div>

        </div><!-- fin calculator-view -->

        <!-- ═══════ PREVIEW VIEW (split layout) ═══════ -->
        <div class="preview-view" id="previewView">
            <div class="pv-toolbar">
                <button onclick="closePreview()">&larr; Retour au calculateur</button>
                <span class="pv-toolbar-title">Aper&ccedil;u soumission</span>
                <span class="pv-toolbar-sub" id="pvSubNumber"></span>
                <button class="btn-client-view" id="btnPresentation" onclick="openPresentation()" title="Plein &eacute;cran">Pr&eacute;sentation</button>
                <button class="btn-client-view" id="btnLang" onclick="toggleLang()" title="Changer la langue">EN</button>
            </div>
            <div class="pv-split">
                <div class="pv-left">
                    <div class="pv-content" id="pvContent"></div>
                </div>
                <div class="pv-right" id="pvRight">
                    <div class="pv-tools-header">Outils</div>
                    <div class="pv-tools-section">
                        <h5>Biblioth&egrave;que de clauses</h5>
                        <div class="pv-lib-actions">
                            <button class="pv-btn-add-clause" onclick="showClauseEditor()">+ Nouvelle clause</button>
                        </div>
                        <div id="pvClauseEditZone"></div>
                        <div class="pv-clause-list" id="pvClauseList"></div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Modal Rentabilité -->
    <div class="rentab-overlay" id="rentabModal" onclick="if(event.target===this)closeRentab()">
        <div class="rentab-modal">
            <div class="rentab-header">
                <h2 id="rentabTitle">Rentabilit&eacute;</h2>
                <button class="rentab-close" onclick="closeRentab()">&times;</button>
            </div>
            <div class="rentab-body" id="rentabBody"></div>
            <div class="rentab-footer">
                <button onclick="closeRentab()">Annuler</button>
            </div>
        </div>
    </div>

    <!-- Modal g\u00e9n\u00e9rique (confirm / prompt / alert) -->
    <div class="modal-overlay" id="steleDialogOverlay">
        <div class="modal" style="max-width:440px;">
            <div class="modal-header">
                <h3 class="modal-title" id="steleDialogTitle"></h3>
            </div>
            <div class="modal-body">
                <p id="steleDialogMessage" style="font-size:14px; color:#444; margin-bottom:12px;"></p>
                <div id="steleDialogInputWrap" style="display:none;">
                    <input type="text" class="form-input" id="steleDialogInput" style="font-size:14px;">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" id="steleDialogCancel" onclick="steleDialogResolve(null)" style="display:none;">Annuler</button>
                <button class="btn-generate" id="steleDialogOk" onclick="steleDialogOk()">OK</button>
            </div>
        </div>
    </div>

    <!-- Timeline drawer (historique soumission) -->
    <div class="timeline-drawer-overlay" id="timelineOverlay" onclick="closeTimelineDrawer()"></div>
    <div class="timeline-drawer" id="timelineDrawer">
        <div class="timeline-drawer-header">
            <h3>Historique</h3>
            <button class="timeline-drawer-close" onclick="closeTimelineDrawer()">&times;</button>
        </div>
        <div class="timeline-drawer-body" id="timelineBody">
            <div class="timeline-empty">Aucun historique</div>
        </div>
    </div>

    <!-- Modal Soumettre la soumission -->
    <div class="modal-overlay" id="pdfModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="submitModalTitle">Soumettre la soumission</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="projectDate">Date requise</label>
                    <input type="date" class="form-input" id="projectDate">
                </div>
                <div class="form-group">
                    <label class="form-label" for="projectDescription">Message / Notes</label>
                    <textarea class="form-input" id="projectDescription" rows="3" placeholder="Ex: J'en ai besoin pour demain, pr&eacute;voir 2 semaines de d&eacute;lai..." style="resize: vertical; min-height: 60px;"></textarea>
                </div>
                <div id="sendStatus" style="display: none; padding: 10px; border-radius: 4px; font-size: 13px; margin-top: 8px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closePdfModal()">Annuler</button>
                <button class="btn-generate" id="btnSend" onclick="soumettreSoumission()">Soumettre</button>
            </div>
        </div>
    </div>

    <!-- Modal Bypass approbation -->
    <div class="modal-overlay" id="bypassModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" style="color:#c0392b;">Envoi sans approbation</h3>
            </div>
            <div class="modal-body">
                <div style="background:#fff3e0; border:1px solid #e65100; border-radius:6px; padding:14px; margin-bottom:16px; font-size:13px; color:#e65100; line-height:1.5;">
                    <strong>Attention :</strong> Vous vous appr&ecirc;tez &agrave; envoyer cette soumission directement au client <strong>sans approbation interne</strong>. Cette action sera consign&eacute;e avec votre identit&eacute; et votre adresse IP.
                </div>
                <div class="form-group">
                    <label class="form-label" style="display:flex; align-items:flex-start; gap:8px; cursor:pointer;">
                        <input type="checkbox" id="bypassConfirmCheck" style="margin-top:3px;">
                        <span>Je confirme envoyer cette soumission sans approbation interne et j'en assume l'enti&egrave;re responsabilit&eacute;.</span>
                    </label>
                </div>
                <div class="form-group">
                    <label class="form-label" for="bypassReason">Raison du bypass <span style="color:#c0392b;">*</span></label>
                    <textarea class="form-input" id="bypassReason" rows="3" placeholder="Ex: Client en urgence, d&eacute;j&agrave; discut&eacute; avec le directeur..." style="resize:vertical; min-height:60px;" required></textarea>
                </div>
                <div id="bypassStatus" style="display:none; padding:10px; border-radius:4px; font-size:13px; margin-top:8px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeBypassModal()">Annuler</button>
                <button class="btn-generate" id="btnBypassConfirm" style="background:#c0392b;" onclick="executeBypass()">Envoyer sans approbation</button>
            </div>
        </div>
    </div>

    <!-- Modal Acceptation hors-ligne -->
    <div class="modal-overlay" id="offlineAcceptModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" style="color:#2e7d32;">Confirmer la vente (hors-ligne)</h3>
            </div>
            <div class="modal-body">
                <div style="background:#e8f5e9; border:1px solid #2e7d32; border-radius:6px; padding:14px; margin-bottom:16px; font-size:13px; color:#2e7d32; line-height:1.5;">
                    Vous confirmez que le client a accept&eacute; cette soumission <strong>par un autre moyen</strong> que la signature en ligne. Cette action sera consign&eacute;e avec votre identit&eacute; et votre adresse IP.
                </div>
                <div class="form-group">
                    <label class="form-label" for="offlineUserName">Votre nom (charg&eacute; de projet) <span style="color:#c0392b;">*</span></label>
                    <input type="text" class="form-input" id="offlineUserName" placeholder="Pr&eacute;nom Nom">
                </div>
                <div class="form-group">
                    <label class="form-label" for="offlineClientName">Nom du client</label>
                    <input type="text" class="form-input" id="offlineClientName" placeholder="Nom du client">
                </div>
                <div class="form-group">
                    <label class="form-label" for="offlineMethod">M&eacute;thode d'acceptation <span style="color:#c0392b;">*</span></label>
                    <select class="form-input" id="offlineMethod" style="font-size:14px;">
                        <option value="">-- S&eacute;lectionner --</option>
                        <option value="courriel">Courriel</option>
                        <option value="telephone">T&eacute;l&eacute;phone</option>
                        <option value="papier">Papier</option>
                        <option value="autre">Autre</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="offlineDate">Date d'acceptation client <span style="color:#c0392b;">*</span></label>
                    <input type="date" class="form-input" id="offlineDate">
                </div>
                <div class="form-group">
                    <label class="form-label" for="offlineNotes">Notes (optionnel)</label>
                    <textarea class="form-input" id="offlineNotes" rows="2" placeholder="Ex: Le client a confirm&eacute; par courriel le..." style="resize:vertical; min-height:40px;"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label" style="display:flex; align-items:flex-start; gap:8px; cursor:pointer;">
                        <input type="checkbox" id="offlineConfirmCheck" style="margin-top:3px;">
                        <span>Je confirme que le client a accept&eacute; cette soumission par un autre moyen. J'en assume l'enti&egrave;re responsabilit&eacute;.</span>
                    </label>
                </div>
                <div id="offlineAcceptStatus" style="display:none; padding:10px; border-radius:4px; font-size:13px; margin-top:8px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeOfflineAcceptModal()">Annuler</button>
                <button class="btn-generate" id="btnOfflineConfirm" style="background:#2e7d32;" onclick="executeOfflineAcceptance()">Confirmer la vente</button>
            </div>
        </div>
    </div>

    <!-- Version Drawer -->
    <div id="versionDrawer" class="version-drawer" style="display:none;">
        <div class="version-drawer-header">
            <h3>Historique des versions</h3>
            <button onclick="closeVersionDrawer()" class="btn-close-drawer">&times;</button>
        </div>
        <div id="versionList" class="version-list"></div>
    </div>

    <!-- Modal Déverrouillage d'urgence -->
    <div class="modal-overlay" id="unlockModal">
        <div class="modal" style="max-width:460px;">
            <div class="modal-header">
                <h3 class="modal-title" style="color:#c62828;">D&eacute;verrouillage d'urgence</h3>
            </div>
            <div class="modal-body">
                <div style="background:#ffebee; border:1px solid #c62828; border-radius:6px; padding:14px; margin-bottom:16px; font-size:13px; color:#c62828; line-height:1.5;">
                    Cette action sera enregistr&eacute;e de fa&ccedil;on <strong>permanente et irr&eacute;versible</strong> dans le journal d'audit. Le contenu actuel sera sauvegard&eacute; en version avant le d&eacute;verrouillage.
                </div>
                <div class="form-group">
                    <label class="form-label" for="unlockUserName">Votre nom complet <span style="color:#c62828;">*</span></label>
                    <input type="text" class="form-input" id="unlockUserName" placeholder="Pr&eacute;nom Nom">
                </div>
                <div class="form-group">
                    <label class="form-label" for="unlockReason">Raison du d&eacute;verrouillage <span style="color:#c62828;">*</span></label>
                    <textarea class="form-input" id="unlockReason" rows="3" placeholder="Expliquer pourquoi cette soumission doit &ecirc;tre d&eacute;verrouill&eacute;e..." style="resize:vertical;"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label" style="display:flex; align-items:flex-start; gap:8px; cursor:pointer;">
                        <input type="checkbox" id="unlockConfirmCheck" style="margin-top:3px;">
                        <span>Je comprends que cette action est permanente et tra&ccedil;able. L'adresse IP sera consign&eacute;e.</span>
                    </label>
                </div>
                <div id="unlockStatus" style="display:none; padding:10px; border-radius:4px; font-size:13px; margin-top:8px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeUnlockModal()">Annuler</button>
                <button class="btn-generate" id="btnUnlockConfirm" style="background:#c62828;" onclick="executeUnlock()">D&eacute;verrouiller</button>
            </div>
        </div>
    </div>

    <!-- Modal Proposer un article -->
    <div class="modal-overlay" id="proposerModal">
        <div class="modal modal-edit">
            <div class="modal-header">
                <h3 class="modal-title">Proposer un nouvel article</h3>
            </div>
            <div class="modal-body">
                <div class="edit-row">
                    <div class="form-group">
                        <label class="form-label">Code</label>
                        <input type="text" class="form-input" id="propCode" readonly style="background:#f5f5f5; color:#888;">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Cat&eacute;gorie</label>
                        <select class="form-input" id="propCategory" onchange="updatePropCode()"></select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <input type="text" class="form-input" id="propDescription" placeholder="ex: Poign&eacute;e en bois massif...">
                </div>
                <div class="edit-row">
                    <div class="form-group">
                        <label class="form-label">Type</label>
                        <select class="form-input" id="propType"></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Prix</label>
                        <input type="hidden" id="propPrice">
                        <div class="form-input" id="propPriceDisplay" style="background:#f5f5f5; color:#888; min-height:38px; display:flex; align-items:center;">Calcul&eacute; automatiquement</div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Instruction</label>
                    <textarea class="form-input" id="propInstruction" rows="2" style="resize:vertical;" placeholder="Instructions sp&eacute;ciales..."></textarea>
                </div>

                <!-- Prix composé — Minutes & Matériaux -->
                <div class="form-group" id="propComposedPriceGroup">
                    <div class="cp-section-title">Prix compos&eacute;</div>
                    <div class="composed-price-section">
                        <div class="cp-table-wrap">
                            <div class="cp-sub-title">Minutes main-d'&oelig;uvre</div>
                            <table class="cp-table">
                                <thead><tr><th>D&eacute;partement</th><th style="width:70px">Min.</th></tr></thead>
                                <tbody id="propCpMinutesBody"></tbody>
                            </table>
                        </div>
                        <div class="cp-table-wrap">
                            <div class="cp-sub-title">Mat&eacute;riaux</div>
                            <table class="cp-table">
                                <thead><tr><th>Cat&eacute;gorie</th><th style="width:80px">Co&ucirc;t ($)</th></tr></thead>
                                <tbody id="propCpMaterialsBody"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="cp-calculated">
                        <div>
                            <span class="cp-total-label">Prix calcul&eacute;</span>
                            <span class="cp-breakdown" id="propCpBreakdown"></span>
                        </div>
                        <span class="cp-total-value" id="propCpTotalValue">&mdash;</span>
                    </div>
                </div>

                <!-- Médias tagués -->
                <div class="form-group">
                    <div class="cat-media-title">M&eacute;dias</div>
                    <div class="cat-dropzone" id="propDropzone">
                        Cliquer ou glisser des images / PDFs ici
                    </div>
                    <input type="file" id="propMediaInput" accept="image/*,.pdf,application/pdf" multiple style="display:none;">
                    <div class="cat-media-list" id="propMediaList"></div>
                </div>

                <div class="form-group" style="margin-bottom:0;">
                    <div class="edit-toggle-row">
                        <label class="edit-toggle">
                            <input type="checkbox" id="propInCalculator" checked>
                            <span class="slider"></span>
                        </label>
                        <span class="edit-toggle-label">Visible dans le calculateur</span>
                    </div>
                </div>

                <div class="edit-status" id="propStatus"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeProposerModal()">Annuler</button>
                <button class="btn-generate" id="btnProposerSave" onclick="saveProposedItem()">Enregistrer</button>
            </div>
        </div>
    </div>

    <!-- Lightbox pour agrandir les images -->
    <div class="lightbox-overlay" id="lightbox" onclick="closeLightbox()">
        <img id="lightboxImg" src="" alt="">
    </div>

    <!-- Modal Plans architecturaux -->
    <div class="modal-overlay" id="plansModal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title">Plans architecturaux</h3>
                <button class="modal-close" onclick="closePlansModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="plans-upload-zone">
                    <input type="file" id="planFileInput" accept=".pdf" style="display:none;" onchange="handlePlanFileSelect(event)">
                    <button class="btn-upload-plan" id="btnUploadPlan" onclick="document.getElementById('planFileInput').click()">
                        <span style="font-size:20px;">&#128196;</span> T&eacute;l&eacute;verser un nouveau plan
                    </button>
                    <div id="planUploadStatus" style="display:none; margin-top:12px; padding:10px; border-radius:6px; font-size:13px; text-align:center;"></div>
                </div>
                <div id="plansListContainer" class="plans-list">
                    <div class="plans-empty">Aucun plan pour cette soumission</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closePlansModal()">Fermer</button>
            </div>
        </div>
    </div>

    <!-- PDF Viewer Modal -->
    <div class="pdf-viewer-overlay" id="pdfViewerOverlay">
        <div class="pdf-viewer-container">
            <!-- Header avec contrôles -->
            <div class="pdf-viewer-header">
                <div class="pdf-viewer-title" id="pdfViewerTitle">Plan architectural</div>
                <div class="pdf-viewer-controls">
                    <button class="pdf-control-btn" id="btnPdfPrev" onclick="pdfNavigate(-1)" title="Page pr\u00e9c\u00e9dente">&#9664;</button>
                    <span class="pdf-page-info" id="pdfPageInfo">1 / 1</span>
                    <button class="pdf-control-btn" id="btnPdfNext" onclick="pdfNavigate(1)" title="Page suivante">&#9654;</button>
                    <div class="pdf-control-divider"></div>
                    <button class="pdf-control-btn" onclick="pdfZoom(-0.25)" title="Zoom -">&#8722;</button>
                    <span class="pdf-zoom-info" id="pdfZoomInfo">100%</span>
                    <button class="pdf-control-btn" onclick="pdfZoom(0.25)" title="Zoom +">&#43;</button>
                    <button class="pdf-control-btn" onclick="pdfResetZoom()" title="R\u00e9initialiser zoom">&#8634;</button>
                    <div class="pdf-control-divider"></div>
                    <button class="pdf-control-btn" onclick="pdfRotate()" title="Rotation 90\u00b0">&#8635;</button>
                    <div class="pdf-control-divider"></div>
                    <button class="pdf-action-btn" id="btnCapturePage" onclick="capturePdfPage()" title="Capturer cette page">&#128248; Capturer</button>
                    <button class="pdf-action-btn" onclick="openPdfInNewWindow()" title="Ouvrir dans une nouvelle fen\u00eatre" style="margin-left:8px;">&#8599; Nouvelle fen\u00eatre</button>
                </div>
                <button class="pdf-viewer-close" onclick="closePdfViewer()">&times;</button>
            </div>

            <!-- Content avec sidebar et canvas -->
            <div class="pdf-viewer-content">
                <!-- Sidebar avec thumbnails -->
                <div class="pdf-sidebar" id="pdfSidebar">
                    <div class="pdf-sidebar-title">Pages</div>
                    <div class="pdf-thumbnails" id="pdfThumbnails"></div>
                </div>

                <!-- Main canvas area -->
                <div class="pdf-canvas-container" id="pdfCanvasContainer">
                    <canvas id="pdfCanvas"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Capture Room Selection -->
    <div class="modal-overlay" id="captureRoomModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">Capturer la page du plan</h3>
                <button class="modal-close" onclick="closeCaptureRoomModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="font-size:13px; color:#666; margin-bottom:16px;">
                    S&eacute;lectionnez la pi&egrave;ce/meuble o&ugrave; associer cette capture haute r&eacute;solution.
                </p>
                <div class="form-group">
                    <label class="form-label">Pi&egrave;ce / Meuble</label>
                    <select class="form-input" id="captureRoomSelect">
                        <option value="">-- S&eacute;lectionnez --</option>
                    </select>
                </div>
                <div id="captureStatus" style="display:none; padding:10px; border-radius:4px; font-size:13px; margin-top:12px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeCaptureRoomModal()">Annuler</button>
                <button class="btn-generate" id="btnConfirmCapture" onclick="confirmCapture()">Capturer</button>
            </div>
        </div>
    </div>

    <!-- Crop Modal -->
    <div class="crop-overlay" id="cropModal">
        <div class="crop-box">
            <div class="crop-header">
                <span>Cadrer l'image</span>
                <span id="cropDimensions" style="font-weight:400; font-size:12px; color:#888;"></span>
            </div>
            <div class="crop-error" id="cropError"></div>
            <div class="crop-container" id="cropContainer">
                <img id="cropImage" src="">
            </div>
            <div class="crop-controls">
                <div class="crop-ratios">
                    <button class="crop-ratio-btn active" id="cropRatio169" onclick="setCropRatio('16:9')">16:9</button>
                    <button class="crop-ratio-btn" id="cropRatio916" onclick="setCropRatio('9:16')">9:16</button>
                    <button class="crop-ratio-btn" id="cropRatio11" onclick="setCropRatio('1:1')">1:1</button>
                </div>
                <div class="crop-actions">
                    <button class="crop-btn crop-btn-cancel" onclick="cancelCrop()">Annuler</button>
                    <button class="crop-btn crop-btn-confirm" id="cropConfirmBtn" onclick="confirmCrop()">Valider</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ═══════════════════════════════════════════════════════════════════════
        // UTILITAIRES
        // ═══════════════════════════════════════════════════════════════════════

        function openLightbox(src) {
            document.getElementById('lightboxImg').src = src;
            document.getElementById('lightbox').classList.add('active');
        }

        function closeLightbox() {
            document.getElementById('lightbox').classList.remove('active');
            document.getElementById('lightboxImg').src = '';
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && document.getElementById('lightbox').classList.contains('active')) closeLightbox();
        });

        function formatPrice(amount) {
            if (amount === null || amount === undefined) return 'Sur demande';
            if (typeof amount === 'number' && amount < 1 && amount > 0) return (amount * 100).toFixed(0) + '%';
            return amount.toLocaleString('fr-CA', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' $';
        }

        function formatType(type) {
            if (type === '%') return '%';
            return type;
        }

        function updateStatus(status, message) {
            const statusEl = document.getElementById('dataStatus');
            const textEl = document.getElementById('statusText');
            statusEl.className = 'data-status ' + status;
            textEl.textContent = message;
        }

        function formatDate(date) {
            if (!date) return '';
            const options = { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' };
            return date.toLocaleDateString('fr-CA', options);
        }

        function getUserEmail() {
            try {
                const token = localStorage.getItem('sb_access_token');
                if (!token) return '';
                const payload = JSON.parse(atob(token.split('.')[1]));
                return payload.email || '';
            } catch (e) { return ''; }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // CHARGEMENT DES DONN&Eacute;ES
        // ═══════════════════════════════════════════════════════════════════════

        function saveToLocalStorage(data) {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                localStorage.setItem(STORAGE_DATE_KEY, new Date().toISOString());
            } catch (e) { console.warn('Impossible de sauvegarder dans localStorage:', e); }
        }

        function loadFromLocalStorage() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                const date = localStorage.getItem(STORAGE_DATE_KEY);
                if (data) return { data: JSON.parse(data), date: date ? new Date(date) : null };
            } catch (e) { console.warn('Impossible de lire depuis localStorage:', e); }
            return null;
        }

        function loadCatalogueData() {
            return new Promise((resolve) => {
                updateStatus('', 'Chargement...');

                var userEmail = getUserEmail();
                authenticatedFetch(SUPABASE_URL + '/rest/v1/catalogue_items?select=id,category,description,type,price,instruction,image_url,in_calculator,status,proposed_by,labor_minutes,material_costs&or=(status.eq.approved,status.is.null,and(status.eq.pending,proposed_by.eq.' + encodeURIComponent(userEmail) + '))&order=sort_order', {})
                .then(r => {
                    if (!r.ok) throw new Error('HTTP ' + r.status);
                    return r.json();
                })
                .then(data => {
                    if (data.length > 0) {
                        CATALOGUE_DATA = data;
                        saveToLocalStorage(data);
                        updateStatus('online', 'Données à jour');
                        resolve(true);
                    } else {
                        throw new Error('Données vides');
                    }
                })
                .catch(error => {
                    console.warn('Erreur chargement catalogue:', error);
                    loadFallbackData();
                    resolve(false);
                });
            });
        }

        function loadFallbackData() {
            const cached = loadFromLocalStorage();
            if (cached && cached.data && cached.data.length > 0) {
                CATALOGUE_DATA = cached.data;
                const dateStr = cached.date ? formatDate(cached.date) : '';
                updateStatus('offline', 'Hors-ligne' + (dateStr ? ' — ' + dateStr : ''));
            } else {
                updateStatus('error', 'Aucune donnée disponible');
            }
        }

        function loadEmployeesData() {
            return new Promise((resolve) => {
                authenticatedFetch(SUPABASE_URL + '/rest/v1/employees?select=name,email&order=sort_order', {})
                .then(r => {
                    if (!r.ok) throw new Error('HTTP ' + r.status);
                    return r.json();
                })
                .then(data => {
                    EMPLOYEES_DATA = data;
                    resolve(true);
                })
                .catch(error => {
                    console.warn('Erreur chargement employ\u00e9s:', error);
                    resolve(false);
                });
            });
        }

        // ═══════════════════════════════════════════════════════════════════════
        // CALCULATEUR — SECTIONS PAR MEUBLE
        // ═══════════════════════════════════════════════════════════════════════

        let rowCounter = 0;
        let groupCounter = 0;

        function buildSelectOptions() {
            let options = '<option value="">— Sélectionner un article —</option>';
            let currentCategory = '';

            const itemsWithPrice = CATALOGUE_DATA.filter(item =>
                item.price !== null &&
                item.type !== '%' &&
                item.in_calculator !== false
            ).sort((a, b) => (a.category || '').localeCompare(b.category || ''));

            itemsWithPrice.forEach(item => {
                if (item.category !== currentCategory) {
                    if (currentCategory !== '') options += '</optgroup>';
                    options += `<optgroup label="${escapeAttr(item.category)}">`;
                    currentCategory = item.category;
                }
                const pendingLabel = (item.status === 'pending') ? ' (en attente)' : '';
                options += `<option value="${escapeAttr(item.id)}">${escapeHtml(item.description)}${pendingLabel}</option>`;
            });
            options += '</optgroup>';
            options += '<optgroup label="Autre">';
            options += '<option value="__PROPOSER__">📋 Proposer un nouvel article...</option>';
            options += '<option value="__AJOUT__">➕ Ajout personnalisé...</option>';
            options += '</optgroup>';
            return options;
        }

        function toggleGroup(groupId) {
            document.getElementById(groupId).classList.toggle('collapsed');
        }

        function toggleProjectInstallation() {
            var cb = document.getElementById('projInstallation');
            var checked = cb.checked;
            // Cascade vers toutes les sections
            document.querySelectorAll('.furniture-group').forEach(function(group) {
                var groupId = group.id;
                var sectionCb = document.getElementById(groupId + '-install');
                if (sectionCb && sectionCb.checked !== checked) {
                    sectionCb.checked = checked;
                    toggleInstallation(groupId);
                }
            });
        }

        function toggleInstallation(groupId) {
            var cb = document.getElementById(groupId + '-install');
            // Cascade vers toutes les lignes de ce groupe
            var rows = document.querySelectorAll('#' + groupId + '-rows .calc-row');
            rows.forEach(function(row) {
                var rowCb = document.getElementById(row.id + '-install');
                if (rowCb) rowCb.checked = cb.checked;
                updateRow(row.id);
            });

            // Sauvegarder dans Supabase
            if (roomMap[groupId]) {
                updateRoom(roomMap[groupId], { installation_included: cb.checked });
                showSaveIndicator();
            }
        }

        function toggleRowInstallation(rowId) {
            updateRow(rowId);
            // Sauvegarder dans Supabase
            if (itemMap[rowId]) {
                var cb = document.getElementById(rowId + '-install');
                updateItem(itemMap[rowId], { installation_included: cb.checked });
                showSaveIndicator();
            }
        }

        function addFurnitureGroup(initialName, opts) {
            opts = opts || {};
            groupCounter++;
            const groupId = `group-${groupCounter}`;

            const group = document.createElement('div');
            group.className = 'furniture-group';
            group.id = groupId;

            group.innerHTML = `
                <div class="furniture-group-header">
                    <button class="btn-collapse" onclick="toggleGroup('${groupId}')" title="Réduire / Agrandir">&#9660;</button>
                    <span class="group-label">Meuble :</span>
                    <input type="text" class="furniture-name-input" id="${groupId}-name"
                           placeholder="ex: Cuisine, Salle de bain, Sous-sol..."
                           value="${escapeAttr(initialName || '')}">
                    <label class="install-toggle" title="Inclure l'installation">
                        <input type="checkbox" id="${groupId}-install" checked onchange="toggleInstallation('${groupId}')">
                        <span class="install-label">Installation</span>
                    </label>
                    <button class="btn-rentab" onclick="openRentab('group','${groupId}')">Rentabilit&eacute;</button>
                    <button class="btn-remove-group" onclick="removeFurnitureGroup('${groupId}')">Supprimer</button>
                </div>
                <div class="client-description-section">
                    <label class="client-desc-label">Description client</label>
                    <textarea class="client-desc-textarea" id="${groupId}-clientDesc"
                              placeholder="Description visible par le client pour cette pi&egrave;ce..."
                              rows="2"
                              onblur="saveClientDescription('${groupId}')"></textarea>
                </div>
                <div class="calc-header">
                    <span></span>
                    <span>Article</span>
                    <span class="col-center">Code</span>
                    <span class="col-center">Type</span>
                    <span class="col-right">Prix unit.</span>
                    <span class="col-center">Quantité</span>
                    <span class="col-center" title="Installation incluse">Inst.</span>
                    <span class="col-right">Total</span>
                    <span></span>
                </div>
                <div class="calc-rows" id="${groupId}-rows">
                    <div class="add-row-container">
                        <button class="btn-add" onclick="addRow('${groupId}')" title="Ajouter une ligne">+</button>
                        <span class="add-row-text">Ajouter un article</span>
                    </div>
                </div>
                <div class="group-subtotal-container">
                    <span class="group-subtotal-label">Sous-total</span>
                    <span class="group-subtotal-amount" id="${groupId}-subtotal">0,00 $</span>
                </div>
                <div class="group-images-section">
                    <div class="group-images-header">Images / Photos</div>
                    <div class="image-drop-zone group-image-drop-zone" id="${groupId}-imgDrop">
                        <div class="image-drop-zone-text">
                            <strong>Ctrl+V</strong> pour coller &middot; <strong>glisser-d&eacute;poser</strong> &middot; ou <strong>cliquer</strong>
                        </div>
                    </div>
                    <input type="file" id="${groupId}-imgInput" accept="image/png,image/jpeg,image/webp,application/pdf" multiple style="display:none;">
                    <div class="image-previews" id="${groupId}-imgPreviews"></div>
                    <div class="image-count" id="${groupId}-imgCount"></div>
                </div>
            `;

            document.getElementById('furnitureGroups').appendChild(group);
            setupGroupImageHandlers(groupId);
            if (!groupImages[groupId]) groupImages[groupId] = [];

            // Persistance Supabase
            if (opts.existingId) {
                roomMap[groupId] = opts.existingId;
            } else if (currentSubmission && !opts.skipSave) {
                const sortOrder = document.querySelectorAll('.furniture-group').length;
                createRoom(currentSubmission.id, initialName || '', sortOrder).then(room => {
                    if (room) roomMap[groupId] = room.id;
                });
            }

            // Auto-save nom du meuble sur blur
            const nameInput = document.getElementById(`${groupId}-name`);
            nameInput.addEventListener('blur', function() {
                if (roomMap[groupId]) {
                    updateRoom(roomMap[groupId], { name: this.value });
                    showSaveIndicator();
                }
            });

            return groupId;
        }

        async function removeFurnitureGroup(groupId) {
            const groups = document.querySelectorAll('.furniture-group');
            if (groups.length <= 1) return;
            if (!(await steleConfirm('Supprimer ce meuble et tous ses articles ?', 'Supprimer', 'Supprimer', true))) return;

            // Supprimer dans Supabase
            if (roomMap[groupId]) {
                deleteRoom(roomMap[groupId]);
                // Nettoyer les itemMap pour les rows de ce groupe
                const group = document.getElementById(groupId);
                if (group) {
                    group.querySelectorAll('.calc-row').forEach(row => {
                        delete itemMap[row.id];
                    });
                }
                delete roomMap[groupId];
            }
            delete groupImages[groupId];

            const group = document.getElementById(groupId);
            if (group) { group.remove(); updateGrandTotal(); }
        }

        function addRow(groupId, opts) {
            opts = opts || {};
            rowCounter++;
            const rowId = `row-${rowCounter}`;

            const row = document.createElement('div');
            row.className = 'calc-row';
            row.id = rowId;
            row.dataset.mode = 'normal';
            row.dataset.group = groupId;
            row.innerHTML = `
                <div class="cell-add">
                    <button class="btn-add" onclick="addRow('${groupId}')" title="Ajouter une ligne">+</button>
                </div>
                <div class="cell-select">
                    <select class="item-select" onchange="updateRow('${rowId}')">
                        ${buildSelectOptions()}
                    </select>
                </div>
                <div class="cell-code" id="${rowId}-code">—</div>
                <div class="cell-type" id="${rowId}-type">—</div>
                <div class="cell-unit-price" id="${rowId}-unit-price">—</div>
                <div class="cell-qty">
                    <input type="number" class="qty-input" id="${rowId}-qty" value="1" min="0" step="0.01" onchange="updateRow('${rowId}')" oninput="updateRow('${rowId}')">
                </div>
                <div class="install-toggle-row">
                    <input type="checkbox" id="${rowId}-install" checked onchange="toggleRowInstallation('${rowId}')" title="Installation incluse">
                </div>
                <div class="cell-total" id="${rowId}-total">0,00 $</div>
                <div class="cell-remove">
                    <button class="btn-remove" onclick="removeRow('${rowId}')" title="Supprimer">×</button>
                </div>
            `;

            const container = document.getElementById(`${groupId}-rows`);
            const addContainer = container.querySelector('.add-row-container');
            container.insertBefore(row, addContainer);

            // Persistance Supabase
            if (opts.existingId) {
                itemMap[rowId] = opts.existingId;
            } else if (currentSubmission && roomMap[groupId] && !opts.skipSave) {
                const sortOrder = container.querySelectorAll('.calc-row').length;
                createItem(roomMap[groupId], { sort_order: sortOrder }).then(item => {
                    if (item) itemMap[rowId] = item.id;
                });
            }

            if (!opts.skipFocus) row.querySelector('.item-select').focus();
            return rowId;
        }

        function transformToAjoutMode(row, rowId) {
            row.dataset.mode = 'ajout';
            row.style.background = '#eef2ef';

            const codeEl = document.getElementById(`${rowId}-code`);
            const typeEl = document.getElementById(`${rowId}-type`);
            const unitPriceEl = document.getElementById(`${rowId}-unit-price`);

            codeEl.innerHTML = `<input type="text" class="ajout-description" id="${rowId}-desc" placeholder="Description..." oninput="updateRow('${rowId}')" style="width: 100%; padding: 6px 8px; font-size: 12px; border: 1px solid #C8C8C8; border-radius: 4px;">`;
            codeEl.style.gridColumn = 'span 1';
            typeEl.innerHTML = `<input type="number" class="ajout-price" id="${rowId}-price" placeholder="Prix" value="0" min="0" step="0.01" oninput="updateRow('${rowId}')" style="width: 100%; padding: 6px 8px; font-size: 12px; border: 1px solid #C8C8C8; border-radius: 4px; text-align: right; -moz-appearance: textfield;" onwheel="this.blur()">`;
            unitPriceEl.innerHTML = `<div style="display: flex; align-items: center; gap: 4px;"><input type="number" class="ajout-markup" id="${rowId}-markup" value="30" min="0" step="1" oninput="updateRow('${rowId}')" style="width: 60px; padding: 6px 8px; font-size: 12px; border: 1px solid #C8C8C8; border-radius: 4px; text-align: right; -moz-appearance: textfield;" onwheel="this.blur()"><span style="font-size: 11px; color: #666;">%</span></div>`;

            setTimeout(() => {
                const descInput = document.getElementById(`${rowId}-desc`);
                if (descInput) descInput.focus();
            }, 50);
        }

        function transformToNormalMode(row, rowId) {
            row.dataset.mode = 'normal';
            row.style.background = '';
            document.getElementById(`${rowId}-code`).innerHTML = '—';
            document.getElementById(`${rowId}-code`).style.gridColumn = '';
            document.getElementById(`${rowId}-type`).innerHTML = '—';
            document.getElementById(`${rowId}-unit-price`).innerHTML = '—';
            document.getElementById(`${rowId}-total`).textContent = '0,00 $';
        }

        let configCategories = [];

        async function loadConfigCategories() {
            try {
                const r = await authenticatedFetch(
                    SUPABASE_URL + '/rest/v1/app_config?key=eq.catalogue_categories&select=value', {}
                );
                if (r.ok) {
                    const rows = await r.json();
                    if (rows.length > 0 && Array.isArray(rows[0].value)) {
                        configCategories = rows[0].value;
                    }
                }
            } catch (e) { /* keep empty */ }
        }

        async function loadTauxAndExpenses() {
            try {
                const r = await authenticatedFetch(
                    SUPABASE_URL + '/rest/v1/app_config?key=in.(taux_horaires,expense_categories)&select=key,value', {}
                );
                if (r.ok) {
                    const rows = await r.json();
                    rows.forEach(function(row) {
                        if (row.key === 'taux_horaires') tauxHoraires = row.value || [];
                        if (row.key === 'expense_categories') expenseCategories = row.value || [];
                    });
                }
            } catch (e) { /* keep defaults */ }
        }

        // Calculer le prix composé d'un article catalogue
        function computeComposedPrice(item, includeInstallation) {
            var laborMinutes = item.labor_minutes || {};
            var materialCosts = item.material_costs || {};
            var hasComposed = false;

            // Main-d'œuvre
            var laborTotal = 0;
            for (var i = 0; i < tauxHoraires.length; i++) {
                var dept = tauxHoraires[i].department;
                var minutes = laborMinutes[dept] || 0;
                if (minutes > 0) {
                    if (!includeInstallation && dept === 'Installation') continue;
                    laborTotal += (minutes / 60) * (tauxHoraires[i].taux_horaire || 0);
                    hasComposed = true;
                }
            }

            // Matériaux
            var materialTotal = 0;
            for (var j = 0; j < expenseCategories.length; j++) {
                var cat = expenseCategories[j].name;
                var cost = materialCosts[cat] || 0;
                if (cost > 0) {
                    var markup = (expenseCategories[j].markup || 0) / 100;
                    var waste = (expenseCategories[j].waste || 0) / 100;
                    materialTotal += cost * (1 + markup + waste);
                    hasComposed = true;
                }
            }

            if (!hasComposed) return null; // pas de prix composé → utiliser item.price
            return laborTotal + materialTotal;
        }

        function getCategories() {
            const cats = new Set();
            CATALOGUE_DATA.forEach(item => { if (item.category) cats.add(item.category); });
            configCategories.forEach(c => cats.add(c));
            return Array.from(cats).sort();
        }

        function generateNextCode(category) {
            const clean = (category || 'XXX').normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            const prefix = clean.substring(0, 3).toUpperCase();
            let maxNum = 0;
            CATALOGUE_DATA.forEach(item => {
                if (item.id && item.id.startsWith(prefix + '-')) {
                    const num = parseInt(item.id.split('-')[1]) || 0;
                    if (num > maxNum) maxNum = num;
                }
            });
            return prefix + '-' + String(maxNum + 1).padStart(3, '0');
        }

        let proposerRowId = null; // rowId en cours de proposition

        function transformToProposerMode(row, rowId) {
            row.dataset.mode = 'proposer';
            proposerRowId = rowId;
            openProposerModal();
        }

        function updatePropCode() {
            var cat = document.getElementById('propCategory').value;
            document.getElementById('propCode').value = generateNextCode(cat);
        }

        function openProposerModal() {
            // Remplir le dropdown catégories
            const catSelect = document.getElementById('propCategory');
            const categories = getCategories();
            catSelect.innerHTML = categories.map(c => `<option value="${escapeAttr(c)}">${escapeHtml(c)}</option>`).join('');

            // Remplir le dropdown types
            const typeSelect = document.getElementById('propType');
            const types = new Set(['pi\u00b2', 'unitaire', 'lin\u00e9aire', '%']);
            CATALOGUE_DATA.forEach(function(i) { if (i.type) types.add(i.type); });
            typeSelect.innerHTML = Array.from(types).map(t => `<option value="${escapeAttr(t)}">${escapeHtml(t)}</option>`).join('');

            // Réinitialiser les champs
            document.getElementById('propDescription').value = '';
            document.getElementById('propType').value = 'unitaire';
            document.getElementById('propPrice').value = '';
            document.getElementById('propPriceDisplay').textContent = 'Calcul\u00e9 automatiquement';
            document.getElementById('propInstruction').value = '';
            document.getElementById('propInCalculator').checked = true;

            // Code auto-généré
            updatePropCode();

            // Tableaux prix composé
            renderPropComposedTables();

            // Médias
            propMedia = [];
            renderPropMedia();

            // Reset status
            var status = document.getElementById('propStatus');
            status.className = 'edit-status';
            status.style.display = 'none';
            document.getElementById('btnProposerSave').disabled = false;
            document.getElementById('btnProposerSave').textContent = 'Enregistrer';

            document.getElementById('proposerModal').classList.add('active');
            setTimeout(() => document.getElementById('propDescription').focus(), 100);
        }

        function closeProposerModal() {
            document.getElementById('proposerModal').classList.remove('active');

            // Si on ferme sans sauvegarder, remettre la row en mode normal
            if (proposerRowId) {
                const row = document.getElementById(proposerRowId);
                if (row && row.dataset.mode === 'proposer') {
                    const select = row.querySelector('.item-select');
                    select.value = '';
                    transformToNormalMode(row, proposerRowId);
                    updateRow(proposerRowId);
                }
                proposerRowId = null;
            }
        }

        // ── Prix composé pour le modal de proposition ──

        function renderPropComposedTables() {
            var mBody = document.getElementById('propCpMinutesBody');
            var mHtml = '';
            for (var i = 0; i < tauxHoraires.length; i++) {
                var dept = tauxHoraires[i].department;
                mHtml += '<tr><td>' + escapeHtml(dept) + '</td>' +
                    '<td><input type="number" step="0.1" placeholder="0" value=""' +
                    ' data-dept="' + escapeAttr(dept) + '"' +
                    (canEditMinutes ? '' : ' disabled') +
                    ' oninput="updatePropComposedPrice()"></td></tr>';
            }
            mBody.innerHTML = mHtml;

            var cBody = document.getElementById('propCpMaterialsBody');
            var cHtml = '';
            for (var j = 0; j < expenseCategories.length; j++) {
                var cat = expenseCategories[j].name;
                cHtml += '<tr><td title="' + escapeAttr(cat) + '">' + escapeHtml(cat) + '</td>' +
                    '<td><input type="number" step="0.01" placeholder="0.00" value=""' +
                    ' data-cat="' + escapeAttr(cat) + '"' +
                    (canEditMaterials ? '' : ' disabled') +
                    ' oninput="updatePropComposedPrice()"></td></tr>';
            }
            cBody.innerHTML = cHtml;

            updatePropComposedPrice();
        }

        function updatePropComposedPrice() {
            var laborTotal = 0;
            var mInputs = document.querySelectorAll('#propCpMinutesBody input[type="number"]');
            for (var i = 0; i < mInputs.length; i++) {
                var minutes = parseFloat(mInputs[i].value) || 0;
                var dept = mInputs[i].getAttribute('data-dept');
                var taux = tauxHoraires.find(function(t) { return t.department === dept; });
                laborTotal += (minutes / 60) * (taux ? (taux.taux_horaire || 0) : 0);
            }

            var materialTotal = 0;
            var cInputs = document.querySelectorAll('#propCpMaterialsBody input[type="number"]');
            for (var j = 0; j < cInputs.length; j++) {
                var cost = parseFloat(cInputs[j].value) || 0;
                var catName = cInputs[j].getAttribute('data-cat');
                var expCat = expenseCategories.find(function(c) { return c.name === catName; });
                var markup = (expCat ? (expCat.markup || 0) : 0) / 100;
                var waste = (expCat ? (expCat.waste || 0) : 0) / 100;
                materialTotal += cost * (1 + markup + waste);
            }

            var total = laborTotal + materialTotal;
            var totalEl = document.getElementById('propCpTotalValue');
            var breakdownEl = document.getElementById('propCpBreakdown');
            var priceField = document.getElementById('propPrice');
            var priceDisplay = document.getElementById('propPriceDisplay');

            if (total > 0) {
                totalEl.textContent = total.toFixed(2) + ' $';
                breakdownEl.textContent = '(MO: ' + laborTotal.toFixed(2) + ' + Mat: ' + materialTotal.toFixed(2) + ')';
                priceField.value = total.toFixed(2);
                priceDisplay.textContent = total.toFixed(2) + ' $';
            } else {
                totalEl.textContent = '\u2014';
                breakdownEl.textContent = '';
                priceField.value = '';
                priceDisplay.textContent = 'Calcul\u00e9 automatiquement';
            }
        }

        function collectPropLaborMinutes() {
            var data = {};
            var inputs = document.querySelectorAll('#propCpMinutesBody input[type="number"]');
            for (var i = 0; i < inputs.length; i++) {
                var val = parseFloat(inputs[i].value) || 0;
                if (val > 0) data[inputs[i].getAttribute('data-dept')] = val;
            }
            return data;
        }

        function collectPropMaterialCosts() {
            var data = {};
            var inputs = document.querySelectorAll('#propCpMaterialsBody input[type="number"]');
            for (var i = 0; i < inputs.length; i++) {
                var val = parseFloat(inputs[i].value) || 0;
                if (val > 0) data[inputs[i].getAttribute('data-cat')] = val;
            }
            return data;
        }

        // ── Médias pour le modal de proposition ──

        function setupProposerMediaHandlers() {
            var dropzone = document.getElementById('propDropzone');
            var fileInput = document.getElementById('propMediaInput');
            if (!dropzone || !fileInput) return;

            dropzone.addEventListener('click', function() { fileInput.click(); });
            dropzone.addEventListener('dragover', function(e) { e.preventDefault(); dropzone.classList.add('dragover'); });
            dropzone.addEventListener('dragleave', function() { dropzone.classList.remove('dragover'); });
            dropzone.addEventListener('drop', function(e) {
                e.preventDefault();
                dropzone.classList.remove('dragover');
                handlePropMediaFiles(e.dataTransfer.files);
            });
            fileInput.addEventListener('change', function() {
                handlePropMediaFiles(fileInput.files);
                fileInput.value = '';
            });
        }

        function handlePropMediaFiles(files) {
            Array.from(files).forEach(function(file) {
                var isPdf = file.type === 'application/pdf';
                var isImage = file.type.startsWith('image/');
                if (!isPdf && !isImage) return;

                var mediaEntry = {
                    id: null, file_url: null, previewUrl: null,
                    file_type: isPdf ? 'pdf' : 'image',
                    tags: [], isNew: true, file: file
                };

                if (isImage) {
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        mediaEntry.previewUrl = e.target.result;
                        propMedia.push(mediaEntry);
                        renderPropMedia();
                    };
                    reader.readAsDataURL(file);
                } else {
                    propMedia.push(mediaEntry);
                    renderPropMedia();
                }
            });
        }

        function renderPropMedia() {
            var list = document.getElementById('propMediaList');
            list.innerHTML = '';

            propMedia.forEach(function(media, index) {
                var item = document.createElement('div');
                item.className = 'cat-media-item';

                if (media.file_type === 'pdf') {
                    var pdfIcon = document.createElement('div');
                    pdfIcon.className = 'cat-pdf-icon';
                    pdfIcon.textContent = 'PDF';
                    item.appendChild(pdfIcon);
                } else {
                    var img = document.createElement('img');
                    img.src = media.file_url || media.previewUrl || '';
                    img.alt = '';
                    item.appendChild(img);
                }

                var info = document.createElement('div');
                info.className = 'cat-media-info';
                var tags = document.createElement('div');
                tags.className = 'cat-media-tags';

                mediaTagsList.forEach(function(tag) {
                    var chip = document.createElement('span');
                    chip.className = 'cat-tag' + (media.tags.indexOf(tag) !== -1 ? ' active' : '');
                    chip.textContent = tag.replace(/_/g, ' ');
                    chip.onclick = function() {
                        var idx = media.tags.indexOf(tag);
                        if (idx !== -1) media.tags.splice(idx, 1);
                        else media.tags.push(tag);
                        chip.classList.toggle('active');
                    };
                    tags.appendChild(chip);
                });

                info.appendChild(tags);
                item.appendChild(info);

                var removeBtn = document.createElement('button');
                removeBtn.className = 'cat-media-remove';
                removeBtn.innerHTML = '&times;';
                removeBtn.title = 'Supprimer';
                removeBtn.onclick = function() {
                    propMedia.splice(index, 1);
                    renderPropMedia();
                };
                item.appendChild(removeBtn);

                list.appendChild(item);
            });
        }

        // ── Sauvegarde ──

        async function saveProposedItem() {
            if (!proposerRowId) return;

            const category = document.getElementById('propCategory').value;
            const description = document.getElementById('propDescription').value.trim();
            const type = document.getElementById('propType').value;
            const priceVal = document.getElementById('propPrice').value;
            const price = priceVal !== '' ? parseFloat(priceVal) : null;
            const instruction = document.getElementById('propInstruction').value.trim();
            const inCalculator = document.getElementById('propInCalculator').checked;
            const laborMinutes = collectPropLaborMinutes();
            const materialCosts = collectPropMaterialCosts();

            if (!description) { document.getElementById('propDescription').focus(); return; }
            if (!price || price <= 0) {
                // Vérifier s'il y a des données composées
                if (Object.keys(laborMinutes).length === 0 && Object.keys(materialCosts).length === 0) {
                    steleAlert('Veuillez remplir les minutes ou mat\u00e9riaux pour calculer le prix.');
                    return;
                }
            }

            const btn = document.getElementById('btnProposerSave');
            btn.disabled = true;
            btn.textContent = 'Enregistrement...';

            const newId = document.getElementById('propCode').value || generateNextCode(category);
            const email = getUserEmail();

            const payload = {
                id: newId,
                category: category,
                description: description,
                type: type,
                price: price,
                instruction: instruction || null,
                labor_minutes: Object.keys(laborMinutes).length > 0 ? laborMinutes : null,
                material_costs: Object.keys(materialCosts).length > 0 ? materialCosts : null,
                status: 'pending',
                proposed_by: email,
                in_calculator: inCalculator,
                sort_order: 9999
            };

            try {
                const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/catalogue_items', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                    body: JSON.stringify(payload)
                });
                if (!r.ok) throw new Error('HTTP ' + r.status);
                const data = await r.json();
                const newItem = data[0] || payload;

                // Upload des médias
                for (var mi = 0; mi < propMedia.length; mi++) {
                    var m = propMedia[mi];
                    if (m.isNew && m.file) {
                        var ext = m.file.name.split('.').pop().toLowerCase() || 'bin';
                        var path = newId + '/' + Date.now() + '_' + mi + '.' + ext;
                        var uploadResp = await authenticatedFetch(SUPABASE_URL + '/storage/v1/object/fiche-images/' + path, {
                            method: 'POST',
                            headers: { 'Content-Type': m.file.type, 'x-upsert': 'true' },
                            body: m.file
                        });
                        if (uploadResp.ok) {
                            var fileUrl = SUPABASE_URL + '/storage/v1/object/public/fiche-images/' + path;
                            await authenticatedFetch(SUPABASE_URL + '/rest/v1/item_media', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                                body: JSON.stringify({
                                    catalogue_item_id: newId,
                                    file_url: fileUrl,
                                    file_type: m.file_type,
                                    tags: m.tags,
                                    sort_order: mi
                                })
                            });
                            // Auto-sync image_url si tag "catalogue"
                            if (mi === 0 || m.tags.indexOf('catalogue') !== -1) {
                                if (m.file_type === 'image' && m.tags.indexOf('catalogue') !== -1) {
                                    await authenticatedFetch(SUPABASE_URL + '/rest/v1/catalogue_items?id=eq.' + encodeURIComponent(newId), {
                                        method: 'PATCH',
                                        headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                                        body: JSON.stringify({ image_url: fileUrl })
                                    });
                                    newItem.image_url = fileUrl;
                                }
                            }
                        }
                    }
                }

                CATALOGUE_DATA.push(newItem);

                // Mettre à jour la row
                const rowId = proposerRowId;
                const row = document.getElementById(rowId);
                if (row) {
                    transformToNormalMode(row, rowId);
                    refreshAllSelects();
                    const select = row.querySelector('.item-select');
                    select.value = newId;
                    updateRow(rowId);
                }

                proposerRowId = null;
                showSaveIndicator();

                // Afficher le message de confirmation
                const statusEl = document.getElementById('propStatus');
                statusEl.style.display = 'block';
                statusEl.className = 'edit-status success';
                statusEl.textContent = 'Votre article a \u00e9t\u00e9 ajout\u00e9 \u00e0 votre soumission mais est en attente d\u2019approbation pour \u00eatre ajout\u00e9 au catalogue officiellement.';
                btn.textContent = 'Enregistr\u00e9!';

                setTimeout(() => {
                    document.getElementById('proposerModal').classList.remove('active');
                }, 3000);
            } catch (e) {
                console.error('Erreur proposition article:', e);
                const statusEl = document.getElementById('propStatus');
                statusEl.style.display = 'block';
                statusEl.className = 'edit-status error';
                statusEl.textContent = 'Erreur lors de la proposition. V\u00e9rifiez votre connexion.';
                btn.disabled = false;
                btn.textContent = 'Enregistrer';
            }
        }

        function refreshAllSelects() {
            const newOptions = buildSelectOptions();
            document.querySelectorAll('.item-select').forEach(select => {
                const currentValue = select.value;
                select.innerHTML = newOptions;
                if (currentValue) select.value = currentValue;
            });
        }

        function updateRow(rowId) {
            const row = document.getElementById(rowId);
            const select = row.querySelector('.item-select');
            const qtyInput = row.querySelector('.qty-input');
            const totalEl = document.getElementById(`${rowId}-total`);

            const selectedId = select.value;
            const qty = parseFloat(qtyInput.value) || 0;
            const currentMode = row.dataset.mode;

            if (selectedId === '__PROPOSER__') {
                if (currentMode !== 'proposer') {
                    if (currentMode === 'ajout') transformToNormalMode(row, rowId);
                    transformToProposerMode(row, rowId);
                }
            } else if (selectedId === '__AJOUT__') {
                if (currentMode !== 'ajout') {
                    if (currentMode === 'proposer') transformToNormalMode(row, rowId);
                    transformToAjoutMode(row, rowId);
                }
                const priceInput = document.getElementById(`${rowId}-price`);
                const markupInput = document.getElementById(`${rowId}-markup`);
                if (priceInput && markupInput) {
                    const price = parseFloat(priceInput.value) || 0;
                    const markup = parseFloat(markupInput.value) || 0;
                    totalEl.textContent = formatPrice(price * qty * (1 + markup / 100));
                }
            } else {
                if (currentMode === 'ajout' || currentMode === 'proposer') transformToNormalMode(row, rowId);
                const codeEl = document.getElementById(`${rowId}-code`);
                const typeEl = document.getElementById(`${rowId}-type`);
                const unitPriceEl = document.getElementById(`${rowId}-unit-price`);

                if (selectedId) {
                    const item = CATALOGUE_DATA.find(i => i.id === selectedId);
                    if (item) {
                        const tooltipImg = item.image_url ? `<img class="tooltip-img" src="${escapeAttr(item.image_url)}" alt="">` : '';
                        codeEl.innerHTML = `<span class="tooltip-container">${escapeHtml(item.id)}<div class="tooltip">${tooltipImg}<div class="tooltip-title">${escapeHtml(item.description)}</div><div class="tooltip-text">${escapeHtml(item.instruction || '')}</div></div></span>`;
                        typeEl.textContent = formatType(item.type);

                        // Prix composé si disponible, sinon prix catalogue
                        var installCb = document.getElementById(rowId + '-install');
                        var includeInstall = installCb ? installCb.checked : true;
                        var composedPrice = computeComposedPrice(item, includeInstall);
                        var effectivePrice = composedPrice !== null ? composedPrice : (item.price || 0);
                        unitPriceEl.textContent = formatPrice(effectivePrice);
                        totalEl.textContent = formatPrice(effectivePrice * qty);
                    }
                } else {
                    codeEl.textContent = '—';
                    typeEl.textContent = '—';
                    unitPriceEl.textContent = '—';
                    totalEl.textContent = '0,00 $';
                }
            }

            const groupId = row.dataset.group;
            if (groupId) updateGroupSubtotal(groupId);
            updateGrandTotal();

            // Sauvegarder dans Supabase (debounce) — pas en mode proposer
            if (itemMap[rowId] && row.dataset.mode !== 'proposer') {
                debouncedSaveItem(rowId, row);
            }
        }

        const debouncedSaveItem = debounce(function(rowId, row) {
            if (!itemMap[rowId]) return;
            const select = row.querySelector('.item-select');
            const qtyInput = row.querySelector('.qty-input');
            const selectedId = select ? select.value : '';
            const qty = parseFloat(qtyInput ? qtyInput.value : 0) || 0;

            let fields = { quantity: qty };

            if (selectedId === '__PROPOSER__') return;

            if (selectedId === '__AJOUT__') {
                const descInput = row.querySelector('.ajout-description');
                const priceInput = row.querySelector('.ajout-price');
                const markupInput = row.querySelector('.ajout-markup');
                fields.item_type = 'custom';
                fields.catalogue_item_id = null;
                fields.description = descInput ? descInput.value : '';
                fields.unit_price = parseFloat(priceInput ? priceInput.value : 0) || 0;
                fields.markup = parseFloat(markupInput ? markupInput.value : 0) || 0;
                fields.unit_type = '';
            } else if (selectedId) {
                const item = CATALOGUE_DATA.find(i => i.id === selectedId);
                if (item) {
                    var installCb = document.getElementById(rowId + '-install');
                    var includeInstall = installCb ? installCb.checked : true;
                    var composed = computeComposedPrice(item, includeInstall);
                    fields.item_type = 'catalogue';
                    fields.catalogue_item_id = item.id;
                    fields.description = item.description;
                    fields.unit_type = item.type || '';
                    fields.unit_price = composed !== null ? composed : (item.price || 0);
                    fields.markup = 0;
                }
            } else {
                // Pas de sélection, on sauvegarde quand même la quantité
                fields.item_type = 'catalogue';
                fields.catalogue_item_id = null;
                fields.description = '';
                fields.unit_price = 0;
                fields.markup = 0;
            }

            updateItem(itemMap[rowId], fields);
            showSaveIndicator();
        }, 500);

        function removeRow(rowId) {
            const row = document.getElementById(rowId);
            if (row) {
                const groupId = row.dataset.group;
                // Supprimer dans Supabase
                if (itemMap[rowId]) {
                    deleteItem(itemMap[rowId]);
                    delete itemMap[rowId];
                }
                row.remove();
                if (groupId) updateGroupSubtotal(groupId);
                updateGrandTotal();
            }
        }

        function getRowTotal(row) {
            const select = row.querySelector('.item-select');
            const qtyInput = row.querySelector('.qty-input');
            if (!select || !qtyInput) return 0;
            const selectedId = select.value;
            const qty = parseFloat(qtyInput.value) || 0;

            if (selectedId === '__PROPOSER__') {
                return 0;
            } else if (selectedId === '__AJOUT__') {
                const priceInput = row.querySelector('.ajout-price');
                const markupInput = row.querySelector('.ajout-markup');
                if (priceInput && markupInput) {
                    return (parseFloat(priceInput.value) || 0) * qty * (1 + (parseFloat(markupInput.value) || 0) / 100);
                }
            } else if (selectedId) {
                const item = CATALOGUE_DATA.find(i => i.id === selectedId);
                if (item && item.price) return item.price * qty;
            }
            return 0;
        }

        function updateGroupSubtotal(groupId) {
            let subtotal = 0;
            const container = document.getElementById(`${groupId}-rows`);
            if (!container) return;
            container.querySelectorAll('.calc-row').forEach(row => { subtotal += getRowTotal(row); });
            const subtotalEl = document.getElementById(`${groupId}-subtotal`);
            if (subtotalEl) subtotalEl.textContent = formatPrice(subtotal);
        }

        function updateGrandTotal() {
            let total = 0;
            document.querySelectorAll('.calc-row').forEach(row => { total += getRowTotal(row); });
            document.getElementById('grandTotal').textContent = formatPrice(total);
            updateHeaderTotal();
        }

        function calculerGrandTotal() {
            let total = 0;
            document.querySelectorAll('.calc-row').forEach(row => { total += getRowTotal(row); });
            return Math.round(total * 100) / 100;
        }

        function updateHeaderTotal() {
            var el = document.getElementById('headerTotal');
            if (!el) return;
            var total = calculerGrandTotal();
            el.textContent = total.toLocaleString('fr-CA', { style: 'currency', currency: 'CAD' });
        }

        // ═══════════════════════════════════════════════════════════════════════
        // MODAL ENVOI
        // ═══════════════════════════════════════════════════════════════════════

        function openSubmitModal() {
            if (!currentSubmission) return;
            var s = currentSubmission.status;
            if (s !== 'draft' && s !== 'returned') {
                steleAlert('Cette soumission ne peut pas \u00eatre soumise (statut: ' + (STATUS_LABELS[s] || s) + ').');
                return;
            }
            const rows = document.querySelectorAll('.calc-row');
            if (rows.length === 0) {
                steleAlert('Veuillez ajouter au moins un article au calculateur.');
                return;
            }
            document.getElementById('projectDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('projectDescription').value = '';
            // Titre du modal adapté
            document.getElementById('submitModalTitle').textContent = 'Soumettre la soumission #' + currentSubmission.submission_number;
            document.getElementById('btnSend').textContent = 'Soumettre';
            document.getElementById('sendStatus').style.display = 'none';
            document.getElementById('pdfModal').classList.add('active');
        }

        // Legacy alias
        function openPdfModal() { openSubmitModal(); }

        function closePdfModal() {
            document.getElementById('pdfModal').classList.remove('active');
        }

        document.addEventListener('click', function(e) {
            if (e.target === document.getElementById('pdfModal')) closePdfModal();
            if (e.target === document.getElementById('proposerModal')) closeProposerModal();
        });

        // ═══════════════════════════════════════════════════════════════════════
        // GESTION DES IMAGES
        // ═══════════════════════════════════════════════════════════════════════

        // ── Chargement dynamique des librairies ──
        var cropperLoaded = false;
        var pdfJsLoaded = false;
        var currentCropper = null;
        var cropState = {}; // { groupId, originalBlob, existingMediaId, ratio }

        function loadCropperLib() {
            if (cropperLoaded) return Promise.resolve();
            return new Promise(function(resolve, reject) {
                var link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = 'https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.css';
                document.head.appendChild(link);
                var script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.js';
                script.onload = function() { cropperLoaded = true; resolve(); };
                script.onerror = function() { reject(new Error('Impossible de charger Cropper.js')); };
                document.head.appendChild(script);
            });
        }

        function loadPdfLib() {
            if (pdfJsLoaded) return Promise.resolve();
            return new Promise(function(resolve, reject) {
                var script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
                script.onload = function() {
                    window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                    pdfJsLoaded = true;
                    resolve();
                };
                script.onerror = function() { reject(new Error('Impossible de charger pdf.js')); };
                document.head.appendChild(script);
            });
        }

        function convertPdfToImage(file) {
            return new Promise(function(resolve, reject) {
                var reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        var pdf = await window.pdfjsLib.getDocument({ data: new Uint8Array(e.target.result) }).promise;
                        var page = await pdf.getPage(1);
                        var scale = 300 / 72; // 300 DPI
                        var viewport = page.getViewport({ scale: scale });
                        var canvas = document.createElement('canvas');
                        canvas.width = viewport.width;
                        canvas.height = viewport.height;
                        await page.render({ canvasContext: canvas.getContext('2d'), viewport: viewport }).promise;
                        canvas.toBlob(function(blob) {
                            resolve(blob);
                        }, 'image/jpeg', 0.92);
                    } catch (err) {
                        reject(err);
                    }
                };
                reader.readAsArrayBuffer(file);
            });
        }

        // ── Crop Modal ──
        function openCropModal(imageBlob, groupId, existingMediaId) {
            cropState = { groupId: groupId, originalBlob: imageBlob, existingMediaId: existingMediaId || null, ratio: '16:9' };
            var url = URL.createObjectURL(imageBlob);
            var imgEl = document.getElementById('cropImage');
            var modal = document.getElementById('cropModal');
            var errEl = document.getElementById('cropError');
            errEl.style.display = 'none';

            // Check dimensions
            var testImg = new Image();
            testImg.onload = async function() {
                document.getElementById('cropDimensions').textContent = testImg.width + ' × ' + testImg.height + ' px';
                if (testImg.width < 800 || testImg.height < 600) {
                    errEl.textContent = 'Image trop petite pour une présentation professionnelle (minimum 800×600). Celle-ci fait ' + testImg.width + '×' + testImg.height + '.';
                    errEl.style.display = 'block';
                    imgEl.src = url;
                    modal.classList.add('active');
                    document.getElementById('cropConfirmBtn').disabled = true;
                    return;
                }
                document.getElementById('cropConfirmBtn').disabled = false;
                imgEl.src = url;
                modal.classList.add('active');

                await loadCropperLib();
                if (currentCropper) { currentCropper.destroy(); currentCropper = null; }
                currentCropper = new Cropper(imgEl, {
                    aspectRatio: 16 / 9,
                    viewMode: 1,
                    autoCropArea: 0.9,
                    responsive: true,
                    background: false
                });
                // Reset ratio buttons
                document.getElementById('cropRatio169').classList.add('active');
                document.getElementById('cropRatio916').classList.remove('active');
                document.getElementById('cropRatio11').classList.remove('active');
            };
            testImg.src = url;
        }

        function setCropRatio(ratio) {
            cropState.ratio = ratio;
            document.getElementById('cropRatio169').classList.toggle('active', ratio === '16:9');
            document.getElementById('cropRatio916').classList.toggle('active', ratio === '9:16');
            document.getElementById('cropRatio11').classList.toggle('active', ratio === '1:1');
            var numRatio = ratio === '1:1' ? 1 : ratio === '9:16' ? 9 / 16 : 16 / 9;
            if (currentCropper) {
                currentCropper.setAspectRatio(numRatio);
            }
        }

        async function confirmCrop() {
            if (!currentCropper) return;
            var confirmBtn = document.getElementById('cropConfirmBtn');
            confirmBtn.disabled = true;
            confirmBtn.textContent = 'Upload...';

            try {
                var croppedCanvas = currentCropper.getCroppedCanvas({ maxWidth: 2048, maxHeight: 2048, imageSmoothingQuality: 'high' });
                var cropData = currentCropper.getData(true); // rounded
                var croppedBlob = await new Promise(function(resolve) {
                    croppedCanvas.toBlob(function(b) { resolve(b); }, 'image/jpeg', 0.88);
                });

                await uploadToStorage(cropState.originalBlob, croppedBlob, cropState.groupId, cropState.ratio, cropData, cropState.existingMediaId);
                closeCropModal();
            } catch (err) {
                console.error('Crop/upload error:', err);
                alert('Erreur lors de l\'upload : ' + err.message);
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Valider';
            }
        }

        function cancelCrop() {
            closeCropModal();
        }

        function closeCropModal() {
            var modal = document.getElementById('cropModal');
            modal.classList.remove('active');
            if (currentCropper) { currentCropper.destroy(); currentCropper = null; }
            var imgEl = document.getElementById('cropImage');
            if (imgEl.src.startsWith('blob:')) URL.revokeObjectURL(imgEl.src);
            imgEl.src = '';
            var resolve = cropState._resolve;
            cropState = {};
            if (resolve) resolve(); // continue to next image in queue
        }

        // ── Upload vers Supabase Storage + insert room_media ──
        async function uploadToStorage(originalBlob, croppedBlob, groupId, ratio, cropData, existingMediaId) {
            var roomId = roomMap[groupId];
            if (!roomId) throw new Error('Room non sauvegardée');
            var ts = Date.now();

            // Upload original (skip if recrop — original already exists)
            var originalUrl;
            if (existingMediaId) {
                // Recrop: find existing media to get original URL
                var existing = (groupImages[groupId] || []).find(function(img) { return img.mediaId === existingMediaId; });
                originalUrl = existing ? existing.originalUrl : null;
                if (!originalUrl) throw new Error('Original introuvable');
            } else {
                var origPath = 'originals/' + roomId + '/' + ts + '.jpg';
                var origResp = await authenticatedFetch(SUPABASE_URL + '/storage/v1/object/room-images/' + origPath, {
                    method: 'POST',
                    headers: { 'Content-Type': 'image/jpeg', 'x-upsert': 'true' },
                    body: originalBlob
                });
                if (!origResp.ok) throw new Error('Upload original échoué: ' + origResp.status);
                originalUrl = SUPABASE_URL + '/storage/v1/object/public/room-images/' + origPath;
            }

            // Upload cropped
            var cropPath = 'cropped/' + roomId + '/' + ts + '_' + ratio.replace(':', 'x') + '.jpg';
            var cropResp = await authenticatedFetch(SUPABASE_URL + '/storage/v1/object/room-images/' + cropPath, {
                method: 'POST',
                headers: { 'Content-Type': 'image/jpeg', 'x-upsert': 'true' },
                body: croppedBlob
            });
            if (!cropResp.ok) throw new Error('Upload crop échoué: ' + cropResp.status);
            var croppedUrl = SUPABASE_URL + '/storage/v1/object/public/room-images/' + cropPath;

            if (existingMediaId) {
                // Recrop: update existing record
                var oldMedia = (groupImages[groupId] || []).find(function(img) { return img.mediaId === existingMediaId; });
                // Delete old cropped file
                if (oldMedia && oldMedia.url) {
                    var oldPath = oldMedia.url.split('/room-images/')[1];
                    if (oldPath) {
                        authenticatedFetch(SUPABASE_URL + '/storage/v1/object/room-images/' + oldPath, { method: 'DELETE' }).catch(function() {});
                    }
                }
                await authenticatedFetch(SUPABASE_URL + '/rest/v1/room_media?id=eq.' + existingMediaId, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                    body: JSON.stringify({ cropped_url: croppedUrl, crop_ratio: ratio, crop_data: cropData })
                });
                // Update in memory
                if (oldMedia) { oldMedia.url = croppedUrl; oldMedia.cropRatio = ratio; }
            } else {
                // New image: insert record
                var sortOrder = (groupImages[groupId] || []).length;
                var insResp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/room_media', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                    body: JSON.stringify({
                        room_id: roomId,
                        original_url: originalUrl,
                        cropped_url: croppedUrl,
                        crop_ratio: ratio,
                        crop_data: cropData,
                        tags: ['presentation_soumission'],
                        sort_order: sortOrder
                    })
                });
                if (!insResp.ok) throw new Error('Insert room_media échoué: ' + insResp.status);
                var inserted = await insResp.json();
                var mediaId = Array.isArray(inserted) ? inserted[0].id : inserted.id;

                if (!groupImages[groupId]) groupImages[groupId] = [];
                groupImages[groupId].push({
                    name: 'photo_' + ts + '.jpg',
                    url: croppedUrl,
                    originalUrl: originalUrl,
                    mediaId: mediaId,
                    tags: ['presentation_soumission'],
                    cropRatio: ratio,
                    isLegacy: false,
                    showInQuote: true // compat
                });
            }

            renderGroupImagePreviews(groupId);
            showSaveIndicator();
        }

        // ── Recrop depuis l'original ──
        async function recropImage(groupId, index) {
            if (currentSubmission && !isSubmissionCurrentlyEditable()) return;
            var img = (groupImages[groupId] || [])[index];
            if (!img || img.isLegacy || !img.originalUrl) return;
            try {
                var resp = await fetch(img.originalUrl);
                if (!resp.ok) throw new Error('Fetch original failed');
                var blob = await resp.blob();
                openCropModal(blob, groupId, img.mediaId);
            } catch (err) {
                console.error('Recrop error:', err);
                alert('Impossible de charger l\'image originale.');
            }
        }

        function compressImage(file, maxWidth, quality) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        if (w > maxWidth) { h = Math.round(h * maxWidth / w); w = maxWidth; }
                        canvas.width = w; canvas.height = h;
                        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // ═══════════════════════════════════════════════════════════════════════
        // IMAGES PAR MEUBLE (dans le calculateur)
        // ═══════════════════════════════════════════════════════════════════════

        function setupGroupImageHandlers(groupId) {
            const dropZone = document.getElementById(`${groupId}-imgDrop`);
            const fileInput = document.getElementById(`${groupId}-imgInput`);
            if (!dropZone || !fileInput) return;

            dropZone.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => { handleGroupImageFiles(groupId, e.target.files); fileInput.value = ''; });

            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
            dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('dragover'); });
            dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); handleGroupImageFiles(groupId, e.dataTransfer.files); });

            // Paste: écouter sur le groupe entier
            const groupEl = document.getElementById(groupId);
            groupEl.addEventListener('paste', (e) => {
                const files = [];
                for (let i = 0; i < e.clipboardData.items.length; i++) {
                    if (e.clipboardData.items[i].type.startsWith('image/')) files.push(e.clipboardData.items[i].getAsFile());
                }
                if (files.length > 0) { e.preventDefault(); e.stopPropagation(); handleGroupImageFiles(groupId, files); }
            });
        }

        async function handleGroupImageFiles(groupId, files) {
            // Guard: bloquer si soumission verrouillée
            if (currentSubmission && !isSubmissionCurrentlyEditable()) {
                steleAlert('Soumission verrouillée — impossible d\'ajouter des images.');
                return;
            }
            if (!groupImages[groupId]) groupImages[groupId] = [];
            var remaining = MAX_GROUP_IMAGES - groupImages[groupId].length;
            if (remaining <= 0) { alert('Maximum ' + MAX_GROUP_IMAGES + ' images atteint.'); return; }

            var validFiles = Array.from(files).slice(0, remaining);
            // Process one at a time (crop modal is sequential)
            for (var i = 0; i < validFiles.length; i++) {
                var file = validFiles[i];
                var blob;

                if (file.type === 'application/pdf') {
                    // PDF → image conversion
                    try {
                        await loadPdfLib();
                        blob = await convertPdfToImage(file);
                    } catch (err) {
                        console.error('PDF conversion error:', err);
                        alert('Erreur de conversion PDF : ' + err.message);
                        continue;
                    }
                } else if (file.type.startsWith('image/')) {
                    blob = file;
                } else {
                    continue; // skip unsupported
                }

                // Open crop modal (awaits user action)
                await new Promise(function(resolve) {
                    openCropModal(blob, groupId, null);
                    cropState._resolve = resolve; // must be after openCropModal which resets cropState
                });
            }
        }

        function renderGroupImagePreviews(groupId) {
            const container = document.getElementById(`${groupId}-imgPreviews`);
            const countEl = document.getElementById(`${groupId}-imgCount`);
            const dropZone = document.getElementById(`${groupId}-imgDrop`);
            if (!container) return;

            const imgs = groupImages[groupId] || [];
            container.innerHTML = '';
            imgs.forEach((img, index) => {
                const item = document.createElement('div');
                item.className = 'image-preview-item';
                var imgSrc = img.isLegacy ? img.dataUrl : (img.url || img.dataUrl);
                var checkedAttr = img.showInQuote ? 'checked' : '';
                var canRecrop = !img.isLegacy && img.originalUrl && isSubmissionCurrentlyEditable();
                var recropAttr = canRecrop ? ` onclick="recropImage('${escapeAttr(groupId)}', ${index})" style="cursor:pointer;" title="Cliquer pour recadrer"` : ` ondblclick="openLightbox(this.src)" title="Double-cliquer pour agrandir"`;
                item.innerHTML = `<img src="${imgSrc}" alt="${escapeAttr(img.name)}"${recropAttr}><button class="image-preview-remove" onclick="removeGroupImage('${escapeAttr(groupId)}', ${index})" title="Supprimer">&times;</button><label class="image-quote-toggle" title="Afficher dans la soumission client"><input type="checkbox" ${checkedAttr} onchange="toggleImageShowInQuote('${escapeAttr(groupId)}', ${index}, this.checked)"><span>Client</span></label>`;
                container.appendChild(item);
            });
            if (countEl) countEl.textContent = imgs.length > 0 ? imgs.length + ' / ' + MAX_GROUP_IMAGES + ' image(s)' : '';
            if (dropZone) dropZone.style.display = imgs.length >= MAX_GROUP_IMAGES ? 'none' : '';
        }

        async function removeGroupImage(groupId, index) {
            if (!groupImages[groupId]) return;
            var img = groupImages[groupId][index];
            if (!img) return;

            // Guard: bloquer si soumission verrouillée
            if (currentSubmission && !isSubmissionCurrentlyEditable()) {
                steleAlert('Soumission verrouillée — impossible de supprimer des images.');
                return;
            }
            // Confirmation avant suppression
            if (!(await steleConfirm('Supprimer cette image ?', 'Supprimer'))) return;

            if (!img.isLegacy && img.mediaId) {
                // Delete from room_media table
                try {
                    await authenticatedFetch(SUPABASE_URL + '/rest/v1/room_media?id=eq.' + img.mediaId, { method: 'DELETE' });
                } catch (e) { console.error('Delete room_media error:', e); }
                // Delete files from Storage (best effort)
                try {
                    if (img.url) {
                        var croppedPath = img.url.split('/room-images/')[1];
                        if (croppedPath) authenticatedFetch(SUPABASE_URL + '/storage/v1/object/room-images/' + croppedPath, { method: 'DELETE' }).catch(function(){});
                    }
                    if (img.originalUrl) {
                        var origPath = img.originalUrl.split('/room-images/')[1];
                        if (origPath) authenticatedFetch(SUPABASE_URL + '/storage/v1/object/room-images/' + origPath, { method: 'DELETE' }).catch(function(){});
                    }
                } catch (e) { console.error('Delete storage files error:', e); }
            }

            groupImages[groupId].splice(index, 1);
            renderGroupImagePreviews(groupId);
            // Only save to JSONB if there are legacy images
            if (img.isLegacy) saveGroupImages(groupId);
            showSaveIndicator();
        }

        const debouncedSaveGroupImages = debounce(function(groupId) {
            if (!roomMap[groupId]) return;
            // Only save legacy (Base64) images to JSONB — new images are in room_media table
            const legacyImgs = (groupImages[groupId] || []).filter(img => img.isLegacy);
            const imgs = legacyImgs.map(img => ({ name: img.name, dataUrl: img.dataUrl, showInQuote: !!img.showInQuote }));
            updateRoom(roomMap[groupId], { images: imgs });
            showSaveIndicator();
        }, 1000);

        function saveGroupImages(groupId) {
            debouncedSaveGroupImages(groupId);
        }

        function saveExclusions() {
            if (!currentSubmission) return;
            var el = document.getElementById('exclusionsText');
            if (!el) return;
            updateSubmission(currentSubmission.id, { exclusions: el.value });
            showSaveIndicator();
        }

        function saveClientDescription(groupId) {
            if (!roomMap[groupId]) return;
            var textarea = document.getElementById(groupId + '-clientDesc');
            if (!textarea) return;
            // Plain text from calculator — clear HTML cache + stale EN
            roomDescHTML[groupId] = '';
            if (roomDescEN[groupId]) {
                roomDescEN[groupId] = '';
                updateRoom(roomMap[groupId], { client_description: textarea.value, client_description_en: '' });
            } else {
                updateRoom(roomMap[groupId], { client_description: textarea.value });
            }
            showSaveIndicator();
        }

        async function toggleImageShowInQuote(groupId, index, checked) {
            if (!groupImages[groupId] || !groupImages[groupId][index]) return;
            var img = groupImages[groupId][index];
            img.showInQuote = checked;

            if (!img.isLegacy && img.mediaId) {
                // Update tags in room_media
                var newTags = checked
                    ? Array.from(new Set((img.tags || []).concat(['presentation_soumission'])))
                    : (img.tags || []).filter(function(t) { return t !== 'presentation_soumission'; });
                img.tags = newTags;
                try {
                    await authenticatedFetch(SUPABASE_URL + '/rest/v1/room_media?id=eq.' + img.mediaId, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                        body: JSON.stringify({ tags: newTags })
                    });
                } catch (e) { console.error('Update room_media tags error:', e); }
                showSaveIndicator();
            } else {
                saveGroupImages(groupId);
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // ENVOI DE L'ESTIMATION
        // ═══════════════════════════════════════════════════════════════════════

        function collecterDonneesCalculateur() {
            const groups = document.querySelectorAll('.furniture-group');
            const meubles = [];
            let grandTotal = 0;

            groups.forEach(group => {
                const nameInput = group.querySelector('.furniture-name-input');
                const meubleName = nameInput ? (nameInput.value.trim() || 'Sans nom') : 'Sans nom';
                const items = [];
                let subtotal = 0;

                group.querySelectorAll('.calc-row').forEach(row => {
                    const select = row.querySelector('.item-select');
                    const qtyInput = row.querySelector('.qty-input');
                    if (!select || !qtyInput || !select.value) return;

                    const selectedId = select.value;
                    const qty = parseFloat(qtyInput.value) || 0;

                    if (selectedId === '__AJOUT__') {
                        const descInput = row.querySelector('.ajout-description');
                        const priceInput = row.querySelector('.ajout-price');
                        const markupInput = row.querySelector('.ajout-markup');
                        if (descInput && priceInput && markupInput) {
                            const price = parseFloat(priceInput.value) || 0;
                            const markup = parseFloat(markupInput.value) || 0;
                            const lineTotal = price * qty * (1 + markup / 100);
                            subtotal += lineTotal;
                            items.push({ type: 'ajout', description: descInput.value || 'Ajout sans description', unitPrice: formatPrice(price), qty: qty, markup: markup, lineTotal: formatPrice(lineTotal) });
                        }
                    } else {
                        const item = CATALOGUE_DATA.find(i => i.id === selectedId);
                        if (item) {
                            const lineTotal = (item.price || 0) * qty;
                            subtotal += lineTotal;
                            items.push({ type: 'catalogue', code: item.id, description: item.description, itemType: item.type, unitPrice: formatPrice(item.price), qty: qty, lineTotal: formatPrice(lineTotal) });
                        }
                    }
                });

                if (items.length > 0) {
                    grandTotal += subtotal;
                    const groupId = group.id;
                    const imgs = (groupImages[groupId] || []).map(img => ({
                        name: img.name,
                        mimeType: img.dataUrl ? (img.dataUrl.match(/^data:(.*?);/)?.[1] || 'image/jpeg') : 'image/jpeg',
                        data: img.dataUrl ? img.dataUrl.split(',')[1] : null,
                        url: img.url || null
                    }));
                    meubles.push({ name: meubleName, items: items, subtotal: formatPrice(subtotal), images: imgs });
                }
            });

            var result = { meubles: meubles, total: formatPrice(grandTotal) };
            if (currentSubmission) {
                result.submissionNumber = currentSubmission.submission_number;
                result.submissionTitle = currentSubmission.title;
                result.clauses = currentSubmission.clauses || [];
                result.status = currentSubmission.status;
                result.approvedTotal = currentSubmission.approved_total;
            }
            if (currentProject) {
                result.projectName = currentProject.name;
                result.clientName = currentProject.client_name;
                result.clientEmail = currentProject.client_email;
                result.clientAddress = currentProject.client_address;
                result.designer = currentProject.designer;
            }
            // Descriptions client + installation + media URLs par room
            var allGroups = document.querySelectorAll('.furniture-group');
            var mIdx = 0;
            allGroups.forEach(function(group) {
                // Only match groups that produced a meuble (items.length > 0)
                var rows = group.querySelectorAll('.calc-row');
                var hasItems = false;
                rows.forEach(function(row) {
                    var sel = row.querySelector('.item-select');
                    if (sel && sel.value) hasItems = true;
                });
                if (!hasItems) return;
                if (mIdx >= result.meubles.length) return;
                var textarea = group.querySelector('.client-desc-textarea');
                if (textarea) result.meubles[mIdx].clientDescription = textarea.value || '';
                var instCheckbox = group.querySelector('.install-toggle');
                if (instCheckbox) result.meubles[mIdx].installationIncluded = instCheckbox.checked;
                var groupId = group.id;
                result.meubles[mIdx].mediaUrls = (groupImages[groupId] || []).map(function(img) {
                    return { url: img.url || null, originalUrl: img.originalUrl || null, mediaId: img.mediaId || null, cropRatio: img.cropRatio || null, name: img.name };
                });
                mIdx++;
            });
            return result;
        }

        function showSendStatus(message, isError) {
            const statusEl = document.getElementById('sendStatus');
            statusEl.style.display = 'block';
            statusEl.textContent = message;
            statusEl.style.background = isError ? '#ffebee' : '#e8f5e9';
            statusEl.style.color = isError ? '#c62828' : '#2e7d32';
        }

        async function soumettreSoumission() {
            if (!currentSubmission) return;

            const projectDate = document.getElementById('projectDate').value;
            const projectDescription = document.getElementById('projectDescription').value.trim();

            const { meubles, total } = collecterDonneesCalculateur();
            if (meubles.length === 0) { showSendStatus('Aucun article \u00e0 soumettre.', true); return; }

            const btnSend = document.getElementById('btnSend');
            btnSend.disabled = true;
            btnSend.textContent = 'Soumission en cours...';
            showSendStatus('Soumission en cours...', false);

            try {
                // Cr\u00e9er un snapshot avec les notes du modal
                await createVersion(currentSubmission.id);

                // Sauvegarder les notes sur le projet
                if (projectDescription && currentProject) {
                    await updateProject(currentProject.id, { notes: projectDescription });
                }

                var grandTotal = calculerGrandTotal();

                if (canApproveQuotes) {
                    // Auto-approbation
                    await createSubmissionReview(currentSubmission.id, 'approved', projectDescription || 'Auto-approbation');
                    await updateSubmission(currentSubmission.id, {
                        status: 'approved_internal',
                        approved_by: localStorage.getItem('sb_user_id'),
                        approved_at: new Date().toISOString(),
                        approved_total: grandTotal
                    });
                    currentSubmission.status = 'approved_internal';
                    updateStatusBadge('approved_internal');
                    showSendStatus('Soumission approuv\u00e9e!', false);
                } else {
                    // Soumettre pour approbation interne
                    var submitComment = projectDescription || '';
                    if (projectDate) submitComment = 'Date requise: ' + projectDate + (submitComment ? '\n' + submitComment : '');
                    await createSubmissionReview(currentSubmission.id, 'submitted', submitComment || 'Soumis pour approbation');
                    await updateSubmission(currentSubmission.id, {
                        status: 'pending_internal',
                        approved_total: grandTotal
                    });
                    currentSubmission.status = 'pending_internal';
                    updateStatusBadge('pending_internal');
                    showSendStatus('Soumission envoy\u00e9e pour approbation!', false);
                }

                updateWorkflowButtons();
                setEditable(false);
                loadSubmissionReviews(currentSubmission.id);
                btnSend.textContent = 'Soumis!';
                setTimeout(() => {
                    closePdfModal();
                    btnSend.disabled = false;
                    btnSend.textContent = 'Soumettre';
                    document.getElementById('sendStatus').style.display = 'none';
                }, 1500);
            } catch (error) {
                console.error('Erreur soumission:', error);
                showSendStatus('Erreur: ' + error.message, true);
                btnSend.disabled = false;
                btnSend.textContent = 'Soumettre';
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // APERÇU SOUMISSION (PREVIEW VIEW) + BIBLIOTHÈQUE DE CLAUSES
        // ═══════════════════════════════════════════════════════════════════════

        var clauseLibrary = []; // loaded from quote_clauses table
        var clientViewMode = false;
        var currentLang = 'fr';
        var roomDescEN = {}; // { groupDomId: 'english description (HTML)' }
        var roomDescHTML = {}; // { groupDomId: 'HTML description from optimizer' }
        var i18n = {
            fr: {
                soumission: 'Soumission',
                client: 'Client',
                projet: 'Projet',
                designer: 'Designer',
                clausesTitle: 'Clauses du contrat',
                total: 'Total',
                taxes: '+ taxes applicables',
                footer: 'Stele \u2014 \u00c9b\u00e9nisterie sur mesure',
                descPlaceholder: 'Description visible par le client...',
                dropClause: 'Glissez une clause ici',
                biblio: '\u2191 Bib.',
                stepsTitle: '\u00c9tapes d\u2019un projet type',
                steps: [
                    { label: 'Conception', desc: '\u00c0 cette \u00e9tape, nous veillerons \u00e0 rassembler toutes les informations n\u00e9cessaires au bon d\u00e9roulement du projet. Cela inclut le choix des poign\u00e9es, l\u2019approbation des mat\u00e9riaux, ainsi que l\u2019\u00e9tude des d\u00e9fis sp\u00e9cifiques au projet. Nous rassemblerons \u00e9galement les fiches techniques des \u00e9lectrom\u00e9nagers et validerons l\u2019\u00e9ch\u00e9ancier avec le client et l\u2019entrepreneur.' },
                    { label: 'Prise de mesure initiale', desc: 'Typiquement, cette prise de mesures s\u2019effectue sur les colombages et le plancher non fini. Nous tiendrons compte de l\u2019\u00e9paisseur du rev\u00eatement de sol et des murs pr\u00e9vus afin d\u2019\u00e9laborer nos dessins.' },
                    { label: 'Approbation des dessins d\u2019atelier', desc: 'Suite \u00e0 notre premi\u00e8re prise de mesures, les dessins d\u2019atelier vous seront remis pour approbation. Une fois ces dessins approuv\u00e9s, aucune modification ne pourra y \u00eatre apport\u00e9e.' },
                    { label: 'Commande de mat\u00e9riaux', desc: 'Comme nous prenons en compte les \u00e9paisseurs de rev\u00eatement lors de notre prise de mesures sur l\u2019ossature brute, nous sommes en mesure de commander les mat\u00e9riaux, tels que les placages de bois et la quincaillerie sp\u00e9ciale, afin d\u2019\u00e9viter tout d\u00e9lai lors de la mise en production.' },
                    { label: 'Prise de mesure finale', desc: 'La prise de mesures finale s\u2019effectue une fois le plancher fini et les joints ainsi que les coins de fer pos\u00e9s. Apr\u00e8s cette prise de mesures, un d\u00e9lai de 6 semaines est n\u00e9cessaire avant le d\u00e9but de l\u2019installation.' },
                    { label: 'Dessins d\u2019atelier pour production', desc: 'Comme nous avons pr\u00e9alablement ajust\u00e9 la prise de mesures initiale pour qu\u2019elle soit presque conforme au r\u00e9sultat final, les ajustements \u00e0 ce stade sont mineurs. Sauf en cas de changement majeur, les dessins d\u2019atelier ne vous seront pas renvoy\u00e9s pour approbation \u00e0 cette \u00e9tape.' },
                    { label: 'Installation', desc: 'La dur\u00e9e de cette \u00e9tape varie en fonction de l\u2019ampleur du projet, mais elle marque un moment cl\u00e9\u00a0: celui o\u00f9 votre vision prend forme. Il ne restera plus que notre mobilier, pr\u00eat \u00e0 s\u2019int\u00e9grer dans votre quotidien et \u00e0 accompagner vos plus beaux moments \u00e0 la maison.' },
                    { label: 'Contr\u00f4le de qualit\u00e9', desc: 'Une fois l\u2019installation termin\u00e9e, un repr\u00e9sentant Stele effectuera une visite avec vous pour \u00e9tablir ensemble une liste unique d\u2019ajustements, si n\u00e9cessaire. Stele pr\u00e9parera ensuite tout le n\u00e9cessaire et, lors d\u2019une seule visite suppl\u00e9mentaire, apportera les ajustements n\u00e9cessaires pour garantir un r\u00e9sultat final \u00e0 la hauteur de vos attentes.' }
                ]
            },
            en: {
                soumission: 'Quote',
                client: 'Client',
                projet: 'Project',
                designer: 'Designer',
                clausesTitle: 'Contract Terms',
                total: 'Total',
                taxes: '+ applicable taxes',
                footer: 'Stele \u2014 Custom Cabinetry',
                descPlaceholder: 'Client-facing description...',
                dropClause: 'Drag a clause here',
                biblio: '\u2191 Lib.',
                stepsTitle: 'Typical Project Steps',
                steps: [
                    { label: 'Design', desc: 'At this stage, we will gather all the information necessary for the smooth progress of the project. This includes the choice of handles, material approval, and the study of project-specific challenges. We will also collect technical specifications for appliances and validate the timeline with the client and contractor.' },
                    { label: 'Initial Measurement', desc: 'Typically, this measurement is taken on the framing and unfinished floor. We will account for the thickness of the planned flooring and wall coverings in order to develop our drawings.' },
                    { label: 'Shop Drawing Approval', desc: 'Following our initial measurements, the shop drawings will be submitted to you for approval. Once these drawings are approved, no modifications can be made.' },
                    { label: 'Material Ordering', desc: 'Since we account for covering thicknesses during our measurements on the rough framing, we are able to order materials such as wood veneers and specialty hardware, avoiding any delay when production begins.' },
                    { label: 'Final Measurement', desc: 'The final measurement is taken once the finished floor is installed and the joints and corner beads are in place. After this measurement, a 6-week lead time is required before installation begins.' },
                    { label: 'Production Shop Drawings', desc: 'Since we previously adjusted the initial measurements to be nearly consistent with the final result, adjustments at this stage are minor. Unless there is a major change, the shop drawings will not be resubmitted for your approval at this step.' },
                    { label: 'Installation', desc: 'The duration of this stage varies depending on the scope of the project, but it marks a key moment: the one where your vision takes shape. All that will remain is our furniture, ready to integrate into your daily life and accompany your finest moments at home.' },
                    { label: 'Quality Control', desc: 'Once installation is complete, a Stele representative will visit you to establish a single list of adjustments, if necessary. Stele will then prepare everything needed and, in one additional visit, make the necessary adjustments to ensure a final result that meets your expectations.' }
                ]
            }
        };
        function t(key) { return (i18n[currentLang] || i18n.fr)[key] || key; }

        async function openPreview() {
            clientViewMode = false;
            document.getElementById('previewView').classList.remove('pv-client-mode');
            document.getElementById('calculatorView').classList.remove('active');
            document.getElementById('previewView').classList.add('active');
            await loadClauseLibrary();
            renderPreview();
            renderClauseLibrary();
            document.getElementById('pvContent').scrollTop = 0;

            // Hide EN toggle and clause panel when submission is locked
            var isLocked = !isSubmissionCurrentlyEditable();
            var btnLang = document.getElementById('btnLang');
            var pvRight = document.getElementById('pvRight');
            if (btnLang) btnLang.style.display = isLocked ? 'none' : '';
            if (pvRight) pvRight.style.display = isLocked ? 'none' : '';
        }

        function closePreview() {
            document.getElementById('previewView').classList.remove('active');
            document.getElementById('previewView').classList.remove('pv-client-mode');
            document.getElementById('calculatorView').classList.add('active');
            clientViewMode = false;
        }

        // ═══════════════════════════════════════════════════════════════════════
        // Plans architecturaux
        // ═══════════════════════════════════════════════════════════════════════
        async function openPlansModal() {
            if (!currentSubmission) {
                alert('Veuillez ouvrir une soumission d\'abord.');
                return;
            }
            document.getElementById('plansModal').classList.add('active');
            await loadSubmissionPlans();
        }

        function closePlansModal() {
            document.getElementById('plansModal').classList.remove('active');
        }

        async function loadSubmissionPlans() {
            if (!currentSubmission) return;

            var container = document.getElementById('plansListContainer');
            container.innerHTML = '<div class="plans-empty">Chargement...</div>';

            try {
                var response = await authenticatedFetch(
                    SUPABASE_URL + '/rest/v1/submission_plans?submission_id=eq.' + currentSubmission.id + '&order=version_number.desc',
                    { headers: { 'Prefer': 'return=representation' } }
                );

                if (!response.ok) throw new Error('Erreur de chargement des plans');

                var plans = await response.json();

                if (plans.length === 0) {
                    container.innerHTML = '<div class="plans-empty">Aucun plan pour cette soumission</div>';
                    return;
                }

                var html = '';
                for (var i = 0; i < plans.length; i++) {
                    var plan = plans[i];
                    var date = new Date(plan.uploaded_at).toLocaleDateString('fr-CA');
                    var size = (plan.file_size / 1024).toFixed(0) + ' Ko';
                    var pages = plan.page_count ? plan.page_count + ' pages' : '';

                    html += '<div class="plan-item">';
                    html += '  <div class="plan-icon">📄</div>';
                    html += '  <div class="plan-info">';
                    html += '    <div class="plan-version">Version ' + plan.version_number + '</div>';
                    html += '    <div class="plan-filename">' + plan.file_name + '</div>';
                    html += '    <div class="plan-meta">' + date + ' • ' + size + (pages ? ' • ' + pages : '') + '</div>';
                    html += '  </div>';
                    html += '  <div class="plan-actions">';
                    html += '    <button class="plan-action-btn" onclick="openPdfViewer(\'' + plan.id + '\')">Voir</button>';
                    html += '    <button class="plan-action-btn" onclick="downloadPlan(\'' + plan.id + '\', \'' + plan.file_name + '\')">Télécharger</button>';
                    html += '    <button class="plan-action-btn danger" onclick="deletePlan(\'' + plan.id + '\')">Supprimer</button>';
                    html += '  </div>';
                    html += '</div>';
                }

                container.innerHTML = html;
            } catch (err) {
                console.error('Error loading plans:', err);
                container.innerHTML = '<div class="plans-empty">Erreur de chargement</div>';
            }
        }

        async function handlePlanFileSelect(event) {
            var file = event.target.files[0];
            if (!file) return;

            if (file.type !== 'application/pdf') {
                alert('Veuillez sélectionner un fichier PDF.');
                event.target.value = '';
                return;
            }

            await uploadNewPlan(file);
            event.target.value = '';
        }

        async function uploadNewPlan(file) {
            if (!currentSubmission) return;

            var status = document.getElementById('planUploadStatus');
            var btn = document.getElementById('btnUploadPlan');

            try {
                // Show upload status
                btn.disabled = true;
                status.style.display = 'block';
                status.style.background = '#e3f2fd';
                status.style.color = '#1565c0';
                status.innerHTML = '<span style="display:inline-block; animation: pulse 1.5s ease-in-out infinite;">📄</span> Préparation...';

                // Get next version number
                var versionResp = await authenticatedFetch(
                    SUPABASE_URL + '/rest/v1/rpc/get_next_plan_version',
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ p_submission_id: currentSubmission.id })
                    }
                );

                if (!versionResp.ok) throw new Error('Erreur de récupération de la version');
                var nextVersion = await versionResp.json();

                status.innerHTML = '<span style="display:inline-block; animation: pulse 1.5s ease-in-out infinite;">⬆️</span> Upload en cours (' + (file.size / 1024 / 1024).toFixed(1) + ' MB)...';

                // Upload to Storage
                var storagePath = currentSubmission.id + '/v' + nextVersion + '_' + file.name;
                var uploadResp = await authenticatedFetch(
                    SUPABASE_URL + '/storage/v1/object/submission-plans/' + storagePath,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': file.type },
                        body: file
                    }
                );

                if (!uploadResp.ok) {
                    var errData = await uploadResp.text();
                    throw new Error('Erreur d\'upload: ' + errData);
                }

                status.innerHTML = '<span style="display:inline-block; animation: pulse 1.5s ease-in-out infinite;">💾</span> Enregistrement...';

                // Create database record
                var dbResp = await authenticatedFetch(
                    SUPABASE_URL + '/rest/v1/submission_plans',
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify({
                            submission_id: currentSubmission.id,
                            version_number: nextVersion,
                            file_path: storagePath,
                            file_name: file.name,
                            file_size: file.size,
                            status: 'ready'
                        })
                    }
                );

                if (!dbResp.ok) throw new Error('Erreur de création de l\'enregistrement');

                // Success
                status.style.background = '#e8f5e9';
                status.style.color = '#2e7d32';
                status.innerHTML = '✓ Plan téléversé avec succès!';

                // Reload list
                await loadSubmissionPlans();

                // Hide status after 3 seconds
                setTimeout(function() {
                    status.style.display = 'none';
                }, 3000);

            } catch (err) {
                console.error('Upload error:', err);
                status.style.background = '#ffebee';
                status.style.color = '#c62828';
                status.innerHTML = '✗ Erreur: ' + err.message;

                // Keep error visible longer (10 seconds)
                setTimeout(function() {
                    status.style.display = 'none';
                }, 10000);
            } finally {
                btn.disabled = false;
            }
        }

        async function downloadPlan(planId, fileName) {
            try {
                // Get plan record to get file_path
                var planResp = await authenticatedFetch(
                    SUPABASE_URL + '/rest/v1/submission_plans?id=eq.' + planId + '&select=file_path',
                    {}
                );

                if (!planResp.ok) throw new Error('Plan introuvable');
                var plans = await planResp.json();
                if (plans.length === 0) throw new Error('Plan introuvable');

                var filePath = plans[0].file_path;

                // Get signed URL for download
                var signResp = await authenticatedFetch(
                    SUPABASE_URL + '/storage/v1/object/sign/submission-plans/' + filePath,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ expiresIn: 60 })
                    }
                );

                if (!signResp.ok) throw new Error('Erreur de génération du lien');
                var signData = await signResp.json();

                // Download file
                var downloadUrl = SUPABASE_URL + '/storage/v1' + signData.signedURL;
                var link = document.createElement('a');
                link.href = downloadUrl;
                link.download = fileName;
                link.click();

            } catch (err) {
                console.error('Download error:', err);
                alert('Erreur de téléchargement: ' + err.message);
            }
        }

        async function deletePlan(planId) {
            if (!confirm('Êtes-vous sûr de vouloir supprimer ce plan ?')) return;

            try {
                // Get plan record to get file_path
                var planResp = await authenticatedFetch(
                    SUPABASE_URL + '/rest/v1/submission_plans?id=eq.' + planId + '&select=file_path',
                    {}
                );

                if (!planResp.ok) throw new Error('Plan introuvable');
                var plans = await planResp.json();
                if (plans.length === 0) throw new Error('Plan introuvable');

                var filePath = plans[0].file_path;

                // Delete from Storage
                var deleteStorageResp = await authenticatedFetch(
                    SUPABASE_URL + '/storage/v1/object/submission-plans/' + filePath,
                    { method: 'DELETE' }
                );

                if (!deleteStorageResp.ok) {
                    console.warn('Storage deletion failed, continuing with DB deletion');
                }

                // Delete from database
                var deleteDbResp = await authenticatedFetch(
                    SUPABASE_URL + '/rest/v1/submission_plans?id=eq.' + planId,
                    { method: 'DELETE' }
                );

                if (!deleteDbResp.ok) throw new Error('Erreur de suppression');

                // Reload list
                await loadSubmissionPlans();

            } catch (err) {
                console.error('Delete error:', err);
                alert('Erreur de suppression: ' + err.message);
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // PDF Viewer
        // ═══════════════════════════════════════════════════════════════════════
        var pdfDoc = null;
        var pdfCurrentPage = 1;
        var pdfTotalPages = 0;
        var pdfScale = 1.0;
        var pdfRotation = 0;
        var currentPdfUrl = null;
        var currentPlanRecord = null;

        async function openPdfViewer(planId) {
            try {
                // Get plan record
                var planResp = await authenticatedFetch(
                    SUPABASE_URL + '/rest/v1/submission_plans?id=eq.' + planId + '&select=*',
                    {}
                );

                if (!planResp.ok) throw new Error('Plan introuvable');
                var plans = await planResp.json();
                if (plans.length === 0) throw new Error('Plan introuvable');

                currentPlanRecord = plans[0];

                // Get signed URL
                var signResp = await authenticatedFetch(
                    SUPABASE_URL + '/storage/v1/object/sign/submission-plans/' + currentPlanRecord.file_path,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ expiresIn: 3600 })
                    }
                );

                if (!signResp.ok) throw new Error('Erreur de génération du lien');
                var signData = await signResp.json();

                currentPdfUrl = SUPABASE_URL + '/storage/v1' + signData.signedURL;

                // Load PDF
                var loadingTask = pdfjsLib.getDocument(currentPdfUrl);
                pdfDoc = await loadingTask.promise;
                pdfTotalPages = pdfDoc.numPages;
                pdfCurrentPage = 1;
                pdfScale = 1.0;
                pdfRotation = 0;

                // Update title
                document.getElementById('pdfViewerTitle').textContent = currentPlanRecord.file_name;

                // Show modal
                document.getElementById('pdfViewerOverlay').classList.add('active');

                // Render first page
                await renderPdfPage();

                // Generate thumbnails
                await renderPdfThumbnails();

            } catch (err) {
                console.error('PDF viewer error:', err);
                alert('Erreur d\'ouverture du PDF: ' + err.message);
            }
        }

        function closePdfViewer() {
            document.getElementById('pdfViewerOverlay').classList.remove('active');
            // Don't reset pdfDoc - keep it in memory for captures
            // pdfDoc = null;
            // currentPdfUrl = null;
            // currentPlanRecord = null;
        }

        function openPdfInNewWindow() {
            if (!pdfDoc || !currentPlanRecord) {
                alert('Aucun PDF chargé');
                return;
            }

            // Create standalone viewer page
            var viewerHtml = createStandaloneViewer();
            var blob = new Blob([viewerHtml], { type: 'text/html' });
            var blobUrl = URL.createObjectURL(blob);

            // Open in new window
            var newWindow = window.open(blobUrl, '_blank', 'width=1200,height=800');

            if (!newWindow) {
                alert('Veuillez autoriser les fenêtres pop-up pour cette fonctionnalité.');
            } else {
                // Pass data to new window after it loads
                newWindow.addEventListener('load', function() {
                    newWindow.postMessage({
                        type: 'INIT_PDF',
                        pdfUrl: currentPdfUrl,
                        planRecord: currentPlanRecord,
                        submissionId: currentSubmission.id,
                        supabaseUrl: SUPABASE_URL,
                        accessToken: localStorage.getItem('sb_access_token')
                    }, '*');
                });
            }
        }

        function createStandaloneViewer() {
            return '<!DOCTYPE html>' +
'<html><head><meta charset="utf-8"><title>Plan - ' + (currentPlanRecord ? currentPlanRecord.file_name : 'PDF') + '</title>' +
'<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>' +
'<style>' +
'* { margin: 0; padding: 0; box-sizing: border-box; }' +
'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #2b2b2b; color: #fff; overflow: hidden; }' +
'.viewer-header { background: #1a1a1a; padding: 12px 16px; display: flex; align-items: center; gap: 16px; border-bottom: 1px solid #444; }' +
'.viewer-title { font-size: 14px; font-weight: 600; flex: 1; }' +
'.controls { display: flex; align-items: center; gap: 8px; }' +
'.btn { background: #3a3a3a; border: 1px solid #555; color: #fff; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 13px; font-family: inherit; }' +
'.btn:hover { background: #4a4a4a; }' +
'.btn:disabled { opacity: 0.5; cursor: not-allowed; }' +
'.page-info { font-size: 13px; color: #999; }' +
'.canvas-container { position: fixed; top: 60px; left: 0; right: 0; bottom: 0; overflow: auto; display: flex; justify-content: center; align-items: flex-start; padding: 20px; }' +
'canvas { box-shadow: 0 4px 24px rgba(0,0,0,0.5); background: #fff; }' +
'.capture-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; z-index: 1000; }' +
'.capture-modal.active { display: flex; }' +
'.modal-content { background: #2b2b2b; border-radius: 8px; padding: 24px; max-width: 500px; width: 90%; border: 1px solid #444; }' +
'.modal-title { font-size: 18px; margin-bottom: 16px; }' +
'.form-group { margin-bottom: 16px; }' +
'.form-label { display: block; font-size: 13px; margin-bottom: 6px; color: #aaa; }' +
'.form-input { width: 100%; padding: 10px; background: #1a1a1a; border: 1px solid #555; border-radius: 4px; color: #fff; font-family: inherit; font-size: 14px; }' +
'.modal-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px; }' +
'.status { margin-top: 12px; padding: 10px; border-radius: 4px; font-size: 13px; display: none; }' +
'</style></head><body>' +
'<div class="viewer-header">' +
'  <div class="viewer-title" id="title">Chargement...</div>' +
'  <div class="controls">' +
'    <button class="btn" id="btnPrev" onclick="navigate(-1)">◀</button>' +
'    <span class="page-info" id="pageInfo">1 / 1</span>' +
'    <button class="btn" id="btnNext" onclick="navigate(1)">▶</button>' +
'    <button class="btn" onclick="zoom(-0.25)">−</button>' +
'    <span class="page-info" id="zoomInfo">100%</span>' +
'    <button class="btn" onclick="zoom(0.25)">+</button>' +
'    <button class="btn" onclick="rotate()">↻</button>' +
'    <button class="btn" onclick="openCaptureModal()">📸 Capturer</button>' +
'  </div>' +
'</div>' +
'<div class="canvas-container" id="canvasContainer"><canvas id="pdfCanvas"></canvas></div>' +
'<div class="capture-modal" id="captureModal">' +
'  <div class="modal-content">' +
'    <div class="modal-title">Capturer la page</div>' +
'    <div class="form-group"><label class="form-label">Pièce / Meuble</label><select class="form-input" id="roomSelect"><option value="">-- Sélectionnez --</option></select></div>' +
'    <div class="status" id="status"></div>' +
'    <div class="modal-actions"><button class="btn" onclick="closeCaptureModal()">Annuler</button><button class="btn" onclick="confirmCapture()">Capturer</button></div>' +
'  </div>' +
'</div>' +
'<script>' +
'pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";' +
'var pdfDoc = null, currentPage = 1, totalPages = 0, scale = 1.0, rotation = 0, planRecord = null, submissionId = null, supabaseUrl = null, accessToken = null;' +
'window.addEventListener("message", async function(e) {' +
'  if (e.data.type === "INIT_PDF") {' +
'    planRecord = e.data.planRecord; submissionId = e.data.submissionId; supabaseUrl = e.data.supabaseUrl; accessToken = e.data.accessToken;' +
'    document.getElementById("title").textContent = planRecord.file_name;' +
'    var loadingTask = pdfjsLib.getDocument(e.data.pdfUrl);' +
'    pdfDoc = await loadingTask.promise; totalPages = pdfDoc.numPages; await render(); await loadRooms();' +
'  }' +
'});' +
'async function render() {' +
'  if (!pdfDoc) return;' +
'  var page = await pdfDoc.getPage(currentPage);' +
'  var canvas = document.getElementById("pdfCanvas"); var ctx = canvas.getContext("2d");' +
'  var viewport = page.getViewport({ scale: scale, rotation: rotation });' +
'  canvas.width = viewport.width; canvas.height = viewport.height;' +
'  await page.render({ canvasContext: ctx, viewport: viewport }).promise;' +
'  document.getElementById("pageInfo").textContent = currentPage + " / " + totalPages;' +
'  document.getElementById("zoomInfo").textContent = Math.round(scale * 100) + "%";' +
'  document.getElementById("btnPrev").disabled = currentPage <= 1; document.getElementById("btnNext").disabled = currentPage >= totalPages;' +
'}' +
'function navigate(d) { currentPage += d; if (currentPage < 1) currentPage = 1; if (currentPage > totalPages) currentPage = totalPages; render(); }' +
'function zoom(d) { scale += d; if (scale < 0.5) scale = 0.5; if (scale > 3.0) scale = 3.0; render(); }' +
'function rotate() { rotation = (rotation + 90) % 360; render(); }' +
'document.getElementById("canvasContainer").addEventListener("wheel", function(e) { if (e.ctrlKey) { e.preventDefault(); zoom(e.deltaY > 0 ? -0.1 : 0.1); }}, { passive: false });' +
'async function loadRooms() {' +
'  try {' +
'    var r = await fetch(supabaseUrl + "/rest/v1/project_rooms?submission_id=eq." + submissionId + "&select=id,name&order=sort_order.asc", { headers: { "apikey": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJwbHpidGpmbndhaHFvZHJocG55Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ1NjU2NzMsImV4cCI6MjA1MDE0MTY3M30.TUZ7aFlqZECugaPAZOqMpqEFaI-I4RQMV_9JI-KqS0k", "Authorization": "Bearer " + accessToken } });' +
'    var rooms = await r.json(); var sel = document.getElementById("roomSelect");' +
'    rooms.forEach(function(rm) { var opt = document.createElement("option"); opt.value = rm.id; opt.textContent = rm.name; sel.appendChild(opt); });' +
'  } catch (e) { console.error(e); }' +
'}' +
'function openCaptureModal() { document.getElementById("captureModal").classList.add("active"); }' +
'function closeCaptureModal() { document.getElementById("captureModal").classList.remove("active"); document.getElementById("status").style.display = "none"; }' +
'async function confirmCapture() {' +
'  var roomId = document.getElementById("roomSelect").value; if (!roomId) { alert("Sélectionnez une pièce"); return; }' +
'  var status = document.getElementById("status"); status.style.display = "block"; status.style.background = "#e3f2fd"; status.style.color = "#1565c0"; status.textContent = "Capture...";' +
'  try {' +
'    var page = await pdfDoc.getPage(currentPage); var viewport = page.getViewport({ scale: 3.0, rotation: rotation });' +
'    var canvas = document.createElement("canvas"); canvas.width = viewport.width; canvas.height = viewport.height;' +
'    await page.render({ canvasContext: canvas.getContext("2d"), viewport: viewport }).promise;' +
'    status.textContent = "Compression...";' +
'    var blob = await new Promise(function(res) { canvas.toBlob(function(b) { res(b); }, "image/jpeg", 0.85); });' +
'    status.textContent = "Upload..."; var ts = Date.now(); var filename = "plan_p" + currentPage + "_" + ts + ".jpg"; var uploadPath = roomId + "/" + filename;' +
'    var up = await fetch(supabaseUrl + "/storage/v1/object/room-media/" + uploadPath, { method: "POST", headers: { "apikey": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJwbHpidGpmbndhaHFvZHJocG55Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ1NjU2NzMsImV4cCI6MjA1MDE0MTY3M30.TUZ7aFlqZECugaPAZOqMpqEFaI-I4RQMV_9JI-KqS0k", "Authorization": "Bearer " + accessToken, "Content-Type": "image/jpeg" }, body: blob });' +
'    if (!up.ok) throw new Error("Upload failed");' +
'    var meta = { type: "pdf_plan", plan_id: planRecord.id, page_number: currentPage, pdf_filename: planRecord.file_name, pdf_version: planRecord.version_number, captured_at: new Date().toISOString(), scale: 3.0 };' +
'    await fetch(supabaseUrl + "/rest/v1/room_media", { method: "POST", headers: { "apikey": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJwbHpidGpmbndhaHFvZHJocG55Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ1NjU2NzMsImV4cCI6MjA1MDE0MTY3M30.TUZ7aFlqZECugaPAZOqMpqEFaI-I4RQMV_9JI-KqS0k", "Authorization": "Bearer " + accessToken, "Content-Type": "application/json" }, body: JSON.stringify({ room_id: roomId, file_path: uploadPath, file_name: filename, file_size: blob.size, tags: [], source_metadata: meta }) });' +
'    status.style.background = "#e8f5e9"; status.style.color = "#2e7d32"; status.textContent = "✓ Capture réussie!"; setTimeout(closeCaptureModal, 2000);' +
'  } catch (e) { console.error(e); status.style.background = "#ffebee"; status.style.color = "#c62828"; status.textContent = "✗ Erreur: " + e.message; }' +
'}' +
'</script></body></html>';
        }

        async function renderPdfPage() {
            if (!pdfDoc) return;

            var page = await pdfDoc.getPage(pdfCurrentPage);
            var canvas = document.getElementById('pdfCanvas');
            var ctx = canvas.getContext('2d');

            var viewport = page.getViewport({ scale: pdfScale, rotation: pdfRotation });

            canvas.width = viewport.width;
            canvas.height = viewport.height;

            var renderContext = {
                canvasContext: ctx,
                viewport: viewport
            };

            await page.render(renderContext).promise;

            // Update UI
            document.getElementById('pdfPageInfo').textContent = pdfCurrentPage + ' / ' + pdfTotalPages;
            document.getElementById('pdfZoomInfo').textContent = Math.round(pdfScale * 100) + '%';

            // Update prev/next buttons
            document.getElementById('btnPdfPrev').disabled = (pdfCurrentPage <= 1);
            document.getElementById('btnPdfNext').disabled = (pdfCurrentPage >= pdfTotalPages);

            // Update active thumbnail
            var thumbs = document.querySelectorAll('.pdf-thumb');
            for (var i = 0; i < thumbs.length; i++) {
                thumbs[i].classList.remove('active');
            }
            var activeThumb = document.querySelector('.pdf-thumb[data-page="' + pdfCurrentPage + '"]');
            if (activeThumb) activeThumb.classList.add('active');
        }

        async function renderPdfThumbnails() {
            if (!pdfDoc) return;

            var container = document.getElementById('pdfThumbnails');
            container.innerHTML = '';

            for (var pageNum = 1; pageNum <= pdfTotalPages; pageNum++) {
                var page = await pdfDoc.getPage(pageNum);
                var viewport = page.getViewport({ scale: 0.3 });

                var thumbDiv = document.createElement('div');
                thumbDiv.className = 'pdf-thumb';
                thumbDiv.setAttribute('data-page', pageNum);
                thumbDiv.onclick = (function(num) {
                    return function() { pdfGoToPage(num); };
                })(pageNum);

                var canvas = document.createElement('canvas');
                canvas.width = viewport.width;
                canvas.height = viewport.height;

                var ctx = canvas.getContext('2d');
                await page.render({
                    canvasContext: ctx,
                    viewport: viewport
                }).promise;

                var label = document.createElement('div');
                label.className = 'pdf-thumb-label';
                label.textContent = pageNum;

                thumbDiv.appendChild(canvas);
                thumbDiv.appendChild(label);
                container.appendChild(thumbDiv);
            }

            // Mark first as active
            var firstThumb = container.querySelector('.pdf-thumb[data-page="1"]');
            if (firstThumb) firstThumb.classList.add('active');
        }

        function pdfNavigate(delta) {
            pdfCurrentPage += delta;
            if (pdfCurrentPage < 1) pdfCurrentPage = 1;
            if (pdfCurrentPage > pdfTotalPages) pdfCurrentPage = pdfTotalPages;
            renderPdfPage();
        }

        function pdfGoToPage(pageNum) {
            pdfCurrentPage = pageNum;
            renderPdfPage();
        }

        function pdfZoom(delta) {
            pdfScale += delta;
            if (pdfScale < 0.5) pdfScale = 0.5;
            if (pdfScale > 3.0) pdfScale = 3.0;
            renderPdfPage();
        }

        function pdfResetZoom() {
            pdfScale = 1.0;
            renderPdfPage();
        }

        function pdfRotate() {
            pdfRotation = (pdfRotation + 90) % 360;
            renderPdfPage();
        }

        // ═══════════════════════════════════════════════════════════════════════
        // Capture PDF Page → Room Media
        // ═══════════════════════════════════════════════════════════════════════
        var capturedImageBlob = null;

        async function capturePdfPage() {
            if (!currentSubmission) {
                alert('Aucune soumission ouverte');
                return;
            }

            // Load rooms and open modal
            await loadRoomsForCapture();
            document.getElementById('captureRoomModal').classList.add('active');
        }

        async function loadRoomsForCapture() {
            var select = document.getElementById('captureRoomSelect');
            select.innerHTML = '<option value="">-- Sélectionnez --</option>';

            if (!currentSubmission) return;

            try {
                var response = await authenticatedFetch(
                    SUPABASE_URL + '/rest/v1/project_rooms?submission_id=eq.' + currentSubmission.id + '&select=id,name&order=sort_order.asc',
                    {}
                );

                if (!response.ok) throw new Error('Erreur de chargement des pièces');

                var rooms = await response.json();

                for (var i = 0; i < rooms.length; i++) {
                    var option = document.createElement('option');
                    option.value = rooms[i].id;
                    option.textContent = rooms[i].name;
                    select.appendChild(option);
                }

            } catch (err) {
                console.error('Error loading rooms:', err);
                alert('Erreur de chargement des pièces');
            }
        }

        function closeCaptureRoomModal() {
            document.getElementById('captureRoomModal').classList.remove('active');
            capturedImageBlob = null;
            document.getElementById('captureStatus').style.display = 'none';
        }

        async function confirmCapture() {
            var roomId = document.getElementById('captureRoomSelect').value;
            if (!roomId) {
                alert('Veuillez sélectionner une pièce');
                return;
            }

            // Validate PDF is loaded
            if (!pdfDoc || !currentPlanRecord) {
                alert('Erreur: Le PDF n\'est pas chargé correctement. Veuillez fermer et rouvrir le PDF.');
                return;
            }

            var status = document.getElementById('captureStatus');
            var btn = document.getElementById('btnConfirmCapture');

            try {
                btn.disabled = true;
                status.style.display = 'block';
                status.style.background = '#e3f2fd';
                status.style.color = '#1565c0';
                status.textContent = 'Capture en cours...';

                // Render page at high resolution (scale=3 for ~300 DPI)
                if (!pdfDoc) throw new Error('PDF non chargé');

                var page = await pdfDoc.getPage(pdfCurrentPage);
                var viewport = page.getViewport({ scale: 3.0, rotation: pdfRotation });

                // Create temporary canvas for high-res render
                var canvas = document.createElement('canvas');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                var ctx = canvas.getContext('2d');

                await page.render({
                    canvasContext: ctx,
                    viewport: viewport
                }).promise;

                status.textContent = 'Compression de l\'image...';

                // Convert to JPEG blob
                var blob = await new Promise(function(resolve) {
                    canvas.toBlob(function(b) { resolve(b); }, 'image/jpeg', 0.85);
                });

                status.textContent = 'Upload en cours...';

                // Generate unique filename
                var timestamp = Date.now();
                var filename = 'plan_p' + pdfCurrentPage + '_' + timestamp + '.jpg';

                // Upload to room_media bucket
                var uploadPath = roomId + '/' + filename;
                var uploadResp = await authenticatedFetch(
                    SUPABASE_URL + '/storage/v1/object/room-media/' + uploadPath,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'image/jpeg' },
                        body: blob
                    }
                );

                if (!uploadResp.ok) {
                    var errText = await uploadResp.text();
                    throw new Error('Erreur d\'upload: ' + errText);
                }

                // Create room_media record with source_metadata
                var sourceMetadata = {
                    type: 'pdf_plan',
                    plan_id: currentPlanRecord.id,
                    page_number: pdfCurrentPage,
                    pdf_filename: currentPlanRecord.file_name,
                    pdf_version: currentPlanRecord.version_number,
                    captured_at: new Date().toISOString(),
                    scale: 3.0
                };

                var mediaResp = await authenticatedFetch(
                    SUPABASE_URL + '/rest/v1/room_media',
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify({
                            room_id: roomId,
                            file_path: uploadPath,
                            file_name: filename,
                            file_size: blob.size,
                            tags: [],
                            source_metadata: sourceMetadata
                        })
                    }
                );

                if (!mediaResp.ok) throw new Error('Erreur de création de l\'enregistrement');

                status.style.background = '#e8f5e9';
                status.style.color = '#2e7d32';
                status.textContent = '✓ Capture réussie!';

                setTimeout(function() {
                    closeCaptureRoomModal();
                }, 1500);

            } catch (err) {
                console.error('Capture error:', err);
                status.style.background = '#ffebee';
                status.style.color = '#c62828';
                status.textContent = 'Erreur: ' + err.message;
                btn.disabled = false;
            }
        }

        // toggleClientView removed — Présentation handles client mode directly

        async function toggleLang() {
            var btn = document.getElementById('btnLang');
            if (currentLang === 'fr') {
                // Switching to EN — check if translation needed
                var stale = collectStaleFrTexts();
                if (stale.length > 0) {
                    if (btn) { btn.disabled = true; btn.textContent = 'Traduction...'; }
                    try {
                        var results = await callEdgeFunction(stale, 'translate');
                        applyTranslations(results);
                        showSaveIndicator();
                    } catch (err) {
                        console.error('Translation error:', err);
                        alert('Erreur de traduction : ' + err.message);
                        if (btn) { btn.disabled = false; btn.textContent = 'EN'; }
                        return; // stay on FR
                    }
                }
                currentLang = 'en';
            } else {
                currentLang = 'fr';
            }
            if (btn) {
                btn.textContent = currentLang === 'fr' ? 'EN' : 'FR';
                btn.classList.toggle('active', currentLang === 'en');
                btn.disabled = false;
            }
            renderPreview();
        }

        // Collect only FR texts that have no EN translation (stale or missing)
        function collectStaleFrTexts() {
            var texts = [];
            var groups = document.querySelectorAll('#calculatorView .furniture-group');
            groups.forEach(function(g) {
                var gid = g.id;
                if (roomDescEN[gid]) return; // already has EN translation
                var frText;
                if (roomDescHTML[gid]) {
                    frText = roomDescHTML[gid];
                } else {
                    var descEl = document.getElementById(gid + '-clientDesc');
                    frText = descEl ? descEl.value.trim() : '';
                }
                if (frText) {
                    texts.push({ key: 'room_' + gid, text: frText });
                }
            });
            var clauses = getSubmissionClauses();
            clauses.forEach(function(c, i) {
                if (c.content && c.content.trim() && !c.content_en) {
                    texts.push({ key: 'clause_' + i, text: c.content });
                }
            });
            return texts;
        }

        // Apply translation results to memory + DB
        function applyTranslations(results) {
            var groups = document.querySelectorAll('#calculatorView .furniture-group');
            groups.forEach(function(g) {
                var gid = g.id;
                var key = 'room_' + gid;
                if (results[key]) {
                    roomDescEN[gid] = results[key];
                    if (roomMap[gid]) {
                        updateRoom(roomMap[gid], { client_description_en: results[key] });
                    }
                }
            });
            var clauses = getSubmissionClauses();
            var updated = clauses.slice();
            var changed = false;
            clauses.forEach(function(c, i) {
                var key = 'clause_' + i;
                if (results[key]) {
                    updated[i].content_en = results[key];
                    changed = true;
                }
            });
            if (changed) saveSubmissionClauses(updated);
        }

        // ── Edge Function helper ──
        async function callEdgeFunction(texts, action) {
            var token = localStorage.getItem('sb_access_token') || '';
            console.log('[AI] Calling edge function:', action, 'with', texts.length, 'texts');
            var resp = await fetch(SUPABASE_URL + '/functions/v1/translate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token,
                    'apikey': SUPABASE_KEY
                },
                body: JSON.stringify({ texts: texts, action: action })
            });
            if (!resp.ok) {
                var errText = await resp.text().catch(function() { return ''; });
                console.error('[AI] Edge function error:', resp.status, errText);
                try { var errObj = JSON.parse(errText); throw new Error(errObj.error || 'Erreur ' + resp.status); }
                catch(e) { if (e.message) throw e; throw new Error('Erreur ' + resp.status + ': ' + errText.substring(0, 200)); }
            }
            var data = await resp.json();
            console.log('[AI] Edge function response:', JSON.stringify(data).substring(0, 500));
            if (!data.translations || Object.keys(data.translations).length === 0) {
                throw new Error('Aucun résultat retourné par l\'AI');
            }
            return data.translations;
        }

        // ── Collect all FR texts (useHtml=true sends HTML for translate, plain for optimize) ──
        function collectFrTexts(useHtml) {
            var texts = [];
            var groups = document.querySelectorAll('#calculatorView .furniture-group');
            groups.forEach(function(g) {
                var gid = g.id;
                var frText;
                if (useHtml && roomDescHTML[gid]) {
                    frText = roomDescHTML[gid]; // HTML for translation
                } else {
                    var descEl = document.getElementById(gid + '-clientDesc');
                    frText = descEl ? descEl.value.trim() : '';
                }
                if (frText) {
                    texts.push({ key: 'room_' + gid, text: frText });
                }
            });
            var clauses = getSubmissionClauses();
            clauses.forEach(function(c, i) {
                if (c.content && c.content.trim()) {
                    texts.push({ key: 'clause_' + i, text: c.content });
                }
            });
            return texts;
        }

        // ── Optimiser tout (FR) ──
        async function optimizeAll() {
            var btn = document.getElementById('btnOptimizeAll');
            if (!btn) return;
            var origText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Optimisation...';

            try {
                var texts = collectFrTexts();
                if (texts.length === 0) { showSaveIndicator(); return; }

                var results = await callEdgeFunction(texts, 'optimize');
                var groups = document.querySelectorAll('#calculatorView .furniture-group');

                // Apply optimized room descriptions (HTML)
                groups.forEach(function(g) {
                    var gid = g.id;
                    var key = 'room_' + gid;
                    if (results[key]) {
                        // Store HTML in memory
                        roomDescHTML[gid] = results[key];
                        if (roomMap[gid]) {
                            updateRoom(roomMap[gid], { client_description: results[key], client_description_en: '' });
                        }
                        // Clear stale EN
                        roomDescEN[gid] = '';
                    }
                });

                // Apply optimized clause texts
                var clauses = getSubmissionClauses();
                var updated = clauses.slice();
                var changed = false;
                clauses.forEach(function(c, i) {
                    var key = 'clause_' + i;
                    if (results[key]) {
                        updated[i].content = results[key];
                        updated[i].content_en = ''; // clear stale EN
                        changed = true;
                    }
                });
                if (changed) await saveSubmissionClauses(updated);

                showSaveIndicator();
                renderPreview();
            } catch (err) {
                console.error('Optimize error:', err);
                alert('Erreur d\'optimisation : ' + err.message);
            } finally {
                btn.disabled = false;
                btn.textContent = origText;
            }
        }

        // ── Optimiser un seul champ (bouton ✨ par champ) ──
        async function optimizeText(btnEl) {
            var gid = btnEl.getAttribute('data-group-id');
            if (!gid) return;
            var descDiv = btnEl.parentElement.querySelector('.pv-page-room-desc');
            if (!descDiv || !descDiv.textContent.trim()) return;

            btnEl.disabled = true;
            var origText = btnEl.textContent;
            btnEl.textContent = '...';

            try {
                // Send plain text to AI, receive HTML back
                var results = await callEdgeFunction(
                    [{ key: 'room_' + gid, text: descDiv.textContent }],
                    'optimize'
                );
                var optimized = results['room_' + gid];
                console.log('[AI] Optimize result for', gid, ':', optimized ? optimized.substring(0, 200) : 'EMPTY');
                if (optimized) {
                    // Save optimized HTML to memory + DB
                    roomDescHTML[gid] = optimized;
                    if (roomMap[gid]) {
                        updateRoom(roomMap[gid], { client_description: optimized, client_description_en: '' });
                    }
                    // Clear stale EN
                    roomDescEN[gid] = '';
                    showSaveIndicator();
                    // Re-render to show optimized HTML
                    renderPreview();
                } else {
                    alert('L\'AI n\'a retourné aucun texte. Vérifiez la console (F12).');
                }
            } catch (err) {
                console.error('Optimize error:', err);
                alert('Erreur d\'optimisation : ' + err.message);
            } finally {
                btnEl.disabled = false;
                btnEl.textContent = origText;
            }
        }

        // ── Traduire tout (FR → EN) ──

        function removePreviewImage(groupId, index) {
            removeGroupImage(groupId, index);
            renderPreview();
        }

        // ── Clause Library CRUD ──

        async function loadClauseLibrary() {
            try {
                var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/quote_clauses?order=sort_order.asc,title.asc&select=*', {});
                if (r.ok) clauseLibrary = await r.json();
            } catch (e) { console.error('loadClauseLibrary error:', e); }
        }

        function renderClauseLibrary() {
            var container = document.getElementById('pvClauseList');
            if (!container) return;

            if (clauseLibrary.length === 0) {
                container.innerHTML = '<p class="pv-clause-empty">Aucune clause dans la biblioth\u00e8que. Cliquez + pour en cr\u00e9er.</p>';
                return;
            }

            var html = '';
            clauseLibrary.forEach(function(clause, idx) {
                html += '<div class="pv-clause-item" draggable="true" data-clause-idx="' + idx + '"';
                html += ' ondragstart="onClauseDragStart(event, ' + idx + ')">';
                html += '<div class="pv-clause-item-header">';
                html += '<span class="pv-clause-item-title">' + escapeHtml(clause.title) + '</span>';
                html += '<span class="pv-clause-item-btns">';
                html += '<button class="pv-clause-item-btn add-to-sub" onclick="event.stopPropagation(); addClauseToSubmission(' + idx + ')" title="Ajouter \u00e0 la soumission">+</button>';
                html += '<button class="pv-clause-item-btn" onclick="showClauseEditor(\'' + clause.id + '\')" title="Modifier">\u270E</button>';
                html += '<button class="pv-clause-item-btn delete" onclick="deleteLibraryClause(\'' + clause.id + '\')" title="Supprimer">\u2715</button>';
                html += '</span>';
                html += '</div>';
                var preview = (clause.content_fr || '').substring(0, 120);
                if (preview) html += '<div class="pv-clause-item-preview">' + escapeHtml(preview) + '</div>';
                html += '</div>';
            });
            container.innerHTML = html;
        }

        function showClauseEditor(clauseId) {
            var zone = document.getElementById('pvClauseEditZone');
            if (!zone) return;

            var clause = clauseId ? clauseLibrary.find(function(c) { return c.id === clauseId; }) : null;
            var isNew = !clause;

            zone.innerHTML = '<div class="pv-clause-edit">' +
                '<label>Titre</label>' +
                '<input type="text" id="ceTitle" value="' + escapeAttr(clause ? clause.title : '') + '" placeholder="Ex: Dessins d\'atelier">' +
                '<label>Contenu</label>' +
                '<textarea id="ceFr" rows="5" placeholder="Texte de la clause...">' + escapeHtml(clause ? clause.content_fr : '') + '</textarea>' +
                '<div class="pv-clause-edit-btns">' +
                '<button class="cancel" onclick="closeClauseEditor()">Annuler</button>' +
                '<button class="save" onclick="saveLibraryClause(' + (isNew ? 'null' : "'" + clauseId + "'") + ')">' + (isNew ? 'Cr\u00e9er' : 'Sauvegarder') + '</button>' +
                '</div></div>';

            zone.querySelector('#ceTitle').focus();
        }

        function closeClauseEditor() {
            var zone = document.getElementById('pvClauseEditZone');
            if (zone) zone.innerHTML = '';
        }

        async function saveLibraryClause(clauseId) {
            var title = document.getElementById('ceTitle').value.trim();
            var fr = document.getElementById('ceFr').value.trim();
            if (!title) { document.getElementById('ceTitle').focus(); return; }

            var payload = { title: title, content_fr: fr };

            try {
                var r;
                if (clauseId) {
                    r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/quote_clauses?id=eq.' + clauseId, {
                        method: 'PATCH', headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                        body: JSON.stringify(payload)
                    });
                } else {
                    r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/quote_clauses', {
                        method: 'POST', headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                        body: JSON.stringify(payload)
                    });
                }

                if (r.ok) {
                    closeClauseEditor();
                    await loadClauseLibrary();
                    renderClauseLibrary();
                    showSaveIndicator();
                }
            } catch (e) { console.error('saveLibraryClause error:', e); }
        }

        async function deleteLibraryClause(clauseId) {
            if (!confirm('Supprimer cette clause de la biblioth\u00e8que ?')) return;
            try {
                var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/quote_clauses?id=eq.' + clauseId, { method: 'DELETE' });
                if (r.ok) {
                    await loadClauseLibrary();
                    renderClauseLibrary();
                    showSaveIndicator();
                }
            } catch (e) { console.error('deleteLibraryClause error:', e); }
        }

        // ── Submission Clauses (JSONB on submissions) ──

        function getSubmissionClauses() {
            if (!currentSubmission) return [];
            return currentSubmission.clauses || [];
        }

        async function saveSubmissionClauses(clauses) {
            if (!currentSubmission) return;
            currentSubmission.clauses = clauses;
            await updateSubmission(currentSubmission.id, { clauses: clauses });
            showSaveIndicator();
        }

        async function addClauseToSubmission(clauseIdx) {
            var lib = clauseLibrary[clauseIdx];
            if (!lib) return;
            var clauses = getSubmissionClauses().slice();
            // Avoid duplicate by id
            if (clauses.some(function(c) { return c.clause_id === lib.id; })) return;
            clauses.push({
                clause_id: lib.id,
                title: lib.title,
                content: lib.content_fr,
                content_en: lib.content_en || '',
                sort_order: clauses.length
            });
            await saveSubmissionClauses(clauses);
            renderPreview();
        }

        async function removeClauseFromSubmission(idx) {
            var clauses = getSubmissionClauses().slice();
            clauses.splice(idx, 1);
            // Re-index sort_order
            clauses.forEach(function(c, i) { c.sort_order = i; });
            await saveSubmissionClauses(clauses);
            renderPreview();
        }

        async function updateClauseText(idx, newText) {
            var clauses = getSubmissionClauses().slice();
            if (clauses[idx]) {
                clauses[idx].content = newText;
                await saveSubmissionClauses(clauses);
            }
        }

        async function updateClauseTextEN(idx, newText) {
            var clauses = getSubmissionClauses().slice();
            if (clauses[idx]) {
                clauses[idx].content_en = newText;
                await saveSubmissionClauses(clauses);
            }
        }

        async function saveClauseBackToLibrary(idx) {
            var clauses = getSubmissionClauses();
            var c = clauses[idx];
            if (!c) return;

            // If came from library, update it; otherwise create new
            if (c.clause_id) {
                var existing = clauseLibrary.find(function(lib) { return lib.id === c.clause_id; });
                if (existing) {
                    await authenticatedFetch(SUPABASE_URL + '/rest/v1/quote_clauses?id=eq.' + c.clause_id, {
                        method: 'PATCH', headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                        body: JSON.stringify({ title: c.title, content_fr: c.content, content_en: c.content_en || '' })
                    });
                    await loadClauseLibrary();
                    renderClauseLibrary();
                    showSaveIndicator();
                    return;
                }
            }

            // Create new in library
            await authenticatedFetch(SUPABASE_URL + '/rest/v1/quote_clauses', {
                method: 'POST', headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                body: JSON.stringify({ title: c.title, content_fr: c.content, content_en: c.content_en || '' })
            });
            await loadClauseLibrary();
            renderClauseLibrary();
            showSaveIndicator();
        }

        // ── Drag and Drop ──

        var draggedClauseIdx = null;

        function onClauseDragStart(e, idx) {
            draggedClauseIdx = idx;
            e.dataTransfer.effectAllowed = 'copy';
            e.dataTransfer.setData('text/plain', idx.toString());
            e.target.classList.add('dragging');
            setTimeout(function() { e.target.classList.remove('dragging'); }, 200);
        }

        function onClauseDropZoneDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
            e.currentTarget.classList.add('drag-over');
        }

        function onClauseDropZoneDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function onClauseDropZoneDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            var idx = parseInt(e.dataTransfer.getData('text/plain'), 10);
            if (!isNaN(idx)) addClauseToSubmission(idx);
            draggedClauseIdx = null;
        }

        // ── Render Preview ──

        async function loadAcceptanceProof(submissionId) {
            if (!currentSubmission) return null;
            var s = currentSubmission.status;
            if (s !== 'accepted' && s !== 'invoiced') return null;

            try {
                // Essayer acceptation en ligne (public_quote_tokens)
                var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/public_quote_tokens?submission_id=eq.' + submissionId + '&select=accepted_at,accepted_by_name,accepted_by_email,accepted_from_ip,signature_data');
                if (r.ok) {
                    var tokens = await r.json();
                    var accepted = tokens.find(function(t) { return t.accepted_at; });
                    if (accepted) return Object.assign({ method: 'online' }, accepted);
                }

                // Essayer acceptation hors-ligne via submission_reviews
                var r2 = await authenticatedFetch(SUPABASE_URL + '/rest/v1/submission_reviews?submission_id=eq.' + submissionId + '&action=eq.offline_accepted&order=created_at.desc&limit=1&select=comment,created_at');
                if (r2.ok) {
                    var reviews = await r2.json();
                    if (reviews.length > 0) return { method: 'offline', comment: reviews[0].comment, created_at: reviews[0].created_at };
                }
            } catch (e) {
                console.error('Erreur chargement preuve acceptation:', e);
            }
            return null;
        }

        async function renderPreview() {
            var container = document.getElementById('pvContent');
            var subLabel = document.getElementById('pvSubNumber');
            if (!container) return;

            if (subLabel && currentSubmission) {
                subLabel.textContent = t('soumission') + ' #' + (currentSubmission.submission_number || '');
            }

            var html = '';
            var editable = currentSubmission && (currentSubmission.status === 'draft' || currentSubmission.status === 'returned');

            // ── Load acceptance proof ──
            var acceptanceProofHtml = '';
            if (currentSubmission) {
                var proof = await loadAcceptanceProof(currentSubmission.id);
                if (proof) {
                    acceptanceProofHtml += '<div style="position:absolute;top:10px;left:20px;background:#e8f5e9;border:1px solid var(--stele-green);border-radius:8px;padding:12px 16px;max-width:320px;font-size:11px;line-height:1.6;z-index:1;">';
                    acceptanceProofHtml += '<div style="font-weight:700;font-size:13px;color:var(--stele-green);margin-bottom:6px;">Soumission accept\u00e9e</div>';
                    if (proof.method === 'online') {
                        acceptanceProofHtml += '<div><strong>M\u00e9thode :</strong> Signature en ligne</div>';
                        if (proof.accepted_by_name) acceptanceProofHtml += '<div><strong>Nom :</strong> ' + escapeHtml(proof.accepted_by_name) + '</div>';
                        if (proof.accepted_by_email) acceptanceProofHtml += '<div><strong>Courriel :</strong> ' + escapeHtml(proof.accepted_by_email) + '</div>';
                        if (proof.accepted_at) acceptanceProofHtml += '<div><strong>Date :</strong> ' + new Date(proof.accepted_at).toLocaleString('fr-CA') + '</div>';
                        if (proof.accepted_from_ip) acceptanceProofHtml += '<div><strong>IP :</strong> ' + escapeHtml(proof.accepted_from_ip) + '</div>';
                        if (proof.signature_data) acceptanceProofHtml += '<div style="margin-top:8px;"><img src="' + proof.signature_data + '" style="max-width:200px;border:1px solid #ccc;border-radius:4px;" alt="Signature"></div>';
                    } else {
                        acceptanceProofHtml += '<div><strong>M\u00e9thode :</strong> Hors-ligne</div>';
                        if (proof.comment) acceptanceProofHtml += '<div style="margin-top:2px;color:#555;">' + escapeHtml(proof.comment) + '</div>';
                        if (proof.created_at) acceptanceProofHtml += '<div><strong>Date :</strong> ' + new Date(proof.created_at).toLocaleString('fr-CA') + '</div>';
                    }
                    acceptanceProofHtml += '</div>';
                }
            }

            // ── Page 1: Title ──
            var subNum = currentSubmission ? currentSubmission.submission_number : '';
            var subDate = '';
            if (currentSubmission) {
                var d = currentSubmission.sent_at || currentSubmission.approved_at || currentSubmission.created_at;
                if (d) {
                    var dt = new Date(d);
                    var loc = currentLang === 'en' ? 'en-CA' : 'fr-CA';
                    subDate = dt.toLocaleDateString(loc, { year: 'numeric', month: 'long', day: 'numeric' });
                }
            }
            html += '<div class="pv-page pv-page-title">';
            html += acceptanceProofHtml;
            html += '<img class="pv-logo" src="https://rplzbtjfnwahqodrhpny.supabase.co/storage/v1/object/public/assets/stele_logo_noir.png" alt="Stele">';
            html += '<div class="pv-sub-number">' + t('soumission') + ' #' + escapeHtml(subNum + '') + '</div>';
            if (subDate) html += '<div class="pv-sub-date">' + escapeHtml(subDate) + '</div>';
            if (currentProject) {
                html += '<div class="pv-client-name">' + escapeHtml(currentProject.client_name || '') + '</div>';
                if (currentProject.client_address) html += '<div class="pv-client-address">' + escapeHtml(currentProject.client_address) + '</div>';
                html += '<div class="pv-project-name">' + escapeHtml(currentProject.name || '') + '</div>';
                if (currentProject.designer) html += '<div class="pv-designer">' + t('designer') + ' : ' + escapeHtml(currentProject.designer) + '</div>';
            }
            html += '</div>';

            // ── Room pages (one per room) — text left, images right ──
            var grandTotal = 0;
            var groups = document.querySelectorAll('#calculatorView .furniture-group');
            groups.forEach(function(group) {
                var groupId = group.id;
                var nameInput = group.querySelector('.furniture-name-input');
                var roomName = nameInput ? nameInput.value : 'Sans nom';

                var subtotal = 0;
                group.querySelectorAll('.calc-row').forEach(function(row) {
                    subtotal += getRowTotal(row);
                });
                grandTotal += subtotal;

                var allImgs = groupImages[groupId] || [];
                var imgs = allImgs.filter(function(img) { return img.showInQuote; });
                var descEl = document.getElementById(groupId + '-clientDesc');
                var descPlain = descEl ? descEl.value : '';
                var descFr = roomDescHTML[groupId] || descPlain;
                var descEn = roomDescEN[groupId] || '';
                var desc = currentLang === 'en' ? (descEn || descFr) : descFr;
                var hasImages = imgs.length > 0;

                html += '<div class="pv-page" data-group-id="' + escapeAttr(groupId) + '">';
                html += '<div class="pv-page-room-header"><span class="pv-page-room-name">' + escapeHtml(roomName) + '</span><span class="pv-page-room-subtotal">' + formatPrice(subtotal) + '</span></div>';
                html += '<div class="pv-page-room-body">';

                // Left column: description
                if (hasImages) {
                    html += '<div class="pv-page-room-text" style="position:relative;">';
                    if (editable && currentLang === 'fr') {
                        html += '<button class="pv-optimize-btn" onclick="optimizeText(this)" data-group-id="' + escapeAttr(groupId) + '">&#10024;</button>';
                    }
                    html += '<div class="pv-page-room-desc" data-group-id="' + escapeAttr(groupId) + '"';
                    html += ' data-placeholder="' + escapeAttr(t('descPlaceholder')) + '"';
                    html += ' contenteditable="' + (editable ? 'true' : 'false') + '">';
                    html += textToHtml(desc);
                    html += '</div>';
                    html += '</div>';

                    // Right column: images
                    var imgCount = Math.min(imgs.length, 4);
                    html += '<div class="pv-page-room-media imgs-' + imgCount + '">';
                    imgs.forEach(function(img) {
                        var realIdx = allImgs.indexOf(img);
                        var imgSrc = img.isLegacy ? img.dataUrl : (img.url || img.dataUrl);
                        var ratio = img.cropRatio === '1:1' ? '1/1' : img.cropRatio === '9:16' ? '9/16' : '16/9';
                        html += '<div class="pv-img-wrap">';
                        html += '<img src="' + imgSrc + '" alt="' + escapeAttr(img.name) + '" style="aspect-ratio:' + ratio + ';" onclick="openLightbox(this.src)">';
                        if (editable && !clientViewMode) {
                            html += '<button class="pv-img-delete" onclick="removePreviewImage(\'' + escapeAttr(groupId) + '\', ' + realIdx + ')" title="Supprimer">&times;</button>';
                        }
                        html += '</div>';
                    });
                    html += '</div>';
                } else {
                    // No images — description takes full width
                    html += '<div class="pv-page-room-text" style="flex:1; position:relative;">';
                    if (editable && currentLang === 'fr') {
                        html += '<button class="pv-optimize-btn" onclick="optimizeText(this)" data-group-id="' + escapeAttr(groupId) + '">&#10024;</button>';
                    }
                    html += '<div class="pv-page-room-desc" data-group-id="' + escapeAttr(groupId) + '"';
                    html += ' data-placeholder="' + escapeAttr(t('descPlaceholder')) + '"';
                    html += ' contenteditable="' + (editable ? 'true' : 'false') + '">';
                    html += textToHtml(desc);
                    html += '</div>';
                    html += '</div>';
                }

                html += '</div></div>';
            });

            // ── Clauses page (compact) ──
            var subClauses = getSubmissionClauses();
            if (subClauses.length > 0 || editable) {
                html += '<div class="pv-page">';
                html += '<div class="pv-page-clauses-header">' + t('clausesTitle') + '</div>';
                html += '<div class="pv-page-clauses-body">';

                subClauses.forEach(function(clause, idx) {
                    html += '<div class="pv-page-clause" data-clause-idx="' + idx + '">';
                    html += '<div class="pv-page-clause-title">' + escapeHtml(clause.title) + '</div>';
                    var clauseText = currentLang === 'en' ? (clause.content_en || clause.content || '') : (clause.content || '');
                    html += '<textarea class="pv-page-clause-text" data-clause-idx="' + idx + '"';
                    html += ' rows="2"' + (editable ? '' : ' disabled') + '>' + escapeHtml(clauseText) + '</textarea>';
                    if (editable) {
                        html += '<div class="pv-page-clause-actions">';
                        html += '<button class="pv-doc-clause-btn save-lib" onclick="saveClauseBackToLibrary(' + idx + ')" title="Sauvegarder dans la biblioth\u00e8que">' + t('biblio') + '</button>';
                        html += '<button class="pv-doc-clause-btn remove" onclick="removeClauseFromSubmission(' + idx + ')" title="Retirer">\u2715</button>';
                        html += '</div>';
                    }
                    html += '</div>';
                });

                if (editable) {
                    html += '<div class="pv-clause-dropzone" id="pvClauseDropZone"';
                    html += ' ondragover="onClauseDropZoneDragOver(event)"';
                    html += ' ondragleave="onClauseDropZoneDragLeave(event)"';
                    html += ' ondrop="onClauseDropZoneDrop(event)">';
                    html += t('dropClause');
                    html += '</div>';
                }

                html += '</div></div>';
            }

            // ── Total page (last) ──
            html += '<div class="pv-page pv-page-total">';
            html += '<div class="pv-total-box">';
            html += '<div class="total-label">' + t('total') + '</div>';
            html += '<div class="total-amount">' + formatPrice(grandTotal) + '</div>';
            html += '<div class="total-taxes">' + t('taxes') + '</div>';
            html += '</div>';
            html += '<div class="pv-page-footer-text">' + t('footer') + '</div>';
            html += '</div>';

            // ── Steps page ──
            var steps = t('steps');
            if (steps && Array.isArray(steps)) {
                // Gradient from dark green to light green
                var stepColors = ['#2f3e34','#3a4b3f','#45584a','#4b6050','#5e7462','#718874','#849c86','#97b098'];
                html += '<div class="pv-page pv-page-steps">';
                html += '<div class="pv-steps-title">' + escapeHtml(t('stepsTitle')) + '</div>';
                html += '<div class="pv-steps-grid">';
                steps.forEach(function(step, i) {
                    html += '<div class="pv-step">';
                    html += '<div class="pv-step-circle" style="background:' + stepColors[i] + '">' + (i + 1) + '</div>';
                    html += '<div class="pv-step-content">';
                    html += '<div class="pv-step-label">' + escapeHtml(step.label) + '</div>';
                    html += '<div class="pv-step-desc">' + escapeHtml(step.desc) + '</div>';
                    html += '</div></div>';
                });
                html += '</div></div>';
            }

            // (acceptance proof is on the title page)

            container.innerHTML = html;
            wirePreviewSaveHandlers();
        }

        function wirePreviewSaveHandlers() {
            // Room descriptions — save HTML to correct lang field + stale detection
            document.querySelectorAll('#pvContent .pv-page-room-desc').forEach(function(el) {
                el.addEventListener('blur', function() {
                    var gid = this.getAttribute('data-group-id');
                    if (!gid || !roomMap[gid]) return;
                    var htmlContent = this.innerHTML.trim();
                    if (currentLang === 'en') {
                        roomDescEN[gid] = htmlContent;
                        updateRoom(roomMap[gid], { client_description_en: htmlContent });
                    } else {
                        roomDescHTML[gid] = htmlContent;
                        updateRoom(roomMap[gid], { client_description: htmlContent });
                        var calcDesc = document.getElementById(gid + '-clientDesc');
                        if (calcDesc) calcDesc.value = this.textContent; // plain text for calc textarea
                        // Stale detection: FR changed → clear EN
                        if (roomDescEN[gid]) {
                            roomDescEN[gid] = '';
                            updateRoom(roomMap[gid], { client_description_en: '' });
                        }
                    }
                    showSaveIndicator();
                });
            });

            // Auto-resize clause textareas to fit content
            document.querySelectorAll('#pvContent .pv-page-clause-text').forEach(function(ta) {
                ta.style.height = 'auto';
                ta.style.height = ta.scrollHeight + 'px';
                ta.addEventListener('input', function() { this.style.height = 'auto'; this.style.height = this.scrollHeight + 'px'; });
            });

            // Clause texts — save to correct lang field + stale detection
            document.querySelectorAll('#pvContent .pv-page-clause-text').forEach(function(textarea) {
                textarea.addEventListener('blur', function() {
                    var idx = parseInt(this.getAttribute('data-clause-idx'), 10);
                    if (isNaN(idx)) return;
                    if (currentLang === 'en') {
                        updateClauseTextEN(idx, this.value);
                    } else {
                        updateClauseText(idx, this.value);
                        // Stale detection: FR changed → clear EN
                        var clauses = getSubmissionClauses();
                        if (clauses[idx] && clauses[idx].content_en) {
                            clauses[idx].content_en = '';
                            saveSubmissionClauses(clauses);
                        }
                    }
                });
            });
        }

        // ═══════════════════════════════════════════════════════════════════════
        // MODE PRÉSENTATION (PLEIN ÉCRAN + NAVIGATION PAR PAGE)
        // ═══════════════════════════════════════════════════════════════════════

        var presActive = false;

        function openPresentation() {
            presActive = true;
            // Force client view + render
            clientViewMode = true;
            var pv = document.getElementById('previewView');
            pv.classList.add('pv-client-mode');
            pv.classList.add('pv-fullscreen');
            renderPreview();

            // Scroll to top in fullscreen mode (pv-left is the scrolling element)
            var scrollEl = document.querySelector('#previewView .pv-left');
            if (scrollEl) scrollEl.scrollTop = 0;

            // Request fullscreen on the preview view
            if (pv.requestFullscreen) pv.requestFullscreen();
            else if (pv.webkitRequestFullscreen) pv.webkitRequestFullscreen();
            else if (pv.msRequestFullscreen) pv.msRequestFullscreen();

            document.addEventListener('keydown', presPageNav);
            document.getElementById('pvContent').addEventListener('click', presClickNav);
        }

        function closePresentation() {
            presActive = false;
            var pv = document.getElementById('previewView');
            pv.classList.remove('pv-fullscreen');
            pv.classList.remove('pv-client-mode');
            clientViewMode = false;
            if (document.fullscreenElement) document.exitFullscreen();
            else if (document.webkitFullscreenElement) document.webkitExitFullscreen();
            document.removeEventListener('keydown', presPageNav);
            var pvContent = document.getElementById('pvContent');
            if (pvContent) pvContent.removeEventListener('click', presClickNav);
            renderPreview();
        }

        function presPageNav(e) {
            if (e.key === 'Escape') { closePresentation(); return; }
            var scrollEl = document.querySelector('#previewView .pv-left');
            if (!scrollEl) return;
            var pages = scrollEl.querySelectorAll('.pv-page');
            if (pages.length === 0) return;

            if (e.key === 'ArrowDown' || e.key === 'Enter' || e.key === ' ' || e.key === 'ArrowRight') {
                e.preventDefault();
                presScrollToNext(scrollEl, pages, 1);
            }
            if (e.key === 'ArrowUp' || e.key === 'Backspace' || e.key === 'ArrowLeft') {
                e.preventDefault();
                presScrollToNext(scrollEl, pages, -1);
            }
        }

        function presClickNav(e) {
            // Don't navigate if clicking on interactive elements
            if (e.target.closest('textarea, button, a, input, .pv-img-wrap')) return;
            var scrollEl = document.querySelector('#previewView .pv-left');
            var pages = scrollEl ? scrollEl.querySelectorAll('.pv-page') : [];
            if (pages.length > 0) presScrollToNext(scrollEl, pages, 1);
        }

        function presScrollToNext(scrollEl, pages, direction) {
            var scrollTop = scrollEl.scrollTop;
            var threshold = 20;
            for (var i = 0; i < pages.length; i++) {
                var top = pages[i].offsetTop - scrollEl.offsetTop;
                if (direction > 0 && top > scrollTop + threshold) {
                    pages[i].scrollIntoView({ behavior: 'smooth', block: 'start' });
                    return;
                }
                if (direction < 0 && i > 0 && top >= scrollTop - threshold) {
                    pages[i - 1].scrollIntoView({ behavior: 'smooth', block: 'start' });
                    return;
                }
            }
            // Edge cases: last page forward or first page backward
            if (direction < 0) pages[0].scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Exit presentation when leaving fullscreen
        document.addEventListener('fullscreenchange', function() {
            if (!document.fullscreenElement && presActive) {
                closePresentation();
            }
        });

        // ═══════════════════════════════════════════════════════════════════════
        // NAVIGATION ENTRE VUES
        // ═══════════════════════════════════════════════════════════════════════

        function showProjectList() {
            document.getElementById('projectListView').classList.add('active');
            document.getElementById('calculatorView').classList.remove('active');
            document.getElementById('previewView').classList.remove('active');
            currentProject = null;
            currentSubmission = null;
            roomMap = {};
            itemMap = {};
            groupImages = {};
            roomDescEN = {};
            roomDescHTML = {};
            renderProjectList();
        }

        function showCalculator() {
            document.getElementById('projectListView').classList.remove('active');
            document.getElementById('calculatorView').classList.add('active');
            document.getElementById('previewView').classList.remove('active');
        }

        function backToProjectList() {
            if (isApprovalMode) {
                window.location.href = 'approbation.html';
                return;
            }
            showProjectList();
        }

        // ── Kebab menu ──
        function toggleHeaderKebab(e) {
            e.stopPropagation();
            var dropdown = document.getElementById('headerKebabDropdown');
            var btn = e.currentTarget;
            var isOpen = dropdown.classList.contains('open');
            dropdown.classList.toggle('open');
            btn.classList.toggle('active');
            if (!isOpen) {
                setTimeout(function() {
                    document.addEventListener('click', closeHeaderKebabOnOutside, { once: true });
                }, 0);
            }
        }
        function closeHeaderKebab() {
            var dd = document.getElementById('headerKebabDropdown');
            if (dd) dd.classList.remove('open');
            var btn = document.querySelector('.btn-kebab');
            if (btn) btn.classList.remove('active');
        }
        function closeHeaderKebabOnOutside(e) {
            if (!e.target.closest('.kebab-menu')) closeHeaderKebab();
        }

        function showSaveIndicator() {
            const el = document.getElementById('saveIndicator');
            el.textContent = 'Sauvegardé ✓';
            el.className = 'save-indicator saving';
            clearTimeout(el._timeout);
            el._timeout = setTimeout(() => { el.textContent = ''; el.className = 'save-indicator'; }, 2000);
        }

        // ═══════════════════════════════════════════════════════════════════════
        // RENDU LISTE DE PROJETS
        // ═══════════════════════════════════════════════════════════════════════

        var STATUS_LABELS = {
            'draft': 'Brouillon', 'pending_internal': 'En approbation', 'returned': 'Retourn\u00e9e',
            'approved_internal': 'Pr\u00eate \u00e0 envoyer', 'sent_client': 'Envoy\u00e9e', 'accepted': 'Vendue',
            'invoiced': 'Factur\u00e9e',
            // Legacy
            'brouillon': 'Brouillon', 'soumis': 'Soumis', 'approuv\u00e9': 'Approuv\u00e9',
            'envoy\u00e9': 'Envoy\u00e9', 'sign\u00e9': 'Sign\u00e9'
        };

        function updateStatusBadge(status) {
            var badge = document.getElementById('subStatusBadge');
            if (!badge) return;
            var label = STATUS_LABELS[status] || status;
            badge.className = 'status-badge status-' + status;
            var locked = !isSubmissionCurrentlyEditable();
            var prefix = locked ? '\uD83D\uDD12 ' : '';
            if (currentSubmission && currentSubmission.bypass_approval) {
                badge.innerHTML = escapeHtml(prefix + label) + ' <span class="bypass-badge">BYPASS</span>';
            } else {
                badge.textContent = prefix + label;
            }
        }

        function updateStatusTimeline() {
            var container = document.getElementById('statusTimeline');
            if (!container || !currentSubmission) {
                if (container) container.innerHTML = '';
                return;
            }

            var status = currentSubmission.status;
            // invoiced is treated same as accepted for timeline
            if (status === 'invoiced') status = 'accepted';

            // Define 6 timeline steps
            var steps = [
                { key: 'draft', label: 'Brouillon' },
                { key: 'pending_internal', label: 'En approbation' },
                { key: 'returned', label: 'Retourn\u00e9e' },
                { key: 'approved_internal', label: 'Pr\u00eate \u00e0 envoyer' },
                { key: 'sent_client', label: 'Envoy\u00e9e' },
                { key: 'accepted', label: 'Vendue' }
            ];

            // Determine step state for each step
            function getStepState(stepKey) {
                if (stepKey === status) return 'active';

                // Special: "returned" is only active when status is returned, otherwise always future
                if (stepKey === 'returned') {
                    return (status === 'returned') ? 'active' : 'future';
                }

                // Linear progression for other steps
                switch (status) {
                    case 'draft':
                        return 'future';
                    case 'pending_internal':
                        return (stepKey === 'draft') ? 'completed' : 'future';
                    case 'returned':
                        return (stepKey === 'draft' || stepKey === 'pending_internal') ? 'completed' : 'future';
                    case 'approved_internal':
                        return (stepKey === 'draft' || stepKey === 'pending_internal') ? 'completed' : 'future';
                    case 'sent_client':
                        return (stepKey === 'draft' || stepKey === 'pending_internal' || stepKey === 'approved_internal') ? 'completed' : 'future';
                    case 'accepted':
                        return (stepKey === 'draft' || stepKey === 'pending_internal' || stepKey === 'approved_internal' || stepKey === 'sent_client') ? 'completed' : 'future';
                    default:
                        return 'future';
                }
            }

            var html = '';
            steps.forEach(function(step) {
                var stepState = getStepState(step.key);
                var classNames = 'timeline-step ' + stepState;
                if (step.key === 'returned' && stepState === 'active') classNames += ' returned';

                // Rendre "Envoyée" cliquable pour copier le lien client
                var isClickable = (status === 'sent_client' && step.key === 'sent_client');
                if (isClickable) classNames += ' clickable';

                var onclick = isClickable ? ' onclick="copyQuoteLink()" title="Cliquer pour copier le lien client"' : '';

                html += '<div class="' + classNames + '"' + onclick + '>';
                html += '<div class="timeline-circle">';
                if (stepState === 'completed') {
                    html += '\u2713'; // checkmark
                } else {
                    html += '&nbsp;';
                }
                html += '</div>';
                html += '<span class="timeline-label">' + escapeHtml(step.label) + '</span>';
                html += '</div>';
            });

            // CTA button at the end
            var cta = null;
            if (status === 'draft' || status === 'returned') {
                cta = { text: status === 'returned' ? 'Resoumettre' : 'Soumettre', action: 'openSubmitModal()', className: status === 'returned' ? 'btn-orange' : '' };
            } else if (status === 'pending_internal' && (canApproveQuotes || isApprovalMode)) {
                cta = { text: 'Approuver', action: 'approveSubmission()', className: '' };
            } else if (status === 'approved_internal') {
                cta = { text: 'Envoyer au client', action: 'sendToClient()', className: '' };
            } else if (status === 'sent_client') {
                cta = { text: 'Confirmer la vente', action: 'offlineAcceptance()', className: '' };
            }

            if (cta) {
                html += '<div class="timeline-cta">';
                html += '<button onclick="' + cta.action + '" class="' + (cta.className || '') + '">' + escapeHtml(cta.text) + '</button>';
                html += '</div>';
            }

            container.innerHTML = html;
        }

        async function renderProjectList() {
            const grid = document.getElementById('projectGrid');
            const empty = document.getElementById('projectEmpty');
            grid.innerHTML = '';

            const projects = await loadProjects();

            if (projects.length === 0) {
                empty.style.display = 'block';
                return;
            }
            empty.style.display = 'none';

            projects.forEach(proj => {
                const card = document.createElement('div');
                card.className = 'project-card';

                const subs = proj.submissions || [];
                const subCount = subs.length;

                var subsHtml = '';
                subs.forEach(function(sub) {
                    var label = STATUS_LABELS[sub.status] || sub.status || 'Brouillon';
                    subsHtml += '<div class="sub-line" data-subid="' + escapeAttr(sub.id) + '" data-projid="' + escapeAttr(proj.id) + '">' +
                        '<span class="sub-number">#' + escapeHtml(String(sub.submission_number)) + '</span> ' +
                        '<span class="sub-title">' + escapeHtml(sub.title || 'Sans titre') + '</span>' +
                        '<span class="project-status-badge status-' + escapeAttr(sub.status) + '">' + escapeHtml(label) + (sub.bypass_approval ? ' <span class="bypass-badge">BYPASS</span>' : '') + '</span>' +
                        '</div>';
                });

                card.innerHTML =
                    '<button class="project-card-delete" onclick="handleDeleteProject(\'' + escapeAttr(proj.id) + '\', event)" title="Supprimer">&times;</button>' +
                    '<div class="project-card-name">' + escapeHtml(proj.name || 'Sans nom') + '</div>' +
                    '<div class="project-card-client">' + escapeHtml(proj.client_name || 'Aucun client') + '</div>' +
                    '<div class="project-subs">' + (subsHtml || '<div class="sub-empty">Aucune soumission</div>') + '</div>' +
                    '<button class="btn-add-sub" onclick="handleAddSubmission(\'' + escapeAttr(proj.id) + '\', event)">+ Nouvelle soumission</button>';

                // Click on a submission line → open it
                card.addEventListener('click', function(e) {
                    if (e.target.closest('.project-card-delete') || e.target.closest('.btn-add-sub')) return;
                    var subLine = e.target.closest('.sub-line');
                    if (subLine) {
                        var subId = subLine.getAttribute('data-subid');
                        openSubmission(subId);
                        return;
                    }
                    // Click on card header (project name) → open first submission
                    if (subs.length > 0) {
                        openSubmission(subs[0].id);
                    } else {
                        openProject(proj.id); // creates default submission
                    }
                });

                grid.appendChild(card);
            });
        }

        async function handleAddSubmission(projectId, event) {
            if (event) event.stopPropagation();
            var title = await stelePrompt('Titre de la nouvelle soumission :', 'Nouvelle soumission');
            if (title === null) return;
            try {
                var sub = await createSubmission(projectId, title || '');
                await openSubmission(sub.id);
            } catch (e) {
                console.error('Erreur cr\u00e9ation soumission:', e);
                steleAlert('Erreur lors de la cr\u00e9ation de la soumission.');
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // FORMULAIRE NOUVEAU PROJET
        // ═══════════════════════════════════════════════════════════════════════

        function showNewProjectForm() {
            document.getElementById('newProjectForm').classList.add('active');
            document.getElementById('newProjectName').focus();
        }

        function hideNewProjectForm() {
            document.getElementById('newProjectForm').classList.remove('active');
            document.getElementById('newProjectName').value = '';
        }

        async function handleCreateProject() {
            const nameInput = document.getElementById('newProjectName');
            const name = nameInput.value.trim();
            if (!name) { nameInput.focus(); return; }

            const btn = document.getElementById('btnCreateProject');
            btn.disabled = true;
            btn.textContent = 'Création...';

            try {
                const project = await createProject(name, '');
                hideNewProjectForm();
                await openProject(project.id);
            } catch (e) {
                console.error('Erreur création projet:', e);
                steleAlert('Erreur lors de la cr\u00e9ation du projet.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Créer';
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // OUVRIR / CHARGER UN PROJET
        // ═══════════════════════════════════════════════════════════════════════

        async function openSubmission(submissionId, project) {
            // Charger la soumission
            const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/submissions?id=eq.' + submissionId + '&select=*', {});
            if (!r.ok) return;
            const subData = await r.json();
            if (subData.length === 0) return;

            currentSubmission = subData[0];

            // Charger le projet parent si pas déjà fourni
            if (project) {
                currentProject = project;
            } else {
                const pr = await authenticatedFetch(SUPABASE_URL + '/rest/v1/projects?id=eq.' + currentSubmission.project_id + '&select=*', {});
                if (pr.ok) {
                    const pData = await pr.json();
                    if (pData.length > 0) currentProject = pData[0];
                }
            }

            roomMap = {};
            itemMap = {};
            groupImages = {};
            roomDescEN = {};
            roomDescHTML = {};

            // Remplir le header
            document.getElementById('projName').value = currentProject ? (currentProject.name || '') : '';
            document.getElementById('subTitle').value = currentSubmission.title || '';
            var exclEl = document.getElementById('exclusionsText');
            if (exclEl) exclEl.value = currentSubmission.exclusions || '';
            updateStatusBadge(currentSubmission.status || 'draft');
            document.getElementById('subNumber').textContent = '#' + currentSubmission.submission_number;
            document.getElementById('projInstallation').checked = true;

            // Vider le calculateur
            document.getElementById('furnitureGroups').innerHTML = '';

            // Charger les pièces et items via submission_id
            const rooms = await loadSubmissionRooms(submissionId);

            if (rooms.length === 0) {
                addFurnitureGroup('');
            } else {
                for (const room of rooms) {
                    const groupId = addFurnitureGroup(room.name, { existingId: room.id, skipSave: true });

                    if (room.installation_included === false) {
                        var installCb = document.getElementById(groupId + '-install');
                        if (installCb) installCb.checked = false;
                    }

                    if (room.client_description) {
                        var descEl = document.getElementById(groupId + '-clientDesc');
                        if (descEl) descEl.value = room.client_description;
                        roomDescHTML[groupId] = room.client_description;
                    }
                    if (room.client_description_en) {
                        roomDescEN[groupId] = room.client_description_en;
                    }

                    // Load legacy images from JSONB
                    if (room.images && Array.isArray(room.images) && room.images.length > 0) {
                        groupImages[groupId] = room.images.map(img => ({ name: img.name, dataUrl: img.dataUrl, showInQuote: !!img.showInQuote, isLegacy: true }));
                    }

                    // Load room_media from dedicated table
                    try {
                        var mediaResp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/room_media?room_id=eq.' + room.id + '&order=sort_order.asc', {});
                        if (mediaResp.ok) {
                            var mediaRows = await mediaResp.json();
                            if (mediaRows.length > 0) {
                                if (!groupImages[groupId]) groupImages[groupId] = [];
                                mediaRows.forEach(function(m) {
                                    groupImages[groupId].push({
                                        name: m.cropped_url.split('/').pop() || 'image.jpg',
                                        url: m.cropped_url,
                                        originalUrl: m.original_url,
                                        mediaId: m.id,
                                        tags: m.tags || ['presentation_soumission'],
                                        cropRatio: m.crop_ratio,
                                        isLegacy: false,
                                        showInQuote: (m.tags || []).includes('presentation_soumission')
                                    });
                                });
                            }
                        }
                    } catch (e) { console.error('Load room_media error:', e); }

                    if (groupImages[groupId] && groupImages[groupId].length > 0) {
                        renderGroupImagePreviews(groupId);
                    }

                    if (room.room_items && room.room_items.length > 0) {
                        room.room_items.forEach(item => {
                            const rowId = addRow(groupId, { existingId: item.id, skipSave: true, skipFocus: true });

                            const row = document.getElementById(rowId);
                            const select = row.querySelector('.item-select');
                            const qtyInput = row.querySelector('.qty-input');

                            qtyInput.value = item.quantity || 1;

                            if (item.installation_included === false) {
                                var rowInstCb = document.getElementById(rowId + '-install');
                                if (rowInstCb) rowInstCb.checked = false;
                            }

                            if (item.item_type === 'custom') {
                                select.value = '__AJOUT__';
                                transformToAjoutMode(row, rowId);
                                const descInput = document.getElementById(`${rowId}-desc`);
                                const priceInput = document.getElementById(`${rowId}-price`);
                                const markupInput = document.getElementById(`${rowId}-markup`);
                                if (descInput) descInput.value = item.description || '';
                                if (priceInput) priceInput.value = item.unit_price || 0;
                                if (markupInput) markupInput.value = item.markup || 0;
                            } else if (item.catalogue_item_id) {
                                select.value = item.catalogue_item_id;
                            }

                            updateRow(rowId);
                        });
                    }
                }
            }

            updateWorkflowButtons();
            loadSubmissionReviews(submissionId);
            var isEditable = isSubmissionCurrentlyEditable();
            setEditable(isEditable);
            showCalculator();
            if (isApprovalMode) {
                // Hide submission panel and project name edit in approval mode
                document.getElementById('headerSubPanel').style.display = 'none';
                document.getElementById('projName').readOnly = true;
                document.getElementById('btnBackProjects').innerHTML = '&larr; Approbations';
            } else {
                renderHeaderSubmissionList();
            }
        }

        // Panneau de soumissions dans le calculateur
        async function renderHeaderSubmissionList() {
            var panel = document.getElementById('headerSubPanel');
            var list = document.getElementById('headerSubList');
            if (!currentProject) { panel.style.display = 'none'; return; }

            var subs = await loadSubmissions(currentProject.id);
            var html = '';
            subs.forEach(function(sub) {
                var label = STATUS_LABELS[sub.status] || sub.status || 'Brouillon';
                var isActive = currentSubmission && currentSubmission.id === sub.id;
                html += '<div class="sub-line' + (isActive ? ' active' : '') + '" data-subid="' + escapeAttr(sub.id) + '">' +
                    '<span class="sub-number">#' + escapeHtml(String(sub.submission_number)) + '</span> ' +
                    '<span class="sub-title">' + escapeHtml(sub.title || 'Sans titre') + '</span>' +
                    '<span class="project-status-badge status-' + escapeAttr(sub.status) + '">' + escapeHtml(label) + (sub.bypass_approval ? ' <span class="bypass-badge">BYPASS</span>' : '') + '</span>' +
                    '<button class="sub-kebab" onclick="event.stopPropagation(); openSubmission(\'' + escapeAttr(sub.id) + '\')" title="Ouvrir">&middot;&middot;&middot;</button>' +
                    '</div>';
            });
            list.innerHTML = html || '<div class="sub-empty">Aucune soumission</div>';
            panel.style.display = 'block';

            list.querySelectorAll('.sub-line').forEach(function(el) {
                el.addEventListener('click', function() {
                    var subId = el.getAttribute('data-subid');
                    if (currentSubmission && currentSubmission.id === subId) return;
                    openSubmission(subId);
                });
            });
        }

        async function handleAddSubmissionFromCalc() {
            if (!currentProject) return;
            var title = await stelePrompt('Titre de la nouvelle soumission :', 'Nouvelle soumission');
            if (title === null) return;
            try {
                var sub = await createSubmission(currentProject.id, title || '');
                await openSubmission(sub.id);
            } catch (e) {
                console.error('Erreur cr\u00e9ation soumission:', e);
                steleAlert('Erreur lors de la cr\u00e9ation de la soumission.');
            }
        }

        // Legacy wrapper pour compatibilité — ouvre la première soumission du projet
        async function openProject(projectId) {
            const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/projects?id=eq.' + projectId + '&select=*,submissions(id,submission_number,title,status,updated_at)', {});
            if (!r.ok) return;
            const data = await r.json();
            if (data.length === 0) return;

            var project = data[0];
            var subs = project.submissions || [];
            if (subs.length === 0) {
                // Pas de soumission → en créer une
                var newSub = await createSubmission(projectId, project.name || 'Soumission initiale');
                await openSubmission(newSub.id, project);
            } else {
                // Ouvrir la plus récente
                subs.sort(function(a, b) { return (b.updated_at || '').localeCompare(a.updated_at || ''); });
                await openSubmission(subs[0].id, project);
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // SAUVEGARDER CHAMPS HEADER PROJET
        // ═══════════════════════════════════════════════════════════════════════

        function saveProjectField() {
            if (!currentProject) return;
            var name = document.getElementById('projName').value.trim();
            currentProject.name = name;
            updateProject(currentProject.id, { name: name });
            showSaveIndicator();
        }

        function saveSubmissionField() {
            if (!currentSubmission) return;
            var title = document.getElementById('subTitle').value.trim();
            currentSubmission.title = title;
            updateSubmission(currentSubmission.id, { title: title });
            showSaveIndicator();
        }

        // ═══════════════════════════════════════════════════════════════════════
        // VERROUILLAGE ÉDITION
        // ═══════════════════════════════════════════════════════════════════════

        function isSubmissionCurrentlyEditable() {
            if (!currentSubmission) return true;
            var s = currentSubmission.status;
            return s === 'draft' || s === 'returned' ||
                   (s === 'pending_internal' && (canApproveQuotes || isApprovalMode));
        }

        function setEditable(editable) {
            // Inputs et selects du calculateur
            var container = document.getElementById('calculatorView');
            if (!container) return;

            container.querySelectorAll('.item-select, .qty-input, .markup-input, .ajout-desc, .ajout-price, .ajout-markup, .client-desc-textarea').forEach(function(el) {
                el.disabled = !editable;
                el.style.opacity = editable ? '' : '0.6';
            });

            // Boutons ajouter meuble/ligne, supprimer
            container.querySelectorAll('.btn-add-group, .btn-add, .btn-remove, .btn-remove-group, .furniture-name-input').forEach(function(el) {
                if (el.tagName === 'BUTTON') {
                    el.disabled = !editable;
                    el.style.opacity = editable ? '' : '0.4';
                } else {
                    el.readOnly = !editable;
                    el.style.opacity = editable ? '' : '0.6';
                }
            });

            // Installation toggles
            container.querySelectorAll('input[type="checkbox"]').forEach(function(el) {
                el.disabled = !editable;
            });

            // Bouton "Soumettre pour approbation" en bas
            var btnOpenSubmit = document.getElementById('btnOpenSubmit');
            if (btnOpenSubmit) {
                btnOpenSubmit.disabled = !editable;
                btnOpenSubmit.style.opacity = editable ? '' : '0.4';
            }

            // Header fields
            var subTitle = document.getElementById('subTitle');
            if (subTitle) subTitle.readOnly = !editable;

            // Image drop zones + file inputs
            container.querySelectorAll('.drop-zone, .image-upload-input').forEach(function(el) {
                if (el.tagName === 'INPUT') {
                    el.disabled = !editable;
                }
                el.style.pointerEvents = editable ? '' : 'none';
                el.style.opacity = editable ? '' : '0.4';
            });

            // Bannière de statut
            var banner = document.getElementById('lockBanner');
            if (!editable && currentSubmission) {
                var label = STATUS_LABELS[currentSubmission.status] || currentSubmission.status;
                if (!banner) {
                    banner = document.createElement('div');
                    banner.id = 'lockBanner';
                    banner.style.cssText = 'background:#fff3e0; color:#e65100; padding:10px 16px; border-radius:6px; font-size:13px; font-weight:600; margin-bottom:12px; text-align:center;';
                    var calcContainer = document.querySelector('.calculator-container');
                    if (calcContainer) calcContainer.parentNode.insertBefore(banner, calcContainer);
                }
                banner.textContent = 'Soumission verrouill\u00e9e \u2014 Statut : ' + label;
                banner.style.display = '';
            } else if (banner) {
                banner.style.display = 'none';
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // HISTORIQUE DES VERSIONS
        // ═══════════════════════════════════════════════════════════════════════

        async function openVersionDrawer() {
            var drawer = document.getElementById('versionDrawer');
            drawer.style.display = 'flex';
            var list = document.getElementById('versionList');
            list.innerHTML = '<div style="text-align:center;padding:20px;color:#999;">Chargement...</div>';
            if (!currentSubmission) { list.innerHTML = '<p style="text-align:center;color:#999;">Aucune soumission</p>'; return; }

            try {
                var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/project_versions?submission_id=eq.' + currentSubmission.id + '&order=version_number.desc&select=id,version_number,status_at_save,created_at,created_by', {});
                if (!r.ok) throw new Error(r.status);
                var versions = await r.json();

                if (versions.length === 0) {
                    list.innerHTML = '<p style="text-align:center;color:#999;padding:20px;">Aucune version enregistr\u00e9e</p>';
                    return;
                }

                list.innerHTML = versions.map(function(v) {
                    var label = STATUS_LABELS[v.status_at_save] || v.status_at_save;
                    var date = new Date(v.created_at).toLocaleString('fr-CA');
                    return '<div class="version-card" onclick="viewVersion(\'' + v.id + '\')">' +
                        '<div style="font-weight:600;">Version ' + v.version_number + '</div>' +
                        '<div style="font-size:12px;color:#666;">' + date + ' \u2014 ' + label + '</div></div>';
                }).join('');
            } catch (e) {
                console.error('Erreur chargement versions:', e);
                list.innerHTML = '<p style="text-align:center;color:#c62828;">Erreur chargement</p>';
            }
        }

        function closeVersionDrawer() {
            document.getElementById('versionDrawer').style.display = 'none';
        }

        async function viewVersion(versionId) {
            try {
                var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/project_versions?id=eq.' + versionId + '&select=snapshot,version_number,status_at_save,created_at', {});
                if (!r.ok) return;
                var data = (await r.json())[0];
                if (!data) return;
                renderVersionSnapshot(data);
            } catch (e) {
                console.error('Erreur affichage version:', e);
            }
        }

        function renderVersionSnapshot(data) {
            var snap = data.snapshot;
            if (!snap) { steleAlert('Snapshot vide'); return; }
            var overlay = document.createElement('div');
            overlay.className = 'version-snapshot-overlay';
            overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };

            var html = '<div style="max-width:900px;margin:auto;background:#fff;border-radius:12px;padding:32px;">';
            html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">';
            html += '<h2 style="margin:0;">Version ' + data.version_number + ' \u2014 ' + (STATUS_LABELS[data.status_at_save] || data.status_at_save) + '</h2>';
            html += '<button onclick="this.closest(\'.version-snapshot-overlay\').remove()" style="font-size:24px;background:none;border:none;cursor:pointer;color:#666;">&times;</button></div>';

            // Infos projet/client si disponibles
            if (snap.projectName || snap.clientName) {
                html += '<div style="margin-bottom:16px;padding:12px;background:#f5f5f5;border-radius:8px;font-size:13px;">';
                if (snap.projectName) html += '<div><strong>Projet :</strong> ' + escapeHtml(snap.projectName) + '</div>';
                if (snap.clientName) html += '<div><strong>Client :</strong> ' + escapeHtml(snap.clientName) + '</div>';
                if (snap.designer) html += '<div><strong>Designer :</strong> ' + escapeHtml(snap.designer) + '</div>';
                html += '</div>';
            }

            // Render chaque meuble
            (snap.meubles || []).forEach(function(m) {
                html += '<div style="border:1px solid #e0e0e0;border-radius:8px;margin-bottom:16px;overflow:hidden;">';
                html += '<div style="background:var(--stele-green);color:#fff;padding:10px 16px;font-weight:600;">' + escapeHtml(m.name) + ' \u2014 ' + m.subtotal + ' $</div>';
                html += '<table style="width:100%;border-collapse:collapse;font-size:13px;">';
                html += '<thead><tr style="background:#f5f5f5;"><th style="padding:6px 12px;text-align:left;">Description</th><th style="padding:6px;text-align:right;">Qt\u00e9</th><th style="padding:6px;text-align:right;">Prix unit.</th><th style="padding:6px;text-align:right;">Total</th></tr></thead>';
                (m.items || []).forEach(function(it) {
                    html += '<tr style="border-bottom:1px solid #f0f0f0;"><td style="padding:6px 12px;">' + escapeHtml(it.description) + '</td>';
                    html += '<td style="padding:6px;text-align:right;">' + it.qty + '</td>';
                    html += '<td style="padding:6px;text-align:right;">' + it.unitPrice + ' $</td>';
                    html += '<td style="padding:6px;text-align:right;font-weight:600;">' + it.lineTotal + ' $</td></tr>';
                });
                html += '</table>';
                if (m.clientDescription) {
                    html += '<div style="padding:10px 16px;border-top:1px solid #e0e0e0;font-size:13px;color:#555;"><strong>Description client :</strong> ' + escapeHtml(m.clientDescription).replace(/\n/g, '<br>') + '</div>';
                }
                html += '</div>';
            });

            html += '<div style="text-align:right;font-size:20px;font-weight:700;margin-top:16px;">Total : ' + snap.total + ' $</div>';
            html += '</div>';
            overlay.innerHTML = html;
            document.body.appendChild(overlay);
        }

        // ═══════════════════════════════════════════════════════════════════════
        // DUPLICATION DE SOUMISSION
        // ═══════════════════════════════════════════════════════════════════════

        async function duplicateSubmission() {
            if (!currentSubmission) return;
            if (!(await steleConfirm('Dupliquer cette soumission en nouveau brouillon ?\nLes pi\u00e8ces, articles et images seront copi\u00e9s.', 'Dupliquer la soumission', 'Dupliquer'))) return;
            try {
                var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/rpc/duplicate_submission', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ p_submission_id: currentSubmission.id })
                });
                if (!r.ok) throw new Error('Erreur duplication: ' + r.status);
                var newSubId = await r.json();

                await createSubmissionReview(currentSubmission.id, 'duplicated', 'Soumission dupliqu\u00e9e \u2192 nouveau brouillon');
                steleAlert('Soumission dupliqu\u00e9e avec succ\u00e8s!');
                openSubmission(newSubId);
            } catch (e) {
                console.error('Erreur duplication:', e);
                steleAlert('Erreur: ' + e.message);
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // DÉVERROUILLAGE D'URGENCE
        // ═══════════════════════════════════════════════════════════════════════

        function unlockSubmission() {
            if (!currentSubmission || !canUnlockSubmission) return;
            document.getElementById('unlockUserName').value = '';
            document.getElementById('unlockReason').value = '';
            document.getElementById('unlockConfirmCheck').checked = false;
            document.getElementById('unlockStatus').style.display = 'none';
            document.getElementById('btnUnlockConfirm').disabled = false;
            document.getElementById('unlockModal').classList.add('active');
        }

        function closeUnlockModal() {
            document.getElementById('unlockModal').classList.remove('active');
        }

        function showUnlockStatus(msg, isError) {
            var el = document.getElementById('unlockStatus');
            el.style.display = 'block';
            el.textContent = msg;
            el.style.background = isError ? '#ffebee' : '#e8f5e9';
            el.style.color = isError ? '#c62828' : '#2e7d32';
        }

        async function executeUnlock() {
            var userName = document.getElementById('unlockUserName').value.trim();
            var reason = document.getElementById('unlockReason').value.trim();

            if (!userName) { showUnlockStatus('Le nom est obligatoire.', true); return; }
            if (!reason) { showUnlockStatus('La raison est obligatoire.', true); return; }
            if (!document.getElementById('unlockConfirmCheck').checked) {
                showUnlockStatus('Vous devez cocher la case de confirmation.', true);
                return;
            }

            var btn = document.getElementById('btnUnlockConfirm');
            btn.disabled = true;
            showUnlockStatus('D\u00e9verrouillage en cours...', false);

            try {
                // 1. Snapshot avant d\u00e9verrouillage
                await createVersion(currentSubmission.id);

                // 2. Log immuable via RPC (IP captur\u00e9e c\u00f4t\u00e9 serveur)
                var rpcResp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/rpc/log_submission_unlock', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        p_submission_id: currentSubmission.id,
                        p_user_name: userName,
                        p_reason: reason,
                        p_previous_status: currentSubmission.status
                    })
                });
                if (!rpcResp.ok) throw new Error('Erreur journalisation: ' + rpcResp.status);

                // 3. Remettre en brouillon
                await updateSubmission(currentSubmission.id, { status: 'draft' });

                // 4. Timeline
                await createSubmissionReview(currentSubmission.id, 'unlocked',
                    'D\u00c9VERROUILLAGE par ' + userName + ' \u2014 Raison: ' + reason);

                // 5. UI
                currentSubmission.status = 'draft';
                updateStatusBadge('draft');
                updateWorkflowButtons();
                setEditable(true);
                loadSubmissionReviews(currentSubmission.id);

                showUnlockStatus('Soumission d\u00e9verrouill\u00e9e!', false);
                setTimeout(function() { closeUnlockModal(); }, 1000);
            } catch (e) {
                console.error('Erreur d\u00e9verrouillage:', e);
                showUnlockStatus('Erreur: ' + e.message, true);
                btn.disabled = false;
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // WORKFLOW : SOUMETTRE / APPROUVER / RETOURNER
        // ═══════════════════════════════════════════════════════════════════════

        function updateWorkflowButtons() {
            var btnSubmit = document.getElementById('btnWfSubmit');
            var btnApprove = document.getElementById('btnWfApprove');
            var btnReturn = document.getElementById('btnWfReturn');
            var btnSendClient = document.getElementById('btnWfSendClient');
            var btnBypass = document.getElementById('btnWfBypass');
            var btnAcceptOffline = document.getElementById('btnWfAcceptOffline');
            var btnInvoiced = document.getElementById('btnWfInvoiced');

            // Hide all main action buttons
            btnSubmit.style.display = 'none';
            btnApprove.style.display = 'none';
            btnReturn.style.display = 'none';
            if (btnSendClient) { btnSendClient.style.display = 'none'; btnSendClient.textContent = 'Envoyer au client'; btnSendClient.onclick = function() { sendToClient(); }; }
            if (btnBypass) btnBypass.style.display = 'none';
            if (btnAcceptOffline) btnAcceptOffline.style.display = 'none';
            if (btnInvoiced) btnInvoiced.style.display = 'none';

            if (!currentSubmission) return;

            var s = currentSubmission.status;
            if (s === 'draft' || s === 'returned') {
                btnSubmit.style.display = 'inline-block';
                btnSubmit.textContent = 'Soumettre';
                if (canBypassApproval && btnBypass) {
                    btnBypass.style.display = 'inline-block';
                }
            }
            if (s === 'pending_internal' && (canApproveQuotes || isApprovalMode)) {
                btnApprove.style.display = 'inline-block';
                btnReturn.style.display = 'inline-block';
            }
            if (s === 'approved_internal' && btnSendClient) {
                btnSendClient.style.display = 'inline-block';
            }
            if (s === 'sent_client') {
                if (btnSendClient) {
                    btnSendClient.style.display = 'inline-block';
                    btnSendClient.textContent = 'Copier le lien';
                    btnSendClient.onclick = function() { copyQuoteLink(); };
                }
                if (btnAcceptOffline) btnAcceptOffline.style.display = 'inline-block';
            }
            if (s === 'accepted') {
                if (btnInvoiced) btnInvoiced.style.display = 'inline-block';
            }

            // Kebab: Déverrouiller — visible pour statuts verrouillés si permission
            var kebabUnlock = document.getElementById('kebabUnlock');
            if (kebabUnlock) {
                kebabUnlock.style.display = 'none';
                if (canUnlockSubmission) {
                    var lockedStatuses = ['pending_internal','approved_internal','sent_client','accepted','invoiced'];
                    if (lockedStatuses.includes(s)) kebabUnlock.style.display = '';
                }
            }

            // Update header total
            updateHeaderTotal();
            updateStatusTimeline();
        }

        // submitForApproval() redirigé vers le modal
        function submitForApproval() { openSubmitModal(); }

        // ═══════════════════════════════════════════════════════════════════════
        // ENVOI AU CLIENT — LIEN PUBLIC
        // ═══════════════════════════════════════════════════════════════════════

        async function sendToClient() {
            if (!currentSubmission) return;
            if (currentSubmission.status !== 'approved_internal') {
                steleAlert('La soumission doit \u00eatre approuv\u00e9e avant l\'envoi au client.');
                return;
            }
            if (!(await steleConfirm('G\u00e9n\u00e9rer un lien de soumission pour le client ?\nLe statut passera \u00e0 \u00abEnvoy\u00e9e\u00bb.', 'Envoyer au client', 'G\u00e9n\u00e9rer le lien'))) return;

            try {
                // Snapshot avant envoi
                await createVersion(currentSubmission.id);

                var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/public_quote_tokens', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                    body: JSON.stringify({ submission_id: currentSubmission.id })
                });
                if (!r.ok) throw new Error('Erreur cr\u00e9ation token: ' + r.status);
                var tokenData = (await r.json())[0];

                await updateSubmission(currentSubmission.id, {
                    status: 'sent_client',
                    sent_at: new Date().toISOString()
                });
                await createSubmissionReview(currentSubmission.id, 'sent', 'Lien client g\u00e9n\u00e9r\u00e9');

                currentSubmission.status = 'sent_client';
                updateStatusBadge('sent_client');
                updateWorkflowButtons();
                setEditable(false);
                loadSubmissionReviews(currentSubmission.id);

                var link = window.location.origin + '/quote.html?token=' + tokenData.token;
                showQuoteLinkModal(link);
            } catch (e) {
                console.error('Erreur envoi client:', e);
                steleAlert('Erreur: ' + e.message);
            }
        }

        function showQuoteLinkModal(link) {
            document.getElementById('steleDialogTitle').textContent = 'Lien de soumission';
            document.getElementById('steleDialogMessage').textContent = 'Copiez ce lien et envoyez-le au client par courriel :';
            document.getElementById('steleDialogInputWrap').style.display = '';
            var input = document.getElementById('steleDialogInput');
            input.value = link;
            input.readOnly = true;
            input.style.fontSize = '12px';
            document.getElementById('steleDialogCancel').style.display = 'none';
            document.getElementById('steleDialogOk').textContent = 'Copier & Fermer';
            document.getElementById('steleDialogOk').className = 'btn-generate';
            document.getElementById('steleDialogOverlay').classList.add('active');

            _steleDialogResolve = function() {
                navigator.clipboard.writeText(link).catch(function() {});
                document.getElementById('steleDialogOverlay').classList.remove('active');
                input.readOnly = false;
                input.style.fontSize = '';
            };
            setTimeout(function() { input.select(); }, 100);
        }

        async function copyQuoteLink() {
            if (!currentSubmission) return;
            var r = await authenticatedFetch(
                SUPABASE_URL + '/rest/v1/public_quote_tokens?submission_id=eq.' + currentSubmission.id + '&order=created_at.desc&limit=1', {}
            );
            if (!r.ok) { steleAlert('Erreur chargement du lien.'); return; }
            var tokens = await r.json();
            if (tokens.length === 0) { steleAlert('Aucun lien trouv\u00e9 pour cette soumission.'); return; }
            var link = window.location.origin + '/quote.html?token=' + tokens[0].token;
            showQuoteLinkModal(link);
        }

        async function approveSubmission() {
            if (!currentSubmission || !(canApproveQuotes || isApprovalMode)) return;
            var comment = await stelePrompt('Commentaire d\'approbation (optionnel) :', 'Approuver la soumission');
            if (comment === null) return;
            try {
                // Snapshot avant approbation
                await createVersion(currentSubmission.id);
                await createSubmissionReview(currentSubmission.id, 'approved', comment);
                var total = calculerGrandTotal();
                await updateSubmission(currentSubmission.id, {
                    status: 'approved_internal',
                    approved_by: localStorage.getItem('sb_user_id'),
                    approved_at: new Date().toISOString(),
                    approved_total: total
                });
                currentSubmission.status = 'approved_internal';
                updateStatusBadge('approved_internal');
                updateWorkflowButtons();
                setEditable(false);
                showSaveIndicator();
                loadSubmissionReviews(currentSubmission.id);
            } catch (e) {
                console.error('Erreur approbation:', e);
                steleAlert('Erreur approbation: ' + e.message);
            }
        }

        async function returnSubmission() {
            if (!currentSubmission || !(canApproveQuotes || isApprovalMode)) return;
            var comment = await stelePrompt('Raison du retour :', 'Retourner la soumission', 'Ex: Revoir les prix du meuble X...');
            if (comment === null) return;
            if (!comment.trim()) { steleAlert('Veuillez indiquer une raison.'); return; }
            try {
                await createSubmissionReview(currentSubmission.id, 'returned', comment);
                await updateSubmission(currentSubmission.id, { status: 'returned' });
                currentSubmission.status = 'returned';
                updateStatusBadge('returned');
                updateWorkflowButtons();
                setEditable(true);
                showSaveIndicator();
                loadSubmissionReviews(currentSubmission.id);
            } catch (e) {
                console.error('Erreur retour:', e);
                steleAlert('Erreur retour: ' + e.message);
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // BYPASS APPROBATION
        // ═══════════════════════════════════════════════════════════════════════

        function bypassApproval() {
            if (!currentSubmission) return;
            var s = currentSubmission.status;
            if (s !== 'draft' && s !== 'returned') {
                steleAlert('Seules les soumissions en brouillon ou retournées peuvent utiliser le bypass.');
                return;
            }
            if (!canBypassApproval) {
                steleAlert('Vous n\'avez pas la permission de contourner l\'approbation.');
                return;
            }
            var rows = document.querySelectorAll('.calc-row');
            if (rows.length === 0) {
                steleAlert('Veuillez ajouter au moins un article au calculateur.');
                return;
            }
            document.getElementById('bypassConfirmCheck').checked = false;
            document.getElementById('bypassReason').value = '';
            document.getElementById('bypassStatus').style.display = 'none';
            document.getElementById('btnBypassConfirm').disabled = false;
            document.getElementById('btnBypassConfirm').textContent = 'Envoyer sans approbation';
            document.getElementById('bypassModal').classList.add('active');
        }

        function closeBypassModal() {
            document.getElementById('bypassModal').classList.remove('active');
        }

        function showBypassStatus(msg, isError) {
            var el = document.getElementById('bypassStatus');
            el.style.display = 'block';
            el.textContent = msg;
            el.style.background = isError ? '#ffebee' : '#e8f5e9';
            el.style.color = isError ? '#c62828' : '#2e7d32';
        }

        async function executeBypass() {
            if (!document.getElementById('bypassConfirmCheck').checked) {
                showBypassStatus('Vous devez cocher la case de confirmation.', true);
                return;
            }
            var reason = document.getElementById('bypassReason').value.trim();
            if (!reason) {
                showBypassStatus('La raison est obligatoire.', true);
                return;
            }
            if (reason.length < 10) {
                showBypassStatus('La raison doit contenir au moins 10 caractères.', true);
                return;
            }

            var btn = document.getElementById('btnBypassConfirm');
            btn.disabled = true;
            btn.textContent = 'Envoi en cours...';
            showBypassStatus('Traitement en cours...', false);

            try {
                var statusBefore = currentSubmission.status;

                // 1. Snapshot
                await createVersion(currentSubmission.id);

                // 2. Log immutable via RPC (capture IP serveur)
                var rpcResp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/rpc/log_bypass_approval', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        p_submission_id: currentSubmission.id,
                        p_reason: reason,
                        p_status_before: statusBefore,
                        p_status_after: 'sent_client'
                    })
                });
                if (!rpcResp.ok) throw new Error('Erreur journalisation bypass: ' + rpcResp.status);

                // 3. Générer token client (même logique que sendToClient)
                var tokenResp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/public_quote_tokens', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                    body: JSON.stringify({ submission_id: currentSubmission.id })
                });
                if (!tokenResp.ok) throw new Error('Erreur création token: ' + tokenResp.status);
                var tokenData = (await tokenResp.json())[0];

                // 4. Mettre à jour la soumission
                var grandTotal = calculerGrandTotal();
                await updateSubmission(currentSubmission.id, {
                    status: 'sent_client',
                    sent_at: new Date().toISOString(),
                    bypass_approval: true,
                    approved_total: grandTotal
                });

                // 5. Entrée timeline
                await createSubmissionReview(currentSubmission.id, 'bypass', 'BYPASS: ' + reason);

                // 6. Mettre à jour l'UI
                currentSubmission.status = 'sent_client';
                currentSubmission.bypass_approval = true;
                updateStatusBadge('sent_client');
                updateWorkflowButtons();
                setEditable(false);
                loadSubmissionReviews(currentSubmission.id);

                showBypassStatus('Soumission envoyée au client (bypass approbation).', false);

                // 7. Afficher le lien client
                var link = window.location.origin + '/quote.html?token=' + tokenData.token;
                setTimeout(function() {
                    closeBypassModal();
                    showQuoteLinkModal(link);
                }, 1500);

            } catch (e) {
                console.error('Erreur bypass:', e);
                showBypassStatus('Erreur: ' + e.message, true);
                btn.disabled = false;
                btn.textContent = 'Envoyer sans approbation';
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // ACCEPTATION HORS-LIGNE (Chemin B)
        // ═══════════════════════════════════════════════════════════════════════

        function offlineAcceptance() {
            if (!currentSubmission) return;
            if (currentSubmission.status !== 'sent_client') {
                steleAlert('Seules les soumissions envoyées au client peuvent être confirmées.');
                return;
            }
            // Reset modal
            document.getElementById('offlineUserName').value = '';
            document.getElementById('offlineClientName').value = currentProject ? (currentProject.client_name || '') : '';
            document.getElementById('offlineMethod').value = 'courriel';
            document.getElementById('offlineDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('offlineNotes').value = '';
            document.getElementById('offlineConfirmCheck').checked = false;
            document.getElementById('btnOfflineConfirm').disabled = false;
            document.getElementById('btnOfflineConfirm').textContent = 'Confirmer la vente';
            document.getElementById('offlineAcceptStatus').style.display = 'none';
            document.getElementById('offlineAcceptModal').classList.add('active');
        }

        function closeOfflineAcceptModal() {
            document.getElementById('offlineAcceptModal').classList.remove('active');
        }

        function showOfflineAcceptStatus(msg, isError) {
            var el = document.getElementById('offlineAcceptStatus');
            el.style.display = 'block';
            el.textContent = msg;
            el.style.background = isError ? '#ffebee' : '#e8f5e9';
            el.style.color = isError ? '#c62828' : '#2e7d32';
        }

        async function executeOfflineAcceptance() {
            var userName = document.getElementById('offlineUserName').value.trim();
            var clientName = document.getElementById('offlineClientName').value.trim();
            var method = document.getElementById('offlineMethod').value;
            var acceptDate = document.getElementById('offlineDate').value;
            var notes = document.getElementById('offlineNotes').value.trim();
            var checked = document.getElementById('offlineConfirmCheck').checked;

            if (!userName) {
                showOfflineAcceptStatus('Le nom du chargé de projet est obligatoire.', true);
                return;
            }
            if (!clientName) {
                showOfflineAcceptStatus('Le nom du client est obligatoire.', true);
                return;
            }
            if (!acceptDate) {
                showOfflineAcceptStatus('La date d\'acceptation est obligatoire.', true);
                return;
            }
            if (!checked) {
                showOfflineAcceptStatus('Vous devez cocher la case de confirmation.', true);
                return;
            }

            var btn = document.getElementById('btnOfflineConfirm');
            btn.disabled = true;
            btn.textContent = 'Traitement en cours...';
            showOfflineAcceptStatus('Enregistrement...', false);

            try {
                // 0. Snapshot avant acceptation
                await createVersion(currentSubmission.id);

                // 1. Log immutable via RPC (capture IP serveur)
                var rpcResp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/rpc/log_offline_acceptance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        p_submission_id: currentSubmission.id,
                        p_user_name: userName,
                        p_acceptance_method: method,
                        p_acceptance_date: acceptDate,
                        p_client_name: clientName,
                        p_notes: notes || null
                    })
                });
                if (!rpcResp.ok) throw new Error('Erreur journalisation acceptation: ' + rpcResp.status);

                // 2. Mettre à jour la soumission
                await updateSubmission(currentSubmission.id, {
                    status: 'accepted',
                    accepted_at: new Date(acceptDate).toISOString(),
                    accepted_by_name: clientName
                });

                // 3. Entrée timeline
                var methodLabels = { courriel: 'Courriel', telephone: 'Téléphone', papier: 'Papier', autre: 'Autre' };
                var comment = 'Acceptation hors-ligne par ' + userName + ' — Méthode: ' + (methodLabels[method] || method) + ', Client: ' + clientName;
                if (notes) comment += ', Notes: ' + notes;
                await createSubmissionReview(currentSubmission.id, 'offline_accepted', comment);

                // 4. Mettre à jour l'UI
                currentSubmission.status = 'accepted';
                currentSubmission.accepted_at = acceptDate;
                currentSubmission.accepted_by_name = clientName;
                updateStatusBadge('accepted');
                updateWorkflowButtons();
                setEditable(false);
                loadSubmissionReviews(currentSubmission.id);

                showOfflineAcceptStatus('Vente confirmée avec succès!', false);

                setTimeout(function() {
                    closeOfflineAcceptModal();
                }, 1500);

            } catch (e) {
                console.error('Erreur acceptation hors-ligne:', e);
                showOfflineAcceptStatus('Erreur: ' + e.message, true);
                btn.disabled = false;
                btn.textContent = 'Confirmer la vente';
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // MARQUER FACTURÉE
        // ═══════════════════════════════════════════════════════════════════════

        async function markInvoiced() {
            if (!currentSubmission) return;
            if (currentSubmission.status !== 'accepted') {
                steleAlert('Seules les soumissions vendues peuvent être marquées facturées.');
                return;
            }

            var ok = await steleConfirm(
                'Marquer cette soumission comme facturée? Cette action indique que la facturation a été effectuée.',
                'Marquer facturée',
                'Confirmer'
            );
            if (!ok) return;

            try {
                await updateSubmission(currentSubmission.id, { status: 'invoiced' });
                await createSubmissionReview(currentSubmission.id, 'invoiced', 'Soumission marquée comme facturée');

                currentSubmission.status = 'invoiced';
                updateStatusBadge('invoiced');
                updateWorkflowButtons();
                setEditable(false);
                loadSubmissionReviews(currentSubmission.id);

            } catch (e) {
                console.error('Erreur marquage facturée:', e);
                steleAlert('Erreur: ' + e.message);
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // SUPPRIMER UN PROJET
        // ═══════════════════════════════════════════════════════════════════════

        async function handleDeleteProject(projectId, event) {
            event.stopPropagation();
            if (!(await steleConfirm('Supprimer ce projet et toutes ses donn\u00e9es ?', 'Supprimer le projet', 'Supprimer', true))) return;
            await deleteProject(projectId);
            renderProjectList();
        }

        // ═══════════════════════════════════════════════════════════════════════
        // RENTABILITÉ
        // ═══════════════════════════════════════════════════════════════════════

        function openRentab(scope, groupId) {
            // scope = 'project' ou 'group'
            var title = scope === 'project' ? 'Rentabilit\u00e9 — Projet complet' : 'Rentabilit\u00e9 — ' + (document.getElementById(groupId + '-name').value || 'Meuble');
            document.getElementById('rentabTitle').textContent = title;

            // Collecter les lignes en scope
            var rows;
            if (scope === 'project') {
                rows = document.querySelectorAll('.calc-row');
            } else {
                rows = document.querySelectorAll('#' + groupId + '-rows .calc-row');
            }

            // Accumulateurs
            var deptMinutes = {};
            var matCoutant = {};
            var totalMatMarkup = 0;
            var totalMatWaste = 0;
            var totalMatCoutant = 0;
            var totalHeuresCharge = 0;
            var totalSalaires = 0;
            var totalFraisFixes = 0;
            var totalProfitMO = 0;
            var totalPrixVente = 0;

            // Init départements
            tauxHoraires.forEach(function(t) { deptMinutes[t.department] = 0; });

            // Init matériaux
            expenseCategories.forEach(function(c) { matCoutant[c.name] = 0; });

            rows.forEach(function(row) {
                var select = row.querySelector('.item-select');
                var qtyInput = row.querySelector('.qty-input');
                if (!select || !qtyInput) return;
                var selectedId = select.value;
                var qty = parseFloat(qtyInput.value) || 0;
                if (!selectedId || selectedId === '__AJOUT__' || selectedId === '__PROPOSER__') {
                    // Ajout personnalisé — ajouter au prix de vente
                    if (selectedId === '__AJOUT__') {
                        var priceInput = row.querySelector('.ajout-price');
                        var markupInput = row.querySelector('.ajout-markup');
                        var p = parseFloat(priceInput ? priceInput.value : 0) || 0;
                        var m = parseFloat(markupInput ? markupInput.value : 0) || 0;
                        totalPrixVente += p * qty * (1 + m / 100);
                    }
                    return;
                }
                var item = CATALOGUE_DATA.find(function(i) { return i.id === selectedId; });
                if (!item) return;

                var installCb = document.getElementById(row.id + '-install');
                var includeInstall = installCb ? installCb.checked : true;
                var laborMinutes = item.labor_minutes || {};
                var materialCosts = item.material_costs || {};

                // Départements
                tauxHoraires.forEach(function(t) {
                    var dept = t.department;
                    var mins = (laborMinutes[dept] || 0) * qty;
                    if (!includeInstall && dept === 'Installation') return;
                    deptMinutes[dept] = (deptMinutes[dept] || 0) + mins;
                    var hours = mins / 60;
                    totalHeuresCharge += hours * (t.taux_horaire || 0);
                    totalSalaires += hours * (t.salaire || 0);
                    totalFraisFixes += hours * (t.frais_fixe || 0);
                    totalProfitMO += hours * ((t.taux_horaire || 0) - (t.salaire || 0) - (t.frais_fixe || 0));
                });

                // Matériaux
                expenseCategories.forEach(function(c) {
                    var cost = (materialCosts[c.name] || 0) * qty;
                    matCoutant[c.name] = (matCoutant[c.name] || 0) + cost;
                    totalMatCoutant += cost;
                    totalMatMarkup += cost * ((c.markup || 0) / 100);
                    totalMatWaste += cost * ((c.waste || 0) / 100);
                });
            });

            totalPrixVente += totalHeuresCharge + totalMatCoutant + totalMatWaste + totalMatMarkup;

            // Marges
            var profitNet = totalProfitMO + totalMatMarkup;
            var margeBrutReelPct = totalPrixVente > 0 ? (profitNet / totalPrixVente * 100) : 0;
            var margeVisee = 38; // %
            var margeViseeMontant = totalPrixVente * margeVisee / 100;

            // Total minutes
            var totalMinutes = 0;
            tauxHoraires.forEach(function(t) { totalMinutes += (deptMinutes[t.department] || 0); });

            // Render
            var f = function(v) { return v.toLocaleString('fr-CA', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' $'; };
            var fPct = function(v) { return v.toFixed(2) + ' %'; };
            var fNum = function(v) { return v.toLocaleString('fr-CA', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); };

            var html = '';

            // ── 2 colonnes : résumé | ventilation + marges ──
            html += '<div class="rentab-columns">';

            // Colonne gauche — Résumé
            html += '<div>';
            html += '<div class="rentab-section">';
            html += '<div class="rentab-section-title">R\u00e9sum\u00e9</div>';
            html += '<table class="rentab-table">';
            html += '<tr class="highlight"><td>Prix de vente total</td><td>' + f(totalPrixVente) + '</td></tr>';
            html += '<tr class="spacer"><td></td><td></td></tr>';
            html += '<tr><td>Prix co\u00fbtant mat\u00e9riaux (base)</td><td>' + f(totalMatCoutant) + '</td></tr>';
            html += '<tr><td>Perte mat\u00e9riaux</td><td>' + f(totalMatWaste) + '</td></tr>';
            html += '<tr><td>Mark up mat\u00e9riaux</td><td>' + f(totalMatMarkup) + '</td></tr>';
            html += '<tr class="spacer"><td></td><td></td></tr>';
            html += '<tr class="highlight"><td>Total heures charg\u00e9</td><td>' + f(totalHeuresCharge) + '</td></tr>';
            html += '<tr><td>Total salaires</td><td>' + f(totalSalaires) + '</td></tr>';
            html += '<tr><td>Total frais fixes</td><td>' + f(totalFraisFixes) + '</td></tr>';
            html += '<tr><td>Profit sur taux horaire</td><td>' + f(totalProfitMO) + '</td></tr>';
            html += '</table>';
            html += '</div>';
            html += '</div>';

            // Colonne droite — Ventilation + Marges
            html += '<div>';

            // Départements
            html += '<div class="rentab-section">';
            html += '<div class="rentab-section-title">Ventilation main-d\u2019\u0153uvre</div>';
            html += '<table class="rentab-dept-table">';
            html += '<tr><th></th>';
            tauxHoraires.forEach(function(t) {
                var short = t.department.split('/')[0].substring(0, 6);
                html += '<th>' + escapeHtml(short) + '</th>';
            });
            html += '</tr>';
            // Heures
            html += '<tr><td>Heures</td>';
            var totalHeures = 0;
            tauxHoraires.forEach(function(t) {
                var h = (deptMinutes[t.department] || 0) / 60;
                totalHeures += h;
                html += '<td>' + fNum(h) + '</td>';
            });
            html += '</tr>';
            html += '</table>';
            html += '</div>';

            // Marges
            html += '<div class="rentab-section">';
            html += '<div class="rentab-section-title">Marges</div>';
            html += '<div class="rentab-margins">';
            html += '<div class="rentab-margins-row"><span>Marge brut vis\u00e9e</span><span>' + fPct(margeVisee) + '</span></div>';
            html += '<div class="rentab-margins-row"><span>Marge brut r\u00e9elle</span><span>' + fPct(margeBrutReelPct) + '</span></div>';
            html += '<div class="rentab-margins-row profit-row"><span>Profit net estim\u00e9</span><span>' + f(profitNet) + '</span></div>';
            html += '</div>';
            html += '</div>';

            html += '</div>';
            html += '</div>'; // fin rentab-columns

            // ── Pleine largeur : Coûtant matériaux ──
            html += '<div class="rentab-section" style="margin-top:8px;">';
            html += '<div class="rentab-section-title">Co\u00fbtant mat\u00e9riaux</div>';
            html += '<table class="rentab-table">';
            var hasMatRows = false;
            expenseCategories.forEach(function(c) {
                var costVal = matCoutant[c.name] || 0;
                if (costVal > 0) {
                    html += '<tr><td>' + escapeHtml(c.name) + '</td><td style="color:#999;">' + escapeHtml(c.name) + '</td><td>' + f(costVal) + '</td></tr>';
                    hasMatRows = true;
                }
            });
            if (!hasMatRows) html += '<tr><td>Aucun mat\u00e9riau</td><td style="color:#999;">Aucun mat\u00e9riau</td><td>' + f(0) + '</td></tr>';
            html += '<tr class="total"><td>Total</td><td></td><td>' + f(totalMatCoutant) + '</td></tr>';
            html += '</table>';
            html += '</div>';

            document.getElementById('rentabBody').innerHTML = html;
            document.getElementById('rentabModal').classList.add('active');
        }

        function closeRentab() {
            document.getElementById('rentabModal').classList.remove('active');
        }

        // ═══════════════════════════════════════════════════════════════════════
        // VÉRIFICATION DES PERMISSIONS
        // ═══════════════════════════════════════════════════════════════════════

        const DEFAULT_PERMISSIONS = {
            'Admin': { calculateur: true }, 'Vente': { calculateur: true },
            'Charg\u00e9 de projet': { calculateur: true }, 'Achat': { calculateur: false },
            'Atelier': { calculateur: false }, 'Client': { calculateur: false }
        };
        const DEFAULT_USER_ROLES = { 'hubert@stele.ca': 'Admin' };

        async function checkPageAccess() {
            try {
                const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/app_config?key=in.(permissions,user_roles)&select=key,value', {});
                let perms = DEFAULT_PERMISSIONS, roles = DEFAULT_USER_ROLES;
                if (r.ok) {
                    const rows = await r.json();
                    rows.forEach(row => {
                        if (row.key === 'permissions') perms = row.value;
                        if (row.key === 'user_roles') roles = row.value;
                    });
                }
                const email = (localStorage.getItem('sb_user_email') || '').toLowerCase();
                const role = roles[email] || 'Client';
                const defaults = DEFAULT_PERMISSIONS[role] || {};
                const saved = perms[role] || {};
                const allowed = Object.assign({}, defaults, saved);
                canEditMinutes = !!allowed.edit_minutes;
                canEditMaterials = !!allowed.edit_materials;
                canApproveQuotes = !!allowed.can_approve_quotes;
                canBypassApproval = !!allowed.can_bypass_approval;
                canUnlockSubmission = !!allowed.can_unlock_submission;
                var hasSubParam = new URLSearchParams(window.location.search).has('submission');
                if (!allowed.calculateur && !(hasSubParam && (allowed.approbation || allowed.can_approve_quotes))) {
                    window.location.href = 'app.html'; return false;
                }
            } catch (e) {
                const email = (localStorage.getItem('sb_user_email') || '').toLowerCase();
                const role = DEFAULT_USER_ROLES[email] || 'Client';
                var defPerms = DEFAULT_PERMISSIONS[role] || {};
                canEditMinutes = !!defPerms.edit_minutes;
                canEditMaterials = !!defPerms.edit_materials;
                canApproveQuotes = !!defPerms.can_approve_quotes;
                canBypassApproval = !!defPerms.can_bypass_approval;
                canUnlockSubmission = !!defPerms.can_unlock_submission;
                if (!defPerms.calculateur) { window.location.href = 'app.html'; return false; }
            }
            return true;
        }

        async function loadMediaTags() {
            try {
                const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/app_config?key=eq.media_tags&select=value', {});
                if (r.ok) {
                    const rows = await r.json();
                    if (rows.length > 0 && Array.isArray(rows[0].value)) {
                        mediaTagsList = rows[0].value;
                    }
                }
            } catch (e) { /* keep defaults */ }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // INITIALISATION
        // ═══════════════════════════════════════════════════════════════════════

        document.addEventListener('DOMContentLoaded', async function() {
            if (!(await checkPageAccess())) return;
            await loadCatalogueData();
            await loadConfigCategories();
            await loadTauxAndExpenses();
            await loadMediaTags();
            await loadEmployeesData();
            setupProposerMediaHandlers();

            // Setup PDF viewer Ctrl+scroll zoom
            var pdfCanvasContainer = document.getElementById('pdfCanvasContainer');
            if (pdfCanvasContainer) {
                pdfCanvasContainer.addEventListener('wheel', function(e) {
                    if (e.ctrlKey) {
                        e.preventDefault();
                        var delta = e.deltaY > 0 ? -0.1 : 0.1;
                        pdfZoom(delta);
                    }
                }, { passive: false });
            }

            // Check for direct submission opening (from approbation page)
            var params = new URLSearchParams(window.location.search);
            var submissionParam = params.get('submission');
            if (submissionParam) {
                isApprovalMode = true;
                await openSubmission(submissionParam);
            } else {
                renderProjectList();
            }
        });
    </script>

</body>
</html>
