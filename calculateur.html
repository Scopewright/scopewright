<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stele — Calculateur</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="scopewright-tokens.css">

    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"
            onerror="handleScriptError('PDF.js')"></script>

    <script>
    // ═══════════════════════════════════════════════════════════════════════
    // ERROR HANDLING & LOADING STATE
    // ═══════════════════════════════════════════════════════════════════════

    var appLoadTimeout = null;
    var scriptsLoaded = { pdfjs: false };
    var appReady = false;

    function handleScriptError(scriptName) {
        console.error('Failed to load:', scriptName);
        showOverlayError(
            'Erreur de connexion',
            'Impossible de charger les ressources nécessaires. Vérifiez votre connexion internet et rafraîchissez la page.'
        );
    }

    function showOverlayError(title, message) {
        clearTimeout(appLoadTimeout);
        var overlay = document.getElementById('appOverlay');
        if (!overlay) return;

        document.getElementById('overlaySpinner').style.display = 'none';
        document.getElementById('overlayErrorIcon').style.display = 'block';
        document.getElementById('overlayTitle').textContent = title;
        document.getElementById('overlayMessage').textContent = message;
        document.getElementById('overlayRetryBtn').style.display = 'inline-block';
        overlay.classList.remove('hidden');
    }

    function hideOverlay() {
        clearTimeout(appLoadTimeout);
        var overlay = document.getElementById('appOverlay');
        if (overlay) {
            overlay.classList.add('hidden');
            setTimeout(function() { overlay.style.display = 'none'; }, 300);
        }
    }

    // Timeout de 30 secondes pour le chargement initial
    appLoadTimeout = setTimeout(function() {
        if (!appReady) {
            console.error('App load timeout - appReady never set to true');
            showOverlayError(
                'Chargement lent',
                'Le chargement prend plus de temps que prévu. Vérifiez votre connexion internet ou rafraîchissez la page.'
            );
        }
    }, 30000);

    // ═══════════════════════════════════════════════════════════════════════
    // AUTHENTICATION & CONSTANTS
    // ═══════════════════════════════════════════════════════════════════════

    // Vérifier la connexion
    if (!localStorage.getItem('sb_access_token')) {
        window.location.href = 'login.html';
    }

    const SUPABASE_URL = 'https://rplzbtjfnwahqodrhpny.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJwbHpidGpmbndhaHFvZHJocG55Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NDU2MDEsImV4cCI6MjA4NjIyMTYwMX0.OQAZhc029PbRDSe1b02NDAuOUE8yn-_h3QqSnUDpLeU';

    const STORAGE_KEY = 'stele_catalogue_data';
    const STORAGE_DATE_KEY = 'stele_catalogue_date';

    // GAS retiré — workflow interne via soumissions

    let EMPLOYEES_DATA = [];
    let CATALOGUE_DATA = [];
    let tauxHoraires = [];
    let expenseCategories = [];
    let canEditMinutes = false;
    let canEditMaterials = false;
    let mediaTagsList = ['fiche_client', 'catalogue', 'technique', 'dessin'];
    let propMedia = [];

    // Pipeline commercial
    var pipelineStatuses = [];
    var projectSources = [];
    var projectTypes = [];
    var currentPipelineView = 'cards';
    var cachedProjects = [];
    var pipelineSortColumn = 'updated_at';
    var pipelineSortDir = 'desc';
    var pipelineFilters = { search: '', status: '', assigned: '', type: '', followsOnly: false, showArchived: false };
    var userFollows = {};

    // Configure PDF.js worker (wait for script to load)
    function initPdfJs() {
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            scriptsLoaded.pdfjs = true;
            return true;
        }
        return false;
    }

    // Try to initialize PDF.js immediately, or wait for load event
    if (!initPdfJs()) {
        window.addEventListener('load', initPdfJs);
    }

    // Global error handlers
    window.addEventListener('error', function(e) {
        if (e.filename && e.filename.includes('pdf')) {
            console.error('PDF.js error:', e);
            // Don't show overlay if app is already loaded
            if (!appReady) {
                handleScriptError('PDF.js');
            }
        }
    });

    window.addEventListener('unhandledrejection', function(e) {
        console.error('Unhandled promise rejection:', e.reason);
        // Only show overlay for critical errors during initialization
        if (!appReady && e.reason && (
            e.reason.message?.includes('fetch') ||
            e.reason.message?.includes('network') ||
            e.reason.message?.includes('Failed to fetch')
        )) {
            showOverlayError(
                'Erreur de connexion',
                'Impossible de se connecter au serveur. Vérifiez votre connexion internet.'
            );
        }
    });

    // ═══════════════════════════════════════════════════════════════════════
    // PROJETS — ÉTAT GLOBAL
    // ═══════════════════════════════════════════════════════════════════════

    let currentProject = null;      // objet projet courant { id, name, client_name, ... }
    let currentSubmission = null;   // objet soumission courante { id, submission_number, title, status, ... }
    let canApproveQuotes = false;   // permission can_approve_quotes
    let canBypassApproval = false;  // permission can_bypass_approval
    let canUnlockSubmission = false; // permission can_unlock_submission
    let isApprovalMode = false;     // true when opened from approbation.html via ?submission=
    let roomMap = {};               // { groupDomId: supabaseRoomUUID }
    let itemMap = {};               // { rowDomId: supabaseItemUUID }
    let groupImages = {};        // { groupDomId: [{ name, dataUrl }] }
    let saveTimeout = null;      // pour le debounce
    const MAX_GROUP_IMAGES = 8;

    // Project contacts state
    var projectContacts = [];
    var allContactsCache = [];
    var selectedComboContactId = null;
    var configContactRoles = ['Client', 'Entrepreneur', 'Designer', 'Architecte', 'Ingénieur'];
    var allCompaniesCache = [];
    var selectedClientType = null;
    var selectedClientId = null;
    var coverImageUrl = null;

    // ═══════════════════════════════════════════════════════════════════════
    // DIALOGUES CUSTOM (remplace alert/confirm/prompt natifs)
    // ═══════════════════════════════════════════════════════════════════════

    var _steleDialogResolve = null;
    function steleDialogResolve(val) {
        document.getElementById('steleDialogOverlay').classList.remove('active');
        if (_steleDialogResolve) { var fn = _steleDialogResolve; _steleDialogResolve = null; fn(val); }
    }
    function steleDialogOk() {
        var input = document.getElementById('steleDialogInput');
        var wrap = document.getElementById('steleDialogInputWrap');
        steleDialogResolve(wrap.style.display === 'none' ? true : input.value);
    }

    function steleAlert(msg, title) {
        return new Promise(function(resolve) {
            _steleDialogResolve = resolve;
            document.getElementById('steleDialogTitle').textContent = title || '';
            document.getElementById('steleDialogMessage').textContent = msg;
            document.getElementById('steleDialogInputWrap').style.display = 'none';
            document.getElementById('steleDialogCancel').style.display = 'none';
            document.getElementById('steleDialogOk').textContent = 'OK';
            document.getElementById('steleDialogOk').className = 'btn-generate';
            document.getElementById('steleDialogOverlay').classList.add('active');
        });
    }

    function steleConfirm(msg, title, okLabel, danger) {
        return new Promise(function(resolve) {
            _steleDialogResolve = resolve;
            document.getElementById('steleDialogTitle').textContent = title || 'Confirmation';
            document.getElementById('steleDialogMessage').textContent = msg;
            document.getElementById('steleDialogInputWrap').style.display = 'none';
            document.getElementById('steleDialogCancel').style.display = '';
            document.getElementById('steleDialogOk').textContent = okLabel || 'Confirmer';
            document.getElementById('steleDialogOk').className = danger ? 'btn-generate' : 'btn-generate';
            if (danger) document.getElementById('steleDialogOk').style.background = '#c0392b';
            else document.getElementById('steleDialogOk').style.background = '';
            document.getElementById('steleDialogOverlay').classList.add('active');
        });
    }

    function stelePrompt(msg, title, placeholder, required) {
        return new Promise(function(resolve) {
            _steleDialogResolve = resolve;
            document.getElementById('steleDialogTitle').textContent = title || '';
            document.getElementById('steleDialogMessage').textContent = msg;
            document.getElementById('steleDialogInputWrap').style.display = '';
            var input = document.getElementById('steleDialogInput');
            input.value = '';
            input.placeholder = placeholder || '';
            document.getElementById('steleDialogCancel').style.display = '';
            document.getElementById('steleDialogOk').textContent = 'OK';
            document.getElementById('steleDialogOk').className = 'btn-generate';
            document.getElementById('steleDialogOk').style.background = '';
            document.getElementById('steleDialogOverlay').classList.add('active');
            setTimeout(function() { input.focus(); }, 100);
        });
    }

    // ═══════════════════════════════════════════════════════════════════════

    function escapeHtml(str) {
        if (!str) return '';
        var div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }

    function escapeAttr(str) {
        return (str || '').replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;');
    }

    // Convert plain text (legacy) to basic HTML; if already HTML, return as-is
    function textToHtml(str) {
        if (!str) return '';
        if (str.indexOf('<p>') !== -1 || str.indexOf('<strong>') !== -1 || str.indexOf('<ul>') !== -1) {
            return str; // already HTML
        }
        // Legacy plain text: escape then convert newlines to <br>
        return escapeHtml(str).replace(/\n/g, '<br>');
    }

    function debounce(fn, delay) {
        let timer;
        return function(...args) {
            clearTimeout(timer);
            timer = setTimeout(() => fn.apply(this, args), delay);
        };
    }

    // ═══════════════════════════════════════════════════════════════════════
    // PROJETS — CRUD SUPABASE
    // ═══════════════════════════════════════════════════════════════════════

    async function loadProjects() {
        const userId = localStorage.getItem('sb_user_id');
        // Try enriched query with pipeline columns + contacts
        var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/projects?user_id=eq.' + userId + '&order=updated_at.desc&select=*,submissions(id,submission_number,title,status,current_version,updated_at,bypass_approval,approved_total,estimateur,vendeur_cp,approbateur,internal_deadline,client_deadline,is_archived),project_contacts(role,is_primary,contacts(first_name,last_name,contact_companies(companies(name))))', {});
        if (!r.ok) {
            // Fallback: basic query without pipeline columns (migrations not yet run)
            r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/projects?user_id=eq.' + userId + '&order=updated_at.desc&select=*,submissions(id,submission_number,title,status,current_version,updated_at,bypass_approval,is_archived)', {});
            if (!r.ok) return [];
        }
        var projects = await r.json();
        projects.forEach(function(p) {
            if (p.submissions) p.submissions.sort(function(a, b) { return b.submission_number - a.submission_number; });
        });
        return projects;
    }

    async function createProject(name, clientName) {
        const userId = localStorage.getItem('sb_user_id');
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/projects', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
            body: JSON.stringify({ user_id: userId, name: name, client_name: clientName || '' })
        });
        if (!r.ok) throw new Error('Erreur création projet: ' + r.status);
        const data = await r.json();
        return data[0];
    }

    async function updateProject(projectId, fields) {
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/projects?id=eq.' + projectId, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
            body: JSON.stringify(fields)
        });
        return r.ok;
    }

    async function deleteProject(projectId) {
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/projects?id=eq.' + projectId, {
            method: 'DELETE'
        });
        return r.ok;
    }

    // ═══════════════════════════════════════════════════════════════════════
    // PROJECT FOLLOWS (★)
    // ═══════════════════════════════════════════════════════════════════════

    async function loadUserFollows() {
        var userId = localStorage.getItem('sb_user_id');
        try {
            var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/project_follows?user_id=eq.' + userId + '&select=project_id', {});
            if (!r.ok) return;
            var rows = await r.json();
            userFollows = {};
            rows.forEach(function(row) { userFollows[row.project_id] = true; });
        } catch (e) {
            console.warn('loadUserFollows error (table may not exist yet):', e);
        }
    }

    async function toggleFollow(projectId, evt) {
        evt.stopPropagation();
        var userId = localStorage.getItem('sb_user_id');
        if (userFollows[projectId]) {
            await authenticatedFetch(SUPABASE_URL + '/rest/v1/project_follows?project_id=eq.' + projectId + '&user_id=eq.' + userId, { method: 'DELETE' });
            delete userFollows[projectId];
        } else {
            await authenticatedFetch(SUPABASE_URL + '/rest/v1/project_follows', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                body: JSON.stringify({ project_id: projectId, user_id: userId })
            });
            userFollows[projectId] = true;
        }
        renderCurrentView();
    }

    function toggleFollowsFilter() {
        pipelineFilters.followsOnly = !pipelineFilters.followsOnly;
        var btn = document.getElementById('filterFollowsBtn');
        if (btn) btn.classList.toggle('active', pipelineFilters.followsOnly);
        applyPipelineFilters();
    }

    // ═══════════════════════════════════════════════════════════════════════
    // SOUMISSIONS — CRUD SUPABASE
    // ═══════════════════════════════════════════════════════════════════════

    async function loadSubmissions(projectId) {
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/submissions?project_id=eq.' + projectId + '&order=submission_number.desc&select=*', {});
        if (!r.ok) return [];
        return await r.json();
    }

    async function createSubmission(projectId, title) {
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/submissions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
            body: JSON.stringify({ project_id: projectId, title: title || '' })
        });
        if (!r.ok) throw new Error('Erreur cr\u00e9ation soumission: ' + r.status);
        const data = await r.json();
        return data[0];
    }

    async function updateSubmission(submissionId, fields) {
        // Guard: transition vers 'accepted' uniquement depuis 'sent_client'
        if (fields.status === 'accepted') {
            if (!currentSubmission || currentSubmission.status !== 'sent_client') {
                throw new Error('Transition invalide: seul le statut "sent_client" peut mener à "accepted".');
            }
        }
        fields.updated_at = new Date().toISOString();
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/submissions?id=eq.' + submissionId, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
            body: JSON.stringify(fields)
        });
        if (!r.ok) {
            var errText = '';
            try { errText = await r.text(); } catch(e) {}
            throw new Error('Échec mise à jour soumission (' + r.status + '): ' + errText);
        }
        return true;
    }

    async function deleteSubmission(submissionId) {
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/submissions?id=eq.' + submissionId, {
            method: 'DELETE'
        });
        return r.ok;
    }

    // Vérifie si une soumission a déjà été acceptée (online ou offline)
    async function wasAlreadyAccepted(submissionId) {
        try {
            var r = await authenticatedFetch(
                SUPABASE_URL + '/rest/v1/submission_reviews?submission_id=eq.' + submissionId +
                '&action=in.(offline_accepted,accepted)&limit=1&select=id',
                {}
            );
            if (r.ok) {
                var rows = await r.json();
                if (rows.length > 0) return true;
            }
            // Vérifier aussi via public_quote_tokens (acceptation en ligne)
            var r2 = await authenticatedFetch(
                SUPABASE_URL + '/rest/v1/public_quote_tokens?submission_id=eq.' + submissionId +
                '&accepted_at=not.is.null&limit=1&select=id',
                {}
            );
            if (r2.ok) {
                var rows2 = await r2.json();
                if (rows2.length > 0) return true;
            }
        } catch (e) { /* fail open — le trigger BD protégera */ }
        return false;
    }

    // ═══════════════════════════════════════════════════════════════════════
    // REVIEWS — CRUD SUPABASE
    // ═══════════════════════════════════════════════════════════════════════

    async function createSubmissionReview(submissionId, action, comment) {
        const userId = localStorage.getItem('sb_user_id');
        var versionAt = currentSubmission ? currentSubmission.current_version : null;
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/submission_reviews', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
            body: JSON.stringify({
                submission_id: submissionId,
                reviewer_id: userId,
                action: action,
                comment: comment || '',
                version_at_review: versionAt
            })
        });
        if (!r.ok) {
            var errText = await r.text().catch(function() { return ''; });
            console.error('createSubmissionReview failed:', r.status, errText);
            throw new Error('Erreur review: ' + r.status + ' ' + errText);
        }
        return (await r.json())[0];
    }

    // ═══════════════════════════════════════════════════════════════════════
    // TIMELINE DRAWER — HISTORIQUE SOUMISSION
    // ═══════════════════════════════════════════════════════════════════════

    var timelineReviews = [];

    async function loadSubmissionReviews(submissionId) {
        var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/submission_reviews?submission_id=eq.' + submissionId + '&order=created_at.asc&select=*', {});
        if (!r.ok) { timelineReviews = []; return; }
        timelineReviews = await r.json();
        renderTimelineDrawer();
        // Show button if there are reviews (now in kebab menu, always visible)
        var btn = document.getElementById('btnTimeline');
        if (btn) btn.style.display = '';
    }

    function renderTimelineDrawer() {
        var body = document.getElementById('timelineBody');
        if (timelineReviews.length === 0) {
            body.innerHTML = '<div class="timeline-empty">Aucun historique pour cette soumission.</div>';
            return;
        }

        var actionLabels = {
            'submitted': 'Soumis pour approbation',
            'approved': 'Approuv\u00e9',
            'returned': 'Retourn\u00e9',
            'sent': 'Envoy\u00e9 au client',
            'bypass': 'Bypass approbation',
            'offline_accepted': 'Vente confirmée (hors-ligne)',
            'duplicated': 'Soumission dupliquée',
            'unlocked': 'DÉVERROUILLÉ'
        };

        var html = '';
        timelineReviews.forEach(function(rev) {
            var action = rev.action || 'submitted';
            var label = actionLabels[action] || action;
            var date = rev.created_at ? new Date(rev.created_at) : null;
            var dateStr = date ? date.toLocaleDateString('fr-CA', { year: 'numeric', month: 'short', day: 'numeric' }) + ' \u00e0 ' + date.toLocaleTimeString('fr-CA', { hour: '2-digit', minute: '2-digit' }) : '';
            var version = rev.version_at_review ? 'V' + rev.version_at_review : '';

            html += '<div class="timeline-entry">';
            html += '<div class="timeline-dot timeline-dot-' + action + '"></div>';
            html += '<div class="timeline-entry-header">';
            html += '<span class="timeline-action timeline-action-' + action + '">' + label + '</span>';
            if (version) html += '<span class="timeline-version">' + version + '</span>';
            html += '</div>';
            html += '<div class="timeline-date">' + dateStr + '</div>';
            if (rev.comment) {
                html += '<div class="timeline-comment timeline-comment-' + action + '">' + escapeHtml(rev.comment) + '</div>';
            }
            html += '</div>';
        });

        body.innerHTML = html;
    }

    function openTimelineDrawer() {
        document.getElementById('timelineOverlay').classList.add('active');
        document.getElementById('timelineDrawer').classList.add('active');
    }

    function closeTimelineDrawer() {
        document.getElementById('timelineOverlay').classList.remove('active');
        document.getElementById('timelineDrawer').classList.remove('active');
    }

    // ═══════════════════════════════════════════════════════════════════════
    // AI ASSISTANT — DRAWER & MESSAGING
    // ═══════════════════════════════════════════════════════════════════════

    var aiConversation = [];      // { role, content } for API
    var aiPendingImages = [];     // base64 images waiting to send
    var aiCurrentScope = 'project';
    var aiChatLoaded = false;     // whether we loaded from DB for this submission
    var aiScopeObserver = null;
    var _aiScopeDebounceTimer = null;

    function openAiDrawer() {
        document.getElementById('aiOverlay').classList.add('active');
        document.getElementById('aiDrawer').classList.add('active');
        document.getElementById('btnAiAssistant').classList.add('active');
        updateAiScope();
        if (!aiChatLoaded && currentSubmission) {
            aiChatLoaded = true;
            loadAiChat(currentSubmission.id);
        }
        setTimeout(function() {
            var inp = document.getElementById('aiInput');
            if (inp) inp.focus({ preventScroll: true });
        }, 300);
    }

    function closeAiDrawer() {
        document.getElementById('aiOverlay').classList.remove('active');
        document.getElementById('aiDrawer').classList.remove('active');
        document.getElementById('btnAiAssistant').classList.remove('active');
    }

    function updateAiScope() {
        var badge = document.getElementById('aiScopeBadge');
        if (!badge) return;
        if (aiCurrentScope === 'room' && aiFocusGroupId) {
            var nameInput = document.getElementById(aiFocusGroupId + '-name');
            var roomName = nameInput ? nameInput.value.trim() : '';
            badge.textContent = roomName ? roomName : 'Pièce';
            badge.title = 'AI ciblée sur: ' + (roomName || 'pièce sélectionnée');
        } else {
            badge.textContent = 'Projet';
            badge.title = 'AI analyse le projet entier';
        }
    }

    function toggleAiFocus(groupId) {
        // Deselect all focus buttons
        document.querySelectorAll('.btn-ai-focus.active').forEach(function(btn) { btn.classList.remove('active'); });

        if (aiFocusGroupId === groupId) {
            // Toggle off — back to project scope
            aiFocusGroupId = null;
            aiCurrentScope = 'project';
        } else {
            // Focus on this room and open the AI drawer
            aiFocusGroupId = groupId;
            aiCurrentScope = 'room';
            var btn = document.getElementById(groupId + '-aiFocus');
            if (btn) btn.classList.add('active');
            openAiDrawer();
        }
        updateAiScope();
    }

    function setAiScopeFromScroll(groupId) {
        // groupId = null means project scope, otherwise room scope
        if (groupId === aiFocusGroupId) return; // no change

        // Update focus buttons
        document.querySelectorAll('.btn-ai-focus.active').forEach(function(btn) { btn.classList.remove('active'); });

        if (groupId) {
            aiFocusGroupId = groupId;
            aiCurrentScope = 'room';
            var btn = document.getElementById(groupId + '-aiFocus');
            if (btn) btn.classList.add('active');
        } else {
            aiFocusGroupId = null;
            aiCurrentScope = 'project';
        }

        updateAiScope();

        // Flash the badge
        var badge = document.getElementById('aiScopeBadge');
        if (badge) {
            badge.classList.remove('flash');
            void badge.offsetWidth;
            badge.classList.add('flash');
        }
    }

    function initAiScopeObserver() {
        if (aiScopeObserver) return;
        var visibleHeaders = new Set();
        aiScopeObserver = new IntersectionObserver(function(entries) {
            entries.forEach(function(entry) {
                var group = entry.target.closest('.furniture-group');
                if (!group) return;
                if (entry.isIntersecting) {
                    visibleHeaders.add(group.id);
                } else {
                    visibleHeaders.delete(group.id);
                }
            });
            clearTimeout(_aiScopeDebounceTimer);
            _aiScopeDebounceTimer = setTimeout(function() {
                if (visibleHeaders.size === 0) {
                    setAiScopeFromScroll(null);
                } else {
                    // Pick the first visible header in DOM order
                    var allGroups = document.querySelectorAll('#calculatorView .furniture-group');
                    for (var i = 0; i < allGroups.length; i++) {
                        if (visibleHeaders.has(allGroups[i].id)) {
                            setAiScopeFromScroll(allGroups[i].id);
                            break;
                        }
                    }
                }
            }, 300);
        }, { rootMargin: '-40% 0px -55% 0px', threshold: 0 });
    }

    // ── Render un message dans le chat ──
    function appendAiMessage(role, content, opts) {
        opts = opts || {};
        var container = document.getElementById('aiMessages');
        var div = document.createElement('div');

        if (role === 'action') {
            div.className = 'ai-msg ai-msg-action';
            div.innerHTML = '<div class="ai-action-label">Action propos\u00e9e</div>' + escapeHtml(content);
            container.appendChild(div);
        } else if (role === 'confirm') {
            div.className = 'ai-msg ai-msg-confirm';
            var confirmId = 'ai-confirm-' + Date.now();
            div.id = confirmId;
            div.innerHTML = '<div class="ai-confirm-text">' + renderAiMarkdown(content) + '</div>' +
                '<div class="ai-confirm-actions">' +
                '<button class="btn-ai-apply" onclick="aiApplyPending(\'' + confirmId + '\')">Appliquer</button>' +
                '<button class="btn-ai-dismiss" onclick="aiDismissPending(\'' + confirmId + '\')">Ignorer</button>' +
                '</div>';
            container.appendChild(div);
        } else {
            div.className = 'ai-msg ai-msg-' + role;
            if (role === 'user' && opts.images && opts.images.length > 0) {
                var imgHtml = opts.images.map(function(src) {
                    return '<img src="' + src + '" style="max-width:100%;border-radius:8px;margin-bottom:6px;">';
                }).join('');
                div.innerHTML = imgHtml + renderAiMarkdown(content);
            } else {
                div.innerHTML = renderAiMarkdown(content);
            }
            container.appendChild(div);
        }

        // Auto scroll — only if user is near the bottom (not scrolled up to read history)
        var isNearBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 80;
        if (isNearBottom) container.scrollTop = container.scrollHeight;
    }

    // ── Markdown minimal : gras, italique, listes, code, tableaux ──
    function renderAiMarkdown(text) {
        if (!text) return '';
        var s = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        // Code blocks
        s = s.replace(/```([\s\S]*?)```/g, '<pre>$1</pre>');
        // Inline code
        s = s.replace(/`([^`]+)`/g, '<code>$1</code>');
        // Bold
        s = s.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        // Italic
        s = s.replace(/\*(.+?)\*/g, '<em>$1</em>');
        // Tables → cards (with stagger animation)
        s = s.replace(/((?:\|.*\|\n?)+)/g, function(table) {
            var rows = table.trim().split('\n').filter(function(r) { return r.trim() && !/^\|[\s\-:]+\|$/.test(r); });
            if (rows.length === 0) return table;
            // Parse header to find column indices
            var headers = rows[0].split('|').filter(function(c) { return c.trim() !== ''; }).map(function(c) { return c.trim().toLowerCase(); });
            // Try to detect code/description/price columns
            var codeIdx = -1, descIdx = -1, priceIdx = -1;
            headers.forEach(function(h, i) {
                var hl = h.toLowerCase();
                if (codeIdx < 0 && (hl === 'code' || hl === 'id' || hl.indexOf('code') >= 0)) codeIdx = i;
                if (descIdx < 0 && (hl === 'description' || hl.indexOf('desc') >= 0 || hl === 'article' || hl === 'nom')) descIdx = i;
                if (priceIdx < 0 && (hl === 'prix' || hl === 'price' || hl.indexOf('prix') >= 0 || hl.indexOf('total') >= 0 || hl === 'montant')) priceIdx = i;
            });
            // If we can identify card structure (at least desc), use cards
            if (descIdx >= 0 && rows.length > 1) {
                var cards = '';
                for (var ri = 1; ri < rows.length; ri++) {
                    var cells = rows[ri].split('|').filter(function(c) { return c.trim() !== ''; }).map(function(c) { return c.trim(); });
                    var code = codeIdx >= 0 && cells[codeIdx] ? cells[codeIdx] : '';
                    var desc = cells[descIdx] || '';
                    var price = priceIdx >= 0 && cells[priceIdx] ? cells[priceIdx] : '';
                    // Collect remaining columns as meta
                    var meta = [];
                    headers.forEach(function(h, i) {
                        if (i !== codeIdx && i !== descIdx && i !== priceIdx && cells[i] && cells[i].trim()) {
                            meta.push(h.charAt(0).toUpperCase() + h.slice(1) + ': ' + cells[i]);
                        }
                    });
                    var delay = (ri - 1) * 40;
                    cards += '<div class="ai-card" style="animation-delay:' + delay + 'ms">';
                    if (code || price) {
                        cards += '<div class="ai-card-row">';
                        cards += code ? '<span class="ai-card-code">' + code + '</span>' : '<span></span>';
                        cards += price ? '<span class="ai-card-price">' + price + '</span>' : '';
                        cards += '</div>';
                    }
                    if (desc) cards += '<div class="ai-card-desc">' + desc + '</div>';
                    if (meta.length) cards += '<div class="ai-card-meta">' + meta.join(' &middot; ') + '</div>';
                    cards += '</div>';
                }
                return '<div class="ai-card-stack">' + cards + '</div>';
            }
            // Fallback: soft-styled table
            var html = '<table>';
            rows.forEach(function(row, i) {
                var cells = row.split('|').filter(function(c) { return c.trim() !== ''; });
                var tag = i === 0 ? 'th' : 'td';
                html += '<tr>' + cells.map(function(c) { return '<' + tag + '>' + c.trim() + '</' + tag + '>'; }).join('') + '</tr>';
            });
            html += '</table>';
            return html;
        });
        // Unordered lists
        s = s.replace(/^[•\-\*] (.+)$/gm, '<li>$1</li>');
        s = s.replace(/((?:<li>.*<\/li>\n?)+)/g, '<ul>$1</ul>');
        // Paragraphs
        s = s.replace(/\n{2,}/g, '</p><p>');
        s = s.replace(/\n/g, '<br>');
        s = '<p>' + s + '</p>';
        s = s.replace(/<p><\/p>/g, '');
        return s;
    }

    function showAiTyping() { document.getElementById('aiTyping').classList.add('active'); }
    function hideAiTyping() { document.getElementById('aiTyping').classList.remove('active'); }

    function aiInputKeydown(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendAiMessage();
        }
    }

    function aiQuickAction(text) {
        document.getElementById('aiInput').value = text;
        sendAiMessage();
    }

    // ── Auto-resize textarea ──
    (function() {
        document.addEventListener('input', function(e) {
            if (e.target.id === 'aiInput') {
                e.target.style.height = 'auto';
                e.target.style.height = Math.min(e.target.scrollHeight, 120) + 'px';
            }
        });
    })();

    // ── Image paste & drag-drop ──
    function setupAiImageHandlers() {
        var input = document.getElementById('aiInput');
        var dropZone = document.getElementById('aiDropZone');
        var drawer = document.getElementById('aiDrawer');

        if (input) {
            input.addEventListener('paste', function(e) {
                var items = (e.clipboardData || {}).items || [];
                for (var i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        e.preventDefault();
                        var file = items[i].getAsFile();
                        aiProcessImage(file);
                        break;
                    }
                }
            });
        }

        if (drawer) {
            drawer.addEventListener('dragover', function(e) {
                e.preventDefault();
                dropZone.classList.add('active');
            });
            drawer.addEventListener('dragleave', function(e) {
                if (!drawer.contains(e.relatedTarget)) dropZone.classList.remove('active');
            });
            drawer.addEventListener('drop', function(e) {
                e.preventDefault();
                dropZone.classList.remove('active');
                var files = e.dataTransfer.files;
                for (var i = 0; i < files.length; i++) {
                    if (files[i].type.indexOf('image') !== -1) {
                        aiProcessImage(files[i]);
                    }
                }
            });
        }
    }

    function aiProcessImage(file) {
        var reader = new FileReader();
        reader.onload = function(e) {
            // Compress via canvas
            var img = new Image();
            img.onload = function() {
                var canvas = document.createElement('canvas');
                var maxDim = 1200;
                var w = img.width, h = img.height;
                if (w > maxDim || h > maxDim) {
                    if (w > h) { h = Math.round(h * maxDim / w); w = maxDim; }
                    else { w = Math.round(w * maxDim / h); h = maxDim; }
                }
                canvas.width = w; canvas.height = h;
                canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                var dataUrl = canvas.toDataURL('image/jpeg', 0.8);
                aiPendingImages.push(dataUrl);
                renderAiImagePreviews();
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    function renderAiImagePreviews() {
        var container = document.getElementById('aiImgPreview');
        container.innerHTML = '';
        aiPendingImages.forEach(function(src, i) {
            var div = document.createElement('div');
            div.className = 'ai-img-thumb';
            div.innerHTML = '<img src="' + src + '"><button class="ai-img-remove" onclick="aiRemoveImage(' + i + ')">&times;</button>';
            container.appendChild(div);
        });
    }

    function aiRemoveImage(index) {
        aiPendingImages.splice(index, 1);
        renderAiImagePreviews();
    }

    // ── Reset chat when switching submissions ──
    function resetAiChat() {
        aiConversation = [];
        aiPendingImages = [];
        aiChatLoaded = false;
        aiClientFileCache = null;
        aiFocusGroupId = null;
        aiCurrentScope = 'project';
        var container = document.getElementById('aiMessages');
        if (container) container.innerHTML = '';
        var preview = document.getElementById('aiImgPreview');
        if (preview) preview.innerHTML = '';
    }

    // ── Collect AI context from current calculator state ──
    var aiClientFileCache = null;

    function collectRoomsSummary() {
        var rooms = [];
        document.querySelectorAll('#calculatorView .furniture-group').forEach(function(group) {
            var gid = group.id;
            var nameEl = group.querySelector('.furniture-name-input');
            var name = nameEl ? (nameEl.value.trim() || 'Sans nom') : 'Sans nom';
            var rows = group.querySelectorAll('.calc-row');
            var itemCount = 0;
            var subtotal = 0;
            rows.forEach(function(row) {
                var sel = row.querySelector('.item-select');
                if (sel && sel.value) { itemCount++; subtotal += getRowTotal(row); }
            });
            var descEl = document.getElementById(gid + '-clientDesc');
            var installCb = document.getElementById(gid + '-install');
            rooms.push({
                groupId: gid,
                roomId: roomMap[gid] || null,
                name: name,
                itemCount: itemCount,
                subtotal: Math.round(subtotal * 100) / 100,
                hasDescription: !!(descEl && descEl.value.trim()),
                installationIncluded: installCb ? installCb.checked : true
            });
        });
        return rooms;
    }

    function collectRowDims(row) {
        var rowId = row.id;
        var lEl = document.getElementById(rowId + '-dim-l');
        if (!lEl) return null;
        var l = parseFloat(lEl.value) || 0;
        var h = parseFloat(document.getElementById(rowId + '-dim-h').value) || 0;
        var p = parseFloat(document.getElementById(rowId + '-dim-p').value) || 0;
        if (!l && !h && !p) return null;
        return { l: l, h: h, p: p };
    }

    function collectRoomDetail(groupId) {
        var group = document.getElementById(groupId);
        if (!group) return null;
        var nameEl = group.querySelector('.furniture-name-input');
        var name = nameEl ? (nameEl.value.trim() || 'Sans nom') : 'Sans nom';
        var descEl = document.getElementById(groupId + '-clientDesc');
        var installCb = document.getElementById(groupId + '-install');
        var includeInstall = installCb ? installCb.checked : true;

        var items = [];
        var subtotal = 0;
        group.querySelectorAll('.calc-row').forEach(function(row, idx) {
            var sel = row.querySelector('.item-select');
            var qtyInput = row.querySelector('.qty-input');
            if (!sel || !sel.value) return;
            var qty = parseFloat(qtyInput.value) || 0;
            var selectedId = sel.value;
            var tagInput = row.querySelector('.cell-tag input');
            var tag = tagInput ? tagInput.value.trim() : '';
            if (selectedId === '__AJOUT__') {
                var descInput = row.querySelector('.ajout-description');
                var priceInput = row.querySelector('.ajout-price');
                var markupInput = row.querySelector('.ajout-markup');
                var p = parseFloat(priceInput ? priceInput.value : 0) || 0;
                var m = parseFloat(markupInput ? markupInput.value : 0) || 0;
                var lt = p * qty * (1 + m / 100);
                subtotal += lt;
                var ajoutDims = collectRowDims(row);
                items.push({ index: idx, tag: tag || null, type: 'ajout', description: descInput ? descInput.value : '', unitPrice: p, qty: qty, markup: m, lineTotal: Math.round(lt * 100) / 100, dims: ajoutDims });
            } else if (selectedId !== '__PROPOSER__') {
                var item = CATALOGUE_DATA.find(function(i) { return i.id === selectedId; });
                if (item) {
                    var composed = computeComposedPrice(item, includeInstall);
                    var effPrice = composed !== null ? composed : (item.price || 0);
                    var lt2 = effPrice * qty;
                    subtotal += lt2;
                    var catDims = collectRowDims(row);
                    items.push({
                        index: idx, tag: tag || null, type: 'catalogue', catalogueId: item.id,
                        description: item.description, itemType: item.type,
                        unitPrice: Math.round(effPrice * 100) / 100, qty: qty,
                        lineTotal: Math.round(lt2 * 100) / 100,
                        laborMinutes: item.labor_minutes || {},
                        materialCosts: item.material_costs || {},
                        dims: catDims
                    });
                }
            }
        });

        // Compute rentability inline (same logic as openRentab but returns data)
        var rentab = computeRentabilityData('room', groupId);

        return {
            groupId: groupId,
            roomId: roomMap[groupId] || null,
            name: name,
            installationIncluded: includeInstall,
            clientDescription: descEl ? descEl.value.trim() : '',
            items: items,
            subtotal: Math.round(subtotal * 100) / 100,
            rentability: rentab
        };
    }

    function computeRentabilityData(scope, groupId) {
        var rows;
        if (scope === 'project') {
            rows = document.querySelectorAll('.calc-row');
        } else {
            rows = document.querySelectorAll('#' + groupId + '-rows .calc-row');
        }
        if (!rows || rows.length === 0) return null;

        var deptMinutes = {};
        var totalMatCoutant = 0, totalMatMarkup = 0, totalMatWaste = 0;
        var totalHeuresCharge = 0, totalSalaires = 0, totalFraisFixes = 0, totalProfitMO = 0;
        var totalPrixVente = 0;

        tauxHoraires.forEach(function(t) { deptMinutes[t.department] = 0; });

        rows.forEach(function(row) {
            var select = row.querySelector('.item-select');
            var qtyInput = row.querySelector('.qty-input');
            if (!select || !qtyInput) return;
            var selectedId = select.value;
            var qty = parseFloat(qtyInput.value) || 0;
            if (!selectedId || selectedId === '__PROPOSER__') return;
            if (selectedId === '__AJOUT__') {
                var pi = row.querySelector('.ajout-price');
                var mi = row.querySelector('.ajout-markup');
                var p = parseFloat(pi ? pi.value : 0) || 0;
                var m = parseFloat(mi ? mi.value : 0) || 0;
                totalPrixVente += p * qty * (1 + m / 100);
                return;
            }
            var item = CATALOGUE_DATA.find(function(i) { return i.id === selectedId; });
            if (!item) return;
            var installCb = document.getElementById(row.id + '-install');
            var includeInstall = installCb ? installCb.checked : true;
            var laborMinutes = item.labor_minutes || {};
            var materialCosts = item.material_costs || {};

            tauxHoraires.forEach(function(t) {
                var dept = t.department;
                var mins = (laborMinutes[dept] || 0) * qty;
                if (!includeInstall && dept === 'Installation') return;
                deptMinutes[dept] = (deptMinutes[dept] || 0) + mins;
                var hours = mins / 60;
                totalHeuresCharge += hours * (t.taux_horaire || 0);
                totalSalaires += hours * (t.salaire || 0);
                totalFraisFixes += hours * (t.frais_fixe || 0);
                totalProfitMO += hours * ((t.taux_horaire || 0) - (t.salaire || 0) - (t.frais_fixe || 0));
            });

            expenseCategories.forEach(function(c) {
                var cost = (materialCosts[c.name] || 0) * qty;
                totalMatCoutant += cost;
                totalMatMarkup += cost * ((c.markup || 0) / 100);
                totalMatWaste += cost * ((c.waste || 0) / 100);
            });

            // Fallback: si pas de données composées, utiliser item.price
            var composedPrice = computeComposedPrice(item, includeInstall);
            if (composedPrice === null) {
                totalPrixVente += (item.price || 0) * qty;
            }
        });

        totalPrixVente += totalHeuresCharge + totalMatCoutant + totalMatWaste + totalMatMarkup;
        var profitNet = totalProfitMO + totalMatMarkup;
        var margeReelle = totalPrixVente > 0 ? (profitNet / totalPrixVente * 100) : 0;

        return {
            prixVente: Math.round(totalPrixVente * 100) / 100,
            coutMateriaux: Math.round(totalMatCoutant * 100) / 100,
            perteMateriaux: Math.round(totalMatWaste * 100) / 100,
            markupMateriaux: Math.round(totalMatMarkup * 100) / 100,
            heuresCharge: Math.round(totalHeuresCharge * 100) / 100,
            salaires: Math.round(totalSalaires * 100) / 100,
            fraisFixes: Math.round(totalFraisFixes * 100) / 100,
            profitMO: Math.round(totalProfitMO * 100) / 100,
            profitNet: Math.round(profitNet * 100) / 100,
            margeReelle: Math.round(margeReelle * 10) / 10,
            margeVisee: 38,
            heuresParDept: deptMinutes
        };
    }

    function buildCatalogueSummary() {
        if (!CATALOGUE_DATA || CATALOGUE_DATA.length === 0) return '';
        var cats = {};
        CATALOGUE_DATA.forEach(function(item) {
            if (!item.in_calculator) return;
            var cat = item.category || 'Autre';
            if (!cats[cat]) cats[cat] = [];
            var typeTag = item.item_type === 'fabrication' ? '[Fab] ' : item.item_type === 'materiau' ? '[Mat] ' : '';
            var line = (item.is_default ? '\u2605 ' : '') + typeTag + item.id + ': ' + (item.description || '').substring(0, 60) + ' (' + (item.type || '') + ' ' + (item.price || 0) + '$)';
            if (item.client_text) line += ' \u2192 client: "' + item.client_text + '"';
            cats[cat].push(line);
        });
        var lines = [];
        Object.keys(cats).forEach(function(cat) {
            lines.push('### ' + cat);
            cats[cat].forEach(function(line) { lines.push('- ' + line); });
        });
        return lines.join('\n');
    }

    async function loadClientFile() {
        if (aiClientFileCache) return aiClientFileCache;
        if (!currentProject || !currentProject.client_name) return null;
        try {
            var clientName = currentProject.client_name.trim();
            // Search contacts by name match
            var parts = clientName.split(' ');
            var firstName = parts[0] || '';
            var lastName = parts.slice(1).join(' ') || '';
            var query = SUPABASE_URL + '/rest/v1/contacts?select=*,contact_companies(role,companies(name,notes))';
            if (lastName) {
                query += '&first_name=ilike.' + encodeURIComponent(firstName + '%') + '&last_name=ilike.' + encodeURIComponent(lastName + '%');
            } else {
                query += '&or=(first_name.ilike.' + encodeURIComponent('%' + firstName + '%') + ',last_name.ilike.' + encodeURIComponent('%' + firstName + '%') + ')';
            }
            var r = await authenticatedFetch(query, {});
            if (!r.ok) return null;
            var contacts = await r.json();
            if (contacts.length === 0) return null;
            var c = contacts[0];
            var companies = (c.contact_companies || []).map(function(cc) {
                return cc.companies ? cc.companies.name : null;
            }).filter(Boolean);
            var companyNotes = (c.contact_companies || []).map(function(cc) {
                return cc.companies && cc.companies.notes ? cc.companies.notes : null;
            }).filter(Boolean);

            // Load recent communications
            var commR = await authenticatedFetch(SUPABASE_URL + '/rest/v1/communications?contact_id=eq.' + c.id + '&order=comm_date.desc&limit=5&select=comm_type,direction,subject,content,comm_date', {});
            var comms = commR.ok ? await commR.json() : [];
            var commStr = comms.map(function(cm) {
                return (cm.direction === 'outgoing' ? '→' : '←') + ' ' + (cm.comm_type || '') + ': ' + (cm.subject || cm.content || '').substring(0, 100);
            }).join('\n');

            aiClientFileCache = {
                name: c.first_name + ' ' + c.last_name,
                email: c.email || '',
                phone: c.phone || '',
                company: companies.join(', '),
                notes: c.notes || '',
                preferences: c.preferred_contact || '',
                companyNotes: companyNotes.join('; '),
                history: commStr || 'Aucune communication récente'
            };
            return aiClientFileCache;
        } catch (e) {
            console.warn('[AI] Could not load client file:', e);
            return null;
        }
    }

    async function collectAiContext() {
        var clientFile = await loadClientFile();

        // Load benchmarks from app_config if not already cached
        var benchmarks = null;
        try {
            var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/app_config?key=eq.ai_benchmarks&select=value', {});
            if (r.ok) {
                var rows = await r.json();
                if (rows.length > 0) benchmarks = rows[0].value;
            }
        } catch (e) { /* ignore */ }

        return {
            project: currentProject ? {
                name: currentProject.name,
                client: currentProject.client_name,
                designer: currentProject.designer,
                address: currentProject.client_address
            } : null,
            submission: currentSubmission ? {
                id: currentSubmission.id,
                number: currentSubmission.submission_number,
                status: currentSubmission.status,
                title: currentSubmission.title
            } : null,
            rooms: collectRoomsSummary(),
            focusRoomDetail: aiCurrentScope === 'room' && aiFocusGroupId ? collectRoomDetail(aiFocusGroupId) : null,
            tauxHoraires: tauxHoraires,
            expenseCategories: expenseCategories,
            grandTotal: calculerGrandTotal(),
            catalogueSummary: buildCatalogueSummary(),
            clientFile: clientFile,
            benchmarks: benchmarks,
            defaultMaterials: getDefaultMaterials(),
            tagPrefixes: tagPrefixes,
            aiReferenceImageUrls: collectAiReferenceImageUrls(),
            calculationRules: (CATALOGUE_DATA || [])
                .filter(function(item) { return item.calculation_rule_ai; })
                .map(function(item) { return { id: item.id, description: item.description, type: item.type, rule: item.calculation_rule_ai }; })
        };
    }

    function collectAiReferenceImageUrls() {
        var urls = [];
        var groups = document.querySelectorAll('#calculatorView .furniture-group');
        groups.forEach(function(group) {
            var gid = group.id;
            var nameEl = group.querySelector('.furniture-name-input');
            var roomName = nameEl ? nameEl.value.trim() : 'Sans nom';
            (groupImages[gid] || []).forEach(function(img) {
                if (img.aiReference && (img.url || img.dataUrl)) {
                    urls.push({ url: img.url || img.dataUrl, room: roomName });
                }
            });
        });
        return urls;
    }

    var aiFocusGroupId = null;

    // ── Call AI Edge Function ──
    var _aiRetried401 = false;
    async function callAiAssistant(messages, context) {
        var resp = await authenticatedFetch(SUPABASE_URL + '/functions/v1/ai-assistant', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ messages: messages, context: context })
        });
        if (!resp.ok) {
            var errText = await resp.text().catch(function() { return ''; });
            // Auto-retry on 401 auth error (force token refresh + one more try)
            if (resp.status === 401 && !_aiRetried401) {
                _aiRetried401 = true;
                if (await refreshAccessToken()) {
                    var result = await callAiAssistant(messages, context);
                    _aiRetried401 = false;
                    return result;
                }
                throw new Error('Session expirée — veuillez vous reconnecter');
            }
            _aiRetried401 = false;
            try {
                var errObj = JSON.parse(errText);
                throw new Error(errObj.error || errObj.msg || errObj.message || 'Erreur ' + resp.status);
            } catch(e) { if (e.message) throw e; throw new Error('Erreur ' + resp.status); }
        }
        var data = await resp.json();
        return data;
    }

    // ── Build API message content (text + images) ──
    function buildUserContent(text, images) {
        if (!images || images.length === 0) return text;
        // Multi-modal: array of content blocks
        var content = [];
        images.forEach(function(dataUrl) {
            var match = dataUrl.match(/^data:(.*?);base64,(.*)$/);
            if (match) {
                content.push({
                    type: 'image',
                    source: { type: 'base64', media_type: match[1], data: match[2] }
                });
            }
        });
        if (text) content.push({ type: 'text', text: text });
        return content;
    }

    // ── Main send function ──
    var aiPendingToolCalls = null; // stores pending tool_use blocks for confirmation

    async function sendAiMessage() {
        var input = document.getElementById('aiInput');
        var text = input.value.trim();
        if (!text && aiPendingImages.length === 0) return;

        var images = aiPendingImages.slice();
        aiPendingImages = [];
        renderAiImagePreviews();
        input.value = '';
        input.style.height = 'auto';

        appendAiMessage('user', text || '(image)', { images: images });

        // Build the user message for API (user images + AI reference images)
        var userContent = buildUserContent(text, images);

        // Include AI reference images from rooms (as URL sources)
        var refImgs = collectAiReferenceImageUrls();
        if (refImgs.length > 0) {
            // Convert to array format if it's just text
            if (typeof userContent === 'string') {
                userContent = [{ type: 'text', text: userContent }];
            }
            refImgs.forEach(function(ref) {
                if (ref.url && !ref.url.startsWith('data:')) {
                    userContent.unshift({
                        type: 'image',
                        source: { type: 'url', url: ref.url }
                    });
                }
            });
            // Add context about which rooms the images are from
            var refLabel = refImgs.map(function(r) { return r.room; }).join(', ');
            userContent.push({ type: 'text', text: '[Images de référence des pièces: ' + refLabel + ']' });
        }

        aiConversation.push({ role: 'user', content: userContent });

        // Save user message to DB
        saveAiChatMessage('user', text, images);

        showAiTyping();
        document.getElementById('aiSendBtn').disabled = true;

        try {
            var context = await collectAiContext();
            var data = await callAiAssistant(aiConversation, context);

            // Process response blocks
            var contentBlocks = data.content || [];
            var textParts = [];
            var toolCalls = [];

            contentBlocks.forEach(function(block) {
                if (block.type === 'text') textParts.push(block.text);
                if (block.type === 'tool_use') toolCalls.push(block);
            });

            // Add assistant response to conversation
            aiConversation.push({ role: 'assistant', content: contentBlocks });

            if (toolCalls.length > 0) {
                // Mode simulation: show text + confirm buttons, don't execute tools yet
                var fullText = textParts.join('\n');
                if (fullText) appendAiMessage('assistant', fullText);

                // Store pending tool calls
                aiPendingToolCalls = { tools: toolCalls, conversationSnapshot: aiConversation.length };
                appendAiMessage('confirm', formatPendingActions(toolCalls));

                saveAiChatMessage('assistant', fullText + '\n[Actions proposées - en attente de confirmation]', []);
            } else {
                // Pure text response
                var fullText = textParts.join('\n');
                appendAiMessage('assistant', fullText);
                saveAiChatMessage('assistant', fullText, []);
            }
        } catch (err) {
            appendAiMessage('assistant', 'Erreur : ' + err.message);
        } finally {
            hideAiTyping();
            document.getElementById('aiSendBtn').disabled = false;
            maybeAutoSummarize(); // async, fire-and-forget
        }
    }

    function formatPendingActions(toolCalls) {
        return toolCalls.map(function(tc) {
            switch (tc.name) {
                case 'write_description':
                    return 'Écrire la description de **' + (tc.input.room_name || '?') + '**';
                case 'add_catalogue_item':
                    return 'Ajouter **' + (tc.input.catalogue_item_id || '?') + '** × ' + (tc.input.quantity || 1) + ' à **' + (tc.input.room_name || '?') + '**';
                case 'update_item_quantity':
                    return 'Modifier quantité ligne ' + tc.input.item_index + ' → ' + tc.input.new_quantity + ' dans **' + (tc.input.room_name || '?') + '**';
                case 'analyze_rentability':
                    return 'Analyser la rentabilité (' + (tc.input.scope || 'projet') + ')';
                case 'suggest_items':
                    return 'Rechercher articles : ' + (tc.input.query || '?');
                case 'compare_versions':
                    return 'Comparer versions ' + tc.input.version_a + ' et ' + tc.input.version_b;
                default:
                    return tc.name + ': ' + JSON.stringify(tc.input);
            }
        }).join('\n');
    }

    // ── Apply / dismiss pending tool actions ──
    async function aiApplyPending(confirmId) {
        var el = document.getElementById(confirmId);
        if (!el || !aiPendingToolCalls) return;
        el.querySelector('.ai-confirm-actions').innerHTML = '<span class="ai-confirm-applied">Application en cours...</span>';

        try {
            var toolResults = [];
            var addItemIndex = 0;
            for (var i = 0; i < aiPendingToolCalls.tools.length; i++) {
                var tc = aiPendingToolCalls.tools[i];
                if (tc.name === 'add_catalogue_item') {
                    tc.input._staggerIndex = addItemIndex++;
                }
                var result = await executeAiTool(tc.name, tc.input);
                toolResults.push({ type: 'tool_result', tool_use_id: tc.id, content: JSON.stringify(result) });
                appendAiMessage('action', toolActionLabel(tc.name, tc.input));
            }
            // Pulse on totals after batch
            if (addItemIndex > 0) {
                setTimeout(function() { pulseTotals(); }, addItemIndex * 50 + 250);
            }

            // Continue conversation with tool results
            aiConversation.push({ role: 'user', content: toolResults });
            showAiTyping();

            var freshContext = await collectAiContext();
            var data = await callAiAssistant(aiConversation, freshContext);
            var contentBlocks = data.content || [];
            aiConversation.push({ role: 'assistant', content: contentBlocks });

            var text = contentBlocks.filter(function(b) { return b.type === 'text'; }).map(function(b) { return b.text; }).join('\n');
            if (text) {
                appendAiMessage('assistant', text);
                saveAiChatMessage('assistant', text, []);
            }

            el.querySelector('.ai-confirm-actions').innerHTML = '<span class="ai-confirm-applied">Appliqué \u2713</span>';
        } catch (err) {
            el.querySelector('.ai-confirm-actions').innerHTML = '<span style="color:#c62828;font-size:11px;">Erreur: ' + escapeHtml(err.message) + '</span>';
        } finally {
            aiPendingToolCalls = null;
            hideAiTyping();
        }
    }

    function aiDismissPending(confirmId) {
        var el = document.getElementById(confirmId);
        if (!el) return;
        el.querySelector('.ai-confirm-actions').innerHTML = '<span style="font-size:11px;color:#999;">Ignoré</span>';
        aiPendingToolCalls = null;
    }

    function toolActionLabel(name, input) {
        switch (name) {
            case 'write_description': return 'Description mise à jour : ' + (input.room_name || '');
            case 'add_catalogue_item': return 'Article ajouté : ' + (input.catalogue_item_id || '') + ' × ' + (input.quantity || 1);
            case 'update_item_quantity': return 'Quantité modifiée : ligne ' + input.item_index + ' → ' + input.new_quantity;
            case 'analyze_rentability': return 'Analyse de rentabilité effectuée';
            case 'suggest_items': return 'Recherche catalogue effectuée';
            case 'compare_versions': return 'Comparaison de versions effectuée';
            default: return name;
        }
    }

    // ── Tool execution (client-side) ──
    async function executeAiTool(name, input) {
        switch (name) {
            case 'analyze_rentability': {
                if (input.scope === 'room' && input.room_name) {
                    var gid = findGroupIdByName(input.room_name);
                    if (!gid) return { error: 'Pièce introuvable: ' + input.room_name };
                    return computeRentabilityData('room', gid);
                }
                return computeRentabilityData('project');
            }
            case 'write_description': {
                var gid = findGroupIdByName(input.room_name);
                if (!gid) return { error: 'Pièce introuvable: ' + input.room_name };
                var textarea = document.getElementById(gid + '-clientDesc');
                if (textarea) {
                    textarea.value = input.description_html;
                    saveClientDescription(gid);
                    return { success: true, room: input.room_name };
                }
                return { error: 'Textarea introuvable' };
            }
            case 'add_catalogue_item': {
                var gid = findGroupIdByName(input.room_name);
                if (!gid) return { error: 'Pièce introuvable: ' + input.room_name };
                var rowId = addRow(gid, { staggerIndex: input._staggerIndex || 0 });
                // Wait for Supabase item creation (async in addRow) before updating
                var waitAttempts = 0;
                while (!itemMap[rowId] && waitAttempts < 50) {
                    await new Promise(function(r) { setTimeout(r, 100); });
                    waitAttempts++;
                }
                if (!itemMap[rowId]) return { error: 'Échec création ligne Supabase' };
                var select = document.querySelector('#' + rowId + ' .item-select');
                if (select) {
                    select.value = input.catalogue_item_id;
                    updateRow(rowId);
                    var qtyInput = document.getElementById(rowId + '-qty');
                    if (qtyInput && input.quantity) {
                        qtyInput.value = input.quantity;
                        updateRow(rowId);
                    }
                }
                if (input.tag) {
                    var tagInput = document.getElementById(rowId + '-tag');
                    if (tagInput) {
                        tagInput.value = input.tag.toUpperCase();
                        saveRowTag(rowId);
                    }
                }
                updateGrandTotal();
                return { success: true, rowId: rowId, room: input.room_name, tag: input.tag || null };
            }
            case 'update_item_quantity': {
                var gid = findGroupIdByName(input.room_name);
                if (!gid) return { error: 'Pièce introuvable: ' + input.room_name };
                var rows = document.querySelectorAll('#' + gid + '-rows .calc-row');
                var targetRow = rows[input.item_index];
                if (!targetRow) return { error: 'Ligne ' + input.item_index + ' introuvable' };
                var qtyInput = targetRow.querySelector('.qty-input');
                if (qtyInput) {
                    qtyInput.value = input.new_quantity;
                    updateRow(targetRow.id);
                }
                updateGrandTotal();
                return { success: true, room: input.room_name, index: input.item_index, newQty: input.new_quantity };
            }
            case 'suggest_items': {
                var q = (input.query || '').toLowerCase();
                var results = CATALOGUE_DATA.filter(function(item) {
                    if (!item.in_calculator) return false;
                    return (item.description || '').toLowerCase().indexOf(q) !== -1 ||
                           (item.category || '').toLowerCase().indexOf(q) !== -1 ||
                           (item.id || '').toLowerCase().indexOf(q) !== -1;
                }).slice(0, 10).map(function(item) {
                    return { id: item.id, description: item.description, category: item.category, type: item.type, price: item.price };
                });
                return { results: results };
            }
            case 'compare_versions': {
                if (!currentSubmission) return { error: 'Pas de soumission courante' };
                try {
                    var rA = await authenticatedFetch(SUPABASE_URL + '/rest/v1/project_versions?submission_id=eq.' + currentSubmission.id + '&version_number=eq.' + input.version_a + '&select=snapshot', {});
                    var rB = await authenticatedFetch(SUPABASE_URL + '/rest/v1/project_versions?submission_id=eq.' + currentSubmission.id + '&version_number=eq.' + input.version_b + '&select=snapshot', {});
                    if (!rA.ok || !rB.ok) return { error: 'Versions introuvables' };
                    var dataA = await rA.json();
                    var dataB = await rB.json();
                    if (dataA.length === 0 || dataB.length === 0) return { error: 'Version(s) introuvable(s)' };
                    var snapA = dataA[0].snapshot;
                    var snapB = dataB[0].snapshot;
                    return {
                        versionA: input.version_a,
                        versionB: input.version_b,
                        totalA: snapA.total,
                        totalB: snapB.total,
                        roomCountA: (snapA.meubles || []).length,
                        roomCountB: (snapB.meubles || []).length,
                        roomsA: (snapA.meubles || []).map(function(m) { return { name: m.name, subtotal: m.subtotal, items: m.items.length }; }),
                        roomsB: (snapB.meubles || []).map(function(m) { return { name: m.name, subtotal: m.subtotal, items: m.items.length }; })
                    };
                } catch (e) { return { error: e.message }; }
            }
            default:
                return { error: 'Tool inconnu: ' + name };
        }
    }

    function findGroupIdByName(name) {
        if (!name) return null;
        var lowerName = name.toLowerCase().trim();
        var groups = document.querySelectorAll('#calculatorView .furniture-group');
        for (var i = 0; i < groups.length; i++) {
            var nameEl = groups[i].querySelector('.furniture-name-input');
            if (nameEl && nameEl.value.toLowerCase().trim() === lowerName) return groups[i].id;
        }
        // Partial match fallback
        for (var i = 0; i < groups.length; i++) {
            var nameEl = groups[i].querySelector('.furniture-name-input');
            if (nameEl && nameEl.value.toLowerCase().indexOf(lowerName) !== -1) return groups[i].id;
        }
        return null;
    }

    // ── Save / Load chat messages (Supabase) ──
    async function saveAiChatMessage(role, content, images) {
        if (!currentSubmission) return;
        try {
            await authenticatedFetch(SUPABASE_URL + '/rest/v1/chat_messages', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                body: JSON.stringify({
                    submission_id: currentSubmission.id,
                    role: role,
                    content: content || '',
                    image_urls: (images || []).length > 0 ? ['(image attachée)'] : []
                })
            });
        } catch (e) { console.warn('[AI] Failed to save chat message:', e); }
    }

    async function loadAiChat(submissionId) {
        try {
            var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/chat_messages?submission_id=eq.' + submissionId + '&order=created_at.desc&limit=20&select=role,content,created_at', {});
            if (!r.ok) return;
            var msgs = await r.json();
            if (msgs.length === 0) return;

            // Reverse to chronological order
            msgs.reverse();

            // If there's a summary, show it first
            var container = document.getElementById('aiMessages');
            container.innerHTML = '';

            msgs.forEach(function(msg) {
                if (msg.role === 'summary') {
                    var div = document.createElement('div');
                    div.className = 'ai-msg ai-msg-action';
                    div.innerHTML = '<div class="ai-action-label">Résumé de la conversation précédente</div>' + renderAiMarkdown(msg.content);
                    container.appendChild(div);
                } else {
                    appendAiMessage(msg.role, msg.content);
                }
            });

            // Rebuild aiConversation from loaded messages
            aiConversation = [];
            msgs.forEach(function(msg) {
                if (msg.role === 'summary') {
                    // Inject summary as a system-ish context at start
                    aiConversation.push({ role: 'user', content: '[Résumé conversation précédente: ' + msg.content + ']' });
                    aiConversation.push({ role: 'assistant', content: 'Compris, je continue avec ce contexte.' });
                } else if (msg.role === 'user' || msg.role === 'assistant') {
                    aiConversation.push({ role: msg.role, content: msg.content });
                }
            });
        } catch (e) { console.warn('[AI] Failed to load chat:', e); }
    }

    // ── Auto-summarize when conversation gets long ──
    async function maybeAutoSummarize() {
        if (!currentSubmission) return;
        // Count messages in DB
        try {
            var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/chat_messages?submission_id=eq.' + currentSubmission.id + '&select=id', {});
            if (!r.ok) return;
            var msgs = await r.json();
            if (msgs.length < 25) return;

            // Get the oldest messages to summarize (all except last 5)
            var r2 = await authenticatedFetch(SUPABASE_URL + '/rest/v1/chat_messages?submission_id=eq.' + currentSubmission.id + '&order=created_at.asc&limit=' + (msgs.length - 5) + '&select=id,role,content', {});
            if (!r2.ok) return;
            var oldMsgs = await r2.json();

            // Build text to summarize
            var textToSummarize = oldMsgs.map(function(m) { return m.role + ': ' + (m.content || '').substring(0, 300); }).join('\n');

            // Call AI to generate summary
            var summaryResp = await callAiAssistant([
                { role: 'user', content: 'Résume cette conversation en 3-5 points clés. Sois concis et factuel. Ne commence pas par "Voici un résumé".\n\n' + textToSummarize }
            ], { project: { name: currentProject?.name }, submission: { number: currentSubmission?.submission_number } });

            var summaryText = (summaryResp.content || []).filter(function(b) { return b.type === 'text'; }).map(function(b) { return b.text; }).join('\n');

            if (summaryText) {
                // Delete old messages
                var idsToDelete = oldMsgs.map(function(m) { return m.id; });
                await authenticatedFetch(SUPABASE_URL + '/rest/v1/chat_messages?id=in.(' + idsToDelete.join(',') + ')', { method: 'DELETE' });

                // Insert summary
                await authenticatedFetch(SUPABASE_URL + '/rest/v1/chat_messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                    body: JSON.stringify({
                        submission_id: currentSubmission.id,
                        role: 'summary',
                        content: summaryText
                    })
                });
            }
        } catch (e) { console.warn('[AI] Auto-summarize failed:', e); }
    }

    // Init image handlers after DOM ready
    document.addEventListener('DOMContentLoaded', function() {
        setupAiImageHandlers();
    });

    // ═══════════════════════════════════════════════════════════════════════
    // MATÉRIAUX PAR DÉFAUT (JSONB dans submissions.default_materials)
    // ═══════════════════════════════════════════════════════════════════════
    // Structure: [ { type: "Caisson", catalogue_item_id: "uuid", description: "Mélamine blanc ME1" }, ... ]

    var DM_TYPES = ['Caisson', 'Façades et panneaux apparents', 'Tiroirs', 'Poignées', 'Éclairage', 'Autre'];
    var dmActiveAC = null; // currently open autocomplete index

    function toggleDefaultMaterials() {
        var body = document.getElementById('dmBody');
        var arrow = document.getElementById('dmArrow');
        var isCollapsed = body.classList.toggle('collapsed');
        arrow.classList.toggle('open', !isCollapsed);
        localStorage.setItem('dmPanelCollapsed', isCollapsed ? '1' : '0');
        if (!isCollapsed) renderDefaultMaterials();
    }

    function restoreDmPanelState() {
        var saved = localStorage.getItem('dmPanelCollapsed');
        // Default collapsed (saved is null or '1')
        var shouldCollapse = saved !== '0';
        var body = document.getElementById('dmBody');
        var arrow = document.getElementById('dmArrow');
        if (body) body.classList.toggle('collapsed', shouldCollapse);
        if (arrow) arrow.classList.toggle('open', !shouldCollapse);
        if (!shouldCollapse) renderDefaultMaterials();
    }

    function getDefaultMaterials() {
        var raw = (currentSubmission && currentSubmission.default_materials);
        // Migrate old object format to new array format
        if (raw && !Array.isArray(raw)) {
            var arr = [];
            Object.keys(raw).forEach(function(cat) {
                (raw[cat] || []).forEach(function(entry) {
                    if (entry.material) arr.push({ type: cat, catalogue_item_id: null, description: entry.material });
                });
            });
            return arr;
        }
        return raw || [];
    }

    function renderDefaultMaterials() {
        var dm = getDefaultMaterials();
        var body = document.getElementById('dmBody');
        var html = '<div class="dm-rows" id="dmRows">';
        dm.forEach(function(entry, idx) {
            html += renderDmRow(idx, entry);
        });
        html += '</div>';
        html += '<button class="dm-add-btn" onclick="addDefaultMaterial()">+ Ajouter un mat&eacute;riau par d&eacute;faut</button>';
        body.innerHTML = html;
    }

    function renderDmRow(idx, entry) {
        var typeOptions = DM_TYPES.map(function(t) {
            return '<option value="' + escapeAttr(t) + '"' + (entry.type === t ? ' selected' : '') + '>' + escapeHtml(t) + '</option>';
        }).join('');
        // Show client_text if the catalogue item has one, otherwise fall back to stored description
        var displayLabel = entry.description || '';
        if (entry.catalogue_item_id) {
            var catItem = (CATALOGUE_DATA || []).find(function(i) { return i.id === entry.catalogue_item_id; });
            if (catItem && catItem.client_text) displayLabel = catItem.client_text;
        }
        return '<div class="dm-row" data-dm-idx="' + idx + '">' +
            '<select onchange="updateDmType(' + idx + ',this.value)">' + typeOptions + '</select>' +
            '<div class="dm-search-wrap">' +
                '<input type="text" value="' + escapeAttr(displayLabel) + '" placeholder="Rechercher dans le catalogue..." ' +
                    'oninput="dmSearchCatalogue(' + idx + ',this)" ' +
                    'onfocus="dmSearchCatalogue(' + idx + ',this)" ' +
                    'onkeydown="dmSearchKeydown(event,' + idx + ')" ' +
                    (entry.catalogue_item_id ? 'class="dm-resolved"' : '') + '>' +
                '<div class="dm-autocomplete" id="dmAC-' + idx + '"></div>' +
            '</div>' +
            '<button class="dm-remove" onclick="removeDmEntry(' + idx + ')" title="Supprimer">&times;</button>' +
            '</div>';
    }

    function addDefaultMaterial() {
        var dm = getDefaultMaterials();
        dm.push({ type: DM_TYPES[0], catalogue_item_id: null, description: '' });
        if (currentSubmission) currentSubmission.default_materials = dm;
        saveDefaultMaterials(dm);
        renderDefaultMaterials();
        // Focus the new search input
        var rows = document.querySelectorAll('.dm-row');
        if (rows.length > 0) {
            var lastInput = rows[rows.length - 1].querySelector('.dm-search-wrap input');
            if (lastInput) lastInput.focus();
        }
    }

    function updateDmType(idx, newType) {
        var dm = getDefaultMaterials();
        if (!dm[idx]) return;
        dm[idx].type = newType;
        if (currentSubmission) currentSubmission.default_materials = dm;
        saveDefaultMaterials(dm);
    }

    function dmSearchCatalogue(idx, input) {
        var query = input.value.trim().toLowerCase();
        var acDiv = document.getElementById('dmAC-' + idx);
        if (!acDiv) return;

        // Mark as unresolved when user edits
        input.classList.remove('dm-resolved');

        var items = CATALOGUE_DATA || [];
        var results;
        if (query.length < 2) {
            // No query: show all items grouped by category (browseable)
            results = items.slice(0, 50);
        } else {
            // Filter by query — search client_text, description, and category
            results = items.filter(function(item) {
                var desc = (item.description || '').toLowerCase();
                var ct = (item.client_text || '').toLowerCase();
                var cat = (item.category || '').toLowerCase();
                return ct.indexOf(query) !== -1 || desc.indexOf(query) !== -1 || cat.indexOf(query) !== -1;
            }).slice(0, 30);
        }

        if (results.length === 0) {
            acDiv.innerHTML = '<div class="dm-ac-item" style="color:#999;cursor:default;">Aucun r&eacute;sultat</div>';
            acDiv.classList.add('open');
            dmActiveAC = idx;
            return;
        }

        // Group by category for display
        var grouped = {};
        results.forEach(function(item) {
            var cat = item.category || 'Autre';
            if (!grouped[cat]) grouped[cat] = [];
            grouped[cat].push(item);
        });

        var html = '';
        var globalIdx = 0;
        Object.keys(grouped).forEach(function(cat) {
            html += '<div style="padding:4px 10px;font-size:10px;font-weight:700;color:#888;background:#f9f9f9;text-transform:uppercase;letter-spacing:0.3px;position:sticky;top:0;">' + escapeHtml(cat) + '</div>';
            grouped[cat].forEach(function(item) {
                var displayName = item.client_text || item.description;
                var secondary = item.client_text && item.client_text !== item.description ? item.description : '';
                html += '<div class="dm-ac-item" data-idx="' + globalIdx + '" ' +
                    'onmousedown="dmSelectItem(' + idx + ',\'' + escapeAttr(item.id) + '\',\'' + escapeAttr(displayName) + '\')">' +
                    '<span>' + escapeHtml(displayName) + '</span>' +
                    (secondary ? '<span class="dm-ac-secondary">' + escapeHtml(secondary) + '</span>' : '') +
                    '</div>';
                globalIdx++;
            });
        });
        acDiv.innerHTML = html;
        acDiv.classList.add('open');
        dmActiveAC = idx;
    }

    function dmSearchKeydown(e, idx) {
        var acDiv = document.getElementById('dmAC-' + idx);
        if (!acDiv || !acDiv.classList.contains('open')) return;
        var items = acDiv.querySelectorAll('.dm-ac-item[data-idx]');
        var activeIdx = -1;
        items.forEach(function(el, i) { if (el.classList.contains('active')) activeIdx = i; });

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            activeIdx = Math.min(activeIdx + 1, items.length - 1);
            items.forEach(function(el, i) { el.classList.toggle('active', i === activeIdx); });
            if (items[activeIdx]) items[activeIdx].scrollIntoView({ block: 'nearest' });
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            activeIdx = Math.max(activeIdx - 1, 0);
            items.forEach(function(el, i) { el.classList.toggle('active', i === activeIdx); });
            if (items[activeIdx]) items[activeIdx].scrollIntoView({ block: 'nearest' });
        } else if (e.key === 'Enter') {
            e.preventDefault();
            if (activeIdx >= 0 && items[activeIdx]) items[activeIdx].dispatchEvent(new Event('mousedown'));
        } else if (e.key === 'Escape') {
            acDiv.classList.remove('open');
            dmActiveAC = null;
        }
    }

    function dmSelectItem(idx, itemId, itemDesc) {
        var dm = getDefaultMaterials();
        if (!dm[idx]) return;
        dm[idx].catalogue_item_id = itemId;
        dm[idx].description = itemDesc;
        if (currentSubmission) currentSubmission.default_materials = dm;
        saveDefaultMaterials(dm);
        // Update input visually
        var row = document.querySelector('.dm-row[data-dm-idx="' + idx + '"]');
        if (row) {
            var input = row.querySelector('.dm-search-wrap input');
            if (input) { input.value = itemDesc; input.classList.add('dm-resolved'); }
            var ac = document.getElementById('dmAC-' + idx);
            if (ac) { ac.classList.remove('open'); ac.innerHTML = ''; }
        }
        dmActiveAC = null;
    }

    function removeDmEntry(idx) {
        var dm = getDefaultMaterials();
        var label = (dm[idx] && dm[idx].description) ? dm[idx].description : 'ce matériau';
        steleConfirm('Supprimer « ' + label + ' » ?').then(function(ok) {
            if (!ok) return;
            var dm2 = getDefaultMaterials();
            dm2.splice(idx, 1);
            if (currentSubmission) currentSubmission.default_materials = dm2;
            saveDefaultMaterials(dm2);
            renderDefaultMaterials();
        });
    }

    var dmSaveTimer = null;
    function saveDefaultMaterials(dm) {
        clearTimeout(dmSaveTimer);
        dmSaveTimer = setTimeout(function() {
            if (!currentSubmission) return;
            authenticatedFetch(SUPABASE_URL + '/rest/v1/submissions?id=eq.' + currentSubmission.id, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                body: JSON.stringify({ default_materials: dm })
            }).then(function() { showSaveIndicator(); }).catch(function(e) { console.warn('[DM] Save failed:', e); });
        }, 500);
    }

    // Close autocomplete when clicking outside
    document.addEventListener('click', function(e) {
        if (dmActiveAC !== null && !e.target.closest('.dm-search-wrap')) {
            var ac = document.getElementById('dmAC-' + dmActiveAC);
            if (ac) { ac.classList.remove('open'); ac.innerHTML = ''; }
            dmActiveAC = null;
        }
    });

    // ═══════════════════════════════════════════════════════════════════════
    // PIÈCES & ARTICLES — CRUD SUPABASE
    // ═══════════════════════════════════════════════════════════════════════

    async function loadSubmissionRooms(submissionId) {
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/project_rooms?submission_id=eq.' + submissionId + '&order=sort_order&select=*,room_items(*)', {});
        if (!r.ok) return [];
        const rooms = await r.json();
        rooms.forEach(room => {
            if (room.room_items) room.room_items.sort((a, b) => a.sort_order - b.sort_order);
        });
        return rooms;
    }

    // Legacy — keep for transition
    async function loadProjectRooms(projectId) {
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/project_rooms?project_id=eq.' + projectId + '&order=sort_order&select=*,room_items(*)', {});
        if (!r.ok) return [];
        const rooms = await r.json();
        rooms.forEach(room => {
            if (room.room_items) room.room_items.sort((a, b) => a.sort_order - b.sort_order);
        });
        return rooms;
    }

    async function createRoom(submissionId, name, sortOrder) {
        var payload = { submission_id: submissionId, name: name || '', sort_order: sortOrder || 0 };
        // Also set project_id for transition period
        if (currentProject) payload.project_id = currentProject.id;
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/project_rooms', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
            body: JSON.stringify(payload)
        });
        if (!r.ok) return null;
        const data = await r.json();
        return data[0];
    }

    async function updateRoom(roomId, fields) {
        await authenticatedFetch(SUPABASE_URL + '/rest/v1/project_rooms?id=eq.' + roomId, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
            body: JSON.stringify(fields)
        });
    }

    async function deleteRoom(roomId) {
        await authenticatedFetch(SUPABASE_URL + '/rest/v1/project_rooms?id=eq.' + roomId, {
            method: 'DELETE'
        });
    }

    async function createItem(roomId, itemData) {
        const payload = Object.assign({ room_id: roomId }, itemData);
        const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/room_items', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
            body: JSON.stringify(payload)
        });
        if (!r.ok) return null;
        const data = await r.json();
        return data[0];
    }

    async function updateItem(itemId, fields) {
        await authenticatedFetch(SUPABASE_URL + '/rest/v1/room_items?id=eq.' + itemId, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
            body: JSON.stringify(fields)
        });
    }

    async function deleteItem(itemId) {
        await authenticatedFetch(SUPABASE_URL + '/rest/v1/room_items?id=eq.' + itemId, {
            method: 'DELETE'
        });
    }

    // ═══════════════════════════════════════════════════════════════════════
    // MOTEUR CASCADE — Phase 3
    // ═══════════════════════════════════════════════════════════════════════

    var cascadeParentMap = {};   // cascadeParentMap[childRowId] = parentRowId
    var _cascadeRunning = false; // guard against re-entrancy

    /**
     * Évaluateur de formules sécurisé.
     * Variables : L, H, P (dimensions en pouces), QTY (quantité du parent)
     * Fonctions : ceil, floor, round, min, max
     */
    function evalFormula(expr, vars) {
        if (!expr) return null;
        var safe = String(expr).replace(/\b(L|H|P|QTY)\b/g, function(m) {
            return (vars[m] != null) ? Number(vars[m]) : 0;
        });
        safe = safe.replace(/\bceil\b/g, 'Math.ceil')
                   .replace(/\bfloor\b/g, 'Math.floor')
                   .replace(/\bround\b/g, 'Math.round')
                   .replace(/\bmin\b/g, 'Math.min')
                   .replace(/\bmax\b/g, 'Math.max');
        var check = safe.replace(/Math\.\w+/g, '').replace(/[\d\s+\-*/.(),><=!&|]/g, '');
        if (check.length > 0) { console.warn('[Cascade] Formule non sécuritaire:', expr, '→', check); return null; }
        try { return new Function('return ' + safe)(); }
        catch (e) { console.error('[Cascade] Erreur formule:', expr, e); return null; }
    }

    /** Trouver les enfants cascade d'un parent (lookup dans cascadeParentMap) */
    function findCascadeChildren(parentRowId) {
        var children = [];
        for (var childRowId in cascadeParentMap) {
            if (cascadeParentMap[childRowId] === parentRowId) {
                var row = document.getElementById(childRowId);
                var select = row ? row.querySelector('.item-select') : null;
                children.push({ rowId: childRowId, catalogueId: select ? select.value : null });
            }
        }
        return children;
    }

    /** Remonter la chaîne parent pour trouver les dimensions L/H/P de la racine fabrication */
    function getRootDimsForCascade(rowId) {
        var visited = {};
        var current = rowId;
        while (cascadeParentMap[current] && !visited[current]) {
            visited[current] = true;
            current = cascadeParentMap[current];
        }
        // current = racine (le row fabrication avec les dims)
        var dimL = document.getElementById(current + '-dim-l');
        var dimH = document.getElementById(current + '-dim-h');
        var dimP = document.getElementById(current + '-dim-p');
        return {
            L: dimL ? (parseFloat(dimL.value) || 0) : 0,
            H: dimH ? (parseFloat(dimH.value) || 0) : 0,
            P: dimP ? (parseFloat(dimP.value) || 0) : 0
        };
    }

    /**
     * Moteur cascade récursif.
     * Exécute les règles `cascade` du calculation_rule_ai de l'article sélectionné.
     * Crée/met à jour/supprime les lignes enfants automatiquement.
     */
    async function executeCascade(parentRowId, depth) {
        depth = depth || 0;
        if (depth >= 3) return;
        if (!itemMap[parentRowId]) return;

        var row = document.getElementById(parentRowId);
        if (!row) return;
        var select = row.querySelector('.item-select');
        var qtyInput = row.querySelector('.qty-input');
        if (!select || !qtyInput) return;

        var selectedId = select.value;
        var catItem = CATALOGUE_DATA.find(function(i) { return i.id === selectedId; });
        var rules = catItem && catItem.calculation_rule_ai && catItem.calculation_rule_ai.cascade;
        if (!rules || !Array.isArray(rules) || rules.length === 0) {
            // Pas de règles cascade → supprimer les enfants existants
            var orphans = findCascadeChildren(parentRowId);
            orphans.forEach(function(c) { removeRow(c.rowId); });
            return;
        }

        // Dimensions : si ce row a ses propres dims, les utiliser ; sinon remonter la chaîne
        var dims = getRootDimsForCascade(parentRowId);
        // Si c'est un row avec dims propres (fabrication), les utiliser directement
        var ownL = document.getElementById(parentRowId + '-dim-l');
        if (ownL) {
            dims.L = parseFloat(ownL.value) || 0;
            var ownH = document.getElementById(parentRowId + '-dim-h');
            dims.H = ownH ? (parseFloat(ownH.value) || 0) : dims.H;
            var ownP = document.getElementById(parentRowId + '-dim-p');
            dims.P = ownP ? (parseFloat(ownP.value) || 0) : dims.P;
        }
        var parentQty = parseFloat(qtyInput.value) || 0;
        var vars = { L: dims.L, H: dims.H, P: dims.P, QTY: parentQty };

        // Au moins une dimension doit exister pour exécuter la cascade
        if (dims.L === 0 && dims.H === 0 && dims.P === 0 && parentQty === 0) return;

        var groupId = row.dataset.group;
        var parentItemId = itemMap[parentRowId];
        var existingChildren = findCascadeChildren(parentRowId);
        var matchedChildRowIds = [];

        // Tag du parent à hériter
        var parentTagEl = document.getElementById(parentRowId + '-tag');
        var parentTag = parentTagEl ? parentTagEl.value : '';

        for (var ri = 0; ri < rules.length; ri++) {
            var rule = rules[ri];
            if (!rule.target) continue; // target null = AI (pas JS)

            // Évaluer la condition
            if (rule.condition) {
                var condResult = evalFormula(rule.condition, vars);
                if (!condResult) continue;
            }

            // Calculer la quantité
            var qty = evalFormula(rule.qty, vars);
            if (qty === null || qty <= 0) continue;
            qty = Math.round(qty * 100) / 100; // arrondir à 2 décimales

            // Chercher un enfant existant avec le même target
            var existing = null;
            for (var ei = 0; ei < existingChildren.length; ei++) {
                if (existingChildren[ei].catalogueId === rule.target) {
                    existing = existingChildren[ei];
                    break;
                }
            }

            if (existing) {
                // Mettre à jour la quantité de l'enfant existant
                var childRow = document.getElementById(existing.rowId);
                if (childRow) {
                    var childQty = childRow.querySelector('.qty-input');
                    if (childQty && parseFloat(childQty.value) !== qty) {
                        childQty.value = qty;
                        updateRow(existing.rowId);
                    }
                }
                matchedChildRowIds.push(existing.rowId);
            } else {
                // Créer une nouvelle ligne enfant
                var newRowId = addRow(groupId, { skipFocus: true, cascade: true });

                // Attendre que itemMap soit peuplé (async createItem)
                var waitAttempts = 0;
                while (!itemMap[newRowId] && waitAttempts < 50) {
                    await new Promise(function(r) { setTimeout(r, 80); });
                    waitAttempts++;
                }
                if (!itemMap[newRowId]) {
                    console.error('[Cascade] Timeout création ligne pour', rule.target);
                    continue;
                }

                // Enregistrer le lien parent
                cascadeParentMap[newRowId] = parentRowId;
                updateItem(itemMap[newRowId], { parent_item_id: parentItemId });

                // Sélectionner l'article cible
                var childRow2 = document.getElementById(newRowId);
                var childSelect = childRow2 ? childRow2.querySelector('.item-select') : null;
                if (childSelect) childSelect.value = rule.target;
                var childQtyInput = childRow2 ? childRow2.querySelector('.qty-input') : null;
                if (childQtyInput) childQtyInput.value = qty;

                // Hériter le tag du parent
                if (parentTag) {
                    var childTagInput = document.getElementById(newRowId + '-tag');
                    if (childTagInput) childTagInput.value = parentTag;
                }

                updateRow(newRowId);
                matchedChildRowIds.push(newRowId);
            }
        }

        // Supprimer les enfants orphelins (plus dans les règles actuelles)
        existingChildren.forEach(function(c) {
            if (matchedChildRowIds.indexOf(c.rowId) === -1) {
                removeRow(c.rowId);
            }
        });

        // Récursion : chaque enfant peut avoir ses propres règles cascade
        for (var ci = 0; ci < matchedChildRowIds.length; ci++) {
            await executeCascade(matchedChildRowIds[ci], depth + 1);
        }
    }

    var debouncedCascade = debounce(function(rowId) {
        if (_cascadeRunning) return;
        _cascadeRunning = true;
        executeCascade(rowId, 0).finally(function() { _cascadeRunning = false; });
    }, 800);

    async function createVersion(submissionId) {
        // Trouver le prochain numéro de version (par project_id pour respecter la contrainte unique)
        var versionQuery = currentProject
            ? SUPABASE_URL + '/rest/v1/project_versions?project_id=eq.' + currentProject.id + '&order=version_number.desc&limit=1&select=version_number'
            : SUPABASE_URL + '/rest/v1/project_versions?submission_id=eq.' + submissionId + '&order=version_number.desc&limit=1&select=version_number';
        const r = await authenticatedFetch(versionQuery, {});
        let nextVersion = 1;
        if (r.ok) {
            const data = await r.json();
            if (data.length > 0) nextVersion = data[0].version_number + 1;
        }

        const snapshot = collecterDonneesCalculateur();
        const userId = localStorage.getItem('sb_user_id');

        var projectId = currentProject ? currentProject.id : (currentSubmission ? currentSubmission.project_id : null);
        var payload = {
            submission_id: submissionId,
            project_id: projectId,
            version_number: nextVersion,
            snapshot: snapshot,
            status_at_save: currentSubmission ? currentSubmission.status : 'draft',
            created_by: userId
        };

        var vr = await authenticatedFetch(SUPABASE_URL + '/rest/v1/project_versions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
            body: JSON.stringify(payload)
        });
        if (!vr.ok) {
            var errText = await vr.text().catch(function() { return ''; });
            console.error('createVersion failed:', vr.status, errText);
            throw new Error('Erreur version: ' + vr.status + ' ' + errText);
        }

        // Update current_version on submission
        await updateSubmission(submissionId, { current_version: nextVersion });
        if (currentSubmission) currentSubmission.current_version = nextVersion;
    }

    // ═══════════════════════════════════════════════════════════════════════
    // REFRESH AUTOMATIQUE DU TOKEN
    // ═══════════════════════════════════════════════════════════════════════

    var _refreshPromise = null;

    function isTokenExpiringSoon(token, bufferSec) {
        if (!token) return true;
        try { var p = JSON.parse(atob(token.split('.')[1])); return p.exp < (Date.now() / 1000 + (bufferSec || 300)); }
        catch(e) { return true; }
    }

    async function refreshAccessToken() {
        if (_refreshPromise) return _refreshPromise;
        _refreshPromise = (async function() {
            var rt = localStorage.getItem('sb_refresh_token');
            if (!rt) return false;
            try {
                var r = await fetch(SUPABASE_URL + '/auth/v1/token?grant_type=refresh_token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'apikey': SUPABASE_KEY },
                    body: JSON.stringify({ refresh_token: rt })
                });
                if (!r.ok) return false;
                var d = await r.json();
                if (d.access_token) {
                    localStorage.setItem('sb_access_token', d.access_token);
                    localStorage.setItem('sb_refresh_token', d.refresh_token);
                    return true;
                }
                return false;
            } catch(e) { return false; }
        })();
        var result = await _refreshPromise;
        _refreshPromise = null;
        return result;
    }

    async function authenticatedFetch(url, options) {
        options = options || {};
        var token = localStorage.getItem('sb_access_token');
        if (isTokenExpiringSoon(token, 300)) {
            if (await refreshAccessToken()) token = localStorage.getItem('sb_access_token');
        }
        var headers = Object.assign({}, options.headers || {}, {
            'apikey': SUPABASE_KEY,
            'Authorization': 'Bearer ' + token
        });
        var resp = await fetch(url, Object.assign({}, options, { headers: headers }));
        if (resp.status === 401 || resp.status === 403) {
            if (await refreshAccessToken()) {
                headers['Authorization'] = 'Bearer ' + localStorage.getItem('sb_access_token');
                resp = await fetch(url, Object.assign({}, options, { headers: headers }));
            }
            if (resp.status === 401 || resp.status === 403) {
                localStorage.removeItem('sb_access_token');
            }
        }
        return resp;
    }
    </script>

    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-size: 16px;
            line-height: 1.5;
        }

        /* HEADER SCOPEWRIGHT STANDARD */
        .nav-bar {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: 56px;
            background: var(--sw-surface);
            border-bottom: 1px solid var(--sw-border);
            padding: 0 60px;
            display: flex;
            align-items: center;
            gap: var(--sw-space-3);
            z-index: 100;
        }
        .nav-logo {
            font-size: 23px;
            font-weight: 650;
            letter-spacing: -0.025em;
            line-height: 1;
            color: var(--sw-navy);
            text-decoration: none;
        }
        .nav-back {
            color: var(--sw-text);
            text-decoration: none;
            font-size: 13px;
            font-weight: 400;
            opacity: 0.45;
            transition: opacity var(--sw-ease);
            white-space: nowrap;
        }
        .nav-back:hover { opacity: 0.8; }

        .data-status {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            padding: 6px 12px;
            border-radius: 20px;
            background: #f5f5f5;
        }
        .data-status.online { background: #e8f5e9; color: #2e7d32; }
        .data-status.offline { background: #fff3e0; color: #ef6c00; }
        .data-status.error { background: #ffebee; color: #c62828; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; }
        .data-status.online .status-dot { background: #4caf50; }
        .data-status.offline .status-dot { background: #ff9800; }
        .data-status.error .status-dot { background: #f44336; }
        .status-text { white-space: nowrap; }

        /* Main content */
        .main-content {
            margin-top: 56px;
            padding: 40px 60px 60px;
        }

        .page-title {
            font-size: 32px;
            font-weight: 400;
            margin-bottom: 8px;
        }

        .page-subtitle {
            font-size: 14px;
            color: #666;
            margin-bottom: 32px;
        }

        /* ═══════════════════════════════════════════════════════════════
           CALCULATEUR STYLES
           ═══════════════════════════════════════════════════════════════ */

        .calculator-container {
            max-width: 1200px;
        }

        .calc-header {
            display: grid;
            grid-template-columns: 30px 55px 1fr 90px 90px 140px 110px 100px 30px 120px 30px;
            gap: 6px;
            padding: 8px 10px;
            background: transparent;
            color: #888;
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            border-bottom: 1px solid #e0e0e0;
        }

        .calc-header span {
            display: flex;
            align-items: center;
        }
        .calc-header .sortable {
            cursor: pointer; user-select: none; gap: 3px;
        }
        .calc-header .sortable:hover { color: var(--sw-navy); }
        .calc-header .sort-arrow { font-size: 9px; opacity: 0.4; }
        .calc-header .sortable.sort-active .sort-arrow { opacity: 1; color: var(--sw-navy); }

        .calc-header .col-center { justify-content: center; }
        .calc-header .col-right { justify-content: flex-end; }

        .calc-rows {
            border-top: none;
        }

        .calc-row {
            display: grid;
            grid-template-columns: 30px 55px 1fr 90px 90px 140px 110px 100px 30px 120px 30px;
            gap: 6px;
            padding: 6px 10px;
            align-items: center;
            border-bottom: 1px solid #eee;
            background: var(--sw-surface);
            transition: background-color 0.15s ease;
        }
        .calc-row.cascade-child {
            border-left: 2px solid var(--stele-green);
            margin-left: 6px;
            background: #f8faf9;
        }
        .calc-row.cascade-child .cell-add .btn-add { visibility: hidden; }
        .cascade-badge {
            font-size: 9px; background: #e2e8f0; color: #475569;
            padding: 1px 5px; border-radius: 3px; margin-left: 4px;
            vertical-align: middle; letter-spacing: 0.02em;
        }
        .cell-tag input {
            width: 100%; padding: 4px 6px; font-size: 11px; font-family: monospace;
            border: 1px solid #e0e0e0; border-radius: 4px; text-align: center;
            text-transform: uppercase; font-weight: 600; color: var(--sw-navy);
        }
        .cell-tag input:focus { border-color: var(--sw-navy); outline: none; }
        .cell-tag input::placeholder { color: #ccc; font-weight: 400; }

        /* ── Combobox autocomplete ── */
        .combobox { position: relative; display: flex; align-items: center; gap: 3px; }
        .combobox-input {
            width: 100%; padding: 5px 8px; font-size: 11px; border: 1px solid #e0e0e0;
            border-radius: 4px; background: #fff; cursor: text;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .combobox-input:focus { border-color: var(--sw-navy); outline: none; }
        .combobox-input::placeholder { color: #aaa; }
        .combobox-input.has-value { font-weight: 500; color: var(--sw-navy); }
        .btn-edit-cat {
            flex-shrink: 0; width: 22px; height: 22px; border: none; background: none;
            cursor: pointer; font-size: 12px; color: #94a3b8; border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-edit-cat:hover { background: #f1f5f9; color: var(--sw-navy); }

        .cb-dropdown {
            position: fixed; z-index: 9999; background: #fff;
            border: 1px solid #e2e8f0; border-radius: 10px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.12); max-height: 340px;
            overflow-y: auto; min-width: 320px;
            animation: sdFadeIn 120ms ease-out;
        }
        .cb-dropdown .cb-search {
            position: sticky; top: 0; background: #fff; padding: 8px; border-bottom: 1px solid #f1f5f9;
        }
        .cb-dropdown .cb-search input {
            width: 100%; padding: 6px 10px; font-size: 12px; border: 1px solid #e2e8f0;
            border-radius: 6px; outline: none;
        }
        .cb-dropdown .cb-search input:focus { border-color: var(--sw-navy); }
        .cb-group-label {
            padding: 6px 12px 3px; font-size: 10px; font-weight: 600;
            color: #94a3b8; text-transform: uppercase; letter-spacing: 0.04em;
        }
        .cb-item {
            padding: 6px 12px; cursor: pointer; font-size: 12px;
            display: flex; align-items: center; gap: 8px;
            border-radius: 6px; margin: 1px 4px;
        }
        .cb-item:hover, .cb-item.cb-active { background: #f1f5f9; }
        .cb-item-code { color: #94a3b8; font-size: 10px; font-family: monospace; min-width: 60px; }
        .cb-item-desc { flex: 1; color: #0f172a; }
        .cb-item-type { color: #94a3b8; font-size: 10px; }
        .cb-item-special { color: var(--sw-navy); font-weight: 500; }
        .cb-empty { padding: 12px; text-align: center; color: #94a3b8; font-size: 12px; }

        .calc-row:nth-child(even) { background: #fafafa; }
        .calc-row:last-child { border-bottom: none; }

        /* ── Row insertion animation ── */
        @keyframes rowEnter {
            from { opacity: 0; transform: translateY(8px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        @keyframes rowHighlight {
            from { background-color: #F8FAFC; }
            to   { background-color: inherit; }
        }
        .calc-row.row-entering {
            animation: rowEnter 200ms ease-out forwards, rowHighlight 600ms ease-out 200ms forwards;
        }
        /* Total pulse after batch insert */
        @keyframes totalPulse {
            0%   { transform: scale(1); }
            50%  { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        .total-pulse {
            animation: totalPulse 300ms ease-out;
        }
        .calc-row:hover { background: #f5f5f5; }

        .btn-add {
            width: 20px;
            height: 20px;
            border: 1.5px solid var(--sw-navy);
            background: var(--sw-surface);
            color: var(--sw-navy);
            border-radius: 50%;
            font-size: 14px;
            font-weight: 400;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
            line-height: 1;
        }

        .btn-add:hover {
            background: var(--sw-navy);
            color: var(--sw-surface);
        }

        .btn-remove {
            width: 20px;
            height: 20px;
            border: none;
            background: transparent;
            color: var(--sw-border);
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color 0.15s ease;
            border-radius: 4px;
        }

        .btn-remove:hover {
            color: #c0392b;
            background: #fdeaea;
        }

        .item-select {
            width: 100%;
            padding: 4px 8px;
            font-size: 11px;
            font-family: inherit;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #fff;
            color: var(--sw-text);
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%230A0203' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            padding-right: 28px;
        }

        .item-select:focus {
            outline: none;
            border-color: var(--sw-navy);
        }

        .cell-code, .cell-type, .cell-unit-price {
            font-size: 11px;
            color: var(--sw-text);
        }

        .cell-code {
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            font-size: 11px;
            color: #666;
            position: relative;
            cursor: help;
        }

        .cell-type { text-align: center; }
        .cell-unit-price { text-align: right; }

        .cell-dims {
            display: flex;
            align-items: center;
            gap: 2px;
            font-size: 10px;
            color: #94a3b8;
        }
        .cell-dims input {
            width: 36px;
            padding: 3px 2px;
            font-size: 10px;
            text-align: center;
            border: 1px solid #e0e0e0;
            border-radius: 3px;
            background: #fff;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
        }
        .cell-dims input:focus { border-color: var(--sw-navy); outline: none; }
        .cell-dims input::placeholder { color: #d4d4d4; }
        .cell-dims .dim-sep { color: #cbd5e1; font-size: 9px; }
        .cell-dims.dims-hidden { justify-content: center; }

        /* Tooltip styles */
        .tooltip-container {
            position: relative;
            cursor: help;
        }

        .tooltip {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--sw-text);
            color: var(--sw-surface);
            padding: 10px 14px;
            border-radius: 4px;
            font-size: 12px;
            line-height: 1.5;
            white-space: normal;
            width: 240px;
            text-align: left;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: opacity 0.2s ease, visibility 0.2s ease;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }

        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--sw-text);
        }

        .tooltip-container:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        .tooltip-img {
            width: 100%;
            border-radius: 3px;
            margin-bottom: 8px;
        }

        .tooltip-title { font-weight: 700; margin-bottom: 4px; font-size: 12px; }
        .tooltip-text { font-weight: 400; color: rgba(255,255,255,0.85); }

        .qty-input {
            width: 100%;
            padding: 5px 8px;
            font-size: 12px;
            font-family: inherit;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            background: #fff;
        }

        .qty-input:focus { outline: none; border-color: var(--sw-navy); }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }

        .cell-total {
            font-size: 12px;
            font-weight: 600;
            text-align: right;
            color: var(--sw-text);
        }

        .add-row-container {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: none;
            background: var(--sw-surface);
        }

        .add-row-text { font-size: 13px; color: #999; }

        .grand-total-container {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 20px 16px;
            background: var(--sw-text);
            border-radius: 0 0 4px 4px;
            margin-top: -1px;
        }

        .grand-total-label {
            font-size: 16px;
            font-weight: 700;
            color: var(--sw-surface);
            margin-right: 24px;
        }

        .grand-total-amount {
            font-size: 24px;
            font-weight: 700;
            color: var(--sw-surface);
            min-width: 140px;
            text-align: right;
        }

        /* ── Tag filter bar ── */
        .tag-filter-bar {
            display: flex; align-items: center; gap: 6px; padding: 8px 12px;
            background: #f5f5f5; border-radius: 6px; margin-bottom: 12px; flex-wrap: wrap;
        }
        .tag-filter-bar .tag-filter-label {
            font-size: 11px; font-weight: 600; color: #888; text-transform: uppercase;
            letter-spacing: 0.3px; margin-right: 4px;
        }
        .tag-filter-chip {
            padding: 4px 10px; border: 1px solid #ddd; border-radius: 12px;
            font-size: 11px; font-weight: 600; cursor: pointer; background: #fff;
            color: #555; transition: all 0.15s; font-family: monospace;
        }
        .tag-filter-chip:hover { border-color: var(--sw-navy); color: var(--sw-navy); }
        .tag-filter-chip.active {
            background: var(--sw-navy); color: #fff; border-color: var(--sw-navy);
        }
        .tag-filter-chip.chip-all {
            font-family: inherit; font-weight: 500;
        }
        .calc-row.tag-hidden { display: none !important; }

        /* ── Rentab tag breakdown ── */
        .rentab-tag-section { margin-top: 16px; }
        .rentab-tag-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px; margin-top: 10px;
        }
        .rentab-tag-card {
            border: 1px solid #eee; border-radius: 6px; padding: 12px;
            background: #fafafa;
        }
        .rentab-tag-card-title {
            font-size: 13px; font-weight: 700; color: var(--sw-navy);
            margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 6px;
        }
        .rentab-tag-card table { width: 100%; font-size: 12px; }
        .rentab-tag-card td { padding: 2px 0; }
        .rentab-tag-card td:last-child { text-align: right; font-family: monospace; }
        .rentab-tag-card .tag-card-total { font-weight: 700; border-top: 1px solid #ddd; padding-top: 4px; }

        /* Sections meuble */
        .furniture-group {
            margin-bottom: 28px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e0e0e0;
            border-top: none;
            box-shadow: 0 1px 4px rgba(0,0,0,0.06);
        }

        .btn-collapse {
            background: none;
            border: none;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            font-size: 12px;
            padding: 4px;
            transition: transform 0.2s;
            line-height: 1;
        }

        .btn-collapse:hover { color: #fff; }

        .furniture-group.collapsed .btn-collapse {
            transform: rotate(-90deg);
        }

        .furniture-group.collapsed .calc-header,
        .furniture-group.collapsed .calc-rows,
        .furniture-group.collapsed .group-images-section,
        .furniture-group.collapsed .client-description-section {
            display: none;
        }

        .furniture-group-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            background: var(--sw-navy);
            color: var(--sw-surface);
            border-radius: 8px 8px 0 0;
        }

        .furniture-group-header .group-label {
            font-size: 13px;
            font-weight: 700;
            white-space: nowrap;
        }

        .furniture-name-input {
            flex: 1;
            padding: 7px 12px;
            font-size: 14px;
            font-family: inherit;
            font-weight: 600;
            border: none;
            border-radius: 4px;
            background: rgba(255,255,255,0.2);
            color: var(--sw-surface);
        }

        .furniture-name-input::placeholder { color: rgba(255,255,255,0.6); }
        .furniture-name-input:focus { outline: none; background: rgba(255,255,255,0.3); }

        .install-toggle {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            white-space: nowrap;
            font-size: 12px;
            color: rgba(255,255,255,0.85);
        }
        .install-toggle input[type="checkbox"] {
            width: 14px;
            height: 14px;
            cursor: pointer;
            accent-color: var(--sw-surface);
        }
        .install-label {
            font-weight: 500;
        }
        .install-toggle-project {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            white-space: nowrap;
            font-size: 12px;
            font-weight: 500;
        }
        .install-toggle-project input[type="checkbox"] {
            width: 14px;
            height: 14px;
            cursor: pointer;
            accent-color: var(--sw-navy);
        }
        .install-toggle-row {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .install-toggle-row input[type="checkbox"] {
            width: 12px;
            height: 12px;
            cursor: pointer;
            accent-color: var(--sw-navy);
        }

        .btn-remove-group {
            padding: 5px 12px;
            background: transparent;
            color: rgba(255,255,255,0.7);
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            font-size: 12px;
            font-family: inherit;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.15s;
        }

        .btn-remove-group:hover {
            background: rgba(255,255,255,0.15);
            color: var(--sw-surface);
            border-color: rgba(255,255,255,0.6);
        }

        .group-subtotal-container {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 14px 16px;
            background: #f5f7f5;
            border-top: 1px solid #e8e8e8;
        }

        .group-subtotal-label {
            font-size: 13px;
            font-weight: 600;
            color: #666;
            margin-right: 20px;
        }

        .group-subtotal-amount {
            font-size: 17px;
            font-weight: 700;
            color: var(--sw-text);
            min-width: 120px;
            text-align: right;
        }

        .group-images-section {
            padding: 14px 16px;
            background: #f9f9f9;
            border-top: 1px solid #eee;
        }

        .group-images-header {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            margin-bottom: 8px;
        }

        .group-image-drop-zone {
            padding: 12px;
        }

        .group-image-drop-zone .image-drop-zone-text {
            font-size: 11px;
        }

        /* Description client par pièce */
        .client-description-section {
            padding: 10px 16px 12px; background: #fff; border-top: 1px solid #eee;
        }
        .client-desc-label {
            display: block; font-size: 12px; font-weight: 600; color: #444;
            margin-bottom: 6px;
        }
        .client-desc-textarea {
            width: 100%; padding: 8px 12px; border: 1px solid #e8e8e8; border-radius: 6px;
            font-family: inherit; font-size: 13px; resize: vertical; min-height: 40px;
            background: #fafafa; color: #333; line-height: 1.5;
        }
        .client-desc-textarea:focus { outline: none; border-color: var(--sw-navy); background: #fff; }

        /* Toggle showInQuote sur images */
        .image-quote-toggle {
            position: absolute; bottom: 2px; left: 2px; display: flex; align-items: center; gap: 2px;
            background: rgba(0,0,0,0.6); color: #fff; padding: 1px 4px; border-radius: 3px;
            font-size: 9px; cursor: pointer;
        }
        .image-quote-toggle input[type="checkbox"] { width: 11px; height: 11px; margin: 0; }
        .image-ai-toggle {
            position: absolute; bottom: 2px; right: 2px; display: flex; align-items: center; gap: 2px;
            background: rgba(11,18,32,0.75); color: #fff; padding: 1px 4px; border-radius: 3px;
            font-size: 9px; cursor: pointer;
        }
        .image-ai-toggle input[type="checkbox"] { width: 11px; height: 11px; margin: 0; }

        /* Exclusions */
        .exclusions-section {
            margin-top: 16px; padding: 14px 16px; background: #fafafa;
            border: 1px solid #e8e8e8; border-radius: 8px;
        }

        .btn-add-group {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 14px 20px;
            margin-bottom: 20px;
            background: var(--sw-surface);
            color: var(--sw-navy);
            border: 2px dashed #b5c4b8;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            width: 100%;
            justify-content: center;
        }

        .btn-add-group:hover { background: #edf0f5; border-color: var(--sw-navy); }

        .calc-disclaimer {
            margin-top: 24px;
            padding: 16px;
            background: var(--sw-border-2);
            border-radius: 4px;
            font-size: 13px;
            color: #666;
            font-style: italic;
        }

        .btn-pdf {
            display: none; /* Hidden - replaced by timeline CTA */
        }

        /* Ajout personnalis&eacute; */
        .ajout-description:focus,
        .ajout-price:focus,
        .ajout-markup:focus { outline: none; border-color: var(--sw-navy); }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-y: auto;
        }
        #steleDialogOverlay { z-index: 9999; }

        .modal-overlay.active { display: flex; }

        .modal {
            background: var(--sw-surface);
            border-radius: 8px;
            width: 100%;
            max-width: 450px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--sw-border);
            flex-shrink: 0;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--sw-text);
        }

        .modal-body { padding: 24px; overflow-y: auto; flex: 1; }

        .form-group { margin-bottom: 16px; }
        .form-group:last-child { margin-bottom: 0; }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--sw-text);
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            font-size: 14px;
            font-family: inherit;
            border: 1px solid var(--sw-border);
            border-radius: 4px;
            background: var(--sw-surface);
        }

        .form-input:focus { outline: none; border-color: var(--sw-navy); }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--sw-border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            flex-shrink: 0;
        }

        .btn-cancel {
            padding: 10px 20px;
            background: transparent;
            color: var(--sw-text);
            border: 1px solid var(--sw-border);
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-cancel:hover { background: var(--sw-border-2); }

        .btn-generate {
            padding: 10px 20px;
            background: var(--sw-navy);
            color: var(--sw-surface);
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-generate:hover { background: #3d4f42; }

        /* Modal edit (large) */
        .modal.modal-edit {
            max-width: 800px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        .modal.modal-edit .modal-body { overflow-y: auto; }
        .edit-row { display: flex; gap: 12px; }
        .edit-row .form-group { flex: 1; }

        /* Prix composé */
        .composed-price-section { display: flex; gap: 16px; margin-top: 8px; }
        .cp-table-wrap { flex: 1; min-width: 0; }
        .cp-section-title {
            font-size: 12px; font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.5px; color: var(--sw-navy);
            margin-bottom: 10px; padding-bottom: 6px; border-bottom: 1px solid #f0f0f0;
        }
        .cp-sub-title { font-size: 11px; font-weight: 600; color: #555; margin-bottom: 6px; }
        .cp-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .cp-table th { text-align: left; font-weight: 600; font-size: 11px; color: #888; padding: 4px 6px; border-bottom: 1px solid #e0e0e0; }
        .cp-table th:last-child { text-align: right; }
        .cp-table td { padding: 3px 6px; }
        .cp-table td:first-child { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 140px; font-size: 11px; }
        .cp-table input[type="number"] { width: 100%; padding: 4px 6px; border: 1px solid #e0e0e0; border-radius: 3px; font-size: 12px; text-align: right; font-family: inherit; }
        .cp-table input[type="number"]:focus { outline: none; border-color: var(--sw-navy); }
        .cp-table input[type="number"]:disabled { background: #f0f0f0; color: #999; cursor: not-allowed; }
        .cp-calculated {
            margin-top: 12px; padding: 10px 14px; background: #f8f8f4;
            border-radius: 6px; display: flex; justify-content: space-between;
            align-items: center; font-size: 14px;
        }
        .cp-calculated .cp-total-label { font-weight: 600; color: #555; }
        .cp-calculated .cp-total-value { font-weight: 700; font-size: 16px; color: var(--sw-navy); }
        .cp-calculated .cp-breakdown { font-size: 11px; color: #888; margin-left: 8px; }

        /* Médias tagués */
        .cat-media-title {
            font-size: 12px; font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.5px; color: var(--sw-navy);
            margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #f0f0f0;
        }
        .cat-dropzone {
            border: 2px dashed var(--sw-border); border-radius: 6px; padding: 16px;
            text-align: center; cursor: pointer; transition: border-color 0.2s;
            font-size: 13px; color: #888; margin-bottom: 12px;
        }
        .cat-dropzone:hover, .cat-dropzone.dragover { border-color: var(--sw-navy); color: var(--sw-navy); }
        .cat-media-list { display: flex; flex-direction: column; gap: 10px; }
        .cat-media-item { display: flex; gap: 10px; padding: 10px; background: #f8f8f8; border-radius: 6px; align-items: flex-start; }
        .cat-media-item img { width: 80px; height: 60px; object-fit: cover; border-radius: 4px; border: 1px solid var(--sw-border); flex-shrink: 0; }
        .cat-pdf-icon { width: 80px; height: 60px; background: #e8e8e8; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; color: #999; flex-shrink: 0; }
        .cat-media-info { flex: 1; min-width: 0; }
        .cat-media-tags { display: flex; flex-wrap: wrap; gap: 5px; }
        .cat-tag { display: inline-block; font-size: 11px; padding: 3px 8px; border-radius: 12px; cursor: pointer; border: 1px solid var(--sw-border); background: #fff; color: #666; transition: all 0.15s; user-select: none; }
        .cat-tag.active { background: var(--sw-navy); color: #fff; border-color: var(--sw-navy); }
        .cat-media-remove { background: none; border: none; color: #c62828; cursor: pointer; font-size: 18px; padding: 0 4px; flex-shrink: 0; opacity: 0.5; transition: opacity 0.15s; }
        .cat-media-remove:hover { opacity: 1; }

        /* Toggle switch */
        .edit-toggle-row { display: flex; align-items: center; gap: 10px; }
        .edit-toggle { position: relative; display: inline-block; width: 38px; height: 22px; }
        .edit-toggle input { opacity: 0; width: 0; height: 0; }
        .edit-toggle .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: #ddd; border-radius: 22px; transition: background 0.25s; }
        .edit-toggle .slider::before { content: ''; position: absolute; height: 16px; width: 16px; left: 3px; bottom: 3px; background: #fff; border-radius: 50%; transition: transform 0.25s; box-shadow: 0 1px 3px rgba(0,0,0,0.15); }
        .edit-toggle input:checked + .slider { background: var(--sw-navy); }
        .edit-toggle input:checked + .slider::before { transform: translateX(16px); }
        .edit-toggle-label { font-size: 13px; color: var(--sw-text); }

        .edit-status { font-size: 13px; padding: 8px 12px; border-radius: 4px; margin-top: 8px; display: none; }
        .edit-status.success { display: block; background: #e8f5e9; color: #2e7d32; }
        .edit-status.error { display: block; background: #ffebee; color: #c62828; }

        @media (max-width: 768px) {
            .composed-price-section { flex-direction: column; }
            .modal.modal-edit { max-width: 98vw; }
        }

        /* Image zone */
        .image-drop-zone {
            border: 2px dashed var(--sw-border);
            border-radius: 6px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
            margin-top: 4px;
        }

        .image-drop-zone:hover,
        .image-drop-zone.dragover {
            border-color: var(--sw-navy);
            background: #edf1f7;
        }

        .image-drop-zone-text { font-size: 12px; color: #888; }
        .image-drop-zone-text strong { color: #555; }

        .image-previews {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .image-preview-item {
            position: relative;
            width: 90px;
            height: 90px;
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid #ddd;
        }

        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-preview-remove {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(0,0,0,0.6);
            color: #fff;
            border: none;
            cursor: pointer;
            font-size: 12px;
            line-height: 20px;
            text-align: center;
            padding: 0;
        }

        .image-preview-remove:hover { background: rgba(200,0,0,0.8); }
        .image-count { font-size: 11px; color: #888; margin-top: 4px; }

        .image-preview-item img { cursor: pointer; }

        /* Lightbox */
        .lightbox-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }

        .lightbox-overlay.active { display: flex; }

        .lightbox-overlay img {
            max-width: 90vw;
            max-height: 90vh;
            object-fit: contain;
            border-radius: 4px;
            box-shadow: 0 4px 30px rgba(0,0,0,0.4);
        }

        /* Modal Plans */
        .modal-close {
            position: absolute;
            top: 20px;
            right: 24px;
            background: none;
            border: none;
            font-size: 28px;
            line-height: 1;
            color: #888;
            cursor: pointer;
            transition: color 0.15s;
        }
        .modal-close:hover { color: var(--sw-text); }

        .plans-upload-zone {
            margin-bottom: 20px;
            padding: 16px;
            background: #f9f9f9;
            border: 1px dashed #ccc;
            border-radius: 6px;
            text-align: center;
        }

        .btn-upload-plan {
            padding: 12px 24px;
            background: var(--sw-navy);
            color: var(--sw-surface);
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            font-family: inherit;
        }
        .btn-upload-plan:hover { background: #3d4f42; }

        .plans-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .plans-empty {
            padding: 40px 20px;
            text-align: center;
            color: #888;
            font-size: 14px;
        }

        .plan-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            margin-bottom: 8px;
            transition: background 0.15s;
        }
        .plan-item:hover { background: #f9f9f9; }

        .plan-icon {
            font-size: 32px;
            color: #c62828;
        }

        .plan-info {
            flex: 1;
            min-width: 0;
        }

        .plan-version {
            font-size: 11px;
            font-weight: 700;
            color: var(--sw-navy);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }

        .plan-filename {
            font-size: 14px;
            font-weight: 600;
            color: var(--sw-text);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .plan-meta {
            font-size: 11px;
            color: #888;
        }

        .plan-actions {
            display: flex;
            gap: 6px;
        }

        .plan-action-btn {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid #d0d0d0;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.15s;
            color: #555;
            font-family: inherit;
        }
        .plan-action-btn:hover {
            background: #f0f0f0;
            border-color: #b0b0b0;
            color: var(--sw-text);
        }
        .plan-action-btn.danger {
            color: #c62828;
            border-color: #ffcdd2;
        }
        .plan-action-btn.danger:hover {
            background: #ffebee;
            border-color: #ef9a9a;
        }

        /* PDF Viewer */
        .pdf-viewer-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 5000;
            justify-content: center;
            align-items: center;
        }
        .pdf-viewer-overlay.active { display: flex; }

        .pdf-viewer-container {
            width: 95vw;
            height: 95vh;
            background: #2b2b2b;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
        }

        .pdf-viewer-header {
            background: #1e1e1e;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #3a3a3a;
        }

        .pdf-viewer-title {
            font-size: 15px;
            font-weight: 600;
            color: #fff;
        }

        .pdf-viewer-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pdf-control-btn, .pdf-action-btn {
            background: #3a3a3a;
            border: 1px solid #4a4a4a;
            color: #e0e0e0;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-family: inherit;
            transition: all 0.15s;
        }
        .pdf-control-btn:hover, .pdf-action-btn:hover {
            background: #4a4a4a;
            border-color: #5a5a5a;
        }
        .pdf-control-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .pdf-action-btn {
            background: var(--sw-navy);
            border-color: var(--sw-navy);
            color: #fff;
            font-weight: 600;
        }
        .pdf-action-btn:hover {
            background: #3d4f42;
            border-color: #3d4f42;
        }

        .pdf-page-info, .pdf-zoom-info {
            color: #b0b0b0;
            font-size: 13px;
            min-width: 60px;
            text-align: center;
        }

        .pdf-control-divider {
            width: 1px;
            height: 20px;
            background: #4a4a4a;
            margin: 0 4px;
        }

        .pdf-viewer-close {
            background: none;
            border: none;
            color: #b0b0b0;
            font-size: 32px;
            line-height: 1;
            cursor: pointer;
            padding: 0;
            margin-left: 12px;
            transition: color 0.15s;
        }
        .pdf-viewer-close:hover { color: #fff; }

        .pdf-viewer-content {
            flex: 1;
            display: flex;
            overflow: hidden;
            background: #2b2b2b;
        }

        .pdf-sidebar {
            width: 180px;
            background: #1e1e1e;
            border-right: 1px solid #3a3a3a;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .pdf-sidebar-title {
            padding: 12px 16px;
            font-size: 11px;
            font-weight: 700;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #3a3a3a;
        }

        .pdf-thumbnails {
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .pdf-thumb {
            background: #2b2b2b;
            border: 2px solid transparent;
            border-radius: 4px;
            cursor: pointer;
            overflow: hidden;
            transition: all 0.15s;
            position: relative;
        }
        .pdf-thumb:hover {
            border-color: #5a5a5a;
        }
        .pdf-thumb.active {
            border-color: var(--sw-navy);
            box-shadow: 0 0 0 1px var(--sw-navy);
        }

        .pdf-thumb canvas {
            display: block;
            width: 100%;
            height: auto;
        }

        .pdf-thumb-label {
            position: absolute;
            bottom: 4px;
            right: 4px;
            background: rgba(0,0,0,0.7);
            color: #fff;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .pdf-canvas-container {
            flex: 1;
            overflow: auto;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        #pdfCanvas {
            display: block;
            max-width: 100%;
            height: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        /* Crop Modal */
        .crop-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.88); z-index: 3000;
            justify-content: center; align-items: center; flex-direction: column;
        }
        .crop-overlay.active { display: flex; }
        .crop-box {
            background: #fff; border-radius: 8px; overflow: hidden;
            width: 90vw; max-width: 800px; max-height: 90vh; display: flex; flex-direction: column;
        }
        .crop-header {
            padding: 14px 20px; font-weight: 700; font-size: 15px;
            border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between;
        }
        .crop-container { position: relative; flex: 1; min-height: 300px; max-height: 60vh; background: #222; overflow: hidden; }
        .crop-container img { display: block; max-width: 100%; }
        .crop-controls {
            padding: 12px 20px; display: flex; gap: 10px; align-items: center;
            border-top: 1px solid #eee; justify-content: space-between;
        }
        .crop-controls .crop-ratios { display: flex; gap: 6px; }
        .crop-controls .crop-ratio-btn {
            padding: 6px 16px; border: 2px solid #ccc; border-radius: 4px;
            background: #fff; cursor: pointer; font-size: 13px; font-weight: 600;
        }
        .crop-controls .crop-ratio-btn.active { border-color: var(--sw-navy); background: var(--sw-navy); color: #fff; }
        .crop-controls .crop-actions { display: flex; gap: 8px; }
        .crop-controls .crop-btn {
            padding: 8px 20px; border: none; border-radius: 4px;
            cursor: pointer; font-size: 13px; font-weight: 600;
        }
        .crop-btn-cancel { background: #eee; color: #555; }
        .crop-btn-confirm { background: var(--sw-navy); color: #fff; }
        .crop-btn-confirm:disabled { opacity: 0.5; cursor: not-allowed; }
        .crop-error { padding: 10px 20px; background: #fee; color: #c00; font-size: 13px; display: none; }
        .crop-loading { padding: 20px; text-align: center; color: #888; font-size: 14px; }

        /* ── Annotation Modal ── */
        .annotation-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.88); z-index: 3500;
            justify-content: center; align-items: center; flex-direction: column;
        }
        .annotation-overlay.active { display: flex; }
        .annotation-box {
            background: #fff; border-radius: 8px; overflow: hidden;
            width: 95vw; max-width: 1200px; max-height: 92vh;
            display: flex; flex-direction: column;
        }
        .annotation-header {
            padding: 12px 20px; border-bottom: 1px solid #eee;
            display: flex; align-items: center; gap: 12px; flex-shrink: 0;
        }
        .annotation-header .annotation-title { font-weight: 700; font-size: 15px; margin-right: auto; }
        .annotation-header select {
            padding: 5px 10px; border: 1px solid #ddd; border-radius: 4px;
            font-size: 13px; font-family: inherit;
        }
        .annotation-header .annotation-next {
            font-size: 13px; font-weight: 600; color: var(--sw-navy);
            min-width: 90px;
        }
        .annotation-header .annotation-arrow-toggle {
            display: flex; align-items: center; gap: 4px; font-size: 12px; cursor: pointer;
        }
        .annotation-header .annotation-arrow-toggle input { width: 14px; height: 14px; accent-color: var(--sw-navy); }
        .annotation-close {
            background: none; border: none; font-size: 22px; cursor: pointer; color: #888;
            padding: 0 4px; line-height: 1;
        }
        .annotation-close:hover { color: #333; }
        .annotation-img-container {
            flex: 1; position: relative; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
            background: #1a1a1a; min-height: 300px;
        }
        .annotation-img-container img {
            max-width: 100%; max-height: 75vh; display: block; user-select: none; -webkit-user-drag: none;
        }
        .annotation-img-container svg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; overflow: visible;
        }
        .annotation-img-container svg .annot-label {
            pointer-events: all; cursor: grab; user-select: none;
        }
        .annotation-img-container svg .annot-label:hover rect { stroke: #fff; stroke-width: 2; }
        .annotation-img-container svg .annot-label.dragging { cursor: grabbing; opacity: 0.8; }
        .annotation-img-container svg .annot-arrow {
            stroke: var(--sw-navy); stroke-width: 2; fill: none;
            marker-end: url(#annotArrowHead);
        }
        .annotation-footer {
            padding: 10px 20px; border-top: 1px solid #eee;
            display: flex; align-items: center; gap: 12px; font-size: 12px; color: #888;
        }
        .annotation-footer .annotation-hint { flex: 1; }
        .annotation-badge {
            position: absolute; top: 2px; left: 2px;
            background: var(--sw-navy); color: #fff;
            font-size: 9px; font-weight: 700; min-width: 16px; height: 16px;
            border-radius: 8px; display: flex; align-items: center; justify-content: center;
            padding: 0 3px; line-height: 1;
        }
        .annotation-btn {
            position: absolute; top: 2px; left: 2px;
            background: rgba(11,18,32,0.85); color: #fff; border: none;
            width: 22px; height: 22px; border-radius: 4px; cursor: pointer;
            font-size: 12px; display: flex; align-items: center; justify-content: center;
            padding: 0; opacity: 0.7; transition: opacity 0.15s;
        }
        .image-preview-item:hover .annotation-btn { opacity: 1; }
        .annotation-btn:hover { background: var(--sw-navy); }

        /* ═══════════════════════════════════════════════════════════════
           VUE LISTE DE PROJETS
           ═══════════════════════════════════════════════════════════════ */

        .project-list-view { display: none; }
        .project-list-view.active { display: block; }
        .calculator-view { display: none; max-width: 1200px; }
        .calculator-view.active { display: block; }

        /* ═══════════════════════════════════════════════════════════════
           PREVIEW VIEW (Aperçu soumission)
           ═══════════════════════════════════════════════════════════════ */
        /* Preview — split layout (document gauche, outils droite) */
        .preview-view {
            display: none; position: fixed; top: 56px; left: 0; right: 0; bottom: 0;
            z-index: 50; background: #fff;
        }
        .preview-view.active { display: flex; flex-direction: column; }

        .pv-toolbar {
            display: flex; align-items: center; gap: 16px; flex-wrap: wrap;
            padding: 10px 24px; border-bottom: 2px solid var(--sw-text);
            background: #fff; flex-shrink: 0;
        }
        .pv-toolbar button {
            background: none; border: 1px solid var(--sw-navy); color: var(--sw-navy);
            padding: 6px 14px; border-radius: 4px; font-size: 12px; cursor: pointer; font-weight: 500;
        }
        .pv-toolbar button:hover { background: var(--sw-navy); color: #fff; }
        .pv-toolbar-title { font-size: 16px; font-weight: 600; color: var(--sw-text); }
        .pv-toolbar-sub { font-size: 13px; color: var(--sw-navy); font-weight: 600; margin-left: auto; }

        /* Split panels */
        .pv-split { flex: 1; display: flex; overflow: hidden; }
        .pv-left { flex: 1; overflow-y: auto; padding: 4px 0; background: #ddd; }
        .pv-right {
            width: 360px; min-width: 360px; overflow-y: auto;
            background: #f8f8f8; border-left: 1px solid rgba(0,0,0,0.1);
        }

        .pv-content {
            display: flex; flex-direction: column; gap: 4px;
        }

        /* ── Landscape pages (11 × 8.5 in) ── */
        .pv-page {
            background: #fff; padding: 36px 32px;
            aspect-ratio: 11 / 8.5;
            overflow: hidden; position: relative;
            display: flex; flex-direction: column;
        }

        /* Title page — full-screen image + text overlay */
        .pv-page-title { position: relative; padding: 32px; overflow: hidden; background: #fff; }
        .pv-cover-right {
            position: absolute; inset: 32px; z-index: 0; background: var(--sw-navy); overflow: hidden; border-radius: 4px;
        }
        .pv-cover-right img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .pv-cover-right .pv-cover-overlay {
            position: absolute; inset: 0; border-radius: 4px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.05), rgba(0,0,0,0.15));
        }
        .pv-cover-left {
            position: relative; z-index: 1; width: 100%;
            display: flex; flex-direction: column; justify-content: flex-start;
            padding: clamp(24px, 3vw, 48px); min-height: 100%;
            background: transparent; text-align: left;
        }
        .pv-cover-brand { font-size: 12px; text-transform: uppercase; letter-spacing: 0.08em; color: rgba(255,255,255,0.7); margin-bottom: 16px; }
        .pv-cover-left .pv-project-name { font-size: 34px; font-weight: 600; color: #FFFFFF; line-height: 1.2; margin-bottom: 6px; }
        .pv-cover-left .pv-client-name { font-size: 14px; font-weight: 400; color: rgba(255,255,255,0.8); line-height: 1.6; margin-bottom: 0; }
        .pv-cover-left .pv-client-address { font-size: 14px; font-weight: 400; color: rgba(255,255,255,0.8); line-height: 1.6; margin-bottom: 0; }
        .pv-cover-left .pv-cover-divider { width: 40px; height: 2px; background: rgba(255,255,255,0.3); margin: 24px 0; }
        .pv-cover-left .pv-sub-number { font-size: 13px; font-weight: 500; color: #FFFFFF; margin-bottom: 2px; }
        .pv-cover-left .pv-sub-date { font-size: 13px; color: rgba(255,255,255,0.7); }
        .pv-cover-logo {
            position: absolute; bottom: calc(32px + clamp(24px, 3vw, 48px)); left: calc(32px + clamp(24px, 3vw, 48px));
            max-width: 140px; z-index: 1;
        }
        .pv-cover-logo img { width: 100%; height: auto; display: block; }

        /* Installation non incluse — indicators */
        .pv-install-banner { font-size: 12px; color: rgba(255,255,255,0.7); margin-top: 60px; letter-spacing: 0.3px; }
        .pv-install-room-note { font-size: 11px; color: #999; font-style: italic; margin-top: -30px; margin-bottom: 20px; padding-left: 20px; }
        .pv-install-total-note { font-size: 13px; color: #999; margin-bottom: 16px; letter-spacing: 0.3px; }

        /* Room page — landscape layout */
        .pv-page-room-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 16px; background: #4b6050; color: #fff;
            border-radius: 0; margin: 0 0 38px 0; flex-shrink: 0;
        }
        .pv-room-separator {
            border-bottom: 1px solid #E5E7EB;
            flex-shrink: 0;
        }
        .pv-page-room-name { font-size: 17px; font-weight: 600; letter-spacing: 0.3px; }
        .pv-page-room-subtotal { font-size: 17px; font-weight: 700; }
        .pv-page-room-body { flex: 1; display: flex; gap: 38px; overflow: hidden; min-height: 0; }
        .pv-page-room-text { flex: 1; display: flex; flex-direction: column; overflow: hidden; justify-content: center; }
        .pv-page-room-media {
            flex: 1; display: grid; grid-template-columns: repeat(2, 1fr);
            gap: 8px; align-content: center; max-height: 100%;
        }
        /* 1 image: single column, centered */
        .pv-page-room-media.imgs-1 { grid-template-columns: 1fr; }
        /* 2 images: stacked vertically, gap = header height */
        .pv-page-room-media.imgs-2 { grid-template-columns: 1fr; gap: 38px; }
        /* 3 images: first spans full width, 2 below side by side */
        .pv-page-room-media.imgs-3 { gap: 8px; }
        .pv-page-room-media.imgs-3 .pv-img-wrap:first-child { grid-column: 1 / -1; }
        .pv-page-room-media .pv-img-wrap { overflow: hidden; min-height: 0; }
        .pv-page-room-media .pv-img-wrap img {
            width: 100%; height: 100%; object-fit: cover; display: block; cursor: pointer;
        }
        .pv-page-room-desc {
            width: 100%; border: 1px dashed #ccc; border-radius: 4px;
            padding: 10px 12px; font-size: 13px; line-height: 1.5; color: #444;
            font-family: inherit; flex: 1; min-height: 60px;
            background: #fafafa; transition: border-color 0.2s;
            overflow-y: auto; white-space: normal; word-wrap: break-word;
        }
        .pv-page-room-desc:focus { outline: none; border-color: var(--sw-navy); background: #fff; }
        .pv-page-room-desc[contenteditable="false"] { background: transparent; border-color: transparent; cursor: default; }
        .pv-page-room-desc:empty::before { content: attr(data-placeholder); color: #aaa; font-style: italic; }
        .pv-page-room-desc p { margin: 0 0 6px 0; }
        .pv-page-room-desc ul { margin: 4px 0 8px 0; padding-left: 20px; }
        .pv-page-room-desc li { margin-bottom: 2px; }
        .pv-page-room-desc strong { font-weight: 700; }

        /* Clauses page — compact */
        .pv-page-clauses-header {
            font-size: 12px; text-transform: uppercase; letter-spacing: 1px;
            color: #4b6050; font-weight: 700; margin-bottom: 14px;
            padding-bottom: 6px; border-bottom: 2px solid #4b6050;
        }
        .pv-page-clauses-body { flex: 1; overflow: hidden; }
        .pv-page-clause {
            margin-bottom: 8px; padding: 6px 14px;
            border-left: 3px solid #4b6050; background: #fafafa;
            border-radius: 0 3px 3px 0;
        }
        .pv-page-clause-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 2px; }
        .pv-page-clause-text {
            width: 100%; border: 1px dashed transparent; border-radius: 3px;
            padding: 2px 4px; font-size: 12px; line-height: 1.3; color: #555;
            font-family: inherit; resize: none; background: transparent;
        }
        .pv-page-clause-text:focus { outline: none; border-color: #4b6050; background: #fff; }
        .pv-page-clause-text:disabled { border-color: transparent; background: transparent; }
        .pv-page-clause-actions { display: flex; gap: 6px; margin-top: 2px; justify-content: flex-end; }

        /* Total page */
        .pv-page-total { justify-content: center; align-items: center; text-align: center; }
        .pv-total-box {
            padding: 36px 56px; background: var(--sw-text); color: #fff; border-radius: 6px;
        }
        .pv-total-box .total-label { font-size: 16px; font-weight: 300; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 10px; opacity: 0.8; }
        .pv-total-box .total-amount { font-size: 42px; font-weight: 700; }
        .pv-total-box .total-taxes { font-size: 13px; opacity: 0.6; margin-top: 6px; }
        .pv-page-footer-text { margin-top: 32px; font-size: 12px; color: #aaa; letter-spacing: 0.5px; }

        /* Steps page */
        .pv-page-steps { padding: 32px 32px; }
        .pv-steps-title {
            font-size: 12px; text-transform: uppercase; letter-spacing: 1px;
            color: #4b6050; font-weight: 700; margin-bottom: 20px;
            padding-bottom: 6px; border-bottom: 2px solid #4b6050;
        }
        .pv-steps-grid {
            flex: 1; display: grid; grid-template-columns: 1fr 1fr;
            grid-template-rows: repeat(4, 1fr); gap: 10px 48px;
            grid-auto-flow: column;
        }
        .pv-step { display: flex; gap: 16px; align-items: flex-start; }
        .pv-step-circle {
            width: 64px; height: 64px; min-width: 64px; border-radius: 50%;
            color: #fff; display: flex; align-items: center; justify-content: center;
            font-size: 24px; font-weight: 700; margin-top: 2px;
        }
        .pv-step-content { flex: 1; min-width: 0; }
        .pv-step-label {
            font-size: 12px; font-weight: 700; text-transform: uppercase;
            letter-spacing: 0.3px; color: var(--sw-text); margin-bottom: 4px;
        }
        .pv-step-desc { font-size: 11px; line-height: 1.45; color: #555; }

        /* Tools panel */
        .pv-tools-header {
            padding: 14px 20px; font-size: 13px; font-weight: 700;
            text-transform: uppercase; letter-spacing: 1px; color: var(--sw-text);
            border-bottom: 1px solid rgba(0,0,0,0.08); background: #f0f0f0;
            position: sticky; top: 0; z-index: 1;
        }
        .pv-tools-section { padding: 16px 20px; border-bottom: 1px solid rgba(0,0,0,0.06); }
        .pv-tools-section h5 {
            font-size: 11px; text-transform: uppercase; letter-spacing: 0.6px;
            color: var(--sw-navy); margin-bottom: 10px; font-weight: 600;
        }
        .pv-tools-placeholder { font-size: 13px; color: #888; line-height: 1.4; font-style: italic; }

        .pv-clause-list { display: flex; flex-direction: column; gap: 6px; }
        .pv-clause-item {
            padding: 10px 12px; background: #fff; border: 1px solid rgba(0,0,0,0.08);
            border-radius: 4px; font-size: 13px; color: #333; cursor: grab;
            transition: box-shadow 0.15s, border-color 0.15s;
        }
        .pv-clause-item:hover { border-color: var(--sw-navy); box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .pv-clause-item .clause-title { font-weight: 600; margin-bottom: 2px; }
        .pv-clause-item .clause-preview {
            font-size: 12px; color: #888; overflow: hidden;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
        }

        /* Image wrap (used in room pages) */
        .pv-img-wrap { position: relative; border-radius: 4px; overflow: hidden; }
        .pv-img-delete {
            position: absolute; top: 6px; right: 6px; width: 24px; height: 24px;
            border-radius: 50%; background: rgba(0,0,0,0.6); color: #fff;
            border: none; cursor: pointer; font-size: 14px; line-height: 24px;
            text-align: center; padding: 0; transition: background 0.15s;
            display: none;
        }
        .pv-img-wrap:hover .pv-img-delete { display: block; }
        .pv-img-delete:hover { background: rgba(200,0,0,0.85); }
        .pv-img-badge-client {
            position: absolute; bottom: 6px; left: 6px;
            background: rgba(11,18,32,0.85); color: #fff; font-size: 8px;
            padding: 2px 5px; border-radius: 3px; font-weight: 600;
            letter-spacing: 0.3px; text-transform: uppercase;
        }

        /* Client / presentation mode — hide edit UI */
        .pv-toolbar .btn-client-view {
            background: none; border: 1px solid #333; color: #333;
            padding: 6px 14px; border-radius: 4px; font-size: 12px;
            cursor: pointer; font-weight: 500; margin-left: 8px;
        }
        .pv-toolbar .btn-client-view:hover { background: #333; color: #fff; }
        .pv-toolbar .btn-client-view.active { background: #333; color: #fff; }
        .pv-optimize-btn {
            position: absolute; top: 6px; right: 6px; z-index: 2;
            display: flex; align-items: center; justify-content: center;
            width: 28px; height: 28px; padding: 0;
            background: transparent; border: none; cursor: pointer;
            font-size: 0; color: transparent;
        }
        .pv-optimize-btn::after {
            content: ''; display: block; width: 9px; height: 9px;
            border-radius: 50%; background: var(--sw-navy);
            opacity: 0.6; box-shadow: 0 0 0 3px rgba(11,18,32,0.06);
            transition: all 200ms ease;
            animation: ai-breathe 3s ease-in-out infinite;
        }
        .pv-optimize-btn:hover::after { opacity: 1; transform: scale(1.05); }
        .pv-client-mode .pv-optimize-btn { display: none !important; }
        .pv-client-mode .pv-right { display: none; }
        .pv-client-mode .pv-page-room-desc { border-color: transparent; background: transparent; padding: 0; flex: initial; min-height: auto; }
        .pv-client-mode .pv-page-clause { background: transparent; border-left: 3px solid #4b6050; border: 1px solid #e0e0e0; border-left: 3px solid #4b6050; }
        .pv-client-mode .pv-page-clause-text { border-color: transparent; background: transparent; padding: 0; height: auto !important; overflow: visible; }
        .pv-client-mode .pv-page-clause-actions,
        .pv-client-mode .pv-clause-dropzone,
        .pv-client-mode .pv-img-delete { display: none !important; }

        /* Clause action buttons (in document) */
        .pv-doc-clause-btn {
            background: none; border: none; font-size: 10px; cursor: pointer;
            font-family: inherit; padding: 2px 5px; border-radius: 3px; transition: all 0.15s;
        }
        .pv-doc-clause-btn.remove { color: #c62828; }
        .pv-doc-clause-btn.remove:hover { background: #ffebee; }
        .pv-doc-clause-btn.save-lib { color: var(--sw-navy); }
        .pv-doc-clause-btn.save-lib:hover { background: #e8f5e9; }

        /* Drop zone for clauses */
        .pv-clause-dropzone {
            padding: 10px; border: 2px dashed #ccc; border-radius: 4px;
            text-align: center; color: #aaa; font-size: 12px; font-style: italic;
            transition: all 0.2s; margin-top: 6px;
        }
        .pv-clause-dropzone.drag-over {
            border-color: var(--sw-navy); background: #edf1f7; color: var(--sw-navy);
        }

        /* Fullscreen presentation mode */
        .pv-fullscreen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 9999; }
        .pv-fullscreen .pv-toolbar { display: none; }
        .pv-fullscreen .pv-right { display: none; }
        .pv-fullscreen .pv-left { padding: 0; background: #fff; scroll-snap-type: y mandatory; }
        .pv-fullscreen .pv-content { gap: 0; }
        .pv-fullscreen .pv-page {
            scroll-snap-align: start;
            height: 100vh; max-height: 100vh;
            width: calc(100vh * 11 / 8.5); max-width: 100vw;
            margin: 0 auto; box-sizing: border-box;
            aspect-ratio: auto;
        }
        .pv-fullscreen .pv-page-room-desc { border-color: transparent; background: transparent; padding: 0; flex: initial; min-height: auto; }
        .pv-fullscreen .pv-page-clause { background: transparent; border: 1px solid #e0e0e0; border-left: 3px solid #4b6050; }
        .pv-fullscreen .pv-page-clause-text { border-color: transparent; background: transparent; padding: 0; height: auto !important; overflow: visible; }
        .pv-fullscreen .pv-page-clause-actions,
        .pv-fullscreen .pv-clause-dropzone,
        .pv-fullscreen .pv-img-delete,
        .pv-fullscreen .pv-img-badge-client { display: none !important; }

        /* Tools panel — clause library items */
        .pv-lib-actions { display: flex; gap: 6px; margin-bottom: 10px; }
        .pv-btn-add-clause {
            background: var(--sw-navy); color: #fff; border: none;
            padding: 6px 12px; border-radius: 4px; font-size: 11px;
            cursor: pointer; font-family: inherit; font-weight: 500;
        }
        .pv-btn-add-clause:hover { background: #3d5043; }
        .pv-clause-item {
            padding: 10px 12px; background: #fff; border: 1px solid rgba(0,0,0,0.08);
            border-radius: 4px; font-size: 13px; color: #333; cursor: grab;
            transition: box-shadow 0.15s, border-color 0.15s; margin-bottom: 6px;
        }
        .pv-clause-item:hover { border-color: var(--sw-navy); box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .pv-clause-item.dragging { opacity: 0.5; }
        .pv-clause-item-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px;
        }
        .pv-clause-item-title { font-weight: 600; font-size: 12px; }
        .pv-clause-item-btns { display: flex; gap: 4px; }
        .pv-clause-item-btn {
            background: none; border: none; font-size: 11px; cursor: pointer;
            color: #888; padding: 1px 4px; border-radius: 2px;
        }
        .pv-clause-item-btn:hover { color: var(--sw-text); background: rgba(0,0,0,0.05); }
        .pv-clause-item-btn.add-to-sub { color: var(--sw-navy); font-size: 14px; font-weight: 700; }
        .pv-clause-item-btn.add-to-sub:hover { background: #e8f5e9; }
        .pv-clause-item-btn.delete:hover { color: #c62828; background: #ffebee; }
        .pv-clause-item-preview {
            font-size: 11px; color: #999; overflow: hidden;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
            line-height: 1.3;
        }
        .pv-clause-empty { font-size: 12px; color: #aaa; font-style: italic; padding: 8px 0; }

        /* Clause edit modal (inline in tools panel) */
        .pv-clause-edit {
            padding: 12px; background: #fff; border: 2px solid var(--sw-navy);
            border-radius: 6px; margin-bottom: 10px;
        }
        .pv-clause-edit label { font-size: 11px; font-weight: 600; color: #666; display: block; margin-bottom: 3px; }
        .pv-clause-edit input, .pv-clause-edit textarea {
            width: 100%; border: 1px solid #ddd; border-radius: 4px;
            padding: 6px 8px; font-size: 12px; font-family: inherit; margin-bottom: 8px;
        }
        .pv-clause-edit input:focus, .pv-clause-edit textarea:focus { outline: none; border-color: var(--sw-navy); }
        .pv-clause-edit textarea { resize: vertical; min-height: 60px; line-height: 1.35; }
        .pv-clause-edit-btns { display: flex; gap: 6px; justify-content: flex-end; }
        .pv-clause-edit-btns button {
            padding: 5px 12px; border-radius: 4px; font-size: 11px;
            cursor: pointer; font-family: inherit; border: none;
        }
        .pv-clause-edit-btns .save { background: var(--sw-navy); color: #fff; }
        .pv-clause-edit-btns .save:hover { background: #3d5043; }
        .pv-clause-edit-btns .cancel { background: #eee; color: #666; }
        .pv-clause-edit-btns .cancel:hover { background: #ddd; }

        /* Responsive — tools panel collapses on small screens */
        @media (max-width: 1100px) {
            .pv-right { width: 300px; min-width: 300px; }
        }
        @media (max-width: 900px) {
            .pv-split { flex-direction: column; }
            .pv-left { padding: 2px 0; }
            .pv-right { width: 100%; min-width: 100%; max-height: 240px; border-left: none; border-top: 1px solid rgba(0,0,0,0.1); }
            .pv-page-room-body { flex-direction: column; }
            .pv-page-room-media { grid-template-columns: 1fr 1fr; }
        }

        .project-list-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 24px; flex-wrap: wrap; gap: 12px;
        }
        .project-list-title { font-size: 28px; font-weight: 400; }

        .btn-new-project {
            background: var(--sw-navy); color: #fff; border: none;
            padding: 10px 20px; font-size: 14px; cursor: pointer;
            border-radius: 6px; font-family: inherit; transition: background 0.15s;
        }
        .btn-new-project:hover { background: #3d4f41; }

        .project-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }

        .project-card {
            background: #fff; border: 1px solid #e0e0e0; border-radius: 8px;
            padding: 20px; cursor: pointer; transition: all 0.2s; position: relative;
        }
        .project-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.1); transform: translateY(-2px); }

        .project-card-name { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
        .project-card-client { font-size: 13px; color: #666; margin-bottom: 10px; }
        .project-card-meta { display: flex; align-items: center; justify-content: space-between; gap: 8px; }
        .project-card-date { font-size: 11px; color: #999; }

        .project-status-badge {
            display: inline-block; padding: 2px 10px; border-radius: 12px;
            font-size: 11px; font-weight: 600; text-transform: capitalize;
        }
        /* Nouveau workflow */
        .status-draft { background: #f0f0f0; color: #666; }
        .status-pending_internal { background: #e3f2fd; color: #1565c0; }
        .status-returned { background: #fff3e0; color: #e65100; }
        .status-approved_internal { background: #e8f5e9; color: #2e7d32; }
        .status-sent_client { background: #ede7f6; color: #4527a0; }
        .status-accepted { background: #e8f5e9; color: #1b5e20; }
        .status-lost { background: #ffebee; color: #c62828; }
        /* Legacy */
        .status-brouillon { background: #f0f0f0; color: #666; }
        .status-soumis { background: #e3f2fd; color: #1565c0; }
        .status-approuvé { background: #e8f5e9; color: #2e7d32; }
        .status-envoyé { background: #fff3e0; color: #e65100; }
        .status-signé { background: #e8f5e9; color: #1b5e20; }

        /* Soumissions dans la carte projet */
        .project-subs { margin: 10px 0 8px; }
        .sub-line {
            display: flex; align-items: center; gap: 8px; padding: 6px 10px;
            border-radius: 6px; cursor: pointer; transition: background 0.15s;
        }
        .sub-line:hover { background: #f5f5f5; }
        .sub-number { font-size: 12px; font-weight: 700; color: var(--sw-navy); min-width: 40px; }
        .sub-title { font-size: 13px; color: #333; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .sub-empty { font-size: 12px; color: #aaa; padding: 8px 10px; font-style: italic; }
        .btn-add-sub {
            display: block; width: 100%; padding: 6px 0; margin-top: 4px;
            background: none; border: 1px dashed #ccc; border-radius: 6px;
            color: #888; font-size: 12px; cursor: pointer; transition: all 0.15s;
        }
        .btn-add-sub:hover { border-color: var(--sw-navy); color: var(--sw-navy); background: #f7f8fa; }

        /* ── Pipeline — Tabs ── */
        .pipeline-tabs {
            display: flex; gap: 0; margin-bottom: 16px; border-bottom: 2px solid #e0e0e0;
        }
        .pipeline-tab {
            padding: 10px 20px; font-size: 13px; font-weight: 600; color: #888;
            cursor: pointer; border: none; background: none; font-family: inherit;
            border-bottom: 2px solid transparent; margin-bottom: -2px; transition: all 0.15s;
        }
        .pipeline-tab:hover { color: #333; }
        .pipeline-tab.active { color: var(--sw-navy); border-bottom-color: var(--sw-navy); }

        /* ── Pipeline — Filter bar ── */
        .pipeline-filters {
            display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; align-items: center;
        }
        .pipeline-filters input[type="text"] {
            flex: 1; min-width: 180px; padding: 7px 12px; border: 1px solid #ddd;
            border-radius: 6px; font-size: 13px; font-family: inherit;
        }
        .pipeline-filters select {
            padding: 7px 10px; border: 1px solid #ddd; border-radius: 6px;
            font-size: 13px; font-family: inherit; background: #fff; min-width: 140px;
        }
        .pipeline-filter-btn {
            padding: 7px 14px; border: 1px solid #ddd; border-radius: 6px;
            background: #fff; cursor: pointer; font-size: 13px; font-family: inherit;
        }
        .pipeline-filter-btn.active { background: var(--sw-navy); color: #fff; border-color: var(--sw-navy); }

        /* ── Pipeline — Table view ── */
        .pipeline-table-wrap {
            overflow-x: hidden; margin-bottom: 16px; border: 1px solid #e0e0e0; border-radius: 8px;
        }
        .pipeline-table {
            width: 100%; border-collapse: collapse; font-size: 13px; table-layout: fixed;
        }
        .pipeline-table thead th {
            background: #f8f8f8; padding: 10px 14px; text-align: left; font-weight: 600;
            font-size: 11px; text-transform: uppercase; letter-spacing: 0.3px; color: #666;
            cursor: pointer; user-select: none; white-space: nowrap; border-bottom: 1px solid #e0e0e0;
            overflow: hidden; text-overflow: ellipsis;
        }
        .pipeline-table thead th:hover { background: #f0f0f0; }
        .pipeline-table thead th .sort-arrow { font-size: 10px; margin-left: 4px; opacity: 0.4; }
        .pipeline-table thead th.sorted .sort-arrow { opacity: 1; color: var(--sw-navy); }
        .pipeline-table tbody tr {
            cursor: pointer; transition: background 0.1s; border-bottom: 1px solid #f0f0f0;
        }
        .pipeline-table tbody tr:hover { background: #f7f8fa; }
        .pipeline-table tbody td {
            padding: 9px 14px; white-space: nowrap;
            overflow: hidden; text-overflow: ellipsis;
        }
        .pipeline-table tbody td.col-name { font-weight: 500; }
        .pipeline-table tbody td.col-amount { text-align: right; font-family: 'SF Mono', monospace; font-size: 12px; }
        /* Column widths */
        .col-w-follow { width: 36px; text-align: center; }
        .col-w-name { width: auto; }
        .col-w-contact { width: 11%; }
        .col-w-amount { width: 100px; }
        .col-w-prob { width: 60px; }
        .col-w-status { width: 120px; }
        .col-w-deadline { width: 80px; }
        .col-w-resp { width: 10%; }
        .col-w-type { width: 10%; }
        .col-w-delivery { width: 90px; }
        .col-w-more { width: 40px; text-align: center; }
        /* PROB% — always hidden */
        .col-prob-hidden th, .col-prob-hidden td { /* handled via inline class */ }
        .col-always-hidden { display: none !important; }
        /* Responsive column hiding */
        @media (max-width: 1399px) {
            .col-hide-xl { display: none !important; }
        }
        @media (max-width: 1199px) {
            .col-hide-lg { display: none !important; }
        }
        @media (max-width: 991px) {
            .col-hide-md { display: none !important; }
        }
        /* Follow star */
        .follow-star {
            cursor: pointer; font-size: 16px; color: #ccc;
            transition: color 0.15s; user-select: none;
        }
        .follow-star.active { color: #f5a623; }
        .follow-star:hover { color: #f5a623; }
        /* Priority indicator (inline in name cell) */
        .prio-indicator {
            display: inline-block; width: 8px; height: 8px;
            border-radius: 50%; margin-right: 6px; vertical-align: middle;
            cursor: pointer; flex-shrink: 0;
        }
        .prio-indicator.haute { background: #F59E0B; }
        .prio-indicator.urgente { background: #EF4444; }
        .prio-indicator.normal { background: transparent; width: 8px; height: 8px; }
        .prio-indicator:hover { opacity: 0.8; }
        /* Priority dropdown */
        .prio-dropdown {
            position: absolute; top: 100%; left: 0; z-index: 100;
            background: #fff; border: 1px solid #ddd; border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.12); padding: 4px 0;
            min-width: 130px;
        }
        .prio-dropdown-item {
            display: flex; align-items: center; gap: 8px;
            padding: 6px 12px; cursor: pointer; font-size: 13px;
            white-space: nowrap;
        }
        .prio-dropdown-item:hover { background: #f5f5f5; }
        .prio-dropdown-dot {
            display: inline-block; width: 8px; height: 8px; border-radius: 50%;
        }
        .name-cell-inner { display: flex; align-items: center; position: relative; }
        /* More button */
        .tbl-more-btn {
            background: none; border: none; cursor: pointer; font-size: 16px;
            color: #999; padding: 2px 6px; border-radius: 4px; line-height: 1;
        }
        .tbl-more-btn:hover { background: #f0f0f0; color: #333; }
        .pipeline-badge {
            display: inline-block; padding: 2px 10px; border-radius: 12px;
            font-size: 11px; font-weight: 600; white-space: nowrap; cursor: pointer;
        }
        /* ── Status dropdown (Linear/Notion style) ── */
        .status-dropdown {
            position: fixed; z-index: 9999;
            background: #fff; border: 1px solid #e2e8f0;
            border-radius: 10px; box-shadow: 0 4px 24px rgba(0,0,0,0.12), 0 1px 4px rgba(0,0,0,0.06);
            padding: 4px; min-width: 180px;
            transform-origin: top left;
            animation: sdFadeIn 0.12s ease-out;
        }
        @keyframes sdFadeIn {
            from { opacity: 0; transform: scale(0.96) translateY(-4px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
        .status-dropdown-item {
            display: flex; align-items: center; gap: 10px;
            padding: 7px 10px; cursor: pointer; font-size: 13px;
            border-radius: 6px; color: var(--sw-text); white-space: nowrap;
            transition: background 0.08s;
        }
        .status-dropdown-item:hover, .status-dropdown-item.sd-focused {
            background: var(--sw-border-2);
        }
        .status-dropdown-item .sd-dot {
            width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
        }
        .status-dropdown-item .sd-label { flex: 1; }
        .status-dropdown-item .sd-check {
            width: 16px; text-align: center; font-size: 13px; color: var(--sw-text-2);
        }
        /* ── Date picker (Apple/Linear style) ── */
        .dp-popover {
            position: fixed; z-index: 9999;
            background: #fff; border: 1px solid #e2e8f0;
            border-radius: 12px; box-shadow: 0 4px 24px rgba(0,0,0,0.12), 0 1px 4px rgba(0,0,0,0.06);
            padding: 12px; width: 264px; user-select: none;
            animation: sdFadeIn 0.12s ease-out;
        }
        .dp-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 8px; padding: 0 2px;
        }
        .dp-header-title {
            font-size: 14px; font-weight: 600; color: var(--sw-text);
            cursor: default;
        }
        .dp-nav {
            display: flex; gap: 2px;
        }
        .dp-nav-btn {
            width: 28px; height: 28px; border: none; background: transparent;
            border-radius: 6px; cursor: pointer; font-size: 16px; color: var(--sw-text-2);
            display: flex; align-items: center; justify-content: center;
            transition: background 0.08s;
        }
        .dp-nav-btn:hover { background: var(--sw-border-2); }
        .dp-weekdays {
            display: grid; grid-template-columns: repeat(7, 1fr);
            text-align: center; font-size: 11px; font-weight: 600;
            color: var(--sw-muted); margin-bottom: 4px;
        }
        .dp-weekdays span { padding: 4px 0; }
        .dp-grid {
            display: grid; grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }
        .dp-day {
            width: 32px; height: 32px; border: none; background: transparent;
            border-radius: 8px; cursor: pointer; font-size: 13px; color: var(--sw-text);
            display: flex; align-items: center; justify-content: center;
            margin: 0 auto; transition: background 0.08s;
        }
        .dp-day:hover { background: var(--sw-border-2); }
        .dp-day.outside { color: #cbd5e1; }
        .dp-day.today { box-shadow: inset 0 0 0 1.5px #cbd5e1; }
        .dp-day.selected { background: var(--sw-navy); color: #fff; }
        .dp-day.selected.today { box-shadow: none; }
        .dp-footer {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--sw-border-2);
        }
        .dp-footer-btn {
            border: none; background: transparent; cursor: pointer;
            font-size: 12px; color: var(--sw-text-2); padding: 4px 8px; border-radius: 6px;
        }
        .dp-footer-btn:hover { background: var(--sw-border-2); color: var(--sw-text); }
        .dp-footer-btn.dp-today-btn { color: var(--sw-navy); font-weight: 600; }
        /* ── Pipeline — Amount override inline edit ── */
        .amount-cell { cursor: pointer; position: relative; }
        .amount-cell:hover { background: rgba(0,0,0,0.03); }
        .inline-editable { cursor: pointer; }
        .inline-editable:hover { background: rgba(0,0,0,0.03); }
        .inline-edit-select, .inline-edit-input {
            width: 100%; padding: 4px 6px; font-size: 12px; font-family: inherit;
            border: 1px solid var(--sw-navy); border-radius: 4px; background: #fff;
            outline: none;
        }
        .amount-override { color: #c62828; }
        .amount-override::after {
            content: attr(data-tooltip); position: absolute; bottom: calc(100% + 4px); right: 0;
            white-space: nowrap; background: #333; color: #fff; font-size: 11px;
            padding: 3px 8px; border-radius: 4px; pointer-events: none;
            opacity: 0; transition: opacity 0.15s; font-family: "Segoe UI", system-ui, sans-serif;
        }
        .amount-override:hover::after { opacity: 1; }
        .amount-inline-input {
            width: 100%; border: 1px solid var(--sw-navy); border-radius: 3px;
            padding: 2px 6px; font-family: 'SF Mono', monospace; font-size: 12px;
            text-align: right; outline: none; background: #fff;
        }

        /* ── Pipeline — Submissions view ── */
        .pipeline-mini-timeline {
            display: inline-flex; align-items: center; gap: 3px;
        }
        .pipeline-table tbody td:has(.pipeline-mini-timeline) { overflow: visible; }
        .pipeline-mini-timeline .tl-dot {
            width: 8px; height: 8px; border-radius: 50%; background: #e0e0e0;
            position: relative; cursor: default;
        }
        .pipeline-mini-timeline .tl-dot.filled { background: var(--sw-navy); }
        .pipeline-mini-timeline .tl-dot.filled.lost { background: #c62828; }
        .pipeline-mini-timeline .tl-dot::after {
            content: attr(data-label); position: absolute; bottom: calc(100% + 6px); left: 50%;
            transform: translateX(-50%); white-space: nowrap;
            background: #333; color: #fff; font-size: 11px; padding: 3px 8px;
            border-radius: 4px; pointer-events: none;
            opacity: 0; transition: opacity 0.15s; z-index: 10;
        }
        .pipeline-mini-timeline .tl-dot:hover::after { opacity: 1; }
        .pipeline-mini-timeline .tl-line {
            width: 6px; height: 2px; background: #e0e0e0;
        }
        .pipeline-mini-timeline .tl-line.filled { background: var(--sw-navy); }

        /* ── Pipeline — Project detail drawer ── */
        .project-drawer-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.25); z-index: 900;
            opacity: 0; transition: opacity 0.2s; pointer-events: none;
        }
        .project-drawer-overlay.open { opacity: 1; pointer-events: auto; }
        .project-drawer {
            position: fixed; top: 0; right: -380px; width: 380px; height: 100%;
            background: #fff; z-index: 901; box-shadow: -4px 0 24px rgba(0,0,0,0.12);
            transition: right 0.25s ease; display: flex; flex-direction: column;
        }
        .project-drawer.open { right: 0; }
        .project-drawer-head {
            display: flex; align-items: center; justify-content: space-between;
            padding: 20px 24px; border-bottom: 1px solid #e8e8e8;
        }
        .project-drawer-head h3 { font-size: 16px; font-weight: 600; margin: 0; }
        .project-drawer-close {
            background: none; border: none; font-size: 22px; cursor: pointer;
            color: #999; line-height: 1; padding: 4px;
        }
        .project-drawer-close:hover { color: #333; }
        .project-drawer-body {
            flex: 1; overflow-y: auto; padding: 24px;
        }
        .drawer-field { margin-bottom: 14px; }
        .drawer-field-label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.4px; color: #999; margin-bottom: 3px; }
        .drawer-field-value { font-size: 14px; color: #222; }
        .drawer-field-value.readonly { color: #666; }
        .drawer-edit {
            width: 100%; padding: 5px 8px; font-size: 13px; font-family: inherit;
            border: 1px solid #ddd; border-radius: 4px; background: #fff; outline: none;
            color: #222; box-sizing: border-box;
        }
        .drawer-edit:focus { border-color: var(--sw-navy); }
        select.drawer-edit { cursor: pointer; }

        /* ── Pipeline — Full-width with side padding ── */
        .project-list-view { margin-left: -60px; margin-right: -60px; padding-left: 48px; padding-right: 48px; }

        /* ── Pipeline — Auto-switch to cards on mobile ── */
        @media (max-width: 767px) {
            #viewTableContainer { display: none !important; }
        }

        /* ── Pipeline — Card enhancements ── */
        .project-card-pipeline {
            display: flex; align-items: center; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;
        }
        .project-card-amount {
            font-size: 14px; font-weight: 600; color: var(--sw-navy);
        }
        .project-card-meta-row {
            display: flex; align-items: center; gap: 12px; font-size: 11px; color: #888; margin-top: 6px;
        }
        .project-card-deadline { color: #c62828; font-weight: 600; }
        .project-card-urgent { border-left: 3px solid #c62828; }

        /* ── Pipeline — Submission assignment ── */
        .sub-assignment-row {
            display: flex; gap: 12px; flex-wrap: wrap; margin-top: 10px; padding-top: 10px;
            border-top: 1px solid #f0f0f0;
        }
        .sub-assignment-row .sa-field {
            display: flex; flex-direction: column; gap: 3px; flex: 1; min-width: 120px;
        }
        .sub-assignment-row .sa-label {
            font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; color: #999;
        }
        .sub-assignment-row select, .sub-assignment-row input[type="date"] {
            padding: 5px 8px; border: 1px solid #ddd; border-radius: 4px;
            font-size: 12px; font-family: inherit; background: #fff;
        }

        /* Panneau soumissions dans le calculateur */
        .header-sub-panel {
            display: none; background: #fff; border: 1px solid #e0e0e0; border-radius: 8px;
            padding: 10px 14px; margin: -8px 0 16px;
        }
        .header-sub-panel .sub-line {
            display: flex; align-items: center; gap: 8px;
            padding: 6px 8px; border-radius: 4px; cursor: pointer;
        }
        .header-sub-panel .sub-line:hover { background: #f5f5f5; }
        .header-sub-panel .sub-line.active { background: #eef3ef; }
        .header-sub-panel .sub-line.active .sub-number { color: var(--sw-text); }
        .header-sub-panel .sub-line .sub-kebab {
            margin-left: auto; background: none; border: none;
            color: #999; cursor: pointer; font-size: 16px; padding: 2px 6px;
            font-family: inherit; border-radius: 4px;
        }
        .header-sub-panel .sub-line .sub-kebab:hover { color: #333; background: #e0e0e0; }
        .header-sub-panel .header-sub-label {
            font-size: 11px; font-weight: 600; color: #888; text-transform: uppercase;
            letter-spacing: 0.5px; margin-bottom: 6px; cursor: pointer; user-select: none;
            display: flex; align-items: center; gap: 6px;
        }
        .header-sub-panel .header-sub-label:hover { color: #555; }
        .header-sub-label .sub-chevron { transition: transform 0.2s; display: inline-block; font-size: 10px; }
        .header-sub-label .sub-chevron.open { transform: rotate(90deg); }
        .header-sub-body {
            overflow: hidden; transition: max-height 0.25s ease, opacity 0.2s ease;
            max-height: 500px; opacity: 1;
        }
        .header-sub-body.collapsed { max-height: 0; opacity: 0; }

        /* ── Matériaux par défaut section — same style as header-sub-panel ── */
        .default-materials-panel {
            background: #fff; border: 1px solid #e0e0e0; border-radius: 8px;
            padding: 10px 14px; margin: -8px 0 16px; overflow: visible; position: relative; z-index: 2;
        }
        .default-materials-panel .dm-label {
            font-size: 11px; font-weight: 600; color: #888; text-transform: uppercase;
            letter-spacing: 0.5px; margin-bottom: 6px; cursor: pointer; user-select: none;
            display: flex; align-items: center; gap: 6px;
        }
        .default-materials-panel .dm-label:hover { color: #555; }
        .dm-label .dm-arrow { transition: transform 0.2s; display: inline-block; font-size: 10px; }
        .dm-label .dm-arrow.open { transform: rotate(90deg); }
        .default-materials-body {
            overflow: visible; transition: max-height 0.3s ease, opacity 0.2s ease;
            max-height: 600px; opacity: 1; padding-top: 8px;
        }
        .default-materials-body.collapsed { max-height: 0; opacity: hidden; padding-top: 0; overflow: hidden; }
        .dm-rows { display: flex; flex-direction: column; gap: 6px; margin-bottom: 8px; }
        .dm-row {
            display: flex; gap: 6px; align-items: center; font-size: 12px;
        }
        .dm-row select {
            width: 180px; padding: 5px 8px; border: 1px solid #ddd; border-radius: 4px;
            font-size: 12px; font-family: inherit; background: #fff; flex-shrink: 0;
        }
        .dm-row select:focus { border-color: var(--sw-navy); outline: none; }
        .dm-search-wrap {
            flex: 1; position: relative;
        }
        .dm-search-wrap input {
            width: 100%; padding: 5px 8px; border: 1px solid #ddd; border-radius: 4px;
            font-size: 12px; font-family: inherit; box-sizing: border-box;
        }
        .dm-search-wrap input:focus { border-color: var(--sw-navy); outline: none; }
        .dm-search-wrap input.dm-resolved {
            background: #edf1f7; border-color: var(--sw-navy); color: #333;
        }
        .dm-autocomplete {
            position: absolute; top: 100%; left: 0; right: 0; z-index: 100;
            background: #fff; border: 1px solid #ddd; border-top: none; border-radius: 0 0 4px 4px;
            max-height: 280px; overflow-y: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: none;
        }
        .dm-autocomplete.open { display: block; }
        .dm-ac-item {
            padding: 6px 10px; cursor: pointer; font-size: 12px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .dm-ac-item:hover, .dm-ac-item.active { background: #edf1f7; }
        .dm-ac-item .dm-ac-cat { font-size: 10px; color: #999; }
        .dm-ac-item .dm-ac-secondary { font-size: 10px; color: #999; margin-left: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 160px; }
        .dm-row .dm-remove {
            background: none; border: none; color: #ccc; cursor: pointer; font-size: 16px;
            padding: 0 4px; flex-shrink: 0; line-height: 1;
        }
        .dm-row .dm-remove:hover { color: #c62828; }
        .dm-add-btn {
            font-size: 12px; color: var(--sw-navy); background: none; border: 1px dashed #ccc;
            cursor: pointer; padding: 6px 12px; border-radius: 4px; width: 100%;
        }
        .dm-add-btn:hover { border-color: var(--sw-navy); background: #edf1f7; }

        /* ── Main action buttons ── */
        .ph-actions { display: none; /* replaced by timeline CTA */ }
        .btn-main-action {
            display: none; padding: 12px 28px; font-size: 15px; font-weight: 600;
            border: none; border-radius: 8px; cursor: pointer; font-family: inherit;
            transition: opacity 0.15s; background: #1565c0; color: #fff;
        }
        .btn-main-action:hover { opacity: 0.85; }
        .btn-main-green { background: var(--sw-navy); color: #fff; }
        .btn-main-orange { background: #e65100; color: #fff; }
        .btn-main-purple { background: #4527a0; color: #fff; }
        .btn-main-red { background: #c0392b; color: #fff; }

        /* ── Kebab menu ── */
        .kebab-menu { position: relative; }
        .btn-kebab {
            background: #f5f5f5; border: 1px solid #e0e0e0; border-radius: 50%;
            width: 32px; height: 32px; font-size: 16px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            color: #666; transition: all 0.15s; font-family: inherit;
        }
        .btn-kebab:hover { background: #eee; border-color: #ccc; }
        .btn-kebab.active { background: var(--sw-navy); color: #fff; border-color: var(--sw-navy); }
        .kebab-dropdown {
            display: none; position: absolute; top: 100%; right: 0; margin-top: 4px;
            background: #fff; border: 1px solid #e0e0e0; border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1); min-width: 180px; z-index: 100;
            padding: 4px 0;
        }
        .kebab-dropdown.open { display: block; }
        .kebab-dropdown button {
            display: flex; align-items: center; gap: 10px; width: 100%;
            background: none; border: none; padding: 10px 16px; font-size: 13px;
            font-family: inherit; cursor: pointer; color: #333; text-align: left;
        }
        .kebab-dropdown button:hover { background: #f5f5f5; }
        .kebab-icon { font-size: 15px; width: 20px; text-align: center; }

        /* Version Drawer */
        .version-drawer { position:fixed; right:0; top:0; width:360px; height:100vh; background:#fff; box-shadow:-4px 0 20px rgba(0,0,0,.15); z-index:1000; display:flex; flex-direction:column; transition:transform .3s ease; }
        .version-drawer-header { padding:16px 20px; border-bottom:1px solid #e0e0e0; display:flex; justify-content:space-between; align-items:center; }
        .version-drawer-header h3 { margin:0; font-size:16px; }
        .btn-close-drawer { background:none; border:none; font-size:22px; cursor:pointer; color:#666; padding:4px 8px; }
        .btn-close-drawer:hover { color:#000; }
        .version-list { flex:1; overflow-y:auto; padding:12px; }
        .version-card { padding:12px; border:1px solid #e0e0e0; border-radius:8px; margin-bottom:8px; cursor:pointer; transition:all .15s; }
        .version-card:hover { background:#f5f5f5; border-color:#bbb; }
        .version-snapshot-overlay { position:fixed; inset:0; background:rgba(0,0,0,.85); z-index:1100; overflow-y:auto; padding:40px; }

        .bypass-badge {
            display: inline-block; background: #ffebee; color: #c0392b;
            font-size: 9px; font-weight: 700; padding: 2px 6px;
            border-radius: 3px; margin-left: 6px; text-transform: uppercase;
            letter-spacing: 0.3px; vertical-align: middle;
        }
        .timeline-dot-bypass { background: #c0392b; }
        .timeline-action-bypass { color: #c0392b; font-weight: 700; }
        .timeline-comment-bypass { background: #ffebee; border-left: 3px solid #c0392b; padding: 6px 10px; border-radius: 4px; }
        .timeline-dot-offline_accepted { background: #2e7d32; }
        .timeline-action-offline_accepted { color: #2e7d32; font-weight: 700; }
        .timeline-comment-offline_accepted { background: #e8f5e9; border-left: 3px solid #2e7d32; padding: 6px 10px; border-radius: 4px; }
        .timeline-dot-duplicated { background: #546e7a; }
        .timeline-action-duplicated { color: #546e7a; font-weight: 700; }
        .timeline-dot-unlocked { background: #c62828; }
        .timeline-action-unlocked { color: #c62828; font-weight: 700; text-transform: uppercase; }
        .timeline-comment-unlocked { background: #ffebee; border-left: 3px solid #c62828; padding: 6px 10px; border-radius: 4px; font-weight: 600; }
        .status-badge {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 5px 12px; font-size: 11px; font-weight: 700;
            border-radius: 12px; text-transform: uppercase; letter-spacing: 0.3px;
        }
        .status-draft { background: #f0f0f0; color: #666; }
        .status-pending_internal { background: #fff3e0; color: #e65100; }
        .status-returned { background: #fce4ec; color: #c62828; }
        .status-approved_internal { background: #e8f5e9; color: #2e7d32; }
        .status-sent_client { background: #e3f2fd; color: #1565c0; }
        .status-accepted { background: #e8f5e9; color: #1b5e20; }
        .status-lost { background: #ffebee; color: #c62828; }

        .project-card-delete {
            position: absolute; top: 8px; right: 8px; background: none; border: none;
            color: #ccc; cursor: pointer; font-size: 18px; padding: 4px 8px;
            border-radius: 4px; transition: all 0.15s; line-height: 1;
        }
        .project-card-delete:hover { color: #c62828; background: #ffebee; }
        .card-follow { font-size: 18px; flex-shrink: 0; }

        .project-empty {
            text-align: center; padding: 60px 20px; color: #999; font-size: 15px;
        }

        /* Formulaire nouveau projet (inline) */
        .new-project-form {
            display: none; background: #f8f8f8; border: 1px solid #e0e0e0;
            border-radius: 8px; padding: 20px; margin-bottom: 20px;
        }
        .new-project-form.active { display: block; }
        .new-project-form .form-row {
            display: flex; gap: 12px; margin-bottom: 12px; flex-wrap: wrap;
        }
        .new-project-form input {
            flex: 1; min-width: 200px; padding: 10px 14px; font-size: 14px;
            border: 1px solid #ccc; border-radius: 6px; font-family: inherit;
        }
        .new-project-form input:focus { outline: none; border-color: var(--sw-navy); }
        .new-project-form-actions { display: flex; gap: 8px; }
        .btn-create-project {
            background: var(--sw-navy); color: #fff; border: none;
            padding: 10px 20px; font-size: 14px; cursor: pointer;
            border-radius: 6px; font-family: inherit;
        }
        .btn-create-project:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-cancel-project {
            background: #fff; color: #666; border: 1px solid #ccc;
            padding: 10px 20px; font-size: 14px; cursor: pointer;
            border-radius: 6px; font-family: inherit;
        }

        /* ═══════════════════════════════════════════════════════════════
           HEADER PROJET (dans le calculateur)
           ═══════════════════════════════════════════════════════════════ */

        .project-header {
            background: #fff; border: 1px solid #e0e0e0; border-radius: 8px;
            padding: 20px 24px; margin-bottom: 16px; position: relative;
            display: flex; flex-direction: column; gap: 4px;
        }
        .ph-top-bar {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 8px;
        }
        .ph-top-actions { display: flex; align-items: center; gap: 8px; }
        .btn-back-projects {
            background: none; border: none; color: var(--sw-navy);
            cursor: pointer; font-size: 14px; font-family: inherit;
            padding: 6px 0; white-space: nowrap;
        }
        .btn-back-projects:hover { text-decoration: underline; }
        .btn-header-link {
            background: none; border: none; color: #555; font-size: 13px;
            font-family: inherit; cursor: pointer; padding: 4px 8px;
            transition: color 0.15s;
        }
        .btn-header-link:hover { color: var(--sw-navy); }
        .ai-assistant-btn { vertical-align: middle; }
        .ph-project-name {
            font-size: 26px; font-weight: 700; border: none; outline: none;
            background: transparent; font-family: inherit; color: var(--sw-text);
            padding: 0; width: 100%; user-select: none; pointer-events: none; cursor: default;
        }
        .ph-sub-number { font-size: 13px; color: #999; font-weight: 400; display: block; margin-top: 2px; }
        .ph-status-row { margin: 4px 0; }
        .ph-total-section { margin: 12px 0 4px; }
        .ph-total-label { font-size: 12px; color: #888; margin-bottom: 2px; }
        .ph-total-amount { font-size: 28px; font-weight: 700; color: var(--sw-text); }
        .save-indicator {
            font-size: 11px; color: #999; white-space: nowrap;
            position: absolute; top: 8px; right: 12px;
        }
        .save-indicator.saving { color: var(--sw-navy); }

        /* Status Timeline */
        .status-timeline {
            margin: 16px 0 4px; display: flex; align-items: center; gap: 0;
            position: relative;
        }
        .timeline-step {
            display: flex; align-items: center; gap: 6px; position: relative; flex: 0 0 auto;
            padding-right: 16px;
        }
        .timeline-step:last-child { padding-right: 0; }
        .timeline-step::after {
            content: ''; position: absolute; right: -1px; top: 50%;
            transform: translateY(-50%); width: 24px; height: 1px; background: #ddd;
        }
        .timeline-step:last-child::after { display: none; }
        .timeline-step.completed::after { background: #4caf50; }
        .timeline-circle {
            width: 20px; height: 20px; border-radius: 50%; display: flex;
            align-items: center; justify-content: center; font-size: 11px; flex-shrink: 0;
        }
        .timeline-step.completed .timeline-circle {
            background: #4caf50; color: #fff;
        }
        .timeline-step.active .timeline-circle {
            background: var(--sw-navy); color: #fff; box-shadow: 0 0 0 3px rgba(11,18,32,0.15);
        }
        .timeline-step.active.returned .timeline-circle {
            background: #ff9800; box-shadow: 0 0 0 3px rgba(255,152,0,0.15);
        }
        .timeline-step.active.lost .timeline-circle {
            background: #c62828; box-shadow: 0 0 0 3px rgba(198,40,40,0.15);
        }
        .timeline-step.future .timeline-circle {
            background: #f0f0f0; color: #bbb; border: 1px solid #ddd;
        }
        .timeline-label {
            font-size: 12px; color: #666; white-space: nowrap;
        }
        .timeline-step.active .timeline-label {
            font-weight: 700; color: var(--sw-text);
        }
        .timeline-step.completed .timeline-label {
            color: #666;
        }
        .timeline-cta {
            margin-left: auto; padding-left: 16px; display: flex; gap: 8px; align-items: center;
        }
        .timeline-cta button {
            background: var(--sw-navy); color: #fff; border: none; padding: 8px 20px;
            border-radius: 6px; font-size: 13px; font-weight: 600; font-family: inherit;
            cursor: pointer; transition: all 0.15s; white-space: nowrap;
        }
        .timeline-cta button:hover {
            background: #3e4f42; transform: translateY(-1px); box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        .timeline-cta button.btn-orange {
            background: #ff9800;
        }
        .timeline-cta button.btn-orange:hover {
            background: #f57c00;
        }
        .timeline-cta button.btn-outline-orange {
            background: transparent; color: #e65100; border: 1.5px solid #e65100;
        }
        .timeline-cta button.btn-outline-orange:hover {
            background: #fff3e0; box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        .timeline-cta button.btn-outline {
            background: transparent; color: #555; border: 1.5px solid #ccc;
        }
        .timeline-cta button.btn-outline:hover {
            background: #f5f5f5; box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        .timeline-cta button.btn-outline-red {
            background: transparent; color: #c62828; border: 1.5px solid #c62828;
        }
        .timeline-cta button.btn-outline-red:hover {
            background: #ffebee; box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        .sub-line.archived { opacity: 0.5; }

        /* Timeline step clickable (pour copier lien client) */
        .timeline-step.clickable {
            cursor: pointer;
        }
        .timeline-step.clickable .timeline-circle {
            animation: heartbeat 2s ease-in-out infinite;
        }
        .timeline-step.clickable:hover .timeline-circle {
            transform: scale(1.1);
            box-shadow: 0 0 0 4px rgba(11,18,32,0.25);
        }
        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            14% { transform: scale(1.15); }
            28% { transform: scale(1); }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        @keyframes ai-breathe {
            0%, 100% { opacity: 0.6; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.1); }
        }
        @keyframes scope-flash {
            0% { background: rgba(75, 96, 80, 0.25); }
            100% { background: #edf0f5; }
        }
        .ai-scope-badge.flash {
            animation: scope-flash 500ms ease-out;
        }

        /* Modal Rentabilité */
        /* ── Rentabilité modal ── */
        .rentab-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4); z-index: 9000; justify-content: center; align-items: flex-start; padding: 40px 20px;
        }
        .rentab-overlay.active { display: flex; }
        .rentab-modal {
            background: #fff; border-radius: 10px; max-width: 1100px; width: 100%;
            max-height: 90vh; overflow-y: auto; box-shadow: 0 8px 40px rgba(0,0,0,0.2);
        }
        .rentab-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px 32px; border-bottom: 1px solid #e8e8e8;
        }
        .rentab-header h2 { font-size: 18px; font-weight: 600; color: var(--sw-text); margin: 0; }
        .rentab-close {
            background: none; border: none; font-size: 24px; cursor: pointer; color: #999;
            padding: 4px 8px; transition: color 0.15s;
        }
        .rentab-close:hover { color: var(--sw-text); }
        .rentab-body { padding: 28px 32px; }
        .rentab-columns { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; }
        .rentab-section { margin-bottom: 24px; }
        .rentab-section-title {
            font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
            color: #666; margin-bottom: 10px; padding-bottom: 6px; border-bottom: 1px solid #e8e8e8;
        }
        .rentab-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .rentab-table td { padding: 6px 10px; }
        .rentab-table td:first-child { color: #555; font-weight: 400; }
        .rentab-table td:last-child { text-align: right; font-weight: 600; font-family: 'SF Mono', 'Consolas', monospace; color: var(--sw-text); }
        .rentab-table tr.highlight td { background: #f5f5f5; font-weight: 700; color: var(--sw-text); border-radius: 4px; }
        .rentab-table tr.highlight td:first-child { font-size: 12px; text-transform: uppercase; letter-spacing: 0.3px; }
        .rentab-table tr.total td { border-top: 1px solid #ccc; font-weight: 700; font-size: 14px; padding-top: 10px; }
        .rentab-table tr.spacer td { padding: 8px 0; }
        .rentab-dept-table { width: 100%; border-collapse: collapse; font-size: 12px; border: 1px solid #e8e8e8; border-radius: 6px; overflow: hidden; }
        .rentab-dept-table th {
            background: #f5f5f5; color: #666; padding: 8px 8px;
            font-weight: 600; font-size: 11px; text-align: center; border-bottom: 1px solid #e8e8e8;
        }
        .rentab-dept-table td { padding: 8px 8px; text-align: right; font-family: 'SF Mono', 'Consolas', monospace; color: var(--sw-text); }
        .rentab-dept-table td:first-child { text-align: left; font-family: inherit; color: #555; font-weight: 500; }
        .rentab-margins {
            margin-top: 8px; border: 1px solid #e8e8e8; border-radius: 6px; overflow: hidden;
        }
        .rentab-margins-row {
            display: flex; justify-content: space-between; padding: 8px 14px;
            font-size: 13px; border-bottom: 1px solid #eee; align-items: center;
        }
        .rentab-margins-row:last-child { border-bottom: none; }
        .rentab-margins-row.profit-row { background: #f5f5f5; font-weight: 700; }
        .rentab-margins-row span:first-child { color: #555; }
        .rentab-margins-row span:last-child { font-weight: 600; font-family: 'SF Mono', 'Consolas', monospace; color: var(--sw-text); }
        .rentab-full { grid-column: 1 / -1; }
        .rentab-footer {
            padding: 16px 32px 24px; display: flex; justify-content: flex-end;
        }
        .rentab-footer button {
            padding: 10px 28px; background: #fff; border: 1px solid #ddd; border-radius: 6px;
            font-size: 14px; font-family: inherit; cursor: pointer; color: #333; transition: all 0.15s;
        }
        .rentab-footer button:hover { background: #f5f5f5; border-color: #bbb; }
        .btn-rentab {
            background: none; border: 1px solid rgba(255,255,255,0.4); color: rgba(255,255,255,0.85);
            padding: 4px 10px; border-radius: 4px; font-size: 11px; cursor: pointer; white-space: nowrap;
            font-family: inherit; transition: all 0.15s;
        }
        .btn-rentab:hover { background: rgba(255,255,255,0.15); border-color: rgba(255,255,255,0.7); }
        .btn-ai-focus {
            display: inline-flex; align-items: center; justify-content: center;
            width: 28px; height: 28px; padding: 0; border: none;
            background: transparent; cursor: pointer; position: relative;
            vertical-align: middle;
        }
        .btn-ai-focus::after {
            content: ''; display: block; width: 9px; height: 9px;
            border-radius: 50%; background: #fff;
            opacity: 0.6; box-shadow: 0 0 0 3px rgba(255,255,255,0.12);
            transition: all 200ms ease;
            animation: ai-breathe 3s ease-in-out infinite;
        }
        .btn-ai-focus:hover::after { opacity: 1; transform: scale(1.05); }
        .btn-ai-focus.active::after {
            opacity: 1; box-shadow: 0 0 0 4px rgba(255,255,255,0.25);
            animation: none;
        }
        /* Print */
        @media print {
            .nav-bar { display: none; }
            .btn-add, .btn-remove, .add-row-container, .group-images-section { display: none !important; }
            .item-select { border: none; background: none; padding: 0; appearance: none; background-image: none; }
            .qty-input, .ajout-description, .ajout-price, .ajout-markup { border: none; background: none; }
            .calculator-container { page-break-inside: avoid; }
        }

        /* Responsive */
        @media (max-width: 900px) {
            .nav-bar { padding: 0 20px; gap: 16px; }
            .main-content { padding: 24px 16px; }
            .project-list-view { margin-left: -16px; margin-right: -16px; padding-left: 16px; padding-right: 16px; }
            .calc-header, .calc-row {
                grid-template-columns: 24px 45px 1fr 70px 70px 110px 90px 80px 24px 100px 24px;
                gap: 4px;
                padding: 3px 8px;
                font-size: 10px;
            }
            .btn-add, .btn-remove, .btn-add-group { font-size: 12px; }
            .ajout-description, .ajout-price, .ajout-markup { font-size: 11px !important; }
            .calculator-container { font-size: 13px; }
        }

        /* ═══════════════════════════════════════════════════════════════
           TIMELINE DRAWER (historique soumission)
           ═══════════════════════════════════════════════════════════════ */
        .timeline-drawer-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.3); z-index: 8500;
        }
        .timeline-drawer-overlay.active { display: block; }
        .timeline-drawer {
            position: fixed; top: 0; right: -420px; width: 400px; height: 100%;
            background: #fff; box-shadow: -4px 0 20px rgba(0,0,0,0.15);
            z-index: 8600; transition: right 0.3s ease; overflow-y: auto;
        }
        .timeline-drawer.active { right: 0; }
        .timeline-drawer-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px 20px; border-bottom: 2px solid var(--sw-navy);
            background: #fafafa; position: sticky; top: 0; z-index: 1;
        }
        .timeline-drawer-header h3 { font-size: 15px; font-weight: 700; margin: 0; color: var(--sw-text); }
        .timeline-drawer-close {
            background: none; border: none; font-size: 20px; cursor: pointer; color: #666; padding: 0 4px;
        }
        .timeline-drawer-close:hover { color: var(--sw-text); }
        .timeline-drawer-body { padding: 20px; }
        .timeline-empty { text-align: center; color: #999; font-size: 13px; padding: 40px 0; font-style: italic; }

        .timeline-entry { position: relative; padding-left: 28px; margin-bottom: 20px; }
        .timeline-entry::before {
            content: ''; position: absolute; left: 8px; top: 24px; bottom: -20px;
            width: 2px; background: #e0e0e0;
        }
        .timeline-entry:last-child::before { display: none; }
        .timeline-dot {
            position: absolute; left: 2px; top: 6px; width: 14px; height: 14px;
            border-radius: 50%; border: 2px solid #fff;
        }
        .timeline-dot-submitted { background: #1565c0; }
        .timeline-dot-approved { background: #2e7d32; }
        .timeline-dot-returned { background: #e65100; }
        .timeline-dot-sent { background: #4527a0; }
        .timeline-entry-header {
            display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 4px;
        }
        .timeline-action {
            font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px;
        }
        .timeline-action-submitted { color: #1565c0; }
        .timeline-action-approved { color: #2e7d32; }
        .timeline-action-returned { color: #e65100; }
        .timeline-action-sent { color: #4527a0; }
        .timeline-date { font-size: 11px; color: #999; }
        .timeline-reviewer { font-size: 12px; color: #666; margin-bottom: 4px; }
        .timeline-comment {
            font-size: 13px; color: #444; background: #f8f8f8;
            border-radius: 6px; padding: 8px 12px; border-left: 3px solid #e0e0e0;
        }
        .timeline-comment-submitted { border-left-color: #1565c0; }
        .timeline-comment-approved { border-left-color: #2e7d32; }
        .timeline-comment-returned { border-left-color: #e65100; }
        .timeline-comment-sent { border-left-color: #4527a0; }
        .timeline-version { font-size: 10px; color: #aaa; margin-top: 4px; }

        @media (max-width: 600px) {
            .timeline-drawer { width: 100%; right: -100%; }
        }

        /* ═══════════════════════════════════════════════════════════════
           AI ASSISTANT DRAWER — Premium Redesign
           ═══════════════════════════════════════════════════════════════ */

        @keyframes aiMsgFadeIn {
            from { opacity: 0; transform: translateY(6px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes aiCardStagger {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .ai-drawer-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: transparent; z-index: 8700; pointer-events: none;
        }
        .ai-drawer-overlay.active { display: block; }

        .ai-drawer {
            position: fixed; top: 0; right: -460px; width: 440px; height: 100%;
            background: rgba(255, 255, 255, 0.82);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border-left: 1px solid rgba(0, 0, 0, 0.06);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.06), inset 0 1px 0 rgba(255, 255, 255, 0.4);
            z-index: 8800; transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; flex-direction: column;
        }
        .ai-drawer.active { right: 0; }
        .ai-drawer:hover, .ai-drawer:focus-within {
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
        }

        /* Header — minimal */
        .ai-drawer-header {
            display: flex; align-items: center; gap: 10px;
            padding: 16px 20px; border-bottom: 1px solid rgba(0, 0, 0, 0.06);
            background: transparent; flex-shrink: 0;
        }
        .ai-drawer-header h3 {
            font-size: 14px; font-weight: 600; margin: 0;
            color: #1A1A2E; flex: 1; letter-spacing: -0.01em;
        }
        .ai-scope-badge {
            font-size: 10px; font-weight: 500; padding: 3px 8px;
            border-radius: 10px; background: #edf0f5; color: var(--sw-navy);
            text-transform: uppercase; letter-spacing: 0.3px;
        }
        .ai-drawer-close {
            background: none; border: none; font-size: 18px;
            cursor: pointer; color: #9ca3af; padding: 2px 4px;
            transition: color 0.15s; border-radius: 6px;
        }
        .ai-drawer-close:hover { color: #1A1A2E; }

        /* Messages area */
        .ai-messages {
            flex: 1; min-height: 0; overflow-y: auto; padding: 20px;
            display: flex; flex-direction: column; gap: 16px;
            overscroll-behavior: contain;
            scrollbar-width: thin; scrollbar-color: #e5e7eb transparent;
        }
        .ai-messages::before { content: ''; flex: 1 1 0; }
        .ai-messages::-webkit-scrollbar { width: 5px; }
        .ai-messages::-webkit-scrollbar-track { background: transparent; }
        .ai-messages::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 3px; }
        .ai-messages::-webkit-scrollbar-thumb:hover { background: #d1d5db; }
        .ai-messages:empty::after {
            content: 'Posez une question sur votre projet, demandez une analyse de rentabilit\00e9, ou d\00e9crivez ce que vous voulez ajouter.';
            color: #9ca3af; font-size: 13px; text-align: center; padding: 40px 24px;
            line-height: 1.6;
        }

        /* Message base */
        .ai-msg {
            max-width: 85%; padding: 0; border-radius: 0;
            font-size: 14px; line-height: 1.5; word-wrap: break-word;
            color: #1A1A2E;
            animation: aiMsgFadeIn 180ms ease-out both;
        }
        .ai-msg p { margin: 0 0 8px 0; }
        .ai-msg p:last-child { margin-bottom: 0; }
        .ai-msg ul, .ai-msg ol { margin: 6px 0; padding-left: 20px; }
        .ai-msg li { margin-bottom: 4px; }
        .ai-msg strong { font-weight: 600; }
        .ai-msg code {
            background: #f3f4f6; padding: 2px 6px; border-radius: 4px;
            font-size: 13px; font-family: 'SF Mono', 'Cascadia Code', 'Consolas', monospace;
        }
        .ai-msg pre {
            background: #f8f9fa; padding: 12px 14px; border-radius: 8px;
            overflow-x: auto; font-size: 12px; margin: 8px 0;
            font-family: 'SF Mono', 'Cascadia Code', 'Consolas', monospace;
            line-height: 1.5;
        }

        /* Cards — replace tables */
        .ai-msg .ai-card-stack { display: flex; flex-direction: column; gap: 6px; margin: 10px 0; }
        .ai-msg .ai-card {
            background: #F8FAFC; border-radius: 10px; padding: 12px 14px;
            animation: aiCardStagger 180ms ease-out both;
        }
        .ai-msg .ai-card-row {
            display: flex; justify-content: space-between; align-items: baseline;
        }
        .ai-msg .ai-card-code {
            font-size: 12px; font-weight: 600; color: #6B7280;
            font-family: 'SF Mono', 'Cascadia Code', 'Consolas', monospace;
            letter-spacing: 0.02em;
        }
        .ai-msg .ai-card-price {
            font-size: 13px; font-weight: 600; color: #1A1A2E;
            font-family: 'SF Mono', 'Cascadia Code', 'Consolas', monospace;
        }
        .ai-msg .ai-card-desc {
            font-size: 13px; color: #374151; margin-top: 2px; line-height: 1.4;
        }
        .ai-msg .ai-card-meta {
            font-size: 11px; color: #9ca3af; margin-top: 4px;
        }

        /* Legacy table fallback — soft styling */
        .ai-msg table {
            width: 100%; border-collapse: separate; border-spacing: 0;
            margin: 8px 0; font-size: 13px; border-radius: 8px;
            overflow: hidden; background: #F8FAFC;
        }
        .ai-msg th, .ai-msg td {
            padding: 8px 12px; border: none; text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }
        .ai-msg th {
            background: var(--sw-border-2); font-weight: 600; font-size: 11px;
            color: #6B7280; text-transform: uppercase; letter-spacing: 0.04em;
        }
        .ai-msg tr:last-child td { border-bottom: none; }

        /* User messages */
        .ai-msg-user {
            align-self: flex-end; background: var(--sw-border-2);
            padding: 10px 14px; border-radius: 12px; border-bottom-right-radius: 4px;
        }

        /* Assistant messages */
        .ai-msg-assistant {
            align-self: flex-start; background: transparent;
            padding: 2px 0;
        }

        /* Action messages */
        .ai-msg-action {
            align-self: flex-start; background: #FFFBEB;
            border-radius: 10px; padding: 10px 14px; font-size: 13px; color: #92400e;
            max-width: 92%;
        }
        .ai-msg-action .ai-action-label {
            font-weight: 600; font-size: 11px; color: #b45309;
            text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 4px;
        }

        /* Confirm messages — CTA style */
        .ai-msg-confirm {
            align-self: flex-start; background: #fff; border: none;
            border-radius: 12px; padding: 14px 16px; max-width: 92%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 0 0 1px rgba(0,0,0,0.04);
        }
        .ai-msg-confirm .ai-confirm-text {
            font-size: 14px; color: #1A1A2E; margin-bottom: 12px; line-height: 1.5;
        }
        .ai-confirm-actions { display: flex; gap: 8px; align-items: center; }
        .ai-confirm-actions button {
            padding: 8px 18px; border-radius: 8px; font-size: 13px; font-weight: 600;
            cursor: pointer; border: none; transition: all 0.15s;
        }
        .btn-ai-apply {
            background: var(--sw-navy); color: #fff;
        }
        .btn-ai-apply:hover { background: var(--sw-navy-hover); }
        .btn-ai-dismiss {
            background: transparent; color: #6B7280; padding: 8px 12px;
        }
        .btn-ai-dismiss:hover { color: #1A1A2E; }
        .ai-confirm-applied {
            font-size: 12px; color: var(--sw-navy); font-weight: 500;
        }

        /* Typing indicator */
        .ai-typing {
            padding: 10px 20px; display: none;
        }
        .ai-typing.active { display: flex; gap: 6px; align-items: center; }
        .ai-typing-dot {
            width: 8px; height: 8px; border-radius: 50%; background: var(--sw-navy);
            animation: aiTypingBounce 1.4s ease-in-out infinite;
        }
        .ai-typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .ai-typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes aiTypingBounce {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.25; }
            30% { transform: translateY(-4px); opacity: 0.9; }
        }

        /* Quick actions */
        .ai-quick-actions {
            display: flex; gap: 6px; padding: 10px 20px; flex-wrap: wrap;
            border-top: 1px solid #f5f5f5; flex-shrink: 0;
        }
        .ai-quick-btn {
            padding: 6px 12px; border-radius: 8px; font-size: 12px;
            background: #fff; border: 1px solid #e5e7eb; color: #6B7280;
            cursor: pointer; transition: all 0.15s; white-space: nowrap;
            font-weight: 500;
        }
        .ai-quick-btn:hover { background: #f9fafb; border-color: #d1d5db; color: #374151; }

        /* Input area */
        .ai-input-area {
            display: flex; gap: 8px; padding: 12px 16px 14px;
            border-top: 1px solid #f0f0f0;
            background: #fff; flex-shrink: 0; align-items: flex-end;
        }
        .ai-input-area textarea {
            flex: 1; resize: none; border: 1px solid #e5e7eb; border-radius: 10px;
            padding: 10px 14px; font-size: 14px; font-family: inherit; line-height: 1.4;
            max-height: 120px; min-height: 40px; outline: none;
            transition: border-color 0.15s; background: #fafbfc;
            color: #1A1A2E;
        }
        .ai-input-area textarea:focus { border-color: #d1d5db; background: #fff; }
        .ai-input-area textarea::placeholder { color: #9ca3af; }

        .ai-send-btn {
            width: 36px; height: 36px; border-radius: 10px; border: none;
            background: var(--sw-navy); color: #fff; font-size: 16px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: background 0.15s; flex-shrink: 0;
        }
        .ai-send-btn:hover { background: var(--sw-navy-hover); }
        .ai-send-btn:disabled { background: #e5e7eb; color: #9ca3af; cursor: default; }

        /* Drop zone */
        .ai-drop-zone {
            display: none; position: absolute; inset: 0; background: rgba(11,18,32,0.04);
            border: 2px dashed #d1d5db; border-radius: 10px;
            z-index: 10; align-items: center; justify-content: center;
            font-size: 13px; color: #6B7280; font-weight: 500;
        }
        .ai-drop-zone.active { display: flex; }

        /* Image preview */
        .ai-img-preview {
            display: flex; gap: 6px; padding: 6px 20px; flex-wrap: wrap; flex-shrink: 0;
        }
        .ai-img-preview:empty { display: none; }
        .ai-img-thumb {
            position: relative; width: 52px; height: 52px; border-radius: 8px;
            overflow: hidden; border: 1px solid #e5e7eb;
        }
        .ai-img-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .ai-img-thumb .ai-img-remove {
            position: absolute; top: 2px; right: 2px; width: 18px; height: 18px;
            border-radius: 50%; background: rgba(0,0,0,0.5); color: #fff;
            border: none; font-size: 11px; cursor: pointer; display: flex;
            align-items: center; justify-content: center; line-height: 1;
            transition: background 0.15s;
        }
        .ai-img-thumb .ai-img-remove:hover { background: rgba(0,0,0,0.7); }

        @media (max-width: 600px) {
            .ai-drawer { width: 100%; right: -100%; }
        }
        @media (prefers-reduced-motion: reduce) {
            .ai-drawer, .ai-drawer:hover, .ai-drawer:focus-within {
                transition: none; backdrop-filter: none; -webkit-backdrop-filter: none;
                background: #fff;
            }
        }

        /* Loading & Error Overlay */
        .app-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: #fff; z-index: 10000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.3s ease-out;
        }
        .app-overlay.hidden {
            opacity: 0; pointer-events: none;
        }
        .overlay-content {
            text-align: center; max-width: 400px; padding: 40px;
        }
        .overlay-spinner {
            width: 48px; height: 48px; border: 4px solid #e0e0e0;
            border-top-color: var(--sw-navy);
            border-radius: 50%; margin: 0 auto 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .overlay-title {
            font-size: 20px; font-weight: 700; color: var(--sw-text);
            margin-bottom: 8px;
        }
        .overlay-message {
            font-size: 14px; color: #666; margin-bottom: 24px;
            white-space: pre-line;
        }
        .overlay-error-icon {
            font-size: 48px; margin-bottom: 16px;
        }
        .btn-overlay {
            padding: 12px 24px; background: var(--sw-navy); color: #fff;
            border: none; border-radius: 4px; font-size: 14px; font-weight: 600;
            cursor: pointer; font-family: inherit;
        }
        .btn-overlay:hover { opacity: 0.9; }

        /* ═══════════════════════════════════════════════════════════════
           PROJECT INFO BLOC
           ═══════════════════════════════════════════════════════════════ */
        .ph-info-bloc {
            display: flex; align-items: center; gap: 8px; margin: 2px 0 0; padding: 0;
        }
        .ph-info-text { font-size: 13px; color: #666; line-height: 1.4; }
        .ph-info-text span { color: #999; }
        .ph-info-empty { font-size: 13px; color: #bbb; font-style: italic; }
        .btn-edit-info {
            background: none; border: none; cursor: pointer; color: #bbb;
            font-size: 14px; padding: 2px 6px; transition: color 0.15s; flex-shrink: 0;
        }
        .btn-edit-info:hover { color: var(--sw-navy); }
        .info-modal-row { display: grid; grid-template-columns: 2fr 1fr; gap: 12px; }
        @media (max-width: 500px) { .info-modal-row { grid-template-columns: 1fr; } }

        /* ═══════════════════════════════════════════════════════════════
           CONTACT BADGES STRIP (in project header)
           ═══════════════════════════════════════════════════════════════ */
        .ph-contacts-strip { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 6px; }
        .ph-contact-badge {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 3px 10px; border-radius: 12px;
            background: #f5f5f5; border: 1px solid #e0e0e0;
            font-size: 12px; font-weight: 500; color: #666;
            cursor: pointer; transition: all 0.15s; white-space: nowrap;
        }
        .ph-contact-badge:hover { background: #fff; box-shadow: 0 1px 4px rgba(0,0,0,0.06); color: #333; }
        .ph-contact-badge-role { color: #999; font-weight: 400; font-size: 11px; }
        .ph-contacts-more {
            display: inline-flex; align-items: center; padding: 3px 8px;
            border-radius: 12px; font-size: 12px; font-weight: 500;
            color: var(--sw-navy); cursor: pointer; transition: all 0.15s;
        }
        .ph-contacts-more:hover { background: #f5f5f5; }

        /* ═══════════════════════════════════════════════════════════════
           CONTACTS MODAL
           ═══════════════════════════════════════════════════════════════ */
        .contacts-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4); z-index: 9000;
            justify-content: center; align-items: flex-start; padding: 40px 20px;
        }
        .contacts-overlay.active { display: flex; }
        .contacts-modal {
            background: #fff; border-radius: 16px; max-width: 900px; width: 100%;
            max-height: 90vh; overflow-y: auto;
            box-shadow: 0 4px 24px rgba(0,0,0,0.08), 0 1px 4px rgba(0,0,0,0.04);
        }
        .contacts-modal-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 24px 32px; border-bottom: 1px solid #f0f0f0;
        }
        .contacts-modal-header h2 { font-size: 20px; font-weight: 700; color: var(--sw-text); margin: 0; }
        .contacts-modal-close {
            background: none; border: none; font-size: 24px; cursor: pointer;
            color: #999; padding: 4px 8px; transition: color 0.15s;
        }
        .contacts-modal-close:hover { color: var(--sw-text); }
        .contacts-modal-body { padding: 28px 32px; }
        .contact-cards-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 16px;
        }
        .contact-card {
            background: #fff; border: 1px solid #e8e8e8; border-radius: 16px;
            padding: 20px; transition: box-shadow 0.15s; position: relative;
        }
        .contact-card:hover { box-shadow: 0 2px 12px rgba(0,0,0,0.06); }
        .contact-card-role {
            font-size: 11px; font-weight: 700; text-transform: uppercase;
            letter-spacing: 0.5px; color: var(--sw-navy); margin-bottom: 8px;
            display: flex; align-items: center; gap: 6px;
        }
        .contact-primary-star {
            cursor: pointer; font-size: 15px; line-height: 1; color: #ccc; transition: color 0.15s;
        }
        .contact-primary-star:hover { color: #f5a623; }
        .contact-primary-star.active { color: #f5a623; }
        .contact-card-name { font-size: 16px; font-weight: 700; color: var(--sw-text); margin-bottom: 2px; }
        .contact-card-name-link {
            color: var(--sw-text); text-decoration: none; transition: color 0.15s; cursor: pointer;
        }
        .contact-card-name-link:hover { color: var(--sw-navy); text-decoration: underline; }
        .contact-card-company { font-size: 13px; color: #888; margin-bottom: 12px; }
        .contact-card-company-link {
            color: #888; text-decoration: none; transition: color 0.15s;
        }
        .contact-card-company-link:hover { color: var(--sw-navy); text-decoration: underline; }
        .contact-card-details { font-size: 13px; color: #555; line-height: 1.6; }
        .contact-card-actions { display: flex; gap: 8px; margin-top: 14px; flex-wrap: wrap; }
        .contact-card-btn {
            background: #f8f8f8; border: 1px solid #e8e8e8; border-radius: 8px;
            padding: 6px 12px; font-size: 12px; font-weight: 600; cursor: pointer;
            font-family: inherit; color: #555; transition: all 0.15s;
        }
        .contact-card-btn:hover { background: #f0f0f0; border-color: #ccc; color: var(--sw-text); }
        .contact-card-remove {
            position: absolute; top: 8px; right: 8px; background: none;
            border: none; cursor: pointer; color: #ccc; font-size: 16px;
            padding: 4px; transition: color 0.15s;
        }
        .contact-card-remove:hover { color: #c62828; }
        .contact-card-placeholder {
            background: #fafafa; border: 2px dashed #e0e0e0; border-radius: 16px;
            padding: 20px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.15s; min-height: 120px;
        }
        .contact-card-placeholder:hover { border-color: var(--sw-navy); background: #f3f5f8; }
        .contact-card-placeholder span { font-size: 14px; color: #999; font-weight: 500; }
        .btn-add-contact {
            background: var(--sw-navy); color: #fff; border: none;
            border-radius: 12px; padding: 10px 20px; font-size: 14px;
            font-weight: 600; cursor: pointer; font-family: inherit;
            margin-top: 20px; transition: opacity 0.15s;
        }
        .btn-add-contact:hover { opacity: 0.9; }
        @media (max-width: 600px) {
            .contact-cards-grid { grid-template-columns: 1fr; }
            .contacts-modal-body { padding: 16px; }
            .contacts-modal-header { padding: 16px; }
        }

        /* ═══════════════════════════════════════════════════════════════
           ADD CONTACT SUB-MODAL + COMBOBOX
           ═══════════════════════════════════════════════════════════════ */
        .add-contact-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 9500;
            justify-content: center; align-items: center;
        }
        .add-contact-overlay.active { display: flex; }
        .contact-combo-wrap { position: relative; width: 100%; }
        .contact-combo-wrap input {
            width: 100%; padding: 10px 12px; font-size: 14px;
            font-family: inherit; border: 1px solid var(--sw-border);
            border-radius: 4px; box-sizing: border-box;
        }
        .contact-combo-dd {
            display: none; position: absolute; top: 100%; left: 0; right: 0;
            background: #fff; border: 1px solid #ddd; border-radius: 0 0 6px 6px;
            max-height: 220px; overflow-y: auto; z-index: 10;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .contact-combo-dd.open { display: block; }
        .contact-combo-item {
            padding: 8px 12px; cursor: pointer; font-size: 13px; transition: background 0.1s;
        }
        .contact-combo-item:hover { background: #f0f0f0; }
        .contact-combo-item small { color: #999; }
        .combo-section-header {
            padding: 6px 12px; font-size: 11px; font-weight: 700; text-transform: uppercase;
            letter-spacing: 0.5px; color: #999; background: #fafafa; border-top: 1px solid #eee;
        }
    </style>
</head>
<body>
    <!-- Loading/Error Overlay -->
    <div class="app-overlay" id="appOverlay">
        <div class="overlay-content">
            <div class="overlay-spinner" id="overlaySpinner"></div>
            <div class="overlay-error-icon" id="overlayErrorIcon" style="display:none;">⚠️</div>
            <div class="overlay-title" id="overlayTitle">Chargement de l'application</div>
            <div class="overlay-message" id="overlayMessage">Veuillez patienter...</div>
            <button class="btn-overlay" id="overlayRetryBtn" style="display:none;" onclick="location.reload()">
                Rafraîchir la page
            </button>
        </div>
    </div>

    <!-- Nav bar -->
    <nav class="nav-bar">
        <span class="nav-logo">scopewright</span>
        <a href="app.html" class="nav-back">&larr; Menu</a>
        <div class="data-status" id="dataStatus">
            <span class="status-dot"></span>
            <span class="status-text" id="statusText">Chargement...</span>
        </div>
    </nav>

    <!-- Contenu principal -->
    <div class="main-content">

        <!-- ═══════ VUE 1 : LISTE DES PROJETS ═══════ -->
        <div class="project-list-view active" id="projectListView">
            <div class="project-list-header">
                <h1 class="project-list-title">Mes projets</h1>
                <button class="btn-new-project" onclick="showNewProjectForm()">+ Nouveau projet</button>
            </div>

            <div class="new-project-form" id="newProjectForm">
                <div class="new-project-form-actions">
                    <span style="font-size:13px;color:#666;">Le code projet sera g&eacute;n&eacute;r&eacute; automatiquement.</span>
                    <button class="btn-create-project" id="btnCreateProject" onclick="handleCreateProject()">Cr&eacute;er un projet</button>
                    <button class="btn-cancel-project" onclick="hideNewProjectForm()">Annuler</button>
                </div>
            </div>

            <!-- Pipeline tabs -->
            <div class="pipeline-tabs" id="pipelineTabs">
                <button class="pipeline-tab" data-view="table" onclick="switchPipelineView('table')">Table</button>
                <button class="pipeline-tab active" data-view="cards" onclick="switchPipelineView('cards')">Cartes</button>
                <button class="pipeline-tab" data-view="submissions" onclick="switchPipelineView('submissions')">Soumissions</button>
            </div>

            <!-- Pipeline filters -->
            <div class="pipeline-filters" id="pipelineFilters">
                <button class="pipeline-filter-btn" id="filterFollowsBtn" onclick="toggleFollowsFilter()" title="Afficher seulement les projets suivis">&starf; Suivis</button>
                <button class="pipeline-filter-btn" id="filterArchiveBtn" onclick="toggleArchiveFilter()" title="Afficher les soumissions archiv&eacute;es">Archiv&eacute;es</button>
                <input type="text" id="pipelineSearch" placeholder="Rechercher (nom, client, code, ville...)" oninput="applyPipelineFilters()">
                <select id="pipelineStatusFilter" onchange="applyPipelineFilters()">
                    <option value="">Tous les statuts</option>
                </select>
                <select id="pipelineAssignedFilter" onchange="applyPipelineFilters()">
                    <option value="">Tous les responsables</option>
                </select>
                <select id="pipelineTypeFilter" onchange="applyPipelineFilters()">
                    <option value="">Tous les types</option>
                </select>
            </div>

            <!-- Vue Table -->
            <div id="viewTableContainer" style="display:none;">
                <div class="pipeline-table-wrap">
                    <table class="pipeline-table" id="pipelineTable">
                        <thead id="pipelineTableHead"></thead>
                        <tbody id="pipelineTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Vue Cartes -->
            <div id="projectGrid" class="project-grid">
                <!-- Rempli dynamiquement -->
            </div>

            <!-- Vue Soumissions -->
            <div id="viewSubmissions" style="display:none;">
                <div class="pipeline-table-wrap">
                    <table class="pipeline-table" id="submissionsTable">
                        <thead id="submissionsTableHead"></thead>
                        <tbody id="submissionsTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="project-empty" id="projectEmpty" style="display:none;">
                Aucun projet pour le moment.<br>Cliquez sur &laquo; + Nouveau projet &raquo; pour commencer.
            </div>
        </div>

        <!-- Project detail drawer -->
        <div class="project-drawer-overlay" id="projectDrawerOverlay" onclick="closeProjectDrawer()"></div>
        <div class="project-drawer" id="projectDrawer">
            <div class="project-drawer-head">
                <h3 id="drawerProjectName"></h3>
                <button class="project-drawer-close" onclick="closeProjectDrawer()">&times;</button>
            </div>
            <div class="project-drawer-body" id="drawerBody"></div>
        </div>

        <!-- ═══════ VUE 2 : CALCULATEUR ═══════ -->
        <div class="calculator-view" id="calculatorView">

            <div class="project-header" id="projectHeader">
                <div class="ph-top-bar">
                    <button class="btn-back-projects" id="btnBackProjects" onclick="backToProjectList()">&larr; Projets</button>
                    <div class="ph-top-actions">
                        <button class="btn-header-link" id="btnPreview" onclick="openPreview()">Aper&ccedil;u</button>
                        <button class="btn-header-link" onclick="openRentab('project')">Rentabilit&eacute;</button>
                        <button class="btn-header-link" id="btnPlans" onclick="openPlansModal()">Plans</button>
                        <button class="ai-assistant-btn" id="btnAiAssistant" title="Assistant Scopewright" onclick="openAiDrawer()"></button>
                        <button class="btn-header-link" id="btnContacts" onclick="openContactsModal()">Contacts</button>
                        <div class="kebab-menu" id="headerKebab">
                            <button class="btn-kebab" onclick="toggleHeaderKebab(event)">&middot;&middot;&middot;</button>
                            <div class="kebab-dropdown" id="headerKebabDropdown">
                                <button id="kebabDuplicate" onclick="duplicateSubmission(); closeHeaderKebab()"><span class="kebab-icon">&#9633;</span> Dupliquer</button>
                                <button id="kebabVersions" onclick="openVersionDrawer(); closeHeaderKebab()"><span class="kebab-icon">&#9776;</span> Versions</button>
                                <button id="kebabTimeline" onclick="openTimelineDrawer(); closeHeaderKebab()"><span class="kebab-icon">&#9201;</span> Historique</button>
                                <button id="kebabUnlock" onclick="unlockSubmission(); closeHeaderKebab()" style="display:none;"><span class="kebab-icon">&#128275;</span> D&eacute;verrouiller</button>
                                <button id="kebabArchive" onclick="toggleArchiveSubmission(); closeHeaderKebab()" style="display:none;"><span class="kebab-icon">&#128451;</span> Archiver</button>
                            </div>
                        </div>
                    </div>
                </div>
                <input type="text" class="ph-project-name" id="projName" placeholder="Nom du projet" readonly>
                <span class="ph-sub-number" id="headerSubNumber"></span>
                <span class="save-indicator" id="saveIndicator"></span>
                <div class="ph-info-bloc" id="projInfoBloc">
                    <div id="projInfoText" class="ph-info-empty">Ajouter les infos du projet</div>
                    <button class="btn-edit-info" onclick="openEditInfoModal()" title="Modifier les informations du projet">&#9998;</button>
                </div>
                <div class="ph-contacts-strip" id="projContactsStrip" style="display:none;"></div>
                <div class="ph-status-row">
                    <span class="status-badge" id="subStatusBadge"></span>
                </div>
                <div class="ph-total-section">
                    <div class="ph-total-label">Total estim&eacute;</div>
                    <div class="ph-total-amount" id="headerTotal">0,00 $</div>
                </div>
                <div class="status-timeline" id="statusTimeline"></div>
                <div class="ph-actions" id="mainActions">
                    <button class="btn-main-action" id="btnWfSubmit" onclick="openSubmitModal()">Soumettre</button>
                    <button class="btn-main-action btn-main-green" id="btnWfApprove" onclick="approveSubmission()">Approuver</button>
                    <button class="btn-main-action btn-main-orange" id="btnWfReturn" onclick="returnSubmission()">Retourner</button>
                    <button class="btn-main-action btn-main-purple" id="btnWfSendClient" onclick="sendToClient()">Envoyer au client</button>
                    <button class="btn-main-action btn-main-red" id="btnWfBypass" onclick="bypassApproval()">Envoyer sans approbation</button>
                    <button class="btn-main-action btn-main-green" id="btnWfAcceptOffline" onclick="offlineAcceptance()">Confirmer la vente</button>
                </div>
                <!-- Submission assignment -->
                <div class="sub-assignment-row" id="subAssignmentRow" style="display:none;">
                    <div class="sa-field">
                        <span class="sa-label">Estimateur</span>
                        <select id="saEstimateur" onchange="saveSubAssignment()"><option value="">—</option></select>
                    </div>
                    <div class="sa-field">
                        <span class="sa-label">Vendeur / CP</span>
                        <select id="saVendeur" onchange="saveSubAssignment()"><option value="">—</option></select>
                    </div>
                    <div class="sa-field">
                        <span class="sa-label">Approbateur</span>
                        <select id="saApprobateur" onchange="saveSubAssignment()"><option value="">—</option></select>
                    </div>
                    <div class="sa-field">
                        <span class="sa-label">Remise interne</span>
                        <input type="date" id="saInternalDeadline" onchange="saveSubAssignment()">
                    </div>
                    <div class="sa-field">
                        <span class="sa-label">Remise client</span>
                        <input type="date" id="saClientDeadline" onchange="saveSubAssignment()">
                    </div>
                </div>
                <input type="hidden" id="subTitle" value="">
                <span id="subNumber" style="display:none;"></span>
                <label style="display:none;"><input type="checkbox" id="projInstallation" checked onchange="toggleProjectInstallation()"></label>
            </div>

            <div class="header-sub-panel" id="headerSubPanel">
                <div class="header-sub-label" onclick="toggleSubPanel()"><span class="sub-chevron open" id="subPanelChevron">&#9654;</span> Soumissions du projet</div>
                <div class="header-sub-body" id="headerSubBody">
                    <div id="headerSubList"></div>
                    <button class="btn-add-sub" id="btnAddSubHeader" onclick="handleAddSubmissionFromCalc()">+ Nouvelle soumission</button>
                </div>
            </div>

            <div class="default-materials-panel" id="defaultMaterialsPanel">
                <div class="dm-label" onclick="toggleDefaultMaterials()"><span class="dm-arrow" id="dmArrow">&#9654;</span> Mat&eacute;riaux par d&eacute;faut</div>
                <div class="default-materials-body collapsed" id="dmBody"></div>
            </div>

            <h1 class="page-title">Calculateur</h1>
            <p class="page-subtitle">Calculez des estimations budg&eacute;taires &agrave; partir du catalogue de prix.</p>

            <div class="calculator-container">
            <div class="tag-filter-bar" id="tagFilterBar" style="display:none;">
                <span class="tag-filter-label">Filtrer par tag :</span>
                <span class="tag-filter-chip chip-all active" onclick="filterByTag(null)">Tous</span>
            </div>
            <div id="furnitureGroups">
                <!-- Le premier meuble est cr&eacute;&eacute; par JS au chargement -->
            </div>

            <button class="btn-add-group" onclick="addFurnitureGroup()">+ Ajouter un meuble</button>

            <div class="grand-total-container">
                <span class="grand-total-label">Total estim&eacute;</span>
                <span class="grand-total-amount" id="grandTotal">0,00 $</span>
            </div>


            <button class="btn-pdf" id="btnOpenSubmit" onclick="openSubmitModal()">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Soumettre pour approbation
            </button>
        </div>

        </div><!-- fin calculator-view -->

        <!-- ═══════ PREVIEW VIEW (split layout) ═══════ -->
        <div class="preview-view" id="previewView">
            <div class="pv-toolbar">
                <button onclick="closePreview()">&larr; Retour au calculateur</button>
                <span class="pv-toolbar-title">Aper&ccedil;u soumission</span>
                <span class="pv-toolbar-sub" id="pvSubNumber"></span>
                <button class="btn-client-view" id="btnPresentation" onclick="openPresentation()" title="Plein &eacute;cran">Pr&eacute;sentation</button>
                <button class="btn-client-view" id="btnLang" onclick="toggleLang()" title="Changer la langue">EN</button>
            </div>
            <div class="pv-split">
                <div class="pv-left">
                    <div class="pv-content" id="pvContent"></div>
                </div>
                <div class="pv-right" id="pvRight">
                    <div class="pv-tools-header">Outils</div>
                    <div class="pv-tools-section">
                        <h5>Biblioth&egrave;que de clauses</h5>
                        <div class="pv-lib-actions">
                            <button class="pv-btn-add-clause" onclick="showClauseEditor()">+ Nouvelle clause</button>
                        </div>
                        <div id="pvClauseEditZone"></div>
                        <div class="pv-clause-list" id="pvClauseList"></div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Modal Rentabilité -->
    <div class="rentab-overlay" id="rentabModal" onclick="if(event.target===this)closeRentab()">
        <div class="rentab-modal">
            <div class="rentab-header">
                <h2 id="rentabTitle">Rentabilit&eacute;</h2>
                <button class="rentab-close" onclick="closeRentab()">&times;</button>
            </div>
            <div class="rentab-body" id="rentabBody"></div>
            <div class="rentab-footer">
                <button onclick="closeRentab()">Annuler</button>
            </div>
        </div>
    </div>

    <!-- Modal g\u00e9n\u00e9rique (confirm / prompt / alert) -->
    <div class="modal-overlay" id="steleDialogOverlay">
        <div class="modal" style="max-width:440px;">
            <div class="modal-header">
                <h3 class="modal-title" id="steleDialogTitle"></h3>
            </div>
            <div class="modal-body">
                <p id="steleDialogMessage" style="font-size:14px; color:#444; margin-bottom:12px;"></p>
                <div id="steleDialogInputWrap" style="display:none;">
                    <input type="text" class="form-input" id="steleDialogInput" style="font-size:14px;">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" id="steleDialogCancel" onclick="steleDialogResolve(null)" style="display:none;">Annuler</button>
                <button class="btn-generate" id="steleDialogOk" onclick="steleDialogOk()">OK</button>
            </div>
        </div>
    </div>

    <!-- Timeline drawer (historique soumission) -->
    <div class="timeline-drawer-overlay" id="timelineOverlay" onclick="closeTimelineDrawer()"></div>
    <div class="timeline-drawer" id="timelineDrawer">
        <div class="timeline-drawer-header">
            <h3>Historique</h3>
            <button class="timeline-drawer-close" onclick="closeTimelineDrawer()">&times;</button>
        </div>
        <div class="timeline-drawer-body" id="timelineBody">
            <div class="timeline-empty">Aucun historique</div>
        </div>
    </div>

    <!-- AI Assistant Drawer -->
    <div class="ai-drawer-overlay" id="aiOverlay" onclick="closeAiDrawer()"></div>
    <div class="ai-drawer" id="aiDrawer">
        <div class="ai-drawer-header">
            <h3>Assistant Scopewright</h3>
            <div class="ai-scope-badge" id="aiScopeBadge">Projet</div>
            <button class="ai-drawer-close" onclick="closeAiDrawer()">&times;</button>
        </div>
        <div class="ai-messages" id="aiMessages"></div>
        <div class="ai-typing" id="aiTyping">
            <div class="ai-typing-dot"></div>
            <div class="ai-typing-dot"></div>
            <div class="ai-typing-dot"></div>
        </div>
        <div class="ai-quick-actions" id="aiQuickActions">
            <button class="ai-quick-btn" onclick="aiQuickAction('Analyse la rentabilit\u00e9 du projet')">Rentabilit&eacute;</button>
            <button class="ai-quick-btn" onclick="aiQuickAction('R\u00e9sume cette soumission')">R&eacute;sum&eacute;</button>
            <button class="ai-quick-btn" onclick="aiQuickAction('Optimise toutes les descriptions')">Descriptions</button>
            <button class="ai-quick-btn" onclick="aiQuickAction('Sugg\u00e8re des articles pour am\u00e9liorer la marge')">Am&eacute;liorer marge</button>
        </div>
        <div class="ai-img-preview" id="aiImgPreview"></div>
        <div class="ai-input-area" style="position:relative;">
            <div class="ai-drop-zone" id="aiDropZone">D&eacute;posez une image ici</div>
            <textarea id="aiInput" placeholder="Posez une question..." rows="1" onkeydown="aiInputKeydown(event)"></textarea>
            <button class="ai-send-btn" id="aiSendBtn" onclick="sendAiMessage()" title="Envoyer">&uarr;</button>
        </div>
    </div>

    <!-- Modal Soumettre la soumission -->
    <div class="modal-overlay" id="pdfModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="submitModalTitle">Soumettre la soumission</h3>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="projectDate">Date requise</label>
                    <input type="date" class="form-input" id="projectDate">
                </div>
                <div class="form-group">
                    <label class="form-label" for="projectDescription">Message / Notes</label>
                    <textarea class="form-input" id="projectDescription" rows="3" placeholder="Ex: J'en ai besoin pour demain, pr&eacute;voir 2 semaines de d&eacute;lai..." style="resize: vertical; min-height: 60px;"></textarea>
                </div>
                <div id="sendStatus" style="display: none; padding: 10px; border-radius: 4px; font-size: 13px; margin-top: 8px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closePdfModal()">Annuler</button>
                <button class="btn-generate" id="btnSend" onclick="soumettreSoumission()">Soumettre</button>
            </div>
        </div>
    </div>

    <!-- Modal Bypass approbation -->
    <div class="modal-overlay" id="bypassModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" style="color:#c0392b;">Envoi sans approbation</h3>
            </div>
            <div class="modal-body">
                <div style="background:#fff3e0; border:1px solid #e65100; border-radius:6px; padding:14px; margin-bottom:16px; font-size:13px; color:#e65100; line-height:1.5;">
                    <strong>Attention :</strong> Vous vous appr&ecirc;tez &agrave; envoyer cette soumission directement au client <strong>sans approbation interne</strong>. Cette action sera consign&eacute;e avec votre identit&eacute; et votre adresse IP.
                </div>
                <div class="form-group">
                    <label class="form-label" style="display:flex; align-items:flex-start; gap:8px; cursor:pointer;">
                        <input type="checkbox" id="bypassConfirmCheck" style="margin-top:3px;">
                        <span>Je confirme envoyer cette soumission sans approbation interne et j'en assume l'enti&egrave;re responsabilit&eacute;.</span>
                    </label>
                </div>
                <div class="form-group">
                    <label class="form-label" for="bypassReason">Raison du bypass <span style="color:#c0392b;">*</span></label>
                    <textarea class="form-input" id="bypassReason" rows="3" placeholder="Ex: Client en urgence, d&eacute;j&agrave; discut&eacute; avec le directeur..." style="resize:vertical; min-height:60px;" required></textarea>
                </div>
                <div id="bypassStatus" style="display:none; padding:10px; border-radius:4px; font-size:13px; margin-top:8px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeBypassModal()">Annuler</button>
                <button class="btn-generate" id="btnBypassConfirm" style="background:#c0392b;" onclick="executeBypass()">Envoyer sans approbation</button>
            </div>
        </div>
    </div>

    <!-- Modal Acceptation hors-ligne -->
    <div class="modal-overlay" id="offlineAcceptModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" style="color:#2e7d32;">Confirmer la vente (hors-ligne)</h3>
            </div>
            <div class="modal-body">
                <div style="background:#e8f5e9; border:1px solid #2e7d32; border-radius:6px; padding:14px; margin-bottom:16px; font-size:13px; color:#2e7d32; line-height:1.5;">
                    Vous confirmez que le client a accept&eacute; cette soumission <strong>par un autre moyen</strong> que la signature en ligne. Cette action sera consign&eacute;e avec votre identit&eacute; et votre adresse IP.
                </div>
                <div class="form-group">
                    <label class="form-label" for="offlineUserName">Votre nom (charg&eacute; de projet) <span style="color:#c0392b;">*</span></label>
                    <input type="text" class="form-input" id="offlineUserName" placeholder="Pr&eacute;nom Nom">
                </div>
                <div class="form-group">
                    <label class="form-label" for="offlineClientName">Nom du client</label>
                    <input type="text" class="form-input" id="offlineClientName" placeholder="Nom du client">
                </div>
                <div class="form-group">
                    <label class="form-label" for="offlineMethod">M&eacute;thode d'acceptation <span style="color:#c0392b;">*</span></label>
                    <select class="form-input" id="offlineMethod" style="font-size:14px;">
                        <option value="">-- S&eacute;lectionner --</option>
                        <option value="courriel">Courriel</option>
                        <option value="telephone">T&eacute;l&eacute;phone</option>
                        <option value="papier">Papier</option>
                        <option value="autre">Autre</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="offlineDate">Date d'acceptation client <span style="color:#c0392b;">*</span></label>
                    <input type="date" class="form-input" id="offlineDate">
                </div>
                <div class="form-group">
                    <label class="form-label" for="offlineNotes">Notes (optionnel)</label>
                    <textarea class="form-input" id="offlineNotes" rows="2" placeholder="Ex: Le client a confirm&eacute; par courriel le..." style="resize:vertical; min-height:40px;"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label" style="display:flex; align-items:flex-start; gap:8px; cursor:pointer;">
                        <input type="checkbox" id="offlineConfirmCheck" style="margin-top:3px;">
                        <span>Je confirme que le client a accept&eacute; cette soumission par un autre moyen. J'en assume l'enti&egrave;re responsabilit&eacute;.</span>
                    </label>
                </div>
                <div id="offlineAcceptStatus" style="display:none; padding:10px; border-radius:4px; font-size:13px; margin-top:8px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeOfflineAcceptModal()">Annuler</button>
                <button class="btn-generate" id="btnOfflineConfirm" style="background:#2e7d32;" onclick="executeOfflineAcceptance()">Confirmer la vente</button>
            </div>
        </div>
    </div>

    <!-- Modal Marquer comme perdu -->
    <div class="modal-overlay" id="lostModal">
        <div class="modal" style="max-width:480px;">
            <div class="modal-header">
                <h3 class="modal-title" style="color:#c62828;">Marquer comme perdu</h3>
            </div>
            <div class="modal-body">
                <div style="background:#ffebee; border:1px solid #c62828; border-radius:6px; padding:14px; margin-bottom:16px; font-size:13px; color:#c62828; line-height:1.5;">
                    Cette soumission sera marqu&eacute;e comme <strong>perdue</strong>. Vous pourrez la rouvrir ult&eacute;rieurement si n&eacute;cessaire.
                </div>
                <div class="form-group">
                    <label class="form-label" for="lostReason">Raison de la perte (optionnel)</label>
                    <textarea class="form-input" id="lostReason" rows="2" placeholder="Ex: Prix trop &eacute;lev&eacute;, d&eacute;lai trop long, client a choisi un concurrent..." style="resize:vertical; min-height:40px;"></textarea>
                </div>
                <div class="form-group" style="position:relative;">
                    <label class="form-label" for="lostCompetitorSearch">Concurrent (optionnel)</label>
                    <input type="text" class="form-input" id="lostCompetitorSearch" placeholder="Rechercher une entreprise..." oninput="filterLostCompetitors(this)" onfocus="filterLostCompetitors(this)" autocomplete="off">
                    <input type="hidden" id="lostCompetitorId">
                    <div class="contact-combo-dd" id="lostCompetitorDd" style="position:absolute; top:100%; left:0; right:0; z-index:20; max-height:200px; overflow-y:auto;"></div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="lostCompetitorPrice">Prix concurrent (optionnel)</label>
                    <input type="number" class="form-input" id="lostCompetitorPrice" placeholder="0.00" min="0" step="0.01">
                </div>
                <div id="lostStatus" style="display:none; padding:10px; border-radius:4px; font-size:13px; margin-top:8px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeLostModal()">Annuler</button>
                <button class="btn-generate" id="btnLostConfirm" style="background:#c62828;" onclick="executeLostSubmission()">Marquer comme perdu</button>
            </div>
        </div>
    </div>

    <!-- Version Drawer -->
    <div id="versionDrawer" class="version-drawer" style="display:none;">
        <div class="version-drawer-header">
            <h3>Historique des versions</h3>
            <button onclick="closeVersionDrawer()" class="btn-close-drawer">&times;</button>
        </div>
        <div id="versionList" class="version-list"></div>
    </div>

    <!-- Modal Déverrouillage d'urgence -->
    <div class="modal-overlay" id="unlockModal">
        <div class="modal" style="max-width:460px;">
            <div class="modal-header">
                <h3 class="modal-title" style="color:#c62828;">D&eacute;verrouillage d'urgence</h3>
            </div>
            <div class="modal-body">
                <div style="background:#ffebee; border:1px solid #c62828; border-radius:6px; padding:14px; margin-bottom:16px; font-size:13px; color:#c62828; line-height:1.5;">
                    Cette action sera enregistr&eacute;e de fa&ccedil;on <strong>permanente et irr&eacute;versible</strong> dans le journal d'audit. Le contenu actuel sera sauvegard&eacute; en version avant le d&eacute;verrouillage.
                </div>
                <div class="form-group">
                    <label class="form-label" for="unlockUserName">Votre nom complet <span style="color:#c62828;">*</span></label>
                    <input type="text" class="form-input" id="unlockUserName" placeholder="Pr&eacute;nom Nom">
                </div>
                <div class="form-group">
                    <label class="form-label" for="unlockReason">Raison du d&eacute;verrouillage <span style="color:#c62828;">*</span></label>
                    <textarea class="form-input" id="unlockReason" rows="3" placeholder="Expliquer pourquoi cette soumission doit &ecirc;tre d&eacute;verrouill&eacute;e..." style="resize:vertical;"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label" style="display:flex; align-items:flex-start; gap:8px; cursor:pointer;">
                        <input type="checkbox" id="unlockConfirmCheck" style="margin-top:3px;">
                        <span>Je comprends que cette action est permanente et tra&ccedil;able. L'adresse IP sera consign&eacute;e.</span>
                    </label>
                </div>
                <div id="unlockStatus" style="display:none; padding:10px; border-radius:4px; font-size:13px; margin-top:8px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeUnlockModal()">Annuler</button>
                <button class="btn-generate" id="btnUnlockConfirm" style="background:#c62828;" onclick="executeUnlock()">D&eacute;verrouiller</button>
            </div>
        </div>
    </div>

    <!-- Modal Proposer un article -->
    <div class="modal-overlay" id="proposerModal">
        <div class="modal modal-edit">
            <div class="modal-header">
                <h3 class="modal-title">Proposer un nouvel article</h3>
            </div>
            <div class="modal-body">
                <div class="edit-row">
                    <div class="form-group">
                        <label class="form-label">Code</label>
                        <input type="text" class="form-input" id="propCode" readonly style="background:#f5f5f5; color:#888;">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Cat&eacute;gorie</label>
                        <select class="form-input" id="propCategory" onchange="updatePropCode()"></select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <input type="text" class="form-input" id="propDescription" placeholder="ex: Poign&eacute;e en bois massif...">
                </div>
                <div class="edit-row">
                    <div class="form-group">
                        <label class="form-label">Type</label>
                        <select class="form-input" id="propType"></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Prix</label>
                        <input type="hidden" id="propPrice">
                        <div class="form-input" id="propPriceDisplay" style="background:#f5f5f5; color:#888; min-height:38px; display:flex; align-items:center;">Calcul&eacute; automatiquement</div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Instruction</label>
                    <textarea class="form-input" id="propInstruction" rows="2" style="resize:vertical;" placeholder="Instructions sp&eacute;ciales..."></textarea>
                </div>

                <!-- Prix composé — Minutes & Matériaux -->
                <div class="form-group" id="propComposedPriceGroup">
                    <div class="cp-section-title">Prix compos&eacute;</div>
                    <div class="composed-price-section">
                        <div class="cp-table-wrap">
                            <div class="cp-sub-title">Minutes main-d'&oelig;uvre</div>
                            <table class="cp-table">
                                <thead><tr><th>D&eacute;partement</th><th style="width:70px">Min.</th></tr></thead>
                                <tbody id="propCpMinutesBody"></tbody>
                            </table>
                        </div>
                        <div class="cp-table-wrap">
                            <div class="cp-sub-title">Mat&eacute;riaux</div>
                            <table class="cp-table">
                                <thead><tr><th>Cat&eacute;gorie</th><th style="width:80px">Co&ucirc;t ($)</th></tr></thead>
                                <tbody id="propCpMaterialsBody"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="cp-calculated">
                        <div>
                            <span class="cp-total-label">Prix calcul&eacute;</span>
                            <span class="cp-breakdown" id="propCpBreakdown"></span>
                        </div>
                        <span class="cp-total-value" id="propCpTotalValue">&mdash;</span>
                    </div>
                </div>

                <!-- Médias tagués -->
                <div class="form-group">
                    <div class="cat-media-title">M&eacute;dias</div>
                    <div class="cat-dropzone" id="propDropzone">
                        Cliquer ou glisser des images / PDFs ici
                    </div>
                    <input type="file" id="propMediaInput" accept="image/*,.pdf,application/pdf" multiple style="display:none;">
                    <div class="cat-media-list" id="propMediaList"></div>
                </div>

                <div class="form-group" style="margin-bottom:0;">
                    <div class="edit-toggle-row">
                        <label class="edit-toggle">
                            <input type="checkbox" id="propInCalculator" checked>
                            <span class="slider"></span>
                        </label>
                        <span class="edit-toggle-label">Visible dans le calculateur</span>
                    </div>
                </div>

                <div class="edit-status" id="propStatus"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeProposerModal()">Annuler</button>
                <button class="btn-generate" id="btnProposerSave" onclick="saveProposedItem()">Enregistrer</button>
            </div>
        </div>
    </div>

    <!-- Lightbox pour agrandir les images -->
    <div class="lightbox-overlay" id="lightbox" onclick="closeLightbox()">
        <img id="lightboxImg" src="" alt="">
    </div>

    <!-- Modal Annotation -->
    <div class="annotation-overlay" id="annotationModal" onclick="if(event.target===this)closeAnnotationModal()">
        <div class="annotation-box">
            <div class="annotation-header">
                <span class="annotation-title">Annoter l'image</span>
                <select id="annotPrefixSelect" onchange="updateAnnotNext()"></select>
                <span class="annotation-next" id="annotNext"></span>
                <label class="annotation-arrow-toggle">
                    <input type="checkbox" id="annotArrowMode"> Fl&egrave;che
                </label>
                <button class="annotation-close" onclick="closeAnnotationModal()">&times;</button>
            </div>
            <div class="annotation-img-container" id="annotImgContainer">
                <img id="annotImage" src="" onclick="handleAnnotationClick(event)">
                <svg id="annotSvg" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <marker id="annotArrowHead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="var(--sw-navy)"/>
                        </marker>
                    </defs>
                </svg>
            </div>
            <div class="annotation-footer">
                <span class="annotation-hint">Cliquer sur l'image pour placer un tag. Glisser pour d&eacute;placer. Clic droit pour supprimer.</span>
            </div>
        </div>
    </div>

    <!-- Modal Plans architecturaux -->
    <div class="modal-overlay" id="plansModal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title">Plans architecturaux</h3>
                <button class="modal-close" onclick="closePlansModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="plans-upload-zone">
                    <input type="file" id="planFileInput" accept=".pdf" style="display:none;" onchange="handlePlanFileSelect(event)">
                    <button class="btn-upload-plan" id="btnUploadPlan" onclick="document.getElementById('planFileInput').click()">
                        <span style="font-size:20px;">&#128196;</span> T&eacute;l&eacute;verser un nouveau plan
                    </button>
                    <div id="planUploadStatus" style="display:none; margin-top:12px; padding:10px; border-radius:6px; font-size:13px; text-align:center;"></div>
                </div>
                <div id="plansListContainer" class="plans-list">
                    <div class="plans-empty">Aucun plan pour cette soumission</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closePlansModal()">Fermer</button>
            </div>
        </div>
    </div>

    <!-- Edit Project Info Modal -->
    <div class="modal-overlay" id="editInfoModal">
        <div class="modal" style="max-width:520px;">
            <div class="modal-header">
                <h3 class="modal-title">Informations du projet</h3>
                <button class="modal-close" onclick="closeEditInfoModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Client</label>
                    <div class="contact-combo-wrap" id="clientComboWrap">
                        <input type="text" id="infoClientCombo" placeholder="Rechercher un contact ou une entreprise..."
                               autocomplete="off" oninput="filterClientCombo(this)" onfocus="openClientCombo()">
                        <div class="contact-combo-dd" id="clientComboDd"></div>
                    </div>
                    <div id="clientComboSelected" style="font-size:12px; color:var(--sw-navy); margin-top:4px;"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">Adresse du projet</label>
                    <input type="text" class="form-input" id="infoProjectAddress" placeholder="Adresse">
                </div>
                <div class="info-modal-row">
                    <div class="form-group">
                        <label class="form-label">Ville</label>
                        <input type="text" class="form-input" id="infoProjectCity" placeholder="Ville">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Code postal</label>
                        <input type="text" class="form-input" id="infoProjectPostalCode" placeholder="H0H 0H0">
                    </div>
                </div>
                <div id="addrSuggestPanel" style="display:none;"></div>

                <hr style="border:none;border-top:1px solid #eee;margin:16px 0;">
                <div style="font-size:12px;font-weight:600;color:#888;text-transform:uppercase;letter-spacing:0.3px;margin-bottom:10px;">Pipeline commercial</div>

                <div class="info-modal-row">
                    <div class="form-group">
                        <label class="form-label">Statut pipeline</label>
                        <select class="form-input" id="infoPipelineStatus"></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Priorit&eacute;</label>
                        <select class="form-input" id="infoPriority">
                            <option value="normal">Normal</option>
                            <option value="haute">Haute</option>
                            <option value="urgente">Urgente</option>
                        </select>
                    </div>
                </div>
                <div class="info-modal-row">
                    <div class="form-group">
                        <label class="form-label">Source</label>
                        <select class="form-input" id="infoSource"><option value="">—</option></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Type</label>
                        <select class="form-input" id="infoProjectType"><option value="">—</option></select>
                    </div>
                </div>
                <div class="info-modal-row">
                    <div class="form-group">
                        <label class="form-label">Montant estim&eacute; ($)</label>
                        <input type="number" class="form-input" id="infoEstimatedAmount" placeholder="0" min="0" step="100">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Probabilit&eacute; (%)</label>
                        <input type="range" id="infoProbability" min="0" max="100" step="5" value="0" oninput="document.getElementById('infoProbVal').textContent=this.value+'%'" style="width:100%;">
                        <span id="infoProbVal" style="font-size:12px;color:#666;">0%</span>
                    </div>
                </div>
                <div class="info-modal-row">
                    <div class="form-group">
                        <label class="form-label">Responsable</label>
                        <select class="form-input" id="infoAssignedTo"><option value="">—</option></select>
                    </div>
                </div>
                <div class="info-modal-row">
                    <div class="form-group">
                        <label class="form-label">Mois de livraison</label>
                        <input type="month" class="form-input" id="infoDeliveryMonth" placeholder="ex: 2026-05">
                    </div>
                </div>
                <div class="info-modal-row">
                    <div class="form-group">
                        <label class="form-label">Deadline interne</label>
                        <input type="date" class="form-input" id="infoInternalDeadline">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Deadline client</label>
                        <input type="date" class="form-input" id="infoClientDeadline">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeEditInfoModal()">Annuler</button>
                <button class="btn-generate" onclick="saveProjectInfo()">Enregistrer</button>
            </div>
        </div>
    </div>

    <!-- Contacts Modal -->
    <div class="contacts-overlay" id="contactsModal" onclick="if(event.target===this)closeContactsModal()">
        <div class="contacts-modal">
            <div class="contacts-modal-header">
                <h2>Contacts du projet</h2>
                <button class="contacts-modal-close" onclick="closeContactsModal()">&times;</button>
            </div>
            <div class="contacts-modal-body">
                <div class="contact-cards-grid" id="contactCardsGrid"></div>
                <button class="btn-add-contact" onclick="openAddContactModal()">+ Ajouter un contact</button>
            </div>
        </div>
    </div>

    <!-- Add Contact Sub-Modal -->
    <div class="add-contact-overlay" id="addContactOverlay" onclick="if(event.target===this)closeAddContactModal()">
        <div class="modal" style="max-width:460px;">
            <div class="modal-header">
                <h3 class="modal-title">Ajouter un contact</h3>
                <button class="modal-close" onclick="closeAddContactModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">R&ocirc;le</label>
                    <select class="form-input" id="addContactRole" onchange="toggleCustomRole()">
                        <option value="Propri&eacute;taire">Propri&eacute;taire</option>
                        <option value="Entrepreneur">Entrepreneur</option>
                        <option value="Client">Client</option>
                        <option value="Designer">Designer</option>
                        <option value="Architecte">Architecte</option>
                        <option value="Autre">Autre...</option>
                    </select>
                    <input type="text" class="form-input" id="addContactRoleCustom" placeholder="R&ocirc;le personnalis&eacute;..." style="display:none; margin-top:6px;">
                </div>
                <div class="form-group">
                    <label class="form-label">Rechercher un contact</label>
                    <div class="contact-combo-wrap" id="contactComboWrap">
                        <input type="text" id="contactComboInput" placeholder="Taper un nom..." autocomplete="off"
                               oninput="filterContactCombo(this)" onfocus="openContactCombo()">
                        <div class="contact-combo-dd" id="contactComboDd"></div>
                    </div>
                </div>
                <div id="addContactStatus" style="font-size:13px; margin-top:8px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeAddContactModal()">Annuler</button>
                <button class="btn-generate" id="btnConfirmAddContact" onclick="confirmAddContact()" disabled>Ajouter</button>
            </div>
        </div>
    </div>

    <!-- Contact Detail Modal -->
    <div class="modal-overlay" id="contactDetailModal" onclick="if(event.target===this)closeContactDetail()">
        <div class="modal" style="max-width:480px;">
            <div class="modal-header">
                <h3 class="modal-title" id="contactDetailTitle">Contact</h3>
                <button class="modal-close" onclick="closeContactDetail()">&times;</button>
            </div>
            <div class="modal-body" id="contactDetailBody"></div>
            <div class="modal-footer">
                <a id="contactDetailCrmLink" href="#" target="_blank" style="font-size:13px; color:var(--sw-navy); text-decoration:none;">Ouvrir dans le CRM &rarr;</a>
                <button class="btn-cancel" onclick="closeContactDetail()">Fermer</button>
            </div>
        </div>
    </div>

    <!-- PDF Viewer Modal -->
    <div class="pdf-viewer-overlay" id="pdfViewerOverlay">
        <div class="pdf-viewer-container">
            <!-- Header avec contrôles -->
            <div class="pdf-viewer-header">
                <div class="pdf-viewer-title" id="pdfViewerTitle">Plan architectural</div>
                <div class="pdf-viewer-controls">
                    <button class="pdf-control-btn" id="btnPdfPrev" onclick="pdfNavigate(-1)" title="Page pr\u00e9c\u00e9dente">&#9664;</button>
                    <span class="pdf-page-info" id="pdfPageInfo">1 / 1</span>
                    <button class="pdf-control-btn" id="btnPdfNext" onclick="pdfNavigate(1)" title="Page suivante">&#9654;</button>
                    <div class="pdf-control-divider"></div>
                    <button class="pdf-control-btn" onclick="pdfZoom(-0.25)" title="Zoom -">&#8722;</button>
                    <span class="pdf-zoom-info" id="pdfZoomInfo">100%</span>
                    <button class="pdf-control-btn" onclick="pdfZoom(0.25)" title="Zoom +">&#43;</button>
                    <button class="pdf-control-btn" onclick="pdfResetZoom()" title="R\u00e9initialiser zoom">&#8634;</button>
                    <div class="pdf-control-divider"></div>
                    <button class="pdf-control-btn" onclick="pdfRotate()" title="Rotation 90\u00b0">&#8635;</button>
                    <div class="pdf-control-divider"></div>
                    <button class="pdf-action-btn" id="btnCapturePage" onclick="capturePdfPage()" title="Capturer cette page">&#128248; Capturer</button>
                    <button class="pdf-action-btn" onclick="openPdfInNewWindow()" title="Ouvrir dans une nouvelle fenêtre" style="margin-left:8px;">&#8599; Nouvelle fenêtre</button>
                </div>
                <button class="pdf-viewer-close" onclick="closePdfViewer()">&times;</button>
            </div>

            <!-- Content avec sidebar et canvas -->
            <div class="pdf-viewer-content">
                <!-- Sidebar avec thumbnails -->
                <div class="pdf-sidebar" id="pdfSidebar">
                    <div class="pdf-sidebar-title">Pages</div>
                    <div class="pdf-thumbnails" id="pdfThumbnails"></div>
                </div>

                <!-- Main canvas area -->
                <div class="pdf-canvas-container" id="pdfCanvasContainer">
                    <canvas id="pdfCanvas"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Capture Room Selection -->
    <div class="modal-overlay" id="captureRoomModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">Capturer la page du plan</h3>
                <button class="modal-close" onclick="closeCaptureRoomModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="font-size:13px; color:#666; margin-bottom:16px;">
                    S&eacute;lectionnez la pi&egrave;ce/meuble o&ugrave; associer cette capture haute r&eacute;solution.
                </p>
                <div class="form-group">
                    <label class="form-label">Pi&egrave;ce / Meuble</label>
                    <select class="form-input" id="captureRoomSelect">
                        <option value="">-- S&eacute;lectionnez --</option>
                    </select>
                </div>
                <div id="captureStatus" style="display:none; padding:10px; border-radius:4px; font-size:13px; margin-top:12px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeCaptureRoomModal()">Annuler</button>
                <button class="btn-generate" id="btnConfirmCapture" onclick="confirmCapture()">Capturer</button>
            </div>
        </div>
    </div>

    <!-- Crop Modal -->
    <div class="crop-overlay" id="cropModal">
        <div class="crop-box">
            <div class="crop-header">
                <span>Cadrer l'image</span>
                <span id="cropDimensions" style="font-weight:400; font-size:12px; color:#888;"></span>
            </div>
            <div class="crop-error" id="cropError"></div>
            <div class="crop-container" id="cropContainer">
                <img id="cropImage" src="">
            </div>
            <div class="crop-controls">
                <div class="crop-ratios">
                    <button class="crop-ratio-btn active" id="cropRatio169" onclick="setCropRatio('16:9')">16:9</button>
                    <button class="crop-ratio-btn" id="cropRatio916" onclick="setCropRatio('9:16')">9:16</button>
                    <button class="crop-ratio-btn" id="cropRatio11" onclick="setCropRatio('1:1')">1:1</button>
                </div>
                <div class="crop-actions">
                    <button class="crop-btn crop-btn-cancel" onclick="cancelCrop()">Annuler</button>
                    <button class="crop-btn crop-btn-confirm" id="cropConfirmBtn" onclick="confirmCrop()">Valider</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ═══════════════════════════════════════════════════════════════════════
        // UTILITAIRES
        // ═══════════════════════════════════════════════════════════════════════

        function openLightbox(src) {
            document.getElementById('lightboxImg').src = src;
            document.getElementById('lightbox').classList.add('active');
        }

        function closeLightbox() {
            document.getElementById('lightbox').classList.remove('active');
            document.getElementById('lightboxImg').src = '';
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && document.getElementById('lightbox').classList.contains('active')) closeLightbox();
            if (e.key === 'Escape' && document.getElementById('annotationModal').classList.contains('active')) closeAnnotationModal();
        });

        // ═══════════════════════════════════════════════════════════════════════
        // ANNOTATION — TAGS VISUELS SUR IMAGES
        // ═══════════════════════════════════════════════════════════════════════

        var annotState = {
            groupId: null,
            imageIndex: -1,
            annotations: [],
            selectedPrefix: 'C',
            arrowMode: false,
            awaitingArrowTarget: null, // annotation id waiting for arrow click
            dragging: null, // { id, startX, startY, origX, origY }
            mediaId: null
        };
        var annotSaveTimer = null;

        function openAnnotationModal(groupId, index) {
            var imgs = groupImages[groupId] || [];
            var img = imgs[index];
            if (!img || img.isLegacy) return;

            annotState.groupId = groupId;
            annotState.imageIndex = index;
            annotState.mediaId = img.mediaId;
            annotState.annotations = JSON.parse(JSON.stringify(img.annotations || []));
            annotState.awaitingArrowTarget = null;
            annotState.dragging = null;

            // Set image
            var imgEl = document.getElementById('annotImage');
            imgEl.src = img.url || img.dataUrl;

            // Populate prefix dropdown from tagPrefixes
            var sel = document.getElementById('annotPrefixSelect');
            sel.innerHTML = '';
            (tagPrefixes || []).forEach(function(tp) {
                var opt = document.createElement('option');
                opt.value = tp.prefix;
                opt.textContent = tp.prefix + ' — ' + tp.label_fr;
                sel.appendChild(opt);
            });
            if (sel.options.length > 0) {
                annotState.selectedPrefix = sel.options[0].value;
            }

            // Reset arrow mode
            document.getElementById('annotArrowMode').checked = false;
            annotState.arrowMode = false;

            // Show modal
            document.getElementById('annotationModal').classList.add('active');

            // Wait for image to load then sync SVG size and render
            imgEl.onload = function() {
                syncAnnotSvgSize();
                renderAnnotationSVG();
                updateAnnotNext();
            };
            if (imgEl.complete) {
                setTimeout(function() {
                    syncAnnotSvgSize();
                    renderAnnotationSVG();
                    updateAnnotNext();
                }, 50);
            }
        }

        function closeAnnotationModal() {
            saveAnnotationsNow();
            document.getElementById('annotationModal').classList.remove('active');
            document.getElementById('annotImage').src = '';
            // Update in-memory groupImages
            var imgs = groupImages[annotState.groupId] || [];
            if (imgs[annotState.imageIndex]) {
                imgs[annotState.imageIndex].annotations = annotState.annotations;
            }
            renderGroupImagePreviews(annotState.groupId);
        }

        function syncAnnotSvgSize() {
            var imgEl = document.getElementById('annotImage');
            var svg = document.getElementById('annotSvg');
            var rect = imgEl.getBoundingClientRect();
            svg.style.left = imgEl.offsetLeft + 'px';
            svg.style.top = imgEl.offsetTop + 'px';
            svg.style.width = rect.width + 'px';
            svg.style.height = rect.height + 'px';
            svg.setAttribute('viewBox', '0 0 ' + rect.width + ' ' + rect.height);
        }

        function updateAnnotNext() {
            var prefix = document.getElementById('annotPrefixSelect').value;
            annotState.selectedPrefix = prefix;
            var next = getNextTagNumber(prefix);
            document.getElementById('annotNext').textContent = 'Prochain: ' + prefix + next;
        }

        function getNextTagNumber(prefix) {
            var used = {};
            annotState.annotations.forEach(function(a) {
                if (a.prefix === prefix) used[a.number] = true;
            });
            for (var i = 1; i <= 999; i++) {
                if (!used[i]) return i;
            }
            return 999;
        }

        function handleAnnotationClick(e) {
            if (annotState.dragging) return;
            var imgEl = document.getElementById('annotImage');
            var rect = imgEl.getBoundingClientRect();
            var relX = (e.clientX - rect.left) / rect.width;
            var relY = (e.clientY - rect.top) / rect.height;
            relX = Math.max(0, Math.min(1, relX));
            relY = Math.max(0, Math.min(1, relY));

            // If awaiting arrow target placement
            if (annotState.awaitingArrowTarget) {
                var annot = annotState.annotations.find(function(a) { return a.id === annotState.awaitingArrowTarget; });
                if (annot) {
                    annot.hasArrow = true;
                    annot.arrowX = relX;
                    annot.arrowY = relY;
                }
                annotState.awaitingArrowTarget = null;
                renderAnnotationSVG();
                debounceSaveAnnotations();
                return;
            }

            // Place new label
            var prefix = annotState.selectedPrefix;
            var num = getNextTagNumber(prefix);
            var newAnnot = {
                id: prefix + num,
                prefix: prefix,
                number: num,
                x: relX,
                y: relY,
                hasArrow: false,
                arrowX: null,
                arrowY: null
            };
            annotState.annotations.push(newAnnot);

            if (annotState.arrowMode) {
                annotState.awaitingArrowTarget = newAnnot.id;
            }

            renderAnnotationSVG();
            updateAnnotNext();
            debounceSaveAnnotations();
        }

        function renderAnnotationSVG() {
            var svg = document.getElementById('annotSvg');
            var imgEl = document.getElementById('annotImage');
            var rect = imgEl.getBoundingClientRect();
            var w = rect.width;
            var h = rect.height;

            // Keep defs, clear the rest
            var defs = svg.querySelector('defs');
            svg.innerHTML = '';
            svg.appendChild(defs);

            annotState.annotations.forEach(function(a) {
                var px = a.x * w;
                var py = a.y * h;

                // Draw arrow if present
                if (a.hasArrow && a.arrowX != null && a.arrowY != null) {
                    var ax = a.arrowX * w;
                    var ay = a.arrowY * h;
                    var line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', px);
                    line.setAttribute('y1', py);
                    line.setAttribute('x2', ax);
                    line.setAttribute('y2', ay);
                    line.setAttribute('class', 'annot-arrow');
                    svg.appendChild(line);
                }

                // Draw label group
                var g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                g.setAttribute('class', 'annot-label');
                g.setAttribute('data-annot-id', a.id);

                var text = a.id;
                var tw = text.length * 8 + 10;
                var th = 22;

                var r = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                r.setAttribute('x', px - tw / 2);
                r.setAttribute('y', py - th / 2);
                r.setAttribute('width', tw);
                r.setAttribute('height', th);
                r.setAttribute('rx', 4);
                r.setAttribute('fill', '#0B1220');
                r.setAttribute('stroke', 'none');
                g.appendChild(r);

                var t = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                t.setAttribute('x', px);
                t.setAttribute('y', py + 5);
                t.setAttribute('text-anchor', 'middle');
                t.setAttribute('fill', '#fff');
                t.setAttribute('font-size', '13');
                t.setAttribute('font-weight', '700');
                t.setAttribute('font-family', 'inherit');
                t.textContent = text;
                g.appendChild(t);

                // Drag events
                g.addEventListener('mousedown', function(e) {
                    e.stopPropagation();
                    if (e.button === 2) return; // right-click handled by contextmenu
                    annotState.dragging = {
                        id: a.id,
                        startX: e.clientX,
                        startY: e.clientY,
                        origX: a.x,
                        origY: a.y
                    };
                    g.classList.add('dragging');
                });

                // Right-click to delete
                g.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    steleConfirm('Supprimer le tag ' + a.id + ' de cette image ?', 'Supprimer annotation', 'Supprimer', true).then(function(ok) {
                        if (ok) deleteAnnotation(a.id);
                    });
                });

                svg.appendChild(g);
            });

            // Awaiting arrow indicator
            if (annotState.awaitingArrowTarget) {
                var hint = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                hint.setAttribute('x', w / 2);
                hint.setAttribute('y', 20);
                hint.setAttribute('text-anchor', 'middle');
                hint.setAttribute('fill', '#fff');
                hint.setAttribute('font-size', '14');
                hint.setAttribute('font-weight', '600');
                hint.textContent = 'Cliquer pour placer la cible de la fl\u00e8che';
                svg.appendChild(hint);
            }
        }

        // Global mousemove/mouseup for drag
        document.addEventListener('mousemove', function(e) {
            if (!annotState.dragging) return;
            var imgEl = document.getElementById('annotImage');
            var rect = imgEl.getBoundingClientRect();
            var dx = (e.clientX - annotState.dragging.startX) / rect.width;
            var dy = (e.clientY - annotState.dragging.startY) / rect.height;
            var annot = annotState.annotations.find(function(a) { return a.id === annotState.dragging.id; });
            if (annot) {
                annot.x = Math.max(0, Math.min(1, annotState.dragging.origX + dx));
                annot.y = Math.max(0, Math.min(1, annotState.dragging.origY + dy));
                renderAnnotationSVG();
            }
        });

        document.addEventListener('mouseup', function() {
            if (annotState.dragging) {
                annotState.dragging = null;
                debounceSaveAnnotations();
            }
        });

        // Sync SVG size on window resize
        window.addEventListener('resize', function() {
            if (document.getElementById('annotationModal').classList.contains('active')) {
                syncAnnotSvgSize();
                renderAnnotationSVG();
            }
        });

        function deleteAnnotation(annotId) {
            annotState.annotations = annotState.annotations.filter(function(a) { return a.id !== annotId; });
            renderAnnotationSVG();
            updateAnnotNext();
            debounceSaveAnnotations();
        }

        function debounceSaveAnnotations() {
            clearTimeout(annotSaveTimer);
            annotSaveTimer = setTimeout(saveAnnotationsNow, 500);
        }

        function saveAnnotationsNow() {
            clearTimeout(annotSaveTimer);
            if (!annotState.mediaId) return;
            authenticatedFetch(SUPABASE_URL + '/rest/v1/room_media?id=eq.' + annotState.mediaId, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                body: JSON.stringify({ annotations: annotState.annotations })
            }).then(function() {
                showSaveIndicator();
            }).catch(function(e) {
                console.warn('[Annot] Save failed:', e);
            });
        }

        // Arrow mode toggle
        document.getElementById('annotArrowMode').addEventListener('change', function() {
            annotState.arrowMode = this.checked;
        });

        function formatPrice(amount) {
            if (amount === null || amount === undefined) return 'Sur demande';
            if (typeof amount === 'number' && amount < 1 && amount > 0) return (amount * 100).toFixed(0) + '%';
            return amount.toLocaleString('fr-CA', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' $';
        }

        function formatType(type) {
            if (type === '%') return '%';
            return type;
        }

        function updateStatus(status, message) {
            const statusEl = document.getElementById('dataStatus');
            const textEl = document.getElementById('statusText');
            statusEl.className = 'data-status ' + status;
            textEl.textContent = message;
        }

        function formatDate(date) {
            if (!date) return '';
            const options = { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' };
            return date.toLocaleDateString('fr-CA', options);
        }

        function getUserEmail() {
            try {
                const token = localStorage.getItem('sb_access_token');
                if (!token) return '';
                const payload = JSON.parse(atob(token.split('.')[1]));
                return payload.email || '';
            } catch (e) { return ''; }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // CHARGEMENT DES DONN&Eacute;ES
        // ═══════════════════════════════════════════════════════════════════════

        function saveToLocalStorage(data) {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                localStorage.setItem(STORAGE_DATE_KEY, new Date().toISOString());
            } catch (e) { console.warn('Impossible de sauvegarder dans localStorage:', e); }
        }

        function loadFromLocalStorage() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                const date = localStorage.getItem(STORAGE_DATE_KEY);
                if (data) return { data: JSON.parse(data), date: date ? new Date(date) : null };
            } catch (e) { console.warn('Impossible de lire depuis localStorage:', e); }
            return null;
        }

        function loadCatalogueData() {
            return new Promise((resolve) => {
                updateStatus('', 'Chargement...');

                var userEmail = getUserEmail();
                authenticatedFetch(SUPABASE_URL + '/rest/v1/catalogue_items?select=id,category,description,type,price,instruction,image_url,in_calculator,status,proposed_by,labor_minutes,material_costs,calculation_rule_ai,is_default,client_text,presentation_rule,item_type,dims_config&or=(status.eq.approved,status.is.null,and(status.eq.pending,proposed_by.eq.' + encodeURIComponent(userEmail) + '))&order=sort_order', {})
                .then(r => {
                    if (!r.ok) throw new Error('HTTP ' + r.status);
                    return r.json();
                })
                .then(data => {
                    if (data.length > 0) {
                        CATALOGUE_DATA = data;
                        saveToLocalStorage(data);
                        updateStatus('online', 'Données à jour');
                        resolve(true);
                    } else {
                        throw new Error('Données vides');
                    }
                })
                .catch(error => {
                    console.warn('Erreur chargement catalogue:', error);
                    loadFallbackData();
                    resolve(false);
                });
            });
        }

        function loadFallbackData() {
            const cached = loadFromLocalStorage();
            if (cached && cached.data && cached.data.length > 0) {
                CATALOGUE_DATA = cached.data;
                const dateStr = cached.date ? formatDate(cached.date) : '';
                updateStatus('offline', 'Hors-ligne' + (dateStr ? ' — ' + dateStr : ''));
            } else {
                updateStatus('error', 'Aucune donnée disponible');
            }
        }

        function loadEmployeesData() {
            return new Promise((resolve) => {
                authenticatedFetch(SUPABASE_URL + '/rest/v1/employees?select=name,email&order=sort_order', {})
                .then(r => {
                    if (!r.ok) throw new Error('HTTP ' + r.status);
                    return r.json();
                })
                .then(data => {
                    EMPLOYEES_DATA = data;
                    resolve(true);
                })
                .catch(error => {
                    console.warn('Erreur chargement employ\u00e9s:', error);
                    resolve(false);
                });
            });
        }

        // ═══════════════════════════════════════════════════════════════════════
        // CALCULATEUR — SECTIONS PAR MEUBLE
        // ═══════════════════════════════════════════════════════════════════════

        let rowCounter = 0;
        let groupCounter = 0;

        // ── Combobox autocomplete ──
        var _cbActiveRowId = null;
        var _cbIdx = -1; // keyboard navigation index

        function getCatalogueItems() {
            return CATALOGUE_DATA.filter(function(item) {
                return (item.price !== null || item.labor_minutes || item.material_costs) &&
                       item.type !== '%' && item.in_calculator !== false;
            }).sort(function(a, b) { return (a.category || '').localeCompare(b.category || ''); });
        }

        function openCombobox(rowId) {
            if (_cbActiveRowId === rowId) return; // already open
            closeCombobox();
            _cbActiveRowId = rowId;
            _cbIdx = -1;
            var cbInput = document.getElementById(rowId + '-cb');
            if (!cbInput) return;

            // Clear display for search mode
            cbInput.dataset.prevValue = cbInput.value;
            cbInput.value = '';
            cbInput.classList.remove('has-value');

            // Create dropdown
            var dd = document.getElementById('cbDropdown');
            if (!dd) {
                dd = document.createElement('div');
                dd.id = 'cbDropdown';
                dd.className = 'cb-dropdown';
                document.body.appendChild(dd);
            }
            dd.style.display = '';
            dd.innerHTML = '';
            renderComboboxItems(dd, '');
            positionCombobox(dd, cbInput);

            // Keyboard
            cbInput.onkeydown = function(e) { handleComboboxKey(e, rowId); };
            cbInput.oninput = function() { renderComboboxItems(dd, cbInput.value); _cbIdx = -1; };

            // Click outside
            setTimeout(function() {
                document.addEventListener('mousedown', _cbOutsideClick);
            }, 0);
        }

        function _cbOutsideClick(e) {
            var dd = document.getElementById('cbDropdown');
            if (dd && dd.contains(e.target)) return;
            var cbInput = _cbActiveRowId ? document.getElementById(_cbActiveRowId + '-cb') : null;
            if (cbInput && cbInput.contains(e.target)) return;
            closeCombobox();
        }

        function closeCombobox() {
            document.removeEventListener('mousedown', _cbOutsideClick);
            var dd = document.getElementById('cbDropdown');
            if (dd) dd.style.display = 'none';
            // Restore display value if no selection was made
            if (_cbActiveRowId) {
                syncComboboxDisplay(_cbActiveRowId);
            }
            _cbActiveRowId = null;
            _cbIdx = -1;
        }

        function positionCombobox(dd, anchor) {
            var r = anchor.getBoundingClientRect();
            var spaceBelow = window.innerHeight - r.bottom;
            dd.style.left = r.left + 'px';
            dd.style.width = Math.max(r.width, 360) + 'px';
            if (spaceBelow < 200) {
                dd.style.bottom = (window.innerHeight - r.top + 4) + 'px';
                dd.style.top = 'auto';
            } else {
                dd.style.top = (r.bottom + 4) + 'px';
                dd.style.bottom = 'auto';
            }
        }

        function renderComboboxItems(dd, query) {
            var q = (query || '').toLowerCase().trim();
            var items = getCatalogueItems();
            if (q) {
                items = items.filter(function(item) {
                    return (item.description || '').toLowerCase().indexOf(q) !== -1 ||
                           (item.id || '').toLowerCase().indexOf(q) !== -1 ||
                           (item.client_text || '').toLowerCase().indexOf(q) !== -1;
                });
            }
            var html = '';
            var currentCat = '';
            items.forEach(function(item, idx) {
                if (item.category !== currentCat) {
                    currentCat = item.category;
                    html += '<div class="cb-group-label">' + escapeHtml(currentCat || 'Autre') + '</div>';
                }
                var pending = (item.status === 'pending') ? ' <span style="color:#f59e0b;">(en attente)</span>' : '';
                html += '<div class="cb-item" data-id="' + escapeAttr(item.id) + '" data-idx="' + idx + '" onclick="selectComboboxItem(\'' + escapeAttr(item.id) + '\')" onmouseenter="_cbIdx=' + idx + '">'
                    + '<span class="cb-item-code">' + escapeHtml(item.id) + '</span>'
                    + '<span class="cb-item-desc">' + escapeHtml(item.description) + pending + '</span>'
                    + '<span class="cb-item-type">' + escapeHtml(item.type || '') + '</span>'
                    + '</div>';
            });
            // Special options
            html += '<div class="cb-group-label">Autre</div>';
            html += '<div class="cb-item" onclick="selectComboboxItem(\'__PROPOSER__\')"><span class="cb-item-special">\ud83d\udccb Proposer un nouvel article...</span></div>';
            html += '<div class="cb-item" onclick="selectComboboxItem(\'__AJOUT__\')"><span class="cb-item-special">\u2795 Ajout personnalis\u00e9...</span></div>';

            if (items.length === 0 && q) {
                html = '<div class="cb-empty">Aucun article trouv\u00e9 pour \u00ab ' + escapeHtml(q) + ' \u00bb</div>' + html;
            }
            dd.innerHTML = html;
        }

        function selectComboboxItem(itemId) {
            if (!_cbActiveRowId) return;
            var rowId = _cbActiveRowId;
            var row = document.getElementById(rowId);
            if (!row) return;
            var hidden = row.querySelector('.item-select');
            if (hidden) hidden.value = itemId;
            closeCombobox();
            updateRow(rowId);
        }

        function handleComboboxKey(e, rowId) {
            var dd = document.getElementById('cbDropdown');
            if (!dd) return;
            var allItems = dd.querySelectorAll('.cb-item');
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                _cbIdx = Math.min(_cbIdx + 1, allItems.length - 1);
                allItems.forEach(function(el, i) { el.classList.toggle('cb-active', i === _cbIdx); });
                if (allItems[_cbIdx]) allItems[_cbIdx].scrollIntoView({ block: 'nearest' });
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                _cbIdx = Math.max(_cbIdx - 1, 0);
                allItems.forEach(function(el, i) { el.classList.toggle('cb-active', i === _cbIdx); });
                if (allItems[_cbIdx]) allItems[_cbIdx].scrollIntoView({ block: 'nearest' });
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (_cbIdx >= 0 && allItems[_cbIdx]) {
                    allItems[_cbIdx].click();
                }
            } else if (e.key === 'Escape') {
                e.preventDefault();
                closeCombobox();
            }
        }

        function syncComboboxDisplay(rowId) {
            var row = document.getElementById(rowId);
            if (!row) return;
            var hidden = row.querySelector('.item-select');
            var cbInput = document.getElementById(rowId + '-cb');
            var editBtn = document.getElementById(rowId + '-edit-btn');
            if (!hidden || !cbInput) return;
            var val = hidden.value;
            if (val && val !== '__PROPOSER__' && val !== '__AJOUT__') {
                var item = CATALOGUE_DATA.find(function(i) { return i.id === val; });
                cbInput.value = item ? item.description : val;
                cbInput.classList.add('has-value');
                if (editBtn) editBtn.style.display = '';
            } else if (val === '__AJOUT__') {
                cbInput.value = 'Ajout personnalis\u00e9';
                cbInput.classList.add('has-value');
                if (editBtn) editBtn.style.display = 'none';
            } else if (val === '__PROPOSER__') {
                cbInput.value = 'Proposer un article';
                cbInput.classList.add('has-value');
                if (editBtn) editBtn.style.display = 'none';
            } else {
                cbInput.value = '';
                cbInput.classList.remove('has-value');
                if (editBtn) editBtn.style.display = 'none';
            }
        }

        function openCatalogueItem(rowId) {
            var row = document.getElementById(rowId);
            if (!row) return;
            var hidden = row.querySelector('.item-select');
            var val = hidden ? hidden.value : '';
            if (val && val !== '__PROPOSER__' && val !== '__AJOUT__') {
                window.open('catalogue_prix_stele_complet.html?edit=' + encodeURIComponent(val), '_blank');
            }
        }

        function toggleGroup(groupId) {
            document.getElementById(groupId).classList.toggle('collapsed');
        }

        function toggleProjectInstallation() {
            var cb = document.getElementById('projInstallation');
            var checked = cb.checked;
            // Cascade vers toutes les sections
            document.querySelectorAll('.furniture-group').forEach(function(group) {
                var groupId = group.id;
                var sectionCb = document.getElementById(groupId + '-install');
                if (sectionCb && sectionCb.checked !== checked) {
                    sectionCb.checked = checked;
                    toggleInstallation(groupId);
                }
            });
        }

        function toggleInstallation(groupId) {
            var cb = document.getElementById(groupId + '-install');
            // Cascade vers toutes les lignes de ce groupe
            var rows = document.querySelectorAll('#' + groupId + '-rows .calc-row');
            rows.forEach(function(row) {
                var rowCb = document.getElementById(row.id + '-install');
                if (rowCb) rowCb.checked = cb.checked;
                updateRow(row.id);
            });

            // Sauvegarder dans Supabase
            if (roomMap[groupId]) {
                updateRoom(roomMap[groupId], { installation_included: cb.checked });
                showSaveIndicator();
            }
        }

        function toggleRowInstallation(rowId) {
            updateRow(rowId);
            // Sauvegarder dans Supabase
            if (itemMap[rowId]) {
                var cb = document.getElementById(rowId + '-install');
                updateItem(itemMap[rowId], { installation_included: cb.checked });
                showSaveIndicator();
            }
        }

        function addFurnitureGroup(initialName, opts) {
            opts = opts || {};
            groupCounter++;
            const groupId = `group-${groupCounter}`;

            const group = document.createElement('div');
            group.className = 'furniture-group';
            group.id = groupId;

            group.innerHTML = `
                <div class="furniture-group-header">
                    <button class="btn-collapse" onclick="toggleGroup('${groupId}')" title="Réduire / Agrandir">&#9660;</button>
                    <span class="group-label">Meuble :</span>
                    <input type="text" class="furniture-name-input" id="${groupId}-name"
                           placeholder="ex: Cuisine, Salle de bain, Sous-sol..."
                           value="${escapeAttr(initialName || '')}">
                    <label class="install-toggle" title="Inclure l'installation">
                        <input type="checkbox" id="${groupId}-install" checked onchange="toggleInstallation('${groupId}')">
                        <span class="install-label">Installation</span>
                    </label>
                    <button class="btn-rentab" onclick="openRentab('group','${groupId}')">Rentabilit&eacute;</button>
                    <button class="btn-ai-focus" id="${groupId}-aiFocus" onclick="toggleAiFocus('${groupId}')" title="Cibler l'AI sur cette pi&egrave;ce"></button>
                    <button class="btn-remove-group" onclick="removeFurnitureGroup('${groupId}')">Supprimer</button>
                </div>
                <div class="client-description-section">
                    <label class="client-desc-label">Description client</label>
                    <textarea class="client-desc-textarea" id="${groupId}-clientDesc"
                              placeholder="Description visible par le client pour cette pi&egrave;ce..."
                              rows="2"
                              onblur="saveClientDescription('${groupId}')"></textarea>
                </div>
                <div class="calc-header">
                    <span></span>
                    <span class="col-center sortable" onclick="sortGroupRows('${groupId}','tag')">Tag<span class="sort-arrow">&#9650;</span></span>
                    <span class="sortable" onclick="sortGroupRows('${groupId}','article')">Article<span class="sort-arrow">&#9650;</span></span>
                    <span class="col-center">Code</span>
                    <span class="col-center">Type</span>
                    <span class="col-center">L&times;H&times;P</span>
                    <span class="col-right sortable" onclick="sortGroupRows('${groupId}','price')">Prix unit.<span class="sort-arrow">&#9650;</span></span>
                    <span class="col-center sortable" onclick="sortGroupRows('${groupId}','qty')">Quantit&eacute;<span class="sort-arrow">&#9650;</span></span>
                    <span class="col-center" title="Installation incluse">Inst.</span>
                    <span class="col-right sortable" onclick="sortGroupRows('${groupId}','total')">Total<span class="sort-arrow">&#9650;</span></span>
                    <span></span>
                </div>
                <div class="calc-rows" id="${groupId}-rows">
                    <div class="add-row-container">
                        <button class="btn-add" onclick="addRow('${groupId}')" title="Ajouter une ligne">+</button>
                        <span class="add-row-text">Ajouter un article</span>
                    </div>
                </div>
                <div class="group-subtotal-container">
                    <span class="group-subtotal-label">Sous-total</span>
                    <span class="group-subtotal-amount" id="${groupId}-subtotal">0,00 $</span>
                </div>
                <div class="group-images-section">
                    <div class="group-images-header">Images / Photos</div>
                    <div class="image-drop-zone group-image-drop-zone" id="${groupId}-imgDrop">
                        <div class="image-drop-zone-text">
                            <strong>Ctrl+V</strong> pour coller &middot; <strong>glisser-d&eacute;poser</strong> &middot; ou <strong>cliquer</strong>
                        </div>
                    </div>
                    <input type="file" id="${groupId}-imgInput" accept="image/png,image/jpeg,image/webp,application/pdf" multiple style="display:none;">
                    <div class="image-previews" id="${groupId}-imgPreviews"></div>
                    <div class="image-count" id="${groupId}-imgCount"></div>
                </div>
            `;

            document.getElementById('furnitureGroups').appendChild(group);
            setupGroupImageHandlers(groupId);
            if (!groupImages[groupId]) groupImages[groupId] = [];

            // Persistance Supabase
            if (opts.existingId) {
                roomMap[groupId] = opts.existingId;
            } else if (currentSubmission && !opts.skipSave) {
                const sortOrder = document.querySelectorAll('.furniture-group').length;
                createRoom(currentSubmission.id, initialName || '', sortOrder).then(room => {
                    if (room) roomMap[groupId] = room.id;
                });
            }

            // Auto-save nom du meuble sur blur
            const nameInput = document.getElementById(`${groupId}-name`);
            nameInput.addEventListener('blur', function() {
                if (roomMap[groupId]) {
                    updateRoom(roomMap[groupId], { name: this.value });
                    showSaveIndicator();
                }
            });

            // Observe header for AI scope tracking
            if (aiScopeObserver) {
                var header = group.querySelector('.furniture-group-header');
                if (header) aiScopeObserver.observe(header);
            }

            return groupId;
        }

        async function removeFurnitureGroup(groupId) {
            if (!(await steleConfirm('Supprimer ce meuble et tous ses articles ?', 'Supprimer', 'Supprimer', true))) return;

            // Supprimer dans Supabase
            if (roomMap[groupId]) {
                deleteRoom(roomMap[groupId]);
                // Nettoyer les itemMap pour les rows de ce groupe
                const group = document.getElementById(groupId);
                if (group) {
                    group.querySelectorAll('.calc-row').forEach(row => {
                        delete itemMap[row.id];
                    });
                }
                delete roomMap[groupId];
            }
            delete groupImages[groupId];

            const group = document.getElementById(groupId);
            if (group) {
                // Unobserve header before removing
                if (aiScopeObserver) {
                    var header = group.querySelector('.furniture-group-header');
                    if (header) aiScopeObserver.unobserve(header);
                }
                group.remove();
                updateGrandTotal();
            }
        }

        function addRow(groupId, opts) {
            opts = opts || {};
            rowCounter++;
            const rowId = `row-${rowCounter}`;

            const row = document.createElement('div');
            row.className = 'calc-row' + (opts.cascade ? ' cascade-child' : '');
            row.id = rowId;
            row.dataset.mode = 'normal';
            row.dataset.group = groupId;
            row.innerHTML = `
                <div class="cell-add">
                    <button class="btn-add" onclick="addRow('${groupId}')" title="Ajouter une ligne">+</button>
                </div>
                <div class="cell-tag">
                    <input type="text" id="${rowId}-tag" placeholder="—" maxlength="4" oninput="this.value=this.value.toUpperCase()" onblur="saveRowTag('${rowId}')">
                </div>
                <div class="cell-select">
                    <div class="combobox">
                        <input type="hidden" class="item-select" value="">
                        <input type="text" class="combobox-input" id="${rowId}-cb" placeholder="Rechercher un article..."
                               autocomplete="off" onclick="openCombobox('${rowId}')" onfocus="openCombobox('${rowId}')">
                        <button class="btn-edit-cat" id="${rowId}-edit-btn" onclick="openCatalogueItem('${rowId}')" title="Ouvrir dans le catalogue" style="display:none;">&#9998;</button>
                    </div>
                </div>
                <div class="cell-code" id="${rowId}-code">—</div>
                <div class="cell-type" id="${rowId}-type">—</div>
                <div class="cell-dims dims-hidden" id="${rowId}-dims">&mdash;</div>
                <div class="cell-unit-price" id="${rowId}-unit-price">—</div>
                <div class="cell-qty">
                    <input type="number" class="qty-input" id="${rowId}-qty" value="1" min="0" step="0.01" onchange="updateRow('${rowId}')" oninput="updateRow('${rowId}')">
                </div>
                <div class="install-toggle-row">
                    <input type="checkbox" id="${rowId}-install" checked onchange="toggleRowInstallation('${rowId}')" title="Installation incluse">
                </div>
                <div class="cell-total" id="${rowId}-total">0,00 $</div>
                <div class="cell-remove">
                    <button class="btn-remove" onclick="removeRow('${rowId}')" title="Supprimer">×</button>
                </div>
            `;

            const container = document.getElementById(`${groupId}-rows`);
            const addContainer = container.querySelector('.add-row-container');
            container.insertBefore(row, addContainer);

            // ── Insertion animation (skip when loading existing data) ──
            if (!opts.existingId) {
                var staggerMs = (opts.staggerIndex || 0) * 50;
                row.style.opacity = '0';
                setTimeout(function() {
                    row.style.opacity = '';
                    row.classList.add('row-entering');
                    row.addEventListener('animationend', function handler() {
                        row.classList.remove('row-entering');
                        row.removeEventListener('animationend', handler);
                    }, { once: true });
                }, staggerMs);
            }

            // Persistance Supabase
            if (opts.existingId) {
                itemMap[rowId] = opts.existingId;
            } else if (currentSubmission && roomMap[groupId] && !opts.skipSave) {
                const sortOrder = container.querySelectorAll('.calc-row').length;
                createItem(roomMap[groupId], { sort_order: sortOrder }).then(item => {
                    if (item) itemMap[rowId] = item.id;
                });
            }

            if (!opts.skipFocus) { var cbFocus = document.getElementById(rowId + '-cb'); if (cbFocus) cbFocus.focus(); }
            return rowId;
        }

        function transformToAjoutMode(row, rowId) {
            row.dataset.mode = 'ajout';
            row.style.background = '#edf0f5';

            const codeEl = document.getElementById(`${rowId}-code`);
            const typeEl = document.getElementById(`${rowId}-type`);
            const unitPriceEl = document.getElementById(`${rowId}-unit-price`);

            codeEl.innerHTML = `<input type="text" class="ajout-description" id="${rowId}-desc" placeholder="Description..." oninput="updateRow('${rowId}')" style="width: 100%; padding: 6px 8px; font-size: 12px; border: 1px solid #C8C8C8; border-radius: 4px;">`;
            codeEl.style.gridColumn = 'span 1';
            typeEl.innerHTML = `<input type="number" class="ajout-price" id="${rowId}-price" placeholder="Prix" value="0" min="0" step="0.01" oninput="updateRow('${rowId}')" style="width: 100%; padding: 6px 8px; font-size: 12px; border: 1px solid #C8C8C8; border-radius: 4px; text-align: right; -moz-appearance: textfield;" onwheel="this.blur()">`;
            unitPriceEl.innerHTML = `<div style="display: flex; align-items: center; gap: 4px;"><input type="number" class="ajout-markup" id="${rowId}-markup" value="30" min="0" step="1" oninput="updateRow('${rowId}')" style="width: 60px; padding: 6px 8px; font-size: 12px; border: 1px solid #C8C8C8; border-radius: 4px; text-align: right; -moz-appearance: textfield;" onwheel="this.blur()"><span style="font-size: 11px; color: #666;">%</span></div>`;

            setTimeout(() => {
                const descInput = document.getElementById(`${rowId}-desc`);
                if (descInput) descInput.focus();
            }, 50);
        }

        function transformToNormalMode(row, rowId) {
            row.dataset.mode = 'normal';
            row.style.background = '';
            document.getElementById(`${rowId}-code`).innerHTML = '—';
            document.getElementById(`${rowId}-code`).style.gridColumn = '';
            document.getElementById(`${rowId}-type`).innerHTML = '—';
            document.getElementById(`${rowId}-unit-price`).innerHTML = '—';
            document.getElementById(`${rowId}-total`).textContent = '0,00 $';
        }

        let configCategories = [];

        async function loadConfigCategories() {
            try {
                const r = await authenticatedFetch(
                    SUPABASE_URL + '/rest/v1/app_config?key=eq.catalogue_categories&select=value', {}
                );
                if (r.ok) {
                    const rows = await r.json();
                    if (rows.length > 0 && Array.isArray(rows[0].value)) {
                        configCategories = rows[0].value;
                    }
                }
            } catch (e) { /* keep empty */ }
        }

        var tagPrefixes = [
            { prefix: 'C', label_fr: 'Caisson', label_en: 'Cabinet' },
            { prefix: 'F', label_fr: 'Filler', label_en: 'Filler' },
            { prefix: 'P', label_fr: 'Panneau', label_en: 'Panel' },
            { prefix: 'T', label_fr: 'Tiroir', label_en: 'Drawer' },
            { prefix: 'M', label_fr: 'Moulure', label_en: 'Moulding' },
            { prefix: 'A', label_fr: 'Accessoire', label_en: 'Accessory' }
        ];

        async function loadTauxAndExpenses() {
            try {
                const r = await authenticatedFetch(
                    SUPABASE_URL + '/rest/v1/app_config?key=in.(taux_horaires,expense_categories,tag_prefixes)&select=key,value', {}
                );
                if (r.ok) {
                    const rows = await r.json();
                    rows.forEach(function(row) {
                        if (row.key === 'taux_horaires') tauxHoraires = row.value || [];
                        if (row.key === 'expense_categories') expenseCategories = row.value || [];
                        if (row.key === 'tag_prefixes') tagPrefixes = row.value || tagPrefixes;
                    });
                }
            } catch (e) { /* keep defaults */ }
        }

        async function loadPipelineConfig() {
            try {
                var r = await authenticatedFetch(
                    SUPABASE_URL + '/rest/v1/app_config?key=in.(pipeline_statuses,project_sources,project_types)&select=key,value', {}
                );
                if (r.ok) {
                    var rows = await r.json();
                    rows.forEach(function(row) {
                        if (row.key === 'pipeline_statuses') pipelineStatuses = row.value || [];
                        if (row.key === 'project_sources') projectSources = row.value || [];
                        if (row.key === 'project_types') projectTypes = row.value || [];
                    });
                }
            } catch (e) { /* keep empty */ }
            // Defaults if nothing loaded
            if (!pipelineStatuses.length) {
                pipelineStatuses = [
                    {slug:'a_contacter',label:'A contacter',color:'#9e9e9e',sort_order:1},
                    {slug:'en_attente_infos',label:'En attente d\'infos',color:'#ff9800',sort_order:2},
                    {slug:'a_soumissionner',label:'A soumissionner',color:'#2196f3',sort_order:3},
                    {slug:'en_revision',label:'En r\u00e9vision',color:'#9c27b0',sort_order:4},
                    {slug:'a_presenter',label:'A pr\u00e9senter',color:'#00bcd4',sort_order:5},
                    {slug:'envoye',label:'Envoy\u00e9',color:'#3f51b5',sort_order:6},
                    {slug:'en_discussions',label:'En discussions',color:'#ff5722',sort_order:7},
                    {slug:'vendu',label:'Vendu',color:'#4caf50',sort_order:8},
                    {slug:'perdu',label:'Perdu',color:'#f44336',sort_order:9}
                ];
            }
            if (!projectTypes.length) {
                projectTypes = ['R\u00e9sidentiel', 'R\u00e9sidentiel d\'envergure', 'Commercial', 'Collaboration', 'Autre'];
            }
        }

        // Calculer le prix composé d'un article catalogue
        function computeComposedPrice(item, includeInstallation) {
            var laborMinutes = item.labor_minutes || {};
            var materialCosts = item.material_costs || {};
            var hasComposed = false;

            // Main-d'œuvre
            var laborTotal = 0;
            for (var i = 0; i < tauxHoraires.length; i++) {
                var dept = tauxHoraires[i].department;
                var minutes = laborMinutes[dept] || 0;
                if (minutes > 0) {
                    if (!includeInstallation && dept === 'Installation') continue;
                    laborTotal += (minutes / 60) * (tauxHoraires[i].taux_horaire || 0);
                    hasComposed = true;
                }
            }

            // Matériaux
            var materialTotal = 0;
            for (var j = 0; j < expenseCategories.length; j++) {
                var cat = expenseCategories[j].name;
                var cost = materialCosts[cat] || 0;
                if (cost > 0) {
                    var markup = (expenseCategories[j].markup || 0) / 100;
                    var waste = (expenseCategories[j].waste || 0) / 100;
                    materialTotal += cost * (1 + markup + waste);
                    hasComposed = true;
                }
            }

            if (!hasComposed) return null; // pas de prix composé → utiliser item.price
            return laborTotal + materialTotal;
        }

        function getCategories() {
            const cats = new Set();
            CATALOGUE_DATA.forEach(item => { if (item.category) cats.add(item.category); });
            configCategories.forEach(c => cats.add(c));
            return Array.from(cats).sort();
        }

        function generateNextCode(category) {
            const clean = (category || 'XXX').normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            const prefix = clean.substring(0, 3).toUpperCase();
            let maxNum = 0;
            CATALOGUE_DATA.forEach(item => {
                if (item.id && item.id.startsWith(prefix + '-')) {
                    const num = parseInt(item.id.split('-')[1]) || 0;
                    if (num > maxNum) maxNum = num;
                }
            });
            return prefix + '-' + String(maxNum + 1).padStart(3, '0');
        }

        let proposerRowId = null; // rowId en cours de proposition

        function transformToProposerMode(row, rowId) {
            row.dataset.mode = 'proposer';
            proposerRowId = rowId;
            openProposerModal();
        }

        function updatePropCode() {
            var cat = document.getElementById('propCategory').value;
            document.getElementById('propCode').value = generateNextCode(cat);
        }

        function openProposerModal() {
            // Remplir le dropdown catégories
            const catSelect = document.getElementById('propCategory');
            const categories = getCategories();
            catSelect.innerHTML = categories.map(c => `<option value="${escapeAttr(c)}">${escapeHtml(c)}</option>`).join('');

            // Remplir le dropdown types
            const typeSelect = document.getElementById('propType');
            const types = new Set(['pi\u00b2', 'unitaire', 'lin\u00e9aire', '%']);
            CATALOGUE_DATA.forEach(function(i) { if (i.type) types.add(i.type); });
            typeSelect.innerHTML = Array.from(types).map(t => `<option value="${escapeAttr(t)}">${escapeHtml(t)}</option>`).join('');

            // Réinitialiser les champs
            document.getElementById('propDescription').value = '';
            document.getElementById('propType').value = 'unitaire';
            document.getElementById('propPrice').value = '';
            document.getElementById('propPriceDisplay').textContent = 'Calcul\u00e9 automatiquement';
            document.getElementById('propInstruction').value = '';
            document.getElementById('propInCalculator').checked = true;

            // Code auto-généré
            updatePropCode();

            // Tableaux prix composé
            renderPropComposedTables();

            // Médias
            propMedia = [];
            renderPropMedia();

            // Reset status
            var status = document.getElementById('propStatus');
            status.className = 'edit-status';
            status.style.display = 'none';
            document.getElementById('btnProposerSave').disabled = false;
            document.getElementById('btnProposerSave').textContent = 'Enregistrer';

            document.getElementById('proposerModal').classList.add('active');
            setTimeout(() => document.getElementById('propDescription').focus(), 100);
        }

        function closeProposerModal() {
            document.getElementById('proposerModal').classList.remove('active');

            // Si on ferme sans sauvegarder, remettre la row en mode normal
            if (proposerRowId) {
                const row = document.getElementById(proposerRowId);
                if (row && row.dataset.mode === 'proposer') {
                    const select = row.querySelector('.item-select');
                    select.value = '';
                    transformToNormalMode(row, proposerRowId);
                    updateRow(proposerRowId);
                }
                proposerRowId = null;
            }
        }

        // ── Prix composé pour le modal de proposition ──

        function renderPropComposedTables() {
            var mBody = document.getElementById('propCpMinutesBody');
            var mHtml = '';
            for (var i = 0; i < tauxHoraires.length; i++) {
                var dept = tauxHoraires[i].department;
                mHtml += '<tr><td>' + escapeHtml(dept) + '</td>' +
                    '<td><input type="number" step="0.1" placeholder="0" value=""' +
                    ' data-dept="' + escapeAttr(dept) + '"' +
                    (canEditMinutes ? '' : ' disabled') +
                    ' oninput="updatePropComposedPrice()"></td></tr>';
            }
            mBody.innerHTML = mHtml;

            var cBody = document.getElementById('propCpMaterialsBody');
            var cHtml = '';
            for (var j = 0; j < expenseCategories.length; j++) {
                var cat = expenseCategories[j].name;
                cHtml += '<tr><td title="' + escapeAttr(cat) + '">' + escapeHtml(cat) + '</td>' +
                    '<td><input type="number" step="0.01" placeholder="0.00" value=""' +
                    ' data-cat="' + escapeAttr(cat) + '"' +
                    (canEditMaterials ? '' : ' disabled') +
                    ' oninput="updatePropComposedPrice()"></td></tr>';
            }
            cBody.innerHTML = cHtml;

            updatePropComposedPrice();
        }

        function updatePropComposedPrice() {
            var laborTotal = 0;
            var mInputs = document.querySelectorAll('#propCpMinutesBody input[type="number"]');
            for (var i = 0; i < mInputs.length; i++) {
                var minutes = parseFloat(mInputs[i].value) || 0;
                var dept = mInputs[i].getAttribute('data-dept');
                var taux = tauxHoraires.find(function(t) { return t.department === dept; });
                laborTotal += (minutes / 60) * (taux ? (taux.taux_horaire || 0) : 0);
            }

            var materialTotal = 0;
            var cInputs = document.querySelectorAll('#propCpMaterialsBody input[type="number"]');
            for (var j = 0; j < cInputs.length; j++) {
                var cost = parseFloat(cInputs[j].value) || 0;
                var catName = cInputs[j].getAttribute('data-cat');
                var expCat = expenseCategories.find(function(c) { return c.name === catName; });
                var markup = (expCat ? (expCat.markup || 0) : 0) / 100;
                var waste = (expCat ? (expCat.waste || 0) : 0) / 100;
                materialTotal += cost * (1 + markup + waste);
            }

            var total = laborTotal + materialTotal;
            var totalEl = document.getElementById('propCpTotalValue');
            var breakdownEl = document.getElementById('propCpBreakdown');
            var priceField = document.getElementById('propPrice');
            var priceDisplay = document.getElementById('propPriceDisplay');

            if (total > 0) {
                totalEl.textContent = formatPrice(total);
                breakdownEl.textContent = '(MO: ' + formatPrice(laborTotal) + ' + Mat: ' + formatPrice(materialTotal) + ')';
                priceField.value = total.toFixed(2);
                priceDisplay.textContent = formatPrice(total);
            } else {
                totalEl.textContent = '\u2014';
                breakdownEl.textContent = '';
                priceField.value = '';
                priceDisplay.textContent = 'Calcul\u00e9 automatiquement';
            }
        }

        function collectPropLaborMinutes() {
            var data = {};
            var inputs = document.querySelectorAll('#propCpMinutesBody input[type="number"]');
            for (var i = 0; i < inputs.length; i++) {
                var val = parseFloat(inputs[i].value) || 0;
                if (val > 0) data[inputs[i].getAttribute('data-dept')] = val;
            }
            return data;
        }

        function collectPropMaterialCosts() {
            var data = {};
            var inputs = document.querySelectorAll('#propCpMaterialsBody input[type="number"]');
            for (var i = 0; i < inputs.length; i++) {
                var val = parseFloat(inputs[i].value) || 0;
                if (val > 0) data[inputs[i].getAttribute('data-cat')] = val;
            }
            return data;
        }

        // ── Médias pour le modal de proposition ──

        function setupProposerMediaHandlers() {
            var dropzone = document.getElementById('propDropzone');
            var fileInput = document.getElementById('propMediaInput');
            if (!dropzone || !fileInput) return;

            dropzone.addEventListener('click', function() { fileInput.click(); });
            dropzone.addEventListener('dragover', function(e) { e.preventDefault(); dropzone.classList.add('dragover'); });
            dropzone.addEventListener('dragleave', function() { dropzone.classList.remove('dragover'); });
            dropzone.addEventListener('drop', function(e) {
                e.preventDefault();
                dropzone.classList.remove('dragover');
                handlePropMediaFiles(e.dataTransfer.files);
            });
            fileInput.addEventListener('change', function() {
                handlePropMediaFiles(fileInput.files);
                fileInput.value = '';
            });
        }

        function handlePropMediaFiles(files) {
            Array.from(files).forEach(function(file) {
                var isPdf = file.type === 'application/pdf';
                var isImage = file.type.startsWith('image/');
                if (!isPdf && !isImage) return;

                var mediaEntry = {
                    id: null, file_url: null, previewUrl: null,
                    file_type: isPdf ? 'pdf' : 'image',
                    tags: [], isNew: true, file: file
                };

                if (isImage) {
                    var reader = new FileReader();
                    reader.onload = function(e) {
                        mediaEntry.previewUrl = e.target.result;
                        propMedia.push(mediaEntry);
                        renderPropMedia();
                    };
                    reader.readAsDataURL(file);
                } else {
                    propMedia.push(mediaEntry);
                    renderPropMedia();
                }
            });
        }

        function renderPropMedia() {
            var list = document.getElementById('propMediaList');
            list.innerHTML = '';

            propMedia.forEach(function(media, index) {
                var item = document.createElement('div');
                item.className = 'cat-media-item';

                if (media.file_type === 'pdf') {
                    var pdfIcon = document.createElement('div');
                    pdfIcon.className = 'cat-pdf-icon';
                    pdfIcon.textContent = 'PDF';
                    item.appendChild(pdfIcon);
                } else {
                    var img = document.createElement('img');
                    img.src = media.file_url || media.previewUrl || '';
                    img.alt = '';
                    item.appendChild(img);
                }

                var info = document.createElement('div');
                info.className = 'cat-media-info';
                var tags = document.createElement('div');
                tags.className = 'cat-media-tags';

                mediaTagsList.forEach(function(tag) {
                    var chip = document.createElement('span');
                    chip.className = 'cat-tag' + (media.tags.indexOf(tag) !== -1 ? ' active' : '');
                    chip.textContent = tag.replace(/_/g, ' ');
                    chip.onclick = function() {
                        var idx = media.tags.indexOf(tag);
                        if (idx !== -1) media.tags.splice(idx, 1);
                        else media.tags.push(tag);
                        chip.classList.toggle('active');
                    };
                    tags.appendChild(chip);
                });

                info.appendChild(tags);
                item.appendChild(info);

                var removeBtn = document.createElement('button');
                removeBtn.className = 'cat-media-remove';
                removeBtn.innerHTML = '&times;';
                removeBtn.title = 'Supprimer';
                removeBtn.onclick = function() {
                    propMedia.splice(index, 1);
                    renderPropMedia();
                };
                item.appendChild(removeBtn);

                list.appendChild(item);
            });
        }

        // ── Sauvegarde ──

        async function saveProposedItem() {
            if (!proposerRowId) return;

            const category = document.getElementById('propCategory').value;
            const description = document.getElementById('propDescription').value.trim();
            const type = document.getElementById('propType').value;
            const priceVal = document.getElementById('propPrice').value;
            const price = priceVal !== '' ? parseFloat(priceVal) : null;
            const instruction = document.getElementById('propInstruction').value.trim();
            const inCalculator = document.getElementById('propInCalculator').checked;
            const laborMinutes = collectPropLaborMinutes();
            const materialCosts = collectPropMaterialCosts();

            if (!description) { document.getElementById('propDescription').focus(); return; }
            if (!price || price <= 0) {
                // Vérifier s'il y a des données composées
                if (Object.keys(laborMinutes).length === 0 && Object.keys(materialCosts).length === 0) {
                    steleAlert('Veuillez remplir les minutes ou mat\u00e9riaux pour calculer le prix.');
                    return;
                }
            }

            const btn = document.getElementById('btnProposerSave');
            btn.disabled = true;
            btn.textContent = 'Enregistrement...';

            const newId = document.getElementById('propCode').value || generateNextCode(category);
            const email = getUserEmail();

            const payload = {
                id: newId,
                category: category,
                description: description,
                type: type,
                price: price,
                instruction: instruction || null,
                labor_minutes: Object.keys(laborMinutes).length > 0 ? laborMinutes : null,
                material_costs: Object.keys(materialCosts).length > 0 ? materialCosts : null,
                status: 'pending',
                proposed_by: email,
                in_calculator: inCalculator,
                sort_order: 9999
            };

            try {
                const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/catalogue_items', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                    body: JSON.stringify(payload)
                });
                if (!r.ok) throw new Error('HTTP ' + r.status);
                const data = await r.json();
                const newItem = data[0] || payload;

                // Upload des médias
                for (var mi = 0; mi < propMedia.length; mi++) {
                    var m = propMedia[mi];
                    if (m.isNew && m.file) {
                        var ext = m.file.name.split('.').pop().toLowerCase() || 'bin';
                        var path = newId + '/' + Date.now() + '_' + mi + '.' + ext;
                        var uploadResp = await authenticatedFetch(SUPABASE_URL + '/storage/v1/object/fiche-images/' + path, {
                            method: 'POST',
                            headers: { 'Content-Type': m.file.type, 'x-upsert': 'true' },
                            body: m.file
                        });
                        if (uploadResp.ok) {
                            var fileUrl = SUPABASE_URL + '/storage/v1/object/public/fiche-images/' + path;
                            await authenticatedFetch(SUPABASE_URL + '/rest/v1/item_media', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                                body: JSON.stringify({
                                    catalogue_item_id: newId,
                                    file_url: fileUrl,
                                    file_type: m.file_type,
                                    tags: m.tags,
                                    sort_order: mi
                                })
                            });
                            // Auto-sync image_url si tag "catalogue"
                            if (mi === 0 || m.tags.indexOf('catalogue') !== -1) {
                                if (m.file_type === 'image' && m.tags.indexOf('catalogue') !== -1) {
                                    await authenticatedFetch(SUPABASE_URL + '/rest/v1/catalogue_items?id=eq.' + encodeURIComponent(newId), {
                                        method: 'PATCH',
                                        headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                                        body: JSON.stringify({ image_url: fileUrl })
                                    });
                                    newItem.image_url = fileUrl;
                                }
                            }
                        }
                    }
                }

                CATALOGUE_DATA.push(newItem);

                // Mettre à jour la row
                const rowId = proposerRowId;
                const row = document.getElementById(rowId);
                if (row) {
                    transformToNormalMode(row, rowId);
                    refreshAllSelects();
                    const select = row.querySelector('.item-select');
                    select.value = newId;
                    updateRow(rowId);
                }

                proposerRowId = null;
                showSaveIndicator();

                // Afficher le message de confirmation
                const statusEl = document.getElementById('propStatus');
                statusEl.style.display = 'block';
                statusEl.className = 'edit-status success';
                statusEl.textContent = 'Votre article a \u00e9t\u00e9 ajout\u00e9 \u00e0 votre soumission mais est en attente d\u2019approbation pour \u00eatre ajout\u00e9 au catalogue officiellement.';
                btn.textContent = 'Enregistr\u00e9!';

                setTimeout(() => {
                    document.getElementById('proposerModal').classList.remove('active');
                }, 3000);
            } catch (e) {
                console.error('Erreur proposition article:', e);
                const statusEl = document.getElementById('propStatus');
                statusEl.style.display = 'block';
                statusEl.className = 'edit-status error';
                statusEl.textContent = 'Erreur lors de la proposition. V\u00e9rifiez votre connexion.';
                btn.disabled = false;
                btn.textContent = 'Enregistrer';
            }
        }

        function refreshAllSelects() {
            // Combobox reads from CATALOGUE_DATA live — no rebuild needed
            // Just sync all displays
            document.querySelectorAll('.calc-row').forEach(function(row) {
                syncComboboxDisplay(row.id);
            });
        }

        function updateRow(rowId) {
            const row = document.getElementById(rowId);
            const select = row.querySelector('.item-select');
            const qtyInput = row.querySelector('.qty-input');
            const totalEl = document.getElementById(`${rowId}-total`);

            const selectedId = select.value;
            const qty = parseFloat(qtyInput.value) || 0;
            const currentMode = row.dataset.mode;

            // Cascade : détecter changement d'article → reset enfants
            var prevCatId = row.dataset.lastCatalogueId || '';
            if (prevCatId && prevCatId !== selectedId && !_cascadeRunning) {
                findCascadeChildren(rowId).forEach(function(c) { removeRow(c.rowId); });
            }
            row.dataset.lastCatalogueId = selectedId;

            if (selectedId === '__PROPOSER__') {
                if (currentMode !== 'proposer') {
                    if (currentMode === 'ajout') transformToNormalMode(row, rowId);
                    transformToProposerMode(row, rowId);
                }
            } else if (selectedId === '__AJOUT__') {
                if (currentMode !== 'ajout') {
                    if (currentMode === 'proposer') transformToNormalMode(row, rowId);
                    transformToAjoutMode(row, rowId);
                }
                const priceInput = document.getElementById(`${rowId}-price`);
                const markupInput = document.getElementById(`${rowId}-markup`);
                if (priceInput && markupInput) {
                    const price = parseFloat(priceInput.value) || 0;
                    const markup = parseFloat(markupInput.value) || 0;
                    totalEl.textContent = formatPrice(price * qty * (1 + markup / 100));
                }
            } else {
                if (currentMode === 'ajout' || currentMode === 'proposer') transformToNormalMode(row, rowId);
                const codeEl = document.getElementById(`${rowId}-code`);
                const typeEl = document.getElementById(`${rowId}-type`);
                const unitPriceEl = document.getElementById(`${rowId}-unit-price`);

                if (selectedId) {
                    const item = CATALOGUE_DATA.find(i => i.id === selectedId);
                    if (item) {
                        const tooltipImg = item.image_url ? `<img class="tooltip-img" src="${escapeAttr(item.image_url)}" alt="">` : '';
                        codeEl.innerHTML = `<span class="tooltip-container">${escapeHtml(item.id)}<div class="tooltip">${tooltipImg}<div class="tooltip-title">${escapeHtml(item.description)}</div><div class="tooltip-text">${escapeHtml(item.instruction || '')}</div></div></span>`;
                        typeEl.textContent = formatType(item.type);

                        // Prix composé si disponible, sinon prix catalogue
                        var installCb = document.getElementById(rowId + '-install');
                        var includeInstall = installCb ? installCb.checked : true;
                        var composedPrice = computeComposedPrice(item, includeInstall);
                        var effectivePrice = composedPrice !== null ? composedPrice : (item.price || 0);
                        unitPriceEl.textContent = formatPrice(effectivePrice);
                        totalEl.textContent = formatPrice(effectivePrice * qty);
                    }
                } else {
                    codeEl.textContent = '—';
                    typeEl.textContent = '—';
                    unitPriceEl.textContent = '—';
                    totalEl.textContent = '0,00 $';
                }
            }

            // Dimensions L×H×P — conditionnel sur item_type === 'fabrication' ou mode ajout
            var dimsEl = document.getElementById(rowId + '-dims');
            if (dimsEl) {
                var showDims = false;
                var dimItem = null;
                if (selectedId === '__AJOUT__') {
                    showDims = true;
                } else if (selectedId && selectedId !== '__PROPOSER__') {
                    dimItem = CATALOGUE_DATA.find(function(i) { return i.id === selectedId; });
                    if (dimItem && dimItem.item_type === 'fabrication') showDims = true;
                }

                if (showDims) {
                    if (dimsEl.classList.contains('dims-hidden')) {
                        dimsEl.classList.remove('dims-hidden');
                        var curL = dimsEl.dataset.l || '';
                        var curH = dimsEl.dataset.h || '';
                        var curP = dimsEl.dataset.p || '';

                        // Lire dims_config du catalogue (null → tout affiché par défaut)
                        var dc = (dimItem && dimItem.dims_config) ? dimItem.dims_config : { l: true, h: true, p: true };

                        var parts = [];
                        if (dc.l) parts.push('<input type="number" id="' + rowId + '-dim-l" placeholder="L" step="0.125" min="0" value="' + curL + '" onchange="updateRow(\'' + rowId + '\')">');
                        if (dc.l && (dc.h || dc.p)) parts.push('<span class="dim-sep">\u00d7</span>');
                        if (dc.h) parts.push('<input type="number" id="' + rowId + '-dim-h" placeholder="H" step="0.125" min="0" value="' + curH + '" onchange="updateRow(\'' + rowId + '\')">');
                        if (dc.h && dc.p) parts.push('<span class="dim-sep">\u00d7</span>');
                        if (dc.p) parts.push('<input type="number" id="' + rowId + '-dim-p" placeholder="P" step="0.125" min="0" value="' + curP + '" onchange="updateRow(\'' + rowId + '\')">');

                        dimsEl.innerHTML = parts.join('');
                    }
                } else {
                    // Sauvegarder les valeurs dans dataset avant de détruire les inputs
                    var lInput = document.getElementById(rowId + '-dim-l');
                    if (lInput) {
                        dimsEl.dataset.l = lInput.value;
                    }
                    var hInput = document.getElementById(rowId + '-dim-h');
                    if (hInput) {
                        dimsEl.dataset.h = hInput.value;
                    }
                    var pInput = document.getElementById(rowId + '-dim-p');
                    if (pInput) {
                        dimsEl.dataset.p = pInput.value;
                    }
                    dimsEl.classList.add('dims-hidden');
                    dimsEl.innerHTML = '\u2014';
                }
            }

            const groupId = row.dataset.group;
            if (groupId) updateGroupSubtotal(groupId);
            updateGrandTotal();

            // Sauvegarder dans Supabase (debounce) — pas en mode proposer
            if (itemMap[rowId] && row.dataset.mode !== 'proposer') {
                debouncedSaveItem(rowId, row);
            }

            // Cascade : déclencher quand dimensions changent ou article sélectionné
            if (!_cascadeRunning && selectedId && selectedId !== '__PROPOSER__' && selectedId !== '__AJOUT__') {
                var hasCascadeRules = false;
                var cascadeCatItem = CATALOGUE_DATA.find(function(i) { return i.id === selectedId; });
                if (cascadeCatItem && cascadeCatItem.calculation_rule_ai && cascadeCatItem.calculation_rule_ai.cascade) {
                    hasCascadeRules = true;
                }
                // Déclencher aussi pour les parents qui ont déjà des enfants
                if (hasCascadeRules || findCascadeChildren(rowId).length > 0) {
                    debouncedCascade(rowId);
                }
            }

            // Sync combobox display
            syncComboboxDisplay(rowId);
        }

        const debouncedSaveItem = debounce(function(rowId, row) {
            if (!itemMap[rowId]) return;
            const select = row.querySelector('.item-select');
            const qtyInput = row.querySelector('.qty-input');
            const selectedId = select ? select.value : '';
            const qty = parseFloat(qtyInput ? qtyInput.value : 0) || 0;

            let fields = { quantity: qty };

            if (selectedId === '__PROPOSER__') return;

            if (selectedId === '__AJOUT__') {
                const descInput = row.querySelector('.ajout-description');
                const priceInput = row.querySelector('.ajout-price');
                const markupInput = row.querySelector('.ajout-markup');
                fields.item_type = 'custom';
                fields.catalogue_item_id = null;
                fields.description = descInput ? descInput.value : '';
                fields.unit_price = parseFloat(priceInput ? priceInput.value : 0) || 0;
                fields.markup = parseFloat(markupInput ? markupInput.value : 0) || 0;
                fields.unit_type = '';
            } else if (selectedId) {
                const item = CATALOGUE_DATA.find(i => i.id === selectedId);
                if (item) {
                    var installCb = document.getElementById(rowId + '-install');
                    var includeInstall = installCb ? installCb.checked : true;
                    var composed = computeComposedPrice(item, includeInstall);
                    fields.item_type = 'catalogue';
                    fields.catalogue_item_id = item.id;
                    fields.description = item.description;
                    fields.unit_type = item.type || '';
                    fields.unit_price = composed !== null ? composed : (item.price || 0);
                    fields.markup = 0;
                }
            } else {
                // Pas de sélection, on sauvegarde quand même la quantité
                fields.item_type = 'catalogue';
                fields.catalogue_item_id = null;
                fields.description = '';
                fields.unit_price = 0;
                fields.markup = 0;
            }

            // Include tag
            var tagInput = document.getElementById(rowId + '-tag');
            if (tagInput) fields.tag = tagInput.value.trim() || null;

            // Dimensions L/H/P
            var dimL = document.getElementById(rowId + '-dim-l');
            var dimH = document.getElementById(rowId + '-dim-h');
            var dimP = document.getElementById(rowId + '-dim-p');
            fields.length_in = dimL ? (parseFloat(dimL.value) || null) : null;
            fields.height_in = dimH ? (parseFloat(dimH.value) || null) : null;
            fields.depth_in = dimP ? (parseFloat(dimP.value) || null) : null;

            updateItem(itemMap[rowId], fields);
            showSaveIndicator();
        }, 500);

        function saveRowTag(rowId) {
            if (!itemMap[rowId]) return;
            var tagInput = document.getElementById(rowId + '-tag');
            var tag = tagInput ? tagInput.value.trim().toUpperCase() : null;
            updateItem(itemMap[rowId], { tag: tag || null });
            showSaveIndicator();
            refreshTagFilterBar();
        }

        function removeRow(rowId) {
            // Supprimer d'abord les enfants cascade (récursif)
            var cascadeChildren = findCascadeChildren(rowId);
            cascadeChildren.forEach(function(c) { removeRow(c.rowId); });

            const row = document.getElementById(rowId);
            if (row) {
                const groupId = row.dataset.group;
                // Supprimer dans Supabase
                if (itemMap[rowId]) {
                    deleteItem(itemMap[rowId]);
                    delete itemMap[rowId];
                }
                row.remove();
                delete cascadeParentMap[rowId];
                if (groupId) updateGroupSubtotal(groupId);
                updateGrandTotal();
            }
        }

        function getRowTotal(row) {
            const select = row.querySelector('.item-select');
            const qtyInput = row.querySelector('.qty-input');
            if (!select || !qtyInput) return 0;
            const selectedId = select.value;
            const qty = parseFloat(qtyInput.value) || 0;

            if (selectedId === '__PROPOSER__') {
                return 0;
            } else if (selectedId === '__AJOUT__') {
                const priceInput = row.querySelector('.ajout-price');
                const markupInput = row.querySelector('.ajout-markup');
                if (priceInput && markupInput) {
                    return (parseFloat(priceInput.value) || 0) * qty * (1 + (parseFloat(markupInput.value) || 0) / 100);
                }
            } else if (selectedId) {
                const item = CATALOGUE_DATA.find(i => i.id === selectedId);
                if (item) {
                    var installCb = document.getElementById(row.id + '-install');
                    var includeInstall = installCb ? installCb.checked : true;
                    var composed = computeComposedPrice(item, includeInstall);
                    var eff = composed !== null ? composed : (item.price || 0);
                    return eff * qty;
                }
            }
            return 0;
        }

        function updateGroupSubtotal(groupId) {
            let subtotal = 0;
            const container = document.getElementById(`${groupId}-rows`);
            if (!container) return;
            container.querySelectorAll('.calc-row').forEach(row => { subtotal += getRowTotal(row); });
            const subtotalEl = document.getElementById(`${groupId}-subtotal`);
            if (subtotalEl) animateValue(subtotalEl, subtotal, 'price');
        }

        function updateGrandTotal() {
            let total = 0;
            document.querySelectorAll('.calc-row').forEach(row => { total += getRowTotal(row); });
            var grandEl = document.getElementById('grandTotal');
            if (grandEl) animateValue(grandEl, total, 'price');
            var headerEl = document.getElementById('headerTotal');
            if (headerEl) animateValue(headerEl, total, 'currency');
        }

        function calculerGrandTotal() {
            let total = 0;
            document.querySelectorAll('.calc-row').forEach(row => { total += getRowTotal(row); });
            return Math.round(total * 100) / 100;
        }

        function updateHeaderTotal() {
            var el = document.getElementById('headerTotal');
            if (!el) return;
            var total = calculerGrandTotal();
            el.textContent = total.toLocaleString('fr-CA', { style: 'currency', currency: 'CAD' });
        }

        // ── Animated value interpolation ──
        function _formatAnimPrice(val) {
            // Always format as currency during animation (bypass formatPrice % detection)
            return val.toLocaleString('fr-CA', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' $';
        }
        function animateValue(el, targetVal, mode) {
            // Parse current displayed value — handle fr-CA formatting (spaces, commas)
            var currentText = el.textContent.replace(/[^0-9.,-]/g, '').replace(/\u00a0/g, '').replace(',', '.');
            var fromVal = parseFloat(currentText) || 0;
            targetVal = Math.round(targetVal * 100) / 100;
            if (Math.abs(fromVal - targetVal) < 0.01) {
                if (mode === 'currency') el.textContent = targetVal.toLocaleString('fr-CA', { style: 'currency', currency: 'CAD' });
                else el.textContent = formatPrice(targetVal);
                return;
            }
            if (el._animId) cancelAnimationFrame(el._animId);
            var duration = 500;
            var start = performance.now();
            function tick(now) {
                var t = Math.min((now - start) / duration, 1);
                var ease = 1 - Math.pow(1 - t, 3);
                var val = fromVal + (targetVal - fromVal) * ease;
                if (t >= 1) {
                    // Final frame — use canonical formatters
                    if (mode === 'currency') el.textContent = targetVal.toLocaleString('fr-CA', { style: 'currency', currency: 'CAD' });
                    else el.textContent = formatPrice(targetVal);
                    el._animId = null;
                } else {
                    // Intermediate — always format as dollar amount
                    if (mode === 'currency') el.textContent = val.toLocaleString('fr-CA', { style: 'currency', currency: 'CAD' });
                    else el.textContent = _formatAnimPrice(val);
                    el._animId = requestAnimationFrame(tick);
                }
            }
            el._animId = requestAnimationFrame(tick);
        }

        // ── Pulse on totals after batch insert ──
        function pulseTotals() {
            ['grandTotal', 'headerTotal'].forEach(function(id) {
                var el = document.getElementById(id);
                if (!el) return;
                el.classList.remove('total-pulse');
                void el.offsetWidth; // force reflow to restart animation
                el.classList.add('total-pulse');
                el.addEventListener('animationend', function handler() {
                    el.classList.remove('total-pulse');
                    el.removeEventListener('animationend', handler);
                }, { once: true });
            });
        }

        // ═══════════════════════════════════════════════════════════════════════
        // TAG FILTER — SHOW/HIDE ROWS BY TAG PREFIX
        // ═══════════════════════════════════════════════════════════════════════

        var activeTagFilter = null; // null = show all

        function refreshTagFilterBar() {
            var bar = document.getElementById('tagFilterBar');
            if (!bar) return;
            // Collect all unique tags and prefixes in use
            var usedPrefixes = {};
            var usedTags = {};
            document.querySelectorAll('.calc-row').forEach(function(row) {
                var tagInput = row.querySelector('.cell-tag input');
                if (tagInput && tagInput.value.trim()) {
                    var tag = tagInput.value.trim().toUpperCase();
                    var prefix = tag.replace(/[0-9]/g, '');
                    if (prefix) {
                        usedPrefixes[prefix] = true;
                        usedTags[tag] = prefix;
                    }
                }
            });
            var prefixList = Object.keys(usedPrefixes).sort();
            if (prefixList.length === 0) {
                bar.style.display = 'none';
                return;
            }
            bar.style.display = 'flex';
            var isExactFilter = activeTagFilter && /[0-9]/.test(activeTagFilter);
            var activePrefixFromExact = isExactFilter ? activeTagFilter.replace(/[0-9]/g, '') : null;

            // Rebuild chips
            var html = '<span class="tag-filter-label">Filtrer :</span>';
            html += '<span class="tag-filter-chip chip-all' + (activeTagFilter === null ? ' active' : '') + '" onclick="filterByTag(null)">Tous</span>';
            prefixList.forEach(function(p) {
                var tp = (tagPrefixes || []).find(function(t) { return t.prefix === p; });
                var label = tp ? p + ' ' + tp.label_fr : p;
                var isActivePrefix = activeTagFilter === p || activePrefixFromExact === p;
                html += '<span class="tag-filter-chip' + (isActivePrefix ? ' active' : '') + '" onclick="filterByTag(\'' + escapeAttr(p) + '\')">' + escapeHtml(label) + '</span>';
            });

            // Show granular tags for the active prefix
            var activePrefix = activeTagFilter ? activeTagFilter.replace(/[0-9]/g, '') : null;
            if (activePrefix && usedPrefixes[activePrefix]) {
                var tagsForPrefix = Object.keys(usedTags).filter(function(t) { return usedTags[t] === activePrefix; }).sort(function(a, b) {
                    return a.localeCompare(b, 'fr', { numeric: true });
                });
                if (tagsForPrefix.length > 1) {
                    html += '<span style="color:#ccc;margin:0 2px;">|</span>';
                    tagsForPrefix.forEach(function(tag) {
                        html += '<span class="tag-filter-chip' + (activeTagFilter === tag ? ' active' : '') + '" onclick="filterByTag(\'' + escapeAttr(tag) + '\')" style="font-size:10px;padding:3px 8px;">' + escapeHtml(tag) + '</span>';
                    });
                }
            }
            bar.innerHTML = html;
        }

        function filterByTag(value) {
            // value = null (all), "C" (prefix), or "C1" (exact tag)
            activeTagFilter = value;
            document.querySelectorAll('.calc-row').forEach(function(row) {
                if (value === null) {
                    row.classList.remove('tag-hidden');
                    return;
                }
                var tagInput = row.querySelector('.cell-tag input');
                var tag = tagInput ? tagInput.value.trim().toUpperCase() : '';
                var rowPrefix = tag.replace(/[0-9]/g, '');
                // Check exact match (C1) or prefix match (C)
                var isExact = /[0-9]/.test(value);
                if (isExact) {
                    row.classList.toggle('tag-hidden', tag !== value && tag !== '');
                } else {
                    row.classList.toggle('tag-hidden', rowPrefix !== value && tag !== '');
                }
            });
            refreshTagFilterBar();
        }

        // ═══════════════════════════════════════════════════════════════════════
        // SORT ROWS IN GROUP
        // ═══════════════════════════════════════════════════════════════════════

        var sortState = {}; // { groupId: { col: 'tag', dir: 'asc' } }

        function sortGroupRows(groupId, col) {
            var prev = sortState[groupId] || {};
            var dir = (prev.col === col && prev.dir === 'asc') ? 'desc' : 'asc';
            sortState[groupId] = { col: col, dir: dir };

            var container = document.getElementById(groupId + '-rows');
            if (!container) return;
            var rows = Array.from(container.querySelectorAll('.calc-row'));
            var addRowBtn = container.querySelector('.add-row-container');

            rows.sort(function(a, b) {
                var va = getRowSortValue(a, col);
                var vb = getRowSortValue(b, col);
                var cmp;
                if (typeof va === 'number' && typeof vb === 'number') {
                    cmp = va - vb;
                } else {
                    cmp = String(va).localeCompare(String(vb), 'fr', { numeric: true });
                }
                return dir === 'desc' ? -cmp : cmp;
            });

            // Re-append in sorted order
            rows.forEach(function(row) { container.insertBefore(row, addRowBtn); });

            // Update sort arrows in the header
            var header = container.parentElement.querySelector('.calc-header');
            if (header) {
                header.querySelectorAll('.sortable').forEach(function(span) {
                    span.classList.remove('sort-active');
                    var arrow = span.querySelector('.sort-arrow');
                    if (arrow) arrow.innerHTML = '&#9650;';
                });
                // Find the clicked column's span
                var colMap = { tag: 1, article: 2, price: 5, qty: 6, total: 8 };
                var idx = colMap[col];
                if (idx !== undefined) {
                    var target = header.querySelectorAll('span')[idx];
                    if (target) {
                        target.classList.add('sort-active');
                        var arrow = target.querySelector('.sort-arrow');
                        if (arrow) arrow.innerHTML = dir === 'asc' ? '&#9650;' : '&#9660;';
                    }
                }
            }
        }

        function getRowSortValue(row, col) {
            if (col === 'tag') {
                var tagInput = row.querySelector('.cell-tag input');
                return tagInput ? tagInput.value.trim().toUpperCase() : '';
            }
            if (col === 'article') {
                var select = row.querySelector('.item-select');
                if (!select) return '';
                var opt = select.options[select.selectedIndex];
                return opt ? opt.textContent.trim() : '';
            }
            if (col === 'price') {
                var priceSpan = row.querySelector('[id$="-unit-price"]');
                if (priceSpan) return parseFloat(priceSpan.textContent.replace(/[^\d.,-]/g, '').replace(',', '.')) || 0;
                var ajoutPrice = row.querySelector('.ajout-price');
                if (ajoutPrice) return parseFloat(ajoutPrice.value) || 0;
                return 0;
            }
            if (col === 'qty') {
                var qtyInput = row.querySelector('.qty-input');
                return qtyInput ? (parseFloat(qtyInput.value) || 0) : 0;
            }
            if (col === 'total') {
                var totalSpan = row.querySelector('[id$="-total"]');
                if (totalSpan) return parseFloat(totalSpan.textContent.replace(/[^\d.,-]/g, '').replace(',', '.')) || 0;
                return 0;
            }
            return '';
        }

        // ═══════════════════════════════════════════════════════════════════════
        // MODAL ENVOI
        // ═══════════════════════════════════════════════════════════════════════

        function openSubmitModal() {
            if (!currentSubmission) return;
            var s = currentSubmission.status;
            if (s !== 'draft' && s !== 'returned') {
                steleAlert('Cette soumission ne peut pas \u00eatre soumise (statut: ' + (STATUS_LABELS[s] || s) + ').');
                return;
            }
            const rows = document.querySelectorAll('.calc-row');
            if (rows.length === 0) {
                steleAlert('Veuillez ajouter au moins un article au calculateur.');
                return;
            }
            document.getElementById('projectDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('projectDescription').value = '';
            // Titre du modal adapté
            document.getElementById('submitModalTitle').textContent = 'Soumettre la soumission #' + currentSubmission.submission_number;
            document.getElementById('btnSend').textContent = 'Soumettre';
            document.getElementById('sendStatus').style.display = 'none';
            document.getElementById('pdfModal').classList.add('active');
        }

        // Legacy alias
        function openPdfModal() { openSubmitModal(); }

        function closePdfModal() {
            document.getElementById('pdfModal').classList.remove('active');
        }

        document.addEventListener('click', function(e) {
            if (e.target === document.getElementById('pdfModal')) closePdfModal();
            if (e.target === document.getElementById('proposerModal')) closeProposerModal();
        });

        // ═══════════════════════════════════════════════════════════════════════
        // GESTION DES IMAGES
        // ═══════════════════════════════════════════════════════════════════════

        // ── Chargement dynamique des librairies ──
        var cropperLoaded = false;
        var pdfJsLoaded = false;
        var currentCropper = null;
        var cropState = {}; // { groupId, originalBlob, existingMediaId, ratio }

        function loadCropperLib() {
            if (cropperLoaded) return Promise.resolve();
            return new Promise(function(resolve, reject) {
                var link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = 'https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.css';
                document.head.appendChild(link);
                var script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.js';
                script.onload = function() { cropperLoaded = true; resolve(); };
                script.onerror = function() { reject(new Error('Impossible de charger Cropper.js')); };
                document.head.appendChild(script);
            });
        }

        function loadPdfLib() {
            if (pdfJsLoaded) return Promise.resolve();
            return new Promise(function(resolve, reject) {
                var script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
                script.onload = function() {
                    window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                    pdfJsLoaded = true;
                    resolve();
                };
                script.onerror = function() { reject(new Error('Impossible de charger pdf.js')); };
                document.head.appendChild(script);
            });
        }

        function convertPdfToImage(file) {
            return new Promise(function(resolve, reject) {
                var reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        var pdf = await window.pdfjsLib.getDocument({ data: new Uint8Array(e.target.result) }).promise;
                        var page = await pdf.getPage(1);
                        var scale = 300 / 72; // 300 DPI
                        var viewport = page.getViewport({ scale: scale });
                        var canvas = document.createElement('canvas');
                        canvas.width = viewport.width;
                        canvas.height = viewport.height;
                        await page.render({ canvasContext: canvas.getContext('2d'), viewport: viewport }).promise;
                        canvas.toBlob(function(blob) {
                            resolve(blob);
                        }, 'image/jpeg', 0.92);
                    } catch (err) {
                        reject(err);
                    }
                };
                reader.readAsArrayBuffer(file);
            });
        }

        // ── Crop Modal ──
        function openCropModal(imageBlob, groupId, existingMediaId) {
            cropState = { groupId: groupId, originalBlob: imageBlob, existingMediaId: existingMediaId || null, ratio: '16:9' };
            var url = URL.createObjectURL(imageBlob);
            var imgEl = document.getElementById('cropImage');
            var modal = document.getElementById('cropModal');
            var errEl = document.getElementById('cropError');
            errEl.style.display = 'none';

            // Check dimensions
            var testImg = new Image();
            testImg.onload = async function() {
                document.getElementById('cropDimensions').textContent = testImg.width + ' × ' + testImg.height + ' px';
                if (testImg.width < 800 || testImg.height < 600) {
                    errEl.textContent = 'Image trop petite pour une présentation professionnelle (minimum 800×600). Celle-ci fait ' + testImg.width + '×' + testImg.height + '.';
                    errEl.style.display = 'block';
                    imgEl.src = url;
                    modal.classList.add('active');
                    document.getElementById('cropConfirmBtn').disabled = true;
                    return;
                }
                document.getElementById('cropConfirmBtn').disabled = false;
                imgEl.src = url;
                modal.classList.add('active');

                await loadCropperLib();
                if (currentCropper) { currentCropper.destroy(); currentCropper = null; }
                currentCropper = new Cropper(imgEl, {
                    aspectRatio: 16 / 9,
                    viewMode: 1,
                    autoCropArea: 0.9,
                    responsive: true,
                    background: false
                });
                // Reset ratio buttons
                document.getElementById('cropRatio169').classList.add('active');
                document.getElementById('cropRatio916').classList.remove('active');
                document.getElementById('cropRatio11').classList.remove('active');
            };
            testImg.src = url;
        }

        function setCropRatio(ratio) {
            cropState.ratio = ratio;
            document.getElementById('cropRatio169').classList.toggle('active', ratio === '16:9');
            document.getElementById('cropRatio916').classList.toggle('active', ratio === '9:16');
            document.getElementById('cropRatio11').classList.toggle('active', ratio === '1:1');
            var numRatio = ratio === '1:1' ? 1 : ratio === '9:16' ? 9 / 16 : 16 / 9;
            if (currentCropper) {
                currentCropper.setAspectRatio(numRatio);
            }
        }

        async function confirmCrop() {
            if (!currentCropper) return;
            var confirmBtn = document.getElementById('cropConfirmBtn');
            confirmBtn.disabled = true;
            confirmBtn.textContent = 'Upload...';

            try {
                var croppedCanvas = currentCropper.getCroppedCanvas({ maxWidth: 2048, maxHeight: 2048, imageSmoothingQuality: 'high' });
                var cropData = currentCropper.getData(true); // rounded
                var croppedBlob = await new Promise(function(resolve) {
                    croppedCanvas.toBlob(function(b) { resolve(b); }, 'image/jpeg', 0.88);
                });

                await uploadToStorage(cropState.originalBlob, croppedBlob, cropState.groupId, cropState.ratio, cropData, cropState.existingMediaId, cropState.sourceMetadata);
                closeCropModal();
            } catch (err) {
                console.error('Crop/upload error:', err);
                alert('Erreur lors de l\'upload : ' + err.message);
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Valider';
            }
        }

        function cancelCrop() {
            closeCropModal();
        }

        function closeCropModal() {
            var modal = document.getElementById('cropModal');
            modal.classList.remove('active');
            if (currentCropper) { currentCropper.destroy(); currentCropper = null; }
            var imgEl = document.getElementById('cropImage');
            if (imgEl.src.startsWith('blob:')) URL.revokeObjectURL(imgEl.src);
            imgEl.src = '';
            var resolve = cropState._resolve;
            cropState = {};
            if (resolve) resolve(); // continue to next image in queue
        }

        // ── Upload vers Supabase Storage + insert room_media ──
        async function uploadToStorage(originalBlob, croppedBlob, groupId, ratio, cropData, existingMediaId, sourceMetadata) {
            var roomId = roomMap[groupId];
            if (!roomId) throw new Error('Room non sauvegardée');
            var ts = Date.now();

            // Upload original (skip if recrop — original already exists)
            var originalUrl;
            if (existingMediaId) {
                // Recrop: find existing media to get original URL
                var existing = (groupImages[groupId] || []).find(function(img) { return img.mediaId === existingMediaId; });
                originalUrl = existing ? existing.originalUrl : null;
                if (!originalUrl) throw new Error('Original introuvable');
            } else {
                var origPath = 'originals/' + roomId + '/' + ts + '.jpg';
                var origResp = await authenticatedFetch(SUPABASE_URL + '/storage/v1/object/room-images/' + origPath, {
                    method: 'POST',
                    headers: { 'Content-Type': 'image/jpeg', 'x-upsert': 'true' },
                    body: originalBlob
                });
                if (!origResp.ok) throw new Error('Upload original échoué: ' + origResp.status);
                originalUrl = SUPABASE_URL + '/storage/v1/object/public/room-images/' + origPath;
            }

            // Upload cropped
            var cropPath = 'cropped/' + roomId + '/' + ts + '_' + ratio.replace(':', 'x') + '.jpg';
            var cropResp = await authenticatedFetch(SUPABASE_URL + '/storage/v1/object/room-images/' + cropPath, {
                method: 'POST',
                headers: { 'Content-Type': 'image/jpeg', 'x-upsert': 'true' },
                body: croppedBlob
            });
            if (!cropResp.ok) throw new Error('Upload crop échoué: ' + cropResp.status);
            var croppedUrl = SUPABASE_URL + '/storage/v1/object/public/room-images/' + cropPath;

            if (existingMediaId) {
                // Recrop: update existing record
                var oldMedia = (groupImages[groupId] || []).find(function(img) { return img.mediaId === existingMediaId; });
                // Delete old cropped file
                if (oldMedia && oldMedia.url) {
                    var oldPath = oldMedia.url.split('/room-images/')[1];
                    if (oldPath) {
                        authenticatedFetch(SUPABASE_URL + '/storage/v1/object/room-images/' + oldPath, { method: 'DELETE' }).catch(function() {});
                    }
                }
                await authenticatedFetch(SUPABASE_URL + '/rest/v1/room_media?id=eq.' + existingMediaId, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                    body: JSON.stringify({ cropped_url: croppedUrl, crop_ratio: ratio, crop_data: cropData })
                });
                // Update in memory
                if (oldMedia) { oldMedia.url = croppedUrl; oldMedia.cropRatio = ratio; }
            } else {
                // New image: insert record
                var sortOrder = (groupImages[groupId] || []).length;
                var insResp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/room_media', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                    body: JSON.stringify(Object.assign({
                        room_id: roomId,
                        original_url: originalUrl,
                        cropped_url: croppedUrl,
                        crop_ratio: ratio,
                        crop_data: cropData,
                        tags: ['presentation_soumission'],
                        sort_order: sortOrder
                    }, sourceMetadata ? { source_metadata: sourceMetadata } : {}))
                });
                if (!insResp.ok) throw new Error('Insert room_media échoué: ' + insResp.status);
                var inserted = await insResp.json();
                var mediaId = Array.isArray(inserted) ? inserted[0].id : inserted.id;

                if (!groupImages[groupId]) groupImages[groupId] = [];
                groupImages[groupId].push({
                    name: 'photo_' + ts + '.jpg',
                    url: croppedUrl,
                    originalUrl: originalUrl,
                    mediaId: mediaId,
                    tags: ['presentation_soumission'],
                    cropRatio: ratio,
                    isLegacy: false,
                    showInQuote: true,
                    annotations: []
                });
            }

            renderGroupImagePreviews(groupId);
            showSaveIndicator();
        }

        // ── Recrop depuis l'original ──
        async function recropImage(groupId, index) {
            if (currentSubmission && !isSubmissionCurrentlyEditable()) return;
            var img = (groupImages[groupId] || [])[index];
            if (!img || img.isLegacy || !img.originalUrl) return;
            try {
                var resp = await fetch(img.originalUrl);
                if (!resp.ok) throw new Error('Fetch original failed');
                var blob = await resp.blob();
                openCropModal(blob, groupId, img.mediaId);
            } catch (err) {
                console.error('Recrop error:', err);
                alert('Impossible de charger l\'image originale.');
            }
        }

        function compressImage(file, maxWidth, quality) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        if (w > maxWidth) { h = Math.round(h * maxWidth / w); w = maxWidth; }
                        canvas.width = w; canvas.height = h;
                        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // ═══════════════════════════════════════════════════════════════════════
        // IMAGES PAR MEUBLE (dans le calculateur)
        // ═══════════════════════════════════════════════════════════════════════

        function setupGroupImageHandlers(groupId) {
            const dropZone = document.getElementById(`${groupId}-imgDrop`);
            const fileInput = document.getElementById(`${groupId}-imgInput`);
            if (!dropZone || !fileInput) return;

            dropZone.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => { handleGroupImageFiles(groupId, e.target.files); fileInput.value = ''; });

            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
            dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('dragover'); });
            dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); handleGroupImageFiles(groupId, e.dataTransfer.files); });

            // Paste: écouter sur le groupe entier
            const groupEl = document.getElementById(groupId);
            groupEl.addEventListener('paste', (e) => {
                const files = [];
                for (let i = 0; i < e.clipboardData.items.length; i++) {
                    if (e.clipboardData.items[i].type.startsWith('image/')) files.push(e.clipboardData.items[i].getAsFile());
                }
                if (files.length > 0) { e.preventDefault(); e.stopPropagation(); handleGroupImageFiles(groupId, files); }
            });
        }

        async function handleGroupImageFiles(groupId, files) {
            // Guard: bloquer si soumission verrouillée
            if (currentSubmission && !isSubmissionCurrentlyEditable()) {
                steleAlert('Soumission verrouillée — impossible d\'ajouter des images.');
                return;
            }
            if (!groupImages[groupId]) groupImages[groupId] = [];
            var remaining = MAX_GROUP_IMAGES - groupImages[groupId].length;
            if (remaining <= 0) { alert('Maximum ' + MAX_GROUP_IMAGES + ' images atteint.'); return; }

            var validFiles = Array.from(files).slice(0, remaining);
            // Process one at a time (crop modal is sequential)
            for (var i = 0; i < validFiles.length; i++) {
                var file = validFiles[i];
                var blob;

                if (file.type === 'application/pdf') {
                    // PDF → image conversion
                    try {
                        await loadPdfLib();
                        blob = await convertPdfToImage(file);
                    } catch (err) {
                        console.error('PDF conversion error:', err);
                        alert('Erreur de conversion PDF : ' + err.message);
                        continue;
                    }
                } else if (file.type.startsWith('image/')) {
                    blob = file;
                } else {
                    continue; // skip unsupported
                }

                // Open crop modal (awaits user action)
                await new Promise(function(resolve) {
                    openCropModal(blob, groupId, null);
                    cropState._resolve = resolve; // must be after openCropModal which resets cropState
                });
            }
        }

        function renderGroupImagePreviews(groupId) {
            const container = document.getElementById(`${groupId}-imgPreviews`);
            const countEl = document.getElementById(`${groupId}-imgCount`);
            const dropZone = document.getElementById(`${groupId}-imgDrop`);
            if (!container) return;

            const imgs = groupImages[groupId] || [];
            container.innerHTML = '';
            imgs.forEach((img, index) => {
                const item = document.createElement('div');
                item.className = 'image-preview-item';
                var imgSrc = img.isLegacy ? img.dataUrl : (img.url || img.dataUrl);
                var checkedAttr = img.showInQuote ? 'checked' : '';
                var canRecrop = !img.isLegacy && img.originalUrl && isSubmissionCurrentlyEditable();
                var recropAttr = canRecrop ? ` onclick="recropImage('${escapeAttr(groupId)}', ${index})" style="cursor:pointer;" title="Cliquer pour recadrer"` : ` ondblclick="openLightbox(this.src)" title="Double-cliquer pour agrandir"`;
                var aiChecked = img.aiReference ? 'checked' : '';
                var annotCount = (img.annotations || []).length;
                var canAnnot = !img.isLegacy && img.mediaId;
                var annotEl = '';
                if (canAnnot && annotCount > 0) {
                    annotEl = `<span class="annotation-badge" onclick="event.stopPropagation();openAnnotationModal('${escapeAttr(groupId)}', ${index})" style="cursor:pointer;" title="${annotCount} tag(s) — cliquer pour annoter">${annotCount}</span>`;
                } else if (canAnnot) {
                    annotEl = `<button class="annotation-btn" onclick="event.stopPropagation();openAnnotationModal('${escapeAttr(groupId)}', ${index})" title="Annoter">&#9998;</button>`;
                }
                item.innerHTML = `<img src="${imgSrc}" alt="${escapeAttr(img.name)}"${recropAttr}>${annotEl}<button class="image-preview-remove" onclick="removeGroupImage('${escapeAttr(groupId)}', ${index})" title="Supprimer">&times;</button><label class="image-quote-toggle" title="Afficher dans la soumission client"><input type="checkbox" ${checkedAttr} onchange="toggleImageShowInQuote('${escapeAttr(groupId)}', ${index}, this.checked)"><span>Client</span></label><label class="image-ai-toggle" title="Envoyer comme r\u00e9f\u00e9rence \u00e0 l'AI"><input type="checkbox" ${aiChecked} onchange="toggleImageAiRef('${escapeAttr(groupId)}', ${index}, this.checked)"><span>AI</span></label>`;
                container.appendChild(item);
            });
            if (countEl) countEl.textContent = imgs.length > 0 ? imgs.length + ' / ' + MAX_GROUP_IMAGES + ' image(s)' : '';
            if (dropZone) dropZone.style.display = imgs.length >= MAX_GROUP_IMAGES ? 'none' : '';
        }

        async function removeGroupImage(groupId, index) {
            if (!groupImages[groupId]) return;
            var img = groupImages[groupId][index];
            if (!img) return;

            // Guard: bloquer si soumission verrouillée
            if (currentSubmission && !isSubmissionCurrentlyEditable()) {
                steleAlert('Soumission verrouillée — impossible de supprimer des images.');
                return;
            }
            // Confirmation avant suppression
            if (!(await steleConfirm('Supprimer cette image ?', 'Supprimer'))) return;

            if (!img.isLegacy && img.mediaId) {
                // Delete from room_media table
                try {
                    await authenticatedFetch(SUPABASE_URL + '/rest/v1/room_media?id=eq.' + img.mediaId, { method: 'DELETE' });
                } catch (e) { console.error('Delete room_media error:', e); }
                // Delete files from Storage (best effort)
                try {
                    if (img.url) {
                        var croppedPath = img.url.split('/room-images/')[1];
                        if (croppedPath) authenticatedFetch(SUPABASE_URL + '/storage/v1/object/room-images/' + croppedPath, { method: 'DELETE' }).catch(function(){});
                    }
                    if (img.originalUrl) {
                        var origPath = img.originalUrl.split('/room-images/')[1];
                        if (origPath) authenticatedFetch(SUPABASE_URL + '/storage/v1/object/room-images/' + origPath, { method: 'DELETE' }).catch(function(){});
                    }
                } catch (e) { console.error('Delete storage files error:', e); }
            }

            groupImages[groupId].splice(index, 1);
            renderGroupImagePreviews(groupId);
            // Only save to JSONB if there are legacy images
            if (img.isLegacy) saveGroupImages(groupId);
            showSaveIndicator();
        }

        const debouncedSaveGroupImages = debounce(function(groupId) {
            if (!roomMap[groupId]) return;
            // Only save legacy (Base64) images to JSONB — new images are in room_media table
            const legacyImgs = (groupImages[groupId] || []).filter(img => img.isLegacy);
            const imgs = legacyImgs.map(img => ({ name: img.name, dataUrl: img.dataUrl, showInQuote: !!img.showInQuote }));
            updateRoom(roomMap[groupId], { images: imgs });
            showSaveIndicator();
        }, 1000);

        function saveGroupImages(groupId) {
            debouncedSaveGroupImages(groupId);
        }

        function saveExclusions() {
            if (!currentSubmission) return;
            var el = document.getElementById('exclusionsText');
            if (!el) return;
            updateSubmission(currentSubmission.id, { exclusions: el.value }).catch(function(e) { console.error('Save exclusions:', e); });
            showSaveIndicator();
        }

        function saveClientDescription(groupId) {
            if (!roomMap[groupId]) return;
            var textarea = document.getElementById(groupId + '-clientDesc');
            if (!textarea) return;
            // Plain text from calculator — clear HTML cache + stale EN
            roomDescHTML[groupId] = '';
            if (roomDescEN[groupId]) {
                roomDescEN[groupId] = '';
                updateRoom(roomMap[groupId], { client_description: textarea.value, client_description_en: '' });
            } else {
                updateRoom(roomMap[groupId], { client_description: textarea.value });
            }
            showSaveIndicator();
        }

        async function toggleImageShowInQuote(groupId, index, checked) {
            if (!groupImages[groupId] || !groupImages[groupId][index]) return;
            var img = groupImages[groupId][index];
            img.showInQuote = checked;

            if (!img.isLegacy && img.mediaId) {
                // Update tags in room_media
                var newTags = checked
                    ? Array.from(new Set((img.tags || []).concat(['presentation_soumission'])))
                    : (img.tags || []).filter(function(t) { return t !== 'presentation_soumission'; });
                img.tags = newTags;
                try {
                    await authenticatedFetch(SUPABASE_URL + '/rest/v1/room_media?id=eq.' + img.mediaId, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                        body: JSON.stringify({ tags: newTags })
                    });
                } catch (e) { console.error('Update room_media tags error:', e); }
                showSaveIndicator();
            } else {
                saveGroupImages(groupId);
            }
        }

        async function toggleImageAiRef(groupId, index, checked) {
            if (!groupImages[groupId] || !groupImages[groupId][index]) return;
            var img = groupImages[groupId][index];
            img.aiReference = checked;

            if (!img.isLegacy && img.mediaId) {
                var newTags = checked
                    ? Array.from(new Set((img.tags || []).concat(['ai_reference'])))
                    : (img.tags || []).filter(function(t) { return t !== 'ai_reference'; });
                img.tags = newTags;
                try {
                    await authenticatedFetch(SUPABASE_URL + '/rest/v1/room_media?id=eq.' + img.mediaId, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                        body: JSON.stringify({ tags: newTags })
                    });
                } catch (e) { console.error('Update room_media AI tag error:', e); }
                showSaveIndicator();
            } else {
                saveGroupImages(groupId);
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // ENVOI DE L'ESTIMATION
        // ═══════════════════════════════════════════════════════════════════════

        function collecterDonneesCalculateur() {
            const groups = document.querySelectorAll('.furniture-group');
            const meubles = [];
            let grandTotal = 0;

            groups.forEach(group => {
                const nameInput = group.querySelector('.furniture-name-input');
                const meubleName = nameInput ? (nameInput.value.trim() || 'Sans nom') : 'Sans nom';
                const items = [];
                let subtotal = 0;

                group.querySelectorAll('.calc-row').forEach(row => {
                    const select = row.querySelector('.item-select');
                    const qtyInput = row.querySelector('.qty-input');
                    if (!select || !qtyInput || !select.value) return;

                    const selectedId = select.value;
                    const qty = parseFloat(qtyInput.value) || 0;

                    if (selectedId === '__AJOUT__') {
                        const descInput = row.querySelector('.ajout-description');
                        const priceInput = row.querySelector('.ajout-price');
                        const markupInput = row.querySelector('.ajout-markup');
                        if (descInput && priceInput && markupInput) {
                            const price = parseFloat(priceInput.value) || 0;
                            const markup = parseFloat(markupInput.value) || 0;
                            const lineTotal = price * qty * (1 + markup / 100);
                            subtotal += lineTotal;
                            items.push({ type: 'ajout', description: descInput.value || 'Ajout sans description', unitPrice: formatPrice(price), qty: qty, markup: markup, lineTotal: formatPrice(lineTotal) });
                        }
                    } else {
                        const item = CATALOGUE_DATA.find(i => i.id === selectedId);
                        if (item) {
                            const lineTotal = (item.price || 0) * qty;
                            subtotal += lineTotal;
                            items.push({ type: 'catalogue', code: item.id, description: item.description, itemType: item.type, unitPrice: formatPrice(item.price), qty: qty, lineTotal: formatPrice(lineTotal) });
                        }
                    }
                });

                if (items.length > 0) {
                    grandTotal += subtotal;
                    const groupId = group.id;
                    const imgs = (groupImages[groupId] || []).map(img => ({
                        name: img.name,
                        mimeType: img.dataUrl ? (img.dataUrl.match(/^data:(.*?);/)?.[1] || 'image/jpeg') : 'image/jpeg',
                        data: img.dataUrl ? img.dataUrl.split(',')[1] : null,
                        url: img.url || null
                    }));
                    meubles.push({ name: meubleName, items: items, subtotal: formatPrice(subtotal), images: imgs });
                }
            });

            var result = { meubles: meubles, total: formatPrice(grandTotal) };
            if (currentSubmission) {
                result.submissionNumber = currentSubmission.submission_number;
                result.submissionTitle = currentSubmission.title;
                result.clauses = currentSubmission.clauses || [];
                result.status = currentSubmission.status;
                result.approvedTotal = currentSubmission.approved_total;
            }
            if (currentProject) {
                result.projectName = currentProject.name;
                result.clientName = currentProject.client_name;
                result.clientEmail = currentProject.client_email;
                result.clientAddress = currentProject.client_address;
                result.designer = currentProject.designer;
            }
            // Descriptions client + installation + media URLs par room
            var allGroups = document.querySelectorAll('.furniture-group');
            var mIdx = 0;
            allGroups.forEach(function(group) {
                // Only match groups that produced a meuble (items.length > 0)
                var rows = group.querySelectorAll('.calc-row');
                var hasItems = false;
                rows.forEach(function(row) {
                    var sel = row.querySelector('.item-select');
                    if (sel && sel.value) hasItems = true;
                });
                if (!hasItems) return;
                if (mIdx >= result.meubles.length) return;
                var textarea = group.querySelector('.client-desc-textarea');
                if (textarea) result.meubles[mIdx].clientDescription = textarea.value || '';
                var instCheckbox = group.querySelector('.install-toggle');
                if (instCheckbox) result.meubles[mIdx].installationIncluded = instCheckbox.checked;
                var groupId = group.id;
                result.meubles[mIdx].mediaUrls = (groupImages[groupId] || []).map(function(img) {
                    return { url: img.url || null, originalUrl: img.originalUrl || null, mediaId: img.mediaId || null, cropRatio: img.cropRatio || null, name: img.name };
                });
                mIdx++;
            });
            return result;
        }

        function showSendStatus(message, isError) {
            const statusEl = document.getElementById('sendStatus');
            statusEl.style.display = 'block';
            statusEl.textContent = message;
            statusEl.style.background = isError ? '#ffebee' : '#e8f5e9';
            statusEl.style.color = isError ? '#c62828' : '#2e7d32';
        }

        async function soumettreSoumission() {
            if (!currentSubmission) return;

            const projectDate = document.getElementById('projectDate').value;
            const projectDescription = document.getElementById('projectDescription').value.trim();

            const { meubles, total } = collecterDonneesCalculateur();
            if (meubles.length === 0) { showSendStatus('Aucun article \u00e0 soumettre.', true); return; }

            const btnSend = document.getElementById('btnSend');
            btnSend.disabled = true;
            btnSend.textContent = 'Soumission en cours...';
            showSendStatus('Soumission en cours...', false);

            try {
                // Cr\u00e9er un snapshot avec les notes du modal
                await createVersion(currentSubmission.id);

                // Sauvegarder les notes sur le projet
                if (projectDescription && currentProject) {
                    await updateProject(currentProject.id, { notes: projectDescription });
                }

                var grandTotal = calculerGrandTotal();

                if (canApproveQuotes) {
                    // Auto-approbation en 2 étapes (le trigger DB exige draft→pending→approved)
                    await updateSubmission(currentSubmission.id, {
                        status: 'pending_internal',
                        approved_total: grandTotal
                    });
                    await createSubmissionReview(currentSubmission.id, 'approved', projectDescription || 'Auto-approbation');
                    await updateSubmission(currentSubmission.id, {
                        status: 'approved_internal',
                        approved_by: localStorage.getItem('sb_user_id'),
                        approved_at: new Date().toISOString(),
                        approved_total: grandTotal
                    });
                    currentSubmission.status = 'approved_internal';
                    // Figer le HTML de la soumission
                    await uploadSnapshot(currentSubmission.id);
                    updateStatusBadge('approved_internal');
                    showSendStatus('Soumission approuv\u00e9e!', false);
                } else {
                    // Soumettre pour approbation interne
                    var submitComment = projectDescription || '';
                    if (projectDate) submitComment = 'Date requise: ' + projectDate + (submitComment ? '\n' + submitComment : '');
                    await createSubmissionReview(currentSubmission.id, 'submitted', submitComment || 'Soumis pour approbation');
                    await updateSubmission(currentSubmission.id, {
                        status: 'pending_internal',
                        approved_total: grandTotal
                    });
                    currentSubmission.status = 'pending_internal';
                    updateStatusBadge('pending_internal');
                    showSendStatus('Soumission envoy\u00e9e pour approbation!', false);
                }

                updateWorkflowButtons();
                setEditable(false);
                loadSubmissionReviews(currentSubmission.id);
                btnSend.textContent = 'Soumis!';
                setTimeout(() => {
                    closePdfModal();
                    btnSend.disabled = false;
                    btnSend.textContent = 'Soumettre';
                    document.getElementById('sendStatus').style.display = 'none';
                }, 1500);
            } catch (error) {
                console.error('Erreur soumission:', error);
                showSendStatus('Erreur: ' + error.message, true);
                btnSend.disabled = false;
                btnSend.textContent = 'Soumettre';
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // APERÇU SOUMISSION (PREVIEW VIEW) + BIBLIOTHÈQUE DE CLAUSES
        // ═══════════════════════════════════════════════════════════════════════

        var clauseLibrary = []; // loaded from quote_clauses table
        var clientViewMode = false;
        var currentLang = 'fr';
        var roomDescEN = {}; // { groupDomId: 'english description (HTML)' }
        var roomDescHTML = {}; // { groupDomId: 'HTML description from optimizer' }
        var i18n = {
            fr: {
                soumission: 'Soumission',
                client: 'Client',
                projet: 'Projet',
                designer: 'Designer',
                clausesTitle: 'Clauses du contrat',
                total: 'Total',
                taxes: '+ taxes applicables',
                footer: 'Stele \u2014 \u00c9b\u00e9nisterie sur mesure',
                descPlaceholder: 'Description visible par le client...',
                dropClause: 'Glissez une clause ici',
                biblio: '\u2191 Bib.',
                stepsTitle: '\u00c9tapes d\u2019un projet type',
                steps: [
                    { label: 'Conception', desc: '\u00c0 cette \u00e9tape, nous veillerons \u00e0 rassembler toutes les informations n\u00e9cessaires au bon d\u00e9roulement du projet. Cela inclut le choix des poign\u00e9es, l\u2019approbation des mat\u00e9riaux, ainsi que l\u2019\u00e9tude des d\u00e9fis sp\u00e9cifiques au projet. Nous rassemblerons \u00e9galement les fiches techniques des \u00e9lectrom\u00e9nagers et validerons l\u2019\u00e9ch\u00e9ancier avec le client et l\u2019entrepreneur.' },
                    { label: 'Prise de mesure initiale', desc: 'Typiquement, cette prise de mesures s\u2019effectue sur les colombages et le plancher non fini. Nous tiendrons compte de l\u2019\u00e9paisseur du rev\u00eatement de sol et des murs pr\u00e9vus afin d\u2019\u00e9laborer nos dessins.' },
                    { label: 'Approbation des dessins d\u2019atelier', desc: 'Suite \u00e0 notre premi\u00e8re prise de mesures, les dessins d\u2019atelier vous seront remis pour approbation. Une fois ces dessins approuv\u00e9s, aucune modification ne pourra y \u00eatre apport\u00e9e.' },
                    { label: 'Commande de mat\u00e9riaux', desc: 'Comme nous prenons en compte les \u00e9paisseurs de rev\u00eatement lors de notre prise de mesures sur l\u2019ossature brute, nous sommes en mesure de commander les mat\u00e9riaux, tels que les placages de bois et la quincaillerie sp\u00e9ciale, afin d\u2019\u00e9viter tout d\u00e9lai lors de la mise en production.' },
                    { label: 'Prise de mesure finale', desc: 'La prise de mesures finale s\u2019effectue une fois le plancher fini et les joints ainsi que les coins de fer pos\u00e9s. Apr\u00e8s cette prise de mesures, un d\u00e9lai de 6 semaines est n\u00e9cessaire avant le d\u00e9but de l\u2019installation.' },
                    { label: 'Dessins d\u2019atelier pour production', desc: 'Comme nous avons pr\u00e9alablement ajust\u00e9 la prise de mesures initiale pour qu\u2019elle soit presque conforme au r\u00e9sultat final, les ajustements \u00e0 ce stade sont mineurs. Sauf en cas de changement majeur, les dessins d\u2019atelier ne vous seront pas renvoy\u00e9s pour approbation \u00e0 cette \u00e9tape.' },
                    { label: 'Installation', desc: 'La dur\u00e9e de cette \u00e9tape varie en fonction de l\u2019ampleur du projet, mais elle marque un moment cl\u00e9\u00a0: celui o\u00f9 votre vision prend forme. Il ne restera plus que notre mobilier, pr\u00eat \u00e0 s\u2019int\u00e9grer dans votre quotidien et \u00e0 accompagner vos plus beaux moments \u00e0 la maison.' },
                    { label: 'Contr\u00f4le de qualit\u00e9', desc: 'Une fois l\u2019installation termin\u00e9e, un repr\u00e9sentant Stele effectuera une visite avec vous pour \u00e9tablir ensemble une liste unique d\u2019ajustements, si n\u00e9cessaire. Stele pr\u00e9parera ensuite tout le n\u00e9cessaire et, lors d\u2019une seule visite suppl\u00e9mentaire, apportera les ajustements n\u00e9cessaires pour garantir un r\u00e9sultat final \u00e0 la hauteur de vos attentes.' }
                ]
            },
            en: {
                soumission: 'Quote',
                client: 'Client',
                projet: 'Project',
                designer: 'Designer',
                clausesTitle: 'Contract Terms',
                total: 'Total',
                taxes: '+ applicable taxes',
                footer: 'Stele \u2014 Custom Cabinetry',
                descPlaceholder: 'Client-facing description...',
                dropClause: 'Drag a clause here',
                biblio: '\u2191 Lib.',
                stepsTitle: 'Typical Project Steps',
                steps: [
                    { label: 'Design', desc: 'At this stage, we will gather all the information necessary for the smooth progress of the project. This includes the choice of handles, material approval, and the study of project-specific challenges. We will also collect technical specifications for appliances and validate the timeline with the client and contractor.' },
                    { label: 'Initial Measurement', desc: 'Typically, this measurement is taken on the framing and unfinished floor. We will account for the thickness of the planned flooring and wall coverings in order to develop our drawings.' },
                    { label: 'Shop Drawing Approval', desc: 'Following our initial measurements, the shop drawings will be submitted to you for approval. Once these drawings are approved, no modifications can be made.' },
                    { label: 'Material Ordering', desc: 'Since we account for covering thicknesses during our measurements on the rough framing, we are able to order materials such as wood veneers and specialty hardware, avoiding any delay when production begins.' },
                    { label: 'Final Measurement', desc: 'The final measurement is taken once the finished floor is installed and the joints and corner beads are in place. After this measurement, a 6-week lead time is required before installation begins.' },
                    { label: 'Production Shop Drawings', desc: 'Since we previously adjusted the initial measurements to be nearly consistent with the final result, adjustments at this stage are minor. Unless there is a major change, the shop drawings will not be resubmitted for your approval at this step.' },
                    { label: 'Installation', desc: 'The duration of this stage varies depending on the scope of the project, but it marks a key moment: the one where your vision takes shape. All that will remain is our furniture, ready to integrate into your daily life and accompany your finest moments at home.' },
                    { label: 'Quality Control', desc: 'Once installation is complete, a Stele representative will visit you to establish a single list of adjustments, if necessary. Stele will then prepare everything needed and, in one additional visit, make the necessary adjustments to ensure a final result that meets your expectations.' }
                ]
            }
        };
        function t(key) { return (i18n[currentLang] || i18n.fr)[key] || key; }

        async function openPreview() {
            clientViewMode = false;
            document.getElementById('previewView').classList.remove('pv-client-mode');
            document.getElementById('calculatorView').classList.remove('active');
            document.getElementById('previewView').classList.add('active');
            await loadClauseLibrary();
            renderPreview();
            renderClauseLibrary();
            document.getElementById('pvContent').scrollTop = 0;

            // Hide EN toggle and clause panel when submission is locked
            var isLocked = !isSubmissionCurrentlyEditable();
            var btnLang = document.getElementById('btnLang');
            var pvRight = document.getElementById('pvRight');
            if (btnLang) btnLang.style.display = isLocked ? 'none' : '';
            if (pvRight) pvRight.style.display = isLocked ? 'none' : '';
        }

        function closePreview() {
            document.getElementById('previewView').classList.remove('active');
            document.getElementById('previewView').classList.remove('pv-client-mode');
            document.getElementById('calculatorView').classList.add('active');
            clientViewMode = false;
        }

        // ═══════════════════════════════════════════════════════════════════════
        // Plans architecturaux
        // ═══════════════════════════════════════════════════════════════════════
        async function openPlansModal() {
            if (!currentSubmission) {
                alert('Veuillez ouvrir une soumission d\'abord.');
                return;
            }
            document.getElementById('plansModal').classList.add('active');
            await loadSubmissionPlans();
        }

        function closePlansModal() {
            document.getElementById('plansModal').classList.remove('active');
        }

        async function loadSubmissionPlans() {
            if (!currentSubmission) return;

            var container = document.getElementById('plansListContainer');
            container.innerHTML = '<div class="plans-empty">Chargement...</div>';

            try {
                var response = await authenticatedFetch(
                    SUPABASE_URL + '/rest/v1/submission_plans?submission_id=eq.' + currentSubmission.id + '&order=version_number.desc',
                    { headers: { 'Prefer': 'return=representation' } }
                );

                if (!response.ok) throw new Error('Erreur de chargement des plans');

                var plans = await response.json();

                if (plans.length === 0) {
                    container.innerHTML = '<div class="plans-empty">Aucun plan pour cette soumission</div>';
                    return;
                }

                var html = '';
                for (var i = 0; i < plans.length; i++) {
                    var plan = plans[i];
                    var date = new Date(plan.uploaded_at).toLocaleDateString('fr-CA');
                    var size = (plan.file_size / 1024).toFixed(0) + ' Ko';
                    var pages = plan.page_count ? plan.page_count + ' pages' : '';

                    html += '<div class="plan-item">';
                    html += '  <div class="plan-icon">📄</div>';
                    html += '  <div class="plan-info">';
                    html += '    <div class="plan-version">Version ' + plan.version_number + '</div>';
                    html += '    <div class="plan-filename">' + plan.file_name + '</div>';
                    html += '    <div class="plan-meta">' + date + ' • ' + size + (pages ? ' • ' + pages : '') + '</div>';
                    html += '  </div>';
                    html += '  <div class="plan-actions">';
                    html += '    <button class="plan-action-btn" id="btnView_' + plan.id + '" onclick="openPdfViewer(\'' + plan.id + '\')"><span class="btn-text">Voir</span></button>';
                    html += '    <button class="plan-action-btn" id="btnDownload_' + plan.id + '" onclick="downloadPlan(\'' + plan.id + '\', \'' + plan.file_name + '\')"><span class="btn-text">Télécharger</span></button>';
                    html += '    <button class="plan-action-btn danger" onclick="deletePlan(\'' + plan.id + '\')">Supprimer</button>';
                    html += '  </div>';
                    html += '</div>';
                }

                container.innerHTML = html;
            } catch (err) {
                console.error('Error loading plans:', err);
                container.innerHTML = '<div class="plans-empty">Erreur de chargement</div>';
            }
        }

        async function handlePlanFileSelect(event) {
            var file = event.target.files[0];
            if (!file) return;

            if (file.type !== 'application/pdf') {
                alert('Veuillez sélectionner un fichier PDF.');
                event.target.value = '';
                return;
            }

            await uploadNewPlan(file);
            event.target.value = '';
        }

        async function uploadNewPlan(file) {
            if (!currentSubmission) return;

            var status = document.getElementById('planUploadStatus');
            var btn = document.getElementById('btnUploadPlan');

            try {
                // Show upload status
                btn.disabled = true;
                status.style.display = 'block';
                status.style.background = '#e3f2fd';
                status.style.color = '#1565c0';
                status.innerHTML = '<span style="display:inline-block; animation: pulse 1.5s ease-in-out infinite;">📄</span> Préparation...';

                // Get next version number
                var versionResp = await authenticatedFetch(
                    SUPABASE_URL + '/rest/v1/rpc/get_next_plan_version',
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ p_submission_id: currentSubmission.id })
                    }
                );

                if (!versionResp.ok) throw new Error('Erreur de récupération de la version');
                var nextVersion = await versionResp.json();

                status.innerHTML = '<span style="display:inline-block; animation: pulse 1.5s ease-in-out infinite;">⬆️</span> Upload en cours (' + (file.size / 1024 / 1024).toFixed(1) + ' MB)...';

                // Upload to Storage
                var storagePath = currentSubmission.id + '/v' + nextVersion + '_' + file.name;
                var uploadResp = await authenticatedFetch(
                    SUPABASE_URL + '/storage/v1/object/submission-plans/' + storagePath,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': file.type },
                        body: file
                    }
                );

                if (!uploadResp.ok) {
                    var errData = await uploadResp.text();
                    throw new Error('Erreur d\'upload: ' + errData);
                }

                status.innerHTML = '<span style="display:inline-block; animation: pulse 1.5s ease-in-out infinite;">💾</span> Enregistrement...';

                // Create database record
                var dbResp = await authenticatedFetch(
                    SUPABASE_URL + '/rest/v1/submission_plans',
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify({
                            submission_id: currentSubmission.id,
                            version_number: nextVersion,
                            file_path: storagePath,
                            file_name: file.name,
                            file_size: file.size,
                            status: 'ready'
                        })
                    }
                );

                if (!dbResp.ok) throw new Error('Erreur de création de l\'enregistrement');

                // Success
                status.style.background = '#e8f5e9';
                status.style.color = '#2e7d32';
                status.innerHTML = '✓ Plan téléversé avec succès!';

                // Reload list
                await loadSubmissionPlans();

                // Hide status after 3 seconds
                setTimeout(function() {
                    status.style.display = 'none';
                }, 3000);

            } catch (err) {
                console.error('Upload error:', err);
                status.style.background = '#ffebee';
                status.style.color = '#c62828';
                status.innerHTML = '✗ Erreur: ' + err.message;

                // Keep error visible longer (10 seconds)
                setTimeout(function() {
                    status.style.display = 'none';
                }, 10000);
            } finally {
                btn.disabled = false;
            }
        }

        function setPlanButtonLoading(planId, btnType, isLoading) {
            var btn = document.getElementById('btn' + btnType + '_' + planId);
            if (!btn) return;

            if (isLoading) {
                btn.disabled = true;
                var textSpan = btn.querySelector('.btn-text');
                if (textSpan) {
                    textSpan.style.opacity = '0.6';
                    var loadingText = btnType === 'View' ? 'Ouverture...' : 'Téléchargement...';
                    btn.innerHTML = '<span style="display:inline-block; animation: spin 1s linear infinite;">⟳</span> ' + loadingText;
                }
            } else {
                btn.disabled = false;
                var originalText = btnType === 'View' ? 'Voir' : 'Télécharger';
                btn.innerHTML = '<span class="btn-text">' + originalText + '</span>';
            }
        }

        async function downloadPlan(planId, fileName) {
            setPlanButtonLoading(planId, 'Download', true);
            try {
                // Get plan record to get file_path
                var planResp = await authenticatedFetch(
                    SUPABASE_URL + '/rest/v1/submission_plans?id=eq.' + planId + '&select=file_path',
                    {}
                );

                if (!planResp.ok) throw new Error('Plan introuvable');
                var plans = await planResp.json();
                if (plans.length === 0) throw new Error('Plan introuvable');

                var filePath = plans[0].file_path;

                // Get signed URL for download
                var signResp = await authenticatedFetch(
                    SUPABASE_URL + '/storage/v1/object/sign/submission-plans/' + filePath,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ expiresIn: 60 })
                    }
                );

                if (!signResp.ok) throw new Error('Erreur de génération du lien');
                var signData = await signResp.json();

                // Download file
                var downloadUrl = SUPABASE_URL + '/storage/v1' + signData.signedURL;
                var link = document.createElement('a');
                link.href = downloadUrl;
                link.download = fileName;
                link.click();

            } catch (err) {
                console.error('Download error:', err);
                alert('Erreur de téléchargement: ' + err.message);
            } finally {
                setPlanButtonLoading(planId, 'Download', false);
            }
        }

        async function deletePlan(planId) {
            if (!confirm('Êtes-vous sûr de vouloir supprimer ce plan ?')) return;

            try {
                // Get plan record to get file_path
                var planResp = await authenticatedFetch(
                    SUPABASE_URL + '/rest/v1/submission_plans?id=eq.' + planId + '&select=file_path',
                    {}
                );

                if (!planResp.ok) throw new Error('Plan introuvable');
                var plans = await planResp.json();
                if (plans.length === 0) throw new Error('Plan introuvable');

                var filePath = plans[0].file_path;

                // Delete from Storage
                var deleteStorageResp = await authenticatedFetch(
                    SUPABASE_URL + '/storage/v1/object/submission-plans/' + filePath,
                    { method: 'DELETE' }
                );

                if (!deleteStorageResp.ok) {
                    console.warn('Storage deletion failed, continuing with DB deletion');
                }

                // Delete from database
                var deleteDbResp = await authenticatedFetch(
                    SUPABASE_URL + '/rest/v1/submission_plans?id=eq.' + planId,
                    { method: 'DELETE' }
                );

                if (!deleteDbResp.ok) throw new Error('Erreur de suppression');

                // Reload list
                await loadSubmissionPlans();

            } catch (err) {
                console.error('Delete error:', err);
                alert('Erreur de suppression: ' + err.message);
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // PDF Viewer
        // ═══════════════════════════════════════════════════════════════════════
        var pdfDoc = null;
        var pdfCurrentPage = 1;
        var pdfTotalPages = 0;
        var pdfScale = 1.0;
        var pdfRotation = 0;
        var currentPdfUrl = null;
        var currentPlanRecord = null;
        var currentRenderTask = null; // Track current render task for cancellation

        async function openPdfViewer(planId) {
            setPlanButtonLoading(planId, 'View', true);

            // Open blank window IMMEDIATELY (sync) to preserve user gesture — avoids pop-up blocker
            var newWindow = window.open('about:blank', '_blank', 'width=1200,height=800');

            if (!newWindow) {
                alert('Veuillez autoriser les fenêtres pop-up pour cette fonctionnalité.');
                setPlanButtonLoading(planId, 'View', false);
                return;
            }

            try {
                // Get plan record
                var planResp = await authenticatedFetch(
                    SUPABASE_URL + '/rest/v1/submission_plans?id=eq.' + planId + '&select=*',
                    {}
                );

                if (!planResp.ok) throw new Error('Plan introuvable');
                var plans = await planResp.json();
                if (plans.length === 0) throw new Error('Plan introuvable');

                currentPlanRecord = plans[0];

                // Get signed URL
                var signResp = await authenticatedFetch(
                    SUPABASE_URL + '/storage/v1/object/sign/submission-plans/' + currentPlanRecord.file_path,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ expiresIn: 3600 })
                    }
                );

                if (!signResp.ok) throw new Error('Erreur de génération du lien');
                var signData = await signResp.json();

                currentPdfUrl = SUPABASE_URL + '/storage/v1' + signData.signedURL;

                // Write viewer HTML directly into the window (same origin — avoids blob:null CORS issues)
                var viewerHtml = createStandaloneViewer();
                newWindow.document.open();
                newWindow.document.write(viewerHtml);
                newWindow.document.close();

                // Send PDF data once the viewer scripts are loaded
                function trySendMessage() {
                    newWindow.postMessage({
                        type: 'INIT_PDF',
                        pdfUrl: currentPdfUrl,
                        planRecord: currentPlanRecord,
                        submissionId: currentSubmission.id,
                        supabaseUrl: SUPABASE_URL,
                        accessToken: localStorage.getItem('sb_access_token')
                    }, '*');
                }

                // Retry mechanism: send message multiple times until viewer ACKs
                var sendAttempts = 0;
                var sendInterval = setInterval(function() {
                    if (newWindow.closed) { clearInterval(sendInterval); return; }
                    trySendMessage();
                    sendAttempts++;
                    if (sendAttempts > 30) clearInterval(sendInterval); // stop after 15s
                }, 500);

                // Listen for ACK from viewer to stop retrying
                window.addEventListener('message', function ackHandler(e) {
                    if (e.data && e.data.type === 'PDF_VIEWER_ACK') {
                        clearInterval(sendInterval);
                        window.removeEventListener('message', ackHandler);
                    }
                });

                // Auto-close plans modal when PDF viewer window is closed
                var checkClosed = setInterval(function() {
                    if (newWindow.closed) {
                        clearInterval(checkClosed);
                        closePlansModal();
                    }
                }, 500);

            } catch (err) {
                console.error('PDF viewer error:', err);
                try {
                    newWindow.document.body.innerHTML = '<div style="color:#fff;padding:40px;font-family:sans-serif;">' +
                        '<h2>Erreur</h2><p>' + err.message + '</p></div>';
                } catch (e) { /* window might be closed */ }
            } finally {
                setPlanButtonLoading(planId, 'View', false);
            }
        }

        function closePdfViewer() {
            // Cancel any render in progress
            if (currentRenderTask) {
                try {
                    currentRenderTask.cancel();
                } catch (e) {
                    // Ignore
                }
                currentRenderTask = null;
            }

            document.getElementById('pdfViewerOverlay').classList.remove('active');
            // Don't reset pdfDoc - keep it in memory for captures
            // pdfDoc = null;
            // currentPdfUrl = null;
            // currentPlanRecord = null;
        }

        function openPdfInNewWindow() {
            if (!pdfDoc || !currentPlanRecord) {
                alert('Aucun PDF chargé');
                return;
            }

            // Create standalone viewer page
            var viewerHtml = createStandaloneViewer();
            var blob = new Blob([viewerHtml], { type: 'text/html' });
            var blobUrl = URL.createObjectURL(blob);

            // Open in new window
            var newWindow = window.open(blobUrl, '_blank', 'width=1200,height=800');

            if (!newWindow) {
                alert('Veuillez autoriser les fenêtres pop-up pour cette fonctionnalité.');
            } else {
                // Pass data to new window after it loads
                newWindow.addEventListener('load', function() {
                    newWindow.postMessage({
                        type: 'INIT_PDF',
                        pdfUrl: currentPdfUrl,
                        planRecord: currentPlanRecord,
                        submissionId: currentSubmission.id,
                        supabaseUrl: SUPABASE_URL,
                        accessToken: localStorage.getItem('sb_access_token')
                    }, '*');
                });
            }
        }

        function createStandaloneViewer() {
            var ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJwbHpidGpmbndhaHFvZHJocG55Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NDU2MDEsImV4cCI6MjA4NjIyMTYwMX0.OQAZhc029PbRDSe1b02NDAuOUE8yn-_h3QqSnUDpLeU';
            return '<!DOCTYPE html>' +
'<html><head><meta charset="utf-8"><title>Plan - ' + (currentPlanRecord ? currentPlanRecord.file_name : 'PDF') + '</title>' +
'<scr' + 'ipt src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></' + 'script>' +
'<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.css">' +
'<scr' + 'ipt src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.js"></' + 'script>' +
'<style>' +
'* { margin: 0; padding: 0; box-sizing: border-box; }' +
'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #2b2b2b; color: #fff; overflow: hidden; }' +
'.viewer-header { background: #1a1a1a; padding: 12px 16px; display: flex; align-items: center; gap: 16px; border-bottom: 1px solid #444; }' +
'.viewer-title { font-size: 14px; font-weight: 600; flex: 1; }' +
'.controls { display: flex; align-items: center; gap: 8px; }' +
'.btn { background: #3a3a3a; border: 1px solid #555; color: #fff; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 13px; font-family: inherit; }' +
'.btn:hover { background: #4a4a4a; }' +
'.btn:disabled { opacity: 0.5; cursor: not-allowed; }' +
'.page-info { font-size: 13px; color: #999; }' +
'.canvas-container { position: fixed; top: 60px; left: 0; right: 0; bottom: 0; overflow: auto; display: flex; justify-content: center; align-items: flex-start; padding: 20px; }' +
'canvas { box-shadow: 0 4px 24px rgba(0,0,0,0.5); background: #fff; }' +
'.overlay-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; z-index: 1000; }' +
'.overlay-modal.active { display: flex; }' +
'.modal-content { background: #2b2b2b; border-radius: 8px; padding: 24px; max-width: 500px; width: 90%; border: 1px solid #444; }' +
'.modal-title { font-size: 18px; margin-bottom: 16px; }' +
'.form-group { margin-bottom: 16px; }' +
'.form-label { display: block; font-size: 13px; margin-bottom: 6px; color: #aaa; }' +
'.form-input { width: 100%; padding: 10px; background: #1a1a1a; border: 1px solid #555; border-radius: 4px; color: #fff; font-family: inherit; font-size: 14px; }' +
'.modal-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px; }' +
'.status { margin-top: 12px; padding: 10px; border-radius: 4px; font-size: 13px; display: none; }' +
'.crop-box { background: #2b2b2b; border-radius: 8px; border: 1px solid #444; width: 90vw; max-width: 900px; max-height: 90vh; display: flex; flex-direction: column; overflow: hidden; }' +
'.crop-header { padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #444; }' +
'.crop-header .modal-title { margin-bottom: 0; }' +
'.crop-container { position: relative; flex: 1; min-height: 300px; max-height: 60vh; background: #222; overflow: hidden; }' +
'.crop-container img { display: block; max-width: 100%; }' +
'.crop-controls { padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #444; }' +
'.crop-ratios { display: flex; gap: 6px; }' +
'.ratio-btn { background: #3a3a3a; border: 1px solid #555; color: #fff; padding: 6px 14px; border-radius: 4px; cursor: pointer; font-size: 13px; }' +
'.ratio-btn:hover { background: #4a4a4a; }' +
'.ratio-btn.active { border-color: #0B1220; background: #0B1220; color: #fff; }' +
'.crop-actions { display: flex; gap: 8px; }' +
'.loading-screen { position: fixed; inset: 0; background: #2b2b2b; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 900; transition: opacity .4s ease; }' +
'.loading-screen.hidden { opacity: 0; pointer-events: none; }' +
'.loader-ring { width: 48px; height: 48px; border-radius: 50%; border: 3px solid rgba(255,255,255,0.08); border-top-color: rgba(255,255,255,0.6); animation: spin 0.9s linear infinite; }' +
'@keyframes spin { to { transform: rotate(360deg); } }' +
'.loader-text { margin-top: 20px; font-size: 14px; color: rgba(255,255,255,0.45); letter-spacing: 0.5px; }' +
'.loader-bar { margin-top: 24px; width: 120px; height: 3px; border-radius: 2px; background: rgba(255,255,255,0.08); overflow: hidden; }' +
'.loader-bar-inner { height: 100%; width: 40%; border-radius: 2px; background: rgba(255,255,255,0.3); animation: slide 1.2s ease-in-out infinite; }' +
'@keyframes slide { 0% { transform: translateX(-100%); } 100% { transform: translateX(350%); } }' +
'</style></head><body>' +
'<div class="loading-screen" id="loadingScreen">' +
'  <div class="loader-ring"></div>' +
'  <div class="loader-text">Chargement du plan...</div>' +
'  <div class="loader-bar"><div class="loader-bar-inner"></div></div>' +
'</div>' +
'<div class="viewer-header">' +
'  <div class="viewer-title" id="title">Chargement...</div>' +
'  <div class="controls">' +
'    <button class="btn" id="btnPrev" onclick="navigate(-1)">\u25C0</button>' +
'    <span class="page-info" id="pageInfo">1 / 1</span>' +
'    <button class="btn" id="btnNext" onclick="navigate(1)">\u25B6</button>' +
'    <button class="btn" onclick="zoom(-0.25)">\u2212</button>' +
'    <span class="page-info" id="zoomInfo">100%</span>' +
'    <button class="btn" onclick="zoom(0.25)">+</button>' +
'    <button class="btn" onclick="rotate()">\u21BB</button>' +
'    <button class="btn" onclick="openCaptureModal()">\uD83D\uDCF8 Capturer</button>' +
'  </div>' +
'</div>' +
'<div class="canvas-container" id="canvasContainer"><canvas id="pdfCanvas"></canvas></div>' +
/* Capture modal — room selection */
'<div class="overlay-modal" id="captureModal">' +
'  <div class="modal-content">' +
'    <div class="modal-title">Capturer la page</div>' +
'    <div class="form-group"><label class="form-label">Pi\u00E8ce / Meuble</label><select class="form-input" id="roomSelect"><option value="">-- S\u00E9lectionnez --</option></select></div>' +
'    <div class="status" id="captureStatus"></div>' +
'    <div class="modal-actions"><button class="btn" onclick="closeCaptureModal()">Annuler</button><button class="btn" id="btnCapture" onclick="confirmCapture()">Capturer</button></div>' +
'  </div>' +
'</div>' +
/* Crop modal */
'<div class="overlay-modal" id="cropModal">' +
'  <div class="crop-box">' +
'    <div class="crop-header"><div class="modal-title">Recadrer l\\\'image</div><span id="cropDims" style="font-size:12px;color:#888;"></span></div>' +
'    <div class="crop-container" id="cropContainer"><img id="cropImage" src=""></div>' +
'    <div class="crop-controls">' +
'      <div class="crop-ratios">' +
'        <button class="ratio-btn active" onclick="setCropRatio(16/9,this)">16:9</button>' +
'        <button class="ratio-btn" onclick="setCropRatio(9/16,this)">9:16</button>' +
'        <button class="ratio-btn" onclick="setCropRatio(1,this)">1:1</button>' +
'      </div>' +
'      <div class="crop-actions">' +
'        <button class="btn" onclick="cancelCrop()">Annuler</button>' +
'        <button class="btn" id="btnCropConfirm" style="background:#0B1220;" onclick="confirmCrop()">Valider</button>' +
'      </div>' +
'    </div>' +
'    <div class="status" id="cropStatus" style="margin:0 20px 16px;"></div>' +
'  </div>' +
'</div>' +
'<scr' + 'ipt>' +
'pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";' +
'var pdfDoc = null, currentPage = 1, totalPages = 0, scale = 1.0, rotation = 0;' +
'var planRecord = null, submissionId = null, supabaseUrl = null, accessToken = null;' +
'var ANON_KEY = "' + ANON_KEY + '";' +
'var cropper = null, capturedBlob = null, selectedRoomId = null, cropRatioLabel = "16:9";' +

/* INIT via postMessage */
'var pdfInitialized = false;' +
'window.addEventListener("message", async function(e) {' +
'  if (e.data.type === "INIT_PDF" && !pdfInitialized) {' +
'    pdfInitialized = true;' +
'    if (e.source) e.source.postMessage({ type: "PDF_VIEWER_ACK" }, "*");' +
'    planRecord = e.data.planRecord; submissionId = e.data.submissionId; supabaseUrl = e.data.supabaseUrl; accessToken = e.data.accessToken;' +
'    document.getElementById("title").textContent = planRecord.file_name;' +
'    try {' +
'      var loadingTask = pdfjsLib.getDocument(e.data.pdfUrl);' +
'      pdfDoc = await loadingTask.promise; totalPages = pdfDoc.numPages; await render(); await loadRooms();' +
'      var ls = document.getElementById("loadingScreen"); ls.classList.add("hidden"); setTimeout(function() { ls.remove(); }, 500);' +
'    } catch (err) {' +
'      console.error("PDF load error:", err);' +
'      document.getElementById("loadingScreen").innerHTML = "<div style=\\"color:#fff;padding:40px;text-align:center;\\"><h2>Erreur de chargement</h2><p>" + err.message + "</p><p style=\\"margin-top:16px;color:#999;font-size:13px;\\">V\\u00e9rifiez que le fichier PDF existe dans le stockage.</p></div>";' +
'    }' +
'  }' +
'});' +

/* PDF rendering */
'async function render() {' +
'  if (!pdfDoc) return;' +
'  var page = await pdfDoc.getPage(currentPage);' +
'  var canvas = document.getElementById("pdfCanvas"); var ctx = canvas.getContext("2d");' +
'  var viewport = page.getViewport({ scale: scale, rotation: rotation });' +
'  canvas.width = viewport.width; canvas.height = viewport.height;' +
'  await page.render({ canvasContext: ctx, viewport: viewport }).promise;' +
'  document.getElementById("pageInfo").textContent = currentPage + " / " + totalPages;' +
'  document.getElementById("zoomInfo").textContent = Math.round(scale * 100) + "%";' +
'  document.getElementById("btnPrev").disabled = currentPage <= 1; document.getElementById("btnNext").disabled = currentPage >= totalPages;' +
'}' +
'function navigate(d) { currentPage += d; if (currentPage < 1) currentPage = 1; if (currentPage > totalPages) currentPage = totalPages; render(); }' +
'function zoom(d) { scale += d; if (scale < 0.5) scale = 0.5; if (scale > 3.0) scale = 3.0; render(); }' +
'function rotate() { rotation = (rotation + 90) % 360; render(); }' +
'var scrollCooldown = false;' +
'document.getElementById("canvasContainer").addEventListener("wheel", function(e) {' +
'  if (e.ctrlKey) { e.preventDefault(); zoom(e.deltaY > 0 ? -0.1 : 0.1); return; }' +
'  if (scrollCooldown) return;' +
'  var threshold = 30;' +
'  if (Math.abs(e.deltaY) < threshold) return;' +
'  if (e.deltaY > 0 && currentPage < totalPages) { navigate(1); scrollCooldown = true; setTimeout(function() { scrollCooldown = false; }, 300); }' +
'  else if (e.deltaY < 0 && currentPage > 1) { navigate(-1); scrollCooldown = true; setTimeout(function() { scrollCooldown = false; }, 300); }' +
'}, { passive: false });' +

/* Ctrl+drag pan (hand tool like Adobe) */
'var isPanning = false, panStartX = 0, panStartY = 0, scrollStartX = 0, scrollStartY = 0;' +
'var cc = document.getElementById("canvasContainer");' +
'cc.addEventListener("mousedown", function(e) {' +
'  if (e.ctrlKey && e.button === 0) { e.preventDefault(); isPanning = true; panStartX = e.clientX; panStartY = e.clientY; scrollStartX = cc.scrollLeft; scrollStartY = cc.scrollTop; cc.style.cursor = "grabbing"; }' +
'});' +
'window.addEventListener("mousemove", function(e) {' +
'  if (!isPanning) return; cc.scrollLeft = scrollStartX - (e.clientX - panStartX); cc.scrollTop = scrollStartY - (e.clientY - panStartY);' +
'});' +
'window.addEventListener("mouseup", function() { if (isPanning) { isPanning = false; cc.style.cursor = ""; } });' +
'document.addEventListener("keydown", function(e) { if (e.key === "Control") cc.style.cursor = "grab"; });' +
'document.addEventListener("keyup", function(e) { if (e.key === "Control" && !isPanning) cc.style.cursor = ""; });' +

/* Load rooms dropdown */
'async function loadRooms() {' +
'  try {' +
'    var r = await fetch(supabaseUrl + "/rest/v1/project_rooms?submission_id=eq." + submissionId + "&select=id,name&order=sort_order.asc", { headers: { "apikey": ANON_KEY, "Authorization": "Bearer " + accessToken } });' +
'    var rooms = await r.json(); var sel = document.getElementById("roomSelect");' +
'    rooms.forEach(function(rm) { var opt = document.createElement("option"); opt.value = rm.id; opt.textContent = rm.name; sel.appendChild(opt); });' +
'  } catch (e) { console.error(e); }' +
'}' +

/* Capture modal */
'function openCaptureModal() { document.getElementById("captureModal").classList.add("active"); refreshRooms(); }' +
'async function refreshRooms() {' +
'  var sel = document.getElementById("roomSelect"); var prev = sel.value;' +
'  sel.innerHTML = "<option value=\\"\\">-- S\\u00E9lectionnez --</option>";' +
'  await loadRooms();' +
'  if (prev) sel.value = prev;' +
'}' +
'function closeCaptureModal() { document.getElementById("captureModal").classList.remove("active"); document.getElementById("captureStatus").style.display = "none"; }' +

/* Step 1: confirmCapture — render page then open crop */
'async function confirmCapture() {' +
'  selectedRoomId = document.getElementById("roomSelect").value;' +
'  if (!selectedRoomId) { alert("S\\u00E9lectionnez une pi\\u00E8ce"); return; }' +
'  var status = document.getElementById("captureStatus"); var btn = document.getElementById("btnCapture");' +
'  status.style.display = "block"; status.style.background = "#e3f2fd"; status.style.color = "#1565c0"; status.textContent = "Capture haute r\\u00E9solution...";' +
'  btn.disabled = true;' +
'  try {' +
'    var page = await pdfDoc.getPage(currentPage);' +
'    var viewport = page.getViewport({ scale: 3.0, rotation: rotation });' +
'    var canvas = document.createElement("canvas"); canvas.width = viewport.width; canvas.height = viewport.height;' +
'    await page.render({ canvasContext: canvas.getContext("2d"), viewport: viewport }).promise;' +
'    capturedBlob = await new Promise(function(res) { canvas.toBlob(function(b) { res(b); }, "image/jpeg", 0.9); });' +
'    closeCaptureModal();' +
'    openCropModal(capturedBlob);' +
'  } catch (e) { console.error(e); status.style.background = "#ffebee"; status.style.color = "#c62828"; status.textContent = "Erreur: " + e.message; }' +
'  finally { btn.disabled = false; }' +
'}' +

/* Step 2: Crop modal */
'function openCropModal(blob) {' +
'  var url = URL.createObjectURL(blob);' +
'  var imgEl = document.getElementById("cropImage");' +
'  var testImg = new Image();' +
'  testImg.onload = function() {' +
'    document.getElementById("cropDims").textContent = testImg.width + " \\u00D7 " + testImg.height + " px";' +
'    imgEl.src = url;' +
'    document.getElementById("cropModal").classList.add("active");' +
'    if (cropper) { cropper.destroy(); cropper = null; }' +
'    cropper = new Cropper(imgEl, { aspectRatio: 16/9, viewMode: 1, autoCropArea: 1, responsive: true, background: false, dragMode: "move", cropBoxMovable: false, cropBoxResizable: false, toggleDragModeOnDblclick: false });' +
'    cropRatioLabel = "16:9";' +
'    document.querySelectorAll(".ratio-btn").forEach(function(b) { b.classList.remove("active"); });' +
'    document.querySelector(".ratio-btn").classList.add("active");' +
'  };' +
'  testImg.src = url;' +
'}' +

'function setCropRatio(ratio, btn) {' +
'  if (cropper) cropper.setAspectRatio(ratio);' +
'  cropRatioLabel = ratio === 1 ? "1:1" : (ratio < 1 ? "9:16" : "16:9");' +
'  document.querySelectorAll(".ratio-btn").forEach(function(b) { b.classList.remove("active"); });' +
'  btn.classList.add("active");' +
'}' +

'function cancelCrop() {' +
'  document.getElementById("cropModal").classList.remove("active");' +
'  if (cropper) { cropper.destroy(); cropper = null; }' +
'  document.getElementById("cropImage").src = "";' +
'  document.getElementById("cropStatus").style.display = "none";' +
'}' +

/* Step 3: confirmCrop — upload original + cropped */
'async function confirmCrop() {' +
'  if (!cropper || !capturedBlob || !selectedRoomId) return;' +
'  var confirmBtn = document.getElementById("btnCropConfirm");' +
'  var status = document.getElementById("cropStatus");' +
'  confirmBtn.disabled = true; confirmBtn.textContent = "Upload...";' +
'  status.style.display = "block"; status.style.background = "#e3f2fd"; status.style.color = "#1565c0"; status.textContent = "Upload en cours...";' +
'  try {' +
'    var croppedCanvas = cropper.getCroppedCanvas({ maxWidth: 2048, maxHeight: 2048, imageSmoothingQuality: "high" });' +
'    var cropData = cropper.getData(true);' +
'    var croppedBlob = await new Promise(function(res) { croppedCanvas.toBlob(function(b) { res(b); }, "image/jpeg", 0.88); });' +
'    var ts = Date.now();' +
'    var headers = { "apikey": ANON_KEY, "Authorization": "Bearer " + accessToken };' +

/* Upload original to room-images */
'    var origPath = "originals/" + selectedRoomId + "/" + ts + ".jpg";' +
'    var origResp = await fetch(supabaseUrl + "/storage/v1/object/room-images/" + origPath, { method: "POST", headers: Object.assign({}, headers, { "Content-Type": "image/jpeg", "x-upsert": "true" }), body: capturedBlob });' +
'    if (!origResp.ok) throw new Error("Upload original: " + origResp.status);' +
'    var originalUrl = supabaseUrl + "/storage/v1/object/public/room-images/" + origPath;' +

/* Upload cropped to room-images */
'    status.textContent = "Upload recadrage...";' +
'    var ratioFile = cropRatioLabel.replace(":", "x");' +
'    var cropPath = "cropped/" + selectedRoomId + "/" + ts + "_" + ratioFile + ".jpg";' +
'    var cropResp = await fetch(supabaseUrl + "/storage/v1/object/room-images/" + cropPath, { method: "POST", headers: Object.assign({}, headers, { "Content-Type": "image/jpeg", "x-upsert": "true" }), body: croppedBlob });' +
'    if (!cropResp.ok) throw new Error("Upload crop: " + cropResp.status);' +
'    var croppedUrl = supabaseUrl + "/storage/v1/object/public/room-images/" + cropPath;' +

/* Insert room_media record (same schema as calculateur) */
'    status.textContent = "Enregistrement...";' +
'    var meta = { type: "pdf_plan", plan_id: planRecord.id, page_number: currentPage, pdf_filename: planRecord.file_name, pdf_version: planRecord.version_number, captured_at: new Date().toISOString(), scale: 3.0 };' +
'    var insResp = await fetch(supabaseUrl + "/rest/v1/room_media", { method: "POST", headers: Object.assign({}, headers, { "Content-Type": "application/json", "Prefer": "return=representation" }), body: JSON.stringify({ room_id: selectedRoomId, original_url: originalUrl, cropped_url: croppedUrl, crop_ratio: cropRatioLabel, crop_data: cropData, tags: ["presentation_soumission"], source_metadata: meta }) });' +
'    if (!insResp.ok) throw new Error("Insert record: " + insResp.status);' +
'    var inserted = await insResp.json();' +
'    var newMediaId = Array.isArray(inserted) ? inserted[0].id : inserted.id;' +

'    status.style.background = "#e8f5e9"; status.style.color = "#2e7d32"; status.textContent = "\\u2713 Capture r\\u00E9ussie!";' +
'    if (window.opener) { window.opener.postMessage({ type: "PLAN_CAPTURE_DONE", roomId: selectedRoomId, croppedUrl: croppedUrl, originalUrl: originalUrl, cropRatio: cropRatioLabel, mediaId: newMediaId }, "*"); }' +
'    setTimeout(cancelCrop, 1500);' +
'  } catch (e) {' +
'    console.error(e); status.style.background = "#ffebee"; status.style.color = "#c62828"; status.textContent = "Erreur: " + e.message;' +
'  } finally { confirmBtn.disabled = false; confirmBtn.textContent = "Valider"; }' +
'}' +
'</' + 'script></body></html>';
        }

        async function renderPdfPage() {
            if (!pdfDoc) return;

            // Cancel previous render if still in progress
            if (currentRenderTask) {
                try {
                    currentRenderTask.cancel();
                } catch (e) {
                    // Ignore cancel errors
                }
                currentRenderTask = null;
            }

            try {
                var page = await pdfDoc.getPage(pdfCurrentPage);
                var canvas = document.getElementById('pdfCanvas');
                var ctx = canvas.getContext('2d');

                var viewport = page.getViewport({ scale: pdfScale, rotation: pdfRotation });

                // Update zoom info immediately for better UX
                document.getElementById('pdfZoomInfo').textContent = Math.round(pdfScale * 100) + '%';

                // Only update canvas dimensions if they changed (prevents flickering)
                if (canvas.width !== viewport.width || canvas.height !== viewport.height) {
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                }

                var renderContext = {
                    canvasContext: ctx,
                    viewport: viewport
                };

                // Store render task so we can cancel it if needed
                currentRenderTask = page.render(renderContext);
                await currentRenderTask.promise;
                currentRenderTask = null;

                // Update UI
                document.getElementById('pdfPageInfo').textContent = pdfCurrentPage + ' / ' + pdfTotalPages;

                // Update prev/next buttons
                document.getElementById('btnPdfPrev').disabled = (pdfCurrentPage <= 1);
                document.getElementById('btnPdfNext').disabled = (pdfCurrentPage >= pdfTotalPages);

                // Update active thumbnail
                var thumbs = document.querySelectorAll('.pdf-thumb');
                for (var i = 0; i < thumbs.length; i++) {
                    thumbs[i].classList.remove('active');
                }
                var activeThumb = document.querySelector('.pdf-thumb[data-page="' + pdfCurrentPage + '"]');
                if (activeThumb) activeThumb.classList.add('active');
            } catch (err) {
                // Ignore render cancellation errors
                if (err.name === 'RenderingCancelledException') {
                    console.log('PDF render cancelled');
                } else {
                    console.error('PDF render error:', err);
                }
            }
        }

        async function renderPdfThumbnails() {
            if (!pdfDoc) return;

            var container = document.getElementById('pdfThumbnails');
            container.innerHTML = '';

            for (var pageNum = 1; pageNum <= pdfTotalPages; pageNum++) {
                var page = await pdfDoc.getPage(pageNum);
                var viewport = page.getViewport({ scale: 0.3 });

                var thumbDiv = document.createElement('div');
                thumbDiv.className = 'pdf-thumb';
                thumbDiv.setAttribute('data-page', pageNum);
                thumbDiv.onclick = (function(num) {
                    return function() { pdfGoToPage(num); };
                })(pageNum);

                var canvas = document.createElement('canvas');
                canvas.width = viewport.width;
                canvas.height = viewport.height;

                var ctx = canvas.getContext('2d');
                await page.render({
                    canvasContext: ctx,
                    viewport: viewport
                }).promise;

                var label = document.createElement('div');
                label.className = 'pdf-thumb-label';
                label.textContent = pageNum;

                thumbDiv.appendChild(canvas);
                thumbDiv.appendChild(label);
                container.appendChild(thumbDiv);
            }

            // Mark first as active
            var firstThumb = container.querySelector('.pdf-thumb[data-page="1"]');
            if (firstThumb) firstThumb.classList.add('active');
        }

        function pdfNavigate(delta) {
            pdfCurrentPage += delta;
            if (pdfCurrentPage < 1) pdfCurrentPage = 1;
            if (pdfCurrentPage > pdfTotalPages) pdfCurrentPage = pdfTotalPages;
            renderPdfPage();
        }

        function pdfGoToPage(pageNum) {
            pdfCurrentPage = pageNum;
            renderPdfPage();
        }

        function pdfZoom(delta) {
            pdfScale += delta;
            if (pdfScale < 0.5) pdfScale = 0.5;
            if (pdfScale > 3.0) pdfScale = 3.0;
            renderPdfPage();
        }

        function pdfResetZoom() {
            pdfScale = 1.0;
            renderPdfPage();
        }

        function pdfRotate() {
            pdfRotation = (pdfRotation + 90) % 360;
            renderPdfPage();
        }

        // ═══════════════════════════════════════════════════════════════════════
        // Capture PDF Page → Room Media
        // ═══════════════════════════════════════════════════════════════════════
        var capturedImageBlob = null;

        async function capturePdfPage() {
            if (!currentSubmission) {
                alert('Aucune soumission ouverte');
                return;
            }

            // Load rooms and open modal
            await loadRoomsForCapture();
            document.getElementById('captureRoomModal').classList.add('active');
        }

        async function loadRoomsForCapture() {
            var select = document.getElementById('captureRoomSelect');
            select.innerHTML = '<option value="">-- Sélectionnez --</option>';

            if (!currentSubmission) return;

            try {
                var response = await authenticatedFetch(
                    SUPABASE_URL + '/rest/v1/project_rooms?submission_id=eq.' + currentSubmission.id + '&select=id,name&order=sort_order.asc',
                    {}
                );

                if (!response.ok) throw new Error('Erreur de chargement des pièces');

                var rooms = await response.json();

                for (var i = 0; i < rooms.length; i++) {
                    var option = document.createElement('option');
                    option.value = rooms[i].id;
                    option.textContent = rooms[i].name;
                    select.appendChild(option);
                }

            } catch (err) {
                console.error('Error loading rooms:', err);
                alert('Erreur de chargement des pièces');
            }
        }

        function closeCaptureRoomModal() {
            document.getElementById('captureRoomModal').classList.remove('active');
            capturedImageBlob = null;
            document.getElementById('captureStatus').style.display = 'none';
        }

        async function confirmCapture() {
            var roomId = document.getElementById('captureRoomSelect').value;
            if (!roomId) {
                alert('Veuillez sélectionner une pièce');
                return;
            }

            // Validate PDF is loaded
            if (!pdfDoc || !currentPlanRecord) {
                alert('Erreur: Le PDF n\'est pas chargé correctement. Veuillez fermer et rouvrir le PDF.');
                return;
            }

            // Find the groupId from roomId (reverse lookup of roomMap)
            var targetGroupId = null;
            for (var gId in roomMap) {
                if (roomMap[gId] === roomId) { targetGroupId = gId; break; }
            }
            if (!targetGroupId) {
                alert('Erreur: Pièce introuvable dans le calculateur');
                return;
            }

            var status = document.getElementById('captureStatus');
            var btn = document.getElementById('btnConfirmCapture');

            try {
                btn.disabled = true;
                status.style.display = 'block';
                status.style.background = '#e3f2fd';
                status.style.color = '#1565c0';
                status.textContent = 'Capture en cours...';

                // Render page at high resolution (scale=3 for ~300 DPI)
                var page = await pdfDoc.getPage(pdfCurrentPage);
                var viewport = page.getViewport({ scale: 3.0, rotation: pdfRotation });

                var canvas = document.createElement('canvas');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                var ctx = canvas.getContext('2d');

                await page.render({ canvasContext: ctx, viewport: viewport }).promise;

                status.textContent = 'Compression de l\'image...';

                var blob = await new Promise(function(resolve) {
                    canvas.toBlob(function(b) { resolve(b); }, 'image/jpeg', 0.85);
                });

                // Close the capture modal and open the crop modal
                closeCaptureRoomModal();

                // Store source metadata for the upload
                var sourceMetadata = {
                    type: 'pdf_plan',
                    plan_id: currentPlanRecord.id,
                    page_number: pdfCurrentPage,
                    pdf_filename: currentPlanRecord.file_name,
                    pdf_version: currentPlanRecord.version_number,
                    captured_at: new Date().toISOString(),
                    scale: 3.0
                };

                // Open the main crop modal — reuses existing crop + upload flow
                openCropModal(blob, targetGroupId);
                cropState.sourceMetadata = sourceMetadata;

            } catch (err) {
                console.error('Capture error:', err);
                status.style.background = '#ffebee';
                status.style.color = '#c62828';
                status.textContent = 'Erreur: ' + err.message;
                btn.disabled = false;
            }
        }

        // toggleClientView removed — Présentation handles client mode directly

        async function toggleLang() {
            var btn = document.getElementById('btnLang');
            if (currentLang === 'fr') {
                // Switching to EN — check if translation needed
                var stale = collectStaleFrTexts();
                if (stale.length > 0) {
                    if (btn) { btn.disabled = true; btn.textContent = 'Traduction...'; }
                    try {
                        var results = await callEdgeFunction(stale, 'translate');
                        applyTranslations(results);
                        showSaveIndicator();
                    } catch (err) {
                        console.error('Translation error:', err);
                        var tMsg = err.message || '';
                        if (/overload/i.test(tMsg) || /529/.test(tMsg)) tMsg = 'Le service AI est temporairement surchargé. Réessayez dans quelques secondes.';
                        steleAlert(tMsg, 'Erreur de traduction');
                        if (btn) { btn.disabled = false; btn.textContent = 'EN'; }
                        return; // stay on FR
                    }
                }
                currentLang = 'en';
            } else {
                currentLang = 'fr';
            }
            if (btn) {
                btn.textContent = currentLang === 'fr' ? 'EN' : 'FR';
                btn.classList.toggle('active', currentLang === 'en');
                btn.disabled = false;
            }
            renderPreview();
        }

        // Collect only FR texts that have no EN translation (stale or missing)
        function collectStaleFrTexts() {
            var texts = [];
            var groups = document.querySelectorAll('#calculatorView .furniture-group');
            groups.forEach(function(g) {
                var gid = g.id;
                if (roomDescEN[gid]) return; // already has EN translation
                var frText;
                if (roomDescHTML[gid]) {
                    frText = roomDescHTML[gid];
                } else {
                    var descEl = document.getElementById(gid + '-clientDesc');
                    frText = descEl ? descEl.value.trim() : '';
                }
                if (frText) {
                    texts.push({ key: 'room_' + gid, text: frText });
                }
            });
            var clauses = getSubmissionClauses();
            clauses.forEach(function(c, i) {
                if (c.content && c.content.trim() && !c.content_en) {
                    texts.push({ key: 'clause_' + i, text: c.content });
                }
            });
            return texts;
        }

        // Apply translation results to memory + DB
        function applyTranslations(results) {
            var groups = document.querySelectorAll('#calculatorView .furniture-group');
            groups.forEach(function(g) {
                var gid = g.id;
                var key = 'room_' + gid;
                if (results[key]) {
                    roomDescEN[gid] = results[key];
                    if (roomMap[gid]) {
                        updateRoom(roomMap[gid], { client_description_en: results[key] });
                    }
                }
            });
            var clauses = getSubmissionClauses();
            var updated = clauses.slice();
            var changed = false;
            clauses.forEach(function(c, i) {
                var key = 'clause_' + i;
                if (results[key]) {
                    updated[i].content_en = results[key];
                    changed = true;
                }
            });
            if (changed) saveSubmissionClauses(updated);
        }

        // ── Edge Function helper ──
        async function callEdgeFunction(texts, action) {
            console.log('[AI] Calling edge function:', action, 'with', texts.length, 'texts');
            var resp = await authenticatedFetch(SUPABASE_URL + '/functions/v1/translate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ texts: texts, action: action })
            });
            if (!resp.ok) {
                var errText = await resp.text().catch(function() { return ''; });
                console.error('[AI] Edge function error:', resp.status, errText);
                try { var errObj = JSON.parse(errText); throw new Error(errObj.error || 'Erreur ' + resp.status); }
                catch(e) { if (e.message) throw e; throw new Error('Erreur ' + resp.status + ': ' + errText.substring(0, 200)); }
            }
            var data = await resp.json();
            console.log('[AI] Edge function response:', JSON.stringify(data).substring(0, 500));
            if (!data.translations || Object.keys(data.translations).length === 0) {
                throw new Error('Aucun résultat retourné par l\'AI');
            }
            return data.translations;
        }

        // ── Collect all FR texts (useHtml=true sends HTML for translate, plain for optimize) ──
        function collectFrTexts(useHtml) {
            var texts = [];
            var groups = document.querySelectorAll('#calculatorView .furniture-group');
            groups.forEach(function(g) {
                var gid = g.id;
                var frText;
                if (useHtml && roomDescHTML[gid]) {
                    frText = roomDescHTML[gid]; // HTML for translation
                } else {
                    var descEl = document.getElementById(gid + '-clientDesc');
                    frText = descEl ? descEl.value.trim() : '';
                }
                if (frText) {
                    texts.push({ key: 'room_' + gid, text: frText });
                }
            });
            var clauses = getSubmissionClauses();
            clauses.forEach(function(c, i) {
                if (c.content && c.content.trim()) {
                    texts.push({ key: 'clause_' + i, text: c.content });
                }
            });
            return texts;
        }

        // ── Optimiser tout (FR) ──
        async function optimizeAll() {
            var btn = document.getElementById('btnOptimizeAll');
            if (!btn) return;
            var origText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Optimisation...';

            try {
                var texts = collectFrTexts();
                if (texts.length === 0) { showSaveIndicator(); return; }

                var results = await callEdgeFunction(texts, 'optimize');
                var groups = document.querySelectorAll('#calculatorView .furniture-group');

                // Apply optimized room descriptions (HTML)
                groups.forEach(function(g) {
                    var gid = g.id;
                    var key = 'room_' + gid;
                    if (results[key]) {
                        // Store HTML in memory
                        roomDescHTML[gid] = results[key];
                        if (roomMap[gid]) {
                            updateRoom(roomMap[gid], { client_description: results[key], client_description_en: '' });
                        }
                        // Clear stale EN
                        roomDescEN[gid] = '';
                    }
                });

                // Apply optimized clause texts
                var clauses = getSubmissionClauses();
                var updated = clauses.slice();
                var changed = false;
                clauses.forEach(function(c, i) {
                    var key = 'clause_' + i;
                    if (results[key]) {
                        updated[i].content = results[key];
                        updated[i].content_en = ''; // clear stale EN
                        changed = true;
                    }
                });
                if (changed) await saveSubmissionClauses(updated);

                showSaveIndicator();
                renderPreview();
            } catch (err) {
                console.error('Optimize error:', err);
                var msg = err.message || '';
                if (/overload/i.test(msg) || /529/.test(msg)) msg = 'Le service AI est temporairement surchargé. Réessayez dans quelques secondes.';
                steleAlert(msg, 'Erreur d\'optimisation');
            } finally {
                btn.disabled = false;
                btn.textContent = origText;
            }
        }

        // ── Optimiser un seul champ (bouton ✨ par champ) ──
        async function optimizeText(btnEl) {
            var gid = btnEl.getAttribute('data-group-id');
            if (!gid) return;
            var descDiv = btnEl.parentElement.querySelector('.pv-page-room-desc');
            if (!descDiv || !descDiv.textContent.trim()) return;

            btnEl.disabled = true;
            var origText = btnEl.textContent;
            btnEl.textContent = '...';

            try {
                // Send plain text to AI, receive HTML back
                var results = await callEdgeFunction(
                    [{ key: 'room_' + gid, text: descDiv.textContent }],
                    'optimize'
                );
                var optimized = results['room_' + gid];
                console.log('[AI] Optimize result for', gid, ':', optimized ? optimized.substring(0, 200) : 'EMPTY');
                if (optimized) {
                    // Save optimized HTML to memory + DB
                    roomDescHTML[gid] = optimized;
                    if (roomMap[gid]) {
                        updateRoom(roomMap[gid], { client_description: optimized, client_description_en: '' });
                    }
                    // Clear stale EN
                    roomDescEN[gid] = '';
                    showSaveIndicator();
                    // Re-render to show optimized HTML
                    renderPreview();
                } else {
                    alert('L\'AI n\'a retourné aucun texte. Vérifiez la console (F12).');
                }
            } catch (err) {
                console.error('Optimize error:', err);
                var oMsg = err.message || '';
                if (/overload/i.test(oMsg) || /529/.test(oMsg)) oMsg = 'Le service AI est temporairement surchargé. Réessayez dans quelques secondes.';
                steleAlert(oMsg, 'Erreur d\'optimisation');
            } finally {
                btnEl.disabled = false;
                btnEl.textContent = origText;
            }
        }

        // ── Traduire tout (FR → EN) ──

        function removePreviewImage(groupId, index) {
            removeGroupImage(groupId, index);
            renderPreview();
        }

        // ── Clause Library CRUD ──

        async function loadClauseLibrary() {
            try {
                var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/quote_clauses?order=sort_order.asc,title.asc&select=*', {});
                if (r.ok) clauseLibrary = await r.json();
            } catch (e) { console.error('loadClauseLibrary error:', e); }
        }

        function renderClauseLibrary() {
            var container = document.getElementById('pvClauseList');
            if (!container) return;

            if (clauseLibrary.length === 0) {
                container.innerHTML = '<p class="pv-clause-empty">Aucune clause dans la biblioth\u00e8que. Cliquez + pour en cr\u00e9er.</p>';
                return;
            }

            var html = '';
            clauseLibrary.forEach(function(clause, idx) {
                html += '<div class="pv-clause-item" draggable="true" data-clause-idx="' + idx + '"';
                html += ' ondragstart="onClauseDragStart(event, ' + idx + ')">';
                html += '<div class="pv-clause-item-header">';
                html += '<span class="pv-clause-item-title">' + escapeHtml(clause.title) + '</span>';
                html += '<span class="pv-clause-item-btns">';
                html += '<button class="pv-clause-item-btn add-to-sub" onclick="event.stopPropagation(); addClauseToSubmission(' + idx + ')" title="Ajouter \u00e0 la soumission">+</button>';
                html += '<button class="pv-clause-item-btn" onclick="showClauseEditor(\'' + clause.id + '\')" title="Modifier">\u270E</button>';
                html += '<button class="pv-clause-item-btn delete" onclick="deleteLibraryClause(\'' + clause.id + '\')" title="Supprimer">\u2715</button>';
                html += '</span>';
                html += '</div>';
                var preview = (clause.content_fr || '').substring(0, 120);
                if (preview) html += '<div class="pv-clause-item-preview">' + escapeHtml(preview) + '</div>';
                html += '</div>';
            });
            container.innerHTML = html;
        }

        function showClauseEditor(clauseId) {
            var zone = document.getElementById('pvClauseEditZone');
            if (!zone) return;

            var clause = clauseId ? clauseLibrary.find(function(c) { return c.id === clauseId; }) : null;
            var isNew = !clause;

            zone.innerHTML = '<div class="pv-clause-edit">' +
                '<label>Titre</label>' +
                '<input type="text" id="ceTitle" value="' + escapeAttr(clause ? clause.title : '') + '" placeholder="Ex: Dessins d\'atelier">' +
                '<label>Contenu</label>' +
                '<textarea id="ceFr" rows="5" placeholder="Texte de la clause...">' + escapeHtml(clause ? clause.content_fr : '') + '</textarea>' +
                '<div class="pv-clause-edit-btns">' +
                '<button class="cancel" onclick="closeClauseEditor()">Annuler</button>' +
                '<button class="save" onclick="saveLibraryClause(' + (isNew ? 'null' : "'" + clauseId + "'") + ')">' + (isNew ? 'Cr\u00e9er' : 'Sauvegarder') + '</button>' +
                '</div></div>';

            zone.querySelector('#ceTitle').focus();
        }

        function closeClauseEditor() {
            var zone = document.getElementById('pvClauseEditZone');
            if (zone) zone.innerHTML = '';
        }

        async function saveLibraryClause(clauseId) {
            var title = document.getElementById('ceTitle').value.trim();
            var fr = document.getElementById('ceFr').value.trim();
            if (!title) { document.getElementById('ceTitle').focus(); return; }

            var payload = { title: title, content_fr: fr };

            try {
                var r;
                if (clauseId) {
                    r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/quote_clauses?id=eq.' + clauseId, {
                        method: 'PATCH', headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                        body: JSON.stringify(payload)
                    });
                } else {
                    r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/quote_clauses', {
                        method: 'POST', headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                        body: JSON.stringify(payload)
                    });
                }

                if (r.ok) {
                    closeClauseEditor();
                    await loadClauseLibrary();
                    renderClauseLibrary();
                    showSaveIndicator();
                }
            } catch (e) { console.error('saveLibraryClause error:', e); }
        }

        async function deleteLibraryClause(clauseId) {
            if (!confirm('Supprimer cette clause de la biblioth\u00e8que ?')) return;
            try {
                var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/quote_clauses?id=eq.' + clauseId, { method: 'DELETE' });
                if (r.ok) {
                    await loadClauseLibrary();
                    renderClauseLibrary();
                    showSaveIndicator();
                }
            } catch (e) { console.error('deleteLibraryClause error:', e); }
        }

        // ── Submission Clauses (JSONB on submissions) ──

        function getSubmissionClauses() {
            if (!currentSubmission) return [];
            return currentSubmission.clauses || [];
        }

        async function saveSubmissionClauses(clauses) {
            if (!currentSubmission) return;
            currentSubmission.clauses = clauses;
            await updateSubmission(currentSubmission.id, { clauses: clauses });
            showSaveIndicator();
        }

        async function addClauseToSubmission(clauseIdx) {
            var lib = clauseLibrary[clauseIdx];
            if (!lib) return;
            var clauses = getSubmissionClauses().slice();
            // Avoid duplicate by id
            if (clauses.some(function(c) { return c.clause_id === lib.id; })) return;
            clauses.push({
                clause_id: lib.id,
                title: lib.title,
                content: lib.content_fr,
                content_en: lib.content_en || '',
                sort_order: clauses.length
            });
            await saveSubmissionClauses(clauses);
            renderPreview();
        }

        async function removeClauseFromSubmission(idx) {
            var clauses = getSubmissionClauses().slice();
            clauses.splice(idx, 1);
            // Re-index sort_order
            clauses.forEach(function(c, i) { c.sort_order = i; });
            await saveSubmissionClauses(clauses);
            renderPreview();
        }

        async function updateClauseText(idx, newText) {
            var clauses = getSubmissionClauses().slice();
            if (clauses[idx]) {
                clauses[idx].content = newText;
                await saveSubmissionClauses(clauses);
            }
        }

        async function updateClauseTextEN(idx, newText) {
            var clauses = getSubmissionClauses().slice();
            if (clauses[idx]) {
                clauses[idx].content_en = newText;
                await saveSubmissionClauses(clauses);
            }
        }

        async function saveClauseBackToLibrary(idx) {
            var clauses = getSubmissionClauses();
            var c = clauses[idx];
            if (!c) return;

            // If came from library, update it; otherwise create new
            if (c.clause_id) {
                var existing = clauseLibrary.find(function(lib) { return lib.id === c.clause_id; });
                if (existing) {
                    await authenticatedFetch(SUPABASE_URL + '/rest/v1/quote_clauses?id=eq.' + c.clause_id, {
                        method: 'PATCH', headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                        body: JSON.stringify({ title: c.title, content_fr: c.content, content_en: c.content_en || '' })
                    });
                    await loadClauseLibrary();
                    renderClauseLibrary();
                    showSaveIndicator();
                    return;
                }
            }

            // Create new in library
            await authenticatedFetch(SUPABASE_URL + '/rest/v1/quote_clauses', {
                method: 'POST', headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                body: JSON.stringify({ title: c.title, content_fr: c.content, content_en: c.content_en || '' })
            });
            await loadClauseLibrary();
            renderClauseLibrary();
            showSaveIndicator();
        }

        // ── Drag and Drop ──

        var draggedClauseIdx = null;

        function onClauseDragStart(e, idx) {
            draggedClauseIdx = idx;
            e.dataTransfer.effectAllowed = 'copy';
            e.dataTransfer.setData('text/plain', idx.toString());
            e.target.classList.add('dragging');
            setTimeout(function() { e.target.classList.remove('dragging'); }, 200);
        }

        function onClauseDropZoneDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
            e.currentTarget.classList.add('drag-over');
        }

        function onClauseDropZoneDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function onClauseDropZoneDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            var idx = parseInt(e.dataTransfer.getData('text/plain'), 10);
            if (!isNaN(idx)) addClauseToSubmission(idx);
            draggedClauseIdx = null;
        }

        // ── Render Preview ──

        async function loadAcceptanceProof(submissionId) {
            if (!currentSubmission) return null;
            var s = currentSubmission.status;
            if (s !== 'accepted') return null;

            try {
                // Essayer acceptation en ligne (public_quote_tokens)
                var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/public_quote_tokens?submission_id=eq.' + submissionId + '&select=accepted_at,accepted_by_name,accepted_by_email,accepted_from_ip,signature_data');
                if (r.ok) {
                    var tokens = await r.json();
                    var accepted = tokens.find(function(t) { return t.accepted_at; });
                    if (accepted) return Object.assign({ method: 'online' }, accepted);
                }

                // Essayer acceptation hors-ligne via submission_reviews
                var r2 = await authenticatedFetch(SUPABASE_URL + '/rest/v1/submission_reviews?submission_id=eq.' + submissionId + '&action=eq.offline_accepted&order=created_at.desc&limit=1&select=comment,created_at');
                if (r2.ok) {
                    var reviews = await r2.json();
                    if (reviews.length > 0) return { method: 'offline', comment: reviews[0].comment, created_at: reviews[0].created_at };
                }
            } catch (e) {
                console.error('Erreur chargement preuve acceptation:', e);
            }
            return null;
        }

        // ═══════════════════════════════════════════════════════════════════════
        // SNAPSHOT — Fige le HTML de la soumission à l'approbation/envoi
        // ═══════════════════════════════════════════════════════════════════════

        var SNAPSHOT_CSS = ':root{--sw-navy:#0B1220;--sw-text:#0F172A;--sw-border:#E2E8F0}\n' +
            '*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}\n' +
            'body{font-family:"Segoe UI",system-ui,-apple-system,sans-serif;background:#fff;color:var(--sw-text);line-height:1.5}\n' +
            '.pv-content{display:flex;flex-direction:column;gap:40px;max-width:1200px;margin:0 auto;padding:40px 0}\n' +
            '.pv-page{background:#fff;padding:36px 32px;aspect-ratio:11/8.5;overflow:hidden;position:relative;display:flex;flex-direction:column;box-shadow:0 2px 12px rgba(0,0,0,0.08);border-radius:4px}\n' +
            '.pv-page-title{position:relative;padding:32px;overflow:hidden;background:#fff}\n' +
            '.pv-cover-right{position:absolute;inset:32px;z-index:0;background:#0F1C2D;overflow:hidden;border-radius:4px}\n' +
            '.pv-cover-right img{width:100%;height:100%;object-fit:cover;display:block}\n' +
            '.pv-cover-right .pv-cover-overlay{position:absolute;inset:0;border-radius:4px;background:linear-gradient(to bottom,rgba(0,0,0,0.25),rgba(0,0,0,0.35))}\n' +
            '.pv-cover-left{position:relative;z-index:1;width:100%;display:flex;flex-direction:column;justify-content:flex-start;padding:clamp(24px,3vw,48px);min-height:100%;background:transparent;text-align:left}\n' +
            '.pv-cover-brand{font-size:12px;text-transform:uppercase;letter-spacing:0.08em;color:rgba(255,255,255,0.7);margin-bottom:16px}\n' +
            '.pv-cover-left .pv-project-name{font-size:34px;font-weight:600;color:#FFFFFF;line-height:1.2;margin-bottom:6px}\n' +
            '.pv-cover-left .pv-client-name{font-size:14px;font-weight:400;color:rgba(255,255,255,0.8);line-height:1.6;margin-bottom:0}\n' +
            '.pv-cover-left .pv-client-address{font-size:14px;font-weight:400;color:rgba(255,255,255,0.8);line-height:1.6;margin-bottom:0}\n' +
            '.pv-cover-left .pv-cover-divider{width:40px;height:2px;background:rgba(255,255,255,0.3);margin:24px 0}\n' +
            '.pv-cover-left .pv-sub-number{font-size:13px;font-weight:500;color:#FFFFFF;margin-bottom:2px}\n' +
            '.pv-cover-left .pv-sub-date{font-size:13px;color:rgba(255,255,255,0.7)}\n' +
            '.pv-cover-logo{position:absolute;bottom:calc(32px + clamp(24px,3vw,48px));left:calc(32px + clamp(24px,3vw,48px));max-width:140px;z-index:1}\n' +
            '.pv-cover-logo img{width:100%;height:auto;display:block}\n' +
            '.pv-install-banner{font-size:12px;color:rgba(255,255,255,0.7);margin-top:60px;letter-spacing:0.3px}\n' +
            '.pv-install-room-note{font-size:11px;color:#999;font-style:italic;margin-top:-30px;margin-bottom:20px;padding-left:20px}\n' +
            '.pv-install-total-note{font-size:13px;color:#999;margin-bottom:16px;letter-spacing:0.3px}\n' +
            '.pv-page-room-header{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;background:var(--sw-navy);color:#fff;border-radius:0;margin:0 0 38px 0;flex-shrink:0}\n' +
            '.pv-room-separator{border-bottom:1px solid #E5E7EB;flex-shrink:0}\n' +
            '.pv-page-room-name{font-size:17px;font-weight:600;letter-spacing:0.3px}\n' +
            '.pv-page-room-subtotal{font-size:17px;font-weight:700}\n' +
            '.pv-page-room-body{flex:1;display:flex;gap:38px;overflow:hidden;min-height:0}\n' +
            '.pv-page-room-text{flex:1;display:flex;flex-direction:column;overflow:hidden;justify-content:center}\n' +
            '.pv-page-room-media{flex:1;display:grid;grid-template-columns:repeat(2,1fr);gap:8px;align-content:center;max-height:100%}\n' +
            '.pv-page-room-media.imgs-1{grid-template-columns:1fr}\n' +
            '.pv-page-room-media.imgs-2{grid-template-columns:1fr;gap:38px}\n' +
            '.pv-page-room-media.imgs-3{gap:8px}\n' +
            '.pv-page-room-media.imgs-3 .pv-img-wrap:first-child{grid-column:1/-1}\n' +
            '.pv-page-room-media .pv-img-wrap{overflow:hidden;min-height:0;border-radius:4px}\n' +
            '.pv-page-room-media .pv-img-wrap img{width:100%;height:100%;object-fit:cover;display:block}\n' +
            '.pv-page-room-desc{width:100%;border:none;border-radius:4px;padding:10px 12px;font-size:13px;line-height:1.5;color:#444;font-family:inherit;flex:1;min-height:60px;background:transparent}\n' +
            '.pv-page-room-desc p{margin:0 0 6px 0}\n' +
            '.pv-page-room-desc ul{margin:4px 0 8px 0;padding-left:20px}\n' +
            '.pv-page-room-desc li{margin-bottom:2px}\n' +
            '.pv-page-room-desc strong{font-weight:700}\n' +
            '.pv-page-clauses-header{font-size:12px;text-transform:uppercase;letter-spacing:1px;color:var(--sw-navy);font-weight:700;margin-bottom:14px;padding-bottom:6px;border-bottom:2px solid var(--sw-navy)}\n' +
            '.pv-page-clauses-body{flex:1;overflow:hidden}\n' +
            '.pv-page-clause{margin-bottom:8px;padding:6px 14px;border-left:3px solid var(--sw-navy);background:#fafafa;border-radius:0 3px 3px 0}\n' +
            '.pv-page-clause-title{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.3px;margin-bottom:2px}\n' +
            '.pv-page-clause-text{width:100%;border:none;border-radius:3px;padding:2px 4px;font-size:12px;line-height:1.3;color:#555;font-family:inherit;resize:none;background:transparent}\n' +
            '.pv-page-clause-actions{display:none}\n' +
            '.pv-page-total{justify-content:center;align-items:center;text-align:center}\n' +
            '.pv-total-box{padding:36px 56px;background:var(--sw-text);color:#fff;border-radius:6px}\n' +
            '.pv-total-box .total-label{font-size:16px;font-weight:300;text-transform:uppercase;letter-spacing:2px;margin-bottom:10px;opacity:0.8}\n' +
            '.pv-total-box .total-amount{font-size:42px;font-weight:700}\n' +
            '.pv-total-box .total-taxes{font-size:13px;opacity:0.6;margin-top:6px}\n' +
            '.pv-page-footer-text{margin-top:32px;font-size:12px;color:#aaa;letter-spacing:0.5px}\n' +
            '.pv-page-steps{padding:32px 32px}\n' +
            '.pv-steps-title{font-size:12px;text-transform:uppercase;letter-spacing:1px;color:var(--sw-navy);font-weight:700;margin-bottom:20px;padding-bottom:6px;border-bottom:2px solid var(--sw-navy)}\n' +
            '.pv-steps-grid{flex:1;display:grid;grid-template-columns:1fr 1fr;grid-template-rows:repeat(4,1fr);gap:10px 48px;grid-auto-flow:column}\n' +
            '.pv-step{display:flex;gap:16px;align-items:flex-start}\n' +
            '.pv-step-circle{width:64px;height:64px;min-width:64px;border-radius:50%;color:#fff;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:700;margin-top:2px}\n' +
            '.pv-step-content{flex:1;min-width:0}\n' +
            '.pv-step-label{font-size:12px;font-weight:700;text-transform:uppercase;letter-spacing:0.3px;color:var(--sw-text);margin-bottom:4px}\n' +
            '.pv-step-desc{font-size:11px;line-height:1.45;color:#555}\n' +
            '@media print{.pv-page{box-shadow:none;page-break-after:always;border-radius:0}}';

        function generateSnapshotHtml(pagesHtml) {
            return '<!DOCTYPE html>\n<html lang="fr">\n<head>\n' +
                '<meta charset="UTF-8">\n' +
                '<meta name="viewport" content="width=device-width, initial-scale=1.0">\n' +
                '<title>Soumission #' + escapeHtml((currentSubmission ? currentSubmission.submission_number : '') + '') + '</title>\n' +
                '<style>\n' + SNAPSHOT_CSS + '\n</style>\n' +
                '</head>\n<body>\n' +
                '<div class="pv-content">\n' + pagesHtml + '\n</div>\n' +
                '</body>\n</html>';
        }

        async function uploadSnapshot(submissionId) {
            if (!submissionId) return;
            try {
                // Render preview to get HTML
                await loadCoverImage();
                await renderPreview();
                var container = document.getElementById('pvContent');
                if (!container) return;
                var pagesHtml = container.innerHTML;

                // Remove interactive elements from snapshot
                var tempDiv = document.createElement('div');
                tempDiv.innerHTML = pagesHtml;
                // Remove edit buttons, delete buttons, dropzones, optimize buttons
                tempDiv.querySelectorAll('.pv-img-delete, .pv-img-badge-client, .pv-page-clause-actions, .pv-clause-dropzone, .pv-optimize-btn, button').forEach(function(el) { el.remove(); });
                // Make contenteditable divs static
                tempDiv.querySelectorAll('[contenteditable]').forEach(function(el) { el.removeAttribute('contenteditable'); });
                // Make textareas into divs
                tempDiv.querySelectorAll('textarea').forEach(function(ta) {
                    var div = document.createElement('div');
                    div.className = ta.className;
                    div.textContent = ta.value;
                    ta.parentNode.replaceChild(div, ta);
                });
                var cleanHtml = tempDiv.innerHTML;

                var snapshotHtml = generateSnapshotHtml(cleanHtml);
                var blob = new Blob([snapshotHtml], { type: 'text/html' });

                // Upload to Storage
                var filePath = submissionId + '.html';
                var r = await authenticatedFetch(SUPABASE_URL + '/storage/v1/object/submission-snapshots/' + filePath, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'text/html', 'x-upsert': 'true' },
                    body: blob
                });
                if (!r.ok) {
                    // Try POST if PUT fails
                    r = await authenticatedFetch(SUPABASE_URL + '/storage/v1/object/submission-snapshots/' + filePath, {
                        method: 'POST',
                        headers: { 'Content-Type': 'text/html', 'x-upsert': 'true' },
                        body: blob
                    });
                }
                if (r.ok) {
                    console.log('Snapshot saved for submission', submissionId);
                } else {
                    console.warn('Snapshot upload failed:', await r.text());
                }
            } catch (e) {
                console.warn('Error creating snapshot:', e);
            }
        }

        function getSnapshotUrl(submissionId) {
            return SUPABASE_URL + '/storage/v1/object/public/submission-snapshots/' + submissionId + '.html';
        }

        async function loadCoverImage() {
            if (coverImageUrl !== null) return; // already loaded
            try {
                var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/app_config?key=eq.cover_image&select=value', {});
                if (r.ok) {
                    var rows = await r.json();
                    if (rows.length > 0 && rows[0].value) coverImageUrl = rows[0].value;
                    else coverImageUrl = '';
                }
            } catch (e) { coverImageUrl = ''; }
        }

        var _snapshotRendered = false; // flag to prevent snapshot re-render loop from uploadSnapshot

        async function renderPreview() {
            await loadCoverImage();
            var container = document.getElementById('pvContent');
            var subLabel = document.getElementById('pvSubNumber');
            if (!container) return;

            if (subLabel && currentSubmission) {
                subLabel.textContent = t('soumission') + ' #' + (currentSubmission.submission_number || '');
            }

            // For approved+ submissions in client view, try to load snapshot
            var s = currentSubmission ? currentSubmission.status : 'draft';
            var isLocked = s !== 'draft' && s !== 'returned' && s !== 'pending_internal';
            if (isLocked && clientViewMode && !_snapshotRendered) {
                try {
                    var snapUrl = getSnapshotUrl(currentSubmission.id);
                    var snapResp = await fetch(snapUrl, { method: 'GET' });
                    if (snapResp.ok) {
                        var snapHtml = await snapResp.text();
                        // Extract body content from snapshot
                        var bodyMatch = snapHtml.match(/<body[^>]*>([\s\S]*)<\/body>/i);
                        if (bodyMatch) {
                            container.innerHTML = bodyMatch[1];
                            _snapshotRendered = true;
                            return;
                        }
                    }
                } catch (e) { /* snapshot not available, render live */ }
            }
            _snapshotRendered = false;

            var html = '';
            var editable = currentSubmission && (currentSubmission.status === 'draft' || currentSubmission.status === 'returned');

            // ── Load acceptance proof ──
            var acceptanceProofHtml = '';
            if (currentSubmission) {
                var proof = await loadAcceptanceProof(currentSubmission.id);
                if (proof) {
                    acceptanceProofHtml += '<div style="position:absolute;top:10px;left:20px;background:#e8f5e9;border:1px solid var(--sw-navy);border-radius:8px;padding:12px 16px;max-width:320px;font-size:11px;line-height:1.6;z-index:1;">';
                    acceptanceProofHtml += '<div style="font-weight:700;font-size:13px;color:var(--sw-navy);margin-bottom:6px;">Soumission accept\u00e9e</div>';
                    if (proof.method === 'online') {
                        acceptanceProofHtml += '<div><strong>M\u00e9thode :</strong> Signature en ligne</div>';
                        if (proof.accepted_by_name) acceptanceProofHtml += '<div><strong>Nom :</strong> ' + escapeHtml(proof.accepted_by_name) + '</div>';
                        if (proof.accepted_by_email) acceptanceProofHtml += '<div><strong>Courriel :</strong> ' + escapeHtml(proof.accepted_by_email) + '</div>';
                        if (proof.accepted_at) acceptanceProofHtml += '<div><strong>Date :</strong> ' + new Date(proof.accepted_at).toLocaleString('fr-CA') + '</div>';
                        if (proof.accepted_from_ip) acceptanceProofHtml += '<div><strong>IP :</strong> ' + escapeHtml(proof.accepted_from_ip) + '</div>';
                        if (proof.signature_data) acceptanceProofHtml += '<div style="margin-top:8px;"><img src="' + proof.signature_data + '" style="max-width:200px;border:1px solid #ccc;border-radius:4px;" alt="Signature"></div>';
                    } else {
                        acceptanceProofHtml += '<div><strong>M\u00e9thode :</strong> Hors-ligne</div>';
                        if (proof.comment) acceptanceProofHtml += '<div style="margin-top:2px;color:#555;">' + escapeHtml(proof.comment) + '</div>';
                        if (proof.created_at) acceptanceProofHtml += '<div><strong>Date :</strong> ' + new Date(proof.created_at).toLocaleString('fr-CA') + '</div>';
                    }
                    acceptanceProofHtml += '</div>';
                }
            }

            // ── Pre-scan installation status ──
            var pvGroups = document.querySelectorAll('#calculatorView .furniture-group');
            var installExcludedIds = {};
            var totalGroups = 0;
            pvGroups.forEach(function(g) {
                totalGroups++;
                var cb = document.getElementById(g.id + '-install');
                if (cb && !cb.checked) installExcludedIds[g.id] = true;
            });
            var excludedCount = Object.keys(installExcludedIds).length;
            var allInstallExcluded = totalGroups > 0 && excludedCount === totalGroups;
            var someInstallExcluded = excludedCount > 0 && !allInstallExcluded;

            // ── Page 1: Title ──
            var subNum = currentSubmission ? currentSubmission.submission_number : '';
            var subDate = '';
            if (currentSubmission) {
                var d = currentSubmission.sent_at || currentSubmission.approved_at || currentSubmission.created_at;
                if (d) {
                    var dt = new Date(d);
                    var loc = currentLang === 'en' ? 'en-CA' : 'fr-CA';
                    subDate = dt.toLocaleDateString(loc, { year: 'numeric', month: 'long', day: 'numeric' });
                }
            }
            // Build address from new columns with fallback
            var coverAddr = '';
            if (currentProject) {
                var ap = [];
                var pa = currentProject.project_address || currentProject._address || '';
                var pc = currentProject.project_city || currentProject._city || '';
                var pp = currentProject.project_postal_code || currentProject._postal || '';
                if (!pa && !pc && !pp && currentProject.client_address) pa = currentProject.client_address;
                if (pa) ap.push(escapeHtml(pa));
                if (pc) ap.push(escapeHtml(pc));
                if (pp) ap.push(escapeHtml(pp));
                coverAddr = ap.join(', ');
            }

            // Build separate address lines
            var coverAddrLine = '';
            var coverCityPostal = '';
            if (currentProject) {
                var pa = currentProject.project_address || currentProject._address || '';
                var pcity = currentProject.project_city || currentProject._city || '';
                var ppost = currentProject.project_postal_code || currentProject._postal || '';
                if (!pa && !pcity && !ppost && currentProject.client_address) pa = currentProject.client_address;
                coverAddrLine = pa;
                var cp = [];
                if (pcity) cp.push(pcity);
                if (ppost) cp.push(ppost);
                coverCityPostal = cp.join(', ');
            }

            html += '<div class="pv-page pv-page-title">';
            html += '<div class="pv-cover-right">';
            if (coverImageUrl) {
                html += '<img src="' + escapeAttr(coverImageUrl) + '" alt="">';
            }
            html += '<div class="pv-cover-overlay"></div>';
            html += '</div>';
            html += '<div class="pv-cover-left">';
            html += acceptanceProofHtml;
            html += '<div class="pv-cover-brand">stele</div>';
            if (currentProject) {
                html += '<div class="pv-project-name">' + escapeHtml(currentProject.name || '') + '</div>';
                html += '<div class="pv-client-name">' + escapeHtml(currentProject.client_name || '') + '</div>';
                if (coverAddrLine) html += '<div class="pv-client-address">' + escapeHtml(coverAddrLine) + '</div>';
                if (coverCityPostal) html += '<div class="pv-client-address">' + escapeHtml(coverCityPostal) + '</div>';
            }
            html += '<div class="pv-cover-divider"></div>';
            html += '<div class="pv-sub-number">' + t('soumission') + ' #' + escapeHtml(subNum + '') + '</div>';
            if (subDate) html += '<div class="pv-sub-date">' + escapeHtml(subDate) + '</div>';
            if (allInstallExcluded) html += '<div class="pv-install-banner">' + (currentLang === 'en' ? 'Installation not included' : 'Installation non incluse') + '</div>';
            html += '</div>';
            html += '<div class="pv-cover-logo"><img src="' + SUPABASE_URL + '/storage/v1/object/public/assets/logo_white.png" alt="stele" onerror="this.parentElement.style.display=\'none\'"></div>';
            html += '</div>';

            // ── Room pages (one per room) — text left, images right ──
            var grandTotal = 0;
            var groups = document.querySelectorAll('#calculatorView .furniture-group');
            groups.forEach(function(group) {
                var groupId = group.id;
                var nameInput = group.querySelector('.furniture-name-input');
                var roomName = nameInput ? nameInput.value : 'Sans nom';

                var subtotal = 0;
                group.querySelectorAll('.calc-row').forEach(function(row) {
                    subtotal += getRowTotal(row);
                });
                grandTotal += subtotal;

                var allImgs = groupImages[groupId] || [];
                var imgs = allImgs.filter(function(img) { return img.showInQuote; });
                var descEl = document.getElementById(groupId + '-clientDesc');
                var descPlain = descEl ? descEl.value : '';
                var descFr = roomDescHTML[groupId] || descPlain;
                var descEn = roomDescEN[groupId] || '';
                var desc = currentLang === 'en' ? (descEn || descFr) : descFr;
                var hasImages = imgs.length > 0;

                html += '<div class="pv-page" data-group-id="' + escapeAttr(groupId) + '">';
                html += '<div class="pv-page-room-header"><span class="pv-page-room-name">' + escapeHtml(roomName) + '</span><span class="pv-page-room-subtotal">' + formatPrice(subtotal) + '</span></div>';
                if (someInstallExcluded && installExcludedIds[groupId]) {
                    html += '<div class="pv-install-room-note">' + (currentLang === 'en' ? '* Installation not included for this section' : '* Installation non incluse pour cette section') + '</div>';
                }
                html += '<div class="pv-page-room-body">';

                // Left column: description
                if (hasImages) {
                    html += '<div class="pv-page-room-text" style="position:relative;">';
                    if (editable && currentLang === 'fr') {
                        html += '<button class="pv-optimize-btn" onclick="optimizeText(this)" data-group-id="' + escapeAttr(groupId) + '">&#10024;</button>';
                    }
                    html += '<div class="pv-page-room-desc" data-group-id="' + escapeAttr(groupId) + '"';
                    html += ' data-placeholder="' + escapeAttr(t('descPlaceholder')) + '"';
                    html += ' contenteditable="' + (editable ? 'true' : 'false') + '">';
                    html += textToHtml(desc);
                    html += '</div>';
                    html += '</div>';

                    // Right column: images
                    var imgCount = Math.min(imgs.length, 4);
                    html += '<div class="pv-page-room-media imgs-' + imgCount + '">';
                    imgs.forEach(function(img) {
                        var realIdx = allImgs.indexOf(img);
                        var imgSrc = img.isLegacy ? img.dataUrl : (img.url || img.dataUrl);
                        var ratio = img.cropRatio === '1:1' ? '1/1' : img.cropRatio === '9:16' ? '9/16' : '16/9';
                        html += '<div class="pv-img-wrap">';
                        html += '<img src="' + imgSrc + '" alt="' + escapeAttr(img.name) + '" style="aspect-ratio:' + ratio + ';" onclick="openLightbox(this.src)">';
                        if (editable && !clientViewMode) {
                            html += '<button class="pv-img-delete" onclick="removePreviewImage(\'' + escapeAttr(groupId) + '\', ' + realIdx + ')" title="Supprimer">&times;</button>';
                        }
                        html += '</div>';
                    });
                    html += '</div>';
                } else {
                    // No images — description takes full width
                    html += '<div class="pv-page-room-text" style="flex:1; position:relative;">';
                    if (editable && currentLang === 'fr') {
                        html += '<button class="pv-optimize-btn" onclick="optimizeText(this)" data-group-id="' + escapeAttr(groupId) + '">&#10024;</button>';
                    }
                    html += '<div class="pv-page-room-desc" data-group-id="' + escapeAttr(groupId) + '"';
                    html += ' data-placeholder="' + escapeAttr(t('descPlaceholder')) + '"';
                    html += ' contenteditable="' + (editable ? 'true' : 'false') + '">';
                    html += textToHtml(desc);
                    html += '</div>';
                    html += '</div>';
                }

                html += '</div>';
                html += '<div class="pv-room-separator"></div>';
                html += '</div>';
            });

            // ── Clauses page (compact) ──
            var subClauses = getSubmissionClauses();
            if (subClauses.length > 0 || editable) {
                html += '<div class="pv-page">';
                html += '<div class="pv-page-clauses-header">' + t('clausesTitle') + '</div>';
                html += '<div class="pv-page-clauses-body">';

                subClauses.forEach(function(clause, idx) {
                    html += '<div class="pv-page-clause" data-clause-idx="' + idx + '">';
                    html += '<div class="pv-page-clause-title">' + escapeHtml(clause.title) + '</div>';
                    var clauseText = currentLang === 'en' ? (clause.content_en || clause.content || '') : (clause.content || '');
                    html += '<textarea class="pv-page-clause-text" data-clause-idx="' + idx + '"';
                    html += ' rows="2"' + (editable ? '' : ' disabled') + '>' + escapeHtml(clauseText) + '</textarea>';
                    if (editable) {
                        html += '<div class="pv-page-clause-actions">';
                        html += '<button class="pv-doc-clause-btn save-lib" onclick="saveClauseBackToLibrary(' + idx + ')" title="Sauvegarder dans la biblioth\u00e8que">' + t('biblio') + '</button>';
                        html += '<button class="pv-doc-clause-btn remove" onclick="removeClauseFromSubmission(' + idx + ')" title="Retirer">\u2715</button>';
                        html += '</div>';
                    }
                    html += '</div>';
                });

                if (editable) {
                    html += '<div class="pv-clause-dropzone" id="pvClauseDropZone"';
                    html += ' ondragover="onClauseDropZoneDragOver(event)"';
                    html += ' ondragleave="onClauseDropZoneDragLeave(event)"';
                    html += ' ondrop="onClauseDropZoneDrop(event)">';
                    html += t('dropClause');
                    html += '</div>';
                }

                html += '</div></div>';
            }

            // ── Total page (last) ──
            html += '<div class="pv-page pv-page-total">';
            if (allInstallExcluded) {
                html += '<div class="pv-install-total-note">' + (currentLang === 'en' ? 'Installation not included' : 'Installation non incluse') + '</div>';
            }
            html += '<div class="pv-total-box">';
            html += '<div class="total-label">' + t('total') + '</div>';
            html += '<div class="total-amount">' + formatPrice(grandTotal) + '</div>';
            html += '<div class="total-taxes">' + t('taxes') + '</div>';
            html += '</div>';
            html += '<div class="pv-page-footer-text">' + t('footer') + '</div>';
            html += '</div>';

            // ── Steps page ──
            var steps = t('steps');
            if (steps && Array.isArray(steps)) {
                // Gradient from dark green to light green
                var stepColors = ['#2f3e34','#3a4b3f','#45584a','#4b6050','#5e7462','#718874','#849c86','#97b098'];
                html += '<div class="pv-page pv-page-steps">';
                html += '<div class="pv-steps-title">' + escapeHtml(t('stepsTitle')) + '</div>';
                html += '<div class="pv-steps-grid">';
                steps.forEach(function(step, i) {
                    html += '<div class="pv-step">';
                    html += '<div class="pv-step-circle" style="background:' + stepColors[i] + '">' + (i + 1) + '</div>';
                    html += '<div class="pv-step-content">';
                    html += '<div class="pv-step-label">' + escapeHtml(step.label) + '</div>';
                    html += '<div class="pv-step-desc">' + escapeHtml(step.desc) + '</div>';
                    html += '</div></div>';
                });
                html += '</div></div>';
            }

            // (acceptance proof is on the title page)

            container.innerHTML = html;
            wirePreviewSaveHandlers();
        }

        function wirePreviewSaveHandlers() {
            // Room descriptions — save HTML to correct lang field + stale detection
            document.querySelectorAll('#pvContent .pv-page-room-desc').forEach(function(el) {
                el.addEventListener('blur', function() {
                    var gid = this.getAttribute('data-group-id');
                    if (!gid || !roomMap[gid]) return;
                    var htmlContent = this.innerHTML.trim();
                    if (currentLang === 'en') {
                        roomDescEN[gid] = htmlContent;
                        updateRoom(roomMap[gid], { client_description_en: htmlContent });
                    } else {
                        roomDescHTML[gid] = htmlContent;
                        updateRoom(roomMap[gid], { client_description: htmlContent });
                        var calcDesc = document.getElementById(gid + '-clientDesc');
                        if (calcDesc) calcDesc.value = this.textContent; // plain text for calc textarea
                        // Stale detection: FR changed → clear EN
                        if (roomDescEN[gid]) {
                            roomDescEN[gid] = '';
                            updateRoom(roomMap[gid], { client_description_en: '' });
                        }
                    }
                    showSaveIndicator();
                });
            });

            // Auto-resize clause textareas to fit content
            document.querySelectorAll('#pvContent .pv-page-clause-text').forEach(function(ta) {
                ta.style.height = 'auto';
                ta.style.height = ta.scrollHeight + 'px';
                ta.addEventListener('input', function() { this.style.height = 'auto'; this.style.height = this.scrollHeight + 'px'; });
            });

            // Clause texts — save to correct lang field + stale detection
            document.querySelectorAll('#pvContent .pv-page-clause-text').forEach(function(textarea) {
                textarea.addEventListener('blur', function() {
                    var idx = parseInt(this.getAttribute('data-clause-idx'), 10);
                    if (isNaN(idx)) return;
                    if (currentLang === 'en') {
                        updateClauseTextEN(idx, this.value);
                    } else {
                        updateClauseText(idx, this.value);
                        // Stale detection: FR changed → clear EN
                        var clauses = getSubmissionClauses();
                        if (clauses[idx] && clauses[idx].content_en) {
                            clauses[idx].content_en = '';
                            saveSubmissionClauses(clauses);
                        }
                    }
                });
            });
        }

        // ═══════════════════════════════════════════════════════════════════════
        // MODE PRÉSENTATION (PLEIN ÉCRAN + NAVIGATION PAR PAGE)
        // ═══════════════════════════════════════════════════════════════════════

        var presActive = false;

        function openPresentation() {
            presActive = true;
            // Force client view + render
            clientViewMode = true;
            var pv = document.getElementById('previewView');
            pv.classList.add('pv-client-mode');
            pv.classList.add('pv-fullscreen');
            renderPreview();

            // Scroll to top in fullscreen mode (pv-left is the scrolling element)
            var scrollEl = document.querySelector('#previewView .pv-left');
            if (scrollEl) scrollEl.scrollTop = 0;

            // Request fullscreen on the preview view
            if (pv.requestFullscreen) pv.requestFullscreen();
            else if (pv.webkitRequestFullscreen) pv.webkitRequestFullscreen();
            else if (pv.msRequestFullscreen) pv.msRequestFullscreen();

            document.addEventListener('keydown', presPageNav);
            document.getElementById('pvContent').addEventListener('click', presClickNav);
        }

        function closePresentation() {
            presActive = false;
            var pv = document.getElementById('previewView');
            pv.classList.remove('pv-fullscreen');
            pv.classList.remove('pv-client-mode');
            clientViewMode = false;
            if (document.fullscreenElement) document.exitFullscreen();
            else if (document.webkitFullscreenElement) document.webkitExitFullscreen();
            document.removeEventListener('keydown', presPageNav);
            var pvContent = document.getElementById('pvContent');
            if (pvContent) pvContent.removeEventListener('click', presClickNav);
            renderPreview();
        }

        function presPageNav(e) {
            if (e.key === 'Escape') { closePresentation(); return; }
            var scrollEl = document.querySelector('#previewView .pv-left');
            if (!scrollEl) return;
            var pages = scrollEl.querySelectorAll('.pv-page');
            if (pages.length === 0) return;

            if (e.key === 'ArrowDown' || e.key === 'Enter' || e.key === ' ' || e.key === 'ArrowRight') {
                e.preventDefault();
                presScrollToNext(scrollEl, pages, 1);
            }
            if (e.key === 'ArrowUp' || e.key === 'Backspace' || e.key === 'ArrowLeft') {
                e.preventDefault();
                presScrollToNext(scrollEl, pages, -1);
            }
        }

        function presClickNav(e) {
            // Don't navigate if clicking on interactive elements
            if (e.target.closest('textarea, button, a, input, .pv-img-wrap')) return;
            var scrollEl = document.querySelector('#previewView .pv-left');
            var pages = scrollEl ? scrollEl.querySelectorAll('.pv-page') : [];
            if (pages.length > 0) presScrollToNext(scrollEl, pages, 1);
        }

        function presScrollToNext(scrollEl, pages, direction) {
            var scrollTop = scrollEl.scrollTop;
            var threshold = 20;
            for (var i = 0; i < pages.length; i++) {
                var top = pages[i].offsetTop - scrollEl.offsetTop;
                if (direction > 0 && top > scrollTop + threshold) {
                    pages[i].scrollIntoView({ behavior: 'smooth', block: 'start' });
                    return;
                }
                if (direction < 0 && i > 0 && top >= scrollTop - threshold) {
                    pages[i - 1].scrollIntoView({ behavior: 'smooth', block: 'start' });
                    return;
                }
            }
            // Edge cases: last page forward or first page backward
            if (direction < 0) pages[0].scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Exit presentation when leaving fullscreen
        document.addEventListener('fullscreenchange', function() {
            if (!document.fullscreenElement && presActive) {
                closePresentation();
            }
        });

        // ═══════════════════════════════════════════════════════════════════════
        // NAVIGATION ENTRE VUES
        // ═══════════════════════════════════════════════════════════════════════

        function showProjectList() {
            document.getElementById('projectListView').classList.add('active');
            document.getElementById('calculatorView').classList.remove('active');
            document.getElementById('previewView').classList.remove('active');
            currentProject = null;
            currentSubmission = null;
            roomMap = {};
            itemMap = {};
            groupImages = {};
            roomDescEN = {};
            roomDescHTML = {};
            renderProjectList();
        }

        function showCalculator() {
            document.getElementById('projectListView').classList.remove('active');
            document.getElementById('calculatorView').classList.add('active');
            document.getElementById('previewView').classList.remove('active');
        }

        function backToProjectList() {
            if (isApprovalMode) {
                window.location.href = 'approbation.html';
                return;
            }
            showProjectList();
        }

        // ── Kebab menu ──
        function toggleHeaderKebab(e) {
            e.stopPropagation();
            var dropdown = document.getElementById('headerKebabDropdown');
            var btn = e.currentTarget;
            var isOpen = dropdown.classList.contains('open');
            dropdown.classList.toggle('open');
            btn.classList.toggle('active');
            if (!isOpen) {
                setTimeout(function() {
                    document.addEventListener('click', closeHeaderKebabOnOutside, { once: true });
                }, 0);
            }
        }
        function closeHeaderKebab() {
            var dd = document.getElementById('headerKebabDropdown');
            if (dd) dd.classList.remove('open');
            var btn = document.querySelector('.btn-kebab');
            if (btn) btn.classList.remove('active');
        }
        function closeHeaderKebabOnOutside(e) {
            if (!e.target.closest('.kebab-menu')) closeHeaderKebab();
        }

        function showSaveIndicator() {
            const el = document.getElementById('saveIndicator');
            el.textContent = 'Sauvegardé ✓';
            el.className = 'save-indicator saving';
            clearTimeout(el._timeout);
            el._timeout = setTimeout(() => { el.textContent = ''; el.className = 'save-indicator'; }, 2000);
        }

        // ═══════════════════════════════════════════════════════════════════════
        // RENDU LISTE DE PROJETS
        // ═══════════════════════════════════════════════════════════════════════

        var STATUS_LABELS = {
            'draft': 'Brouillon', 'pending_internal': 'En approbation', 'returned': 'Retourn\u00e9e',
            'approved_internal': 'Pr\u00eate \u00e0 envoyer', 'sent_client': 'Envoy\u00e9e', 'accepted': 'Vendue',
            'lost': 'Perdue',
            // Legacy
            'brouillon': 'Brouillon', 'soumis': 'Soumis', 'approuv\u00e9': 'Approuv\u00e9',
            'envoy\u00e9': 'Envoy\u00e9', 'sign\u00e9': 'Sign\u00e9'
        };

        function updateStatusBadge(status) {
            var badge = document.getElementById('subStatusBadge');
            if (!badge) return;
            var label = STATUS_LABELS[status] || status;
            badge.className = 'status-badge status-' + status;
            var locked = !isSubmissionCurrentlyEditable();
            var prefix = locked ? '\uD83D\uDD12 ' : '';
            if (currentSubmission && currentSubmission.bypass_approval) {
                badge.innerHTML = escapeHtml(prefix + label) + ' <span class="bypass-badge">BYPASS</span>';
            } else {
                badge.textContent = prefix + label;
            }
        }

        function updateStatusTimeline() {
            var container = document.getElementById('statusTimeline');
            if (!container || !currentSubmission) {
                if (container) container.innerHTML = '';
                return;
            }

            var status = currentSubmission.status;

            // Define 6 timeline steps (last step is dynamic: Vendue or Perdue)
            var lastStep = status === 'lost'
                ? { key: 'lost', label: 'Perdue' }
                : { key: 'accepted', label: 'Vendue' };
            var steps = [
                { key: 'draft', label: 'Brouillon' },
                { key: 'pending_internal', label: 'En approbation' },
                { key: 'returned', label: 'Retourn\u00e9e' },
                { key: 'approved_internal', label: 'Pr\u00eate \u00e0 envoyer' },
                { key: 'sent_client', label: 'Envoy\u00e9e' },
                lastStep
            ];

            // Determine step state for each step
            function getStepState(stepKey) {
                if (stepKey === status) return 'active';

                // Special: "returned" is only active when status is returned, otherwise always future
                if (stepKey === 'returned') {
                    return (status === 'returned') ? 'active' : 'future';
                }

                // Linear progression for other steps
                switch (status) {
                    case 'draft':
                        return 'future';
                    case 'pending_internal':
                        return (stepKey === 'draft') ? 'completed' : 'future';
                    case 'returned':
                        return (stepKey === 'draft' || stepKey === 'pending_internal') ? 'completed' : 'future';
                    case 'approved_internal':
                        return (stepKey === 'draft' || stepKey === 'pending_internal') ? 'completed' : 'future';
                    case 'sent_client':
                        return (stepKey === 'draft' || stepKey === 'pending_internal' || stepKey === 'approved_internal') ? 'completed' : 'future';
                    case 'accepted':
                        return (stepKey === 'draft' || stepKey === 'pending_internal' || stepKey === 'approved_internal' || stepKey === 'sent_client') ? 'completed' : 'future';
                    case 'lost':
                        return (stepKey === 'draft' || stepKey === 'pending_internal' || stepKey === 'approved_internal' || stepKey === 'sent_client') ? 'completed' : 'future';
                    default:
                        return 'future';
                }
            }

            var html = '';
            steps.forEach(function(step) {
                var stepState = getStepState(step.key);
                var classNames = 'timeline-step ' + stepState;
                if (step.key === 'returned' && stepState === 'active') classNames += ' returned';
                if (step.key === 'lost' && stepState === 'active') classNames += ' lost';

                // Rendre "Envoyée" cliquable pour copier le lien client
                var isClickable = (status === 'sent_client' && step.key === 'sent_client');
                if (isClickable) classNames += ' clickable';

                var onclick = isClickable ? ' onclick="copyQuoteLink()" title="Cliquer pour copier le lien client"' : '';

                html += '<div class="' + classNames + '"' + onclick + '>';
                html += '<div class="timeline-circle">';
                if (stepState === 'completed') {
                    html += '\u2713'; // checkmark
                } else {
                    html += '&nbsp;';
                }
                html += '</div>';
                html += '<span class="timeline-label">' + escapeHtml(step.label) + '</span>';
                html += '</div>';
            });

            // CTA button at the end
            var cta = null;
            if (status === 'draft' || status === 'returned') {
                if (canBypassApproval) {
                    cta = { text: 'Envoyer au client', action: 'bypassApproval()', className: '', secondaryText: status === 'returned' ? 'Resoumettre' : 'Soumettre', secondaryAction: 'openSubmitModal()', secondaryClassName: status === 'returned' ? 'btn-outline-orange' : 'btn-outline' };
                } else {
                    cta = { text: status === 'returned' ? 'Resoumettre' : 'Soumettre', action: 'openSubmitModal()', className: status === 'returned' ? 'btn-orange' : '' };
                }
            } else if (status === 'pending_internal' && canApproveQuotes) {
                cta = { text: 'Approuver', action: 'approveSubmission()', className: '', secondaryText: 'Retourner', secondaryAction: 'returnSubmission()', secondaryClassName: 'btn-outline-orange' };
            } else if (status === 'approved_internal') {
                cta = { text: 'Envoyer au client', action: 'sendToClient()', className: '' };
            } else if (status === 'sent_client') {
                cta = { text: 'Confirmer la vente', action: 'offlineAcceptance()', className: '', secondaryText: 'Marquer comme perdu', secondaryAction: 'openLostModal()', secondaryClassName: 'btn-outline-red' };
            } else if (status === 'lost') {
                cta = { text: 'Rouvrir', action: 'reopenLostSubmission()', className: 'btn-outline' };
            }

            if (cta) {
                html += '<div class="timeline-cta">';
                if (cta.secondaryText) {
                    html += '<button onclick="' + cta.secondaryAction + '" class="' + (cta.secondaryClassName || '') + '">' + escapeHtml(cta.secondaryText) + '</button> ';
                }
                html += '<button onclick="' + cta.action + '" class="' + (cta.className || '') + '">' + escapeHtml(cta.text) + '</button>';
                html += '</div>';
            }

            container.innerHTML = html;
        }

        // ── Pipeline helpers ──

        function getPipelineStatus(slug) {
            return pipelineStatuses.find(function(s) { return s.slug === slug; }) || { slug: slug, label: slug || '—', color: '#9e9e9e' };
        }

        function getContactByRole(proj, role) {
            if (!proj.project_contacts) return '';
            var candidates = proj.project_contacts.filter(function(pc) { return pc.role === role && pc.contacts; });
            if (candidates.length === 0) return '';
            // Prefer is_primary; if none marked, take first
            var match = candidates.find(function(pc) { return pc.is_primary; }) || candidates[0];
            var c = match.contacts;
            // If contact has a company, show company name
            var companies = (c.contact_companies || []).map(function(cc) { return cc.companies ? cc.companies.name : ''; }).filter(Boolean);
            if (companies.length > 0) return companies[0];
            return ((c.first_name || '') + ' ' + (c.last_name || '')).trim();
        }

        // Full tooltip: contact name + company
        function getContactTooltipByRole(proj, role) {
            if (!proj.project_contacts) return '';
            var candidates = proj.project_contacts.filter(function(pc) { return pc.role === role && pc.contacts; });
            if (candidates.length === 0) return '';
            var match = candidates.find(function(pc) { return pc.is_primary; }) || candidates[0];
            var c = match.contacts;
            var name = ((c.first_name || '') + ' ' + (c.last_name || '')).trim();
            var companies = (c.contact_companies || []).map(function(cc) { return cc.companies ? cc.companies.name : ''; }).filter(Boolean);
            if (companies.length > 0) return name + ' — ' + companies[0];
            return name;
        }

        function getClosestDeadline(proj) {
            var dates = [];
            if (proj.internal_deadline) dates.push(proj.internal_deadline);
            if (proj.client_deadline) dates.push(proj.client_deadline);
            (proj.submissions || []).forEach(function(s) {
                if (s.internal_deadline) dates.push(s.internal_deadline);
                if (s.client_deadline) dates.push(s.client_deadline);
            });
            if (dates.length === 0) return null;
            dates.sort();
            return dates[0];
        }

        function formatMoney(n) {
            if (n == null || isNaN(n)) return '—';
            return parseFloat(n).toLocaleString('fr-CA', { style: 'currency', currency: 'CAD', minimumFractionDigits: 0, maximumFractionDigits: 0 });
        }

        function formatDateShort(d) {
            if (!d) return '\u2014';
            var parts = d.split('-');
            if (parts.length === 3) return parts[2] + '/' + parts[1];
            return d;
        }

        var MONTH_NAMES_FR = ['janv.','f\u00e9vr.','mars','avr.','mai','juin','juil.','ao\u00fbt','sept.','oct.','nov.','d\u00e9c.'];
        function formatMonthYear(m) {
            if (!m) return '\u2014';
            var parts = m.split('-');
            if (parts.length >= 2) {
                var mi = parseInt(parts[1], 10) - 1;
                return (MONTH_NAMES_FR[mi] || parts[1]) + ' ' + parts[0];
            }
            return m;
        }

        // Returns { value: number|null, isOverride: boolean } for a project's display amount
        function getProjectDisplayAmount(p) {
            if (p.amount_override != null) return { value: parseFloat(p.amount_override), isOverride: true };
            // Sum approved_total across submissions
            var total = 0; var hasAny = false;
            (p.submissions || []).forEach(function(s) {
                if (s.approved_total) { total += parseFloat(s.approved_total); hasAny = true; }
            });
            if (hasAny) return { value: total, isOverride: false };
            if (p.estimated_amount != null) return { value: parseFloat(p.estimated_amount), isOverride: false };
            return { value: null, isOverride: false };
        }

        function renderAmountCell(p) {
            var da = getProjectDisplayAmount(p);
            if (da.isOverride) {
                return '<span class="amount-override" data-tooltip="Montant estim\u00e9 manuellement">' + formatMoney(da.value) + '</span>';
            }
            return formatMoney(da.value);
        }

        function startAmountEdit(td, projectId, evt) {
            evt.stopPropagation();
            if (td.querySelector('.amount-inline-input')) return;
            var proj = cachedProjects.find(function(p) { return p.id === projectId; });
            var current = proj && proj.amount_override != null ? String(Math.round(proj.amount_override)) : '';
            td.innerHTML = '<input class="amount-inline-input" type="text" value="' + current + '" placeholder="Montant...">';
            var input = td.querySelector('input');
            input.focus();
            input.select();
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') { input.blur(); }
                if (e.key === 'Escape') { renderCurrentView(); }
            });
            input.addEventListener('blur', function() {
                saveAmountOverride(projectId, input.value.trim());
            });
        }

        async function saveAmountOverride(projectId, rawValue) {
            var val = rawValue.replace(/[^0-9.,]/g, '').replace(',', '.');
            var numericVal = val === '' ? null : parseFloat(val);
            if (val !== '' && isNaN(numericVal)) { renderCurrentView(); return; }
            var proj = cachedProjects.find(function(p) { return p.id === projectId; });
            if (proj) proj.amount_override = numericVal;
            renderCurrentView();
            await updateProject(projectId, { amount_override: numericVal });
        }

        // ── Inline edit helpers ──

        function inlineEditSelect(td, projectId, field, options, currentVal, evt) {
            evt.stopPropagation();
            if (td.querySelector('select')) return;
            var html = '<select class="inline-edit-select">';
            options.forEach(function(opt) {
                var val = typeof opt === 'object' ? opt.value : opt;
                var label = typeof opt === 'object' ? opt.label : opt;
                html += '<option value="' + escapeAttr(val) + '"' + (val === currentVal ? ' selected' : '') + '>' + escapeHtml(label) + '</option>';
            });
            html += '</select>';
            td.innerHTML = html;
            var sel = td.querySelector('select');
            sel.focus();
            sel.addEventListener('change', function() { saveInlineField(projectId, field, sel.value); });
            sel.addEventListener('blur', function() { saveInlineField(projectId, field, sel.value); });
            sel.addEventListener('keydown', function(e) { if (e.key === 'Escape') renderCurrentView(); });
        }

        function inlineEditText(td, projectId, field, currentVal, inputType, evt) {
            evt.stopPropagation();
            if (td.querySelector('input')) return;
            td.innerHTML = '<input class="inline-edit-input" type="' + (inputType || 'text') + '" value="' + escapeAttr(currentVal || '') + '">';
            var input = td.querySelector('input');
            input.focus();
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') input.blur();
                if (e.key === 'Escape') renderCurrentView();
            });
            input.addEventListener('blur', function() { saveInlineField(projectId, field, input.value.trim() || null); });
        }

        function openPriorityDropdown(el, projectId, evt) {
            evt.stopPropagation();
            evt.preventDefault();
            // Close any existing dropdown
            var existing = document.querySelector('.prio-dropdown');
            if (existing) existing.remove();

            var container = el.closest('.name-cell-inner');
            if (!container) return;

            var dd = document.createElement('div');
            dd.className = 'prio-dropdown';
            dd.innerHTML =
                '<div class="prio-dropdown-item" data-val="normal"><span class="prio-dropdown-dot" style="background:#ccc;"></span> Normal</div>' +
                '<div class="prio-dropdown-item" data-val="haute"><span class="prio-dropdown-dot" style="background:#F59E0B;"></span> Haute</div>' +
                '<div class="prio-dropdown-item" data-val="urgente"><span class="prio-dropdown-dot" style="background:#EF4444;"></span> Urgente</div>';
            container.appendChild(dd);

            dd.querySelectorAll('.prio-dropdown-item').forEach(function(item) {
                item.addEventListener('click', function(e) {
                    e.stopPropagation();
                    var val = item.getAttribute('data-val');
                    var proj = cachedProjects.find(function(p) { return p.id === projectId; });
                    if (proj) proj.priority = val;
                    dd.remove();
                    renderCurrentView();
                    updateProject(projectId, { priority: val });
                });
            });

            // Close on outside click
            setTimeout(function() {
                document.addEventListener('click', function closePrio(e) {
                    if (!dd.contains(e.target)) {
                        dd.remove();
                        document.removeEventListener('click', closePrio);
                    }
                });
            }, 0);
        }

        function openStatusDropdown(td, projectId, currentSlug, evt) {
            evt.stopPropagation();
            // Close any existing status dropdown
            var existing = document.querySelector('.status-dropdown');
            if (existing) existing.remove();

            var badge = td.querySelector('.pipeline-badge') || td;
            var rect = badge.getBoundingClientRect();

            var dd = document.createElement('div');
            dd.className = 'status-dropdown';
            dd.setAttribute('tabindex', '-1');

            var focusIdx = -1;
            var items = [];

            pipelineStatuses.forEach(function(s, idx) {
                var isActive = s.slug === currentSlug;
                if (isActive) focusIdx = idx;
                var item = document.createElement('div');
                item.className = 'status-dropdown-item' + (isActive ? ' sd-focused' : '');
                item.setAttribute('data-val', s.slug);
                item.setAttribute('data-idx', idx);
                item.innerHTML =
                    '<span class="sd-dot" style="background:' + s.color + ';"></span>' +
                    '<span class="sd-label">' + escapeHtml(s.label) + '</span>' +
                    '<span class="sd-check">' + (isActive ? '✓' : '') + '</span>';
                dd.appendChild(item);
                items.push(item);

                item.addEventListener('click', function(e) {
                    e.stopPropagation();
                    closeDD();
                    if (s.slug !== currentSlug) saveInlineField(projectId, 'pipeline_status', s.slug);
                });
                item.addEventListener('mouseenter', function() {
                    setFocus(idx);
                });
            });

            function setFocus(idx) {
                items.forEach(function(it) { it.classList.remove('sd-focused'); });
                if (idx >= 0 && idx < items.length) {
                    focusIdx = idx;
                    items[idx].classList.add('sd-focused');
                    items[idx].scrollIntoView({ block: 'nearest' });
                }
            }

            function closeDD() {
                dd.remove();
                document.removeEventListener('click', onOutsideClick);
                document.removeEventListener('keydown', onKeyDown);
            }

            function onOutsideClick(e) {
                if (!dd.contains(e.target)) closeDD();
            }

            function onKeyDown(e) {
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    setFocus(Math.min(focusIdx + 1, items.length - 1));
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    setFocus(Math.max(focusIdx - 1, 0));
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (focusIdx >= 0 && items[focusIdx]) items[focusIdx].click();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    closeDD();
                }
            }

            document.body.appendChild(dd);

            // Position: below badge, flip up if near bottom
            var ddRect = dd.getBoundingClientRect();
            var top = rect.bottom + 4;
            var left = rect.left;
            if (top + ddRect.height > window.innerHeight - 8) {
                top = rect.top - ddRect.height - 4;
            }
            if (left + ddRect.width > window.innerWidth - 8) {
                left = window.innerWidth - ddRect.width - 8;
            }
            dd.style.top = top + 'px';
            dd.style.left = left + 'px';

            dd.focus();

            setTimeout(function() {
                document.addEventListener('click', onOutsideClick);
                document.addEventListener('keydown', onKeyDown);
            }, 0);
        }

        // ── Generic inline dropdown (same style as status) ──
        function openInlineDropdown(td, projectId, field, options, currentVal, evt) {
            evt.stopPropagation();
            var existing = document.querySelector('.status-dropdown');
            if (existing) existing.remove();

            var rect = td.getBoundingClientRect();

            var dd = document.createElement('div');
            dd.className = 'status-dropdown';
            dd.setAttribute('tabindex', '-1');

            var focusIdx = -1;
            var items = [];

            options.forEach(function(opt, idx) {
                var val = typeof opt === 'object' ? opt.value : opt;
                var label = typeof opt === 'object' ? opt.label : opt;
                var isActive = val === currentVal;
                if (isActive) focusIdx = idx;
                var item = document.createElement('div');
                item.className = 'status-dropdown-item' + (isActive ? ' sd-focused' : '');
                item.setAttribute('data-val', val);
                item.setAttribute('data-idx', idx);
                item.innerHTML =
                    '<span class="sd-label">' + escapeHtml(label) + '</span>' +
                    '<span class="sd-check">' + (isActive ? '\u2713' : '') + '</span>';
                dd.appendChild(item);
                items.push(item);

                item.addEventListener('click', function(e) {
                    e.stopPropagation();
                    closeDD();
                    if (val !== currentVal) saveInlineField(projectId, field, val);
                });
                item.addEventListener('mouseenter', function() {
                    setFocus(idx);
                });
            });

            function setFocus(idx) {
                items.forEach(function(it) { it.classList.remove('sd-focused'); });
                if (idx >= 0 && idx < items.length) {
                    focusIdx = idx;
                    items[idx].classList.add('sd-focused');
                    items[idx].scrollIntoView({ block: 'nearest' });
                }
            }

            function closeDD() {
                dd.remove();
                document.removeEventListener('click', onOutsideClick);
                document.removeEventListener('keydown', onKeyDown);
            }

            function onOutsideClick(e) {
                if (!dd.contains(e.target)) closeDD();
            }

            function onKeyDown(e) {
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    setFocus(Math.min(focusIdx + 1, items.length - 1));
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    setFocus(Math.max(focusIdx - 1, 0));
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (focusIdx >= 0 && items[focusIdx]) items[focusIdx].click();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    closeDD();
                }
            }

            document.body.appendChild(dd);

            var ddRect = dd.getBoundingClientRect();
            var top = rect.bottom + 4;
            var left = rect.left;
            if (top + ddRect.height > window.innerHeight - 8) {
                top = rect.top - ddRect.height - 4;
            }
            if (left + ddRect.width > window.innerWidth - 8) {
                left = window.innerWidth - ddRect.width - 8;
            }
            dd.style.top = top + 'px';
            dd.style.left = left + 'px';

            dd.focus();
            setTimeout(function() {
                document.addEventListener('click', onOutsideClick);
                document.addEventListener('keydown', onKeyDown);
            }, 0);
        }

        // ── Date Picker (Apple/Linear style) ──
        var DP_MONTHS_FR = ['Janvier','Février','Mars','Avril','Mai','Juin','Juillet','Août','Septembre','Octobre','Novembre','Décembre'];
        var DP_MONTHS_EN = ['January','February','March','April','May','June','July','August','September','October','November','December'];
        var DP_DAYS_FR = ['Lu','Ma','Me','Je','Ve','Sa','Di'];
        var DP_DAYS_EN = ['Mo','Tu','We','Th','Fr','Sa','Su'];

        // ── Date picker global state (for inline onclick handlers) ──
        var _dp = null; // { el, projectId, field, selectedDate, viewDate, onOutside, onKey }

        function _dpClose() {
            if (!_dp) return;
            _dp.el.remove();
            document.removeEventListener('mousedown', _dp.onOutside);
            document.removeEventListener('keydown', _dp.onKey);
            _dp = null;
        }

        function _dpNav(dir) {
            if (!_dp) return;
            _dp.viewDate.setMonth(_dp.viewDate.getMonth() + dir);
            _dpRender();
        }

        function _dpSelect(iso) {
            if (!_dp) return;
            var projectId = _dp.projectId;
            var field = _dp.field;
            _dpClose();
            saveInlineField(projectId, field, iso);
        }

        function _dpToday() {
            var d = new Date();
            var pad = function(n) { return n < 10 ? '0' + n : '' + n; };
            _dpSelect(d.getFullYear() + '-' + pad(d.getMonth() + 1) + '-' + pad(d.getDate()));
        }

        function _dpClear() {
            if (!_dp) return;
            var projectId = _dp.projectId;
            var field = _dp.field;
            _dpClose();
            saveInlineField(projectId, field, null);
        }

        function _dpRender() {
            if (!_dp) return;
            var y = _dp.viewDate.getFullYear();
            var m = _dp.viewDate.getMonth();
            var months = DP_MONTHS_FR;
            var dayNames = DP_DAYS_FR;
            var today = new Date();
            var sel = _dp.selectedDate;

            function pad(n) { return n < 10 ? '0' + n : '' + n; }
            function toISO(d) { return d.getFullYear() + '-' + pad(d.getMonth() + 1) + '-' + pad(d.getDate()); }
            function isSameDay(a, b) { return a && b && a.getFullYear() === b.getFullYear() && a.getMonth() === b.getMonth() && a.getDate() === b.getDate(); }

            var html = '<div class="dp-header">';
            html += '<span class="dp-header-title">' + escapeHtml(months[m]) + ' ' + y + '</span>';
            html += '<div class="dp-nav">';
            html += '<button type="button" class="dp-nav-btn" onclick="_dpNav(-1);event.stopPropagation()">&#8249;</button>';
            html += '<button type="button" class="dp-nav-btn" onclick="_dpNav(1);event.stopPropagation()">&#8250;</button>';
            html += '</div></div>';

            html += '<div class="dp-weekdays">';
            dayNames.forEach(function(d) { html += '<span>' + d + '</span>'; });
            html += '</div>';

            html += '<div class="dp-grid">';

            var firstDay = new Date(y, m, 1).getDay();
            var startOffset = (firstDay + 6) % 7;
            var daysInMonth = new Date(y, m + 1, 0).getDate();

            // Previous month days
            for (var i = startOffset - 1; i >= 0; i--) {
                var dt = new Date(y, m, -i);
                html += '<button type="button" class="dp-day outside" onclick="_dpSelect(\'' + toISO(dt) + '\');event.stopPropagation()">' + dt.getDate() + '</button>';
            }

            // Current month days
            for (var d = 1; d <= daysInMonth; d++) {
                var dt = new Date(y, m, d);
                var cls = 'dp-day';
                if (isSameDay(dt, today)) cls += ' today';
                if (isSameDay(dt, sel)) cls += ' selected';
                html += '<button type="button" class="' + cls + '" onclick="_dpSelect(\'' + toISO(dt) + '\');event.stopPropagation()">' + d + '</button>';
            }

            // Next month days
            var totalCells = startOffset + daysInMonth;
            var remaining = (7 - (totalCells % 7)) % 7;
            for (var d = 1; d <= remaining; d++) {
                var dt = new Date(y, m + 1, d);
                html += '<button type="button" class="dp-day outside" onclick="_dpSelect(\'' + toISO(dt) + '\');event.stopPropagation()">' + d + '</button>';
            }

            html += '</div>';

            // Footer
            html += '<div class="dp-footer">';
            html += '<button type="button" class="dp-footer-btn dp-today-btn" onclick="_dpToday();event.stopPropagation()">Aujourd\'hui</button>';
            if (sel) {
                html += '<button type="button" class="dp-footer-btn" onclick="_dpClear();event.stopPropagation()">Effacer</button>';
            }
            html += '</div>';

            _dp.el.innerHTML = html;
        }

        function openDatePicker(td, projectId, currentVal, field, evt) {
            evt.stopPropagation();
            _dpClose(); // close any existing

            var selectedDate = currentVal ? new Date(currentVal + 'T00:00:00') : null;
            var viewDate = selectedDate ? new Date(selectedDate) : new Date();
            viewDate.setDate(1);

            var dp = document.createElement('div');
            dp.className = 'dp-popover';
            dp.setAttribute('tabindex', '-1');
            document.body.appendChild(dp);

            function onOutside(e) {
                if (!dp.contains(e.target)) _dpClose();
            }
            function onKey(e) {
                if (e.key === 'Escape') { e.preventDefault(); _dpClose(); }
            }

            _dp = { el: dp, projectId: projectId, field: field, selectedDate: selectedDate, viewDate: viewDate, onOutside: onOutside, onKey: onKey };

            _dpRender();

            // Position
            var rect = td.getBoundingClientRect();
            var dpRect = dp.getBoundingClientRect();
            var top = rect.bottom + 4;
            var left = rect.left;
            if (top + dpRect.height > window.innerHeight - 8) {
                top = rect.top - dpRect.height - 4;
            }
            if (left + dpRect.width > window.innerWidth - 8) {
                left = window.innerWidth - dpRect.width - 8;
            }
            dp.style.top = top + 'px';
            dp.style.left = left + 'px';

            dp.focus();
            setTimeout(function() {
                document.addEventListener('mousedown', onOutside);
                document.addEventListener('keydown', onKey);
            }, 0);
        }

        async function saveInlineField(projectId, field, value) {
            var proj = cachedProjects.find(function(p) { return p.id === projectId; });
            if (proj) proj[field] = value;
            renderCurrentView();
            var patch = {};
            if (field === 'probability') {
                patch[field] = value ? parseInt(value) : 0;
            } else {
                patch[field] = value || null;
            }
            await updateProject(projectId, patch);
        }

        // ── Pipeline view switching ──

        function switchPipelineView(view) {
            // Auto-switch to cards on mobile if table requested
            if (view === 'table' && window.innerWidth < 768) view = 'cards';
            currentPipelineView = view;
            document.querySelectorAll('.pipeline-tab').forEach(function(t) {
                t.classList.toggle('active', t.getAttribute('data-view') === view);
            });
            document.getElementById('viewTableContainer').style.display = view === 'table' ? '' : 'none';
            document.getElementById('projectGrid').style.display = view === 'cards' ? '' : 'none';
            document.getElementById('viewSubmissions').style.display = view === 'submissions' ? '' : 'none';
            // Clean up colgroup when leaving table view to avoid stale widths
            if (view !== 'table') {
                var cg = document.querySelector('#pipelineTable colgroup');
                if (cg) cg.remove();
            }
            populateFilterDropdowns();
            renderCurrentView();
        }

        function populateFilterDropdowns() {
            // Status filter
            var sf = document.getElementById('pipelineStatusFilter');
            var currentVal = sf.value;
            sf.innerHTML = '<option value="">Tous les statuts</option>';
            if (currentPipelineView === 'submissions') {
                var subStatuses = [['draft','Brouillon'],['pending_internal','En approbation'],['returned','Retourn\u00e9e'],['approved_internal','Pr\u00eate'],['sent_client','Envoy\u00e9e'],['accepted','Vendue'],['lost','Perdue']];
                subStatuses.forEach(function(s) { sf.innerHTML += '<option value="' + s[0] + '">' + escapeHtml(s[1]) + '</option>'; });
            } else {
                pipelineStatuses.forEach(function(s) { sf.innerHTML += '<option value="' + escapeAttr(s.slug) + '">' + escapeHtml(s.label) + '</option>'; });
            }
            sf.value = currentVal;

            // Assigned filter
            var af = document.getElementById('pipelineAssignedFilter');
            var aVal = af.value;
            af.innerHTML = '<option value="">Tous les responsables</option>';
            EMPLOYEES_DATA.forEach(function(e) { af.innerHTML += '<option value="' + escapeAttr(e.name) + '">' + escapeHtml(e.name) + '</option>'; });
            af.value = aVal;

            // Type filter
            var tf = document.getElementById('pipelineTypeFilter');
            var tVal = tf.value;
            tf.innerHTML = '<option value="">Tous les types</option>';
            projectTypes.forEach(function(t) { tf.innerHTML += '<option value="' + escapeAttr(t) + '">' + escapeHtml(t) + '</option>'; });
            tf.value = tVal;

            // Hide type filter for submissions view
            tf.style.display = currentPipelineView === 'submissions' ? 'none' : '';
        }

        function applyPipelineFilters() {
            pipelineFilters.search = (document.getElementById('pipelineSearch').value || '').toLowerCase();
            pipelineFilters.status = document.getElementById('pipelineStatusFilter').value;
            pipelineFilters.assigned = document.getElementById('pipelineAssignedFilter').value;
            pipelineFilters.type = document.getElementById('pipelineTypeFilter').value;
            renderCurrentView();
        }

        function filterProjects(projects) {
            return projects.filter(function(p) {
                if (pipelineFilters.search) {
                    var s = pipelineFilters.search;
                    var haystack = [p.name, p.client_name, p.project_code, p.project_city, p.assigned_to].filter(Boolean).join(' ').toLowerCase();
                    if (haystack.indexOf(s) === -1) return false;
                }
                if (pipelineFilters.status && (p.pipeline_status || 'a_contacter') !== pipelineFilters.status) return false;
                if (pipelineFilters.assigned && p.assigned_to !== pipelineFilters.assigned) return false;
                if (pipelineFilters.type && p.project_type !== pipelineFilters.type) return false;
                if (pipelineFilters.followsOnly && !userFollows[p.id]) return false;
                return true;
            });
        }

        function renderCurrentView() {
            var filtered = filterProjects(cachedProjects);
            var empty = document.getElementById('projectEmpty');
            if (cachedProjects.length === 0) {
                empty.style.display = 'block';
                return;
            }
            empty.style.display = 'none';

            if (currentPipelineView === 'table') renderTableView(filtered);
            else if (currentPipelineView === 'cards') renderCardView(filtered);
            else if (currentPipelineView === 'submissions') renderSubmissionsView(filtered);
        }

        // ── Table view ──

        // Column definitions: hide = CSS class that hides at breakpoint, wCls = width class
        var TABLE_COLUMNS = [
            { key: 'follow',          label: '★',          wCls: 'col-w-follow',   hide: '' },
            { key: 'name',            label: 'Nom',        wCls: 'col-w-name',     hide: '' },
            { key: 'architecte',      label: 'Archit.',    wCls: 'col-w-contact',  hide: 'col-hide-md', computed: true },
            { key: 'entrepreneur',    label: 'Entrep.',    wCls: 'col-w-contact',  hide: 'col-hide-lg', computed: true },
            { key: 'display_amount',  label: 'Montant',    wCls: 'col-w-amount',   hide: '',            cls: 'col-amount' },
            { key: 'probability',     label: 'Prob%',      wCls: 'col-w-prob',     hide: 'col-always-hidden', cls: 'col-amount' },
            { key: 'pipeline_status', label: 'Statut',     wCls: 'col-w-status',   hide: '' },
            { key: 'deadline',        label: 'Remise',     wCls: 'col-w-deadline', hide: 'col-hide-lg', computed: true },
            { key: 'assigned_to',     label: 'Resp.',      wCls: 'col-w-resp',     hide: 'col-hide-lg' },
            { key: 'project_type',    label: 'Type',       wCls: 'col-w-type',     hide: 'col-hide-xl' }
        ];

        function renderTableView(projects) {
            var tbl = document.getElementById('pipelineTable');

            // Colgroup
            var cg = tbl.querySelector('colgroup');
            if (cg) cg.remove();
            var cgHtml = '<colgroup>';
            TABLE_COLUMNS.forEach(function(col) { cgHtml += '<col class="' + col.wCls + (col.hide ? ' ' + col.hide : '') + '">'; });
            cgHtml += '<col class="col-w-more">';
            cgHtml += '</colgroup>';
            tbl.insertAdjacentHTML('afterbegin', cgHtml);

            // Header
            var head = document.getElementById('pipelineTableHead');
            var hHtml = '<tr>';
            TABLE_COLUMNS.forEach(function(col) {
                var arrow = '';
                var sorted = pipelineSortColumn === col.key ? ' sorted' : '';
                if (pipelineSortColumn === col.key) {
                    arrow = pipelineSortDir === 'asc' ? '\u25B2' : '\u25BC';
                }
                hHtml += '<th class="' + sorted + (col.hide ? ' ' + col.hide : '') + '" onclick="sortPipelineTable(\'' + col.key + '\')"><span>' + col.label + '</span><span class="sort-arrow">' + arrow + '</span></th>';
            });
            hHtml += '<th class="col-w-more"></th>';
            hHtml += '</tr>';
            head.innerHTML = hHtml;

            // Sort
            var sorted = sortProjects(projects.slice());

            // Body
            var body = document.getElementById('pipelineTableBody');
            var bHtml = '';
            sorted.forEach(function(p) {
                var ps = getPipelineStatus(p.pipeline_status);
                var prob = p.probability || 0;
                var architecte = getContactByRole(p, 'Architecte');
                var architecteTip = getContactTooltipByRole(p, 'Architecte');
                var entrepreneur = getContactByRole(p, 'Entrepreneur');
                var entrepreneurTip = getContactTooltipByRole(p, 'Entrepreneur');
                var isFollowed = userFollows[p.id] ? ' active' : '';

                var pid = escapeAttr(p.id);

                var respOpts = [{value:'', label:'\u2014'}].concat(EMPLOYEES_DATA.map(function(e) { return {value: e.name, label: e.name}; }));
                var typeOpts = [{value:'', label:'\u2014'}].concat(projectTypes.map(function(t) { return {value: t, label: t}; }));

                // Priority indicator class
                var prioCls = p.priority === 'urgente' ? ' urgente' : (p.priority === 'haute' ? ' haute' : ' normal');
                var prioTitle = p.priority === 'urgente' ? 'Urgente' : (p.priority === 'haute' ? 'Haute' : '');

                bHtml += '<tr onclick="pipelineRowClick(\'' + pid + '\')">';
                // ★ Follow
                bHtml += '<td><span class="follow-star' + isFollowed + '" onclick="toggleFollow(\'' + pid + '\',event)">\u2605</span></td>';
                // Nom with priority indicator
                bHtml += '<td class="col-name"><div class="name-cell-inner">';
                bHtml += '<span class="prio-indicator' + prioCls + '" onclick="openPriorityDropdown(this,\'' + pid + '\',event)"' + (prioTitle ? ' title="' + prioTitle + '"' : '') + '></span>';
                bHtml += '<span title="' + escapeAttr(p.name || '') + '">' + escapeHtml(p.name || '\u2014') + '</span>';
                bHtml += '</div></td>';
                // Architecte
                bHtml += '<td class="col-hide-md" title="' + escapeAttr(architecteTip) + '">' + escapeHtml(architecte || '\u2014') + '</td>';
                // Entrepreneur
                bHtml += '<td class="col-hide-lg" title="' + escapeAttr(entrepreneurTip) + '">' + escapeHtml(entrepreneur || '\u2014') + '</td>';
                // Montant
                bHtml += '<td class="col-amount amount-cell" onclick="startAmountEdit(this,\'' + pid + '\',event)">' + renderAmountCell(p) + '</td>';
                // Prob% (always hidden in table, visible in drawer)
                bHtml += '<td class="col-always-hidden">' + (prob || '\u2014') + '</td>';
                // Statut pipeline
                bHtml += '<td class="inline-editable" onclick="openStatusDropdown(this,\'' + pid + '\',\'' + escapeAttr(p.pipeline_status || 'a_contacter') + '\',event)"><span class="pipeline-badge" style="background:' + ps.color + '20;color:' + ps.color + ';">' + escapeHtml(ps.label) + '</span></td>';
                // Remise
                var projDeadline = p.client_deadline || '';
                bHtml += '<td class="col-hide-lg inline-editable' + (projDeadline ? ' project-card-deadline' : '') + '" onclick="openDatePicker(this,\'' + pid + '\',\'' + escapeAttr(projDeadline) + '\',\'client_deadline\',event)">' + formatDateShort(projDeadline) + '</td>';
                // Responsable
                bHtml += '<td class="col-hide-lg inline-editable" onclick="openInlineDropdown(this,\'' + pid + '\',\'assigned_to\',' + escapeAttr(JSON.stringify(respOpts)) + ',\'' + escapeAttr(p.assigned_to || '') + '\',event)">' + escapeHtml(p.assigned_to || '\u2014') + '</td>';
                // Type
                bHtml += '<td class="col-hide-xl inline-editable" onclick="openInlineDropdown(this,\'' + pid + '\',\'project_type\',' + escapeAttr(JSON.stringify(typeOpts)) + ',\'' + escapeAttr(p.project_type || '') + '\',event)">' + escapeHtml(p.project_type || '\u2014') + '</td>';
                // More button
                bHtml += '<td class="col-w-more"><button class="tbl-more-btn" onclick="openProjectDrawer(\'' + pid + '\',event)" title="D\u00e9tails">\u2026</button></td>';
                bHtml += '</tr>';
            });
            body.innerHTML = bHtml || '<tr><td colspan="' + (TABLE_COLUMNS.length + 1) + '" style="text-align:center;color:#888;padding:24px;">Aucun projet ne correspond aux filtres.</td></tr>';
        }

        function sortProjects(arr) {
            var col = pipelineSortColumn;
            var dir = pipelineSortDir === 'asc' ? 1 : -1;
            return arr.sort(function(a, b) {
                var va, vb;
                if (col === 'follow') {
                    va = userFollows[a.id] ? 0 : 1;
                    vb = userFollows[b.id] ? 0 : 1;
                } else if (col === 'priority') {
                    var prioOrder = { urgente: 0, haute: 1, normal: 2 };
                    va = prioOrder[a.priority] != null ? prioOrder[a.priority] : 2;
                    vb = prioOrder[b.priority] != null ? prioOrder[b.priority] : 2;
                } else if (col === 'display_amount') {
                    va = (getProjectDisplayAmount(a).value || 0);
                    vb = (getProjectDisplayAmount(b).value || 0);
                } else if (col === 'deadline') {
                    va = a.client_deadline || 'zzzz';
                    vb = b.client_deadline || 'zzzz';
                } else if (col === 'architecte') {
                    va = getContactByRole(a, 'Architecte') || '';
                    vb = getContactByRole(b, 'Architecte') || '';
                } else if (col === 'entrepreneur') {
                    va = getContactByRole(a, 'Entrepreneur') || '';
                    vb = getContactByRole(b, 'Entrepreneur') || '';
                } else {
                    va = a[col]; vb = b[col];
                }
                if (va == null) va = '';
                if (vb == null) vb = '';
                if (typeof va === 'string') return va.localeCompare(vb) * dir;
                return (va - vb) * dir;
            });
        }

        function sortPipelineTable(col) {
            if (pipelineSortColumn === col) {
                pipelineSortDir = pipelineSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                pipelineSortColumn = col;
                pipelineSortDir = 'asc';
            }
            renderCurrentView();
        }

        function pipelineRowClick(projectId) {
            var proj = cachedProjects.find(function(p) { return p.id === projectId; });
            if (!proj) return;
            var subs = proj.submissions || [];
            if (subs.length > 0) {
                openSubmission(subs[0].id);
            } else {
                openProject(projectId);
            }
        }

        // ── Project detail drawer ──

        var _drawerProjectId = null;

        function drawerSave(field, value) {
            if (!_drawerProjectId) return;
            var proj = cachedProjects.find(function(p) { return p.id === _drawerProjectId; });
            if (proj) proj[field] = value;
            var patch = {};
            if (field === 'probability') patch[field] = value ? parseInt(value) : 0;
            else patch[field] = value || null;
            updateProject(_drawerProjectId, patch).then(function() { renderCurrentView(); });
        }

        function drawerSaveCity(value) {
            if (!_drawerProjectId) return;
            var proj = cachedProjects.find(function(p) { return p.id === _drawerProjectId; });
            if (!proj) return;
            proj.project_city = value;
            var newName = proj.project_code ? (value ? proj.project_code + ' ' + value : proj.project_code) : proj.name;
            proj.name = newName;
            document.getElementById('drawerProjectName').textContent = newName || 'Projet';
            var patch = { project_city: value || null, name: newName };
            updateProject(_drawerProjectId, patch).then(function() { renderCurrentView(); });
        }

        function openProjectDrawer(projectId, evt) {
            evt.stopPropagation();
            var p = cachedProjects.find(function(pr) { return pr.id === projectId; });
            if (!p) return;
            _drawerProjectId = projectId;
            document.getElementById('drawerProjectName').textContent = p.name || 'Projet';
            var ps = getPipelineStatus(p.pipeline_status);
            var da = getProjectDisplayAmount(p);
            var deadline = getClosestDeadline(p);
            var entrepreneur = getContactTooltipByRole(p, 'Entrepreneur');
            var architecte = getContactTooltipByRole(p, 'Architecte');
            var prob = p.probability || 0;

            // Build select options
            var statusOptions = pipelineStatuses.map(function(s) {
                return '<option value="' + escapeAttr(s.slug) + '"' + (s.slug === p.pipeline_status ? ' selected' : '') + '>' + escapeHtml(s.label) + '</option>';
            }).join('');

            var respOptions = '<option value="">—</option>' + EMPLOYEES_DATA.map(function(e) {
                return '<option value="' + escapeAttr(e.name) + '"' + (e.name === p.assigned_to ? ' selected' : '') + '>' + escapeHtml(e.name) + '</option>';
            }).join('');

            var prioOptions = ['normal', 'haute', 'urgente'].map(function(v) {
                var lbl = v === 'urgente' ? 'Urgente' : (v === 'haute' ? 'Haute' : 'Normal');
                return '<option value="' + v + '"' + (v === (p.priority || 'normal') ? ' selected' : '') + '>' + lbl + '</option>';
            }).join('');

            var typeOptions = '<option value="">—</option>' + projectTypes.map(function(t) {
                return '<option value="' + escapeAttr(t) + '"' + (t === p.project_type ? ' selected' : '') + '>' + escapeHtml(t) + '</option>';
            }).join('');

            var html = '';

            // Code (readonly)
            html += '<div class="drawer-field"><div class="drawer-field-label">Code</div><div class="drawer-field-value readonly">' + escapeHtml(p.project_code || '—') + '</div></div>';
            // Client (readonly — via contacts)
            html += '<div class="drawer-field"><div class="drawer-field-label">Client</div><div class="drawer-field-value readonly">' + escapeHtml(p.client_name || '—') + '</div></div>';
            // Entrepreneur (readonly — via contacts)
            html += '<div class="drawer-field"><div class="drawer-field-label">Entrepreneur</div><div class="drawer-field-value readonly">' + escapeHtml(entrepreneur || '—') + '</div></div>';
            // Architecte (readonly — via contacts)
            html += '<div class="drawer-field"><div class="drawer-field-label">Architecte</div><div class="drawer-field-value readonly">' + escapeHtml(architecte || '—') + '</div></div>';
            // Montant (readonly — calculated)
            html += '<div class="drawer-field"><div class="drawer-field-label">Montant</div><div class="drawer-field-value readonly">' + (da.value != null ? formatMoney(da.value) + (da.isOverride ? ' (estim\u00e9)' : '') : '—') + '</div></div>';
            // Probabilité
            html += '<div class="drawer-field"><div class="drawer-field-label">Probabilit\u00e9</div><input type="number" class="drawer-edit" min="0" max="100" value="' + (prob || '') + '" onchange="drawerSave(\'probability\',this.value)"></div>';
            // Responsable
            html += '<div class="drawer-field"><div class="drawer-field-label">Responsable</div><select class="drawer-edit" onchange="drawerSave(\'assigned_to\',this.value)">' + respOptions + '</select></div>';
            // Priorité
            html += '<div class="drawer-field"><div class="drawer-field-label">Priorit\u00e9</div><select class="drawer-edit" onchange="drawerSave(\'priority\',this.value)">' + prioOptions + '</select></div>';
            // Statut pipeline
            html += '<div class="drawer-field"><div class="drawer-field-label">Statut pipeline</div><select class="drawer-edit" onchange="drawerSave(\'pipeline_status\',this.value)">' + statusOptions + '</select></div>';
            // Type
            html += '<div class="drawer-field"><div class="drawer-field-label">Type</div><select class="drawer-edit" onchange="drawerSave(\'project_type\',this.value)">' + typeOptions + '</select></div>';
            // Ville
            html += '<div class="drawer-field"><div class="drawer-field-label">Ville</div><input type="text" class="drawer-edit" value="' + escapeAttr(p.project_city || '') + '" onchange="drawerSaveCity(this.value.trim())"></div>';
            // Source
            html += '<div class="drawer-field"><div class="drawer-field-label">Source</div><input type="text" class="drawer-edit" value="' + escapeAttr(p.source || '') + '" onchange="drawerSave(\'source\',this.value.trim())"></div>';
            // Livraison
            html += '<div class="drawer-field"><div class="drawer-field-label">Livraison</div><input type="month" class="drawer-edit" value="' + escapeAttr(p.delivery_month || '') + '" onchange="drawerSave(\'delivery_month\',this.value)"></div>';
            // Deadline interne
            html += '<div class="drawer-field"><div class="drawer-field-label">Deadline interne</div><input type="date" class="drawer-edit" value="' + escapeAttr(p.internal_deadline || '') + '" onchange="drawerSave(\'internal_deadline\',this.value)"></div>';
            // Deadline client
            html += '<div class="drawer-field"><div class="drawer-field-label">Deadline client</div><input type="date" class="drawer-edit" value="' + escapeAttr(p.client_deadline || '') + '" onchange="drawerSave(\'client_deadline\',this.value)"></div>';
            // Date remise (readonly — computed)
            if (deadline) {
                html += '<div class="drawer-field"><div class="drawer-field-label">Date remise</div><div class="drawer-field-value readonly">' + formatDateShort(deadline) + '</div></div>';
            }

            document.getElementById('drawerBody').innerHTML = html;
            document.getElementById('projectDrawerOverlay').classList.add('open');
            document.getElementById('projectDrawer').classList.add('open');
        }

        function closeProjectDrawer() {
            document.getElementById('projectDrawerOverlay').classList.remove('open');
            document.getElementById('projectDrawer').classList.remove('open');
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && document.getElementById('projectDrawer').classList.contains('open')) {
                closeProjectDrawer();
            }
        });

        // ── Card view (enriched) ──

        function renderCardView(projects) {
            var grid = document.getElementById('projectGrid');
            grid.innerHTML = '';

            projects.forEach(function(proj) {
                var card = document.createElement('div');
                card.className = 'project-card' + (proj.priority === 'urgente' ? ' project-card-urgent' : '');

                var subs = proj.submissions || [];
                var ps = getPipelineStatus(proj.pipeline_status);
                var deadline = proj.client_deadline || '';

                var subsHtml = '';
                var archivedCount = 0;
                subs.forEach(function(sub) {
                    if (sub.is_archived && !pipelineFilters.showArchived) { archivedCount++; return; }
                    var label = STATUS_LABELS[sub.status] || sub.status || 'Brouillon';
                    var lineClass = 'sub-line' + (sub.is_archived ? ' archived' : '');
                    subsHtml += '<div class="' + lineClass + '" data-subid="' + escapeAttr(sub.id) + '" data-projid="' + escapeAttr(proj.id) + '">' +
                        '<span class="sub-number">#' + escapeHtml(String(sub.submission_number)) + '</span> ' +
                        '<span class="sub-title">' + escapeHtml(sub.title || 'Sans titre') + '</span>' +
                        '<span class="project-status-badge status-' + escapeAttr(sub.status) + '">' + escapeHtml(label) + (sub.bypass_approval ? ' <span class="bypass-badge">BYPASS</span>' : '') + '</span>' +
                        '</div>';
                });
                if (archivedCount > 0) {
                    subsHtml += '<div style="font-size:11px;color:#999;padding:2px 10px;">' + archivedCount + ' archiv\u00e9e(s)</div>';
                }

                var cardDa = getProjectDisplayAmount(proj);
                var cardAmountHtml = '';
                if (cardDa.value != null) {
                    cardAmountHtml = cardDa.isOverride
                        ? '<span class="project-card-amount" style="color:#c62828;" title="Montant estim\u00e9 manuellement">' + formatMoney(cardDa.value) + '</span>'
                        : '<span class="project-card-amount">' + formatMoney(cardDa.value) + '</span>';
                }
                var metaHtml = '';
                var metaParts = [];
                if (proj.assigned_to) metaParts.push(escapeHtml(proj.assigned_to));
                if (proj.project_type) metaParts.push(escapeHtml(proj.project_type));
                if (deadline) metaParts.push('<span class="project-card-deadline">' + formatDateShort(deadline) + '</span>');
                if (metaParts.length) metaHtml = '<div class="project-card-meta-row">' + metaParts.join(' &middot; ') + '</div>';

                var followCls = userFollows[proj.id] ? ' active' : '';

                var followStarHtml = '<span class="follow-star card-follow' + followCls + '" onclick="toggleFollow(\'' + escapeAttr(proj.id) + '\',event)" title="Suivre">\u2605</span>';
                var pipelineWithStar = '<div class="project-card-pipeline">' +
                    followStarHtml +
                    '<span class="pipeline-badge" style="background:' + ps.color + '20;color:' + ps.color + ';">' + escapeHtml(ps.label) + '</span>' +
                    cardAmountHtml +
                    '</div>';

                card.innerHTML =
                    '<button class="project-card-delete" onclick="handleDeleteProject(\'' + escapeAttr(proj.id) + '\', event)" title="Supprimer">&times;</button>' +
                    pipelineWithStar +
                    '<div class="project-card-name">' + escapeHtml(proj.name || 'Sans nom') + '</div>' +
                    '<div class="project-card-client">' + escapeHtml(proj.client_name || '') + '</div>' +
                    metaHtml +
                    '<div class="project-subs">' + (subsHtml || '<div class="sub-empty">Aucune soumission</div>') + '</div>' +
                    '<button class="btn-add-sub" onclick="handleAddSubmission(\'' + escapeAttr(proj.id) + '\', event)">+ Nouvelle soumission</button>';

                card.addEventListener('click', function(e) {
                    if (e.target.closest('.project-card-delete') || e.target.closest('.btn-add-sub') || e.target.closest('.follow-star')) return;
                    var subLine = e.target.closest('.sub-line');
                    if (subLine) {
                        openSubmission(subLine.getAttribute('data-subid'));
                        return;
                    }
                    if (subs.length > 0) openSubmission(subs[0].id);
                    else openProject(proj.id);
                });

                grid.appendChild(card);
            });
        }

        // ── Submissions view ──

        var SUB_STATUSES_ORDER = ['draft', 'pending_internal', 'returned', 'approved_internal', 'sent_client', 'accepted'];

        var SUB_STATUS_LABELS = {
            draft: 'Brouillon',
            pending_internal: 'En approbation interne',
            returned: 'Retourné',
            approved_internal: 'Approuvé',
            sent_client: 'Envoyé au client',
            accepted: 'Accepté',
            lost: 'Perdue'
        };

        function buildMiniTimeline(status) {
            var isLost = (status === 'lost');
            var idx = isLost ? (SUB_STATUSES_ORDER.length - 1) : SUB_STATUSES_ORDER.indexOf(status);
            if (idx === -1) idx = 0;
            var html = '<span class="pipeline-mini-timeline">';
            for (var i = 0; i < SUB_STATUSES_ORDER.length; i++) {
                var isFilled = (i <= idx);
                var isLastAndLost = isLost && (i === SUB_STATUSES_ORDER.length - 1);
                if (i > 0) html += '<span class="tl-line' + (isFilled ? ' filled' : '') + '"></span>';
                var label = isLastAndLost ? 'Perdue' : (SUB_STATUS_LABELS[SUB_STATUSES_ORDER[i]] || '');
                html += '<span class="tl-dot' + (isFilled ? ' filled' : '') + (isLastAndLost ? ' lost' : '') + '" data-label="' + label + '"></span>';
            }
            html += '</span>';
            return html;
        }

        function renderSubmissionsView(projects) {
            // Flatten all submissions
            var allSubs = [];
            projects.forEach(function(p) {
                (p.submissions || []).forEach(function(s) {
                    s._project = p;
                    allSubs.push(s);
                });
            });

            // Apply submission-specific filters
            if (pipelineFilters.search) {
                var q = pipelineFilters.search;
                allSubs = allSubs.filter(function(s) {
                    var haystack = [s.title, s._project.name, s._project.client_name, String(s.submission_number)].filter(Boolean).join(' ').toLowerCase();
                    return haystack.indexOf(q) !== -1;
                });
            }
            if (pipelineFilters.status) {
                allSubs = allSubs.filter(function(s) { return s.status === pipelineFilters.status; });
            }
            if (pipelineFilters.assigned) {
                allSubs = allSubs.filter(function(s) { return s.estimateur === pipelineFilters.assigned || s.vendeur_cp === pipelineFilters.assigned; });
            }
            if (!pipelineFilters.showArchived) {
                allSubs = allSubs.filter(function(s) { return !s.is_archived; });
            }

            // Sort by updated_at desc
            allSubs.sort(function(a, b) { return (b.updated_at || '').localeCompare(a.updated_at || ''); });

            // Header
            var head = document.getElementById('submissionsTableHead');
            head.innerHTML = '<tr><th>#</th><th>Titre</th><th>Projet</th><th>Client</th><th>Montant</th><th>Estimateur</th><th>Vendeur</th><th>Statut</th><th>Remise</th></tr>';

            // Body
            var body = document.getElementById('submissionsTableBody');
            var html = '';
            allSubs.forEach(function(s) {
                var deadline = s.internal_deadline || s.client_deadline || '';
                html += '<tr onclick="openSubmission(\'' + escapeAttr(s.id) + '\')">';
                html += '<td style="font-weight:700;color:var(--sw-navy);">#' + escapeHtml(String(s.submission_number)) + '</td>';
                html += '<td class="col-name">' + escapeHtml(s.title || 'Sans titre') + '</td>';
                html += '<td>' + escapeHtml(s._project.name || '—') + '</td>';
                html += '<td>' + escapeHtml(s._project.client_name || '—') + '</td>';
                html += '<td class="col-amount">' + (s.approved_total ? formatMoney(s.approved_total) : '—') + '</td>';
                html += '<td>' + escapeHtml(s.estimateur || '—') + '</td>';
                html += '<td>' + escapeHtml(s.vendeur_cp || '—') + '</td>';
                html += '<td>' + buildMiniTimeline(s.status) + '</td>';
                html += '<td' + (deadline ? ' class="project-card-deadline"' : '') + '>' + formatDateShort(deadline) + '</td>';
                html += '</tr>';
            });
            body.innerHTML = html || '<tr><td colspan="9" style="text-align:center;color:#888;padding:24px;">Aucune soumission ne correspond aux filtres.</td></tr>';
        }

        // ── Main renderProjectList — loads data then renders current view ──

        async function renderProjectList() {
            cachedProjects = await loadProjects();
            await loadUserFollows();
            populateFilterDropdowns();
            renderCurrentView();
        }

        async function handleAddSubmission(projectId, event) {
            if (event) event.stopPropagation();
            var title = await stelePrompt('Titre de la nouvelle soumission :', 'Nouvelle soumission');
            if (title === null) return;
            try {
                var sub = await createSubmission(projectId, title || '');
                await openSubmission(sub.id);
            } catch (e) {
                console.error('Erreur cr\u00e9ation soumission:', e);
                steleAlert('Erreur lors de la cr\u00e9ation de la soumission.');
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // FORMULAIRE NOUVEAU PROJET
        // ═══════════════════════════════════════════════════════════════════════

        function showNewProjectForm() {
            document.getElementById('newProjectForm').classList.add('active');
        }

        function hideNewProjectForm() {
            document.getElementById('newProjectForm').classList.remove('active');
        }

        async function handleCreateProject() {
            const btn = document.getElementById('btnCreateProject');
            btn.disabled = true;
            btn.textContent = 'Création...';

            try {
                // Name & code auto-generated by DB trigger
                const project = await createProject('', '');
                hideNewProjectForm();
                await openProject(project.id);
            } catch (e) {
                console.error('Erreur création projet:', e);
                steleAlert('Erreur lors de la cr\u00e9ation du projet.');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Créer';
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // OUVRIR / CHARGER UN PROJET
        // ═══════════════════════════════════════════════════════════════════════

        async function openSubmission(submissionId, project) {
            // Charger la soumission
            const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/submissions?id=eq.' + submissionId + '&select=*', {});
            if (!r.ok) return;
            const subData = await r.json();
            if (subData.length === 0) return;

            currentSubmission = subData[0];

            // Charger le projet parent si pas déjà fourni
            if (project) {
                currentProject = project;
            } else {
                const pr = await authenticatedFetch(SUPABASE_URL + '/rest/v1/projects?id=eq.' + currentSubmission.project_id + '&select=*', {});
                if (pr.ok) {
                    const pData = await pr.json();
                    if (pData.length > 0) currentProject = pData[0];
                }
            }

            roomMap = {};
            itemMap = {};
            groupImages = {};
            roomDescEN = {};
            roomDescHTML = {};
            resetAiChat();

            // Remplir le header
            document.getElementById('projName').value = currentProject ? (currentProject.name || '') : '';
            document.getElementById('subTitle').value = currentSubmission.title || '';
            var exclEl = document.getElementById('exclusionsText');
            if (exclEl) exclEl.value = currentSubmission.exclusions || '';
            updateStatusBadge(currentSubmission.status || 'draft');
            document.getElementById('subNumber').textContent = '#' + currentSubmission.submission_number;
            document.getElementById('headerSubNumber').textContent = 'Soumission #' + currentSubmission.submission_number;
            document.getElementById('projInstallation').checked = true;
            renderProjectInfoBloc();

            // Charger les contacts projet pour les badges header
            loadProjectContacts().then(function() { renderContactBadges(); });

            // Vider le calculateur
            document.getElementById('furnitureGroups').innerHTML = '';
            cascadeParentMap = {};
            _cascadeRunning = false;

            // Charger les pièces et items via submission_id
            const rooms = await loadSubmissionRooms(submissionId);

            if (rooms.length === 0) {
                addFurnitureGroup('');
            } else {
                for (const room of rooms) {
                    const groupId = addFurnitureGroup(room.name, { existingId: room.id, skipSave: true });

                    if (room.installation_included === false) {
                        var installCb = document.getElementById(groupId + '-install');
                        if (installCb) installCb.checked = false;
                    }

                    if (room.client_description) {
                        var descEl = document.getElementById(groupId + '-clientDesc');
                        if (descEl) descEl.value = room.client_description;
                        roomDescHTML[groupId] = room.client_description;
                    }
                    if (room.client_description_en) {
                        roomDescEN[groupId] = room.client_description_en;
                    }

                    // Load legacy images from JSONB
                    if (room.images && Array.isArray(room.images) && room.images.length > 0) {
                        groupImages[groupId] = room.images.map(img => ({ name: img.name, dataUrl: img.dataUrl, showInQuote: !!img.showInQuote, isLegacy: true }));
                    }

                    // Load room_media from dedicated table
                    try {
                        var mediaResp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/room_media?room_id=eq.' + room.id + '&order=sort_order.asc', {});
                        if (mediaResp.ok) {
                            var mediaRows = await mediaResp.json();
                            if (mediaRows.length > 0) {
                                if (!groupImages[groupId]) groupImages[groupId] = [];
                                mediaRows.forEach(function(m) {
                                    groupImages[groupId].push({
                                        name: m.cropped_url.split('/').pop() || 'image.jpg',
                                        url: m.cropped_url,
                                        originalUrl: m.original_url,
                                        mediaId: m.id,
                                        tags: m.tags || ['presentation_soumission'],
                                        cropRatio: m.crop_ratio,
                                        isLegacy: false,
                                        showInQuote: (m.tags || []).includes('presentation_soumission'),
                                        aiReference: (m.tags || []).includes('ai_reference'),
                                        annotations: m.annotations || []
                                    });
                                });
                            }
                        }
                    } catch (e) { console.error('Load room_media error:', e); }

                    if (groupImages[groupId] && groupImages[groupId].length > 0) {
                        renderGroupImagePreviews(groupId);
                    }

                    if (room.room_items && room.room_items.length > 0) {
                        var _loadedCascadeItems = []; // pour la 2e passe
                        room.room_items.forEach(item => {
                            var isCascade = !!item.parent_item_id;
                            const rowId = addRow(groupId, { existingId: item.id, skipSave: true, skipFocus: true, cascade: isCascade });

                            const row = document.getElementById(rowId);
                            const select = row.querySelector('.item-select');
                            const qtyInput = row.querySelector('.qty-input');

                            qtyInput.value = item.quantity || 1;

                            if (item.installation_included === false) {
                                var rowInstCb = document.getElementById(rowId + '-install');
                                if (rowInstCb) rowInstCb.checked = false;
                            }

                            if (item.item_type === 'custom') {
                                select.value = '__AJOUT__';
                                transformToAjoutMode(row, rowId);
                                const descInput = document.getElementById(`${rowId}-desc`);
                                const priceInput = document.getElementById(`${rowId}-price`);
                                const markupInput = document.getElementById(`${rowId}-markup`);
                                if (descInput) descInput.value = item.description || '';
                                if (priceInput) priceInput.value = item.unit_price || 0;
                                if (markupInput) markupInput.value = item.markup || 0;
                            } else if (item.catalogue_item_id) {
                                select.value = item.catalogue_item_id;
                            }

                            // Restore tag
                            if (item.tag) {
                                var tagInput = document.getElementById(rowId + '-tag');
                                if (tagInput) tagInput.value = item.tag;
                            }

                            // Restore dimensions L/H/P
                            if (item.length_in || item.height_in || item.depth_in) {
                                var dimsEl = document.getElementById(rowId + '-dims');
                                if (dimsEl) {
                                    dimsEl.dataset.l = item.length_in || '';
                                    dimsEl.dataset.h = item.height_in || '';
                                    dimsEl.dataset.p = item.depth_in || '';
                                }
                            }

                            // Mémoriser pour la 2e passe cascade
                            if (isCascade) _loadedCascadeItems.push({ rowId: rowId, parentItemId: item.parent_item_id });

                            updateRow(rowId);
                        });

                        // 2e passe : restaurer cascadeParentMap
                        _loadedCascadeItems.forEach(function(ci) {
                            var parentRowId = Object.keys(itemMap).find(function(k) { return itemMap[k] === ci.parentItemId; });
                            if (parentRowId) cascadeParentMap[ci.rowId] = parentRowId;
                        });
                    }
                }
            }

            updateWorkflowButtons();
            populateSubAssignment();
            loadSubmissionReviews(submissionId);
            // Refresh default materials UI + tag filter
            restoreDmPanelState();
            activeTagFilter = null;
            refreshTagFilterBar();
            var isEditable = isSubmissionCurrentlyEditable();
            setEditable(isEditable);
            showCalculator();

            // Init AI scope observer and observe all rendered group headers
            initAiScopeObserver();
            document.querySelectorAll('#calculatorView .furniture-group-header').forEach(function(h) {
                aiScopeObserver.observe(h);
            });

            if (isApprovalMode) {
                // Hide submission panel and project name edit in approval mode
                document.getElementById('headerSubPanel').style.display = 'none';
                document.getElementById('projName').readOnly = true;
                document.getElementById('btnBackProjects').innerHTML = '&larr; Approbations';
            } else {
                renderHeaderSubmissionList();
            }
        }

        // ── Submission assignment ──

        function populateSubAssignment() {
            var row = document.getElementById('subAssignmentRow');
            if (!currentSubmission) { row.style.display = 'none'; return; }
            row.style.display = '';

            ['saEstimateur', 'saVendeur', 'saApprobateur'].forEach(function(id) {
                var sel = document.getElementById(id);
                var val = sel.value;
                sel.innerHTML = '<option value="">—</option>';
                EMPLOYEES_DATA.forEach(function(e) {
                    sel.innerHTML += '<option value="' + escapeAttr(e.name) + '">' + escapeHtml(e.name) + '</option>';
                });
            });

            document.getElementById('saEstimateur').value = currentSubmission.estimateur || '';
            document.getElementById('saVendeur').value = currentSubmission.vendeur_cp || '';
            document.getElementById('saApprobateur').value = currentSubmission.approbateur || '';
            document.getElementById('saInternalDeadline').value = currentSubmission.internal_deadline || '';
            document.getElementById('saClientDeadline').value = currentSubmission.client_deadline || '';
        }

        function saveSubAssignment() {
            if (!currentSubmission) return;
            var fields = {
                estimateur: document.getElementById('saEstimateur').value || null,
                vendeur_cp: document.getElementById('saVendeur').value || null,
                approbateur: document.getElementById('saApprobateur').value || null,
                internal_deadline: document.getElementById('saInternalDeadline').value || null,
                client_deadline: document.getElementById('saClientDeadline').value || null
            };
            Object.assign(currentSubmission, fields);
            updateSubmission(currentSubmission.id, fields).catch(function(e) { console.error('Save sub assignment:', e); });
            showSaveIndicator();
        }

        // Panneau de soumissions dans le calculateur
        async function renderHeaderSubmissionList() {
            var panel = document.getElementById('headerSubPanel');
            var list = document.getElementById('headerSubList');
            if (!currentProject) { panel.style.display = 'none'; return; }

            var subs = await loadSubmissions(currentProject.id);
            var html = '';
            subs.forEach(function(sub) {
                if (sub.is_archived && !pipelineFilters.showArchived) return;
                var label = STATUS_LABELS[sub.status] || sub.status || 'Brouillon';
                var isActive = currentSubmission && currentSubmission.id === sub.id;
                var lineClass = 'sub-line' + (isActive ? ' active' : '') + (sub.is_archived ? ' archived' : '');
                html += '<div class="' + lineClass + '" data-subid="' + escapeAttr(sub.id) + '">' +
                    '<span class="sub-number">#' + escapeHtml(String(sub.submission_number)) + '</span> ' +
                    '<span class="sub-title">' + escapeHtml(sub.title || 'Sans titre') + '</span>' +
                    '<span class="project-status-badge status-' + escapeAttr(sub.status) + '">' + escapeHtml(label) + (sub.bypass_approval ? ' <span class="bypass-badge">BYPASS</span>' : '') + '</span>' +
                    '</div>';
            });
            list.innerHTML = html || '<div class="sub-empty">Aucune soumission</div>';
            panel.style.display = 'block';
            restoreSubPanelState();

            list.querySelectorAll('.sub-line').forEach(function(el) {
                el.addEventListener('click', function() {
                    var subId = el.getAttribute('data-subid');
                    if (currentSubmission && currentSubmission.id === subId) return;
                    openSubmission(subId);
                });
            });
        }

        function toggleSubPanel() {
            var body = document.getElementById('headerSubBody');
            var chevron = document.getElementById('subPanelChevron');
            var collapsed = !body.classList.contains('collapsed');
            body.classList.toggle('collapsed', collapsed);
            chevron.classList.toggle('open', !collapsed);
            localStorage.setItem('subPanelCollapsed', collapsed ? '1' : '');
        }

        // Restore collapse state on panel show
        function restoreSubPanelState() {
            if (localStorage.getItem('subPanelCollapsed') === '1') {
                var body = document.getElementById('headerSubBody');
                var chevron = document.getElementById('subPanelChevron');
                if (body) body.classList.add('collapsed');
                if (chevron) chevron.classList.remove('open');
            }
        }

        async function handleAddSubmissionFromCalc() {
            if (!currentProject) return;
            var title = await stelePrompt('Titre de la nouvelle soumission :', 'Nouvelle soumission');
            if (title === null) return;
            try {
                var sub = await createSubmission(currentProject.id, title || '');
                await openSubmission(sub.id);
            } catch (e) {
                console.error('Erreur cr\u00e9ation soumission:', e);
                steleAlert('Erreur lors de la cr\u00e9ation de la soumission.');
            }
        }

        // Legacy wrapper pour compatibilité — ouvre la première soumission du projet
        async function openProject(projectId) {
            const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/projects?id=eq.' + projectId + '&select=*,submissions(id,submission_number,title,status,updated_at,is_archived)', {});
            if (!r.ok) return;
            const data = await r.json();
            if (data.length === 0) return;

            var project = data[0];
            var subs = project.submissions || [];
            if (subs.length === 0) {
                // Pas de soumission → en créer une
                var newSub = await createSubmission(projectId, project.name || 'Soumission initiale');
                await openSubmission(newSub.id, project);
            } else {
                // Ouvrir la plus récente
                subs.sort(function(a, b) { return (b.updated_at || '').localeCompare(a.updated_at || ''); });
                await openSubmission(subs[0].id, project);
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // SAUVEGARDER CHAMPS HEADER PROJET
        // ═══════════════════════════════════════════════════════════════════════

        function saveProjectField() {
            // Name is now auto-generated by DB trigger (readonly field)
            // Kept for backward compatibility but does nothing
        }

        function saveSubmissionField() {
            if (!currentSubmission) return;
            var title = document.getElementById('subTitle').value.trim();
            currentSubmission.title = title;
            updateSubmission(currentSubmission.id, { title: title }).catch(function(e) { console.error('Save title:', e); });
            showSaveIndicator();
        }

        // ═══════════════════════════════════════════════════════════════════════
        // VERROUILLAGE ÉDITION
        // ═══════════════════════════════════════════════════════════════════════

        function isSubmissionCurrentlyEditable() {
            if (!currentSubmission) return true;
            var s = currentSubmission.status;
            return s === 'draft' || s === 'returned' ||
                   (s === 'pending_internal' && canApproveQuotes);
        }

        function setEditable(editable) {
            // Inputs et selects du calculateur
            var container = document.getElementById('calculatorView');
            if (!container) return;

            container.querySelectorAll('.item-select, .qty-input, .markup-input, .ajout-desc, .ajout-price, .ajout-markup, .client-desc-textarea').forEach(function(el) {
                el.disabled = !editable;
                el.style.opacity = editable ? '' : '0.6';
            });

            // Boutons ajouter meuble/ligne, supprimer
            container.querySelectorAll('.btn-add-group, .btn-add, .btn-remove, .btn-remove-group, .furniture-name-input').forEach(function(el) {
                if (el.tagName === 'BUTTON') {
                    el.disabled = !editable;
                    el.style.opacity = editable ? '' : '0.4';
                } else {
                    el.readOnly = !editable;
                    el.style.opacity = editable ? '' : '0.6';
                }
            });

            // Installation toggles
            container.querySelectorAll('input[type="checkbox"]').forEach(function(el) {
                el.disabled = !editable;
            });

            // Bouton "Soumettre pour approbation" en bas
            var btnOpenSubmit = document.getElementById('btnOpenSubmit');
            if (btnOpenSubmit) {
                btnOpenSubmit.disabled = !editable;
                btnOpenSubmit.style.opacity = editable ? '' : '0.4';
            }

            // Header fields
            var subTitle = document.getElementById('subTitle');
            if (subTitle) subTitle.readOnly = !editable;

            // Image drop zones + file inputs
            container.querySelectorAll('.drop-zone, .image-upload-input').forEach(function(el) {
                if (el.tagName === 'INPUT') {
                    el.disabled = !editable;
                }
                el.style.pointerEvents = editable ? '' : 'none';
                el.style.opacity = editable ? '' : '0.4';
            });

            // Bannière de statut
            var banner = document.getElementById('lockBanner');
            if (!editable && currentSubmission) {
                var label = STATUS_LABELS[currentSubmission.status] || currentSubmission.status;
                if (!banner) {
                    banner = document.createElement('div');
                    banner.id = 'lockBanner';
                    banner.style.cssText = 'background:#fff3e0; color:#e65100; padding:10px 16px; border-radius:6px; font-size:13px; font-weight:600; margin-bottom:12px; text-align:center;';
                    var calcContainer = document.querySelector('.calculator-container');
                    if (calcContainer) calcContainer.parentNode.insertBefore(banner, calcContainer);
                }
                banner.textContent = 'Soumission verrouill\u00e9e \u2014 Statut : ' + label;
                banner.style.display = '';
            } else if (banner) {
                banner.style.display = 'none';
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // HISTORIQUE DES VERSIONS
        // ═══════════════════════════════════════════════════════════════════════

        async function openVersionDrawer() {
            var drawer = document.getElementById('versionDrawer');
            drawer.style.display = 'flex';
            var list = document.getElementById('versionList');
            list.innerHTML = '<div style="text-align:center;padding:20px;color:#999;">Chargement...</div>';
            if (!currentSubmission) { list.innerHTML = '<p style="text-align:center;color:#999;">Aucune soumission</p>'; return; }

            try {
                var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/project_versions?submission_id=eq.' + currentSubmission.id + '&order=version_number.desc&select=id,version_number,status_at_save,created_at,created_by', {});
                if (!r.ok) throw new Error(r.status);
                var versions = await r.json();

                if (versions.length === 0) {
                    list.innerHTML = '<p style="text-align:center;color:#999;padding:20px;">Aucune version enregistr\u00e9e</p>';
                    return;
                }

                list.innerHTML = versions.map(function(v) {
                    var label = STATUS_LABELS[v.status_at_save] || v.status_at_save;
                    var date = new Date(v.created_at).toLocaleString('fr-CA');
                    return '<div class="version-card" onclick="viewVersion(\'' + v.id + '\')">' +
                        '<div style="font-weight:600;">Version ' + v.version_number + '</div>' +
                        '<div style="font-size:12px;color:#666;">' + date + ' \u2014 ' + label + '</div></div>';
                }).join('');
            } catch (e) {
                console.error('Erreur chargement versions:', e);
                list.innerHTML = '<p style="text-align:center;color:#c62828;">Erreur chargement</p>';
            }
        }

        function closeVersionDrawer() {
            document.getElementById('versionDrawer').style.display = 'none';
        }

        async function viewVersion(versionId) {
            try {
                var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/project_versions?id=eq.' + versionId + '&select=snapshot,version_number,status_at_save,created_at', {});
                if (!r.ok) return;
                var data = (await r.json())[0];
                if (!data) return;
                renderVersionSnapshot(data);
            } catch (e) {
                console.error('Erreur affichage version:', e);
            }
        }

        function renderVersionSnapshot(data) {
            var snap = data.snapshot;
            if (!snap) { steleAlert('Snapshot vide'); return; }
            var overlay = document.createElement('div');
            overlay.className = 'version-snapshot-overlay';
            overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };

            var html = '<div style="max-width:900px;margin:auto;background:#fff;border-radius:12px;padding:32px;">';
            html += '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">';
            html += '<h2 style="margin:0;">Version ' + data.version_number + ' \u2014 ' + (STATUS_LABELS[data.status_at_save] || data.status_at_save) + '</h2>';
            html += '<button onclick="this.closest(\'.version-snapshot-overlay\').remove()" style="font-size:24px;background:none;border:none;cursor:pointer;color:#666;">&times;</button></div>';

            // Infos projet/client si disponibles
            if (snap.projectName || snap.clientName) {
                html += '<div style="margin-bottom:16px;padding:12px;background:#f5f5f5;border-radius:8px;font-size:13px;">';
                if (snap.projectName) html += '<div><strong>Projet :</strong> ' + escapeHtml(snap.projectName) + '</div>';
                if (snap.clientName) html += '<div><strong>Client :</strong> ' + escapeHtml(snap.clientName) + '</div>';
                if (snap.designer) html += '<div><strong>Designer :</strong> ' + escapeHtml(snap.designer) + '</div>';
                html += '</div>';
            }

            // Render chaque meuble
            (snap.meubles || []).forEach(function(m) {
                html += '<div style="border:1px solid #e0e0e0;border-radius:8px;margin-bottom:16px;overflow:hidden;">';
                html += '<div style="background:var(--sw-navy);color:#fff;padding:10px 16px;font-weight:600;">' + escapeHtml(m.name) + ' \u2014 ' + m.subtotal + ' $</div>';
                html += '<table style="width:100%;border-collapse:collapse;font-size:13px;">';
                html += '<thead><tr style="background:#f5f5f5;"><th style="padding:6px 12px;text-align:left;">Description</th><th style="padding:6px;text-align:right;">Qt\u00e9</th><th style="padding:6px;text-align:right;">Prix unit.</th><th style="padding:6px;text-align:right;">Total</th></tr></thead>';
                (m.items || []).forEach(function(it) {
                    html += '<tr style="border-bottom:1px solid #f0f0f0;"><td style="padding:6px 12px;">' + escapeHtml(it.description) + '</td>';
                    html += '<td style="padding:6px;text-align:right;">' + it.qty + '</td>';
                    html += '<td style="padding:6px;text-align:right;">' + it.unitPrice + ' $</td>';
                    html += '<td style="padding:6px;text-align:right;font-weight:600;">' + it.lineTotal + ' $</td></tr>';
                });
                html += '</table>';
                if (m.clientDescription) {
                    html += '<div style="padding:10px 16px;border-top:1px solid #e0e0e0;font-size:13px;color:#555;"><strong>Description client :</strong> ' + escapeHtml(m.clientDescription).replace(/\n/g, '<br>') + '</div>';
                }
                html += '</div>';
            });

            html += '<div style="text-align:right;font-size:20px;font-weight:700;margin-top:16px;">Total : ' + snap.total + ' $</div>';
            html += '</div>';
            overlay.innerHTML = html;
            document.body.appendChild(overlay);
        }

        // ═══════════════════════════════════════════════════════════════════════
        // DUPLICATION DE SOUMISSION
        // ═══════════════════════════════════════════════════════════════════════

        async function duplicateSubmission() {
            if (!currentSubmission) return;
            if (!(await steleConfirm('Dupliquer cette soumission en nouveau brouillon ?\nLes pi\u00e8ces, articles et images seront copi\u00e9s.', 'Dupliquer la soumission', 'Dupliquer'))) return;
            try {
                var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/rpc/duplicate_submission', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ p_submission_id: currentSubmission.id })
                });
                if (!r.ok) throw new Error('Erreur duplication: ' + r.status);
                var newSubId = await r.json();

                await createSubmissionReview(currentSubmission.id, 'duplicated', 'Soumission dupliqu\u00e9e \u2192 nouveau brouillon');
                steleAlert('Soumission dupliqu\u00e9e avec succ\u00e8s!');
                openSubmission(newSubId);
            } catch (e) {
                console.error('Erreur duplication:', e);
                steleAlert('Erreur: ' + e.message);
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // DÉVERROUILLAGE D'URGENCE
        // ═══════════════════════════════════════════════════════════════════════

        function unlockSubmission() {
            if (!currentSubmission || !canUnlockSubmission) return;
            document.getElementById('unlockUserName').value = '';
            document.getElementById('unlockReason').value = '';
            document.getElementById('unlockConfirmCheck').checked = false;
            document.getElementById('unlockStatus').style.display = 'none';
            document.getElementById('btnUnlockConfirm').disabled = false;
            document.getElementById('unlockModal').classList.add('active');
        }

        function closeUnlockModal() {
            document.getElementById('unlockModal').classList.remove('active');
        }

        function showUnlockStatus(msg, isError) {
            var el = document.getElementById('unlockStatus');
            el.style.display = 'block';
            el.textContent = msg;
            el.style.background = isError ? '#ffebee' : '#e8f5e9';
            el.style.color = isError ? '#c62828' : '#2e7d32';
        }

        async function executeUnlock() {
            var userName = document.getElementById('unlockUserName').value.trim();
            var reason = document.getElementById('unlockReason').value.trim();

            if (!userName) { showUnlockStatus('Le nom est obligatoire.', true); return; }
            if (!reason) { showUnlockStatus('La raison est obligatoire.', true); return; }
            if (!document.getElementById('unlockConfirmCheck').checked) {
                showUnlockStatus('Vous devez cocher la case de confirmation.', true);
                return;
            }

            var btn = document.getElementById('btnUnlockConfirm');
            btn.disabled = true;
            showUnlockStatus('D\u00e9verrouillage en cours...', false);

            try {
                // 1. Snapshot avant d\u00e9verrouillage
                await createVersion(currentSubmission.id);

                // 2. Log immuable via RPC (IP captur\u00e9e c\u00f4t\u00e9 serveur)
                var rpcResp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/rpc/log_submission_unlock', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        p_submission_id: currentSubmission.id,
                        p_user_name: userName,
                        p_reason: reason,
                        p_previous_status: currentSubmission.status
                    })
                });
                if (!rpcResp.ok) throw new Error('Erreur journalisation: ' + rpcResp.status);

                // 3. Remettre en brouillon
                await updateSubmission(currentSubmission.id, { status: 'draft' });

                // 4. Timeline
                await createSubmissionReview(currentSubmission.id, 'unlocked',
                    'D\u00c9VERROUILLAGE par ' + userName + ' \u2014 Raison: ' + reason);

                // 5. UI
                currentSubmission.status = 'draft';
                updateStatusBadge('draft');
                updateWorkflowButtons();
                setEditable(true);
                loadSubmissionReviews(currentSubmission.id);

                showUnlockStatus('Soumission d\u00e9verrouill\u00e9e!', false);
                setTimeout(function() { closeUnlockModal(); }, 1000);
            } catch (e) {
                console.error('Erreur d\u00e9verrouillage:', e);
                showUnlockStatus('Erreur: ' + e.message, true);
                btn.disabled = false;
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // PROJECT INFO BLOC
        // ═══════════════════════════════════════════════════════════════════════

        function renderProjectInfoBloc() {
            var el = document.getElementById('projInfoText');
            if (!el || !currentProject) { if (el) { el.className = 'ph-info-empty'; el.textContent = ''; } return; }

            var parts = [];
            if (currentProject.client_name) parts.push(escapeHtml(currentProject.client_name));

            // Read from new columns, fallback to local cache, fallback to legacy
            var addr = currentProject.project_address || currentProject._address || '';
            var city = currentProject.project_city || currentProject._city || '';
            var postal = currentProject.project_postal_code || currentProject._postal || '';
            if (!addr && !city && !postal && currentProject.client_address) {
                var parsed = currentProject.client_address.split(',').map(function(s) { return s.trim(); });
                addr = parsed[0] || '';
                city = parsed[1] || '';
                postal = parsed[2] || '';
            }

            var addrParts = [];
            if (addr) addrParts.push(escapeHtml(addr));
            if (city) addrParts.push(escapeHtml(city));
            if (postal) addrParts.push(escapeHtml(postal));

            if (addrParts.length > 0) parts.push('<span>' + addrParts.join(', ') + '</span>');

            if (parts.length === 0) {
                el.className = 'ph-info-empty';
                el.textContent = 'Ajouter les infos du projet';
            } else {
                el.className = 'ph-info-text';
                el.innerHTML = parts.join(' \u2014 ');
            }
        }

        async function openEditInfoModal() {
            if (!currentProject) return;
            document.getElementById('editInfoModal').classList.add('active');
            // Read from new columns, fallback to legacy client_address, fallback to local cache
            var addr = currentProject.project_address || currentProject._address || '';
            var city = currentProject.project_city || currentProject._city || '';
            var postal = currentProject.project_postal_code || currentProject._postal || '';
            // If new columns empty but legacy client_address has data, parse it
            if (!addr && !city && !postal && currentProject.client_address) {
                var parts = currentProject.client_address.split(',').map(function(s) { return s.trim(); });
                addr = parts[0] || '';
                city = parts[1] || '';
                postal = parts[2] || '';
            }
            document.getElementById('infoProjectAddress').value = addr;
            document.getElementById('infoProjectCity').value = city;
            document.getElementById('infoProjectPostalCode').value = postal;
            document.getElementById('addrSuggestPanel').style.display = 'none';

            // Init client combobox
            selectedClientType = null;
            selectedClientId = null;
            var comboInput = document.getElementById('infoClientCombo');
            var selDiv = document.getElementById('clientComboSelected');
            comboInput.value = currentProject.client_name || '';
            selDiv.textContent = '';

            // Pre-select existing client link
            if (currentProject.client_contact_id) {
                selectedClientType = 'contact';
                selectedClientId = currentProject.client_contact_id;
                selDiv.textContent = '\u2713 Contact li\u00e9';
            } else if (currentProject.client_company_id) {
                selectedClientType = 'company';
                selectedClientId = currentProject.client_company_id;
                selDiv.textContent = '\u2713 Entreprise li\u00e9e';
            }

            await loadAllContactsForCombo();
            await loadAllCompaniesForCombo();

            // Pipeline fields
            var psSelect = document.getElementById('infoPipelineStatus');
            psSelect.innerHTML = '';
            pipelineStatuses.forEach(function(s) {
                psSelect.innerHTML += '<option value="' + escapeAttr(s.slug) + '">' + escapeHtml(s.label) + '</option>';
            });
            psSelect.value = currentProject.pipeline_status || 'a_contacter';

            document.getElementById('infoPriority').value = currentProject.priority || 'normal';

            var srcSelect = document.getElementById('infoSource');
            srcSelect.innerHTML = '<option value="">—</option>';
            projectSources.forEach(function(s) { srcSelect.innerHTML += '<option value="' + escapeAttr(s) + '">' + escapeHtml(s) + '</option>'; });
            srcSelect.value = currentProject.source || '';

            var typeSelect = document.getElementById('infoProjectType');
            typeSelect.innerHTML = '<option value="">—</option>';
            projectTypes.forEach(function(t) { typeSelect.innerHTML += '<option value="' + escapeAttr(t) + '">' + escapeHtml(t) + '</option>'; });
            typeSelect.value = currentProject.project_type || '';

            document.getElementById('infoEstimatedAmount').value = currentProject.estimated_amount || '';

            var probSlider = document.getElementById('infoProbability');
            probSlider.value = currentProject.probability || 0;
            document.getElementById('infoProbVal').textContent = (currentProject.probability || 0) + '%';

            var assignSelect = document.getElementById('infoAssignedTo');
            assignSelect.innerHTML = '<option value="">—</option>';
            EMPLOYEES_DATA.forEach(function(e) { assignSelect.innerHTML += '<option value="' + escapeAttr(e.name) + '">' + escapeHtml(e.name) + '</option>'; });
            assignSelect.value = currentProject.assigned_to || '';

            document.getElementById('infoDeliveryMonth').value = currentProject.delivery_month || '';
            document.getElementById('infoInternalDeadline').value = currentProject.internal_deadline || '';
            document.getElementById('infoClientDeadline').value = currentProject.client_deadline || '';
        }

        function closeEditInfoModal() {
            document.getElementById('editInfoModal').classList.remove('active');
            closeClientCombo();
        }

        async function saveProjectInfo() {
            if (!currentProject) return;
            var address = document.getElementById('infoProjectAddress').value.trim();
            var city = document.getElementById('infoProjectCity').value.trim();
            var postal = document.getElementById('infoProjectPostalCode').value.trim();
            var clientName = document.getElementById('infoClientCombo').value.trim();

            // Build full address for client_address fallback
            var fullAddr = [address, city, postal].filter(Boolean).join(', ');

            // Pipeline fields
            var pipelineStatus = document.getElementById('infoPipelineStatus').value;
            var priority = document.getElementById('infoPriority').value;
            var source = document.getElementById('infoSource').value || null;
            var projectType = document.getElementById('infoProjectType').value || null;
            var estimatedAmount = parseFloat(document.getElementById('infoEstimatedAmount').value) || null;
            var probability = parseInt(document.getElementById('infoProbability').value) || 0;
            var assignedTo = document.getElementById('infoAssignedTo').value || null;
            var deliveryMonth = document.getElementById('infoDeliveryMonth').value || null;
            var internalDeadline = document.getElementById('infoInternalDeadline').value || null;
            var clientDeadline = document.getElementById('infoClientDeadline').value || null;

            // Compute name from code + city (trigger does this too, but safeguard client-side)
            var computedName = currentProject.project_code
                ? (city ? currentProject.project_code + ' ' + city : currentProject.project_code)
                : (currentProject.name || '');

            // Try with new columns first, fallback to legacy columns
            var updateObj = {
                name: computedName,
                client_name: clientName,
                project_address: address,
                project_city: city,
                project_postal_code: postal,
                client_contact_id: selectedClientType === 'contact' ? selectedClientId : null,
                client_company_id: selectedClientType === 'company' ? selectedClientId : null,
                pipeline_status: pipelineStatus,
                priority: priority,
                source: source,
                project_type: projectType,
                estimated_amount: estimatedAmount,
                probability: probability,
                assigned_to: assignedTo,
                delivery_month: deliveryMonth,
                internal_deadline: internalDeadline,
                client_deadline: clientDeadline
            };

            try {
                var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/projects?id=eq.' + currentProject.id, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                    body: JSON.stringify(updateObj)
                });
                if (!r.ok) {
                    // New columns probably don't exist yet — fallback to legacy columns
                    var fallbackObj = {
                        client_name: clientName,
                        client_address: fullAddr
                    };
                    var r2 = await authenticatedFetch(SUPABASE_URL + '/rest/v1/projects?id=eq.' + currentProject.id, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                        body: JSON.stringify(fallbackObj)
                    });
                    if (r2.ok) {
                        var rows2 = await r2.json();
                        if (rows2.length > 0) {
                            currentProject = rows2[0];
                            // Store parsed values locally for display
                            currentProject._address = address;
                            currentProject._city = city;
                            currentProject._postal = postal;
                        }
                        renderProjectInfoBloc();
                        closeEditInfoModal();
                        console.warn('Saved with legacy columns. Run sql/project_info_columns.sql to enable full support.');
                    } else {
                        var errText = await r2.text();
                        console.error('Save project info fallback failed:', errText);
                        alert('Erreur lors de la sauvegarde : ' + errText);
                    }
                    return;
                }
                var rows = await r.json();
                if (rows.length > 0) {
                    currentProject = rows[0];
                    // Update header with trigger-generated name (code + city)
                    document.getElementById('projName').value = currentProject.name || '';
                }
                renderProjectInfoBloc();
                closeEditInfoModal();
            } catch (e) {
                console.error('Error saving project info:', e);
                alert('Erreur lors de la sauvegarde des infos projet.');
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // CLIENT COMBOBOX (in edit info modal)
        // ═══════════════════════════════════════════════════════════════════════

        async function loadAllContactsForCombo() {
            try {
                var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/contacts?select=id,first_name,last_name,email,phone,contact_companies(companies(id,name))&order=last_name', {});
                if (r.ok) allContactsCache = await r.json();
            } catch (e) { console.warn('Error loading contacts for combo:', e); }
        }

        async function loadAllCompaniesForCombo() {
            try {
                var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/companies?select=id,name,contact_companies(contacts(id,first_name,last_name))&order=name', {});
                if (r.ok) allCompaniesCache = await r.json();
            } catch (e) { console.warn('Error loading companies for combo:', e); }
        }

        function openClientCombo() {
            var dd = document.getElementById('clientComboDd');
            populateClientCombo(dd, '');
            dd.classList.add('open');
        }

        function filterClientCombo(input) {
            var dd = document.getElementById('clientComboDd');
            populateClientCombo(dd, input.value);
            dd.classList.add('open');
        }

        function populateClientCombo(dd, filter) {
            var html = '';
            var f = (filter || '').toLowerCase();

            // Contacts section
            var contacts = allContactsCache.filter(function(c) {
                var name = ((c.first_name || '') + ' ' + (c.last_name || '')).toLowerCase();
                return !f || name.indexOf(f) !== -1 || (c.email || '').toLowerCase().indexOf(f) !== -1;
            });
            if (contacts.length > 0) {
                html += '<div class="combo-section-header">Contacts</div>';
                for (var i = 0; i < Math.min(contacts.length, 10); i++) {
                    var c = contacts[i];
                    var name = ((c.first_name || '') + ' ' + (c.last_name || '')).trim();
                    html += '<div class="contact-combo-item" onclick="selectClient(this)" data-type="contact" data-id="' + escapeAttr(c.id) + '" data-name="' + escapeAttr(name) + '">' +
                        escapeHtml(name) + (c.email ? ' <small>' + escapeHtml(c.email) + '</small>' : '') + '</div>';
                }
            }

            // Companies section
            var companies = allCompaniesCache.filter(function(co) {
                return !f || (co.name || '').toLowerCase().indexOf(f) !== -1;
            });
            if (companies.length > 0) {
                html += '<div class="combo-section-header">Entreprises</div>';
                for (var j = 0; j < Math.min(companies.length, 10); j++) {
                    var co = companies[j];
                    html += '<div class="contact-combo-item" onclick="selectClient(this)" data-type="company" data-id="' + escapeAttr(co.id) + '" data-name="' + escapeAttr(co.name) + '">' +
                        escapeHtml(co.name) + '</div>';
                }
            }

            dd.innerHTML = html || '<div class="contact-combo-item" style="color:#999;">Aucun contact trouv\u00e9</div>';
        }

        function selectClient(el) {
            var type = el.getAttribute('data-type');
            var id = el.getAttribute('data-id');
            var name = el.getAttribute('data-name');
            selectedClientType = type;
            selectedClientId = id;
            document.getElementById('infoClientCombo').value = name;
            document.getElementById('clientComboSelected').textContent = '\u2713 ' + (type === 'contact' ? 'Contact' : 'Entreprise') + ' li\u00e9(e)';
            closeClientCombo();
            promptClientAddress();
        }

        function closeClientCombo() {
            var dd = document.getElementById('clientComboDd');
            if (dd) dd.classList.remove('open');
        }

        function promptClientAddress() {
            var panel = document.getElementById('addrSuggestPanel');
            if (!panel) return;
            var addresses = [];
            if (selectedClientType === 'contact') {
                var c = allContactsCache.find(function(x) { return x.id === selectedClientId; });
                if (c && Array.isArray(c.addresses)) addresses = c.addresses;
            } else if (selectedClientType === 'company') {
                var co = allCompaniesCache.find(function(x) { return x.id === selectedClientId; });
                if (co && Array.isArray(co.addresses)) addresses = co.addresses;
            }
            if (addresses.length === 0) { panel.style.display = 'none'; return; }
            var html = '<div style="margin-top:8px; padding:8px 12px; background:#f9f9f9; border-radius:6px; border:1px solid #eee;">';
            html += '<div style="font-size:12px; font-weight:600; color:#666; margin-bottom:6px;">Utiliser une adresse existante ?</div>';
            for (var i = 0; i < addresses.length; i++) {
                var a = addresses[i];
                var parts = [a.line1, a.city, a.postal_code].filter(Boolean).join(', ');
                html += '<div style="padding:4px 0; cursor:pointer; color:var(--sw-navy); font-size:13px;" onclick="applyClientAddress(' + i + ')">' +
                    (a.label ? '<strong>' + escapeHtml(a.label) + ':</strong> ' : '') + escapeHtml(parts) + '</div>';
            }
            html += '</div>';
            panel.innerHTML = html;
            panel.style.display = 'block';
        }

        function applyClientAddress(idx) {
            var addresses = [];
            if (selectedClientType === 'contact') {
                var c = allContactsCache.find(function(x) { return x.id === selectedClientId; });
                if (c && Array.isArray(c.addresses)) addresses = c.addresses;
            } else if (selectedClientType === 'company') {
                var co = allCompaniesCache.find(function(x) { return x.id === selectedClientId; });
                if (co && Array.isArray(co.addresses)) addresses = co.addresses;
            }
            if (!addresses[idx]) return;
            var a = addresses[idx];
            document.getElementById('infoProjectAddress').value = a.line1 || '';
            document.getElementById('infoProjectCity').value = a.city || '';
            document.getElementById('infoProjectPostalCode').value = a.postal_code || '';
            document.getElementById('addrSuggestPanel').style.display = 'none';
        }

        async function createNewClientContact() {
            closeClientCombo();
            var firstName = await stelePrompt('Pr\u00e9nom du nouveau contact :', 'Nouveau contact', 'Cr\u00e9er');
            if (!firstName || !firstName.trim()) return;
            var lastName = await stelePrompt('Nom de famille :', 'Nouveau contact', 'Cr\u00e9er');
            if (!lastName || !lastName.trim()) return;
            try {
                var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/contacts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                    body: JSON.stringify({ first_name: firstName.trim(), last_name: lastName.trim(), created_by: localStorage.getItem('sb_user_id') })
                });
                if (r.ok) {
                    var res = await r.json();
                    if (res.length > 0) {
                        allContactsCache.push(res[0]);
                        selectedClientType = 'contact';
                        selectedClientId = res[0].id;
                        document.getElementById('infoClientCombo').value = firstName.trim() + ' ' + lastName.trim();
                        document.getElementById('clientComboSelected').textContent = '\u2713 Contact cr\u00e9\u00e9 et li\u00e9';
                    }
                }
            } catch (e) { console.warn('Error creating contact:', e); }
        }

        async function createNewClientCompany() {
            closeClientCombo();
            var name = await stelePrompt('Nom de l\'entreprise :', 'Nouvelle entreprise', 'Cr\u00e9er');
            if (!name || !name.trim()) return;
            try {
                var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/companies', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                    body: JSON.stringify({ name: name.trim(), created_by: localStorage.getItem('sb_user_id') })
                });
                if (r.ok) {
                    var res = await r.json();
                    if (res.length > 0) {
                        allCompaniesCache.push(res[0]);
                        selectedClientType = 'company';
                        selectedClientId = res[0].id;
                        document.getElementById('infoClientCombo').value = name.trim();
                        document.getElementById('clientComboSelected').textContent = '\u2713 Entreprise cr\u00e9\u00e9e et li\u00e9e';
                    }
                }
            } catch (e) { console.warn('Error creating company:', e); }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // CONTACTS MODAL
        // ═══════════════════════════════════════════════════════════════════════

        async function openContactsModal() {
            if (!currentProject) { steleAlert('Veuillez ouvrir un projet d\'abord.'); return; }
            document.getElementById('contactsModal').classList.add('active');
            await loadProjectContacts();
            renderContactCards();
        }

        function closeContactsModal() {
            document.getElementById('contactsModal').classList.remove('active');
        }

        async function loadProjectContacts() {
            if (!currentProject) { projectContacts = []; return; }
            try {
                var r = await authenticatedFetch(
                    SUPABASE_URL + '/rest/v1/project_contacts?project_id=eq.' + currentProject.id +
                    '&select=*,contacts(id,first_name,last_name,email,phone,address,notes,contact_companies(companies(id,name)))' +
                    '&order=sort_order', {}
                );
                if (r.ok) {
                    projectContacts = await r.json();
                } else {
                    projectContacts = [];
                }
            } catch (e) {
                console.warn('Error loading project contacts:', e);
                projectContacts = [];
            }
        }

        async function loadContactRoles() {
            try {
                var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/app_config?key=eq.contact_roles&select=value', {});
                if (r.ok) {
                    var rows = await r.json();
                    if (rows.length > 0 && Array.isArray(rows[0].value)) configContactRoles = rows[0].value;
                }
            } catch (e) { /* keep defaults */ }
            var dl = document.getElementById('contactRoleOptions');
            if (dl) {
                dl.innerHTML = '';
                for (var i = 0; i < configContactRoles.length; i++) {
                    var opt = document.createElement('option');
                    opt.value = configContactRoles[i];
                    dl.appendChild(opt);
                }
            }
        }

        function renderContactBadges() {
            var strip = document.getElementById('projContactsStrip');
            if (!strip) return;
            if (!projectContacts || projectContacts.length === 0) {
                strip.innerHTML = '<span class="ph-contact-badge" onclick="openContactsModal()" style="border-style:dashed;">+ Contacts</span>';
                return;
            }
            var MAX_BADGES = 4;
            var html = '';
            var shown = Math.min(projectContacts.length, MAX_BADGES);
            for (var i = 0; i < shown; i++) {
                var pc = projectContacts[i];
                var c = pc.contacts;
                if (!c) continue;
                var name = ((c.first_name || '') + ' ' + (c.last_name || '')).trim();
                var companies = (c.contact_companies || []).map(function(cc) { return cc.companies ? cc.companies.name : ''; }).filter(Boolean);
                var displayName = companies.length > 0 ? name + ' \u00b7 ' + companies[0] : name;
                html += '<span class="ph-contact-badge" onclick="openContactsModal()" title="' + escapeAttr(name) + '">' +
                    '<span class="ph-contact-badge-role">' + escapeHtml(pc.role) + '</span> ' +
                    escapeHtml(displayName) +
                '</span>';
            }
            if (projectContacts.length > MAX_BADGES) {
                html += '<span class="ph-contacts-more" onclick="openContactsModal()">+' + (projectContacts.length - MAX_BADGES) + '</span>';
            }
            strip.innerHTML = html;
        }

        function renderContactCards() {
            var grid = document.getElementById('contactCardsGrid');
            var html = '';
            var usedRoles = {};

            // Count contacts per role to decide whether to show star
            var roleCounts = {};
            projectContacts.forEach(function(pc) { roleCounts[pc.role] = (roleCounts[pc.role] || 0) + 1; });

            for (var i = 0; i < projectContacts.length; i++) {
                var pc = projectContacts[i];
                var c = pc.contacts;
                if (!c) continue;
                usedRoles[pc.role] = true;

                var fullName = ((c.first_name || '') + ' ' + (c.last_name || '')).trim();
                var companiesData = (c.contact_companies || []).map(function(cc) {
                    return cc.companies ? { id: cc.companies.id, name: cc.companies.name } : null;
                }).filter(Boolean);
                var companyStr = companiesData.map(function(co) { return escapeHtml(co.name); }).join(', ');

                var starHtml = '';
                if (roleCounts[pc.role] > 1) {
                    var starCls = pc.is_primary ? 'contact-primary-star active' : 'contact-primary-star';
                    var starIcon = pc.is_primary ? '&#9733;' : '&#9734;';
                    starHtml = '<span class="' + starCls + '" onclick="togglePrimaryContact(\'' + escapeAttr(pc.id) + '\',\'' + escapeAttr(pc.role) + '\')" title="' + (pc.is_primary ? 'Contact principal' : 'Définir comme principal') + '">' + starIcon + '</span>';
                }

                html += '<div class="contact-card">' +
                    '<button class="contact-card-remove" onclick="removeProjectContact(\'' + escapeAttr(pc.id) + '\')" title="Retirer">&times;</button>' +
                    '<div class="contact-card-role">' + escapeHtml(pc.role) + starHtml + '</div>' +
                    '<div class="contact-card-name"><span class="contact-card-name-link" onclick="openContactDetail(\'' + escapeAttr(c.id) + '\')">' + escapeHtml(fullName) + '</span></div>' +
                    (companyStr ? '<div class="contact-card-company">' + companyStr + '</div>' : '') +
                    '<div class="contact-card-details">' +
                        (c.phone ? '&#128222; ' + escapeHtml(c.phone) + '<br>' : '') +
                        (c.email ? '&#9993; ' + escapeHtml(c.email) : '') +
                    '</div>' +
                    '<div class="contact-card-actions">' +
                        (c.phone ? '<button class="contact-card-btn" onclick="window.open(\'tel:' + escapeAttr(c.phone) + '\')">Appeler</button>' : '') +
                        (c.email ? '<button class="contact-card-btn" onclick="window.open(\'mailto:' + escapeAttr(c.email) + '\')">Courriel</button>' : '') +
                        '<button class="contact-card-btn" onclick="copyContactInfo(\'' + escapeAttr(c.id) + '\')">Copier</button>' +
                    '</div>' +
                '</div>';
            }

            // Single placeholder card at the end
            html += '<div class="contact-card-placeholder" onclick="openAddContactModal()">' +
                '<span>+ Ajouter un contact</span>' +
            '</div>';

            grid.innerHTML = html;
        }

        function copyContactInfo(contactId) {
            var pc = projectContacts.find(function(p) { return p.contacts && p.contacts.id === contactId; });
            if (!pc || !pc.contacts) return;
            var c = pc.contacts;
            var text = ((c.first_name || '') + ' ' + (c.last_name || '')).trim();
            if (c.phone) text += '\n' + c.phone;
            if (c.email) text += '\n' + c.email;
            navigator.clipboard.writeText(text.trim());
        }

        function openContactDetail(contactId) {
            var pc = projectContacts.find(function(p) { return p.contacts && p.contacts.id === contactId; });
            if (!pc || !pc.contacts) return;
            var c = pc.contacts;
            var fullName = ((c.first_name || '') + ' ' + (c.last_name || '')).trim();
            var companies = (c.contact_companies || []).map(function(cc) { return cc.companies ? cc.companies.name : ''; }).filter(Boolean);

            document.getElementById('contactDetailTitle').textContent = fullName;
            document.getElementById('contactDetailCrmLink').href = 'clients.html#contact-' + contactId;

            var html = '';
            if (pc.role) html += '<div style="font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; color:var(--sw-navy); margin-bottom:12px;">' + escapeHtml(pc.role) + '</div>';
            if (companies.length > 0) html += '<div style="font-size:14px; color:#666; margin-bottom:12px;">' + escapeHtml(companies.join(', ')) + '</div>';

            if (c.phone) html += '<div style="font-size:14px; margin-bottom:8px;">&#128222; <a href="tel:' + escapeAttr(c.phone) + '" style="color:inherit; text-decoration:none;">' + escapeHtml(c.phone) + '</a></div>';
            if (c.email) html += '<div style="font-size:14px; margin-bottom:8px;">&#9993; <a href="mailto:' + escapeAttr(c.email) + '" style="color:inherit; text-decoration:none;">' + escapeHtml(c.email) + '</a></div>';
            if (c.address) html += '<div style="font-size:14px; margin-bottom:8px; color:#666;">&#128205; ' + escapeHtml(c.address) + '</div>';
            if (c.notes) html += '<div style="font-size:13px; margin-top:12px; padding:10px; background:#f8f8f8; border-radius:8px; color:#555; line-height:1.5;">' + escapeHtml(c.notes) + '</div>';

            if (!c.phone && !c.email && !c.address && !c.notes) {
                html += '<div style="font-size:13px; color:#999; font-style:italic;">Aucun d\u00e9tail suppl\u00e9mentaire.</div>';
            }

            document.getElementById('contactDetailBody').innerHTML = html;
            document.getElementById('contactDetailModal').classList.add('active');
        }

        function closeContactDetail() {
            document.getElementById('contactDetailModal').classList.remove('active');
        }

        async function removeProjectContact(pcId) {
            var ok = await steleConfirm('Retirer ce contact du projet ?', 'Retirer', 'Retirer', true);
            if (!ok) return;
            try {
                await authenticatedFetch(SUPABASE_URL + '/rest/v1/project_contacts?id=eq.' + pcId, { method: 'DELETE' });
                await loadProjectContacts();
                renderContactCards();
                renderContactBadges();
            } catch (e) { console.warn('Error removing project contact:', e); }
        }

        async function togglePrimaryContact(pcId, role) {
            if (!currentProject) return;
            try {
                // Clear is_primary for all contacts of this role in this project
                await authenticatedFetch(
                    SUPABASE_URL + '/rest/v1/project_contacts?project_id=eq.' + currentProject.id + '&role=eq.' + encodeURIComponent(role),
                    { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ is_primary: false }) }
                );
                // Set this one as primary
                await authenticatedFetch(
                    SUPABASE_URL + '/rest/v1/project_contacts?id=eq.' + pcId,
                    { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ is_primary: true }) }
                );
                await loadProjectContacts();
                renderContactCards();
            } catch (e) { console.warn('Error toggling primary contact:', e); }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // ADD CONTACT SUB-MODAL + COMBOBOX
        // ═══════════════════════════════════════════════════════════════════════

        function openAddContactModal(preselectedRole) {
            selectedComboContactId = null;
            document.getElementById('contactComboInput').value = '';
            document.getElementById('addContactStatus').textContent = '';
            document.getElementById('btnConfirmAddContact').disabled = true;
            var roleSelect = document.getElementById('addContactRole');
            var customInput = document.getElementById('addContactRoleCustom');
            customInput.style.display = 'none';
            customInput.value = '';
            roleSelect.value = preselectedRole || 'Entrepreneur';
            if (preselectedRole && !Array.from(roleSelect.options).some(function(o) { return o.value === preselectedRole; })) {
                roleSelect.value = 'Autre';
                customInput.style.display = 'block';
                customInput.value = preselectedRole;
            }
            document.getElementById('addContactOverlay').classList.add('active');
            loadAllContactsForCombo();
            loadAllCompaniesForCombo();
            setTimeout(function() { document.getElementById('contactComboInput').focus(); }, 100);
        }

        function toggleCustomRole() {
            var sel = document.getElementById('addContactRole');
            var custom = document.getElementById('addContactRoleCustom');
            if (sel.value === 'Autre') {
                custom.style.display = 'block';
                custom.focus();
            } else {
                custom.style.display = 'none';
                custom.value = '';
            }
        }

        function closeAddContactModal() {
            document.getElementById('addContactOverlay').classList.remove('active');
            var dd = document.getElementById('contactComboDd');
            if (dd) dd.classList.remove('open');
        }

        function openContactCombo() {
            var dd = document.getElementById('contactComboDd');
            populateContactCombo(dd, '');
            dd.classList.add('open');
        }

        function filterContactCombo(input) {
            var dd = document.getElementById('contactComboDd');
            populateContactCombo(dd, input.value);
            dd.classList.add('open');
        }

        function populateContactCombo(dd, filter) {
            var html = '';
            var f = (filter || '').toLowerCase();

            // Contacts section
            var filtered = allContactsCache.filter(function(c) {
                var name = ((c.first_name || '') + ' ' + (c.last_name || '')).toLowerCase();
                return !f || name.indexOf(f) !== -1 || (c.email || '').toLowerCase().indexOf(f) !== -1;
            });
            if (filtered.length > 0) {
                html += '<div class="combo-section-header">Contacts</div>';
                for (var i = 0; i < Math.min(filtered.length, 10); i++) {
                    var c = filtered[i];
                    var name = ((c.first_name || '') + ' ' + (c.last_name || '')).trim();
                    html += '<div class="contact-combo-item" onclick="selectComboContact(this)" data-id="' + escapeAttr(c.id) + '">' +
                        escapeHtml(name) + (c.email ? ' <small>' + escapeHtml(c.email) + '</small>' : '') + '</div>';
                }
            }

            // Companies section
            var coFiltered = allCompaniesCache.filter(function(co) {
                return !f || (co.name || '').toLowerCase().indexOf(f) !== -1;
            });
            if (coFiltered.length > 0) {
                html += '<div class="combo-section-header">Entreprises</div>';
                for (var j = 0; j < Math.min(coFiltered.length, 10); j++) {
                    var co = coFiltered[j];
                    html += '<div class="contact-combo-item" onclick="selectComboCompany(this)" data-id="' + escapeAttr(co.id) + '" data-name="' + escapeAttr(co.name) + '">' +
                        escapeHtml(co.name) + '</div>';
                }
            }

            dd.innerHTML = html || '<div class="contact-combo-item" style="color:#999;">Aucun contact trouv\u00e9</div>';
        }

        function selectComboContact(el) {
            var id = el.getAttribute('data-id');
            selectedComboContactId = id;
            var c = allContactsCache.find(function(x) { return x.id === id; });
            var name = c ? ((c.first_name || '') + ' ' + (c.last_name || '')).trim() : '';
            document.getElementById('contactComboInput').value = name;
            document.getElementById('addContactStatus').textContent = '\u2713 ' + name;
            document.getElementById('addContactStatus').style.color = 'var(--sw-navy)';
            document.getElementById('btnConfirmAddContact').disabled = false;
            document.getElementById('contactComboDd').classList.remove('open');
        }

        async function selectComboCompany(el) {
            var coId = el.getAttribute('data-id');
            var coName = el.getAttribute('data-name');
            var co = allCompaniesCache.find(function(x) { return x.id === coId; });
            var linkedContacts = (co && co.contact_companies) ? co.contact_companies.map(function(cc) { return cc.contacts; }).filter(Boolean) : [];

            if (linkedContacts.length === 0) {
                // No contacts linked, offer to create one
                document.getElementById('contactComboDd').classList.remove('open');
                var ok = await steleConfirm('L\'entreprise "' + coName + '" n\'a aucun contact li\u00e9. Cr\u00e9er un contact ?', 'Cr\u00e9er un contact', 'Cr\u00e9er');
                if (ok) {
                    var firstName = await stelePrompt('Pr\u00e9nom :', 'Nouveau contact', 'Cr\u00e9er');
                    if (!firstName || !firstName.trim()) return;
                    var lastName = await stelePrompt('Nom :', 'Nouveau contact', 'Cr\u00e9er');
                    if (!lastName || !lastName.trim()) return;
                    try {
                        var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/contacts', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                            body: JSON.stringify({ first_name: firstName.trim(), last_name: lastName.trim(), created_by: localStorage.getItem('sb_user_id') })
                        });
                        if (r.ok) {
                            var res = await r.json();
                            if (res.length > 0) {
                                // Link contact to company
                                await authenticatedFetch(SUPABASE_URL + '/rest/v1/contact_companies', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                                    body: JSON.stringify({ contact_id: res[0].id, company_id: coId })
                                });
                                allContactsCache.push(res[0]);
                                selectedComboContactId = res[0].id;
                                var fullName = firstName.trim() + ' ' + lastName.trim();
                                document.getElementById('contactComboInput').value = fullName;
                                document.getElementById('addContactStatus').textContent = '\u2713 ' + fullName + ' (' + coName + ')';
                                document.getElementById('addContactStatus').style.color = 'var(--sw-navy)';
                                document.getElementById('btnConfirmAddContact').disabled = false;
                            }
                        }
                    } catch (e) { console.warn('Error creating contact:', e); }
                }
            } else if (linkedContacts.length === 1) {
                // Auto-select the single linked contact
                selectedComboContactId = linkedContacts[0].id;
                var n = ((linkedContacts[0].first_name || '') + ' ' + (linkedContacts[0].last_name || '')).trim();
                document.getElementById('contactComboInput').value = n;
                document.getElementById('addContactStatus').textContent = '\u2713 ' + n + ' (' + coName + ')';
                document.getElementById('addContactStatus').style.color = 'var(--sw-navy)';
                document.getElementById('btnConfirmAddContact').disabled = false;
                document.getElementById('contactComboDd').classList.remove('open');
            } else {
                // Show linked contacts as sub-items
                var dd = document.getElementById('contactComboDd');
                var html = '<div class="combo-section-header">Contacts de ' + escapeHtml(coName) + '</div>';
                linkedContacts.forEach(function(lc) {
                    var lcName = ((lc.first_name || '') + ' ' + (lc.last_name || '')).trim();
                    html += '<div class="contact-combo-item" onclick="selectComboContact(this)" data-id="' + escapeAttr(lc.id) + '">' + escapeHtml(lcName) + '</div>';
                });
                dd.innerHTML = html;
            }
        }

        async function createNewContactFromCombo() {
            document.getElementById('contactComboDd').classList.remove('open');
            var firstName = await stelePrompt('Pr\u00e9nom du nouveau contact :', 'Nouveau contact', 'Cr\u00e9er');
            if (!firstName || !firstName.trim()) return;
            var lastName = await stelePrompt('Nom de famille :', 'Nouveau contact', 'Cr\u00e9er');
            if (!lastName || !lastName.trim()) return;
            try {
                var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/contacts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                    body: JSON.stringify({ first_name: firstName.trim(), last_name: lastName.trim(), created_by: localStorage.getItem('sb_user_id') })
                });
                if (r.ok) {
                    var res = await r.json();
                    if (res.length > 0) {
                        allContactsCache.push(res[0]);
                        selectedComboContactId = res[0].id;
                        var fullName = firstName.trim() + ' ' + lastName.trim();
                        document.getElementById('contactComboInput').value = fullName;
                        document.getElementById('addContactStatus').textContent = '\u2713 ' + fullName + ' cr\u00e9\u00e9';
                        document.getElementById('addContactStatus').style.color = 'var(--sw-navy)';
                        document.getElementById('btnConfirmAddContact').disabled = false;
                    }
                }
            } catch (e) { console.warn('Error creating contact:', e); }
        }

        async function confirmAddContact() {
            if (!selectedComboContactId || !currentProject) return;
            var roleVal = document.getElementById('addContactRole').value;
            var role = roleVal === 'Autre' ? document.getElementById('addContactRoleCustom').value.trim() : roleVal;
            if (!role) { document.getElementById('addContactStatus').textContent = 'Veuillez sp\u00e9cifier un r\u00f4le.'; document.getElementById('addContactStatus').style.color = '#c62828'; return; }
            try {
                var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/project_contacts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                    body: JSON.stringify({
                        project_id: currentProject.id,
                        contact_id: selectedComboContactId,
                        role: role.trim()
                    })
                });
                if (r.ok) {
                    closeAddContactModal();
                    await loadProjectContacts();
                    renderContactCards();
                    renderContactBadges();

                    // Propose to use contact's address as project address
                    await promptContactAddressForProject(selectedComboContactId);
                } else {
                    var errText = await r.text();
                    var statusEl = document.getElementById('addContactStatus');
                    if (errText.indexOf('unique') !== -1 || errText.indexOf('duplicate') !== -1) {
                        statusEl.textContent = 'Ce contact a d\u00e9j\u00e0 ce r\u00f4le dans ce projet.';
                    } else {
                        statusEl.textContent = 'Erreur lors de l\'ajout.';
                    }
                    statusEl.style.color = '#c62828';
                }
            } catch (e) { console.warn('Error adding project contact:', e); }
        }

        async function promptContactAddressForProject(contactId) {
            if (!currentProject || !contactId) return;
            // Already has a project address? Skip.
            var hasAddr = currentProject.project_address || currentProject._address || currentProject.client_address;
            if (hasAddr) return;
            // Fetch the contact's address
            try {
                var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/contacts?id=eq.' + contactId + '&select=first_name,last_name,address', {});
                if (!r.ok) return;
                var rows = await r.json();
                if (rows.length === 0 || !rows[0].address) return;
                var c = rows[0];
                var name = ((c.first_name || '') + ' ' + (c.last_name || '')).trim();
                var useIt = await steleConfirm(
                    'L\'adresse de ' + name + ' est :\n' + c.address + '\n\nUtiliser comme adresse du projet ?',
                    'Adresse du projet', 'Utiliser', false
                );
                if (useIt) {
                    await saveProjectAddress(c.address);
                } else {
                    var addr = await stelePrompt('Quelle est l\'adresse du projet ?', 'Adresse du projet', 'Enregistrer');
                    if (addr && addr.trim()) {
                        await saveProjectAddress(addr.trim());
                    }
                }
            } catch (e) { console.warn('Error prompting contact address:', e); }
        }

        async function saveProjectAddress(address) {
            // Try new column first, fallback to legacy
            var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/projects?id=eq.' + currentProject.id, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                body: JSON.stringify({ project_address: address })
            });
            if (!r.ok) {
                r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/projects?id=eq.' + currentProject.id, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                    body: JSON.stringify({ client_address: address })
                });
            }
            if (r.ok) {
                var updated = await r.json();
                if (updated.length > 0) currentProject = updated[0];
                if (!currentProject.project_address) currentProject._address = address;
                renderProjectInfoBloc();
            }
        }

        // Close combos on click outside
        document.addEventListener('click', function(e) {
            var clientWrap = document.getElementById('clientComboWrap');
            if (clientWrap && !clientWrap.contains(e.target)) closeClientCombo();
            var contactWrap = document.getElementById('contactComboWrap');
            if (contactWrap && !contactWrap.contains(e.target)) {
                var dd = document.getElementById('contactComboDd');
                if (dd) dd.classList.remove('open');
            }
        });

        // ═══════════════════════════════════════════════════════════════════════
        // WORKFLOW : SOUMETTRE / APPROUVER / RETOURNER
        // ═══════════════════════════════════════════════════════════════════════

        function updateWorkflowButtons() {
            var btnSubmit = document.getElementById('btnWfSubmit');
            var btnApprove = document.getElementById('btnWfApprove');
            var btnReturn = document.getElementById('btnWfReturn');
            var btnSendClient = document.getElementById('btnWfSendClient');
            var btnBypass = document.getElementById('btnWfBypass');
            var btnAcceptOffline = document.getElementById('btnWfAcceptOffline');

            // Hide all main action buttons
            btnSubmit.style.display = 'none';
            btnApprove.style.display = 'none';
            btnReturn.style.display = 'none';
            if (btnSendClient) { btnSendClient.style.display = 'none'; btnSendClient.textContent = 'Envoyer au client'; btnSendClient.onclick = function() { sendToClient(); }; }
            if (btnBypass) { btnBypass.style.display = 'none'; btnBypass.textContent = 'Envoyer sans approbation'; btnBypass.className = 'btn-main-action btn-main-red'; }
            if (btnAcceptOffline) btnAcceptOffline.style.display = 'none';

            if (!currentSubmission) return;

            var s = currentSubmission.status;
            if (s === 'draft' || s === 'returned') {
                btnSubmit.style.display = 'inline-block';
                btnSubmit.textContent = s === 'returned' ? 'Resoumettre' : 'Soumettre';
                if (canBypassApproval && btnBypass) {
                    btnBypass.style.display = 'inline-block';
                    if (s === 'returned') {
                        btnBypass.textContent = 'Envoyer au client';
                        btnBypass.className = 'btn-main-action btn-main-green';
                    } else {
                        btnBypass.textContent = 'Envoyer sans approbation';
                        btnBypass.className = 'btn-main-action btn-main-red';
                    }
                }
            }
            if (s === 'pending_internal' && canApproveQuotes) {
                btnApprove.style.display = 'inline-block';
                btnReturn.style.display = 'inline-block';
            }
            if (s === 'approved_internal' && btnSendClient) {
                btnSendClient.style.display = 'inline-block';
            }
            if (s === 'sent_client') {
                if (btnSendClient) {
                    btnSendClient.style.display = 'inline-block';
                    btnSendClient.textContent = 'Copier le lien';
                    btnSendClient.onclick = function() { copyQuoteLink(); };
                }
                // Vérifier si déjà acceptée (unlock → re-cycle)
                if (btnAcceptOffline) {
                    wasAlreadyAccepted(currentSubmission.id).then(function(already) {
                        if (already) {
                            btnAcceptOffline.style.display = 'inline-block';
                            btnAcceptOffline.textContent = 'Déjà vendue';
                            btnAcceptOffline.disabled = true;
                            btnAcceptOffline.title = 'Cette soumission a déjà été acceptée une fois. Contactez un administrateur.';
                            btnAcceptOffline.onclick = function() {
                                steleAlert('Cette soumission a déjà été acceptée une fois. Contactez un administrateur.');
                            };
                        } else {
                            btnAcceptOffline.style.display = 'inline-block';
                            btnAcceptOffline.textContent = 'Confirmer la vente';
                            btnAcceptOffline.disabled = false;
                            btnAcceptOffline.title = '';
                            btnAcceptOffline.onclick = function() { offlineAcceptance(); };
                        }
                    });
                }
            }

            // Kebab: Déverrouiller — visible pour statuts verrouillés si permission
            var kebabUnlock = document.getElementById('kebabUnlock');
            if (kebabUnlock) {
                kebabUnlock.style.display = 'none';
                if (canUnlockSubmission) {
                    var lockedStatuses = ['pending_internal','approved_internal','sent_client','accepted','lost'];
                    if (lockedStatuses.includes(s)) kebabUnlock.style.display = '';
                }
            }

            // Kebab archive button
            var kebabArchive = document.getElementById('kebabArchive');
            if (kebabArchive) {
                kebabArchive.style.display = 'none';
                if (currentSubmission && (s === 'accepted' || s === 'lost')) {
                    kebabArchive.style.display = '';
                    if (currentSubmission.is_archived) {
                        kebabArchive.innerHTML = '<span class="kebab-icon">&#128194;</span> D\u00e9sarchiver';
                    } else {
                        kebabArchive.innerHTML = '<span class="kebab-icon">&#128451;</span> Archiver';
                    }
                }
            }

            // Update header total
            updateHeaderTotal();
            updateStatusTimeline();
        }

        // submitForApproval() redirigé vers le modal
        function submitForApproval() { openSubmitModal(); }

        // ═══════════════════════════════════════════════════════════════════════
        // ENVOI AU CLIENT — LIEN PUBLIC
        // ═══════════════════════════════════════════════════════════════════════

        async function sendToClient() {
            if (!currentSubmission) return;
            if (currentSubmission.status !== 'approved_internal') {
                steleAlert('La soumission doit \u00eatre approuv\u00e9e avant l\'envoi au client.');
                return;
            }
            if (!(await steleConfirm('G\u00e9n\u00e9rer un lien de soumission pour le client ?\nLe statut passera \u00e0 \u00abEnvoy\u00e9e\u00bb.', 'Envoyer au client', 'G\u00e9n\u00e9rer le lien'))) return;

            try {
                // Snapshot avant envoi
                await createVersion(currentSubmission.id);

                var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/public_quote_tokens', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                    body: JSON.stringify({ submission_id: currentSubmission.id })
                });
                if (!r.ok) throw new Error('Erreur cr\u00e9ation token: ' + r.status);
                var tokenData = (await r.json())[0];

                await updateSubmission(currentSubmission.id, {
                    status: 'sent_client',
                    sent_at: new Date().toISOString()
                });
                await createSubmissionReview(currentSubmission.id, 'sent', 'Lien client g\u00e9n\u00e9r\u00e9');

                currentSubmission.status = 'sent_client';
                // Regénérer le snapshot (au cas où données ont changé depuis approbation)
                await uploadSnapshot(currentSubmission.id);
                updateStatusBadge('sent_client');
                updateWorkflowButtons();
                setEditable(false);
                loadSubmissionReviews(currentSubmission.id);

                var link = window.location.origin + '/quote.html?token=' + tokenData.token;
                showQuoteLinkModal(link);
            } catch (e) {
                console.error('Erreur envoi client:', e);
                steleAlert('Erreur: ' + e.message);
            }
        }

        function showQuoteLinkModal(link) {
            document.getElementById('steleDialogTitle').textContent = 'Lien de soumission';
            document.getElementById('steleDialogMessage').textContent = 'Copiez ce lien et envoyez-le au client par courriel :';
            document.getElementById('steleDialogInputWrap').style.display = '';
            var input = document.getElementById('steleDialogInput');
            input.value = link;
            input.readOnly = true;
            input.style.fontSize = '12px';
            document.getElementById('steleDialogCancel').style.display = 'none';
            document.getElementById('steleDialogOk').textContent = 'Copier & Fermer';
            document.getElementById('steleDialogOk').className = 'btn-generate';
            document.getElementById('steleDialogOverlay').classList.add('active');

            _steleDialogResolve = function() {
                navigator.clipboard.writeText(link).catch(function() {});
                document.getElementById('steleDialogOverlay').classList.remove('active');
                input.readOnly = false;
                input.style.fontSize = '';
            };
            setTimeout(function() { input.select(); }, 100);
        }

        async function copyQuoteLink() {
            if (!currentSubmission) return;
            var r = await authenticatedFetch(
                SUPABASE_URL + '/rest/v1/public_quote_tokens?submission_id=eq.' + currentSubmission.id + '&order=created_at.desc&limit=1', {}
            );
            if (!r.ok) { steleAlert('Erreur chargement du lien.'); return; }
            var tokens = await r.json();
            if (tokens.length === 0) { steleAlert('Aucun lien trouv\u00e9 pour cette soumission.'); return; }
            var link = window.location.origin + '/quote.html?token=' + tokens[0].token;
            showQuoteLinkModal(link);
        }

        async function approveSubmission() {
            if (!currentSubmission || !canApproveQuotes) return;
            var comment = await stelePrompt('Commentaire d\'approbation (optionnel) :', 'Approuver la soumission');
            if (comment === null) return;
            try {
                // Snapshot avant approbation
                await createVersion(currentSubmission.id);
                await createSubmissionReview(currentSubmission.id, 'approved', comment);
                var total = calculerGrandTotal();
                await updateSubmission(currentSubmission.id, {
                    status: 'approved_internal',
                    approved_by: localStorage.getItem('sb_user_id'),
                    approved_at: new Date().toISOString(),
                    approved_total: total
                });
                currentSubmission.status = 'approved_internal';
                // Figer le HTML de la soumission
                await uploadSnapshot(currentSubmission.id);
                updateStatusBadge('approved_internal');
                updateWorkflowButtons();
                setEditable(false);
                showSaveIndicator();
                loadSubmissionReviews(currentSubmission.id);
            } catch (e) {
                console.error('Erreur approbation:', e);
                steleAlert('Erreur approbation: ' + e.message);
            }
        }

        async function returnSubmission() {
            if (!currentSubmission || !canApproveQuotes) return;
            var comment = await stelePrompt('Raison du retour :', 'Retourner la soumission', 'Ex: Revoir les prix du meuble X...');
            if (comment === null) return;
            if (!comment.trim()) { steleAlert('Veuillez indiquer une raison.'); return; }
            try {
                await createSubmissionReview(currentSubmission.id, 'returned', comment);
                await updateSubmission(currentSubmission.id, { status: 'returned' });
                currentSubmission.status = 'returned';
                updateStatusBadge('returned');
                updateWorkflowButtons();
                setEditable(true);
                showSaveIndicator();
                loadSubmissionReviews(currentSubmission.id);
            } catch (e) {
                console.error('Erreur retour:', e);
                steleAlert('Erreur retour: ' + e.message);
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // BYPASS APPROBATION
        // ═══════════════════════════════════════════════════════════════════════

        function bypassApproval() {
            if (!currentSubmission) return;
            var s = currentSubmission.status;
            if (s !== 'draft' && s !== 'returned') {
                steleAlert('Seules les soumissions en brouillon ou retournées peuvent utiliser le bypass.');
                return;
            }
            if (!canBypassApproval) {
                steleAlert('Vous n\'avez pas la permission de contourner l\'approbation.');
                return;
            }
            var rows = document.querySelectorAll('.calc-row');
            if (rows.length === 0) {
                steleAlert('Veuillez ajouter au moins un article au calculateur.');
                return;
            }
            document.getElementById('bypassConfirmCheck').checked = false;
            document.getElementById('bypassReason').value = '';
            document.getElementById('bypassStatus').style.display = 'none';
            document.getElementById('btnBypassConfirm').disabled = false;
            document.getElementById('btnBypassConfirm').textContent = 'Envoyer sans approbation';
            document.getElementById('bypassModal').classList.add('active');
        }

        function closeBypassModal() {
            document.getElementById('bypassModal').classList.remove('active');
        }

        function showBypassStatus(msg, isError) {
            var el = document.getElementById('bypassStatus');
            el.style.display = 'block';
            el.textContent = msg;
            el.style.background = isError ? '#ffebee' : '#e8f5e9';
            el.style.color = isError ? '#c62828' : '#2e7d32';
        }

        async function executeBypass() {
            if (!document.getElementById('bypassConfirmCheck').checked) {
                showBypassStatus('Vous devez cocher la case de confirmation.', true);
                return;
            }
            var reason = document.getElementById('bypassReason').value.trim();
            if (!reason) {
                showBypassStatus('La raison est obligatoire.', true);
                return;
            }
            if (reason.length < 10) {
                showBypassStatus('La raison doit contenir au moins 10 caractères.', true);
                return;
            }

            var btn = document.getElementById('btnBypassConfirm');
            btn.disabled = true;
            btn.textContent = 'Envoi en cours...';
            showBypassStatus('Traitement en cours...', false);

            try {
                var statusBefore = currentSubmission.status;

                // 1. Snapshot
                await createVersion(currentSubmission.id);

                // 2. Log immutable via RPC (capture IP serveur)
                var rpcResp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/rpc/log_bypass_approval', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        p_submission_id: currentSubmission.id,
                        p_reason: reason,
                        p_status_before: statusBefore,
                        p_status_after: 'sent_client'
                    })
                });
                if (!rpcResp.ok) throw new Error('Erreur journalisation bypass: ' + rpcResp.status);

                // 3. Générer token client (même logique que sendToClient)
                var tokenResp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/public_quote_tokens', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                    body: JSON.stringify({ submission_id: currentSubmission.id })
                });
                if (!tokenResp.ok) throw new Error('Erreur création token: ' + tokenResp.status);
                var tokenData = (await tokenResp.json())[0];

                // 4. Mettre à jour la soumission
                var grandTotal = calculerGrandTotal();
                await updateSubmission(currentSubmission.id, {
                    status: 'sent_client',
                    sent_at: new Date().toISOString(),
                    bypass_approval: true,
                    approved_total: grandTotal
                });

                // 5. Entrée timeline
                await createSubmissionReview(currentSubmission.id, 'bypass', 'BYPASS: ' + reason);

                // 6. Figer le HTML de la soumission
                currentSubmission.status = 'sent_client';
                currentSubmission.bypass_approval = true;
                await uploadSnapshot(currentSubmission.id);

                // 7. Mettre à jour l'UI
                updateStatusBadge('sent_client');
                updateWorkflowButtons();
                setEditable(false);
                loadSubmissionReviews(currentSubmission.id);

                showBypassStatus('Soumission envoyée au client (bypass approbation).', false);

                // 7. Afficher le lien client
                var link = window.location.origin + '/quote.html?token=' + tokenData.token;
                setTimeout(function() {
                    closeBypassModal();
                    showQuoteLinkModal(link);
                }, 1500);

            } catch (e) {
                console.error('Erreur bypass:', e);
                showBypassStatus('Erreur: ' + e.message, true);
                btn.disabled = false;
                btn.textContent = 'Envoyer sans approbation';
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // ACCEPTATION HORS-LIGNE (Chemin B)
        // ═══════════════════════════════════════════════════════════════════════

        async function offlineAcceptance() {
            if (!currentSubmission) return;
            if (currentSubmission.status !== 'sent_client') {
                steleAlert('Seules les soumissions envoyées au client peuvent être confirmées.');
                return;
            }
            // Guard: double acceptation
            if (await wasAlreadyAccepted(currentSubmission.id)) {
                steleAlert('Cette soumission a déjà été acceptée une fois. Contactez un administrateur.');
                return;
            }
            // Reset modal
            document.getElementById('offlineUserName').value = '';
            document.getElementById('offlineClientName').value = currentProject ? (currentProject.client_name || '') : '';
            document.getElementById('offlineMethod').value = 'courriel';
            document.getElementById('offlineDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('offlineNotes').value = '';
            document.getElementById('offlineConfirmCheck').checked = false;
            document.getElementById('btnOfflineConfirm').disabled = false;
            document.getElementById('btnOfflineConfirm').textContent = 'Confirmer la vente';
            document.getElementById('offlineAcceptStatus').style.display = 'none';
            document.getElementById('offlineAcceptModal').classList.add('active');
        }

        function closeOfflineAcceptModal() {
            document.getElementById('offlineAcceptModal').classList.remove('active');
        }

        function showOfflineAcceptStatus(msg, isError) {
            var el = document.getElementById('offlineAcceptStatus');
            el.style.display = 'block';
            el.textContent = msg;
            el.style.background = isError ? '#ffebee' : '#e8f5e9';
            el.style.color = isError ? '#c62828' : '#2e7d32';
        }

        async function executeOfflineAcceptance() {
            var userName = document.getElementById('offlineUserName').value.trim();
            var clientName = document.getElementById('offlineClientName').value.trim();
            var method = document.getElementById('offlineMethod').value;
            var acceptDate = document.getElementById('offlineDate').value;
            var notes = document.getElementById('offlineNotes').value.trim();
            var checked = document.getElementById('offlineConfirmCheck').checked;

            if (!userName) {
                showOfflineAcceptStatus('Le nom du chargé de projet est obligatoire.', true);
                return;
            }
            if (!clientName) {
                showOfflineAcceptStatus('Le nom du client est obligatoire.', true);
                return;
            }
            if (!acceptDate) {
                showOfflineAcceptStatus('La date d\'acceptation est obligatoire.', true);
                return;
            }
            if (!checked) {
                showOfflineAcceptStatus('Vous devez cocher la case de confirmation.', true);
                return;
            }

            var btn = document.getElementById('btnOfflineConfirm');
            btn.disabled = true;
            btn.textContent = 'Traitement en cours...';
            showOfflineAcceptStatus('Vérification...', false);

            // Double acceptance guard
            if (await wasAlreadyAccepted(currentSubmission.id)) {
                showOfflineAcceptStatus('Cette soumission a déjà été acceptée une fois. Impossible de ré-accepter.', true);
                btn.disabled = false;
                btn.textContent = 'Confirmer la vente';
                return;
            }

            showOfflineAcceptStatus('Enregistrement...', false);

            try {
                // 0. Snapshot avant acceptation
                await createVersion(currentSubmission.id);

                // 1. Log immutable via RPC (capture IP serveur)
                var rpcResp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/rpc/log_offline_acceptance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        p_submission_id: currentSubmission.id,
                        p_user_name: userName,
                        p_acceptance_method: method,
                        p_acceptance_date: acceptDate,
                        p_client_name: clientName,
                        p_notes: notes || null
                    })
                });
                if (!rpcResp.ok) throw new Error('Erreur journalisation acceptation: ' + rpcResp.status);

                // 2. Mettre à jour la soumission (statut + date seulement)
                await updateSubmission(currentSubmission.id, {
                    status: 'accepted',
                    accepted_at: new Date(acceptDate).toISOString()
                });

                // 2b. Best-effort: accepted_by_name (colonne optionnelle)
                try {
                    await authenticatedFetch(SUPABASE_URL + '/rest/v1/submissions?id=eq.' + currentSubmission.id, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                        body: JSON.stringify({ accepted_by_name: clientName })
                    });
                } catch (e) { /* colonne peut ne pas exister */ }

                // 3. Entrée timeline
                var methodLabels = { courriel: 'Courriel', telephone: 'Téléphone', papier: 'Papier', autre: 'Autre' };
                var comment = 'Acceptation hors-ligne par ' + userName + ' — Méthode: ' + (methodLabels[method] || method) + ', Client: ' + clientName;
                if (notes) comment += ', Notes: ' + notes;
                await createSubmissionReview(currentSubmission.id, 'offline_accepted', comment);

                // 4. Mettre à jour l'UI
                currentSubmission.status = 'accepted';
                currentSubmission.accepted_at = acceptDate;
                currentSubmission.accepted_by_name = clientName;
                updateStatusBadge('accepted');
                updateWorkflowButtons();
                setEditable(false);
                loadSubmissionReviews(currentSubmission.id);

                showOfflineAcceptStatus('Vente confirmée avec succès!', false);

                setTimeout(function() {
                    closeOfflineAcceptModal();
                }, 1500);

            } catch (e) {
                console.error('Erreur acceptation hors-ligne:', e);
                showOfflineAcceptStatus('Erreur: ' + e.message, true);
                btn.disabled = false;
                btn.textContent = 'Confirmer la vente';
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // MARQUER COMME PERDU (LOST)
        // ═══════════════════════════════════════════════════════════════════════

        function openLostModal() {
            if (!currentSubmission) return;
            if (currentSubmission.status !== 'sent_client') {
                steleAlert('Seules les soumissions envoy\u00e9es au client peuvent \u00eatre marqu\u00e9es comme perdues.');
                return;
            }
            document.getElementById('lostReason').value = '';
            document.getElementById('lostCompetitorSearch').value = '';
            document.getElementById('lostCompetitorId').value = '';
            document.getElementById('lostCompetitorPrice').value = '';
            document.getElementById('lostStatus').style.display = 'none';
            document.getElementById('btnLostConfirm').disabled = false;
            document.getElementById('btnLostConfirm').textContent = 'Marquer comme perdu';
            document.getElementById('lostCompetitorDd').classList.remove('open');
            document.getElementById('lostModal').classList.add('active');
        }

        function closeLostModal() {
            document.getElementById('lostModal').classList.remove('active');
        }

        document.addEventListener('click', function(e) {
            if (e.target === document.getElementById('lostModal')) closeLostModal();
        });

        function showLostStatus(msg, isError) {
            var el = document.getElementById('lostStatus');
            el.style.display = 'block';
            el.textContent = msg;
            el.style.background = isError ? '#ffebee' : '#e8f5e9';
            el.style.color = isError ? '#c62828' : '#2e7d32';
        }

        function filterLostCompetitors(input) {
            var dd = document.getElementById('lostCompetitorDd');
            var f = (input.value || '').toLowerCase();
            // Clear hidden id when user types
            document.getElementById('lostCompetitorId').value = '';
            var filtered = allCompaniesCache.filter(function(co) {
                return !f || (co.name || '').toLowerCase().indexOf(f) !== -1;
            });
            var html = '';
            for (var i = 0; i < Math.min(filtered.length, 10); i++) {
                var co = filtered[i];
                html += '<div class="contact-combo-item" onclick="selectLostCompetitor(this)" data-id="' + escapeAttr(co.id) + '" data-name="' + escapeAttr(co.name) + '">' +
                    escapeHtml(co.name) + (co.is_competitor ? ' <small style="color:#c62828;">\u2022 concurrent</small>' : '') + '</div>';
            }
            dd.innerHTML = html || '<div class="contact-combo-item" style="color:#999;">Aucune entreprise trouv\u00e9e</div>';
            dd.classList.add('open');
        }

        function selectLostCompetitor(el) {
            document.getElementById('lostCompetitorSearch').value = el.getAttribute('data-name');
            document.getElementById('lostCompetitorId').value = el.getAttribute('data-id');
            document.getElementById('lostCompetitorDd').classList.remove('open');
        }

        // Close competitor dropdown on outside click
        document.addEventListener('click', function(e) {
            var dd = document.getElementById('lostCompetitorDd');
            if (dd && !e.target.closest('#lostCompetitorSearch') && !e.target.closest('#lostCompetitorDd')) {
                dd.classList.remove('open');
            }
        });

        async function executeLostSubmission() {
            var reason = document.getElementById('lostReason').value.trim();
            var competitorId = document.getElementById('lostCompetitorId').value || null;
            var competitorPrice = document.getElementById('lostCompetitorPrice').value.trim();
            competitorPrice = competitorPrice ? parseFloat(competitorPrice) : null;

            var btn = document.getElementById('btnLostConfirm');
            btn.disabled = true;
            btn.textContent = 'Traitement en cours...';
            showLostStatus('Enregistrement...', false);

            try {
                // 1. Snapshot before marking as lost
                await createVersion(currentSubmission.id);

                // 2. Update submission with lost fields
                await updateSubmission(currentSubmission.id, {
                    status: 'lost',
                    lost_at: new Date().toISOString(),
                    lost_reason: reason || null,
                    lost_competitor_company_id: competitorId,
                    lost_competitor_price: competitorPrice
                });

                // 3. Mark competitor company if selected (non-blocking)
                if (competitorId) {
                    try {
                        await authenticatedFetch(SUPABASE_URL + '/rest/v1/companies?id=eq.' + competitorId, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                            body: JSON.stringify({ is_competitor: true })
                        });
                    } catch (e) { /* non-blocking */ }
                }

                // 4. Review timeline entry
                var comment = 'Soumission marqu\u00e9e comme perdue.';
                if (reason) comment += ' Raison: ' + reason;
                if (competitorId) {
                    var coName = document.getElementById('lostCompetitorSearch').value;
                    if (coName) comment += ' Concurrent: ' + coName;
                }
                if (competitorPrice) comment += ' Prix concurrent: ' + formatPrice(competitorPrice);
                await createSubmissionReview(currentSubmission.id, 'lost', comment);

                // 5. Update UI
                currentSubmission.status = 'lost';
                currentSubmission.lost_at = new Date().toISOString();
                updateStatusBadge('lost');
                updateWorkflowButtons();
                setEditable(false);
                loadSubmissionReviews(currentSubmission.id);

                showLostStatus('Soumission marqu\u00e9e comme perdue.', false);
                setTimeout(function() { closeLostModal(); }, 1500);

            } catch (e) {
                console.error('Erreur marquage perdu:', e);
                showLostStatus('Erreur: ' + e.message, true);
                btn.disabled = false;
                btn.textContent = 'Marquer comme perdu';
            }
        }

        async function reopenLostSubmission() {
            if (!currentSubmission || currentSubmission.status !== 'lost') return;
            if (!(await steleConfirm(
                'Rouvrir cette soumission perdue ?\nElle repassera au statut \u00abEnvoy\u00e9e au client\u00bb.',
                'Rouvrir la soumission', 'Rouvrir'
            ))) return;

            try {
                await createVersion(currentSubmission.id);
                await updateSubmission(currentSubmission.id, {
                    status: 'sent_client',
                    lost_at: null,
                    lost_reason: null,
                    lost_competitor_company_id: null,
                    lost_competitor_price: null
                });
                await createSubmissionReview(currentSubmission.id, 'reopened', 'Soumission rouverte depuis le statut perdu');

                currentSubmission.status = 'sent_client';
                updateStatusBadge('sent_client');
                updateWorkflowButtons();
                setEditable(false);
                loadSubmissionReviews(currentSubmission.id);
            } catch (e) {
                console.error('Erreur r\u00e9ouverture:', e);
                steleAlert('Erreur: ' + e.message);
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // ARCHIVAGE DES SOUMISSIONS
        // ═══════════════════════════════════════════════════════════════════════

        function toggleArchiveFilter() {
            pipelineFilters.showArchived = !pipelineFilters.showArchived;
            var btn = document.getElementById('filterArchiveBtn');
            if (btn) btn.classList.toggle('active', pipelineFilters.showArchived);
            applyPipelineFilters();
        }

        async function toggleArchiveSubmission() {
            if (!currentSubmission) return;
            var newVal = !currentSubmission.is_archived;
            try {
                await authenticatedFetch(SUPABASE_URL + '/rest/v1/submissions?id=eq.' + currentSubmission.id, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                    body: JSON.stringify({ is_archived: newVal })
                });
                currentSubmission.is_archived = newVal;
                updateWorkflowButtons();
                renderProjectList();
                showSaveIndicator();
            } catch (e) {
                console.error('Erreur archivage:', e);
                steleAlert('Erreur: ' + e.message);
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // SUPPRIMER UN PROJET
        // ═══════════════════════════════════════════════════════════════════════

        async function handleDeleteProject(projectId, event) {
            event.stopPropagation();
            if (!(await steleConfirm('Supprimer ce projet et toutes ses donn\u00e9es ?', 'Supprimer le projet', 'Supprimer', true))) return;
            await deleteProject(projectId);
            renderProjectList();
        }

        // ═══════════════════════════════════════════════════════════════════════
        // RENTABILITÉ
        // ═══════════════════════════════════════════════════════════════════════

        function openRentab(scope, groupId) {
            // scope = 'project' ou 'group'
            var title = scope === 'project' ? 'Rentabilit\u00e9 — Projet complet' : 'Rentabilit\u00e9 — ' + (document.getElementById(groupId + '-name').value || 'Meuble');
            document.getElementById('rentabTitle').textContent = title;

            // Collecter les lignes en scope
            var rows;
            if (scope === 'project') {
                rows = document.querySelectorAll('.calc-row');
            } else {
                rows = document.querySelectorAll('#' + groupId + '-rows .calc-row');
            }

            // Accumulateurs
            var deptMinutes = {};
            var matCoutant = {};
            var totalMatMarkup = 0;
            var totalMatWaste = 0;
            var totalMatCoutant = 0;
            var totalHeuresCharge = 0;
            var totalSalaires = 0;
            var totalFraisFixes = 0;
            var totalProfitMO = 0;
            var totalPrixVente = 0;

            // Init départements
            tauxHoraires.forEach(function(t) { deptMinutes[t.department] = 0; });

            // Init matériaux
            expenseCategories.forEach(function(c) { matCoutant[c.name] = 0; });

            // Per-tag accumulator
            var tagData = {}; // { "C": { label, prixVente, heures, matCout, profit, count }, ... }

            rows.forEach(function(row) {
                var select = row.querySelector('.item-select');
                var qtyInput = row.querySelector('.qty-input');
                if (!select || !qtyInput) return;
                var selectedId = select.value;
                var qty = parseFloat(qtyInput.value) || 0;

                // Get tag for this row
                var tagInput = row.querySelector('.cell-tag input');
                var tag = tagInput ? tagInput.value.trim().toUpperCase() : '';
                var tagPrefix = tag ? tag.replace(/[0-9]/g, '') : '';

                if (!selectedId || selectedId === '__AJOUT__' || selectedId === '__PROPOSER__') {
                    if (selectedId === '__AJOUT__') {
                        var priceInput = row.querySelector('.ajout-price');
                        var markupInput = row.querySelector('.ajout-markup');
                        var p = parseFloat(priceInput ? priceInput.value : 0) || 0;
                        var m = parseFloat(markupInput ? markupInput.value : 0) || 0;
                        var ajoutTotal = p * qty * (1 + m / 100);
                        totalPrixVente += ajoutTotal;
                        if (tagPrefix) {
                            if (!tagData[tagPrefix]) tagData[tagPrefix] = { prixVente: 0, heures: 0, matCout: 0, profit: 0, count: 0 };
                            tagData[tagPrefix].prixVente += ajoutTotal;
                            tagData[tagPrefix].count++;
                        }
                    }
                    return;
                }
                var item = CATALOGUE_DATA.find(function(i) { return i.id === selectedId; });
                if (!item) return;

                var installCb = document.getElementById(row.id + '-install');
                var includeInstall = installCb ? installCb.checked : true;
                var laborMinutes = item.labor_minutes || {};
                var materialCosts = item.material_costs || {};

                var rowHeures = 0, rowMatCout = 0, rowProfit = 0, rowPrixVente = 0;

                // Départements
                tauxHoraires.forEach(function(t) {
                    var dept = t.department;
                    var mins = (laborMinutes[dept] || 0) * qty;
                    if (!includeInstall && dept === 'Installation') return;
                    deptMinutes[dept] = (deptMinutes[dept] || 0) + mins;
                    var hours = mins / 60;
                    totalHeuresCharge += hours * (t.taux_horaire || 0);
                    totalSalaires += hours * (t.salaire || 0);
                    totalFraisFixes += hours * (t.frais_fixe || 0);
                    totalProfitMO += hours * ((t.taux_horaire || 0) - (t.salaire || 0) - (t.frais_fixe || 0));
                    rowHeures += hours;
                    rowPrixVente += hours * (t.taux_horaire || 0);
                    rowProfit += hours * ((t.taux_horaire || 0) - (t.salaire || 0) - (t.frais_fixe || 0));
                });

                // Matériaux
                expenseCategories.forEach(function(c) {
                    var cost = (materialCosts[c.name] || 0) * qty;
                    matCoutant[c.name] = (matCoutant[c.name] || 0) + cost;
                    totalMatCoutant += cost;
                    totalMatMarkup += cost * ((c.markup || 0) / 100);
                    totalMatWaste += cost * ((c.waste || 0) / 100);
                    rowMatCout += cost;
                    rowPrixVente += cost + cost * ((c.markup || 0) / 100) + cost * ((c.waste || 0) / 100);
                    rowProfit += cost * ((c.markup || 0) / 100);
                });

                // Fallback: si pas de données composées, utiliser item.price
                var composedPrice = computeComposedPrice(item, includeInstall);
                if (composedPrice === null) {
                    var flatTotal = (item.price || 0) * qty;
                    totalPrixVente += flatTotal;
                    rowPrixVente += flatTotal;
                }

                // Accumulate per-tag
                if (tagPrefix) {
                    if (!tagData[tagPrefix]) tagData[tagPrefix] = { prixVente: 0, heures: 0, matCout: 0, profit: 0, count: 0 };
                    tagData[tagPrefix].prixVente += rowPrixVente;
                    tagData[tagPrefix].heures += rowHeures;
                    tagData[tagPrefix].matCout += rowMatCout;
                    tagData[tagPrefix].profit += rowProfit;
                    tagData[tagPrefix].count++;
                }
            });

            totalPrixVente += totalHeuresCharge + totalMatCoutant + totalMatWaste + totalMatMarkup;

            // Marges
            var profitNet = totalProfitMO + totalMatMarkup;
            var margeBrutReelPct = totalPrixVente > 0 ? (profitNet / totalPrixVente * 100) : 0;
            var margeVisee = 38; // %
            var margeViseeMontant = totalPrixVente * margeVisee / 100;

            // Total minutes
            var totalMinutes = 0;
            tauxHoraires.forEach(function(t) { totalMinutes += (deptMinutes[t.department] || 0); });

            // Render
            var f = function(v) { return Math.round(v).toLocaleString('fr-CA') + ' $'; };
            var fPct = function(v) { return v.toFixed(1) + ' %'; };
            var fNum = function(v) { return v.toLocaleString('fr-CA', { minimumFractionDigits: 1, maximumFractionDigits: 1 }); };

            var html = '';

            // ── 2 colonnes : résumé | ventilation + marges ──
            html += '<div class="rentab-columns">';

            // Colonne gauche — Résumé
            html += '<div>';
            html += '<div class="rentab-section">';
            html += '<div class="rentab-section-title">R\u00e9sum\u00e9</div>';
            html += '<table class="rentab-table">';
            html += '<tr class="highlight"><td>Prix de vente total</td><td>' + f(totalPrixVente) + '</td></tr>';
            html += '<tr class="spacer"><td></td><td></td></tr>';
            html += '<tr><td>Prix co\u00fbtant mat\u00e9riaux (base)</td><td>' + f(totalMatCoutant) + '</td></tr>';
            html += '<tr><td>Perte mat\u00e9riaux</td><td>' + f(totalMatWaste) + '</td></tr>';
            html += '<tr><td>Mark up mat\u00e9riaux</td><td>' + f(totalMatMarkup) + '</td></tr>';
            html += '<tr class="spacer"><td></td><td></td></tr>';
            html += '<tr class="highlight"><td>Total heures charg\u00e9</td><td>' + f(totalHeuresCharge) + '</td></tr>';
            html += '<tr><td>Total salaires</td><td>' + f(totalSalaires) + '</td></tr>';
            html += '<tr><td>Total frais fixes</td><td>' + f(totalFraisFixes) + '</td></tr>';
            html += '<tr><td>Profit sur taux horaire</td><td>' + f(totalProfitMO) + '</td></tr>';
            html += '</table>';
            html += '</div>';
            html += '</div>';

            // Colonne droite — Ventilation + Marges
            html += '<div>';

            // Départements
            html += '<div class="rentab-section">';
            html += '<div class="rentab-section-title">Ventilation main-d\u2019\u0153uvre</div>';
            html += '<table class="rentab-dept-table">';
            html += '<tr><th></th>';
            tauxHoraires.forEach(function(t) {
                var short = t.department.split('/')[0].substring(0, 6);
                html += '<th>' + escapeHtml(short) + '</th>';
            });
            html += '</tr>';
            // Heures
            html += '<tr><td>Heures</td>';
            var totalHeures = 0;
            tauxHoraires.forEach(function(t) {
                var h = (deptMinutes[t.department] || 0) / 60;
                totalHeures += h;
                html += '<td>' + fNum(h) + '</td>';
            });
            html += '</tr>';
            html += '</table>';
            html += '</div>';

            // Marges
            html += '<div class="rentab-section">';
            html += '<div class="rentab-section-title">Marges</div>';
            html += '<div class="rentab-margins">';
            html += '<div class="rentab-margins-row"><span>Marge brut vis\u00e9e</span><span>' + fPct(margeVisee) + '</span></div>';
            html += '<div class="rentab-margins-row"><span>Marge brut r\u00e9elle</span><span>' + fPct(margeBrutReelPct) + '</span></div>';
            html += '<div class="rentab-margins-row profit-row"><span>Profit net estim\u00e9</span><span>' + f(profitNet) + '</span></div>';
            html += '</div>';
            html += '</div>';

            html += '</div>';
            html += '</div>'; // fin rentab-columns

            // ── Pleine largeur : Coûtant matériaux ──
            html += '<div class="rentab-section" style="margin-top:8px;">';
            html += '<div class="rentab-section-title">Co\u00fbtant mat\u00e9riaux</div>';
            html += '<table class="rentab-table">';
            var hasMatRows = false;
            expenseCategories.forEach(function(c) {
                var costVal = matCoutant[c.name] || 0;
                if (costVal > 0) {
                    html += '<tr><td>' + escapeHtml(c.name) + '</td><td>' + f(costVal) + '</td></tr>';
                    hasMatRows = true;
                }
            });
            if (!hasMatRows) html += '<tr><td colspan="2" style="color:#999;">Aucun mat\u00e9riau</td></tr>';
            html += '<tr class="total"><td>Total</td><td>' + f(totalMatCoutant) + '</td></tr>';
            html += '</table>';
            html += '</div>';

            // ── Ventilation par tag ──
            var tagPrefixKeys = Object.keys(tagData).sort();
            if (tagPrefixKeys.length > 0) {
                html += '<div class="rentab-section rentab-tag-section">';
                html += '<div class="rentab-section-title">Ventilation par tag</div>';
                html += '<div class="rentab-tag-grid">';
                tagPrefixKeys.forEach(function(prefix) {
                    var td = tagData[prefix];
                    var tp = (tagPrefixes || []).find(function(t) { return t.prefix === prefix; });
                    var label = tp ? prefix + ' — ' + tp.label_fr : prefix;
                    var marge = td.prixVente > 0 ? (td.profit / td.prixVente * 100) : 0;
                    html += '<div class="rentab-tag-card">';
                    html += '<div class="rentab-tag-card-title">' + escapeHtml(label) + ' (' + td.count + ' ligne' + (td.count > 1 ? 's' : '') + ')</div>';
                    html += '<table>';
                    html += '<tr><td>Prix de vente</td><td>' + f(td.prixVente) + '</td></tr>';
                    html += '<tr><td>Heures</td><td>' + fNum(td.heures) + ' h</td></tr>';
                    html += '<tr><td>Mat\u00e9riaux (co\u00fbt)</td><td>' + f(td.matCout) + '</td></tr>';
                    html += '<tr class="tag-card-total"><td>Profit</td><td>' + f(td.profit) + '</td></tr>';
                    html += '<tr><td>Marge</td><td>' + fPct(marge) + '</td></tr>';
                    html += '</table>';
                    html += '</div>';
                });
                html += '</div>';
                html += '</div>';
            }

            document.getElementById('rentabBody').innerHTML = html;
            document.getElementById('rentabModal').classList.add('active');
        }

        function closeRentab() {
            document.getElementById('rentabModal').classList.remove('active');
        }

        // ═══════════════════════════════════════════════════════════════════════
        // VÉRIFICATION DES PERMISSIONS
        // ═══════════════════════════════════════════════════════════════════════

        const DEFAULT_PERMISSIONS = {
            'Admin': { calculateur: true }, 'Vente': { calculateur: true },
            'Charg\u00e9 de projet': { calculateur: true }, 'Achat': { calculateur: false },
            'Atelier': { calculateur: false }, 'Client': { calculateur: false }
        };
        const DEFAULT_USER_ROLES = { 'hubert@stele.ca': 'Admin' };

        async function checkPageAccess() {
            try {
                const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/app_config?key=in.(permissions,user_roles)&select=key,value', {});
                let perms = DEFAULT_PERMISSIONS, roles = DEFAULT_USER_ROLES;
                if (r.ok) {
                    const rows = await r.json();
                    rows.forEach(row => {
                        if (row.key === 'permissions') perms = row.value;
                        if (row.key === 'user_roles') roles = row.value;
                    });
                }
                const email = (localStorage.getItem('sb_user_email') || '').toLowerCase();
                const role = roles[email] || 'Client';
                const defaults = DEFAULT_PERMISSIONS[role] || {};
                const saved = perms[role] || {};
                const allowed = Object.assign({}, defaults, saved);
                canEditMinutes = !!allowed.edit_minutes;
                canEditMaterials = !!allowed.edit_materials;
                canApproveQuotes = !!allowed.can_approve_quotes;
                canBypassApproval = !!allowed.can_bypass_approval;
                canUnlockSubmission = !!allowed.can_unlock_submission;
                var hasSubParam = new URLSearchParams(window.location.search).has('submission');
                if (!allowed.calculateur && !(hasSubParam && (allowed.approbation || allowed.can_approve_quotes))) {
                    window.location.href = 'app.html'; return false;
                }
            } catch (e) {
                const email = (localStorage.getItem('sb_user_email') || '').toLowerCase();
                const role = DEFAULT_USER_ROLES[email] || 'Client';
                var defPerms = DEFAULT_PERMISSIONS[role] || {};
                canEditMinutes = !!defPerms.edit_minutes;
                canEditMaterials = !!defPerms.edit_materials;
                canApproveQuotes = !!defPerms.can_approve_quotes;
                canBypassApproval = !!defPerms.can_bypass_approval;
                canUnlockSubmission = !!defPerms.can_unlock_submission;
                if (!defPerms.calculateur) { window.location.href = 'app.html'; return false; }
            }
            return true;
        }

        async function loadMediaTags() {
            try {
                const r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/app_config?key=eq.media_tags&select=value', {});
                if (r.ok) {
                    const rows = await r.json();
                    if (rows.length > 0 && Array.isArray(rows[0].value)) {
                        mediaTagsList = rows[0].value;
                    }
                }
            } catch (e) { /* keep defaults */ }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // ═══════════════════════════════════════════════════════════════════════
        // Listen for captures from standalone PDF viewer window
        // ═══════════════════════════════════════════════════════════════════════
        window.addEventListener('message', function(e) {
            if (e.data && e.data.type === 'PLAN_CAPTURE_DONE') {
                var roomId = e.data.roomId;
                // Find groupDomId from roomMap (reverse lookup)
                var groupId = null;
                for (var key in roomMap) {
                    if (roomMap[key] === roomId) { groupId = key; break; }
                }
                if (!groupId) return;

                if (!groupImages[groupId]) groupImages[groupId] = [];
                groupImages[groupId].push({
                    name: (e.data.croppedUrl || '').split('/').pop() || 'capture.jpg',
                    url: e.data.croppedUrl,
                    originalUrl: e.data.originalUrl,
                    mediaId: e.data.mediaId,
                    tags: ['presentation_soumission'],
                    cropRatio: e.data.cropRatio,
                    isLegacy: false,
                    showInQuote: true,
                    annotations: []
                });
                renderGroupImagePreviews(groupId);
                showSaveIndicator();
            }
        });

        // INITIALISATION
        // ═══════════════════════════════════════════════════════════════════════

        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Verify PDF.js loaded
                if (!scriptsLoaded.pdfjs && typeof pdfjsLib === 'undefined') {
                    throw new Error('PDF.js failed to load');
                }

                if (!(await checkPageAccess())) return;
                await loadCatalogueData();
                await loadConfigCategories();
                await loadTauxAndExpenses();
                await loadMediaTags();
                await loadEmployeesData();
                await loadPipelineConfig();
                setupProposerMediaHandlers();

                // Setup PDF viewer Ctrl+scroll zoom
                var pdfCanvasContainer = document.getElementById('pdfCanvasContainer');
                if (pdfCanvasContainer) {
                    pdfCanvasContainer.addEventListener('wheel', function(e) {
                        if (e.ctrlKey) {
                            e.preventDefault();
                            var delta = e.deltaY > 0 ? -0.1 : 0.1;
                            pdfZoom(delta);
                        }
                    }, { passive: false });
                }

                // Check for direct submission opening (from approbation page)
                var params = new URLSearchParams(window.location.search);
                var submissionParam = params.get('submission');
                if (submissionParam) {
                    isApprovalMode = true;
                    await openSubmission(submissionParam);
                } else {
                    renderProjectList();
                }

                // App is ready - hide overlay
                appReady = true;
                hideOverlay();

            } catch (error) {
                console.error('Application initialization error:', error);
                var errorMsg = 'Une erreur est survenue lors du chargement de l\'application.';
                if (error && error.message) {
                    errorMsg += '\n\nDétails techniques: ' + error.message;
                }
                showOverlayError(
                    'Erreur de chargement',
                    errorMsg
                );
            }
        });
    </script>

</body>
</html>
