<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catalogue de prix — Stele</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="scopewright-tokens.css">

    <!-- Auth guard — vérifie le token localStorage avant d'afficher la page -->
    <script>
        if (!localStorage.getItem('sb_access_token')) {
            window.location.href = 'login.html';
        } else {
            document.documentElement.style.visibility = 'visible';
        }
    </script>
    <style>html { visibility: hidden; }</style>
    <script>
    // Embedded mode: inject CSS immediately to prevent catalogue chrome flash
    if (new URLSearchParams(window.location.search).has('embedded')) {
        var s = document.createElement('style');
        s.textContent = '.nav-bar,.catalogue-search-bar,.catalogue-header-bar,#mainCatalogueTable,#aiFilterBadge{display:none!important}'
            + 'body{background:transparent!important}'
            + '.modal-overlay{background:transparent!important}'
            + '.modal-overlay .modal.modal-edit{max-width:none;max-height:none;height:100vh;border-radius:0;box-shadow:none}'
            + '.modal-overlay .modal.modal-edit .modal-body{flex:1}'
            + '.sandbox-split-container{max-width:none;max-height:none;height:100vh;border-radius:0;box-shadow:none}';
        document.head.appendChild(s);
    }
    </script>

    <script>
    /*
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║                                                                              ║
    ║   CATALOGUE DE PRIX STELE — DONNÉES                                          ║
    ║                                                                              ║
    ║   Les données sont chargées automatiquement depuis Supabase.                ║
    ║   En cas de perte de connexion, les dernières données connues sont utilisées.║
    ║                                                                              ║
    ╚══════════════════════════════════════════════════════════════════════════════╝
    */

    const SUPABASE_URL = 'https://rplzbtjfnwahqodrhpny.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJwbHpidGpmbndhaHFvZHJocG55Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NDU2MDEsImV4cCI6MjA4NjIyMTYwMX0.OQAZhc029PbRDSe1b02NDAuOUE8yn-_h3QqSnUDpLeU';

    // Clé pour le localStorage
    const STORAGE_KEY = 'stele_catalogue_data';
    const STORAGE_DATE_KEY = 'stele_catalogue_date';

    // Mode embedded (ouvert dans iframe depuis calculateur)
    var isEmbedded = new URLSearchParams(window.location.search).has('embedded');

    // Donnees par defaut (utilisees uniquement si jamais connecte et pas de cache)
    // Les codes ST-XXXX correspondent au mapping post-migration.
    // En production, les donnees viennent de Supabase.
    let CATALOGUE_DATA = [
        { id: 'ST-0001', category: 'Budg\u00e9taire', description: 'Fa\u00e7ade (placage de bois) et caisson (m\u00e9lamine)', type: 'pi\u00b2', price: 165.00, instruction: 'Calculer la surface totale des fa\u00e7ades en pieds carr\u00e9s.' },
        { id: 'ST-0002', category: 'Budg\u00e9taire', description: 'Fa\u00e7ade (laque opaque) et caisson (m\u00e9lamine)', type: 'pi\u00b2', price: 150.00, instruction: 'Calculer la surface totale des fa\u00e7ades en pieds carr\u00e9s.' },
        { id: 'ST-0003', category: 'Budg\u00e9taire', description: 'Fa\u00e7ade (Shaker mince opaque) et caisson (m\u00e9lamine)', type: 'pi\u00b2', price: 180.00, instruction: '' },
        { id: 'ST-0004', category: 'Budg\u00e9taire', description: 'Fa\u00e7ade (Shaker mince placage) et caisson (m\u00e9lamine)', type: 'pi\u00b2', price: 195.00, instruction: '' },
        { id: 'ST-0005', category: 'Budg\u00e9taire', description: 'Fa\u00e7ade (type AGT) et caisson (m\u00e9lamine)', type: 'pi\u00b2', price: 100.00, instruction: '' },
        { id: 'ST-0006', category: 'Budg\u00e9taire', description: 'Caisson ouvert (placage de bois)', type: 'pi\u00b2', price: 250.00, instruction: '' },
        { id: 'ST-0007', category: 'Budg\u00e9taire', description: 'Caisson ouvert (laque opaque)', type: 'pi\u00b2', price: 235.00, instruction: '' },
        { id: 'ST-0008', category: '\u00c9clairage', description: 'Bande Flexydel 3000K avec encastrement', type: 'lin\u00e9aire', price: 53.00, instruction: '' },
        { id: 'ST-0009', category: '\u00c9clairage', description: '\u0152il magique', type: 'unitaire', price: 140.00, instruction: '' },
        { id: 'ST-0010', category: '\u00c9clairage', description: 'Transformateur', type: 'unitaire', price: 250.00, instruction: '' },
        { id: 'ST-0011', category: 'Panneaux', description: 'Rev\u00eatement mural (placage)', type: 'pi\u00b2', price: 65.00, instruction: '' },
        { id: 'ST-0012', category: 'Panneaux', description: 'Panneaux ajout\u00e9 (placage)', type: 'pi\u00b2', price: 55.00, instruction: '' },
        { id: 'ST-0013', category: 'Panneaux', description: 'Panneaux \u00e9lectro (placage)', type: 'pi\u00b2', price: 40.00, instruction: '' },
        { id: 'ST-0014', category: 'Panneaux', description: 'Rev\u00eatement mural (opaque)', type: 'pi\u00b2', price: 58.00, instruction: '' },
        { id: 'ST-0015', category: 'Panneaux', description: 'Panneaux ajout\u00e9 (opaque)', type: 'pi\u00b2', price: 48.00, instruction: '' },
        { id: 'ST-0016', category: 'Panneaux', description: 'Panneaux \u00e9lectro (opaque)', type: 'pi\u00b2', price: 32.00, instruction: '' },
        { id: 'ST-0017', category: 'Panneaux', description: 'Int\u00e9rieur de caisson en stratifi\u00e9 sur CP versus m\u00e9lamine', type: '%', price: 20, instruction: '' },
        { id: 'ST-0018', category: 'Poign\u00e9es', description: 'Ouverture \u00e0 pression', type: 'unitaire', price: 40.00, instruction: '' },
        { id: 'ST-0019', category: 'Poign\u00e9es', description: 'Placage : finger grip 45\u00b0 avec traverse caisson', type: 'unitaire', price: 220.00, instruction: '' },
        { id: 'ST-0020', category: 'Poign\u00e9es', description: 'Opaque : finger grip 45\u00b0 avec traverse caisson', type: 'unitaire', price: 140.00, instruction: '' },
        { id: 'ST-0021', category: 'Poign\u00e9es', description: 'Placage : finger grip avec bois massif et replacage', type: 'unitaire', price: 275.00, instruction: '' },
        { id: 'ST-0022', category: 'Portes int\u00e9rieures', description: 'Porte 30" x 96" en placage sur penture invisible avec cadre', type: 'unitaire', price: null, instruction: 'Prix sur demande.' },
        { id: 'ST-0023', category: 'Portes int\u00e9rieures', description: 'Porte 30" x 96" en placage sur penture invisible sans cadre', type: 'unitaire', price: null, instruction: 'Prix sur demande.' },
        { id: 'ST-0024', category: 'Portes int\u00e9rieures', description: 'Porte 30" x 96" en placage sur syst\u00e8me coulissant (pocket door)', type: 'unitaire', price: null, instruction: 'Prix sur demande.' },
        { id: 'ST-0025', category: 'Tiroirs', description: 'Bois massif \u00e0 queue d\'aronde', type: 'unitaire', price: 400.00, instruction: '' },
        { id: 'ST-0026', category: 'Tiroirs', description: 'Legrabox avec fa\u00e7ade', type: 'unitaire', price: 300.00, instruction: '' },
        { id: 'ST-0027', category: 'Tiroirs', description: 'Legrabox avec verre (\u00e0 l\'anglaise)', type: 'unitaire', price: 350.00, instruction: '' },
    ];

    /*
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║   FIN DE LA SECTION DONNÉES — Ne pas modifier en dessous de cette ligne      ║
    ║   sauf si vous savez ce que vous faites.                                     ║
    ╚══════════════════════════════════════════════════════════════════════════════╝
    */

    // ═══════════════════════════════════════════════════════════════════════
    // AUTH — refresh proactif + lock anti-race + 401/403
    // ═══════════════════════════════════════════════════════════════════════

    var _refreshPromise = null;

    function isTokenExpiringSoon(token, bufferSec) {
        if (!token) return true;
        try { var p = JSON.parse(atob(token.split('.')[1])); return p.exp < (Date.now() / 1000 + (bufferSec || 300)); }
        catch(e) { return true; }
    }

    function _tokenDebug(token) {
        if (!token) return 'null';
        try { var p = JSON.parse(atob(token.split('.')[1])); var ttl = Math.round(p.exp - Date.now() / 1000); return 'exp in ' + ttl + 's'; }
        catch(e) { return 'invalid'; }
    }

    async function refreshAccessToken() {
        if (_refreshPromise) { console.log('[auth] Refresh already in progress, reusing promise'); return _refreshPromise; }
        _refreshPromise = (async function() {
            var rt = localStorage.getItem('sb_refresh_token');
            if (!rt) { console.warn('[auth] No refresh token in localStorage'); return false; }
            try {
                var r = await fetch(SUPABASE_URL + '/auth/v1/token?grant_type=refresh_token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'apikey': SUPABASE_KEY },
                    body: JSON.stringify({ refresh_token: rt })
                });
                if (!r.ok) { var errBody = await r.text().catch(function() { return ''; }); console.warn('[auth] Refresh failed:', r.status, errBody.substring(0, 200)); return false; }
                var d = await r.json();
                if (d.access_token) {
                    localStorage.setItem('sb_access_token', d.access_token);
                    localStorage.setItem('sb_refresh_token', d.refresh_token);
                    console.log('[auth] Token refreshed OK —', _tokenDebug(d.access_token));
                    return true;
                }
                console.warn('[auth] Refresh response missing access_token');
                return false;
            } catch(e) { console.warn('[auth] Refresh exception:', e.message); return false; }
        })();
        var result = await _refreshPromise;
        _refreshPromise = null;
        return result;
    }

    async function authenticatedFetch(url, options) {
        options = options || {};
        var token = localStorage.getItem('sb_access_token');
        var endpoint = url.split('/').pop().split('?')[0];
        if (isTokenExpiringSoon(token, 300)) {
            console.log('[auth]', endpoint, '— token expiring soon (' + _tokenDebug(token) + '), refreshing...');
            if (await refreshAccessToken()) token = localStorage.getItem('sb_access_token');
        }
        var headers = Object.assign({}, options.headers || {}, {
            'apikey': SUPABASE_KEY,
            'Authorization': 'Bearer ' + token
        });
        var resp = await fetch(url, Object.assign({}, options, { headers: headers }));
        if (resp.status === 401 || resp.status === 403) {
            console.warn('[auth]', endpoint, '— got', resp.status, '(token:', _tokenDebug(token) + '). Refreshing...');
            for (var attempt = 1; attempt <= 2; attempt++) {
                if (attempt === 2) { console.warn('[auth]', endpoint, '— attempt 2: waiting 1s before retry...'); await new Promise(function(r) { setTimeout(r, 1000); }); _refreshPromise = null; }
                if (await refreshAccessToken()) {
                    token = localStorage.getItem('sb_access_token'); headers['Authorization'] = 'Bearer ' + token;
                    resp = await fetch(url, Object.assign({}, options, { headers: headers }));
                    if (resp.status !== 401 && resp.status !== 403) { console.log('[auth]', endpoint, '— retry', attempt, 'succeeded:', resp.status); return resp; }
                    console.warn('[auth]', endpoint, '— retry', attempt, 'still', resp.status);
                } else { console.warn('[auth]', endpoint, '— refresh failed on attempt', attempt); localStorage.removeItem('sb_access_token'); localStorage.removeItem('sb_refresh_token'); window.location.href = 'login.html'; return resp; }
            }
        }
        return resp;
    }
    </script>

    <style>
        /* Reset et base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-size: 16px;
            line-height: 1.5;
            background: var(--sw-surface);
        }

        /* Page setup for print */
        @media print {
            @page {
                size: landscape;
                margin: 0.75in;
            }

            .content-page {
                page-break-after: always;
            }

            .no-print {
                display: none;
            }
        }

        /* Content pages */
        .content-page {
            padding: 40px 60px;
            background: var(--sw-surface);
        }

        /* Catalogue header bar (title + dropdown) */
        .catalogue-header-bar {
            display: flex; align-items: center; gap: 16px;
            padding: 24px 60px 16px;
        }
        .catalogue-title {
            font-size: 24px; font-weight: 700; color: var(--sw-text);
            margin: 0;
        }
        .catalogue-cat-dropdown {
            display: flex; align-items: center; gap: 6px;
            padding: 5px 12px; border: 1px solid #ddd; border-radius: 8px;
            font-size: 13px; color: #555; cursor: pointer;
            transition: border-color 0.15s, background 0.15s;
            user-select: none;
        }
        .catalogue-cat-dropdown:hover { border-color: #999; background: #fafafa; }
        .catalogue-cat-dropdown.active { border-color: var(--sw-navy); color: var(--sw-navy); }
        .cat-dd-chevron { font-size: 10px; color: #999; }
        /* Category grouping row */
        .cat-group-row td {
            background: var(--sw-border-2); color: var(--sw-text-2); font-weight: 600;
            font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em;
            padding: 8px 16px !important; border-bottom: 1px solid var(--sw-border);
        }
        /* Category dropdown popover */
        .cat-dd-popover {
            position: fixed; z-index: 9999;
            background: var(--sw-surface); border-radius: var(--sw-radius-btn);
            box-shadow: var(--sw-shadow-dropdown);
            min-width: 200px; max-height: 320px; overflow-y: auto;
            padding: 4px 0;
            animation: sdFadeIn 120ms ease-out;
        }
        .cat-dd-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 8px 14px; cursor: pointer; font-size: 13px; color: var(--sw-text);
            transition: background var(--sw-ease);
        }
        .cat-dd-item:hover, .cat-dd-item.focused { background: var(--sw-border-2); }
        .cat-dd-item .cat-dd-check { color: var(--sw-text-2); font-size: 14px; }

        /* Search bar */
        .catalogue-search-bar {
            position: sticky; top: 56px; z-index: 100;
            background: var(--sw-surface); padding: 12px 60px;
            border-bottom: 1px solid var(--sw-border);
            margin-top: 56px;
        }
        .catalogue-search-bar input {
            width: 100%; padding: 10px 16px;
            border: 1px solid var(--sw-border); border-radius: var(--sw-radius-input);
            font-size: 14px; background: var(--sw-bg);
            outline: none; transition: border-color var(--sw-ease);
        }
        .catalogue-search-bar input:focus {
            border-color: var(--sw-navy); background: var(--sw-surface);
        }
        .catalogue-search-bar input::placeholder { color: var(--sw-muted); }
        .ai-filter-badge {
            max-width: 1060px; margin: 0 auto; padding: 6px 16px;
            background: #EEF2FF; color: #3B5998; font-size: 12px; font-weight: 500;
            border-radius: 0 0 8px 8px; cursor: pointer; text-align: center;
            transition: background 0.15s;
        }
        .ai-filter-badge:hover { background: #DBEAFE; }
        @keyframes fadeSlideIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .ai-row-animate { animation: fadeSlideIn 200ms ease-out both; }

        /* ═══ AI insertion animations ═══ */
        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .modal-overlay.anim-enter { animation: modalFadeIn 120ms ease-out; }

        @keyframes fieldReveal {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .field-reveal { animation: fieldReveal 200ms ease-out both; }

        .modal-progress {
            position: absolute; top: 0; left: 0; right: 0; height: 1px;
            background: transparent; overflow: hidden; border-radius: 8px 8px 0 0;
            pointer-events: none; z-index: 1;
        }
        .modal-progress-bar {
            height: 100%; width: 0; background: rgba(0,0,0,0.08);
            transition: width 100ms ease-out;
        }
        .modal-progress-bar.done {
            opacity: 0; transition: opacity 400ms ease-out;
        }

        @keyframes savePulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        .btn-generate.pulse { animation: savePulse 180ms ease-out; }

        .ai-batch-row {
            opacity: 0; transform: translateY(4px);
            animation: batchSlideIn 140ms ease-out both;
        }
        @keyframes batchSlideIn {
            to { opacity: 1; transform: translateY(0); }
        }

        .ai-batch-restore {
            display: inline-block; margin: 12px 0 0 16px;
            font-size: 12px; color: var(--sw-text-2); cursor: pointer;
            opacity: 0.6; transition: opacity 150ms ease;
        }
        .ai-batch-restore:hover { opacity: 1; }

        @media (prefers-reduced-motion: reduce) {
            .modal-overlay.anim-enter,
            .field-reveal,
            .btn-generate.pulse,
            .ai-batch-row { animation: none !important; opacity: 1; transform: none; }
        }

        /* Sortable column headers */
        .price-table th.sortable {
            cursor: pointer; user-select: none; position: relative;
            padding-right: 18px;
        }
        .price-table th.sortable:hover { color: var(--sw-navy); }
        .price-table th.sortable::after {
            content: '\2195'; position: absolute; right: 4px; top: 50%;
            transform: translateY(-50%); font-size: 10px; color: #aaa;
        }
        .price-table th.sortable.sort-asc::after { content: '\25B2'; color: var(--sw-navy); }
        .price-table th.sortable.sort-desc::after { content: '\25BC'; color: var(--sw-navy); }

        /* Header */
        .page-header {
            display: flex;
            align-items: center;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--sw-border);
            margin-bottom: 40px;
        }

        .header-logo {
            font-size: 28px;
            font-weight: 400;
            color: var(--sw-text);
            letter-spacing: -0.5px;
        }

        /* Section title */
        .section-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--sw-text);
            margin-bottom: 24px;
        }


        .legend-title {
            font-weight: 700;
            margin-bottom: 8px;
        }

        .legend ul {
            list-style: none;
            padding-left: 0;
        }

        .legend li {
            margin-bottom: 4px;
            padding-left: 0;
        }

        .legend li::before {
            content: "—";
            margin-right: 8px;
            color: var(--sw-border);
        }

        /* Tables */
        .price-table {
            width: calc(100% - 120px);
            margin: 0 60px;
            border-collapse: collapse;
        }

        .price-table thead {
            background-color: var(--sw-navy);
        }

        .price-table th {
            color: var(--sw-surface);
            font-weight: 700;
            font-size: 14px;
            padding: 14px 16px;
            text-align: left;
        }

        .price-table th:nth-child(2) {
            text-align: center;
        }

        .price-table th:last-child {
            text-align: right;
        }

        .price-table td {
            padding: 12px 16px;
            font-size: 14px;
            border-bottom: 1px solid var(--sw-border);
        }

        .price-table td:nth-child(1) {
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            color: #666;
        }

        .price-table td:nth-child(2) {
            text-align: center;
        }

        .price-table td:last-child {
            text-align: right;
            font-weight: 500;
        }

        .price-table tbody tr:nth-child(odd) {
            background-color: var(--sw-surface);
        }

        .price-table tbody tr:nth-child(even) {
            background-color: var(--sw-border-2);
        }

        .price-table tbody tr:last-child td {
            border-bottom: 2px solid var(--sw-text);
        }

        /* Column widths */
        .col-code { width: 10%; }
        .col-fiche { width: 8%; }
        .col-type { width: 10%; }
        .col-description { width: 52%; }
        .col-price { width: 20%; }

        .fiche-link {
            font-size: 11px;
            color: var(--sw-navy);
            text-decoration: none;
            white-space: nowrap;
        }
        .fiche-link:hover { text-decoration: underline; }

        /* Footer */
        .page-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 40px;
            padding-top: 16px;
            font-size: 12px;
            color: var(--sw-text);
        }

        .footer-logo {
            font-size: 14px;
        }

        /* HEADER SCOPEWRIGHT STANDARD */
        .nav-bar {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: 56px;
            background: var(--sw-surface);
            border-bottom: 1px solid var(--sw-border);
            padding: 0 60px;
            display: flex;
            align-items: center;
            gap: var(--sw-space-3);
            z-index: 100;
        }
        .nav-logo {
            font-size: 23px;
            font-weight: 650;
            letter-spacing: -0.025em;
            line-height: 1;
            color: var(--sw-navy);
            text-decoration: none;
        }
        .nav-back {
            color: var(--sw-text);
            text-decoration: none;
            font-size: 13px;
            font-weight: 400;
            opacity: 0.45;
            transition: opacity var(--sw-ease);
            white-space: nowrap;
            border-right: 1px solid var(--sw-border);
            padding-right: 20px;
        }
        .nav-back:hover { opacity: 0.8; }

        .nav-links {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        @media print {
            .nav-bar, .catalogue-search-bar {
                display: none;
            }

            .content-page {
                min-height: auto;
            }
        }

        /* Indicateur de statut des données */
        .data-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            padding: 6px 12px;
            border-radius: 20px;
            background: #f5f5f5;
        }

        .data-status.online {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .data-status.offline {
            background: #fff3e0;
            color: #ef6c00;
        }

        .data-status.error {
            background: #ffebee;
            color: #c62828;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        .data-status.online .status-dot {
            background: #4caf50;
        }

        .data-status.offline .status-dot {
            background: #ff9800;
        }

        .data-status.error .status-dot {
            background: #f44336;
        }

        .status-text {
            white-space: nowrap;
        }

        @media print {
            .data-status {
                display: none;
            }
        }


        /* Tooltip styles */
        .tooltip-container {
            position: relative;
            cursor: help;
        }

        .tooltip {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--sw-text);
            color: var(--sw-surface);
            padding: 10px 14px;
            border-radius: 4px;
            font-size: 12px;
            line-height: 1.5;
            white-space: normal;
            width: 240px;
            text-align: left;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: opacity 0.2s ease, visibility 0.2s ease;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }

        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--sw-text);
        }

        .tooltip-container:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        .tooltip-title {
            font-weight: 700;
            margin-bottom: 4px;
            font-size: 12px;
        }

        .tooltip-text {
            font-weight: 400;
            color: rgba(255,255,255,0.85);
        }

        /* Tooltips dans les tableaux */
        .tooltip-table {
            cursor: help;
            border-bottom: 1px dotted var(--sw-border);
        }

        .tooltip-table .tooltip {
            width: 280px;
        }

        /* Tooltip aligné à gauche pour les descriptions longues */
        .tooltip-left .tooltip {
            left: 0;
            transform: translateX(0);
        }

        .tooltip-left .tooltip::after {
            left: 24px;
            transform: translateX(0);
        }

        /* Image dans le tooltip */
        .tooltip-image {
            width: 100%;
            max-width: 200px;
            height: auto;
            border-radius: 3px;
            margin-bottom: 8px;
            display: block;
        }

        .tooltip-table .tooltip.has-image {
            width: 320px;
        }

        /* Bouton modifier dans les tableaux */
        .col-edit {
            width: 40px;
            text-align: center;
        }

        .btn-edit-row {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px 6px;
            opacity: 0;
            transition: opacity 0.15s;
            color: var(--sw-text);
            font-size: 14px;
            border-radius: 3px;
        }

        .btn-edit-row:hover {
            background: rgba(0,0,0,0.06);
        }

        .price-table tbody tr:hover .btn-edit-row {
            opacity: 0.5;
        }

        .price-table tbody tr:hover .btn-edit-row:hover {
            opacity: 1;
        }

        .btn-add-item {
            width: 24px;
            height: 24px;
            border: 1.5px solid rgba(255,255,255,0.5);
            background: transparent;
            color: rgba(255,255,255,0.7);
            border-radius: 50%;
            font-size: 16px;
            line-height: 1;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
            padding: 0;
        }

        .btn-add-item:hover {
            background: rgba(255,255,255,0.2);
            color: #fff;
            border-color: rgba(255,255,255,0.8);
        }

        /* Modal d'édition — agrandie pour les champs */
        .modal.modal-edit {
            max-width: 800px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        /* ═══ Sandbox split layout (admin only) ═══ */
        .sandbox-split-container {
            display: flex; width: 96vw; max-width: 1600px;
            max-height: 92vh; border-radius: 8px; overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2); background: #fff;
        }
        .sandbox-split-container .modal.modal-edit {
            flex: 0 0 45%; max-width: none; max-height: none;
            border-radius: 0; box-shadow: none; margin: 0;
        }
        .sandbox-panel {
            flex: 0 0 55%; display: flex; flex-direction: column;
            border-right: 1px solid #e0e0e0; overflow-y: auto; padding: 20px 24px;
            background: #fafbfc;
        }
        .sb-section-title {
            font-size: 11px; font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.5px; color: var(--sw-navy); margin-bottom: 10px;
            padding-bottom: 6px; border-bottom: 1px solid #eee;
        }
        .sb-divider { border: none; border-top: 1px solid #eee; margin: 16px 0; }

        /* Material defaults */
        .sb-mat-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .sb-mat-label { font-size: 12px; font-weight: 500; color: #555; min-width: 90px; }
        .sb-mat-select {
            flex: 1; padding: 5px 8px; border: 1px solid #ddd; border-radius: 4px;
            font-size: 12px; font-family: inherit; background: #fff;
        }

        /* Description preview */
        .sb-desc-preview {
            font-size: 13px; color: #333; line-height: 1.6; min-height: 40px;
            max-height: 180px; overflow-y: auto;
            padding: 10px 12px; background: #fff; border: 1px solid #e8e8e8;
            border-radius: 6px;
        }
        .sb-desc-preview p { margin: 0 0 3px 0; }
        .sb-desc-preview strong { font-weight: 600; color: #222; }
        .sb-desc-preview ul { margin: 2px 0 6px 0; padding-left: 18px; }
        .sb-desc-preview li { margin-bottom: 2px; color: #555; }
        .sb-desc-placeholder { color: #bbb; font-style: italic; font-size: 12px; }

        /* Sandbox rows */
        .sb-rows-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .sb-rows-table th {
            text-align: left; font-size: 11px; font-weight: 600; color: #888;
            padding: 4px 6px; border-bottom: 1px solid #e0e0e0;
        }
        .sb-rows-table td { padding: 5px 6px; border-bottom: 1px solid #f0f0f0; vertical-align: middle; }
        .sb-rows-table .sb-code { color: #888; font-size: 11px; }
        .sb-rows-table .sb-desc { max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .sb-rows-table .sb-auto-tag { font-size: 10px; color: #888; margin-left: 4px; }
        .sb-rows-table .sb-warn { font-size: 10px; color: #ef6c00; display: block; margin-top: 2px; }
        .sb-qty-input {
            width: 50px; padding: 3px 6px; border: 1px solid #ddd; border-radius: 3px;
            font-size: 12px; text-align: center; font-family: inherit;
        }
        .sb-remove-btn {
            background: none; border: none; color: #ccc; font-size: 16px;
            cursor: pointer; padding: 0 4px; line-height: 1;
        }
        .sb-remove-btn:hover { color: #e74c3c; }

        /* Combobox */
        .sb-combobox-wrap { position: relative; margin-bottom: 12px; }
        .sb-combobox-input {
            width: 100%; padding: 7px 10px; border: 1px solid #ddd; border-radius: 4px;
            font-size: 12px; font-family: inherit;
        }
        .sb-combobox-input:focus { outline: none; border-color: var(--sw-navy); }
        .sb-combobox-dd {
            position: absolute; top: 100%; left: 0; right: 0; max-height: 260px;
            overflow-y: auto; background: #fff; border: 1px solid #ddd;
            border-top: none; border-radius: 0 0 6px 6px; z-index: 10;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: none;
        }
        .sb-combobox-dd.open { display: block; }
        .sb-cb-group { font-size: 10px; font-weight: 600; color: #888; padding: 6px 10px 3px; text-transform: uppercase; }
        .sb-cb-item {
            padding: 6px 10px; cursor: pointer; font-size: 12px; display: flex;
            align-items: center; gap: 8px;
        }
        .sb-cb-item:hover { background: #f1f5f9; }
        .sb-cb-item img { width: 28px; height: 28px; object-fit: cover; border-radius: 3px; flex-shrink: 0; }
        .sb-cb-item .sb-cb-desc { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .sb-cb-item .sb-cb-price { color: #888; font-size: 11px; white-space: nowrap; }

        /* Subtotal & actions */
        .sb-subtotal-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 0; margin-top: 8px; border-top: 1px solid #e0e0e0;
        }
        .sb-subtotal-label { font-size: 13px; font-weight: 600; color: #333; }
        .sb-subtotal-value { font-size: 14px; font-weight: 700; color: var(--sw-navy); }
        .sb-dims-row { display: flex; align-items: center; gap: 12px; margin-bottom: 4px; }
        .sb-dims-row label { display: flex; align-items: center; gap: 4px; font-size: 12px; font-weight: 600; color: var(--sw-navy); }
        .sb-dim-input {
            width: 70px; padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px;
            font-size: 13px; font-family: inherit; text-align: right;
        }
        .sb-dim-input:focus { border-color: var(--sw-navy); outline: none; }
        .sb-dim-unit { font-size: 11px; color: #888; margin-left: -2px; }
        .sb-actions { display: flex; gap: 8px; margin-top: 8px; }
        .sb-btn {
            padding: 5px 14px; border: 1px solid #ddd; border-radius: 4px;
            background: #fff; font-size: 12px; font-family: inherit;
            cursor: pointer; color: #555; transition: all 0.2s;
        }
        .sb-btn:hover { border-color: #999; background: #f5f5f5; }
        .sb-btn-primary { background: var(--sw-navy); color: #fff; border-color: var(--sw-navy); }
        .sb-btn-primary:hover { opacity: 0.85; }

        .edit-row {
            display: flex;
            gap: 12px;
        }

        .edit-row .form-group {
            flex: 1;
        }

        /* ═══ Prix composé — tableaux minutes & matériaux ═══ */
        .composed-price-section {
            display: flex;
            gap: 16px;
            margin-top: 8px;
        }
        .cp-table-wrap {
            flex: 1;
            min-width: 0;
        }
        .template-hint {
            display: flex; align-items: flex-start; gap: 10px;
            background: #f0f4f8; border: 1px solid #d0d8e0; border-radius: 6px;
            padding: 10px 14px; margin-bottom: 12px; font-size: 12px; color: #475569;
            line-height: 1.5;
        }
        .template-hint-icon { flex-shrink: 0; font-size: 15px; margin-top: 1px; opacity: 0.6; }
        .template-hint-content { flex: 1; min-width: 0; }
        .template-hint-content strong { font-size: 11px; text-transform: uppercase; letter-spacing: 0.3px; color: #334155; display: block; margin-bottom: 3px; }
        .template-hint-text { white-space: pre-wrap; max-height: 80px; overflow-y: auto; }
        .template-hint-link { flex-shrink: 0; font-size: 11px; color: #64748b; text-decoration: underline; white-space: nowrap; margin-top: 1px; }
        .template-hint-link:hover { color: #334155; }
        .calc-rule-json {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            tab-size: 2;
        }
        .calc-rule-success {
            border-color: var(--sw-navy) !important;
            transition: border-color 1.5s;
        }
        .ai-field-wrap {
            position: relative;
        }
        .btn-ai-dot {
            position: absolute; top: 6px; right: 6px; z-index: 2;
            width: 22px; height: 22px; border-radius: 50%;
            background: transparent; border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            padding: 0; flex-shrink: 0;
        }
        .btn-ai-dot:disabled { opacity: 0.3; cursor: not-allowed; }
        .btn-ai-dot .ai-dot {
            width: 9px; height: 9px; border-radius: 50%;
            background: rgba(0,0,0,0.6);
            animation: aiBreathe 3.5s ease-in-out infinite;
            transition: background 300ms ease;
        }
        .btn-ai-dot:hover .ai-dot { opacity: 1; transform: scale(1.3); }
        @keyframes aiBreathe {
            0%,100% { opacity:0.5; transform:scale(1); }
            50% { opacity:1; transform:scale(1.1); }
        }
        /* AI active: fast pulse, navy, larger scale */
        .btn-ai-dot.ai-active .ai-dot {
            background: var(--sw-navy, #0B1220);
            animation: aiBreatheFast 1.2s ease-in-out infinite;
        }
        @keyframes aiBreatheFast {
            0%,100% { opacity:0.6; transform:scale(1); }
            50% { opacity:1; transform:scale(1.25); }
        }
        /* AI done: green flash 500ms */
        .btn-ai-dot.ai-done .ai-dot {
            background: rgba(34,197,94,0.8);
            animation: none; opacity: 1; transform: scale(1.2);
        }
        /* AI Feedback containers */
        .ai-feedback-container { display:flex; flex-direction:column; gap:6px; margin-bottom:6px; }
        .ai-feedback-container:empty { display:none; margin:0; }
        /* Banner base */
        .ai-feedback-banner {
            display:flex; align-items:flex-start; gap:8px;
            padding:8px 10px; border-radius:6px; font-size:12px; line-height:1.4;
            animation: aiFeedbackIn 200ms ease;
        }
        .ai-feedback-banner.warn { background:#FFFBEB; border-left:3px solid #F59E0B; color:#92400E; }
        .ai-feedback-banner.error { background:#FEF2F2; border-left:3px solid #EF4444; color:#991B1B; }
        .ai-feedback-banner.info { background:#F0F9FF; border-left:3px solid #3B82F6; color:#1E40AF; }
        /* Icon, text, actions */
        .ai-feedback-icon { flex-shrink:0; width:14px; opacity:0.7; margin-top:1px; }
        .ai-feedback-text { flex:1; min-width:0; }
        .ai-feedback-actions { display:flex; gap:4px; align-items:center; flex-shrink:0; }
        .ai-feedback-btn-apply {
            font-size:11px; padding:2px 8px; border-radius:4px;
            border:1px solid #F59E0B; background:transparent; color:#92400E;
            cursor:pointer; white-space:nowrap;
        }
        .ai-feedback-btn-apply:hover { background:rgba(245,158,11,0.1); }
        .ai-feedback-btn-close {
            width:18px; height:18px; border:none; background:transparent;
            cursor:pointer; font-size:14px; color:inherit; opacity:0.5;
            display:flex; align-items:center; justify-content:center; padding:0;
        }
        .ai-feedback-btn-close:hover { opacity:1; background:rgba(0,0,0,0.05); border-radius:3px; }
        /* Success micro-flash */
        @keyframes aiSuccessFlash {
            0% { background-color:transparent; }
            30% { background-color:rgba(75,96,80,0.06); }
            100% { background-color:transparent; }
        }
        .ai-success-flash { animation: aiSuccessFlash 600ms ease; }
        @keyframes aiFeedbackIn { from { opacity:0; transform:translateY(-4px); } to { opacity:1; transform:translateY(0); } }
        @media (prefers-reduced-motion:reduce) {
            .ai-feedback-banner, .ai-success-flash { animation:none; }
            .btn-ai-dot .ai-dot { animation:none; opacity:0.7; }
            .btn-ai-dot.ai-active .ai-dot { animation:none; opacity:1; }
            .btn-ai-dot.ai-done .ai-dot { animation:none; }
        }

        /* ── Audit drawer ── */
        .audit-drawer-overlay {
            display:none; position:fixed; inset:0; background:transparent;
            z-index:8600; pointer-events:none;
        }
        .audit-drawer-overlay.active { display:block; }
        .audit-drawer {
            position:fixed; top:0; right:-500px; width:480px; height:100%;
            background:rgba(255,255,255,0.92); backdrop-filter:blur(10px);
            -webkit-backdrop-filter:blur(10px);
            border-left:1px solid rgba(0,0,0,0.06);
            box-shadow:0 4px 24px rgba(0,0,0,0.08);
            z-index:8650; transition:right 0.3s cubic-bezier(0.4,0,0.2,1);
            display:flex; flex-direction:column; overflow:hidden;
        }
        .audit-drawer.active { right:0; }
        .audit-drawer-header {
            display:flex; align-items:center; gap:10px;
            padding:16px 20px; border-bottom:1px solid rgba(0,0,0,0.06);
            flex-shrink:0;
        }
        .audit-drawer-header h3 { font-size:14px; font-weight:600; margin:0; color:var(--sw-text); flex:1; }
        .audit-drawer-close {
            background:none; border:none; font-size:18px; cursor:pointer;
            color:var(--sw-muted); padding:2px 4px; border-radius:6px;
        }
        .audit-drawer-close:hover { color:var(--sw-text); }
        .audit-body {
            flex:1; overflow-y:auto; padding:16px 20px;
            overscroll-behavior:contain;
        }
        .audit-section { margin-bottom:16px; }
        .audit-section-header {
            display:flex; align-items:center; gap:8px; cursor:pointer;
            padding:8px 0; user-select:none;
        }
        .audit-section-header:hover { opacity:0.8; }
        .audit-section-dot {
            width:10px; height:10px; border-radius:50%; flex-shrink:0;
        }
        .audit-section-dot.critical { background:#ef4444; }
        .audit-section-dot.warning { background:#f59e0b; }
        .audit-section-dot.info { background:#22c55e; }
        .audit-section-title {
            font-size:13px; font-weight:600; color:var(--sw-text); flex:1;
        }
        .audit-section-count {
            font-size:11px; color:var(--sw-muted); background:#f1f5f9;
            padding:1px 7px; border-radius:10px;
        }
        .audit-section-chevron {
            font-size:12px; color:var(--sw-muted); transition:transform 0.15s;
        }
        .audit-section.collapsed .audit-section-chevron { transform:rotate(-90deg); }
        .audit-section.collapsed .audit-section-items { display:none; }
        .audit-item {
            display:flex; align-items:center; gap:8px;
            padding:6px 8px 6px 18px; cursor:pointer; border-radius:6px;
            font-size:12px; color:#475569; transition:background 0.1s;
        }
        .audit-item:hover { background:#f1f5f9; }
        .audit-item-code { font-family:monospace; color:#94a3b8; min-width:70px; font-size:11px; }
        .audit-item-desc { flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        .audit-item-detail { color:#94a3b8; font-size:11px; max-width:140px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        .audit-empty { padding:24px; text-align:center; color:#94a3b8; font-size:13px; }
        .audit-summary {
            padding:12px 16px; margin-bottom:12px; border-radius:8px;
            background:#f8fafc; border:1px solid #e2e8f0; font-size:12px; color:#475569;
            display:flex; gap:16px; flex-wrap:wrap;
        }
        .audit-summary-item { display:flex; align-items:center; gap:4px; }
        .audit-loading { padding:40px; text-align:center; color:#94a3b8; font-size:13px; }
        @media (max-width:600px) { .audit-drawer { width:100%; right:-100%; } }

        /* ── Approval buttons ── */
        .btn-approve-item {
            padding: 7px 18px; border-radius: 8px; border: none;
            background: var(--sw-navy, #0F1C2D); color: #fff;
            font-size: 13px; font-weight: 600; cursor: pointer;
            transition: opacity 150ms;
        }
        .btn-approve-item:hover { opacity: 0.85; }
        .btn-reject-item {
            padding: 7px 14px; border-radius: 8px;
            border: 1.5px solid #ef4444; background: transparent;
            color: #ef4444; font-size: 13px; font-weight: 600; cursor: pointer;
            transition: background 150ms, color 150ms;
        }
        .btn-reject-item:hover { background: #fef2f2; }

        /* ── AI dot button in modal header ── */
        .btn-ai-dot-header {
            width: 28px; height: 28px; border-radius: 50%;
            border: none; background: transparent; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: background 150ms; flex-shrink: 0;
        }
        .btn-ai-dot-header:hover { background: rgba(0,0,0,0.06); }
        .btn-ai-dot-header .ai-dot {
            width: 9px; height: 9px; border-radius: 50%;
            background: #0B1220; opacity: 0.45;
            animation: aiBreathe 3.5s ease-in-out infinite;
        }
        .btn-ai-dot-header.ai-active .ai-dot {
            animation: aiBreatheFast 1.2s ease-in-out infinite;
            opacity: 1;
        }

        /* ── AI Review chat overlay ── */
        .ai-review-overlay {
            position: fixed; top: 0; right: 0; bottom: 0; left: 0;
            background: rgba(0,0,0,0.3); z-index: 9010;
            display: flex; justify-content: flex-end;
            animation: arFadeIn 200ms ease;
        }
        @keyframes arFadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes arSlideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .ai-review-panel {
            width: 440px; max-width: 100%; height: 100%;
            background: #fff; display: flex; flex-direction: column;
            box-shadow: -4px 0 24px rgba(0,0,0,0.12);
            animation: arSlideIn 250ms ease;
        }
        .ai-review-header {
            padding: 16px 20px; display: flex;
            justify-content: space-between; align-items: center;
            border-bottom: 1px solid #e5e7eb; flex-shrink: 0;
        }
        .ai-review-header span { font-size: 15px; font-weight: 700; color: #0f172a; }
        .ai-review-close {
            width: 28px; height: 28px; border: none; background: transparent;
            cursor: pointer; font-size: 18px; color: #64748b; border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
        }
        .ai-review-close:hover { background: #f1f5f9; color: #0f172a; }
        .ai-review-messages {
            flex: 1; overflow-y: auto; padding: 16px 20px;
            display: flex; flex-direction: column; gap: 12px;
        }
        .ai-review-msg {
            max-width: 88%; padding: 10px 14px;
            border-radius: 10px; font-size: 13px; line-height: 1.55;
            word-wrap: break-word; white-space: pre-wrap;
            animation: ciMsgFadeIn 140ms ease-out both;
        }
        .ai-review-msg.user {
            align-self: flex-end; background: rgba(15,28,45,0.06); color: #1A1A2E;
        }
        .ai-review-msg.assistant {
            align-self: flex-start; background: #FFFFFF; color: #1e293b;
            box-shadow: 0 1px 2px rgba(0,0,0,0.04);
        }
        .ai-review-msg.assistant p { margin: 0 0 8px; }
        .ai-review-msg.assistant p:last-child { margin-bottom: 0; }
        .ai-review-msg.assistant strong { font-weight: 700; }
        .ai-review-msg.assistant ul, .ai-review-msg.assistant ol {
            margin: 4px 0 8px 18px; padding: 0;
        }
        .ai-review-msg.assistant li { margin-bottom: 2px; }
        .ai-review-msg.assistant code {
            background: rgba(0,0,0,0.06); padding: 1px 4px;
            border-radius: 3px; font-size: 12px;
        }
        .ai-review-msg.context {
            align-self: flex-start; background: transparent; color: rgba(0,0,0,0.4);
            font-size: 12px; padding: 4px 0; border-radius: 0;
            max-width: 100%;
        }
        .ai-review-typing {
            padding: 8px 20px; display: flex; gap: 4px; align-items: center;
        }
        .ai-review-typing .dot {
            width: 6px; height: 6px; border-radius: 50%;
            background: #94a3b8; animation: arTyping 1.4s infinite;
        }
        .ai-review-typing .dot:nth-child(2) { animation-delay: 0.2s; }
        .ai-review-typing .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes arTyping {
            0%, 60%, 100% { opacity: 0.3; transform: scale(0.8); }
            30% { opacity: 1; transform: scale(1); }
        }
        .ai-review-input-area {
            padding: 12px 16px; border-top: 1px solid #e5e7eb;
            display: flex; gap: 8px; align-items: flex-end; flex-shrink: 0;
        }
        .ai-review-input {
            flex: 1; resize: none; border: 1px solid #d1d5db;
            border-radius: 10px; padding: 8px 12px; font-family: inherit;
            font-size: 13px; line-height: 1.4; max-height: 120px;
            outline: none; transition: border-color 150ms;
        }
        .ai-review-input:focus { border-color: #0F1C2D; }
        .ai-review-send {
            width: 32px; height: 32px; border-radius: 50%;
            border: none; background: #0F1C2D; color: #fff;
            cursor: pointer; font-size: 16px; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
            transition: opacity 150ms;
        }
        .ai-review-send:hover { opacity: 0.85; }
        .ai-review-send:disabled { opacity: 0.4; cursor: default; }

        .comp-import-zone {
            border: 1.5px dashed #d1d5db; border-radius: 8px;
            padding: 10px 12px; margin-bottom: 10px; background: #fafbfc;
            transition: border-color 0.2s;
        }
        .comp-import-zone.drag-over { border-color: #0B1220; background: rgba(11,18,32,0.03); }
        .comp-import-textarea {
            width: 100%; border: none; background: transparent; font-family: inherit;
            font-size: 12px; resize: vertical; min-height: 36px; outline: none; color: #333;
            box-sizing: border-box;
        }
        .comp-import-thumbs { display: flex; gap: 4px; flex-wrap: wrap; }
        .comp-import-thumb {
            position: relative; width: 40px; height: 40px; border-radius: 4px;
            overflow: hidden; border: 1px solid #e0e0e0;
        }
        .comp-import-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .comp-import-thumb .comp-img-remove {
            position: absolute; top: -2px; right: -2px; width: 14px; height: 14px;
            border-radius: 50%; background: #333; color: #fff; border: none;
            font-size: 10px; line-height: 14px; text-align: center; cursor: pointer; padding: 0;
        }
        /* Import recap panel */
        .comp-import-recap { margin-top: 8px; font-size: 12px; color: #333; }
        .comp-import-recap .recap-header { font-weight: 600; margin-bottom: 6px; color: var(--sw-navy); }
        .comp-import-recap .recap-table { width: 100%; border-collapse: collapse; margin-bottom: 8px; }
        .comp-import-recap .recap-table th {
            text-align: left; font-size: 10px; font-weight: 600; color: #888;
            text-transform: uppercase; letter-spacing: 0.3px;
            padding: 3px 6px 3px 0; border-bottom: 1px solid #e5e7eb;
        }
        .comp-import-recap .recap-table td { padding: 4px 6px 4px 0; border-bottom: 1px solid #f0f0f0; font-size: 11px; }
        .comp-import-recap .recap-notes { font-size: 11px; color: #666; font-style: italic; margin-bottom: 8px; }
        .comp-import-recap .recap-warnings { font-size: 11px; color: #b45309; margin-bottom: 8px; }
        .comp-import-recap .recap-actions { display: flex; gap: 8px; }
        .comp-import-recap .recap-btn {
            padding: 5px 14px; border-radius: 6px; font-size: 11px; font-weight: 600;
            cursor: pointer; border: none; transition: background 0.15s;
        }
        .comp-import-recap .recap-btn-apply { background: var(--sw-navy, #0F1C2D); color: #fff; }
        .comp-import-recap .recap-btn-apply:hover { opacity: 0.85; }
        .comp-import-recap .recap-btn-cancel { background: #f1f5f9; color: #333; }
        .comp-import-recap .recap-btn-cancel:hover { background: #e2e8f0; }
        .cp-section-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--sw-navy);
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 1px solid #f0f0f0;
        }
        .cp-sub-title {
            font-size: 11px;
            font-weight: 600;
            color: #555;
            margin-bottom: 6px;
        }
        .cp-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .cp-table th {
            text-align: left;
            font-weight: 600;
            font-size: 11px;
            color: #888;
            padding: 4px 6px;
            border-bottom: 1px solid #e0e0e0;
        }
        .cp-table th:last-child {
            text-align: right;
        }
        .cp-table td {
            padding: 3px 6px;
        }
        .cp-table td:first-child {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 140px;
            font-size: 11px;
        }
        .cp-table input[type="number"] {
            width: 100%;
            padding: 4px 6px;
            border: 1px solid #e0e0e0;
            border-radius: 3px;
            font-size: 12px;
            text-align: right;
            font-family: inherit;
        }
        .cp-table input[type="number"]:focus {
            outline: none;
            border-color: var(--sw-navy);
        }
        .cp-table input[type="number"]:disabled {
            background: #f0f0f0;
            color: #999;
            cursor: not-allowed;
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textbox; }
        .cp-calculated {
            margin-top: 12px;
            padding: 10px 14px;
            background: #f8f8f4;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }
        .cp-calculated .cp-total-label {
            font-weight: 600;
            color: #555;
        }
        .cp-calculated .cp-total-value {
            font-weight: 700;
            font-size: 16px;
            color: var(--sw-navy);
        }
        .cp-calculated .cp-breakdown {
            font-size: 11px;
            color: #888;
            margin-left: 8px;
        }
        #cpLossOverride.has-override { border-color: #e67e22 !important; background: #fffaf0; }
        @media (max-width: 768px) {
            .composed-price-section {
                flex-direction: column;
            }
            .modal.modal-edit {
                max-width: 98vw;
            }
        }
        @media (max-width: 1200px) {
            .sandbox-split-container { flex-direction: column-reverse; max-height: 95vh; }
            .sandbox-panel { flex: 0 0 auto; max-height: 40vh; border-right: none; border-top: 1px solid #e0e0e0; }
            .sandbox-split-container .modal.modal-edit { flex: 1 1 auto; max-height: none; }
        }

        /* ═══ Composantes fournisseur ═══ */
        .comp-row {
            display: flex; gap: 6px; align-items: center; margin-bottom: 6px;
        }
        .comp-row input, .comp-row select {
            padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px;
            font-size: 13px; font-family: inherit;
        }
        .comp-row input:focus, .comp-row select:focus { border-color: var(--sw-navy); outline: none; }
        .comp-supplier-wrap {
            flex: 2; min-width: 0; position: relative;
        }
        .comp-supplier-wrap input {
            width: 100%; box-sizing: border-box;
        }
        .comp-supplier-dd {
            display: none; position: absolute; top: 100%; left: 0; right: 0;
            background: #fff; border: 1px solid #ddd; border-top: none; border-radius: 0 0 4px 4px;
            max-height: 200px; overflow-y: auto; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .comp-supplier-dd.open { display: block; }
        .comp-supplier-dd .comp-dd-item {
            padding: 7px 10px; cursor: pointer; font-size: 13px;
        }
        .comp-supplier-dd .comp-dd-item:hover { background: #f0f0f0; }
        .comp-supplier-dd .comp-dd-item.selected { background: #e8f0ea; font-weight: 600; }
        .comp-supplier-dd .comp-dd-add {
            padding: 7px 10px; cursor: pointer; font-size: 12px; color: var(--sw-navy);
            font-weight: 600; border-top: 1px solid #eee;
        }
        .comp-supplier-dd .comp-dd-add:hover { background: #f5f5f5; }
        /* Supplier subtitle in catalogue list */
        .item-supplier-sub { font-size: 11px; color: #aaa; margin-top: 2px; }
        /* Default star in catalogue list */
        .default-star {
            cursor: pointer; font-size: 15px; color: #ddd; user-select: none;
            transition: color 0.15s; vertical-align: middle;
        }
        .default-star.active { color: #F59E0B; }
        .default-star:hover { color: #F59E0B; }
        /* Default filter button in nav */
        .nav-filter-btn {
            padding: 3px 10px; border: 1px solid #ddd; border-radius: 12px;
            background: #fff; cursor: pointer; font-size: 13px; color: #888;
            margin-left: 8px; transition: all 0.15s;
        }
        .nav-filter-btn.active { background: #F59E0B; color: #fff; border-color: #F59E0B; }
        .nav-filter-btn:hover { border-color: #F59E0B; color: #F59E0B; }
        .nav-filter-btn.active:hover { background: #d4880a; }
        .comp-category { flex: 1.5; min-width: 0; }
        .comp-sku { flex: 1.2; min-width: 0; }
        .comp-desc { flex: 2.5; min-width: 0; }
        .comp-qty { width: 55px; flex: none; text-align: center; }
        .comp-cost { width: 80px; flex: none; text-align: right; }
        .comp-remove {
            flex: none; width: 28px; height: 28px; border: 1px solid #c62828;
            background: #fff; color: #c62828; border-radius: 4px; cursor: pointer;
            font-size: 14px; line-height: 1; display: flex; align-items: center; justify-content: center;
        }
        .comp-remove:hover { background: #c62828; color: #fff; }
        .comp-header {
            display: flex; gap: 6px; margin-bottom: 4px; padding: 0 0 4px;
            border-bottom: 1px solid #eee;
        }
        .comp-header span {
            font-size: 11px; font-weight: 600; color: #888; text-transform: uppercase; letter-spacing: 0.3px;
        }
        .btn-add-component {
            background: none; border: 1px dashed #bbb; color: #666; padding: 6px 14px;
            border-radius: 4px; cursor: pointer; font-size: 12px; margin-top: 4px;
        }
        .btn-add-component:hover { border-color: var(--sw-navy); color: var(--sw-navy); }
        /* Matériaux verrouillés par composantes */
        .cp-table td.cp-locked-cell { position: relative; }
        .cp-table td.cp-locked-cell input { background: #f0f0f0; color: #888; }
        .cp-table td.cp-locked-cell::after {
            content: 'auto'; position: absolute; right: 6px; top: 50%; transform: translateY(-50%);
            font-size: 9px; color: #aaa; font-weight: 600; text-transform: uppercase; pointer-events: none;
        }
        /* Stele confirm dialog */
        .stele-confirm-overlay {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.45);
            z-index: 9999; justify-content: center; align-items: center;
        }
        .stele-confirm-overlay.active { display: flex; }
        .stele-confirm-box {
            background: #fff; border-radius: 10px; box-shadow: 0 8px 32px rgba(0,0,0,0.25);
            max-width: 480px; width: 90%; overflow: hidden;
        }
        .stele-confirm-box h3 { padding: 18px 24px 0; font-size: 15px; font-weight: 700; color: var(--sw-text); margin: 0; }
        .stele-confirm-box .scb-body { padding: 12px 24px 20px; font-size: 14px; color: #444; }
        .stele-confirm-box .scb-amount { font-size: 22px; font-weight: 700; color: #c0392b; display: block; margin: 8px 0; }
        .stele-confirm-box .scb-footer { display: flex; justify-content: flex-end; gap: 8px; padding: 0 24px 18px; }
        .stele-confirm-box .scb-footer button {
            padding: 8px 20px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; border: 1px solid #ccc;
        }
        .scb-btn-cancel { background: #f5f5f5; color: #333; }
        .scb-btn-cancel:hover { background: #e8e8e8; }
        .scb-btn-ok { background: var(--sw-navy); color: #fff; border-color: var(--sw-navy) !important; }
        .scb-btn-ok:hover { opacity: 0.9; }

        /* ═══ Médias tagués ═══ */
        .cat-media-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--sw-navy);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f0f0f0;
        }

        .cat-dropzone {
            border: 2px dashed var(--sw-border);
            border-radius: 6px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s;
            font-size: 13px;
            color: #888;
            margin-bottom: 12px;
        }

        .cat-dropzone:hover,
        .cat-dropzone.dragover {
            border-color: var(--sw-navy);
            color: var(--sw-navy);
        }

        .cat-media-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .cat-media-item {
            display: flex;
            gap: 10px;
            padding: 10px;
            background: #f8f8f8;
            border-radius: 6px;
            align-items: flex-start;
        }

        .cat-media-item img {
            width: 80px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid var(--sw-border);
            flex-shrink: 0;
        }

        .cat-pdf-icon {
            width: 80px;
            height: 60px;
            background: #e8e8e8;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            color: #999;
            flex-shrink: 0;
        }

        .cat-media-info { flex: 1; min-width: 0; }

        .cat-media-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .cat-tag {
            display: inline-block;
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 12px;
            cursor: pointer;
            border: 1px solid var(--sw-border);
            background: #fff;
            color: #666;
            transition: all 0.15s;
            user-select: none;
        }

        .cat-tag.active {
            background: var(--sw-navy);
            color: #fff;
            border-color: var(--sw-navy);
        }

        .cat-media-remove {
            background: none;
            border: none;
            color: #c62828;
            cursor: pointer;
            font-size: 18px;
            padding: 0 4px;
            flex-shrink: 0;
            opacity: 0.5;
            transition: opacity 0.15s;
        }

        .cat-media-remove:hover { opacity: 1; }

        /* ═══ Crop Modal (même pattern que calculateur.html) ═══ */
        .crop-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.88); z-index: 3000;
            justify-content: center; align-items: center; flex-direction: column;
        }
        .crop-overlay.active { display: flex; }
        .crop-box {
            background: #fff; border-radius: 8px; overflow: hidden;
            width: 90vw; max-width: 800px; max-height: 90vh; display: flex; flex-direction: column;
        }
        .crop-header {
            padding: 14px 20px; font-weight: 700; font-size: 15px;
            border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between;
        }
        .crop-container { position: relative; flex: 1; min-height: 300px; max-height: 60vh; background: #222; overflow: hidden; }
        .crop-container img { display: block; max-width: 100%; }
        .crop-controls {
            padding: 12px 20px; display: flex; gap: 10px; align-items: center;
            border-top: 1px solid #eee; justify-content: space-between;
        }
        .crop-controls .crop-ratios { display: flex; gap: 6px; }
        .crop-controls .crop-ratio-btn {
            padding: 6px 16px; border: 2px solid #ccc; border-radius: 4px;
            background: #fff; cursor: pointer; font-size: 13px; font-weight: 600;
        }
        .crop-controls .crop-ratio-btn.active { border-color: var(--sw-navy); background: var(--sw-navy); color: #fff; }
        .crop-controls .crop-actions { display: flex; gap: 8px; }
        .crop-controls .crop-btn {
            padding: 8px 20px; border: none; border-radius: 4px;
            cursor: pointer; font-size: 13px; font-weight: 600;
        }
        .crop-btn-cancel { background: #eee; color: #555; }
        .crop-btn-confirm { background: var(--sw-navy); color: #fff; }
        .crop-btn-confirm:disabled { opacity: 0.5; cursor: not-allowed; }
        .crop-error { padding: 10px 20px; background: #fee; color: #c00; font-size: 13px; display: none; }

        .edit-toggle-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .edit-toggle {
            position: relative;
            display: inline-block;
            width: 38px;
            height: 22px;
        }

        .edit-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .edit-toggle .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #ddd;
            border-radius: 22px;
            transition: background 0.25s;
        }

        .edit-toggle .slider::before {
            content: '';
            position: absolute;
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background: #fff;
            border-radius: 50%;
            transition: transform 0.25s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.15);
        }

        .edit-toggle input:checked + .slider {
            background: var(--sw-navy);
        }

        .edit-toggle input:checked + .slider::before {
            transform: translateX(16px);
        }

        .edit-toggle-label {
            font-size: 13px;
            color: var(--sw-text);
        }

        .btn-sales-sheet {
            margin-left: auto;
            padding: 5px 12px;
            font-size: 12px;
            font-family: inherit;
            background: var(--sw-navy);
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .btn-sales-sheet:hover { background: #3d4f42; }

        .btn-delete-item {
            padding: 8px 14px;
            font-size: 13px;
            font-family: inherit;
            background: none;
            color: #c62828;
            border: 1px solid #c62828;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.15s, color 0.15s;
        }

        .btn-delete-item:hover {
            background: #c62828;
            color: #fff;
        }

        .edit-status {
            font-size: 13px;
            padding: 8px 12px;
            border-radius: 4px;
            margin-top: 8px;
            display: none;
        }

        .edit-status.success {
            display: block;
            background: #e8f5e9;
            color: #2e7d32;
        }

        .edit-status.error {
            display: block;
            background: #ffebee;
            color: #c62828;
        }


        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        /* ── Unsaved changes confirmation dialog ── */
        .unsaved-confirm-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.4);
            z-index: 100001; display: flex; align-items: center; justify-content: center;
            animation: ucFadeIn 0.12s ease;
        }
        @keyframes ucFadeIn { from { opacity: 0; } to { opacity: 1; } }
        .unsaved-confirm {
            background: #fff; border-radius: 12px; padding: 24px 28px;
            max-width: 380px; width: 90%; box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }
        .unsaved-confirm h3 { margin: 0 0 8px; font-size: 15px; font-weight: 700; color: #0f172a; }
        .unsaved-confirm p { margin: 0 0 20px; font-size: 13px; color: #475569; line-height: 1.5; }
        .unsaved-confirm-actions { display: flex; gap: 10px; justify-content: flex-end; }
        .unsaved-confirm-actions button {
            padding: 8px 16px; border-radius: 6px; font-size: 13px; font-weight: 600;
            cursor: pointer; border: none;
        }
        .uc-btn-stay { background: var(--sw-navy, #0F1C2D); color: #fff; }
        .uc-btn-stay:hover { opacity: 0.9; }
        .uc-btn-discard { background: #f1f5f9; color: #ef4444; }
        .uc-btn-discard:hover { background: #fee2e2; }

        .modal {
            background: var(--sw-surface);
            border-radius: 8px;
            width: 100%;
            max-width: 450px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--sw-border);
            display: flex; align-items: center; justify-content: space-between;
        }
        .modal-nav {
            display: flex; gap: 2px;
        }
        .modal-nav button {
            width: 32px; height: 32px; border-radius: 6px; border: 1px solid #ddd;
            background: #f8f8f8; cursor: pointer; font-size: 16px; color: #555;
            display: flex; align-items: center; justify-content: center; transition: all 0.15s;
        }
        .modal-nav button:hover:not(:disabled) { background: #eee; color: var(--sw-text); }
        .modal-nav button:disabled { opacity: 0.3; cursor: default; }

        .modal-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--sw-text);
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--sw-text);
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            font-size: 14px;
            font-family: inherit;
            border: 1px solid var(--sw-border);
            border-radius: 4px;
            background: var(--sw-surface);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--sw-navy);
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--sw-border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .btn-cancel {
            padding: 10px 20px;
            background: transparent;
            color: var(--sw-text);
            border: 1px solid var(--sw-border);
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-cancel:hover {
            background: var(--sw-border-2);
        }

        .btn-generate {
            padding: 10px 20px;
            background: var(--sw-navy);
            color: var(--sw-surface);
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-generate:hover {
            background: #3d4f42;
        }
        /* Global add button in nav */
        .nav-add-wrap { position: relative; display: inline-block; margin-left: 8px; }
        .nav-add-btn {
            width: 28px; height: 28px; border-radius: 50%; border: 1.5px solid #ddd;
            background: #fff; color: #555; font-size: 18px; line-height: 1; cursor: pointer;
            display: inline-flex; align-items: center; justify-content: center; transition: all 0.15s;
        }
        .nav-add-btn:hover { border-color: var(--sw-navy); color: var(--sw-navy); }
        .nav-add-dd {
            display: none; position: absolute; top: 100%; right: 0; margin-top: 6px;
            background: #fff; border: 1px solid #ddd; border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.12); min-width: 220px; z-index: 500;
            max-height: 320px; overflow-y: auto;
        }
        .nav-add-dd.open { display: block; }
        .nav-add-dd .add-dd-item {
            padding: 8px 14px; cursor: pointer; font-size: 13px;
        }
        .nav-add-dd .add-dd-item:hover { background: #f0f0f0; }
        .nav-add-dd .add-dd-sep {
            border-top: 1px solid #eee; margin: 4px 0;
        }
        .nav-add-dd .add-dd-input {
            padding: 8px 14px; display: flex; gap: 6px;
        }
        .nav-add-dd .add-dd-input input {
            flex: 1; padding: 6px 10px; border: 1px solid #ddd; border-radius: 6px;
            font-size: 13px; font-family: inherit;
        }
        .nav-add-dd .add-dd-input input:focus { outline: none; border-color: var(--sw-navy); }
        .nav-add-dd .add-dd-input button {
            padding: 6px 12px; background: var(--sw-navy); color: #fff; border: none;
            border-radius: 6px; font-size: 12px; cursor: pointer; white-space: nowrap;
        }

        /* ═══ Import Drawer (AI Chat) — Premium Redesign ═══ */

        @keyframes ciMsgFadeIn {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes ciCardStagger {
            from { opacity: 0; transform: translateY(3px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .ci-drawer-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: transparent; z-index: 8700; pointer-events: none;
        }
        .ci-drawer-overlay.active { display: block; }

        .ci-drawer {
            position: fixed; top: 0; right: -460px; width: 440px; height: 100%;
            background: rgba(255, 255, 255, 0.82);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border-left: 1px solid rgba(0, 0, 0, 0.06);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.06), inset 0 1px 0 rgba(255, 255, 255, 0.4);
            z-index: 8800; transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; flex-direction: column;
        }
        .ci-drawer.active { right: 0; }
        .ci-drawer:hover, .ci-drawer:focus-within {
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
        }

        .ci-drawer-header {
            display: flex; align-items: center; gap: 10px;
            padding: 16px 20px; border-bottom: 1px solid rgba(0, 0, 0, 0.06);
            background: transparent; flex-shrink: 0;
        }
        .ci-drawer-header h3 {
            font-size: 14px; font-weight: 600; margin: 0;
            color: var(--sw-text); flex: 1; letter-spacing: -0.01em;
        }
        .ci-drawer-close {
            background: none; border: none; font-size: 18px;
            cursor: pointer; color: var(--sw-muted); padding: 2px 4px;
            transition: color var(--sw-ease); border-radius: 6px;
        }
        .ci-drawer-close:hover { color: var(--sw-text); }

        .ci-messages {
            flex: 1; min-height: 0; overflow-y: auto; padding: 20px;
            display: flex; flex-direction: column; gap: 16px;
            overscroll-behavior: contain;
            scrollbar-width: thin; scrollbar-color: #e5e7eb transparent;
        }
        .ci-messages::before { content: ''; flex: 1 1 0; }
        .ci-messages::-webkit-scrollbar { width: 5px; }
        .ci-messages::-webkit-scrollbar-track { background: transparent; }
        .ci-messages::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 3px; }
        .ci-messages::-webkit-scrollbar-thumb:hover { background: #d1d5db; }
        .ci-messages:empty::after {
            content: 'Collez un screenshot Excel, tapez une liste de prix, ou d\e9 crivez les articles \e0 importer.';
            color: #9ca3af; font-size: 13px; text-align: center; padding: 40px 24px;
            line-height: 1.6;
        }

        .ci-msg {
            max-width: 85%; padding: 0; border-radius: 0;
            font-size: 14px; line-height: 1.5; word-wrap: break-word;
            color: #1A1A2E;
            animation: ciMsgFadeIn 140ms ease-out both;
        }
        .ci-msg p { margin: 0 0 8px 0; }
        .ci-msg p:last-child { margin-bottom: 0; }
        .ci-msg ul, .ci-msg ol { margin: 6px 0; padding-left: 20px; }
        .ci-msg li { margin-bottom: 4px; }
        .ci-msg strong { font-weight: 600; }
        .ci-msg code {
            background: #f3f4f6; padding: 2px 6px; border-radius: 4px;
            font-size: 13px; font-family: 'SF Mono', 'Cascadia Code', 'Consolas', monospace;
        }
        .ci-msg pre {
            background: #f8f9fa; padding: 12px 14px; border-radius: 8px;
            overflow-x: auto; font-size: 12px; margin: 8px 0;
            font-family: 'SF Mono', 'Cascadia Code', 'Consolas', monospace;
            line-height: 1.5;
        }

        /* Cards — replace tables */
        .ci-msg .ci-card-stack { display: flex; flex-direction: column; gap: 6px; margin: 10px 0; }
        .ci-msg .ci-card {
            background: #F8FAFC; border-radius: 10px; padding: 12px 14px;
            animation: ciCardStagger 180ms ease-out both;
        }
        .ci-msg .ci-card-row {
            display: flex; justify-content: space-between; align-items: baseline;
        }
        .ci-msg .ci-card-code {
            font-size: 12px; font-weight: 600; color: #6B7280;
            font-family: 'SF Mono', 'Cascadia Code', 'Consolas', monospace;
            letter-spacing: 0.02em;
        }
        .ci-msg .ci-card-price {
            font-size: 13px; font-weight: 600; color: #1A1A2E;
            font-family: 'SF Mono', 'Cascadia Code', 'Consolas', monospace;
        }
        .ci-msg .ci-card-desc {
            font-size: 13px; color: #374151; margin-top: 2px; line-height: 1.4;
        }
        .ci-msg .ci-card-meta {
            font-size: 11px; color: #9ca3af; margin-top: 4px;
        }

        /* Legacy table fallback — soft styling */
        .ci-msg table {
            width: 100%; border-collapse: separate; border-spacing: 0;
            margin: 8px 0; font-size: 13px; border-radius: 8px;
            overflow: hidden; background: #F8FAFC;
        }
        .ci-msg th, .ci-msg td {
            padding: 8px 12px; border: none; text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }
        .ci-msg th {
            background: #f1f5f9; font-weight: 600; font-size: 11px;
            color: #6B7280; text-transform: uppercase; letter-spacing: 0.04em;
        }
        .ci-msg tr:last-child td { border-bottom: none; }

        .ci-msg-user {
            align-self: flex-end; background: rgba(15,28,45,0.06);
            padding: 10px 14px; border-radius: 10px;
        }
        .ci-msg-assistant {
            align-self: flex-start; background: #FFFFFF;
            padding: 10px 14px; border-radius: 10px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.04);
        }

        .ci-msg-confirm {
            align-self: flex-start; background: #fff; border: none;
            border-radius: 12px; padding: 14px 16px; max-width: 92%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 0 0 1px rgba(0,0,0,0.04);
        }
        .ci-msg-confirm .ci-confirm-text {
            font-size: 14px; color: #1A1A2E; margin-bottom: 12px; line-height: 1.5;
        }
        .ci-confirm-actions { display: flex; gap: 8px; align-items: center; }
        .ci-confirm-actions button {
            padding: 8px 18px; border-radius: 8px; font-size: 13px; font-weight: 600;
            cursor: pointer; border: none; transition: all 0.15s;
        }
        .btn-ci-apply { background: var(--sw-navy); color: #fff; }
        .btn-ci-apply:hover { background: var(--sw-navy-hover); }
        .btn-ci-dismiss { background: transparent; color: var(--sw-text-2); padding: 8px 12px; }
        .btn-ci-dismiss:hover { color: var(--sw-text); }
        .ci-confirm-applied { font-size: 12px; color: var(--sw-navy); font-weight: 500; }

        .ci-typing {
            padding: 10px 20px; display: none;
        }
        .ci-typing.active { display: flex; gap: 6px; align-items: center; }
        .ci-typing-dot {
            width: 8px; height: 8px; border-radius: 50%; background: var(--sw-navy);
            animation: ciTypingBounce 1.4s ease-in-out infinite;
        }
        .ci-typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .ci-typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes ciTypingBounce {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.25; }
            30% { transform: translateY(-4px); opacity: 0.9; }
        }

        .ci-quick-actions {
            display: flex; gap: 6px; padding: 10px 20px; flex-wrap: wrap;
            border-top: 1px solid #f5f5f5; flex-shrink: 0;
        }
        .ci-quick-btn {
            padding: 6px 12px; border-radius: 8px; font-size: 12px;
            background: #fff; border: 1px solid #e5e7eb; color: #6B7280;
            cursor: pointer; transition: all 0.15s; white-space: nowrap;
            font-weight: 500;
        }
        .ci-quick-btn:hover { background: #f9fafb; border-color: #d1d5db; color: #374151; }

        .ci-input-area {
            display: flex; gap: 8px; padding: 12px 16px 14px;
            border-top: 1px solid #f0f0f0;
            background: #fff; flex-shrink: 0; align-items: flex-end;
        }
        .ci-input-area textarea {
            flex: 1; resize: none; border: 1px solid #e5e7eb; border-radius: 10px;
            padding: 10px 14px; font-size: 14px; font-family: inherit; line-height: 1.4;
            max-height: 120px; min-height: 40px; outline: none;
            transition: border-color 0.15s; background: #fafbfc;
            color: #1A1A2E;
        }
        .ci-input-area textarea:focus { border-color: #d1d5db; background: #fff; }
        .ci-input-area textarea::placeholder { color: #9ca3af; }

        .ci-send-btn {
            width: 36px; height: 36px; border-radius: var(--sw-radius-input); border: none;
            background: var(--sw-navy); color: #fff; font-size: 16px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: background var(--sw-ease); flex-shrink: 0;
        }
        .ci-send-btn:hover { background: var(--sw-navy-hover); }
        .ci-send-btn:disabled { background: var(--sw-border); color: var(--sw-muted); cursor: default; }

        .ci-drop-zone {
            display: none; position: absolute; inset: 0; background: rgba(11,18,32,0.04);
            border: 2px dashed #d1d5db; border-radius: 10px;
            z-index: 10; align-items: center; justify-content: center;
            font-size: 13px; color: #6B7280; font-weight: 500;
        }
        .ci-drop-zone.active { display: flex; }

        .ci-img-preview {
            display: flex; gap: 6px; padding: 6px 20px; flex-wrap: wrap; flex-shrink: 0;
        }
        .ci-img-preview:empty { display: none; }
        .ci-img-thumb {
            position: relative; width: 52px; height: 52px; border-radius: 8px;
            overflow: hidden; border: 1px solid #e5e7eb;
        }
        .ci-img-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .ci-img-thumb .ci-img-remove {
            position: absolute; top: 2px; right: 2px; width: 18px; height: 18px;
            border-radius: 50%; background: rgba(0,0,0,0.5); color: #fff;
            border: none; font-size: 11px; cursor: pointer; display: flex;
            align-items: center; justify-content: center; line-height: 1;
            transition: background 0.15s;
        }
        .ci-img-thumb .ci-img-remove:hover { background: rgba(0,0,0,0.7); }
        /* ═══ Pending badge ═══ */
        .item-pending-badge {
            font-size: 10px; font-weight: 600; padding: 2px 8px;
            border-radius: 10px; background: #FFF3E0; color: #E65100;
            margin-left: 8px; text-transform: uppercase;
            cursor: pointer; transition: background 0.15s;
        }
        .item-pending-badge:hover { background: #E8F5E9; color: #2E7D32; }
        .item-type-badge {
            display: inline-block; font-size: 9px; font-weight: 600;
            text-transform: uppercase; letter-spacing: 0.5px;
            padding: 1px 5px; border-radius: 3px; margin-left: 6px;
            vertical-align: middle;
        }
        .item-type-badge.fab { background: #EEF2FF; color: #4338CA; }
        .item-type-badge.mat { background: #FEF3C7; color: #92400E; }
        .cat-filter-btn {
            font-size: 10px; font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.5px; padding: 3px 10px;
            border: 1px solid #e0e0e0; border-radius: 4px;
            background: #fff; color: #888; cursor: pointer;
            transition: all 0.15s ease;
        }
        .cat-filter-btn:hover { border-color: #999; color: #555; }
        .cat-filter-btn.active { background: var(--stele-black); color: #fff; border-color: var(--stele-black); }
        .nav-filter-btn.pending-active { background: #E65100; color: #fff; }
        /* ai-assistant-btn: styles in scopewright-tokens.css */
        .ai-assistant-btn {
            vertical-align: middle;
        }
        @media (max-width: 600px) {
            .ci-drawer { width: 100%; right: -100%; }
        }
        @media (prefers-reduced-motion: reduce) {
            .ci-drawer, .ci-drawer:hover, .ci-drawer:focus-within {
                transition: none; backdrop-filter: none; -webkit-backdrop-filter: none;
                background: #fff;
            }
        }

    </style>
</head>
<body>

    <!-- Navigation (web only) -->
    <nav class="nav-bar no-print">
        <span class="nav-logo">scopewright</span>
        <a href="app.html" class="nav-back">&larr; Menu</a>
        <div class="nav-links" id="navLinks">
            <button class="nav-filter-btn" id="filterDefaultBtn" onclick="toggleDefaultFilter()" title="Afficher seulement les articles par d&eacute;faut">&#9733; D&eacute;faut</button>
            <button class="nav-filter-btn" id="filterPendingBtn" style="display:none;" onclick="togglePendingFilter()">&#9679; En attente</button>
            <div class="nav-add-wrap" id="navAddWrap" style="display:none;">
                <button class="nav-add-btn" onclick="toggleAddDropdown()" title="Ajouter un article">+</button>
                <div class="nav-add-dd" id="navAddDd"></div>
            </div>
        </div>
        <div class="nav-right">
            <button class="ai-assistant-btn" id="navImportBtn" style="display:none;" title="Assistant Scopewright" onclick="toggleImportDrawer()"></button>
            <div class="data-status" id="dataStatus">
                <span class="status-dot"></span>
                <span class="status-text" id="statusText">Chargement...</span>
            </div>
        </div>
    </nav>

    <!-- Barre de recherche -->
    <div class="catalogue-search-bar no-print" id="catalogueSearchBar">
        <input type="text" id="catalogueSearchInput" placeholder="Rechercher un article (code, description, cat&#233;gorie...)" oninput="filterCatalogueSearch()">
    </div>
    <div class="ai-filter-badge no-print" id="aiFilterBadge" style="display:none;" onclick="resetAiFilter()">Filtre AI actif &mdash; Tout afficher</div>

    <!-- Titre + dropdown catégorie + table unique -->
    <div class="catalogue-header-bar no-print">
        <h2 class="catalogue-title">Catalogue</h2>
        <button class="cat-filter-btn" id="filterFabBtn" onclick="toggleItemTypeFilter('fabrication')">Fab</button>
        <button class="cat-filter-btn" id="filterMatBtn" onclick="toggleItemTypeFilter('materiau')">Mat</button>
        <div class="catalogue-cat-dropdown" id="catDropdownTrigger" onclick="openCatDropdown(event)">
            <span id="catDropdownLabel">Toutes les cat&eacute;gories</span>
            <span class="cat-dd-chevron">&#9662;</span>
        </div>
        <div style="flex:1;"></div>
        <button class="cat-filter-btn" id="auditBtn" onclick="openAuditDrawer()" title="Auditer le catalogue">Auditer</button>
    </div>
    <table class="price-table" id="mainCatalogueTable"></table>


    <!-- Modal Édition catalogue -->
    <div class="modal-overlay" id="editModal">
        <div class="modal modal-edit">
            <div class="modal-progress" id="editModalProgress">
                <div class="modal-progress-bar" id="editModalProgressBar"></div>
            </div>
            <div class="modal-header">
                <h3 class="modal-title">Modifier l'article</h3>
                <div style="display:flex;align-items:center;gap:8px;">
                    <button class="btn-ai-dot-header" id="catAiReviewBtn" style="display:none;" onclick="openCatAiReviewChat()" title="R&eacute;vision AI">
                        <span class="ai-dot"></span>
                    </button>
                    <div class="modal-nav">
                        <button id="btnPrevItem" onclick="navigateItem(-1)" title="Article pr&eacute;c&eacute;dent">&#8249;</button>
                        <button id="btnNextItem" onclick="navigateItem(1)" title="Article suivant">&#8250;</button>
                    </div>
                </div>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editItemId">
                <div class="edit-row">
                    <div class="form-group">
                        <label class="form-label">Code</label>
                        <input type="text" class="form-input" id="editCode" readonly style="background:#f5f5f5; color:#888;">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Cat&eacute;gorie</label>
                        <select class="form-input" id="editCategory"></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Classification</label>
                        <select class="form-input" id="editItemType" onchange="document.getElementById('dimsConfigGroup').style.display=this.value==='fabrication'?'':'none'">
                            <option value="">&mdash; Non class&eacute; &mdash;</option>
                            <option value="fabrication">Fabrication</option>
                            <option value="materiau">Mat&eacute;riau</option>
                        </select>
                    </div>
                    <div class="form-group" id="dimsConfigGroup" style="display:none;">
                        <label class="form-label">Dimensions applicables</label>
                        <div style="display:flex; gap:16px; padding:6px 0;">
                            <label style="display:flex; align-items:center; gap:4px; cursor:pointer; font-size:12px;">
                                <input type="checkbox" id="editDimL" checked> L
                            </label>
                            <label style="display:flex; align-items:center; gap:4px; cursor:pointer; font-size:12px;">
                                <input type="checkbox" id="editDimH" checked> H
                            </label>
                            <label style="display:flex; align-items:center; gap:4px; cursor:pointer; font-size:12px;">
                                <input type="checkbox" id="editDimP" checked> P
                            </label>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <input type="text" class="form-input" id="editDescription">
                </div>
                <div class="edit-row">
                    <div class="form-group">
                        <label class="form-label">Type</label>
                        <select class="form-input" id="editType"></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Prix</label>
                        <input type="hidden" id="editPrice">
                        <div class="form-input" id="editPriceDisplay" style="background:#f5f5f5; color:#888; min-height:38px; display:flex; align-items:center;">Calculé automatiquement</div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Instruction</label>
                    <textarea class="form-input" id="editInstruction" rows="2" style="resize:vertical;"></textarea>
                </div>
                <!-- Proposal context (non-admin proposers + approvers) -->
                <div class="form-group" id="proposalContextGroup" style="display:none;">
                    <label class="form-label">Contraintes ou conditions d'utilisation</label>
                    <textarea class="form-input" id="editPropConstraints" rows="2"
                        placeholder="ex: Doit &ecirc;tre install&eacute; sur un mur porteur..."
                        style="resize:vertical;"></textarea>
                    <label class="form-label" style="margin-top:10px;">Notes pour l'approbateur</label>
                    <textarea class="form-input" id="editPropNotes" rows="2"
                        placeholder="Informations suppl&eacute;mentaires..."
                        style="resize:vertical;"></textarea>
                </div>
                <!-- Présentation client (admin only) -->
                <div class="form-group" id="clientTextGroup" style="display:none;">
                    <div class="cp-section-title">Pr&eacute;sentation client</div>
                    <label class="form-label" style="margin-top:8px;">Texte</label>
                    <div class="ai-feedback-container" id="clientTextFeedback"></div>
                    <div class="ai-field-wrap">
                        <input type="text" class="form-input" id="editClientText" placeholder="Ex: placage de ch&ecirc;ne blanc FC">
                        <button class="btn-ai-dot" id="btnAiClientText" onclick="aiCatalogueClientText()" title="Corriger / reformuler avec l'AI">
                            <span class="ai-dot"></span>
                        </button>
                    </div>
                </div>
                <!-- Template hint banner (admin only) -->
                <div class="template-hint" id="templateHintBanner" style="display:none;">
                    <span class="template-hint-icon">&#8505;</span>
                    <div class="template-hint-content">
                        <strong>R&egrave;gles de base actives</strong>
                        <div class="template-hint-text" id="templateHintText"></div>
                    </div>
                    <a href="admin.html" target="_blank" class="template-hint-link">Modifier</a>
                </div>
                <!-- Comment décrire au client (admin only) -->
                <div class="form-group" id="presRuleGroup" style="display:none;">
                    <div class="cp-section-title">Comment d&eacute;crire au client</div>
                    <label class="form-label" style="margin-top:8px;">Explication</label>
                    <div class="ai-feedback-container" id="presRuleFeedback"></div>
                    <div class="ai-field-wrap">
                        <textarea class="form-input" id="editPresRuleHuman" rows="3" style="resize:vertical;" placeholder="Ex: Le mat&eacute;riau appara&icirc;t en premier avec le pr&eacute;fixe 'en'. Ne pas mentionner les pattes ni la bande de chant au client."></textarea>
                        <button class="btn-ai-dot" id="btnAiExplication" onclick="aiCatalogueExplication()" title="Clarifier / structurer l'explication avec l'AI">
                            <span class="ai-dot"></span>
                        </button>
                    </div>
                    <label class="form-label" style="margin-top:8px;">JSON</label>
                    <textarea class="form-input calc-rule-json" id="editPresRuleAi" rows="6" style="resize:vertical;" placeholder="JSON structur&eacute; pour l'AI..."></textarea>
                </div>
                <!-- Instructions AI (admin only) -->
                <div class="form-group" id="calcRuleGroup" style="display:none;">
                    <div class="cp-section-title">Instructions AI</div>
                    <label class="form-label" style="margin-top:8px;">Explication</label>
                    <div class="ai-feedback-container" id="calcRuleFeedback"></div>
                    <div class="ai-field-wrap">
                        <textarea class="form-input" id="editCalcRuleHuman" rows="3" style="resize:vertical;" placeholder="Ex: Caisson au sol &mdash; ajouter 4 pattes. Demander largeur, profondeur, hauteur. Utiliser le mat&eacute;riau int&eacute;rieur des mat&eacute;riaux par d&eacute;faut." oninput="updateGenerateRuleBtn()"></textarea>
                        <button class="btn-ai-dot" id="btnAiCalcRule" onclick="aiCalcRuleGenerate()" title="Reformuler l'explication et g&eacute;n&eacute;rer le JSON">
                            <span class="ai-dot"></span>
                        </button>
                    </div>
                    <label class="form-label" style="margin-top:8px;">JSON</label>
                    <textarea class="form-input calc-rule-json" id="editCalcRuleAi" rows="6" style="resize:vertical;" placeholder="Instructions structur&eacute;es pour l'AI..."></textarea>
                </div>
                <!-- Composantes fournisseur -->
                <div class="form-group" id="componentsGroup">
                    <div class="cp-section-title">Composantes fournisseur</div>
                    <div class="ai-feedback-container" id="importCompFeedback"></div>
                    <div class="comp-import-zone ai-field-wrap" id="compImportZone">
                        <textarea class="comp-import-textarea" id="compImportInput"
                            placeholder="Coller un screenshot de liste de prix, glisser une image, ou taper les donn&eacute;es en vrac..."
                            rows="2"></textarea>
                        <button class="btn-ai-dot" id="btnAiImportComp" onclick="aiImportComponents()" title="Extraire les composantes avec l'AI">
                            <span class="ai-dot"></span>
                        </button>
                        <div class="comp-import-thumbs" id="compImportThumbs" style="padding-top:4px;"></div>
                        <div class="comp-import-recap" id="compImportRecap" style="display:none;"></div>
                    </div>
                    <div id="componentsList"></div>
                    <button type="button" class="btn-add-component" onclick="addComponent()">+ Ajouter une composante</button>
                </div>
                <!-- Prix composé — Minutes & Matériaux -->
                <div class="form-group" id="composedPriceGroup">
                    <div class="cp-section-title">Prix compos&eacute;</div>
                    <div id="cpLossOverrideWrap" style="margin:6px 0 10px; display:flex; align-items:center; gap:8px;">
                        <label style="font-size:11px; font-weight:600; color:#555; white-space:nowrap;">Perte (%)</label>
                        <input type="number" step="0.1" min="0" max="100" id="cpLossOverride"
                            style="width:70px; padding:4px 6px; border:1px solid #e0e0e0; border-radius:3px; font-size:12px; text-align:right; font-family:inherit;"
                            oninput="onLossOverrideChange()" placeholder="">
                        <span id="cpLossOverrideHint" style="font-size:10px; color:#999;"></span>
                    </div>
                    <div class="composed-price-section">
                        <div class="cp-table-wrap">
                            <div class="cp-sub-title">Minutes main-d'&oelig;uvre</div>
                            <table class="cp-table">
                                <thead><tr><th>D&eacute;partement</th><th style="width:70px">Min.</th></tr></thead>
                                <tbody id="cpMinutesBody"></tbody>
                            </table>
                        </div>
                        <div class="cp-table-wrap">
                            <div class="cp-sub-title">Mat&eacute;riaux</div>
                            <table class="cp-table">
                                <thead><tr><th>Cat&eacute;gorie</th><th style="width:80px">Co&ucirc;t ($)</th></tr></thead>
                                <tbody id="cpMaterialsBody"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="cp-calculated">
                        <div>
                            <span class="cp-total-label">Prix calcul&eacute;</span>
                            <span class="cp-breakdown" id="cpBreakdown"></span>
                        </div>
                        <span class="cp-total-value" id="cpTotalValue">—</span>
                    </div>
                </div>

                <div class="form-group">
                    <div class="cat-media-title">M&eacute;dias</div>
                    <div class="cat-dropzone" id="catDropzone">
                        Cliquer ou glisser des images / PDFs ici
                    </div>
                    <input type="file" id="catMediaInput" accept="image/*,.pdf,application/pdf" multiple style="display:none;">
                    <div class="cat-media-list" id="catMediaList"></div>
                </div>
                <div class="form-group" style="margin-bottom:0;">
                    <div class="edit-toggle-row">
                        <label class="edit-toggle">
                            <input type="checkbox" id="editInCalculator" checked>
                            <span class="slider"></span>
                        </label>
                        <span class="edit-toggle-label">Visible dans le calculateur</span>
                    </div>
                    <div class="edit-toggle-row" style="margin-top: 12px;">
                        <label class="edit-toggle">
                            <input type="checkbox" id="editIsDefault">
                            <span class="slider"></span>
                        </label>
                        <span class="edit-toggle-label">Article par d&eacute;faut &#9733;</span>
                    </div>
                    <div class="edit-toggle-row" style="margin-top: 12px;">
                        <label class="edit-toggle">
                            <input type="checkbox" id="editHasSalesSheet" onchange="toggleSalesSheetBtn()">
                            <span class="slider"></span>
                        </label>
                        <span class="edit-toggle-label">Ce produit a une fiche de vente</span>
                        <button class="btn-sales-sheet" id="btnSalesSheet" style="display:none;" onclick="openSalesSheet()">Ouvrir la fiche</button>
                    </div>
                </div>
                <div class="edit-status" id="editStatus"></div>
            </div>
            <div class="ai-feedback-container" id="saveValidationFeedback" style="padding:0 24px;"></div>
            <div class="modal-footer" style="justify-content: space-between;">
                <div style="display: flex; gap: 8px;">
                    <button class="btn-delete-item" onclick="deleteItem()">Supprimer</button>
                </div>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <span class="modal-proposed-by" id="editProposedBy" style="display:none; font-size:11px; color:#64748b;"></span>
                    <button class="btn-reject-item" id="btnRejectItem" style="display:none;" onclick="rejectItemFromCatalogue()">Rejeter</button>
                    <button class="btn-cancel" onclick="guardedCloseEditModal()">Annuler</button>
                    <button class="btn-approve-item" id="btnApproveItem" style="display:none;" onclick="approveItemFromCatalogue()">Approuver</button>
                    <button class="btn-generate" id="btnEditSave" onclick="saveEditModal()">Sauvegarder</button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Review Chat Overlay (catalogue) -->
    <div class="ai-review-overlay" id="catAiReviewOverlay" style="display:none">
        <div class="ai-review-panel">
            <div class="ai-review-header">
                <span>R&eacute;vision AI</span>
                <button class="ai-review-close" onclick="closeCatAiReviewChat()">&times;</button>
            </div>
            <div class="ai-review-messages" id="catAiReviewMessages"></div>
            <div class="ai-review-typing" id="catAiReviewTyping" style="display:none">
                <span class="dot"></span><span class="dot"></span><span class="dot"></span>
            </div>
            <div class="ai-review-input-area">
                <textarea class="ai-review-input" id="catAiReviewInput" placeholder="Poser une question..." rows="1"></textarea>
                <button class="ai-review-send" id="catAiReviewSendBtn" onclick="sendCatAiReviewMessage()" title="Envoyer">&#8593;</button>
            </div>
        </div>
    </div>

    <!-- Stele confirm dialog -->
    <div class="stele-confirm-overlay" id="steleConfirmOverlay">
        <div class="stele-confirm-box">
            <h3 id="steleConfirmTitle">Confirmation</h3>
            <div class="scb-body" id="steleConfirmBody"></div>
            <div class="scb-footer">
                <button class="scb-btn-cancel" id="steleConfirmCancel">Annuler</button>
                <button class="scb-btn-ok" id="steleConfirmOk">Confirmer</button>
            </div>
        </div>
    </div>

    <!-- Supplier Modal -->
    <div class="modal-overlay" id="supplierModal" style="z-index:1100;" onclick="if(event.target===this)closeSupplierModal()">
        <div class="modal" style="max-width:480px;">
            <div class="modal-header"><h2 id="supplierModalTitle">Nouveau fournisseur</h2></div>
            <div class="modal-body" style="max-height:60vh; overflow-y:auto;">
                <div class="form-group">
                    <label class="form-label">Nom *</label>
                    <input class="form-input" id="supName" placeholder="Nom de l'entreprise">
                </div>
                <div class="form-group">
                    <label class="form-label">Adresse</label>
                    <input class="form-input" id="supAddress" placeholder="Adresse">
                </div>
                <div class="form-group" style="display:flex;gap:10px;">
                    <div style="flex:1;">
                        <label class="form-label">T&eacute;l&eacute;phone</label>
                        <input class="form-input" id="supPhone" placeholder="T&eacute;l&eacute;phone">
                    </div>
                    <div style="flex:1;">
                        <label class="form-label">Email</label>
                        <input class="form-input" id="supEmail" placeholder="Email" type="email">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Site web</label>
                    <input class="form-input" id="supWebsite" placeholder="https://...">
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-input" id="supNotes" rows="2" style="resize:vertical;" placeholder="Notes..."></textarea>
                </div>
                <div class="edit-status" id="supplierModalStatus"></div>
            </div>
            <div class="modal-footer" style="justify-content:flex-end;">
                <button class="btn-cancel" onclick="closeSupplierModal()">Annuler</button>
                <button class="btn-generate" onclick="saveNewSupplier()">Cr&eacute;er le fournisseur</button>
            </div>
        </div>
    </div>

    <!-- Crop Modal (même pattern que calculateur.html) -->
    <div class="crop-overlay" id="cropModal">
        <div class="crop-box">
            <div class="crop-header">
                <span>Cadrer l'image</span>
                <span id="cropDimensions" style="font-weight:400; font-size:12px; color:#888;"></span>
            </div>
            <div class="crop-error" id="cropError"></div>
            <div class="crop-container" id="cropContainer">
                <img id="cropImage" src="">
            </div>
            <div class="crop-controls">
                <div class="crop-ratios">
                    <button class="crop-ratio-btn active" id="cropRatio169" onclick="setCropRatio('16:9')">16:9</button>
                    <button class="crop-ratio-btn" id="cropRatio916" onclick="setCropRatio('9:16')">9:16</button>
                    <button class="crop-ratio-btn" id="cropRatio11" onclick="setCropRatio('1:1')">1:1</button>
                </div>
                <div class="crop-actions">
                    <button class="crop-btn crop-btn-cancel" onclick="cancelCrop()">Annuler</button>
                    <button class="crop-btn crop-btn-confirm" id="cropConfirmBtn" onclick="confirmCrop()">Valider</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ═══════════════════════════════════════════════════════════════════════
        // GÉNÉRATION AUTOMATIQUE DES TABLEAUX À PARTIR DE CATALOGUE_DATA
        // ═══════════════════════════════════════════════════════════════════════

        // Permissions (chargées depuis Supabase)
        let canEditCatalogue = false;
        let canEditMinutes = false;
        let canEditMaterials = false;
        let isAdmin = false;
        let canApproveItems = false;

        // Données de base (chargées depuis app_config)
        let tauxHoraires = [];
        let expenseCategories = [];

        // ── Stele Confirm Dialog ──
        var _steleConfirmResolve = null;
        function steleConfirm(bodyHtml, title, okLabel) {
            return new Promise(function(resolve) {
                _steleConfirmResolve = resolve;
                document.getElementById('steleConfirmTitle').textContent = title || 'Confirmation';
                document.getElementById('steleConfirmBody').innerHTML = bodyHtml;
                document.getElementById('steleConfirmOk').textContent = okLabel || 'Confirmer';
                document.getElementById('steleConfirmOverlay').classList.add('active');
            });
        }
        document.addEventListener('click', function(e) {
            if (e.target.id === 'steleConfirmCancel' || e.target.id === 'steleConfirmOverlay') {
                document.getElementById('steleConfirmOverlay').classList.remove('active');
                if (_steleConfirmResolve) { var fn = _steleConfirmResolve; _steleConfirmResolve = null; fn(false); }
            }
            if (e.target.id === 'steleConfirmOk') {
                document.getElementById('steleConfirmOverlay').classList.remove('active');
                if (_steleConfirmResolve) { var fn = _steleConfirmResolve; _steleConfirmResolve = null; fn(true); }
            }
        });

        // ── Crop Modal (même pattern que calculateur.html) ──
        var cropperLoaded = false;
        var currentCropper = null;
        var cropState = {}; // { originalBlob, ratio, _resolve }

        function loadCropperLib() {
            if (cropperLoaded) return Promise.resolve();
            return new Promise(function(resolve, reject) {
                var link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = 'https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.css';
                document.head.appendChild(link);
                var script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.js';
                script.onload = function() { cropperLoaded = true; resolve(); };
                script.onerror = function() { reject(new Error('Cropper.js failed to load')); };
                document.head.appendChild(script);
            });
        }

        function openCropModal(imageBlob) {
            cropState.originalBlob = imageBlob;
            cropState.ratio = '16:9';
            var url = URL.createObjectURL(imageBlob);
            var imgEl = document.getElementById('cropImage');
            var modal = document.getElementById('cropModal');
            var errEl = document.getElementById('cropError');
            errEl.style.display = 'none';

            var testImg = new Image();
            testImg.onload = async function() {
                document.getElementById('cropDimensions').textContent = testImg.width + ' \u00d7 ' + testImg.height + ' px';

                if (testImg.width < 800 || testImg.height < 600) {
                    errEl.textContent = 'Image trop petite (minimum 800\u00d7600). Celle-ci fait ' + testImg.width + '\u00d7' + testImg.height + '.';
                    errEl.style.display = 'block';
                    imgEl.src = url;
                    modal.classList.add('active');
                    document.getElementById('cropConfirmBtn').disabled = true;
                    return;
                }

                document.getElementById('cropConfirmBtn').disabled = false;
                imgEl.src = url;
                modal.classList.add('active');

                await loadCropperLib();
                if (currentCropper) { currentCropper.destroy(); currentCropper = null; }
                currentCropper = new Cropper(imgEl, {
                    aspectRatio: 16 / 9,
                    viewMode: 1,
                    autoCropArea: 0.9,
                    responsive: true,
                    background: false
                });

                document.getElementById('cropRatio169').classList.add('active');
                document.getElementById('cropRatio916').classList.remove('active');
                document.getElementById('cropRatio11').classList.remove('active');
            };
            testImg.src = url;
        }

        function setCropRatio(ratio) {
            cropState.ratio = ratio;
            document.getElementById('cropRatio169').classList.toggle('active', ratio === '16:9');
            document.getElementById('cropRatio916').classList.toggle('active', ratio === '9:16');
            document.getElementById('cropRatio11').classList.toggle('active', ratio === '1:1');
            var numRatio = ratio === '1:1' ? 1 : ratio === '9:16' ? 9 / 16 : 16 / 9;
            if (currentCropper) {
                currentCropper.setAspectRatio(numRatio);
            }
        }

        async function confirmCrop() {
            if (!currentCropper) return;
            var confirmBtn = document.getElementById('cropConfirmBtn');
            confirmBtn.disabled = true;
            confirmBtn.textContent = 'Traitement...';

            try {
                var croppedCanvas = currentCropper.getCroppedCanvas({
                    maxWidth: 2048,
                    maxHeight: 2048,
                    imageSmoothingQuality: 'high'
                });
                var cropData = currentCropper.getData(true);
                var croppedBlob = await new Promise(function(resolve) {
                    croppedCanvas.toBlob(function(b) { resolve(b); }, 'image/jpeg', 0.88);
                });

                // Save values before closeCropModal resets cropState
                var originalBlob = cropState.originalBlob;
                var ratio = cropState.ratio || '16:9';
                var resolve = cropState._resolve;
                closeCropModal();
                if (resolve) resolve({ croppedBlob: croppedBlob, originalBlob: originalBlob, ratio: ratio, cropData: cropData });
            } catch (err) {
                console.error('Crop error:', err);
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Valider';
            }
        }

        function cancelCrop() {
            var resolve = cropState._resolve;
            closeCropModal();
            if (resolve) resolve(null);
        }

        function closeCropModal() {
            var modal = document.getElementById('cropModal');
            modal.classList.remove('active');
            if (currentCropper) { currentCropper.destroy(); currentCropper = null; }
            var imgEl = document.getElementById('cropImage');
            if (imgEl.src && imgEl.src.startsWith('blob:')) URL.revokeObjectURL(imgEl.src);
            imgEl.src = '';
            cropState = {};
        }

        // Utilitaires d'échappement HTML
        function escapeHtml(str) {
            var div = document.createElement('div');
            div.textContent = str || '';
            return div.innerHTML;
        }
        function escapeAttr(str) {
            return (str || '').replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;');
        }

        // Catégories à exclure des tableaux (affichées uniquement dans le calculateur)
        // Comparaison insensible à la casse
        const excludedCategories = ['temps', 'ajouts', 'ajout'];

        function isExcludedCategory(category) {
            return excludedCategories.includes(category.toLowerCase().trim());
        }

        // Convertir un nom de catégorie en ID valide pour HTML
        function categoryToId(category) {
            return category
                .toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // Enlever les accents
                .replace(/[^a-z0-9]+/g, '-') // Remplacer les caractères spéciaux par des tirets
                .replace(/^-|-$/g, ''); // Enlever les tirets au début et à la fin
        }

        // Formater le prix
        function formatPrice(amount) {
            if (amount === null || amount === undefined) {
                return 'Sur demande';
            }
            if (typeof amount === 'number' && amount < 1 && amount > 0) {
                return (amount * 100).toFixed(0) + '%';
            }
            return amount.toLocaleString('fr-CA', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }) + ' $';
        }

        // Formater le type pour affichage
        function formatType(type) {
            if (type === '%') return '%';
            return type;
        }

        // ═══ Search + Sort state ═══
        var catalogueSearchQuery = '';
        var catalogueSortCol = null; // 'code', 'type', 'description', 'price'
        var catalogueSortDir = 'asc'; // 'asc' or 'desc'
        var aiFilterActive = false;
        var aiFilterCategory = null;
        var aiFilterStatus = null;
        var aiFilterStartsWith = null; // prefix filter (starts_with)
        var aiFilterHasField = null; // has_field filter
        var aiFilterMissingField = null; // missing_field filter
        var aiFilterItemType = null; // 'fabrication' or 'materiau'
        var aiBatchCodes = null; // codes inserted by AI (batch animation)
        var selectedCategory = null; // null = all categories

        function toggleItemTypeFilter(type) {
            if (aiFilterItemType === type) {
                aiFilterItemType = null;
            } else {
                aiFilterItemType = type;
            }
            document.getElementById('filterFabBtn').classList.toggle('active', aiFilterItemType === 'fabrication');
            document.getElementById('filterMatBtn').classList.toggle('active', aiFilterItemType === 'materiau');
            generatePriceTables();
        }

        function filterCatalogueSearch() {
            var input = document.getElementById('catalogueSearchInput');
            catalogueSearchQuery = (input ? input.value : '').toLowerCase().trim();
            generatePriceTables();
        }

        function sortCatalogueBy(col) {
            if (catalogueSortCol === col) {
                catalogueSortDir = catalogueSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                catalogueSortCol = col;
                catalogueSortDir = 'asc';
            }
            generatePriceTables();
        }

        // ═══ Category dropdown ═══
        var _catDdPopover = null;
        function openCatDropdown(e) {
            e.stopPropagation();
            if (_catDdPopover) { closeCatDropdown(); return; }
            var trigger = document.getElementById('catDropdownTrigger');
            var rect = trigger.getBoundingClientRect();
            // Get all categories from CATALOGUE_DATA
            var cats = [];
            CATALOGUE_DATA.forEach(function(item) {
                if (!isExcludedCategory(item.category) && cats.indexOf(item.category) === -1) cats.push(item.category);
            });
            var pop = document.createElement('div');
            pop.className = 'cat-dd-popover';
            pop.style.top = (rect.bottom + 4) + 'px';
            pop.style.left = rect.left + 'px';
            // "All" option
            pop.innerHTML = '<div class="cat-dd-item' + (!selectedCategory ? ' focused' : '') + '" data-val="">' +
                'Toutes les cat\u00e9gories' + (!selectedCategory ? '<span class="cat-dd-check">\u2713</span>' : '') + '</div>';
            cats.forEach(function(cat) {
                var isSel = selectedCategory && selectedCategory.toLowerCase() === cat.toLowerCase();
                pop.innerHTML += '<div class="cat-dd-item' + (isSel ? ' focused' : '') + '" data-val="' + escapeAttr(cat) + '">' +
                    escapeHtml(cat) + (isSel ? '<span class="cat-dd-check">\u2713</span>' : '') + '</div>';
            });
            document.body.appendChild(pop);
            _catDdPopover = pop;
            pop.addEventListener('click', function(ev) {
                var item = ev.target.closest('.cat-dd-item');
                if (!item) return;
                var val = item.getAttribute('data-val');
                selectedCategory = val || null;
                var label = document.getElementById('catDropdownLabel');
                label.textContent = val || 'Toutes les cat\u00e9gories';
                var trigger2 = document.getElementById('catDropdownTrigger');
                trigger2.classList.toggle('active', !!val);
                closeCatDropdown();
                generatePriceTables();
            });
            setTimeout(function() { document.addEventListener('click', _catDdOutsideClick); }, 0);
        }
        function _catDdOutsideClick(e) {
            if (_catDdPopover && !_catDdPopover.contains(e.target)) closeCatDropdown();
        }
        function closeCatDropdown() {
            if (_catDdPopover) { _catDdPopover.remove(); _catDdPopover = null; }
            document.removeEventListener('click', _catDdOutsideClick);
        }

        // Générer la table de prix unique
        function generatePriceTables() {
            // Grouper par catégorie (en conservant l'ordre d'apparition)
            const grouped = {};
            const categoryOrder = [];
            var activeCat = selectedCategory || aiFilterCategory || null;

            CATALOGUE_DATA.forEach(item => {
                if (isExcludedCategory(item.category)) return;
                if (filterDefaultsOnly && !item.is_default) return;
                if (filterPendingOnly && item.status !== 'pending') return;
                if (!canEditCatalogue && item.status === 'pending') return;

                if (catalogueSearchQuery) {
                    var q = catalogueSearchQuery;
                    var match = (item.id || '').toLowerCase().indexOf(q) !== -1
                        || (item.description || '').toLowerCase().indexOf(q) !== -1
                        || (item.category || '').toLowerCase().indexOf(q) !== -1
                        || (item.instruction || '').toLowerCase().indexOf(q) !== -1
                        || (item.type || '').toLowerCase().indexOf(q) !== -1;
                    if (!match) return;
                }

                // Prefix filter (starts_with)
                if (aiFilterStartsWith) {
                    var pfx = aiFilterStartsWith;
                    var pfxMatch = (item.id || '').toLowerCase().startsWith(pfx)
                        || (item.description || '').toLowerCase().startsWith(pfx);
                    if (!pfxMatch) return;
                }

                // has_field / missing_field filters
                if (aiFilterHasField) {
                    var fv = item[aiFilterHasField];
                    var hasIt = fv !== null && fv !== undefined && fv !== '' && fv !== 0 && fv !== false;
                    if (typeof fv === 'object' && fv !== null) hasIt = Object.keys(fv).length > 0;
                    if (!hasIt) return;
                }
                if (aiFilterMissingField) {
                    var mv = item[aiFilterMissingField];
                    var missing = mv === null || mv === undefined || mv === '' || mv === 0 || mv === false;
                    if (typeof mv === 'object' && mv !== null) missing = Object.keys(mv).length === 0;
                    if (!missing) return;
                }

                if (activeCat) {
                    if ((item.category || '').toLowerCase() !== activeCat.toLowerCase()) return;
                }

                if (aiFilterStatus) {
                    var itemStatus = item.status || 'approved';
                    if (itemStatus !== aiFilterStatus) return;
                }

                // item_type filter (fabrication/materiau)
                if (aiFilterItemType) {
                    if ((item.item_type || '') !== aiFilterItemType) return;
                }

                // Batch mode: only show newly inserted items
                if (aiBatchCodes && aiBatchCodes.length > 0) {
                    if (aiBatchCodes.indexOf(item.id) === -1) return;
                }

                if (!grouped[item.category]) {
                    grouped[item.category] = [];
                    categoryOrder.push(item.category);
                }
                grouped[item.category].push(item);
            });

            // Sort items within each category
            if (catalogueSortCol) {
                Object.keys(grouped).forEach(function(cat) {
                    grouped[cat].sort(function(a, b) {
                        var va, vb;
                        if (catalogueSortCol === 'code') { va = a.id || ''; vb = b.id || ''; }
                        else if (catalogueSortCol === 'description') { va = a.description || ''; vb = b.description || ''; }
                        else if (catalogueSortCol === 'type') { va = a.type || ''; vb = b.type || ''; }
                        else if (catalogueSortCol === 'price') { va = a.price || 0; vb = b.price || 0; }
                        else { return 0; }
                        var cmp = typeof va === 'number' ? va - vb : va.localeCompare(vb, 'fr');
                        return catalogueSortDir === 'desc' ? -cmp : cmp;
                    });
                });
            }

            // Build single table HTML
            var colCount = canEditCatalogue ? 6 : 5;
            var html = '<thead><tr>' +
                '<th class="col-code sortable' + (catalogueSortCol==='code'? ' sort-'+catalogueSortDir:'') + '" onclick="sortCatalogueBy(\'code\')">Code</th>' +
                '<th class="col-fiche"></th>' +
                '<th class="col-type sortable' + (catalogueSortCol==='type'? ' sort-'+catalogueSortDir:'') + '" onclick="sortCatalogueBy(\'type\')">Type</th>' +
                '<th class="col-description sortable' + (catalogueSortCol==='description'? ' sort-'+catalogueSortDir:'') + '" onclick="sortCatalogueBy(\'description\')">Description</th>' +
                '<th class="col-price sortable' + (catalogueSortCol==='price'? ' sort-'+catalogueSortDir:'') + '" onclick="sortCatalogueBy(\'price\')">Prix</th>' +
                (canEditCatalogue ? '<th class="col-edit"></th>' : '') +
                '</tr></thead><tbody>';

            categoryOrder.forEach(function(category) {
                // Category grouping row (hide when single category selected)
                if (!activeCat) {
                    html += '<tr class="cat-group-row"><td colspan="' + colCount + '">' + escapeHtml(category) +
                        (canEditCatalogue ? ' <button class="btn-add-item" onclick="createNewItem(\'' + escapeAttr(category).replace(/'/g, "&#39;") + '\')" title="Ajouter un article" style="float:right;margin-top:-2px;">+</button>' : '') +
                        '</td></tr>';
                }

                grouped[category].forEach(function(item) {
                    var imgHtml = item.image_url
                        ? '<img class="tooltip-image" src="' + escapeAttr(item.image_url) + '" alt="">'
                        : '';
                    var tooltipClass = item.image_url ? 'tooltip has-image' : 'tooltip';

                    var typeBadge = '';
                    if (item.item_type === 'fabrication') typeBadge = '<span class="item-type-badge fab">Fab</span>';
                    else if (item.item_type === 'materiau') typeBadge = '<span class="item-type-badge mat">Mat</span>';

                    html += '<tr data-item-id="' + escapeAttr(item.id) + '">' +
                        '<td><span class="tooltip-container tooltip-table">' +
                            escapeHtml(item.id) + typeBadge +
                            '<div class="' + tooltipClass + '">' + imgHtml +
                                '<div class="tooltip-title">' + escapeHtml(item.description) + '</div>' +
                                '<div class="tooltip-text">' + escapeHtml(item.instruction || '') + '</div>' +
                            '</div></span></td>' +
                        '<td>' + (item.has_sales_sheet ? '<a class="fiche-link" href="fiche.html?code=' + encodeURIComponent(item.id) + '" target="_blank">fiche client</a>' : '') + '</td>' +
                        '<td>' + formatType(item.type) + '</td>' +
                        '<td>' +
                            (canEditCatalogue ? '<span class="default-star' + (item.is_default ? ' active' : '') + '" onclick="event.stopPropagation();toggleDefault(\'' + escapeAttr(item.id) + '\',this)" title="Article par d\u00e9faut">\u2605</span> ' : (item.is_default ? '<span class="default-star active" style="cursor:default;" title="Article par d\u00e9faut">\u2605</span> ' : '')) +
                            '<span class="tooltip-container tooltip-table tooltip-left">' + escapeHtml(item.description) +
                                '<div class="' + tooltipClass + '">' + imgHtml +
                                    '<div class="tooltip-title">' + escapeHtml(item.id) + '</div>' +
                                    '<div class="tooltip-text">' + escapeHtml(item.instruction || '') + '</div>' +
                                '</div></span>' +
                            ((item.supplier_name || item.supplier_sku) ? '<div class="item-supplier-sub">' + [item.supplier_name, item.supplier_sku].filter(Boolean).map(escapeHtml).join(' \u2022 ') + '</div>' : '') +
                            (item.status === 'pending' ? '<span class="item-pending-badge" onclick="approveItem(\'' + escapeAttr(item.id) + '\', event)" title="Cliquer pour approuver">en attente</span>' : '') +
                        '</td>' +
                        '<td>' + formatPrice(item.price) + '</td>' +
                        (canEditCatalogue ? '<td class="col-edit"><button class="btn-edit-row" onclick="openEditModal(\'' + escapeAttr(item.id) + '\')" title="Modifier">&#9998;</button></td>' : '') +
                        '</tr>';
                });
            });

            html += '</tbody>';
            document.getElementById('mainCatalogueTable').innerHTML = html;

            // Stagger animation on rows
            if (aiBatchCodes && aiBatchCodes.length > 0) {
                // Batch mode: cascade animation + restore link
                var batchRows = document.querySelectorAll('#mainCatalogueTable tbody tr:not(.cat-group-row)');
                batchRows.forEach(function(row, i) {
                    row.classList.add('ai-batch-row');
                    row.style.animationDelay = (i * 70) + 'ms';
                });
                // Remove existing restore link if any
                var existing = document.querySelector('.ai-batch-restore');
                if (existing) existing.remove();
                // Add restore link
                var restoreLink = document.createElement('div');
                restoreLink.className = 'ai-batch-restore';
                restoreLink.textContent = 'Voir tout le catalogue';
                restoreLink.onclick = function() {
                    aiBatchCodes = null;
                    aiFilterActive = false;
                    removeAiFilterBadge();
                    generatePriceTables();
                };
                document.getElementById('mainCatalogueTable').after(restoreLink);
            } else if (aiFilterActive) {
                var allRows = document.querySelectorAll('#mainCatalogueTable tbody tr:not(.cat-group-row)');
                allRows.forEach(function(row, i) {
                    row.classList.add('ai-row-animate');
                    row.style.animationDelay = Math.min(i * 30, 300) + 'ms';
                });
            }
        }




        // ═══ Toggle default star ═══

        async function toggleDefault(itemId, starEl) {
            var item = CATALOGUE_DATA.find(function(i) { return i.id === itemId; });
            if (!item) return;
            var newVal = !item.is_default;
            starEl.classList.toggle('active', newVal);
            try {
                var resp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/catalogue_items?id=eq.' + encodeURIComponent(itemId), {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_default: newVal })
                });
                if (!resp.ok) throw new Error('Erreur ' + resp.status);
                item.is_default = newVal;
            } catch (e) {
                starEl.classList.toggle('active', !newVal);
            }
        }

        // ═══ Default filter ═══

        var filterDefaultsOnly = false;

        function toggleDefaultFilter() {
            filterDefaultsOnly = !filterDefaultsOnly;
            var btn = document.getElementById('filterDefaultBtn');
            if (btn) btn.classList.toggle('active', filterDefaultsOnly);
            generatePriceTables();
        }

        // ═══ Global add article dropdown ═══

        function toggleAddDropdown() {
            var dd = document.getElementById('navAddDd');
            if (dd.classList.contains('open')) { dd.classList.remove('open'); return; }
            // Build list of existing categories + configCategories
            var cats = new Set(configCategories);
            CATALOGUE_DATA.forEach(function(i) { if (i.category) cats.add(i.category); });
            var sorted = Array.from(cats).sort(function(a, b) { return a.localeCompare(b, 'fr'); });
            var html = '<div style="padding:8px 14px;font-size:11px;font-weight:600;color:#888;text-transform:uppercase;">Cat\u00e9gorie existante</div>';
            sorted.forEach(function(cat) {
                html += '<div class="add-dd-item" onclick="addItemInCategory(\'' + cat.replace(/'/g, "\\'") + '\')">' + escapeHtml(cat) + '</div>';
            });
            html += '<div class="add-dd-sep"></div>';
            html += '<div style="padding:8px 14px;font-size:11px;font-weight:600;color:#888;text-transform:uppercase;">Nouvelle cat\u00e9gorie</div>';
            html += '<div class="add-dd-input"><input id="newCatInput" placeholder="Nom..." onkeydown="if(event.key===\'Enter\')addItemNewCategory()"><button onclick="addItemNewCategory()">Cr\u00e9er</button></div>';
            dd.innerHTML = html;
            dd.classList.add('open');
        }

        function addItemInCategory(category) {
            document.getElementById('navAddDd').classList.remove('open');
            createNewItem(category);
        }

        function addItemNewCategory() {
            var input = document.getElementById('newCatInput');
            var name = input.value.trim();
            if (!name) return;
            document.getElementById('navAddDd').classList.remove('open');
            // Add to configCategories if not already there
            if (!configCategories.includes(name)) configCategories.push(name);
            createNewItem(name);
        }

        // Close dropdown on click outside
        document.addEventListener('click', function(e) {
            var wrap = document.getElementById('navAddWrap');
            if (wrap && !wrap.contains(e.target)) {
                document.getElementById('navAddDd').classList.remove('open');
            }
        });

        // ═══════════════════════════════════════════════════════════════════════
        // CHARGEMENT DES DONNÉES DEPUIS GOOGLE SHEETS (via API Visualization)
        // ═══════════════════════════════════════════════════════════════════════

        // Mettre à jour l'indicateur de statut
        function updateStatus(status, message) {
            const statusEl = document.getElementById('dataStatus');
            const textEl = document.getElementById('statusText');

            statusEl.className = 'data-status ' + status;
            textEl.textContent = message;
        }

        // Sauvegarder les données dans localStorage
        function saveToLocalStorage(data) {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                localStorage.setItem(STORAGE_DATE_KEY, new Date().toISOString());
            } catch (e) {
                console.warn('Impossible de sauvegarder dans localStorage:', e);
            }
        }

        // Charger les données depuis localStorage
        function loadFromLocalStorage() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                const date = localStorage.getItem(STORAGE_DATE_KEY);

                if (data) {
                    return {
                        data: JSON.parse(data),
                        date: date ? new Date(date) : null
                    };
                }
            } catch (e) {
                console.warn('Impossible de lire depuis localStorage:', e);
            }
            return null;
        }

        // Formater une date pour l'affichage
        function formatDate(date) {
            if (!date) return '';
            const options = { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' };
            return date.toLocaleDateString('fr-CA', options);
        }

        // Charger les données du catalogue depuis Supabase
        function loadCatalogueData() {
            return new Promise((resolve) => {
                updateStatus('', 'Chargement...');

                var statusFilter = canEditCatalogue
                    ? '&or=(status.eq.approved,status.is.null,status.eq.pending)'
                    : '&or=(status.eq.approved,status.is.null)';
                authenticatedFetch(SUPABASE_URL + '/rest/v1/catalogue_items?select=id,category,description,type,price,instruction,image_url,in_calculator,has_sales_sheet,labor_minutes,material_costs,calculation_rule_human,calculation_rule_ai,supplier_name,supplier_sku,is_default,client_text,client_text_en,presentation_rule_human,presentation_rule,status,proposed_by,item_type,dims_config,loss_override_pct' + statusFilter + '&order=sort_order', {})
                .then(r => {
                    if (!r.ok) throw new Error('HTTP ' + r.status);
                    return r.json();
                })
                .then(data => {
                    if (data.length > 0) {
                        CATALOGUE_DATA = data;
                        saveToLocalStorage(data);
                        updateStatus('online', 'Données à jour');
                        resolve(true);
                    } else {
                        throw new Error('Données vides');
                    }
                })
                .catch(error => {
                    console.warn('Erreur chargement catalogue:', error);
                    loadFallbackData();
                    resolve(false);
                });
            });
        }

        // ═══ Usage stats (articles dormants / jamais utilisés) ═══
        var USAGE_STATS = [];

        function loadUsageStats() {
            return authenticatedFetch(SUPABASE_URL + '/rest/v1/v_catalogue_usage_stats?select=id,category,description,usage_count,submission_count,last_used_at,days_since_used', {})
                .then(function(r) { return r.ok ? r.json() : []; })
                .then(function(data) { USAGE_STATS = data || []; })
                .catch(function() { USAGE_STATS = []; });
        }

        function ciCheckUsage(input) {
            var mode = input.mode || 'dormant';
            var limit = input.limit || 20;
            var cat = input.category || null;
            var stats = USAGE_STATS;

            // Filter by category if specified
            if (cat) {
                stats = stats.filter(function(s) { return (s.category || '').toLowerCase() === cat.toLowerCase(); });
            }

            if (mode === 'never_used') {
                var results = stats.filter(function(s) { return s.usage_count === 0; });
                results.sort(function(a, b) { return (a.category || '').localeCompare(b.category || '') || (a.id || '').localeCompare(b.id || ''); });
                return { results: results.slice(0, limit), total: results.length, mode: 'never_used' };
            }

            if (mode === 'dormant') {
                var threshold = input.days_threshold || 60;
                var results = stats.filter(function(s) {
                    // Never used OR not used in threshold days
                    return s.usage_count === 0 || (s.days_since_used !== null && s.days_since_used > threshold);
                });
                results.sort(function(a, b) {
                    // Never used first, then by most dormant
                    if (a.usage_count === 0 && b.usage_count > 0) return -1;
                    if (a.usage_count > 0 && b.usage_count === 0) return 1;
                    return (b.days_since_used || 9999) - (a.days_since_used || 9999);
                });
                return { results: results.slice(0, limit), total: results.length, mode: 'dormant', days_threshold: threshold };
            }

            if (mode === 'most_used') {
                var results = stats.filter(function(s) { return s.usage_count > 0; });
                results.sort(function(a, b) { return b.usage_count - a.usage_count; });
                return { results: results.slice(0, limit), total: results.length, mode: 'most_used' };
            }

            if (mode === 'by_item') {
                var itemId = input.catalogue_item_id || '';
                var found = stats.find(function(s) { return s.id === itemId; });
                if (!found) return { error: 'Article ' + itemId + ' non trouv\u00e9' };
                return { item: found, mode: 'by_item' };
            }

            return { error: 'Mode inconnu: ' + mode };
        }

        // ═══ Audit noms clients (détection incohérences) ═══

        function _stripAccents(s) {
            return s.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        }

        function _levenshtein(a, b) {
            if (a.length === 0) return b.length;
            if (b.length === 0) return a.length;
            var matrix = [];
            for (var i = 0; i <= b.length; i++) matrix[i] = [i];
            for (var j = 0; j <= a.length; j++) matrix[0][j] = j;
            for (var i = 1; i <= b.length; i++) {
                for (var j = 1; j <= a.length; j++) {
                    var cost = b.charAt(i - 1) === a.charAt(j - 1) ? 0 : 1;
                    matrix[i][j] = Math.min(
                        matrix[i - 1][j] + 1,
                        matrix[i][j - 1] + 1,
                        matrix[i - 1][j - 1] + cost
                    );
                }
            }
            return matrix[b.length][a.length];
        }

        function ciAuditClientNames(input) {
            var field = input.field || 'client_text';
            var catFilter = input.category || null;
            var items = CATALOGUE_DATA || [];

            // Filter by category if specified
            if (catFilter) {
                items = items.filter(function(i) { return (i.category || '').toLowerCase() === catFilter.toLowerCase(); });
            }

            // Collect items with non-empty field values
            var entries = [];
            items.forEach(function(item) {
                var val = item[field];
                if (val && val.trim()) {
                    entries.push({ id: item.id, text: val.trim(), category: item.category });
                }
            });

            if (entries.length === 0) {
                return { groups: [], total_groups: 0, total_items_affected: 0, message: 'Aucun article avec ' + field + ' rempli' };
            }

            // Normalize: lowercase + strip accents + collapse whitespace
            function normalize(s) {
                return _stripAccents(s).toLowerCase().replace(/\s+/g, ' ').trim();
            }

            // Phase 1: Group by exact normalized form
            var normMap = {}; // normalized → [{ id, text, category }]
            entries.forEach(function(e) {
                var norm = normalize(e.text);
                if (!normMap[norm]) normMap[norm] = [];
                normMap[norm].push(e);
            });

            // Phase 2: Find groups with actual text variations
            var exactGroups = [];
            Object.keys(normMap).forEach(function(norm) {
                var group = normMap[norm];
                // Check if there are different original texts
                var variants = {};
                group.forEach(function(e) {
                    if (!variants[e.text]) variants[e.text] = [];
                    variants[e.text].push(e.id);
                });
                if (Object.keys(variants).length > 1) {
                    // Find canonical (most frequent variant)
                    var best = null, bestCount = 0;
                    Object.keys(variants).forEach(function(v) {
                        if (variants[v].length > bestCount) { best = v; bestCount = variants[v].length; }
                    });
                    exactGroups.push({
                        canonical: best,
                        type: 'case_accent',
                        variants: Object.keys(variants).map(function(v) {
                            return { text: v, items: variants[v], count: variants[v].length };
                        }).sort(function(a, b) { return b.count - a.count; })
                    });
                }
            });

            // Phase 3: Fuzzy matching (Levenshtein ≤ 2) between unique normalized forms
            var normKeys = Object.keys(normMap);
            var fuzzyMerged = {}; // track which norms are already grouped
            var fuzzyGroups = [];

            for (var i = 0; i < normKeys.length; i++) {
                if (fuzzyMerged[normKeys[i]]) continue;
                var cluster = [normKeys[i]];
                for (var j = i + 1; j < normKeys.length; j++) {
                    if (fuzzyMerged[normKeys[j]]) continue;
                    // Only compare if lengths are close enough
                    if (Math.abs(normKeys[i].length - normKeys[j].length) > 2) continue;
                    if (_levenshtein(normKeys[i], normKeys[j]) <= 2) {
                        cluster.push(normKeys[j]);
                        fuzzyMerged[normKeys[j]] = true;
                    }
                }
                if (cluster.length > 1) {
                    fuzzyMerged[normKeys[i]] = true;
                    // Build variant list from all items in the cluster
                    var variants = {};
                    cluster.forEach(function(norm) {
                        normMap[norm].forEach(function(e) {
                            if (!variants[e.text]) variants[e.text] = [];
                            variants[e.text].push(e.id);
                        });
                    });
                    var best = null, bestCount = 0;
                    Object.keys(variants).forEach(function(v) {
                        if (variants[v].length > bestCount) { best = v; bestCount = variants[v].length; }
                    });
                    fuzzyGroups.push({
                        canonical: best,
                        type: 'typo',
                        variants: Object.keys(variants).map(function(v) {
                            return { text: v, items: variants[v], count: variants[v].length };
                        }).sort(function(a, b) { return b.count - a.count; })
                    });
                }
            }

            // Merge results, deduplicate (exact groups may overlap with fuzzy)
            var allGroups = exactGroups.concat(fuzzyGroups);
            var totalAffected = 0;
            allGroups.forEach(function(g) {
                var count = 0;
                g.variants.forEach(function(v) { count += v.count; });
                g.total_items = count;
                totalAffected += count;
            });

            // Sort by total items descending
            allGroups.sort(function(a, b) { return b.total_items - a.total_items; });

            return {
                field: field,
                groups: allGroups,
                total_groups: allGroups.length,
                total_items_affected: totalAffected,
                items_with_field: entries.length,
                items_without_field: items.length - entries.length
            };
        }

        // Charger les données de secours (cache ou défaut)
        function loadFallbackData() {
            const cached = loadFromLocalStorage();

            if (cached && cached.data && cached.data.length > 0) {
                CATALOGUE_DATA = cached.data;
                const dateStr = cached.date ? formatDate(cached.date) : '';
                updateStatus('offline', 'Hors-ligne' + (dateStr ? ' — ' + dateStr : ''));
            } else {
                // Utiliser les données par défaut
                updateStatus('error', 'Données par défaut');
            }
        }


        // ═══════════════════════════════════════════════════════════════════════
        // PERMISSIONS UTILISATEUR
        // ═══════════════════════════════════════════════════════════════════════

        const DEFAULT_PERMISSIONS = {
            'Admin':             { catalogue: true, catalogue_edit: true,  documents: true,  assistant: true,  admin: true,  edit_minutes: true,  edit_materials: true  },
            'Vente':             { catalogue: true, catalogue_edit: true,  documents: true,  assistant: true,  admin: false, edit_minutes: false, edit_materials: false },
            'Charg\u00e9 de projet': { catalogue: true, catalogue_edit: false, documents: true,  assistant: false, admin: false, edit_minutes: false, edit_materials: false },
            'Achat':             { catalogue: true, catalogue_edit: false, documents: true,  assistant: false, admin: false, edit_minutes: false, edit_materials: true  },
            'Atelier':           { catalogue: false, catalogue_edit: false, documents: true,  assistant: false, admin: false, edit_minutes: false, edit_materials: false },
            'Client':            { catalogue: false, catalogue_edit: false, documents: false, assistant: false, admin: false, edit_minutes: false, edit_materials: false }
        };

        const DEFAULT_USER_ROLES = { 'hubert@stele.ca': 'Admin' };
        let configCategories = [];

        function loadUserPermissions() {
            return new Promise((resolve) => {
                const email = (localStorage.getItem('sb_user_email') || '').toLowerCase();

                authenticatedFetch(SUPABASE_URL + '/rest/v1/app_config?select=key,value', {})
                .then(r => r.ok ? r.json() : [])
                .then(rows => {
                    let perms = DEFAULT_PERMISSIONS;
                    let roles = DEFAULT_USER_ROLES;
                    if (Array.isArray(rows)) {
                        rows.forEach(row => {
                            if (row.key === 'permissions') perms = row.value;
                            if (row.key === 'user_roles') roles = row.value;
                            if (row.key === 'taux_horaires') tauxHoraires = row.value;
                            if (row.key === 'expense_categories') expenseCategories = row.value;
                            if (row.key === 'catalogue_categories' && Array.isArray(row.value)) configCategories = row.value;
                        });
                    }
                    const role = roles[email] || 'Client';
                    const defaults = DEFAULT_PERMISSIONS[role] || {};
                    const saved = perms[role] || {};
                    const allowed = Object.assign({}, defaults, saved);
                    canEditCatalogue = !!allowed.catalogue_edit;
                    canEditMinutes = !!allowed.edit_minutes;
                    canEditMaterials = !!allowed.edit_materials;
                    isAdmin = !!allowed.admin;
                    canApproveItems = !!allowed.approbation;
                    resolve();
                })
                .catch(() => {
                    const email2 = (localStorage.getItem('sb_user_email') || '').toLowerCase();
                    const role = DEFAULT_USER_ROLES[email2] || 'Client';
                    const allowed = DEFAULT_PERMISSIONS[role] || {};
                    canEditCatalogue = !!allowed.catalogue_edit;
                    canEditMinutes = !!allowed.edit_minutes;
                    canEditMaterials = !!allowed.edit_materials;
                    isAdmin = !!allowed.admin;
                    canApproveItems = !!allowed.approbation;
                    resolve();
                });
            });
        }

        // ═══════════════════════════════════════════════════════════════════════
        // ÉDITION DU CATALOGUE
        // ═══════════════════════════════════════════════════════════════════════

        // ═══ Composantes fournisseur ═══
        let editComponents = [];          // { id, supplier_name, supplier_sku, description, expense_category, qty_per_unit, unit_cost, notes, sort_order, isNew }
        let editComponentsToDelete = [];  // UUIDs à supprimer au save
        let supplierCompanies = [];       // { id, name } from companies WHERE company_type='Fournisseurs'

        // ═══ Médias tagués ═══
        let editMedia = [];           // { id, file_url, file_type, tags, isNew, file, previewUrl }
        let editMediaToDelete = [];   // IDs à supprimer au save
        let mediaTagsList = ['fiche_client', 'catalogue', 'technique', 'dessin']; // défauts

        async function loadMediaTags() {
            try {
                const resp = await fetch(SUPABASE_URL + '/rest/v1/app_config?key=eq.media_tags&select=value', {
                    headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
                });
                if (resp.ok) {
                    const rows = await resp.json();
                    if (rows.length > 0 && Array.isArray(rows[0].value)) {
                        mediaTagsList = rows[0].value;
                    }
                }
            } catch (e) { /* keep defaults */ }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // AJOUT D'UN NOUVEL ARTICLE
        // ═══════════════════════════════════════════════════════════════════════

        let isNewItem = false;
        let newItemData = null;

        function generateNextCode() {
            // Code auto-genere par le trigger DB (generate_catalogue_code).
            // Cote client, on genere un code preview base sur le max existant.
            // Le code final est celui retourne par le serveur apres INSERT.
            var shopPrefix = 'ST';
            var cfgEntry = (typeof APP_CONFIG !== 'undefined' && APP_CONFIG) ? APP_CONFIG.find(function(c) { return c.key === 'shop_code_prefix'; }) : null;
            if (cfgEntry && cfgEntry.value) {
                var v = typeof cfgEntry.value === 'string' ? cfgEntry.value.replace(/"/g, '') : String(cfgEntry.value);
                if (v) shopPrefix = v;
            }
            var maxNum = 0;
            CATALOGUE_DATA.forEach(function(item) {
                var parts = (item.id || '').split('-');
                if (parts.length === 2) {
                    var num = parseInt(parts[1], 10);
                    if (!isNaN(num) && num > maxNum) maxNum = num;
                }
            });
            return shopPrefix + '-' + String(maxNum + 1).padStart(4, '0');
        }

        function createNewItem(category) {
            const newCode = generateNextCode();
            const maxSort = CATALOGUE_DATA.reduce((max, i) => Math.max(max, i.sort_order || 0), 0);

            // Préparer l'item en mémoire seulement (pas de POST)
            newItemData = {
                id: newCode,
                category: category,
                description: '',
                type: 'unité',
                price: null,
                instruction: '',
                image_url: null,
                in_calculator: true,
                has_sales_sheet: false,
                sort_order: maxSort + 1
            };

            isNewItem = true;
            openEditModal(newCode);
        }

        // ── Navigation entre articles ──
        let navItemList = [];  // liste ordonnée des IDs navigables
        var _navScopedList = null; // temporary scoped list from audit drawer

        /** Open modal with navigation scoped to a specific list of item IDs. */
        function openEditModalScoped(itemId, scopedIds) {
            _navScopedList = scopedIds;
            closeAuditDrawer();
            openEditModal(itemId);
        }

        function buildNavList() {
            navItemList = CATALOGUE_DATA.slice()
                .sort(function(a, b) { return (a.category || '').localeCompare(b.category || '') || (a.sort_order || 0) - (b.sort_order || 0); })
                .map(function(item) { return item.id; });
        }

        function updateNavButtons(itemId) {
            var idx = navItemList.indexOf(itemId);
            var btnPrev = document.getElementById('btnPrevItem');
            var btnNext = document.getElementById('btnNextItem');
            if (btnPrev) btnPrev.disabled = (idx <= 0 || isNewItem);
            if (btnNext) btnNext.disabled = (idx < 0 || idx >= navItemList.length - 1 || isNewItem);
        }

        function navigateItem(direction) {
            var currentId = document.getElementById('editItemId').value;
            var idx = navItemList.indexOf(currentId);
            var newIdx = idx + direction;
            if (newIdx < 0 || newIdx >= navItemList.length) return;
            isNewItem = false;
            newItemData = null;
            openEditModal(navItemList[newIdx]);
        }

        async function approveItem(itemId, event) {
            event.stopPropagation();
            var badge = event.target;
            badge.textContent = '...';
            try {
                var resp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/catalogue_items?id=eq.' + encodeURIComponent(itemId), {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                    body: JSON.stringify({ status: 'approved' })
                });
                if (!resp.ok) throw new Error(await resp.text());
                // Update local data
                for (var i = 0; i < CATALOGUE_DATA.length; i++) {
                    if (CATALOGUE_DATA[i].id === itemId) { CATALOGUE_DATA[i].status = 'approved'; break; }
                }
                badge.remove();
                updatePendingBadge();
            } catch (e) {
                badge.textContent = 'en attente';
                alert('Erreur: ' + e.message);
            }
        }

        // ── Approve/Reject from modal (server-side RPC) ──

        async function approveItemFromCatalogue() {
            var itemId = document.getElementById('editItemId').value;
            if (!itemId) return;
            var btn = document.getElementById('btnApproveItem');
            var origText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '...';
            try {
                // Save all editable fields first
                await saveEditModal(true); // silent save

                var resp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/rpc/approve_catalogue_item', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ p_item_id: itemId, p_new_status: 'approved' })
                });
                if (!resp.ok) throw new Error('Erreur ' + resp.status);
                var result = await resp.json();
                if (result.error) throw new Error(result.error);

                // Update local data
                for (var i = 0; i < CATALOGUE_DATA.length; i++) {
                    if (CATALOGUE_DATA[i].id === itemId) {
                        CATALOGUE_DATA[i].status = 'approved';
                        break;
                    }
                }
                updatePendingBadge();
                generatePriceTables();

                // In embedded mode, notify parent
                if (isEmbedded && window.parent !== window) {
                    var savedItem = CATALOGUE_DATA.find(function(i) { return i.id === itemId; });
                    window.parent.postMessage({
                        type: 'catalogue-item-saved',
                        item: savedItem ? JSON.parse(JSON.stringify(savedItem)) : null
                    }, '*');
                    return;
                }

                // Show success status in modal
                var statusEl = document.getElementById('editStatus');
                statusEl.className = 'edit-status success';
                statusEl.textContent = 'Article approuvé ✓';
                statusEl.style.display = '';

                // Close modal after brief delay
                setTimeout(function() { closeEditModal(); }, 1200);
            } catch (e) {
                btn.textContent = origText;
                btn.disabled = false;
                alert('Erreur: ' + e.message);
            }
        }

        async function rejectItemFromCatalogue() {
            var itemId = document.getElementById('editItemId').value;
            if (!itemId) return;

            var confirmed = await steleConfirm(
                'L\'article <strong>' + escapeHtml(itemId) + '</strong> sera rejeté et retiré du catalogue.',
                'Rejeter cet article ?',
                'Rejeter'
            );
            if (!confirmed) return;

            var btn = document.getElementById('btnRejectItem');
            var origText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '...';
            try {
                var resp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/rpc/approve_catalogue_item', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ p_item_id: itemId, p_new_status: 'rejected' })
                });
                if (!resp.ok) throw new Error('Erreur ' + resp.status);
                var result = await resp.json();
                if (result.error) throw new Error(result.error);

                // Remove from local data
                CATALOGUE_DATA = CATALOGUE_DATA.filter(function(it) { return it.id !== itemId; });
                updatePendingBadge();
                generatePriceTables();

                // In embedded mode, notify parent
                if (isEmbedded && window.parent !== window) {
                    window.parent.postMessage({ type: 'catalogue-modal-closed' }, '*');
                    return;
                }

                closeEditModal();
            } catch (e) {
                btn.textContent = origText;
                btn.disabled = false;
                alert('Erreur: ' + e.message);
            }
        }

        // ── AI Review Chat (catalogue modal) ──

        var catAiReviewMessages = [];
        var catAiReviewItemId = null;
        var catAiReviewLoading = false;

        async function openCatAiReviewChat() {
            var itemId = document.getElementById('editItemId').value;
            var item = CATALOGUE_DATA.find(function(it) { return it.id === itemId; });
            if (!item) return;

            // Reset conversation if different item
            if (catAiReviewItemId !== itemId) {
                catAiReviewMessages = [];
                catAiReviewItemId = itemId;
                document.getElementById('catAiReviewMessages').innerHTML = '';
            }

            document.getElementById('catAiReviewOverlay').style.display = '';
            document.getElementById('catAiReviewInput').focus();

            // If fresh conversation, send initial context
            if (catAiReviewMessages.length === 0) {
                await sendCatAiReviewInitialContext(item);
            }
        }

        function closeCatAiReviewChat() {
            var overlay = document.getElementById('catAiReviewOverlay');
            if (overlay) overlay.style.display = 'none';
        }

        function computeCatItemPrice(item) {
            var total = 0;
            if (item.labor_minutes && tauxHoraires) {
                for (var dept in item.labor_minutes) {
                    var mins = item.labor_minutes[dept] || 0;
                    var th = tauxHoraires.find(function(t) { return t.department === dept; });
                    var rate = th ? th.taux_horaire : 0;
                    total += (mins / 60) * rate;
                }
            }
            if (item.material_costs) {
                for (var cat in item.material_costs) {
                    var mc = item.material_costs[cat];
                    if (!mc || !mc.cost) continue;
                    var cost = mc.cost * (mc.qty || 1);
                    var ec = (expenseCategories || []).find(function(e) { return e.name === cat; });
                    var markup = ec ? (ec.markup || 0) : 0;
                    var waste = item.loss_override_pct != null ? item.loss_override_pct : (ec ? (ec.waste || 0) : 0);
                    total += cost * (1 + markup / 100 + waste / 100);
                }
            }
            return total;
        }

        async function sendCatAiReviewInitialContext(item) {
            var contextParts = [];
            contextParts.push('=== ARTICLE PROPOSÉ ===');
            contextParts.push('Code: ' + item.id);
            contextParts.push('Description: ' + (item.description || '—'));
            contextParts.push('Catégorie: ' + (item.category || '—'));
            contextParts.push('Type d\'unité: ' + (item.type || '—'));
            contextParts.push('Proposé par: ' + (item.proposed_by || '—'));
            contextParts.push('Instruction: ' + (item.instruction || '—'));

            if (item.client_text) contextParts.push('Texte client: ' + item.client_text);
            if (item.calculation_rule_human) contextParts.push('Règle de calcul: ' + item.calculation_rule_human);
            if (item.calculation_rule_ai) contextParts.push('JSON calcul: ' + JSON.stringify(item.calculation_rule_ai));
            if (item.presentation_rule_human) contextParts.push('Règle présentation: ' + item.presentation_rule_human);
            if (item.presentation_rule) contextParts.push('JSON présentation: ' + JSON.stringify(item.presentation_rule));

            // Price type + calculated breakdown
            var hasLM = item.labor_minutes && typeof item.labor_minutes === 'object' && Object.keys(item.labor_minutes).some(function(d) { return item.labor_minutes[d] > 0; });
            var hasMC = item.material_costs && typeof item.material_costs === 'object' && Object.keys(item.material_costs).some(function(c) { var m = item.material_costs[c]; return m && m.cost > 0; });
            var isComposed = hasLM || hasMC;

            if (item.price != null && item.price > 0 && !isComposed) {
                contextParts.push('Type de prix: fixe (' + item.price + ' $)');
            } else if (isComposed) {
                var computedPriceForContext = computeCatItemPrice(item);
                contextParts.push('Type de prix: composé (calculé à partir des composantes MO + matériaux)');

                // Labor detail
                var laborTotal = 0;
                if (hasLM) {
                    contextParts.push('');
                    var lmLines = [];
                    for (var dept in item.labor_minutes) {
                        var mins = item.labor_minutes[dept] || 0;
                        if (mins <= 0) continue;
                        var th = tauxHoraires.find(function(t) { return t.department === dept; });
                        var rate = th ? th.taux_horaire : 0;
                        var laborCost = (mins / 60) * rate;
                        laborTotal += laborCost;
                        lmLines.push('  - ' + dept + ': ' + mins + ' min × ' + rate.toFixed(2) + ' $/h = ' + laborCost.toFixed(2) + ' $');
                    }
                    contextParts.push('Main-d\'oeuvre (total: ' + laborTotal.toFixed(2) + ' $):');
                    lmLines.forEach(function(l) { contextParts.push(l); });
                }

                // Material detail
                var matTotal = 0;
                if (hasMC) {
                    contextParts.push('');
                    var mcLines = [];
                    for (var mcat in item.material_costs) {
                        var mc = item.material_costs[mcat];
                        if (!mc || !mc.cost || mc.cost <= 0) continue;
                        var baseCost = mc.cost * (mc.qty || 1);
                        var ec = (expenseCategories || []).find(function(e) { return e.name === mcat; });
                        var markup = ec ? (ec.markup || 0) : 0;
                        var waste = item.loss_override_pct != null ? item.loss_override_pct : (ec ? (ec.waste || 0) : 0);
                        var matCost = baseCost * (1 + markup / 100 + waste / 100);
                        matTotal += matCost;
                        var wasteLabel = item.loss_override_pct != null ? waste + '% perte [override]' : waste + '% perte';
                        mcLines.push('  - ' + mcat + ': ' + baseCost.toFixed(2) + ' $ \u00d7 (1 + ' + markup + '% markup + ' + wasteLabel + ') = ' + matCost.toFixed(2) + ' $');
                    }
                    contextParts.push('Matériaux (total: ' + matTotal.toFixed(2) + ' $):');
                    mcLines.forEach(function(l) { contextParts.push(l); });
                }

                contextParts.push('');
                contextParts.push('PRIX COMPOSÉ TOTAL: ' + computedPriceForContext.toFixed(2) + ' $ (MO: ' + laborTotal.toFixed(2) + ' + Mat: ' + matTotal.toFixed(2) + ')');
            } else {
                contextParts.push('Type de prix: AUCUN (ni fixe ni composé) — à vérifier');
            }

            // Taux horaires
            if (tauxHoraires && tauxHoraires.length > 0) {
                var thParts = [];
                tauxHoraires.forEach(function(t) { thParts.push(t.department + ': ' + t.taux_horaire + ' $/h'); });
                contextParts.push('\n=== TAUX HORAIRES ===');
                contextParts.push(thParts.join(', '));
            }

            // Expense categories
            if (expenseCategories && expenseCategories.length > 0) {
                contextParts.push('\n=== CATÉGORIES DE DÉPENSES ===');
                expenseCategories.forEach(function(ec) {
                    contextParts.push(ec.name + ': markup ' + (ec.markup || 0) + '%, perte ' + (ec.waste || 0) + '%');
                });
            }

            // Similar items (from CATALOGUE_DATA, same category, approved)
            var similar = getSimilarItems(item.category, 15);
            if (similar.length > 0) {
                contextParts.push('\n=== ARTICLES SIMILAIRES (même catégorie: ' + item.category + ') ===');
                similar.forEach(function(si) {
                    var siPrice = si.price || computeCatItemPrice(si);
                    contextParts.push(si.id + ' — ' + (si.description || '?') + ' — ' + (si.type || '?') + ' — ' + (siPrice > 0 ? siPrice.toFixed(2) + ' $' : 'prix N/A'));
                });
            }

            contextParts.push('\nAnalyse cet article selon les 4 axes (comparaison interne, benchmarking industrie, cohérence des données, verdict).');

            appendCatAiReviewMessage('context', 'Contexte transmis');
            catAiReviewMessages.push({ role: 'user', content: contextParts.join('\n') });
            await callCatAiReviewAssistant();
        }

        async function sendCatAiReviewMessage() {
            if (catAiReviewLoading) return;
            var input = document.getElementById('catAiReviewInput');
            var text = input.value.trim();
            if (!text) return;

            input.value = '';
            input.style.height = 'auto';

            catAiReviewMessages.push({ role: 'user', content: text });
            appendCatAiReviewMessage('user', text);
            await callCatAiReviewAssistant();
        }

        async function callCatAiReviewAssistant() {
            catAiReviewLoading = true;
            var btn = document.getElementById('catAiReviewBtn');
            var sendBtn = document.getElementById('catAiReviewSendBtn');
            btn.classList.add('ai-active');
            sendBtn.disabled = true;
            document.getElementById('catAiReviewTyping').style.display = '';
            scrollCatReviewMessages();

            try {
                var r = await authenticatedFetch(
                    SUPABASE_URL + '/functions/v1/ai-assistant',
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            messages: catAiReviewMessages,
                            context: {},
                            prompt_key: 'ai_prompt_approval_review',
                            tools_enabled: false
                        })
                    }
                );

                if (!r.ok) {
                    var errText = '';
                    try { var errData = await r.json(); errText = errData.error || r.status; } catch(e) { errText = r.status; }
                    appendCatAiReviewMessage('assistant', 'Erreur : ' + errText);
                    return;
                }

                var data = await r.json();
                if (data.error) {
                    appendCatAiReviewMessage('assistant', 'Erreur : ' + data.error);
                    return;
                }

                var responseText = '';
                if (Array.isArray(data.content)) {
                    data.content.forEach(function(block) {
                        if (block.type === 'text') responseText += block.text;
                    });
                } else if (typeof data.content === 'string') {
                    responseText = data.content;
                }

                if (responseText) {
                    catAiReviewMessages.push({ role: 'assistant', content: responseText });
                    appendCatAiReviewMessage('assistant', responseText);
                }
            } catch (e) {
                appendCatAiReviewMessage('assistant', 'Erreur de connexion.');
            } finally {
                catAiReviewLoading = false;
                btn.classList.remove('ai-active');
                sendBtn.disabled = false;
                document.getElementById('catAiReviewTyping').style.display = 'none';
            }
        }

        function appendCatAiReviewMessage(role, content) {
            var container = document.getElementById('catAiReviewMessages');
            var div = document.createElement('div');
            div.className = 'ai-review-msg ' + role;

            if (role === 'assistant') {
                div.innerHTML = renderCatReviewMarkdown(content);
            } else {
                div.textContent = content;
            }

            container.appendChild(div);
            scrollCatReviewMessages();
        }

        function renderCatReviewMarkdown(text) {
            var html = escapeHtml(text);
            html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
            html = html.replace(/^#{1,4}\s+(.+)$/gm, '<strong>$1</strong>');
            html = html.replace(/^[-•]\s+(.+)$/gm, '<li>$1</li>');
            html = html.replace(/((?:<li>.*<\/li>\n?)+)/g, '<ul>$1</ul>');
            html = html.replace(/^\d+\.\s+(.+)$/gm, '<li>$1</li>');
            html = html.replace(/\n{2,}/g, '</p><p>');
            html = '<p>' + html + '</p>';
            html = html.replace(/\n/g, '<br>');
            html = html.replace(/<p>\s*<\/p>/g, '');
            return html;
        }

        function scrollCatReviewMessages() {
            var el = document.getElementById('catAiReviewMessages');
            setTimeout(function() { el.scrollTop = el.scrollHeight; }, 50);
        }

        // Keyboard + auto-resize for AI review input
        (function() {
            var input = document.getElementById('catAiReviewInput');
            if (!input) return;
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendCatAiReviewMessage();
                }
                if (e.key === 'Escape') {
                    closeCatAiReviewChat();
                }
            });
            input.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
        })();

        async function openEditModal(itemId) {
            // Pour un nouvel item, utiliser newItemData au lieu de chercher dans CATALOGUE_DATA
            const item = (isNewItem && newItemData) ? newItemData : CATALOGUE_DATA.find(i => i.id === itemId);
            if (!item) return;

            // Populer catégories dynamiquement
            const catSelect = document.getElementById('editCategory');
            const cats = new Set(configCategories);
            CATALOGUE_DATA.forEach(i => { if (i.category) cats.add(i.category); });
            if (item.category && !cats.has(item.category)) cats.add(item.category);
            catSelect.innerHTML = Array.from(cats).map(c => '<option value="' + c.replace(/"/g, '&quot;') + '">' + c + '</option>').join('');

            // Populer types dynamiquement
            const typeSelect = document.getElementById('editType');
            const types = new Set(['pi\u00b2', 'unitaire', 'lin\u00e9aire', '%']);
            CATALOGUE_DATA.forEach(i => { if (i.type) types.add(i.type); });
            if (item.type && !types.has(item.type)) types.add(item.type);
            typeSelect.innerHTML = Array.from(types).map(t => '<option value="' + t.replace(/"/g, '&quot;') + '">' + t + '</option>').join('');

            document.getElementById('editItemId').value = item.id;
            document.getElementById('editCode').value = item.id;
            document.getElementById('editCategory').value = item.category;
            catSelect.disabled = !isNewItem;
            document.getElementById('editItemType').value = item.item_type || '';
            var dc = item.dims_config || {};
            document.getElementById('editDimL').checked = dc.l !== false;
            document.getElementById('editDimH').checked = dc.h !== false;
            document.getElementById('editDimP').checked = dc.p !== false;
            document.getElementById('dimsConfigGroup').style.display = (item.item_type === 'fabrication') ? '' : 'none';
            document.getElementById('editDescription').value = item.description;
            document.getElementById('editType').value = item.type;
            document.getElementById('editPrice').value = item.price != null ? item.price : '';
            document.getElementById('editPriceDisplay').textContent = item.price != null ? formatPrice(item.price) : 'Calculé automatiquement';
            document.getElementById('editInstruction').value = item.instruction || '';

            // Proposal context (visible for non-editors proposing, or approvers reviewing pending)
            var pc = item.proposal_context || {};
            document.getElementById('editPropConstraints').value = pc.constraints || '';
            document.getElementById('editPropNotes').value = pc.notes_for_approver || '';

            // Présentation client (admin only)
            document.getElementById('editClientText').value = item.client_text || '';
            document.getElementById('clientTextGroup').style.display = isAdmin ? '' : 'none';

            // Template hint banner (admin only)
            var hintBanner = document.getElementById('templateHintBanner');
            var hintText = document.getElementById('templateHintText');
            var templates = getAllRulesTemplates();
            if (isAdmin && templates) {
                hintText.textContent = templates;
                hintBanner.style.display = '';
            } else {
                hintBanner.style.display = 'none';
            }

            // Règles de calcul (admin only)
            document.getElementById('editCalcRuleHuman').value = item.calculation_rule_human || '';
            document.getElementById('editCalcRuleAi').value = item.calculation_rule_ai ? JSON.stringify(item.calculation_rule_ai, null, 2) : '';
            document.getElementById('calcRuleGroup').style.display = isAdmin ? '' : 'none';
            clearAiFeedback('calcRuleFeedback');
            updateGenerateRuleBtn();

            // Règles de présentation (admin only)
            document.getElementById('editPresRuleHuman').value = item.presentation_rule_human || '';
            document.getElementById('editPresRuleAi').value = item.presentation_rule ? JSON.stringify(item.presentation_rule, null, 2) : '';
            document.getElementById('presRuleGroup').style.display = isAdmin ? '' : 'none';

            document.getElementById('editInCalculator').checked = item.in_calculator !== false;
            document.getElementById('editIsDefault').checked = item.is_default === true;
            document.getElementById('editHasSalesSheet').checked = item.has_sales_sheet === true;
            toggleSalesSheetBtn();

            // Rafraîchir taux horaires, catégories dépenses, et mappings matériaux
            try {
                var cfgResp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/app_config?key=in.(taux_horaires,expense_categories,material_groups,category_group_mapping)&select=key,value', {});
                if (cfgResp.ok) {
                    var cfgRows = await cfgResp.json();
                    cfgRows.forEach(function(r) {
                        if (r.key === 'taux_horaires') tauxHoraires = r.value;
                        if (r.key === 'expense_categories') expenseCategories = r.value;
                        if (r.key === 'material_groups' && Array.isArray(r.value) && r.value.length) sbMaterialGroupsFull = r.value;
                        if (r.key === 'category_group_mapping' && r.value && typeof r.value === 'object') sbCategoryGroupMapping = r.value;
                    });
                }
            } catch (e) { /* use cached values */ }

            // Prix composé — tableaux minutes & matériaux
            renderComposedTables(item);

            // Perte override
            var lossInput = document.getElementById('cpLossOverride');
            if (item.loss_override_pct != null) {
                lossInput.value = item.loss_override_pct;
                lossInput.classList.add('has-override');
            } else {
                lossInput.value = '';
                lossInput.classList.remove('has-override');
            }
            updateLossOverrideHint();

            // Composantes fournisseur
            var realItemId = (isNewItem && newItemData) ? null : item.id;
            loadComponents(realItemId);
            loadSupplierCompanies();
            compImportImages = [];
            var compInput = document.getElementById('compImportInput');
            if (compInput) compInput.value = '';
            renderCompImportThumbs();
            clearImportRecap();
            initCompImportZone();

            // Médias
            editMedia = [];
            editMediaToDelete = [];
            if (!(isNewItem && newItemData)) {
                try {
                    const mResp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/item_media?catalogue_item_id=eq.' + encodeURIComponent(item.id) + '&order=sort_order&select=id,file_url,file_type,tags', {});
                    if (mResp.ok) {
                        const existing = await mResp.json();
                        editMedia = existing.map(function(m) {
                            return { id: m.id, file_url: m.file_url, file_type: m.file_type || 'image', tags: m.tags || [], isNew: false };
                        });
                    }
                } catch (e) { /* ignore */ }
            }
            renderEditMedia();

            // Reset status
            const status = document.getElementById('editStatus');
            status.className = 'edit-status';
            status.style.display = 'none';

            // Approval mode: show buttons + all fields if pending + has permission
            var isPending = item.status === 'pending';
            var showApproval = isPending && canApproveItems;

            document.getElementById('btnApproveItem').style.display = showApproval ? '' : 'none';
            document.getElementById('btnRejectItem').style.display = showApproval ? '' : 'none';
            document.getElementById('catAiReviewBtn').style.display = showApproval ? '' : 'none';

            // Show proposed by
            var proposedEl = document.getElementById('editProposedBy');
            if (isPending && item.proposed_by) {
                proposedEl.style.display = '';
                proposedEl.textContent = 'Proposé par : ' + item.proposed_by;
            } else {
                proposedEl.style.display = 'none';
            }

            // If approver viewing pending item: show all admin fields
            if (showApproval) {
                document.getElementById('clientTextGroup').style.display = '';
                document.getElementById('calcRuleGroup').style.display = '';
                document.getElementById('presRuleGroup').style.display = '';
            }

            // Proposal context: visible for non-editors (proposers) or approvers reviewing pending
            var showProposalCtx = !canEditCatalogue || showApproval;
            document.getElementById('proposalContextGroup').style.display = showProposalCtx ? '' : 'none';

            // Navigation — use scoped list if set (from audit), else full catalogue
            if (_navScopedList) {
                navItemList = _navScopedList;
                _navScopedList = null;
            } else if (navItemList.length === 0) {
                buildNavList();
            }
            updateNavButtons(item.id);

            document.getElementById('editModal').classList.add('active');
            document.querySelector('.modal-body').scrollTop = 0;

            // ── Sandbox (admin only) ──
            if (isAdmin) {
                sbItemOverrides = {};
                sbRows = [];
                sbRowCounter = 0;
                sbInitSandbox();
                sbSetupReactivity();
            }

            // ── Dirty tracking: snapshot initial state after modal is fully populated ──
            setTimeout(function() { _modalSnapshot = captureModalSnapshot(); _modalDirty = false; }, 100);
            _saveValidationBypass = false;
            clearAiFeedback('saveValidationFeedback');
        }

        // ═══ Unsaved changes protection ═══
        var _modalSnapshot = '';
        var _modalDirty = false;

        /** Serialize all editable fields into a string for comparison. */
        function captureModalSnapshot() {
            var fields = [
                'editDescription', 'editInstruction', 'editClientText',
                'editCategory', 'editItemType', 'editType', 'editPrice',
                'editPresRuleHuman', 'editPresRuleAi', 'editCalcRuleHuman', 'editCalcRuleAi',
                'editInCalculator', 'editIsDefault', 'editHasSalesSheet',
                'editDimL', 'editDimH', 'editDimP',
                'editPropConstraints', 'editPropNotes'
            ];
            var parts = [];
            fields.forEach(function(id) {
                var el = document.getElementById(id);
                if (!el) return;
                if (el.type === 'checkbox') parts.push(id + ':' + el.checked);
                else parts.push(id + ':' + (el.value || ''));
            });
            // Composed price tables — minutes & materials inputs
            document.querySelectorAll('#minutesTable input, #materialsTable input').forEach(function(inp) {
                parts.push('comp:' + (inp.id || inp.name || '') + ':' + inp.value);
            });
            // Components
            document.querySelectorAll('#componentsList input, #componentsList select').forEach(function(inp) {
                parts.push('cmp:' + (inp.dataset.field || '') + ':' + inp.value);
            });
            return parts.join('|');
        }

        /** Check if modal has unsaved changes. */
        function isModalDirty() {
            if (_modalDirty) return true;
            return captureModalSnapshot() !== _modalSnapshot;
        }

        /**
         * Show unsaved changes confirmation dialog.
         * Returns a Promise that resolves to 'stay' or 'discard'.
         */
        function confirmUnsavedChanges() {
            return new Promise(function(resolve) {
                var overlay = document.createElement('div');
                overlay.className = 'unsaved-confirm-overlay';
                overlay.innerHTML =
                    '<div class="unsaved-confirm">' +
                    '<h3>Modifications non sauvegardées</h3>' +
                    '<p>Vous avez des modifications non sauvegardées. Fermer quand même ?</p>' +
                    '<div class="unsaved-confirm-actions">' +
                    '<button class="uc-btn-discard" id="ucDiscard">Fermer sans sauvegarder</button>' +
                    '<button class="uc-btn-stay" id="ucStay">Rester</button>' +
                    '</div></div>';
                document.body.appendChild(overlay);
                overlay.querySelector('#ucStay').onclick = function() { overlay.remove(); resolve('stay'); };
                overlay.querySelector('#ucDiscard').onclick = function() { overlay.remove(); resolve('discard'); };
                overlay.addEventListener('click', function(e) {
                    if (e.target === overlay) { overlay.remove(); resolve('stay'); }
                });
                overlay.querySelector('#ucStay').focus();
            });
        }

        /**
         * Guarded close: checks for unsaved changes before closing.
         * Use this instead of closeEditModal() for user-initiated closes.
         */
        async function guardedCloseEditModal() {
            if (isModalDirty()) {
                var result = await confirmUnsavedChanges();
                if (result === 'stay') return;
            }
            closeEditModal();
        }

        function toggleSalesSheetBtn() {
            const checked = document.getElementById('editHasSalesSheet').checked;
            document.getElementById('btnSalesSheet').style.display = checked ? '' : 'none';
        }

        function openSalesSheet() {
            const itemId = document.getElementById('editItemId').value;
            window.open('fiche.html?code=' + encodeURIComponent(itemId) + '&edit=true', '_blank');
        }

        function updateGenerateRuleBtn() {
            // No button yet — placeholder for future "Generate AI rule" button
            // This function is called by the oninput handler on editCalcRuleHuman
        }

        function closeEditModal() {
            // In embedded mode, notify parent and return
            if (isEmbedded && window.parent !== window) {
                window.parent.postMessage({ type: 'catalogue-modal-closed' }, '*');
                return;
            }
            document.getElementById('editModal').classList.remove('active');
            document.getElementById('editModal').classList.remove('anim-enter');
            editMedia = [];
            editMediaToDelete = [];
            isNewItem = false;
            newItemData = null;
            // Cleanup AI feedback
            _pendingAiData = {};
            clearAiFeedback('clientTextFeedback');
            clearAiFeedback('presRuleFeedback');
            clearAiFeedback('calcRuleFeedback');
            clearAiFeedback('importCompFeedback');
            // Close AI review overlay if open
            closeCatAiReviewChat();

            // Destroy sandbox if active
            if (isAdmin) sbDestroySandbox();
        }

        // ═══════════════════════════════════════════════════════════════════════
        // SANDBOX — Éditeur de règles (admin only)
        // ═══════════════════════════════════════════════════════════════════════

        var sbRows = [];          // [{ id, catalogueItemId, qty, cascadeOf, warn }]
        var sbRowCounter = 0;
        var sbMaterials = {};     // { caisson: {id,desc}, facades: {id,desc}, poignees: {id,desc} }
        var sbItemOverrides = {}; // Temporary overrides from modal edits
        var sbActive = false;
        var sbDims = { L: 0, H: 0, P: 0 }; // Sandbox dimensions
        var sbMaterialGroups = ['Caisson', 'Façades', 'Panneaux', 'Poignées'];
        var sbCategoryGroupMapping = {};
        var sbMaterialGroupsFull = [];

        // ── Utility functions (adapted from calculateur.html) ──

        function sbEvalFormula(expr, vars) {
            if (!expr) return null;
            var safe = String(expr).replace(/\b(L|H|P|QTY)\b/g, function(m) {
                return (vars[m] != null) ? Number(vars[m]) : 0;
            });
            safe = safe.replace(/\bceil\b/g, 'Math.ceil')
                       .replace(/\bfloor\b/g, 'Math.floor')
                       .replace(/\bround\b/g, 'Math.round')
                       .replace(/\bmin\b/g, 'Math.min')
                       .replace(/\bmax\b/g, 'Math.max');
            var check = safe.replace(/Math\.\w+/g, '').replace(/[\d\s+\-*/.(),><=!&|]/g, '');
            if (check.length > 0) return null;
            try { return new Function('return ' + safe)(); }
            catch (e) { return null; }
        }

        function sbComputePrice(item) {
            if (!item) return null;
            var lm = item.labor_minutes, mc = item.material_costs;
            if ((!lm || Object.keys(lm).length === 0) && (!mc || Object.keys(mc).length === 0)) return null;
            var laborTotal = 0;
            if (lm) {
                for (var dept in lm) {
                    var minutes = parseFloat(lm[dept]) || 0;
                    var taux = tauxHoraires.find(function(t) { return t.department === dept; });
                    laborTotal += (minutes / 60) * (taux ? (taux.taux_horaire || 0) : 0);
                }
            }
            var materialTotal = 0;
            if (mc) {
                for (var cat in mc) {
                    var cost = parseFloat(mc[cat]) || 0;
                    var expCat = expenseCategories.find(function(c) { return c.name === cat; });
                    var markup = (expCat ? (expCat.markup || 0) : 0) / 100;
                    var waste = (expCat ? (expCat.waste || 0) : 0) / 100;
                    materialTotal += cost * (1 + markup + waste);
                }
            }
            var total = laborTotal + materialTotal;
            return total > 0 ? total : null;
        }

        function sbToSentenceCase(str) {
            if (!str) return '';
            return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
        }

        function sbFormatDescription(text) {
            if (!text || !text.trim()) return '';
            var lines = text.split('\n');
            var keywords = [
                'CAISSON', 'FAÇADES ET PANNEAUX APPARENTS', 'FAÇADES',
                'TIROIRS LEGRABOX', 'TIROIRS', 'POIGNÉES', 'ÉCLAIRAGE',
                'DÉTAILS', 'EXCLUSIONS', 'COMPTOIR', 'QUINCAILLERIE',
                'FINITION', 'ÉLECTRO', 'RANGEMENT', 'DIMENSIONS',
                'NOTES', 'PARTICULARITÉS'
            ];
            var hasKw = lines.some(function(l) { return keywords.some(function(k) { return l.trim().toUpperCase().startsWith(k); }); });
            if (!hasKw) return escapeHtml(text).replace(/\n/g, '<br>');
            var html = '', inList = false;
            lines.forEach(function(line) {
                var tr = line.trim();
                if (!tr) { if (inList) { html += '</ul>'; inList = false; } html += '<br>'; return; }
                if (tr.startsWith('-') || tr.startsWith('•')) {
                    if (!inList) { html += '<ul>'; inList = true; }
                    html += '<li>' + escapeHtml(tr.replace(/^[-•]\s*/, '')) + '</li>';
                    return;
                }
                if (inList) { html += '</ul>'; inList = false; }
                var matched = false;
                for (var i = 0; i < keywords.length; i++) {
                    if (tr.toUpperCase().startsWith(keywords[i])) {
                        var ci = tr.indexOf(':');
                        if (ci !== -1) {
                            html += '<p><strong>' + escapeHtml(sbToSentenceCase(tr.substring(0, ci).trim())) + ' :</strong> ' + escapeHtml(tr.substring(ci + 1).trim()) + '</p>';
                        } else {
                            html += '<p><strong>' + escapeHtml(sbToSentenceCase(tr)) + '</strong></p>';
                        }
                        matched = true; break;
                    }
                }
                if (!matched) html += '<p>' + escapeHtml(tr) + '</p>';
            });
            if (inList) html += '</ul>';
            return html;
        }

        // ── Get effective item data (with overrides from modal edits) ──

        function sbGetItem(itemId) {
            var base = CATALOGUE_DATA.find(function(i) { return i.id === itemId; });
            if (!base) return null;
            var over = sbItemOverrides[itemId];
            if (!over) return base;
            return Object.assign({}, base, over);
        }

        function sbGetPrice(item) {
            if (!item) return 0;
            var composed = sbComputePrice(item);
            return composed != null ? composed : (parseFloat(item.price) || 0);
        }

        // ── Sandbox initialization / destruction ──

        function sbInitSandbox() {
            // If already active (navigating between items), just refresh content
            if (sbActive) {
                if (sbMaterialGroupsFull.length > 0) sbMaterialGroups = sbMaterialGroupsFull;
                var panel = document.getElementById('sbPanel');
                if (panel) {
                    panel.innerHTML = sbBuildPanelHTML();
                    sbSetupCombobox();
                    sbSetupMaterialDropdowns();
                    sbUpdateDimsVisibility();
                    var currentId = document.getElementById('editItemId').value;
                    if (currentId) sbAddRow(currentId, 1, null);
                    sbRefreshAll();
                }
                return;
            }

            sbActive = true;
            if (sbMaterialGroupsFull.length > 0) sbMaterialGroups = sbMaterialGroupsFull;

            var overlay = document.getElementById('editModal');
            var modal = overlay.querySelector('.modal.modal-edit');
            if (!modal) return;

            // Wrap modal in split container
            var container = document.createElement('div');
            container.className = 'sandbox-split-container';
            container.id = 'sbSplitContainer';

            // Create sandbox panel
            var panel = document.createElement('div');
            panel.className = 'sandbox-panel';
            panel.id = 'sbPanel';
            panel.innerHTML = sbBuildPanelHTML();

            // Move modal into container
            modal.parentNode.insertBefore(container, modal);
            container.appendChild(panel);
            container.appendChild(modal);

            // Setup combobox handlers
            sbSetupCombobox();

            // Setup material dropdown handlers
            sbSetupMaterialDropdowns();

            // Setup dimension fields visibility
            sbUpdateDimsVisibility();

            // If current item is being edited, auto-add it to sandbox
            var currentId = document.getElementById('editItemId').value;
            if (currentId) {
                sbAddRow(currentId, 1, null);
            }

            sbRefreshAll();
        }

        function sbDestroySandbox() {
            if (!sbActive) return;
            sbActive = false;

            var container = document.getElementById('sbSplitContainer');
            if (!container) return;

            var modal = container.querySelector('.modal.modal-edit');
            if (modal) {
                container.parentNode.insertBefore(modal, container);
            }
            container.remove();

            // Reset state (keep materials)
            sbRows = [];
            sbRowCounter = 0;
            sbItemOverrides = {};
        }

        function sbResetSandbox() {
            sbRows = [];
            sbRowCounter = 0;
            sbItemOverrides = {};
            // Keep sbMaterials!

            sbRefreshAll();

            // Flash feedback on panel
            var panel = document.getElementById('sbPanel');
            if (panel) {
                panel.style.transition = 'background 0.2s';
                panel.style.background = '#f0f7f0';
                setTimeout(function() { panel.style.background = ''; }, 400);
            }
        }

        // ── Panel HTML template ──

        function sbBuildPanelHTML() {
            var html = '<div class="sb-section-title">Matériaux par défaut</div>';

            // Material defaults dropdowns
            sbMaterialGroups.forEach(function(group, idx) {
                var key = sbMatKey(group);
                var current = sbMaterials[key];
                html += '<div class="sb-mat-row">'
                    + '<span class="sb-mat-label">' + escapeHtml(group) + '</span>'
                    + '<select class="sb-mat-select" id="sbMat-' + idx + '" data-group="' + escapeAttr(group) + '" onchange="sbOnMaterialChange(' + idx + ')">'
                    + '<option value="">— Aucun —</option>'
                    + '</select>'
                    + '</div>';
            });

            html += '<hr class="sb-divider">';
            html += '<div class="sb-section-title">Description client</div>';
            html += '<div class="sb-desc-preview" id="sbDescPreview"><span class="sb-desc-placeholder">Ajoutez des articles et matériaux...</span></div>';

            // Dimensions (visible only if current item has dims_config)
            html += '<div id="sbDimsSection" style="display:none;">';
            html += '<hr class="sb-divider">';
            html += '<div class="sb-section-title">Dimensions</div>';
            html += '<div class="sb-dims-row">'
                + '<label id="sbDimLGroup" style="display:none;">L <input type="number" class="sb-dim-input" id="sbDimL" min="0" step="0.1" value="' + (sbDims.L || '') + '" oninput="sbOnDimChange()" placeholder="0"> <span class="sb-dim-unit">po</span></label>'
                + '<label id="sbDimHGroup" style="display:none;">H <input type="number" class="sb-dim-input" id="sbDimH" min="0" step="0.1" value="' + (sbDims.H || '') + '" oninput="sbOnDimChange()" placeholder="0"> <span class="sb-dim-unit">po</span></label>'
                + '<label id="sbDimPGroup" style="display:none;">P <input type="number" class="sb-dim-input" id="sbDimP" min="0" step="0.1" value="' + (sbDims.P || '') + '" oninput="sbOnDimChange()" placeholder="0"> <span class="sb-dim-unit">po</span></label>'
                + '</div>';
            html += '</div>';

            html += '<hr class="sb-divider">';
            html += '<div class="sb-section-title">Lignes catalogue</div>';

            // Combobox
            html += '<div class="sb-combobox-wrap">'
                + '<input type="text" class="sb-combobox-input" id="sbComboInput" placeholder="Rechercher un article..." autocomplete="off">'
                + '<div class="sb-combobox-dd" id="sbComboDd"></div>'
                + '</div>';

            // Rows table
            html += '<table class="sb-rows-table">'
                + '<thead><tr><th>Article</th><th>Code</th><th style="width:70px;text-align:right">Prix</th><th style="width:55px;text-align:center">Qté</th><th style="width:75px;text-align:right">Total</th><th style="width:30px"></th></tr></thead>'
                + '<tbody id="sbRowsBody"></tbody>'
                + '</table>';

            // Subtotal
            html += '<div class="sb-subtotal-row">'
                + '<span class="sb-subtotal-label">Sous-total</span>'
                + '<span class="sb-subtotal-value" id="sbSubtotal">0,00 $</span>'
                + '</div>';

            // Actions
            html += '<div class="sb-actions">'
                + '<button class="sb-btn" onclick="sbResetSandbox()">Rétablir</button>'
                + '</div>';

            return html;
        }

        // ── Material defaults ──

        function sbMatKey(group) {
            return group.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/\s+/g, '_');
        }

        function sbSetupMaterialDropdowns() {
            sbMaterialGroups.forEach(function(group, idx) {
                var select = document.getElementById('sbMat-' + idx);
                if (!select) return;

                // Find allowed categories for this group
                var allowedCats = sbGetAllowedCategories(group);

                // Filter catalogue items by those categories
                var items = CATALOGUE_DATA.filter(function(item) {
                    if (!item.category) return false;
                    if (item.status === 'pending' || item.status === 'rejected') return false;
                    return allowedCats.length === 0 || allowedCats.indexOf(item.category) !== -1;
                });

                // Build options
                var opts = '<option value="">— Aucun —</option>';
                var byCategory = {};
                items.forEach(function(item) {
                    var cat = item.category || 'Autre';
                    if (!byCategory[cat]) byCategory[cat] = [];
                    byCategory[cat].push(item);
                });
                Object.keys(byCategory).sort().forEach(function(cat) {
                    opts += '<optgroup label="' + escapeAttr(cat) + '">';
                    byCategory[cat].forEach(function(item) {
                        var label = item.client_text || item.description || item.id;
                        var key = sbMatKey(group);
                        var sel = (sbMaterials[key] && sbMaterials[key].id === item.id) ? ' selected' : '';
                        opts += '<option value="' + escapeAttr(item.id) + '"' + sel + '>' + escapeHtml(label) + '</option>';
                    });
                    opts += '</optgroup>';
                });
                select.innerHTML = opts;
            });
        }

        function sbGetAllowedCategories(group) {
            if (!sbCategoryGroupMapping || Object.keys(sbCategoryGroupMapping).length === 0) return [];
            var allowed = [];
            for (var cat in sbCategoryGroupMapping) {
                var groups = sbCategoryGroupMapping[cat];
                if (Array.isArray(groups) && groups.indexOf(group) !== -1) {
                    allowed.push(cat);
                }
            }
            return allowed;
        }

        function sbOnMaterialChange(idx) {
            var select = document.getElementById('sbMat-' + idx);
            if (!select) return;
            var group = select.getAttribute('data-group');
            var key = sbMatKey(group);
            var itemId = select.value;
            if (itemId) {
                var item = CATALOGUE_DATA.find(function(i) { return i.id === itemId; });
                sbMaterials[key] = { id: itemId, description: item ? (item.client_text || item.description || itemId) : itemId };
            } else {
                delete sbMaterials[key];
            }

            // Re-process cascades that use $default: for this group
            sbReprocessDefaultCascades(group);

            sbRefreshDescription();
            sbRefreshAll();
        }

        function sbReprocessDefaultCascades(changedGroup) {
            var token = '$default:' + changedGroup;
            // Find parent rows whose items have cascade rules targeting this $default:
            var parentsToReprocess = [];
            sbRows.forEach(function(r) {
                if (r.cascadeOf) return; // skip children
                var item = sbGetItem(r.catalogueItemId);
                if (!item || !item.calculation_rule_ai || !item.calculation_rule_ai.cascade) return;
                var hasDynamic = item.calculation_rule_ai.cascade.some(function(c) {
                    return c.target === token;
                });
                if (hasDynamic) parentsToReprocess.push(r);
            });

            // For each affected parent: remove old cascade children and re-process
            parentsToReprocess.forEach(function(parentRow) {
                // Remove children that came from cascade (not from constraints)
                var item = sbGetItem(parentRow.catalogueItemId);
                var cascadeTargets = {};
                if (item && item.calculation_rule_ai && item.calculation_rule_ai.cascade) {
                    item.calculation_rule_ai.cascade.forEach(function(c) {
                        if (c.target) cascadeTargets[c.target] = true;
                    });
                }
                sbRows = sbRows.filter(function(r) {
                    if (r.cascadeOf !== parentRow.id) return true;
                    // Keep constraint children (auto_add etc.), remove cascade children
                    var resolved = sbResolveCascadeTarget(r.catalogueItemId);
                    // Check if this child's item matches any cascade target (resolved)
                    for (var t in cascadeTargets) {
                        var rt = sbResolveCascadeTarget(t);
                        if (rt === r.catalogueItemId || t === r.catalogueItemId) return false; // remove
                    }
                    return true;
                });
                // Re-process cascade rules only
                var rules = item.calculation_rule_ai;
                if (rules.cascade && Array.isArray(rules.cascade)) {
                    rules.cascade.forEach(function(c) {
                        if (!c.target) return;
                        var resolvedTarget = sbResolveCascadeTarget(c.target);
                        if (!resolvedTarget) return;
                        if (c.condition) {
                            var condResult = sbEvalFormula(c.condition, sbGetDimVars(parentRow.qty));
                            if (!condResult) return;
                        }
                        if (sbRows.some(function(r) { return r.catalogueItemId === resolvedTarget && r.cascadeOf === parentRow.id; })) return;
                        var qty = 1;
                        if (c.qty) {
                            var result = sbEvalFormula(String(c.qty), sbGetDimVars(parentRow.qty));
                            if (result != null && result > 0) qty = Math.round(result);
                        }
                        sbAddRow(resolvedTarget, qty, parentRow.id);
                    });
                }
            });
        }

        // ── Dimensions ──

        function sbUpdateDimsVisibility() {
            var currentId = document.getElementById('editItemId').value;
            var item = sbGetItem(currentId);
            var dc = (item && item.dims_config) ? item.dims_config : {};
            var anyDim = (dc.l !== false) || (dc.h !== false) || (dc.p !== false);
            // Only show section for fabrication items with at least one dim
            var isFab = item && item.item_type === 'fabrication';
            var section = document.getElementById('sbDimsSection');
            if (section) section.style.display = (isFab && anyDim) ? '' : 'none';
            var lG = document.getElementById('sbDimLGroup');
            var hG = document.getElementById('sbDimHGroup');
            var pG = document.getElementById('sbDimPGroup');
            if (lG) lG.style.display = (dc.l !== false) ? '' : 'none';
            if (hG) hG.style.display = (dc.h !== false) ? '' : 'none';
            if (pG) pG.style.display = (dc.p !== false) ? '' : 'none';
        }

        function sbOnDimChange() {
            var lEl = document.getElementById('sbDimL');
            var hEl = document.getElementById('sbDimH');
            var pEl = document.getElementById('sbDimP');
            sbDims.L = lEl ? (parseFloat(lEl.value) || 0) : 0;
            sbDims.H = hEl ? (parseFloat(hEl.value) || 0) : 0;
            sbDims.P = pEl ? (parseFloat(pEl.value) || 0) : 0;

            // Recalculate all cascade quantities with new dimensions
            sbRows.forEach(function(r) {
                if (r.cascadeOf) {
                    var parent = sbRows.find(function(p) { return p.id === r.cascadeOf; });
                    if (parent) sbRecalcCascadeQty(r, parent);
                }
            });
            sbRefreshAll();
        }

        function sbGetDimVars(qty) {
            return { L: sbDims.L, H: sbDims.H, P: sbDims.P, QTY: qty || 1 };
        }

        // ── Combobox ──

        function sbSetupCombobox() {
            var input = document.getElementById('sbComboInput');
            var dd = document.getElementById('sbComboDd');
            if (!input || !dd) return;

            input.addEventListener('input', function() {
                sbRenderComboboxItems(input.value.trim());
                dd.classList.add('open');
            });
            input.addEventListener('focus', function() {
                sbRenderComboboxItems(input.value.trim());
                dd.classList.add('open');
            });
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.sb-combobox-wrap')) {
                    dd.classList.remove('open');
                }
            });
        }

        function sbRenderComboboxItems(query) {
            var dd = document.getElementById('sbComboDd');
            if (!dd) return;

            var items = CATALOGUE_DATA.filter(function(item) {
                if (item.status === 'pending' || item.status === 'rejected') return false;
                if (!query) return true;
                var q = query.toLowerCase();
                return (item.description && item.description.toLowerCase().indexOf(q) !== -1)
                    || (item.id && item.id.toLowerCase().indexOf(q) !== -1)
                    || (item.client_text && item.client_text.toLowerCase().indexOf(q) !== -1);
            });

            if (items.length === 0) {
                dd.innerHTML = '<div style="padding:10px;color:#999;font-size:12px;">Aucun article trouvé</div>';
                return;
            }

            // Group by category, limit total
            var byCategory = {};
            items.slice(0, 50).forEach(function(item) {
                var cat = item.category || 'Autre';
                if (!byCategory[cat]) byCategory[cat] = [];
                byCategory[cat].push(item);
            });

            var html = '';
            Object.keys(byCategory).sort().forEach(function(cat) {
                html += '<div class="sb-cb-group">' + escapeHtml(cat) + '</div>';
                byCategory[cat].forEach(function(item) {
                    var price = sbGetPrice(item);
                    var imgHtml = item.image_url ? '<img src="' + escapeAttr(item.image_url) + '" alt="">' : '';
                    html += '<div class="sb-cb-item" onclick="sbSelectFromCombobox(\'' + escapeAttr(item.id) + '\')">'
                        + imgHtml
                        + '<span class="sb-cb-desc">' + escapeHtml(item.description || item.id) + '</span>'
                        + '<span class="sb-cb-price">' + formatPrice(price) + '</span>'
                        + '</div>';
                });
            });
            dd.innerHTML = html;
        }

        function sbSelectFromCombobox(itemId) {
            document.getElementById('sbComboDd').classList.remove('open');
            document.getElementById('sbComboInput').value = '';
            sbAddRow(itemId, 1, null);
            sbRefreshAll();
        }

        // ── Row management ──

        var _sbAddDepth = 0;
        function sbAddRow(itemId, qty, cascadeOf) {
            if (_sbAddDepth > 10) return null; // guard against infinite recursion
            var item = sbGetItem(itemId);
            if (!item) return null;

            sbRowCounter++;
            var rowData = {
                id: 'sbr-' + sbRowCounter,
                catalogueItemId: itemId,
                qty: qty || 1,
                cascadeOf: cascadeOf || null,
                warn: null
            };
            sbRows.push(rowData);

            // Process constraints for this item
            _sbAddDepth++;
            sbProcessConstraints(rowData);
            _sbAddDepth--;

            return rowData;
        }

        function sbRemoveRow(rowId) {
            // Also remove cascade children
            var childrenToRemove = sbRows.filter(function(r) { return r.cascadeOf === rowId; }).map(function(r) { return r.id; });
            childrenToRemove.forEach(function(childId) { sbRemoveRow(childId); });

            sbRows = sbRows.filter(function(r) { return r.id !== rowId; });
            sbRefreshAll();
        }

        function sbOnQtyChange(rowId, val) {
            var row = sbRows.find(function(r) { return r.id === rowId; });
            if (!row) return;
            row.qty = parseFloat(val) || 1;

            // Recalculate cascade children with formulas
            sbRows.filter(function(r) { return r.cascadeOf === rowId; }).forEach(function(child) {
                sbRecalcCascadeQty(child, row);
            });

            sbRefreshAll();
        }

        function sbRecalcCascadeQty(childRow, parentRow) {
            var parentItem = sbGetItem(parentRow.catalogueItemId);
            if (!parentItem || !parentItem.calculation_rule_ai) return;

            var rules = parentItem.calculation_rule_ai;
            // Check constraints for auto_add_calculated
            if (rules.constraints) {
                rules.constraints.forEach(function(c) {
                    if (c.type === 'auto_add_calculated' && c.item_id === childRow.catalogueItemId && c.quantity_formula) {
                        var result = sbEvalFormula(c.quantity_formula, sbGetDimVars(parentRow.qty));
                        if (result != null) childRow.qty = Math.max(1, Math.round(result));
                    }
                });
            }
            // Check cascade
            if (rules.cascade) {
                rules.cascade.forEach(function(c) {
                    var resolvedTarget = sbResolveCascadeTarget(c.target);
                    if (resolvedTarget === childRow.catalogueItemId && c.qty) {
                        var result = sbEvalFormula(String(c.qty), sbGetDimVars(parentRow.qty));
                        if (result != null) childRow.qty = Math.max(1, Math.round(result));
                    }
                });
            }
        }

        // ── Resolve $default: targets in sandbox ──

        function sbResolveCascadeTarget(target) {
            if (!target) return null;
            if (!target.startsWith('$default:')) return target;
            var groupName = target.substring(9);
            var key = sbMatKey(groupName);
            if (sbMaterials[key] && sbMaterials[key].id) return sbMaterials[key].id;
            return null;
        }

        // ── Constraint engine (simplified) ──

        function sbProcessConstraints(rowData) {
            var item = sbGetItem(rowData.catalogueItemId);
            if (!item || !item.calculation_rule_ai) return;

            var rules = item.calculation_rule_ai;

            // Process constraints
            if (rules.constraints && Array.isArray(rules.constraints)) {
                rules.constraints.forEach(function(c) {
                    switch (c.type) {
                        case 'auto_add':
                            if (c.item_id && !sbRows.some(function(r) { return r.catalogueItemId === c.item_id && r.cascadeOf === rowData.id; })) {
                                sbAddRow(c.item_id, c.quantity || 1, rowData.id);
                            }
                            break;
                        case 'auto_add_calculated':
                            if (c.item_id && !sbRows.some(function(r) { return r.catalogueItemId === c.item_id && r.cascadeOf === rowData.id; })) {
                                var qty = 1;
                                if (c.quantity_formula) {
                                    var result = sbEvalFormula(c.quantity_formula, sbGetDimVars(rowData.qty));
                                    if (result != null && result > 0) qty = Math.round(result);
                                }
                                var child = sbAddRow(c.item_id, qty, rowData.id);
                                var hasDims = sbDims.L > 0 || sbDims.H > 0 || sbDims.P > 0;
                                if (child && c.quantity_formula && !hasDims) child.warn = 'Qté calculée (sans dimensions)';
                            }
                            break;
                        case 'requires_swap':
                            rowData.warn = '⚠ Swap requis : ' + (c.warning || 'Vérifier compatibilité avec ' + (c.target_group || ''));
                            break;
                        case 'requires_choice':
                            rowData.warn = '⚠ Choix requis : ' + (c.conditions && c.conditions[0] ? c.conditions[0].message || '' : 'Vérifier les conditions');
                            break;
                    }
                });
            }

            // Process cascade
            if (rules.cascade && Array.isArray(rules.cascade)) {
                rules.cascade.forEach(function(c) {
                    if (!c.target) return;
                    // Resolve $default: targets
                    var resolvedTarget = sbResolveCascadeTarget(c.target);
                    if (!resolvedTarget) return;
                    // Evaluate condition
                    if (c.condition) {
                        var condResult = sbEvalFormula(c.condition, sbGetDimVars(rowData.qty));
                        if (!condResult) return;
                    }
                    // Check not already added
                    if (sbRows.some(function(r) { return r.catalogueItemId === resolvedTarget && r.cascadeOf === rowData.id; })) return;
                    var qty = 1;
                    if (c.qty) {
                        var result = sbEvalFormula(String(c.qty), sbGetDimVars(rowData.qty));
                        if (result != null && result > 0) qty = Math.round(result);
                    }
                    sbAddRow(resolvedTarget, qty, rowData.id);
                });
            }
        }

        // ── Description assembly ──

        function sbBuildDescription() {
            var lines = [];

            // Material defaults → section headers
            if (sbMaterials[sbMatKey('Caisson')]) {
                lines.push('CAISSON : ' + sbMaterials[sbMatKey('Caisson')].description);
            }
            if (sbMaterials[sbMatKey('Façades')]) {
                lines.push('FAÇADES : ' + sbMaterials[sbMatKey('Façades')].description);
            }
            if (sbMaterials[sbMatKey('Panneaux')]) {
                lines.push('PANNEAUX : ' + sbMaterials[sbMatKey('Panneaux')].description);
            }
            if (sbMaterials[sbMatKey('Poignées')]) {
                lines.push('POIGNÉES : ' + sbMaterials[sbMatKey('Poignées')].description);
            }

            // Articles with client_text → Détails section
            var details = [];
            sbRows.forEach(function(r) {
                var item = sbGetItem(r.catalogueItemId);
                if (item && item.client_text) {
                    // Avoid duplicates
                    if (details.indexOf(item.client_text) === -1) {
                        details.push(item.client_text);
                    }
                }
            });
            if (details.length > 0) {
                lines.push('DÉTAILS :');
                details.forEach(function(d) { lines.push('- ' + d); });
            }

            return lines.join('\n');
        }

        // ── Refresh everything ──

        function sbRefreshAll() {
            sbRefreshRows();
            sbRefreshDescription();
            sbRefreshSubtotal();
        }

        function sbRefreshRows() {
            var tbody = document.getElementById('sbRowsBody');
            if (!tbody) return;

            if (sbRows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="color:#bbb;font-size:12px;text-align:center;padding:20px;">Aucun article — utilisez la recherche ci-dessus</td></tr>';
                return;
            }

            var html = '';
            sbRows.forEach(function(r) {
                var item = sbGetItem(r.catalogueItemId);
                var price = item ? sbGetPrice(item) : 0;
                var total = price * r.qty;
                var isCascade = !!r.cascadeOf;

                html += '<tr id="' + r.id + '">';
                html += '<td class="sb-desc">' + escapeHtml(item ? item.description : r.catalogueItemId);
                if (isCascade) html += '<span class="sb-auto-tag">← auto</span>';
                if (r.warn) html += '<span class="sb-warn">' + escapeHtml(r.warn) + '</span>';
                html += '</td>';
                html += '<td class="sb-code">' + escapeHtml(r.catalogueItemId) + '</td>';
                html += '<td style="text-align:right">' + formatPrice(price) + '</td>';
                html += '<td style="text-align:center">';
                if (isCascade) {
                    html += '<span style="color:#888">' + r.qty + '</span>';
                } else {
                    html += '<input class="sb-qty-input" type="number" min="1" step="1" value="' + r.qty + '" onchange="sbOnQtyChange(\'' + r.id + '\', this.value)">';
                }
                html += '</td>';
                html += '<td style="text-align:right;font-weight:500">' + formatPrice(total) + '</td>';
                html += '<td>';
                if (!isCascade) {
                    html += '<button class="sb-remove-btn" onclick="sbRemoveRow(\'' + r.id + '\')" title="Retirer">×</button>';
                }
                html += '</td>';
                html += '</tr>';
            });
            tbody.innerHTML = html;
        }

        function sbRefreshDescription() {
            var el = document.getElementById('sbDescPreview');
            if (!el) return;
            var text = sbBuildDescription();
            if (!text.trim()) {
                el.innerHTML = '<span class="sb-desc-placeholder">Ajoutez des articles et matériaux...</span>';
            } else {
                el.innerHTML = sbFormatDescription(text);
            }
        }

        function sbRefreshSubtotal() {
            var total = 0;
            sbRows.forEach(function(r) {
                var item = sbGetItem(r.catalogueItemId);
                total += sbGetPrice(item) * r.qty;
            });
            var el = document.getElementById('sbSubtotal');
            if (el) el.textContent = formatPrice(total);
        }

        // ── Reactivity: modal edits → sandbox ──

        function sbSetupReactivity() {
            if (!sbActive) return;

            var fields = [
                { id: 'editClientText', key: 'client_text' },
                { id: 'editPrice', key: 'price' },
                { id: 'editDescription', key: 'description' }
            ];

            fields.forEach(function(f) {
                var el = document.getElementById(f.id);
                if (!el) return;
                el.addEventListener('input', function() {
                    var itemId = document.getElementById('editItemId').value;
                    if (!itemId) return;
                    if (!sbItemOverrides[itemId]) sbItemOverrides[itemId] = {};
                    sbItemOverrides[itemId][f.key] = el.value;
                    sbRefreshAll();
                });
            });

            // Composed price table input changes → refresh sandbox
            var cpMinutes = document.getElementById('cpMinutesBody');
            var cpMaterials = document.getElementById('cpMaterialsBody');
            if (cpMinutes) {
                cpMinutes.addEventListener('input', function() {
                    var itemId = document.getElementById('editItemId').value;
                    if (!itemId || !sbActive) return;
                    var lm = {};
                    cpMinutes.querySelectorAll('input[type="number"]').forEach(function(inp) {
                        var val = parseFloat(inp.value) || 0;
                        var dept = inp.getAttribute('data-dept');
                        if (val > 0 && dept) lm[dept] = val;
                    });
                    if (!sbItemOverrides[itemId]) sbItemOverrides[itemId] = {};
                    sbItemOverrides[itemId].labor_minutes = lm;
                    sbRefreshAll();
                });
            }
            if (cpMaterials) {
                cpMaterials.addEventListener('input', function() {
                    var itemId = document.getElementById('editItemId').value;
                    if (!itemId || !sbActive) return;
                    var mc = {};
                    cpMaterials.querySelectorAll('input[type="number"]').forEach(function(inp) {
                        var val = parseFloat(inp.value) || 0;
                        var cat = inp.getAttribute('data-cat');
                        if (val > 0 && cat) mc[cat] = val;
                    });
                    if (!sbItemOverrides[itemId]) sbItemOverrides[itemId] = {};
                    sbItemOverrides[itemId].material_costs = mc;
                    sbRefreshAll();
                });
            }

            // Calc rule JSON changes → reprocess constraints
            var calcRuleEl = document.getElementById('editCalcRuleAi');
            if (calcRuleEl) {
                calcRuleEl.addEventListener('input', function() {
                    var itemId = document.getElementById('editItemId').value;
                    if (!itemId || !sbActive) return;
                    try {
                        var parsed = JSON.parse(calcRuleEl.value);
                        if (!sbItemOverrides[itemId]) sbItemOverrides[itemId] = {};
                        sbItemOverrides[itemId].calculation_rule_ai = parsed;

                        // Remove old cascade children and reprocess
                        var parentRow = sbRows.find(function(r) { return r.catalogueItemId === itemId && !r.cascadeOf; });
                        if (parentRow) {
                            // Remove children
                            sbRows = sbRows.filter(function(r) { return r.cascadeOf !== parentRow.id; });
                            // Reprocess
                            sbProcessConstraints(parentRow);
                        }
                        sbRefreshAll();
                    } catch (e) { /* invalid JSON, ignore */ }
                });
            }

            // Dims config checkboxes → update sandbox dimension fields visibility
            ['editDimL', 'editDimH', 'editDimP'].forEach(function(cbId) {
                var cb = document.getElementById(cbId);
                if (cb) {
                    cb.addEventListener('change', function() {
                        var itemId = document.getElementById('editItemId').value;
                        if (!itemId || !sbActive) return;
                        if (!sbItemOverrides[itemId]) sbItemOverrides[itemId] = {};
                        sbItemOverrides[itemId].dims_config = {
                            l: document.getElementById('editDimL').checked,
                            h: document.getElementById('editDimH').checked,
                            p: document.getElementById('editDimP').checked
                        };
                        sbUpdateDimsVisibility();
                    });
                }
            });
        }

        // ═══ Animated modal open (AI unit insert) ═══
        function openEditModalAnimated(itemCode) {
            var item = CATALOGUE_DATA.find(function(i) { return i.id === itemCode; });
            if (!item) { openEditModal(itemCode); return; }

            var modal = document.getElementById('editModal');
            var progressBar = document.getElementById('editModalProgressBar');

            // Reset progress bar
            progressBar.classList.remove('done');
            progressBar.style.width = '0%';

            // Clear all fields
            document.getElementById('editItemId').value = '';
            document.getElementById('editCode').value = '';
            document.getElementById('editDescription').value = '';
            document.getElementById('editPrice').value = '';
            document.getElementById('editPriceDisplay').textContent = '';
            document.getElementById('editInstruction').value = '';
            document.getElementById('editClientText').value = '';

            // Open modal with fade animation
            modal.classList.add('anim-enter');
            modal.classList.add('active');

            // Field reveal sequence with stagger
            var fields = [
                { el: 'editCode', value: item.id, pct: 20 },
                { el: 'editDescription', value: item.description, pct: 40 },
                { el: 'editType', value: item.type, pct: 55, isSelect: true },
                { el: 'editPrice', value: item.price != null ? item.price : '', pct: 70 },
                { el: 'editClientText', value: item.client_text || '', pct: 85 },
                { el: 'editInstruction', value: item.instruction || '', pct: 100 }
            ];

            // Populate selects first (no animation on them)
            var catSelect = document.getElementById('editCategory');
            var cats = new Set(configCategories);
            CATALOGUE_DATA.forEach(function(i) { if (i.category) cats.add(i.category); });
            if (item.category && !cats.has(item.category)) cats.add(item.category);
            catSelect.innerHTML = Array.from(cats).map(function(c) { return '<option value="' + c.replace(/"/g, '&quot;') + '">' + c + '</option>'; }).join('');
            catSelect.value = item.category;
            catSelect.disabled = false;

            var typeSelect = document.getElementById('editType');
            var types = new Set(['pi\u00b2', 'unitaire', 'lin\u00e9aire', '%']);
            CATALOGUE_DATA.forEach(function(i) { if (i.type) types.add(i.type); });
            if (item.type && !types.has(item.type)) types.add(item.type);
            typeSelect.innerHTML = Array.from(types).map(function(t) { return '<option value="' + t.replace(/"/g, '&quot;') + '">' + t + '</option>'; }).join('');

            document.getElementById('editItemId').value = item.id;
            document.getElementById('editInCalculator').checked = item.in_calculator !== false;
            document.getElementById('editIsDefault').checked = item.is_default === true;
            document.getElementById('editHasSalesSheet').checked = item.has_sales_sheet === true;
            toggleSalesSheetBtn();

            // Client text + calc rules visibility
            document.getElementById('clientTextGroup').style.display = isAdmin ? '' : 'none';
            document.getElementById('calcRuleGroup').style.display = isAdmin ? '' : 'none';
            document.getElementById('presRuleGroup').style.display = isAdmin ? '' : 'none';
            clearAiFeedback('calcRuleFeedback');

            // Navigation
            if (navItemList.length === 0) buildNavList();
            updateNavButtons(item.id);

            // Reset status
            var status = document.getElementById('editStatus');
            status.className = 'edit-status';
            status.style.display = 'none';

            // Composed tables + components + media (async, no animation)
            renderComposedTables(item);
            loadComponents(item.id);
            loadSupplierCompanies();
            editMedia = [];
            editMediaToDelete = [];
            (async function() {
                try {
                    var mResp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/item_media?catalogue_item_id=eq.' + encodeURIComponent(item.id) + '&order=sort_order&select=id,file_url,file_type,tags', {});
                    if (mResp.ok) {
                        var existing = await mResp.json();
                        editMedia = existing.map(function(m) {
                            return { id: m.id, file_url: m.file_url, file_type: m.file_type || 'image', tags: m.tags || [], isNew: false };
                        });
                    }
                } catch (e) {}
                renderEditMedia();
            })();

            // Staggered field reveal
            fields.forEach(function(f, i) {
                setTimeout(function() {
                    var el = document.getElementById(f.el);
                    if (!el) return;
                    if (f.isSelect) {
                        el.value = f.value;
                    } else {
                        el.value = f.value;
                    }
                    if (f.el === 'editPrice') {
                        document.getElementById('editPriceDisplay').textContent = item.price != null ? formatPrice(item.price) : 'Calculé automatiquement';
                    }
                    // Add reveal animation to parent form-group
                    var fg = el.closest('.form-group') || el.closest('.edit-row');
                    if (fg) {
                        fg.classList.add('field-reveal');
                        fg.style.animationDelay = '0ms';
                    }
                    // Update progress bar
                    progressBar.style.width = f.pct + '%';

                    // Final step: pulse save button + fade progress
                    if (f.pct === 100) {
                        setTimeout(function() {
                            progressBar.classList.add('done');
                            var saveBtn = document.getElementById('btnEditSave');
                            if (saveBtn) {
                                saveBtn.classList.add('pulse');
                                setTimeout(function() { saveBtn.classList.remove('pulse'); }, 200);
                            }
                        }, 150);
                    }
                }, i * 110);
            });

            document.querySelector('.modal-body').scrollTop = 0;

            // Sandbox (admin only) — init after animation starts
            if (isAdmin) {
                sbItemOverrides = {};
                sbRows = [];
                sbRowCounter = 0;
                sbInitSandbox();
                sbSetupReactivity();
            }
        }

        async function deleteItem() {
            const itemId = document.getElementById('editItemId').value;

            // Si c'est un nouvel item pas encore sauvegardé, juste fermer
            if (isNewItem && newItemData) {
                closeEditModal();
                return;
            }

            var ok = await steleConfirm('Supprimer l\u2019article <strong>' + escapeHtml(itemId) + '</strong> ?<br>Cette action est irr\u00e9versible.', 'Supprimer l\u2019article', 'Supprimer');
            if (!ok) return;

            try {
                const resp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/catalogue_items?id=eq.' + encodeURIComponent(itemId), {
                    method: 'DELETE',
                    headers: { 'Prefer': 'return=minimal' }
                });

                if (!resp.ok) throw new Error('Erreur suppression: ' + resp.status);

                // Retirer de CATALOGUE_DATA
                CATALOGUE_DATA = CATALOGUE_DATA.filter(i => i.id !== itemId);
                generatePriceTables();
                closeEditModal();
            } catch (err) {
                console.error('Erreur suppression:', err);
                const status = document.getElementById('editStatus');
                status.textContent = 'Erreur: ' + err.message;
                status.style.display = '';
                status.className = 'edit-status error';
            }
        }

        // ═══ Render & manage tagged media ═══

        function renderEditMedia() {
            const list = document.getElementById('catMediaList');
            list.innerHTML = '';

            editMedia.forEach(function(media, index) {
                var item = document.createElement('div');
                item.className = 'cat-media-item';

                // Preview: image or PDF icon
                if (media.file_type === 'pdf') {
                    var pdfIcon = document.createElement('div');
                    pdfIcon.className = 'cat-pdf-icon';
                    pdfIcon.textContent = 'PDF';
                    item.appendChild(pdfIcon);
                } else {
                    var img = document.createElement('img');
                    img.src = media.file_url || media.previewUrl || '';
                    img.alt = '';
                    item.appendChild(img);
                }

                var info = document.createElement('div');
                info.className = 'cat-media-info';

                var tags = document.createElement('div');
                tags.className = 'cat-media-tags';

                mediaTagsList.forEach(function(tag) {
                    var chip = document.createElement('span');
                    chip.className = 'cat-tag' + (media.tags.indexOf(tag) !== -1 ? ' active' : '');
                    chip.textContent = tag.replace(/_/g, ' ');
                    chip.onclick = function() {
                        var idx = media.tags.indexOf(tag);
                        if (idx !== -1) {
                            media.tags.splice(idx, 1);
                        } else {
                            media.tags.push(tag);
                        }
                        chip.classList.toggle('active');
                    };
                    tags.appendChild(chip);
                });

                info.appendChild(tags);
                item.appendChild(info);

                var removeBtn = document.createElement('button');
                removeBtn.className = 'cat-media-remove';
                removeBtn.innerHTML = '&times;';
                removeBtn.title = 'Supprimer';
                removeBtn.onclick = async function() {
                    if (media.id && !media.isNew) {
                        var ok = await steleConfirm('Supprimer ce média ? Cette action sera définitive après sauvegarde.', 'Supprimer le média', 'Supprimer');
                        if (!ok) return;
                        editMediaToDelete.push({ id: media.id, file_url: media.file_url });
                    }
                    editMedia.splice(index, 1);
                    _modalDirty = true;
                    renderEditMedia();
                };
                item.appendChild(removeBtn);

                list.appendChild(item);
            });
        }

        async function handleEditMediaFiles(files) {
            var fileList = Array.from(files);
            for (var i = 0; i < fileList.length; i++) {
                var file = fileList[i];
                var isPdf = file.type === 'application/pdf';
                var isImage = file.type.startsWith('image/');
                if (!isPdf && !isImage) continue;

                if (isImage) {
                    // Open crop modal, wait for result
                    var result = await new Promise(function(resolve) {
                        openCropModal(file);
                        cropState._resolve = resolve;
                    });
                    if (!result) continue; // cancelled

                    editMedia.push({
                        id: null,
                        file_url: null,
                        previewUrl: URL.createObjectURL(result.croppedBlob),
                        file_type: 'image',
                        tags: [],
                        isNew: true,
                        file: result.croppedBlob,
                        originalFile: result.originalBlob,
                        cropRatio: result.ratio,
                        cropData: result.cropData
                    });
                    _modalDirty = true;
                    renderEditMedia();
                } else {
                    // PDF: no crop
                    editMedia.push({
                        id: null,
                        file_url: null,
                        previewUrl: null,
                        file_type: 'pdf',
                        tags: [],
                        isNew: true,
                        file: file
                    });
                    _modalDirty = true;
                    renderEditMedia();
                }
            }
        }

        // ═══ Prix composé — Rendu des tableaux minutes & matériaux ═══

        function renderComposedTables(item) {
            var laborMinutes = item.labor_minutes || {};
            var materialCosts = item.material_costs || {};

            // Tableau des minutes
            var mBody = document.getElementById('cpMinutesBody');
            var mHtml = '';
            for (var i = 0; i < tauxHoraires.length; i++) {
                var dept = tauxHoraires[i].department;
                var val = laborMinutes[dept] || '';
                mHtml += '<tr><td>' + escapeHtml(dept) + '</td>' +
                    '<td><input type="number" step="0.1" placeholder="0" value="' + val + '"' +
                    ' data-dept="' + escapeAttr(dept) + '"' +
                    (canEditMinutes ? '' : ' disabled') +
                    ' oninput="updateComposedPrice()"></td></tr>';
            }
            mBody.innerHTML = mHtml;

            // Tableau des matériaux
            var cBody = document.getElementById('cpMaterialsBody');
            var cHtml = '';
            for (var j = 0; j < expenseCategories.length; j++) {
                var cat = expenseCategories[j].name;
                var cVal = materialCosts[cat] ? parseFloat(materialCosts[cat]).toFixed(2) : '';
                cHtml += '<tr><td title="' + escapeAttr(cat) + '">' + escapeHtml(cat) + '</td>' +
                    '<td><input type="number" step="0.01" placeholder="0.00" value="' + cVal + '"' +
                    ' data-cat="' + escapeAttr(cat) + '"' +
                    (canEditMaterials ? '' : ' disabled') +
                    ' oninput="updateComposedPrice()"></td></tr>';
            }
            cBody.innerHTML = cHtml;

            updateComposedPrice();
        }

        function updateComposedPrice() {
            // Calcul main-d'œuvre
            var laborTotal = 0;
            var mInputs = document.querySelectorAll('#cpMinutesBody input[type="number"]');
            for (var i = 0; i < mInputs.length; i++) {
                var minutes = parseFloat(mInputs[i].value) || 0;
                var dept = mInputs[i].getAttribute('data-dept');
                var taux = tauxHoraires.find(function(t) { return t.department === dept; });
                var tauxHoraire = taux ? (taux.taux_horaire || 0) : 0;
                laborTotal += (minutes / 60) * tauxHoraire;
            }

            // Calcul matériaux
            var materialTotal = 0;
            var cpLossRaw = document.getElementById('cpLossOverride').value.trim();
            var cpLossOverride = cpLossRaw !== '' ? parseFloat(cpLossRaw) : null;
            var cInputs = document.querySelectorAll('#cpMaterialsBody input[type="number"]');
            for (var j = 0; j < cInputs.length; j++) {
                var cost = parseFloat(cInputs[j].value) || 0;
                var catName = cInputs[j].getAttribute('data-cat');
                var expCat = expenseCategories.find(function(c) { return c.name === catName; });
                var markup = expCat ? (expCat.markup || 0) : 0;
                var waste = cpLossOverride != null ? cpLossOverride : (expCat ? (expCat.waste || 0) : 0);
                materialTotal += cost * (1 + markup / 100 + waste / 100);
            }

            var total = laborTotal + materialTotal;
            var totalEl = document.getElementById('cpTotalValue');
            var breakdownEl = document.getElementById('cpBreakdown');

            var priceField = document.getElementById('editPrice');
            var priceDisplay = document.getElementById('editPriceDisplay');
            if (total > 0) {
                totalEl.textContent = formatPrice(total);
                breakdownEl.textContent = '(MO: ' + formatPrice(laborTotal) + ' + Mat: ' + formatPrice(materialTotal) + ')';
                priceField.value = total.toFixed(2);
                priceDisplay.textContent = formatPrice(total);
            } else {
                totalEl.textContent = '\u2014';
                breakdownEl.textContent = '';
                priceField.value = '';
                priceDisplay.textContent = 'Calculé automatiquement';
            }
        }

        function onLossOverrideChange() {
            var input = document.getElementById('cpLossOverride');
            var val = input.value.trim();
            if (val !== '' && parseFloat(val) >= 0) {
                input.classList.add('has-override');
            } else {
                input.classList.remove('has-override');
            }
            updateLossOverrideHint();
            updateComposedPrice();
        }

        function updateLossOverrideHint() {
            var input = document.getElementById('cpLossOverride');
            var hint = document.getElementById('cpLossOverrideHint');
            var val = input.value.trim();
            if (val !== '') {
                hint.textContent = 'Remplace la perte par cat\u00e9gorie';
                hint.style.color = '#e67e22';
            } else {
                var defaults = expenseCategories
                    .filter(function(c) { return c.waste > 0; })
                    .map(function(c) { return c.name + ': ' + c.waste + '%'; });
                hint.textContent = defaults.length > 0 ? 'D\u00e9faut: ' + defaults.slice(0, 3).join(', ') + (defaults.length > 3 ? '...' : '') : '';
                hint.style.color = '#999';
            }
        }

        function collectLaborMinutes() {
            var data = {};
            var inputs = document.querySelectorAll('#cpMinutesBody input[type="number"]');
            for (var i = 0; i < inputs.length; i++) {
                var val = parseFloat(inputs[i].value) || 0;
                if (val > 0) {
                    data[inputs[i].getAttribute('data-dept')] = val;
                }
            }
            return data;
        }

        function collectMaterialCosts() {
            var data = {};
            var inputs = document.querySelectorAll('#cpMaterialsBody input[type="number"]');
            for (var i = 0; i < inputs.length; i++) {
                var val = parseFloat(inputs[i].value) || 0;
                if (val > 0) {
                    data[inputs[i].getAttribute('data-cat')] = val;
                }
            }
            return data;
        }

        // ═══ Composantes fournisseur ═══

        async function loadSupplierCompanies() {
            try {
                var resp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/companies?company_type=eq.Fournisseurs&select=id,name&order=name', {});
                if (resp.ok) {
                    supplierCompanies = await resp.json();
                }
            } catch (e) { /* ignore */ }
        }

        async function loadComponents(itemId) {
            editComponents = [];
            editComponentsToDelete = [];
            if (!itemId) { renderComponents(); return; }
            try {
                var resp = await authenticatedFetch(
                    SUPABASE_URL + '/rest/v1/catalogue_item_components?catalogue_item_id=eq.' + itemId + '&order=sort_order', {}
                );
                if (resp.ok) {
                    var rows = await resp.json();
                    editComponents = rows.map(function(r) {
                        return {
                            id: r.id,
                            supplier_name: r.supplier_name || '',
                            supplier_sku: r.supplier_sku || '',
                            description: r.description || '',
                            expense_category: r.expense_category || '',
                            qty_per_unit: r.qty_per_unit != null ? r.qty_per_unit : 1,
                            unit_cost: r.unit_cost != null ? r.unit_cost : 0,
                            notes: r.notes || '',
                            sort_order: r.sort_order || 0,
                            isNew: false
                        };
                    });
                }
            } catch (e) { /* ignore */ }
            renderComponents();
            syncComponentsToMaterials();
        }

        function renderComponents() {
            var container = document.getElementById('componentsList');
            if (!container) return;
            var html = '';
            if (editComponents.length > 0) {
                html += '<div class="comp-header">' +
                    '<span class="comp-supplier-wrap">Fournisseur</span>' +
                    '<span class="comp-category">Cat&eacute;gorie</span>' +
                    '<span class="comp-sku">Code produit</span>' +
                    '<span class="comp-desc">Description</span>' +
                    '<span class="comp-qty">Qt&eacute;</span>' +
                    '<span class="comp-cost">Co&ucirc;t ($)</span>' +
                    '<span style="width:28px;flex:none;"></span>' +
                    '</div>';
            }
            // Build category options
            var catOptions = '<option value="">—</option>';
            for (var j = 0; j < expenseCategories.length; j++) {
                catOptions += '<option value="' + escapeAttr(expenseCategories[j].name) + '">' + escapeHtml(expenseCategories[j].name) + '</option>';
            }
            for (var i = 0; i < editComponents.length; i++) {
                var c = editComponents[i];
                // Category select with correct selected option
                var catSelect = '<select class="comp-category" data-field="expense_category" onchange="onComponentCategoryChange(this)">';
                catSelect += '<option value="">—</option>';
                for (var k = 0; k < expenseCategories.length; k++) {
                    var sel = (c.expense_category === expenseCategories[k].name) ? ' selected' : '';
                    catSelect += '<option value="' + escapeAttr(expenseCategories[k].name) + '"' + sel + '>' + escapeHtml(expenseCategories[k].name) + '</option>';
                }
                catSelect += '</select>';

                html += '<div class="comp-row" data-idx="' + i + '">' +
                    '<div class="comp-supplier-wrap">' +
                        '<input type="text" placeholder="Fournisseur" value="' + escapeAttr(c.supplier_name) + '" data-field="supplier_name" oninput="filterSupplierDropdown(this)" onfocus="openSupplierDropdown(this)" autocomplete="off">' +
                        '<div class="comp-supplier-dd"></div>' +
                    '</div>' +
                    catSelect +
                    '<input class="comp-sku" placeholder="Code produit" value="' + escapeAttr(c.supplier_sku) + '" data-field="supplier_sku" oninput="updateComponentField(this)">' +
                    '<input class="comp-desc" placeholder="Description" value="' + escapeAttr(c.description) + '" data-field="description" oninput="updateComponentField(this)">' +
                    '<input type="number" class="comp-qty" step="0.01" min="0" placeholder="1" value="' + (c.qty_per_unit || '') + '" data-field="qty_per_unit" oninput="updateComponentField(this); syncComponentsToMaterials()">' +
                    '<input type="number" class="comp-cost" step="0.01" min="0" placeholder="0.00" value="' + (c.unit_cost || '') + '" data-field="unit_cost" oninput="updateComponentField(this); syncComponentsToMaterials()">' +
                    '<button type="button" class="comp-remove" onclick="removeComponent(' + i + ')">&times;</button>' +
                    '</div>';
            }
            container.innerHTML = html;
        }

        // ── Supplier combobox ──

        function openSupplierDropdown(input) {
            closeAllSupplierDropdowns();
            var dd = input.parentNode.querySelector('.comp-supplier-dd');
            populateSupplierDropdown(dd, input, '');
            dd.classList.add('open');
        }

        function filterSupplierDropdown(input) {
            updateComponentField(input);
            var dd = input.parentNode.querySelector('.comp-supplier-dd');
            var filter = input.value.toLowerCase().trim();
            populateSupplierDropdown(dd, input, filter);
            if (!dd.classList.contains('open')) dd.classList.add('open');
        }

        function populateSupplierDropdown(dd, input, filter) {
            var idx = parseInt(input.closest('.comp-row').getAttribute('data-idx'));
            var currentVal = editComponents[idx].supplier_name;
            var html = '';
            var count = 0;
            for (var i = 0; i < supplierCompanies.length; i++) {
                var name = supplierCompanies[i].name;
                if (filter && name.toLowerCase().indexOf(filter) === -1) continue;
                var sel = (name === currentVal) ? ' selected' : '';
                html += '<div class="comp-dd-item' + sel + '" data-name="' + escapeAttr(name) + '" onclick="selectSupplier(this)">' + escapeHtml(name) + '</div>';
                count++;
            }
            if (count === 0 && filter) {
                html += '<div class="comp-dd-item" style="color:#999;font-style:italic;">Aucun r&eacute;sultat</div>';
            }
            html += '<div class="comp-dd-add" onclick="addNewSupplier(this)">+ Ajouter un fournisseur</div>';
            dd.innerHTML = html;
        }

        function selectSupplier(el) {
            var name = el.getAttribute('data-name');
            var row = el.closest('.comp-row');
            var input = row.querySelector('.comp-supplier-wrap input');
            var idx = parseInt(row.getAttribute('data-idx'));
            input.value = name;
            editComponents[idx].supplier_name = name;
            closeAllSupplierDropdowns();
        }

        var _supplierTargetIdx = null;

        function addNewSupplier(el) {
            var row = el.closest('.comp-row');
            _supplierTargetIdx = parseInt(row.getAttribute('data-idx'));
            closeAllSupplierDropdowns();
            // Pre-fill name from current input text
            var input = row.querySelector('.comp-supplier-wrap input');
            document.getElementById('supName').value = input.value.trim();
            document.getElementById('supAddress').value = '';
            document.getElementById('supPhone').value = '';
            document.getElementById('supEmail').value = '';
            document.getElementById('supWebsite').value = '';
            document.getElementById('supNotes').value = '';
            document.getElementById('supplierModalStatus').textContent = '';
            document.getElementById('supplierModal').classList.add('active');
            document.getElementById('supName').focus();
        }

        function closeSupplierModal() {
            document.getElementById('supplierModal').classList.remove('active');
            _supplierTargetIdx = null;
        }

        async function saveNewSupplier() {
            var name = document.getElementById('supName').value.trim();
            if (!name) {
                document.getElementById('supplierModalStatus').textContent = 'Le nom est requis.';
                document.getElementById('supplierModalStatus').className = 'edit-status error';
                document.getElementById('supplierModalStatus').style.display = '';
                return;
            }
            try {
                var resp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/companies', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                    body: JSON.stringify({
                        name: name,
                        company_type: 'Fournisseurs',
                        address: document.getElementById('supAddress').value.trim() || null,
                        phone: document.getElementById('supPhone').value.trim() || null,
                        email: document.getElementById('supEmail').value.trim() || null,
                        website: document.getElementById('supWebsite').value.trim() || null,
                        notes: document.getElementById('supNotes').value.trim() || null,
                        created_by: localStorage.getItem('sb_user_id')
                    })
                });
                if (!resp.ok) throw new Error('Erreur ' + resp.status);
                var rows = await resp.json();
                if (rows.length > 0) {
                    supplierCompanies.push({ id: rows[0].id, name: name });
                    supplierCompanies.sort(function(a, b) { return a.name.localeCompare(b.name); });
                }
                // Assign to component row
                if (_supplierTargetIdx != null && editComponents[_supplierTargetIdx]) {
                    editComponents[_supplierTargetIdx].supplier_name = name;
                    renderComponents();
                }
                closeSupplierModal();
            } catch (e) {
                document.getElementById('supplierModalStatus').textContent = 'Erreur: ' + e.message;
                document.getElementById('supplierModalStatus').className = 'edit-status error';
                document.getElementById('supplierModalStatus').style.display = '';
            }
        }

        function closeAllSupplierDropdowns() {
            document.querySelectorAll('.comp-supplier-dd.open').forEach(function(dd) { dd.classList.remove('open'); });
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.comp-supplier-wrap')) {
                closeAllSupplierDropdowns();
            }
        });

        // ── Category change with warning ──

        async function onComponentCategoryChange(select) {
            var row = select.closest('.comp-row');
            var idx = parseInt(row.getAttribute('data-idx'));
            var newCat = select.value;
            var oldCat = editComponents[idx].expense_category || '';

            // Check if new category has a manual cost and no existing components in that category
            if (newCat) {
                var existingComponentsInCat = editComponents.filter(function(c, ci) {
                    return ci !== idx && c.expense_category === newCat;
                });
                if (existingComponentsInCat.length === 0) {
                    // No other components in this category — check for manual cost
                    var matInput = document.querySelector('#cpMaterialsBody input[data-cat="' + newCat + '"]');
                    if (matInput && parseFloat(matInput.value) > 0 && !matInput.disabled) {
                        var currentCost = parseFloat(matInput.value);
                        var confirmed = await steleConfirm(
                            'La cat\u00e9gorie <strong>' + escapeHtml(newCat) + '</strong> a d\u00e9j\u00e0 un co\u00fbt manuel de' +
                            '<span class="scb-amount">' + formatPrice(currentCost) + '</span>' +
                            'En ajoutant des composantes, ce montant sera remplac\u00e9 par le total calcul\u00e9 des composantes.',
                            'Remplacer le co\u00fbt manuel ?',
                            'Oui, remplacer par les composantes'
                        );
                        if (!confirmed) {
                            select.value = oldCat;
                            return;
                        }
                    }
                }
            }

            editComponents[idx].expense_category = newCat;
            syncComponentsToMaterials();
        }

        // ── Sync components → material costs ──

        function syncComponentsToMaterials() {
            // Calculate totals per expense category from components
            var catTotals = {};
            for (var i = 0; i < editComponents.length; i++) {
                var c = editComponents[i];
                if (c.expense_category) {
                    if (!catTotals[c.expense_category]) catTotals[c.expense_category] = 0;
                    catTotals[c.expense_category] += (c.qty_per_unit || 0) * (c.unit_cost || 0);
                }
            }

            // Update material cost inputs
            var inputs = document.querySelectorAll('#cpMaterialsBody input[type="number"]');
            for (var j = 0; j < inputs.length; j++) {
                var catName = inputs[j].getAttribute('data-cat');
                var td = inputs[j].parentNode;
                if (catTotals[catName] !== undefined) {
                    // Locked — calculated from components
                    inputs[j].value = catTotals[catName].toFixed(2);
                    inputs[j].disabled = true;
                    td.classList.add('cp-locked-cell');
                } else {
                    // Unlocked — manual entry
                    td.classList.remove('cp-locked-cell');
                    if (canEditMaterials) inputs[j].disabled = false;
                }
            }
            updateComposedPrice();
        }

        function updateComponentField(input) {
            var idx = parseInt(input.closest('.comp-row').getAttribute('data-idx'));
            var field = input.getAttribute('data-field');
            if (field === 'qty_per_unit' || field === 'unit_cost') {
                editComponents[idx][field] = parseFloat(input.value) || 0;
            } else {
                editComponents[idx][field] = input.value;
            }
        }

        function addComponent() {
            editComponents.push({
                id: null, supplier_name: '', supplier_sku: '', description: '',
                expense_category: '', qty_per_unit: 1, unit_cost: 0, notes: '',
                sort_order: editComponents.length + 1, isNew: true
            });
            renderComponents();
            syncComponentsToMaterials();
            var rows = document.querySelectorAll('#componentsList .comp-row');
            if (rows.length > 0) {
                var lastRow = rows[rows.length - 1];
                var firstInput = lastRow.querySelector('.comp-supplier-wrap input');
                if (firstInput) firstInput.focus();
            }
        }

        function removeComponent(index) {
            var comp = editComponents[index];
            if (comp.id && !comp.isNew) {
                editComponentsToDelete.push(comp.id);
            }
            editComponents.splice(index, 1);
            renderComponents();
            syncComponentsToMaterials();
        }

        async function saveComponents(itemId) {
            // Delete removed components
            if (editComponentsToDelete.length > 0) {
                var ids = editComponentsToDelete.map(function(id) { return '"' + id + '"'; }).join(',');
                await authenticatedFetch(
                    SUPABASE_URL + '/rest/v1/catalogue_item_components?id=in.(' + ids + ')',
                    { method: 'DELETE', headers: { 'Prefer': 'return=minimal' } }
                );
            }
            // Upsert components
            for (var i = 0; i < editComponents.length; i++) {
                var c = editComponents[i];
                c.sort_order = i + 1;
                var payload = {
                    catalogue_item_id: itemId,
                    supplier_name: c.supplier_name || null,
                    supplier_sku: c.supplier_sku || null,
                    description: c.description || null,
                    expense_category: c.expense_category || null,
                    qty_per_unit: c.qty_per_unit || 1,
                    unit_cost: c.unit_cost || 0,
                    notes: c.notes || null,
                    sort_order: c.sort_order
                };
                if (c.isNew) {
                    await authenticatedFetch(SUPABASE_URL + '/rest/v1/catalogue_item_components', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                        body: JSON.stringify(payload)
                    });
                } else if (c.id) {
                    await authenticatedFetch(SUPABASE_URL + '/rest/v1/catalogue_item_components?id=eq.' + c.id, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                        body: JSON.stringify(payload)
                    });
                }
            }
        }

        // ═══════════════════════════════════════════
        // ── Validation proactive + Audit catalogue ──
        // ═══════════════════════════════════════════

        /** Normalize text for comparison: lowercase, no accents, no punctuation, single spaces. */
        function normalizeText(str) {
            return (str || '').toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                .replace(/['']/g, ' ')
                .replace(/[^a-z0-9\s]/g, '')
                .replace(/\s+/g, ' ').trim();
        }

        /** Levenshtein distance between two strings. */
        function levenshtein(a, b) {
            if (a.length === 0) return b.length;
            if (b.length === 0) return a.length;
            var matrix = [];
            for (var i = 0; i <= b.length; i++) matrix[i] = [i];
            for (var j = 0; j <= a.length; j++) matrix[0][j] = j;
            for (var i = 1; i <= b.length; i++) {
                for (var j = 1; j <= a.length; j++) {
                    if (b.charAt(i - 1) === a.charAt(j - 1)) matrix[i][j] = matrix[i - 1][j - 1];
                    else matrix[i][j] = Math.min(matrix[i - 1][j - 1] + 1, matrix[i][j - 1] + 1, matrix[i - 1][j] + 1);
                }
            }
            return matrix[b.length][a.length];
        }

        /** Check if item has composed price (labor or materials defined). */
        function hasComposedPrice(item) {
            var lm = item.labor_minutes || {};
            var mc = item.material_costs || {};
            var hasLabor = Object.values(lm).some(function(v) { return v > 0; });
            var hasMat = Object.values(mc).some(function(v) { return v > 0; });
            return hasLabor || hasMat;
        }

        var _saveValidationBypass = false;

        /**
         * Run proactive validation before saving. Returns true if warnings were shown
         * (save should pause for user review), false if no warnings (proceed to save).
         */
        function runSaveValidation() {
            clearAiFeedback('saveValidationFeedback');

            // If user already saw warnings and clicked save again, bypass
            if (_saveValidationBypass) {
                _saveValidationBypass = false;
                return false;
            }

            var itemId = document.getElementById('editItemId').value;
            var clientText = (document.getElementById('editClientText').value || '').trim();
            var category = document.getElementById('editCategory').value;
            var priceVal = document.getElementById('editPrice').value;

            var warnings = [];

            // Check 4: No price and no composed price
            var laborMins = collectLaborMinutes();
            var matCosts = collectMaterialCosts();
            var hasLabor = Object.values(laborMins).some(function(v) { return v > 0; });
            var hasMat = Object.values(matCosts).some(function(v) { return v > 0; });
            var hasPrice = priceVal !== '' && parseFloat(priceVal) > 0;
            if (!hasPrice && !hasLabor && !hasMat) {
                warnings.push({ level: 'error', msg: 'Aucun prix défini — ni prix fixe, ni main-d\'œuvre, ni matériaux. L\'article sera inutilisable.' });
            }

            if (clientText) {
                var normalizedCT = normalizeText(clientText);
                var sameCategory = CATALOGUE_DATA.filter(function(c) {
                    return c.category === category && c.id !== itemId;
                });

                // Outlier check: warn only if this item's client_text is a near-duplicate
                // (Levenshtein 1-3) of another item — exact duplicates are normal/intentional
                for (var si = 0; si < sameCategory.length; si++) {
                    var otherNorm = normalizeText(sameCategory[si].client_text);
                    if (!otherNorm) continue;
                    var dist = levenshtein(normalizedCT, otherNorm);
                    if (dist > 0 && dist <= 3) {
                        warnings.push({
                            level: 'warn',
                            msg: 'Texte client très similaire à ' + sameCategory[si].id + ' : « ' + (sameCategory[si].client_text || '') + ' ». Variante possible (apostrophe, espace, coquille) — vérifier.'
                        });
                        break;
                    }
                }
            } else {
                // Check 3: No client_text
                warnings.push({ level: 'info', msg: 'Pas de texte client défini. L\'article ne sera pas visible dans la présentation client.' });
            }

            if (warnings.length === 0) return false;

            // Show warnings using existing feedback pattern
            var container = document.getElementById('saveValidationFeedback');
            if (!container) return false;
            container.innerHTML = '';

            warnings.forEach(function(w) {
                var cssClass = w.level === 'error' ? 'error' : w.level === 'warn' ? 'warn' : 'info';
                var icon = w.level === 'error' ? '⚠' : w.level === 'warn' ? '⚠' : 'ℹ';
                var banner = document.createElement('div');
                banner.className = 'ai-feedback-banner ' + cssClass;
                banner.innerHTML = '<span class="ai-feedback-icon">' + icon + '</span>'
                    + '<span class="ai-feedback-text">' + escapeHtml(w.msg) + '</span>'
                    + '<span class="ai-feedback-actions"><button class="ai-feedback-btn-close" onclick="this.closest(\'.ai-feedback-banner\').remove()">&times;</button></span>';
                container.appendChild(banner);
            });

            _saveValidationBypass = true;
            return true;
        }

        // ── Audit drawer open/close ──

        function openAuditDrawer() {
            document.getElementById('auditOverlay').classList.add('active');
            document.getElementById('auditDrawer').classList.add('active');
            runFullAudit();
        }

        function closeAuditDrawer() {
            document.getElementById('auditOverlay').classList.remove('active');
            document.getElementById('auditDrawer').classList.remove('active');
        }

        /** Run full catalogue audit and render report in drawer. */
        function runFullAudit() {
            var body = document.getElementById('auditBody');
            body.innerHTML = '<div class="audit-loading">Analyse en cours…</div>';

            // Use setTimeout to let the UI render the loading state
            setTimeout(function() {
                var findings = { critical: [], warning: [], info: [] };
                var items = CATALOGUE_DATA || [];
                var stats = USAGE_STATS || [];
                var statsMap = {};
                stats.forEach(function(s) { statsMap[s.id] = s; });

                // ── Check 1: Near-duplicate client_text outliers ──
                // Exact duplicates are intentional (same text for similar items).
                // Flag only VARIANTS: items whose client_text differs by Levenshtein 1-3
                // from another item in the same category (typo, missing apostrophe, etc.)
                var ctGrouped = {};
                items.forEach(function(item) {
                    var ct = normalizeText(item.client_text);
                    if (!ct) return;
                    var key = item.category + '::' + ct;
                    if (!ctGrouped[key]) ctGrouped[key] = [];
                    ctGrouped[key].push(item);
                });
                // Compare distinct normalized texts within each category
                var catTexts = {};
                Object.keys(ctGrouped).forEach(function(key) {
                    var cat = key.split('::')[0];
                    var norm = key.split('::').slice(1).join('::');
                    if (!catTexts[cat]) catTexts[cat] = [];
                    catTexts[cat].push({ norm: norm, items: ctGrouped[key] });
                });
                var outlierItems = [];
                Object.keys(catTexts).forEach(function(cat) {
                    var entries = catTexts[cat];
                    for (var ai = 0; ai < entries.length; ai++) {
                        for (var bi = ai + 1; bi < entries.length; bi++) {
                            var dist = levenshtein(entries[ai].norm, entries[bi].norm);
                            if (dist > 0 && dist <= 3) {
                                // Flag the smaller group as the outlier (minority variant)
                                var majority = entries[ai].items.length >= entries[bi].items.length ? entries[ai] : entries[bi];
                                var minority = entries[ai].items.length < entries[bi].items.length ? entries[ai] : entries[bi];
                                minority.items.forEach(function(item) {
                                    var majorityText = majority.items[0].client_text || '';
                                    outlierItems.push({
                                        id: item.id,
                                        desc: item.description,
                                        detail: '« ' + (item.client_text || '') + ' » — variante probable de « ' + majorityText + ' »'
                                    });
                                });
                            }
                        }
                    }
                });
                if (outlierItems.length > 0) {
                    findings.warning.push({
                        title: 'Variantes texte client suspectes (' + outlierItems.length + ')',
                        items: outlierItems
                    });
                }

                // ── Check 2: No client_text ──
                var noClientText = items.filter(function(i) { return !i.client_text || !i.client_text.trim(); });
                if (noClientText.length > 0) {
                    findings.info.push({
                        title: 'Articles sans texte client (' + noClientText.length + ')',
                        items: noClientText.map(function(i) { return { id: i.id, desc: i.description, detail: i.category }; })
                    });
                }

                // ── Check 3: No price (fixed or composed) ──
                var noPrice = items.filter(function(i) {
                    var hasFixed = i.price != null && i.price > 0;
                    return !hasFixed && !hasComposedPrice(i);
                });
                if (noPrice.length > 0) {
                    findings.critical.push({
                        title: 'Articles sans prix (' + noPrice.length + ')',
                        items: noPrice.map(function(i) { return { id: i.id, desc: i.description, detail: i.category }; })
                    });
                }

                // ── Check 4: Unclassified category ──
                var unclassified = items.filter(function(i) {
                    return !i.category || i.category === 'Non classé' || i.category.trim() === '';
                });
                if (unclassified.length > 0) {
                    findings.warning.push({
                        title: 'Catégorie non classée (' + unclassified.length + ')',
                        items: unclassified.map(function(i) { return { id: i.id, desc: i.description, detail: 'Non classé' }; })
                    });
                }

                // ── Check 5: Spelling inconsistencies (Levenshtein < 3, same category) ──
                var spellingIssues = [];
                var checkedPairs = {};
                var byCat = {};
                items.forEach(function(i) {
                    if (!i.client_text) return;
                    if (!byCat[i.category]) byCat[i.category] = [];
                    byCat[i.category].push(i);
                });
                Object.keys(byCat).forEach(function(cat) {
                    var catItems = byCat[cat];
                    for (var a = 0; a < catItems.length; a++) {
                        var normA = normalizeText(catItems[a].client_text);
                        if (!normA) continue;
                        for (var b = a + 1; b < catItems.length; b++) {
                            var normB = normalizeText(catItems[b].client_text);
                            if (!normB || normA === normB) continue;
                            var pairKey = catItems[a].id + ':' + catItems[b].id;
                            if (checkedPairs[pairKey]) continue;
                            checkedPairs[pairKey] = true;
                            var dist = levenshtein(normA, normB);
                            if (dist > 0 && dist <= 3) {
                                spellingIssues.push({
                                    items: [
                                        { id: catItems[a].id, desc: catItems[a].description, detail: '« ' + catItems[a].client_text + ' »' },
                                        { id: catItems[b].id, desc: catItems[b].description, detail: '« ' + catItems[b].client_text + ' »' }
                                    ]
                                });
                            }
                        }
                    }
                });
                if (spellingIssues.length > 0) {
                    spellingIssues.forEach(function(issue) {
                        findings.warning.push({
                            title: 'Orthographe similaire',
                            items: issue.items
                        });
                    });
                }

                // ── Check 6: Never used items ──
                var neverUsed = items.filter(function(i) {
                    var s = statsMap[i.id];
                    return !s || s.usage_count === 0;
                });
                if (neverUsed.length > 0) {
                    findings.info.push({
                        title: 'Jamais utilisés (' + neverUsed.length + ')',
                        items: neverUsed.map(function(i) { return { id: i.id, desc: i.description, detail: i.category }; })
                    });
                }

                // ── Check 7: Dormant items (> 60 days) ──
                var dormant = items.filter(function(i) {
                    var s = statsMap[i.id];
                    return s && s.usage_count > 0 && s.days_since_used > 60;
                });
                if (dormant.length > 0) {
                    findings.info.push({
                        title: 'Dormants (> 60 jours) (' + dormant.length + ')',
                        items: dormant.map(function(i) {
                            var s = statsMap[i.id];
                            return { id: i.id, desc: i.description, detail: Math.round(s.days_since_used) + 'j, ' + s.usage_count + '×' };
                        })
                    });
                }

                renderAuditReport(body, findings, items.length);
            }, 50);
        }

        /** Render the audit report in the drawer. */
        function renderAuditReport(container, findings, totalItems) {
            var totalCritical = 0, totalWarning = 0, totalInfo = 0;
            findings.critical.forEach(function(f) { totalCritical += f.items.length; });
            findings.warning.forEach(function(f) { totalWarning += f.items.length; });
            findings.info.forEach(function(f) { totalInfo += f.items.length; });

            var html = '';

            // Summary bar
            html += '<div class="audit-summary">'
                + '<div class="audit-summary-item"><span class="audit-section-dot critical"></span> ' + totalCritical + ' critique' + (totalCritical > 1 ? 's' : '') + '</div>'
                + '<div class="audit-summary-item"><span class="audit-section-dot warning"></span> ' + totalWarning + ' attention</div>'
                + '<div class="audit-summary-item"><span class="audit-section-dot info"></span> ' + totalInfo + ' info</div>'
                + '<div class="audit-summary-item" style="color:#94a3b8;">' + totalItems + ' articles total</div>'
                + '</div>';

            var allSections = [
                { level: 'critical', label: 'CRITIQUE', items: findings.critical },
                { level: 'warning', label: 'ATTENTION', items: findings.warning },
                { level: 'info', label: 'INFO', items: findings.info }
            ];

            allSections.forEach(function(section) {
                if (section.items.length === 0) return;
                section.items.forEach(function(finding) {
                    html += '<div class="audit-section">';
                    html += '<div class="audit-section-header" onclick="this.parentElement.classList.toggle(\'collapsed\')">';
                    html += '<span class="audit-section-dot ' + section.level + '"></span>';
                    html += '<span class="audit-section-title">' + escapeHtml(finding.title) + '</span>';
                    html += '<span class="audit-section-count">' + finding.items.length + '</span>';
                    html += '<span class="audit-section-chevron">▼</span>';
                    html += '</div>';
                    var groupIds = finding.items.map(function(i) { return i.id; });
                    var groupIdsAttr = escapeAttr(JSON.stringify(groupIds));
                    html += '<div class="audit-section-items">';
                    finding.items.forEach(function(item) {
                        html += '<div class="audit-item" onclick="openEditModalScoped(\'' + escapeAttr(item.id) + '\',' + groupIdsAttr + ')">';
                        html += '<span class="audit-item-code">' + escapeHtml(item.id) + '</span>';
                        html += '<span class="audit-item-desc">' + escapeHtml(item.desc) + '</span>';
                        if (item.detail) html += '<span class="audit-item-detail">' + escapeHtml(item.detail) + '</span>';
                        html += '</div>';
                    });
                    html += '</div>';
                    html += '</div>';
                });
            });

            if (totalCritical === 0 && totalWarning === 0 && totalInfo === 0) {
                html += '<div class="audit-empty">Aucun problème détecté. Le catalogue est en ordre.</div>';
            }

            container.innerHTML = html;
        }

        async function saveEditModal(silent) {
            // Validate: components must have a supplier name
            for (var v = 0; v < editComponents.length; v++) {
                if (!editComponents[v].supplier_name || !editComponents[v].supplier_name.trim()) {
                    var rows = document.querySelectorAll('#componentsList .comp-row');
                    if (rows[v]) {
                        var inp = rows[v].querySelector('.comp-supplier-wrap input');
                        if (inp) { inp.focus(); inp.style.borderColor = '#c62828'; }
                    }
                    var valErr = document.getElementById('editStatus');
                    valErr.textContent = 'Le fournisseur est requis pour chaque composante.';
                    valErr.style.display = '';
                    valErr.className = 'edit-status error';
                    return;
                }
            }

            // Validate JSON in calc rule AI field if non-empty
            var calcRuleAiRaw = document.getElementById('editCalcRuleAi').value.trim();
            if (calcRuleAiRaw) {
                try { JSON.parse(calcRuleAiRaw); } catch (e) {
                    showAiFeedback('calcRuleFeedback', { status: 'error', warnings: ['JSON invalide dans la r\u00e8gle AI : ' + e.message] });
                    document.getElementById('editCalcRuleAi').focus();
                    return;
                }
            }

            // Proactive validation (non-blocking — shows warnings, user re-clicks to proceed)
            if (!silent && runSaveValidation()) return;

            const btn = document.getElementById('btnEditSave');
            const status = document.getElementById('editStatus');
            btn.disabled = true;
            btn.textContent = 'Sauvegarde...';
            status.style.display = 'none';

            try {
                const itemId = document.getElementById('editItemId').value;
                const priceVal = document.getElementById('editPrice').value;

                const payload = {
                    category: document.getElementById('editCategory').value,
                    item_type: document.getElementById('editItemType').value || null,
                    dims_config: document.getElementById('editItemType').value === 'fabrication'
                        ? { l: document.getElementById('editDimL').checked, h: document.getElementById('editDimH').checked, p: document.getElementById('editDimP').checked }
                        : null,
                    description: document.getElementById('editDescription').value,
                    type: document.getElementById('editType').value,
                    price: priceVal !== '' ? parseFloat(priceVal) : null,
                    instruction: document.getElementById('editInstruction').value,
                    in_calculator: document.getElementById('editInCalculator').checked,
                    is_default: document.getElementById('editIsDefault').checked,
                    has_sales_sheet: document.getElementById('editHasSalesSheet').checked,
                    labor_minutes: collectLaborMinutes(),
                    material_costs: collectMaterialCosts(),
                    loss_override_pct: (function() {
                        var v = document.getElementById('cpLossOverride').value.trim();
                        return v !== '' ? parseFloat(v) : null;
                    })(),
                    calculation_rule_human: document.getElementById('editCalcRuleHuman').value || null,
                    calculation_rule_ai: (function() {
                        var v = document.getElementById('editCalcRuleAi').value.trim();
                        if (!v) return null;
                        try { return JSON.parse(v); } catch(e) { return null; }
                    })(),
                    client_text: document.getElementById('editClientText').value || null,
                    presentation_rule_human: document.getElementById('editPresRuleHuman').value || null,
                    presentation_rule: (function() {
                        var v = document.getElementById('editPresRuleAi').value.trim();
                        if (!v) return null;
                        try { return JSON.parse(v); } catch(e) { return null; }
                    })()
                };

                // Proposal context (constraints + notes for approver)
                var propConstraints = document.getElementById('editPropConstraints').value.trim();
                var propNotes = document.getElementById('editPropNotes').value.trim();
                if (propConstraints || propNotes) {
                    var pCtx = {};
                    if (propConstraints) pCtx.constraints = propConstraints;
                    if (propNotes) pCtx.notes_for_approver = propNotes;
                    payload.proposal_context = pCtx;
                } else {
                    payload.proposal_context = null;
                }

                let resp;
                if (isNewItem && newItemData) {
                    // Nouvel item : POST sans id (le trigger DB genere le code ST-XXXX)
                    const createPayload = Object.assign({ sort_order: newItemData.sort_order }, payload);
                    // Non-editors proposing: auto-set pending status
                    if (!canEditCatalogue) {
                        createPayload.status = 'pending';
                        createPayload.proposed_by = (localStorage.getItem('sb_user_email') || '').toLowerCase();
                        createPayload.in_calculator = true;
                    }
                    resp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/catalogue_items', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify(createPayload)
                    });

                    if (!resp.ok) throw new Error('Erreur cr\u00e9ation: ' + resp.status);

                    const data = await resp.json();
                    var serverItem = data[0];
                    CATALOGUE_DATA.push(serverItem);
                    // Mettre a jour itemId avec le code genere par le serveur
                    itemId = serverItem.id;

                    // Auto-fill calc/pres rules from templates (non-blocking)
                    if (!serverItem.calculation_rule_ai && !serverItem.presentation_rule && getAllRulesTemplates()) {
                        autoGenerateBaseRules(serverItem);
                    }
                } else {
                    // Item existant : PATCH
                    resp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/catalogue_items?id=eq.' + itemId, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!resp.ok) throw new Error('Erreur sauvegarde: ' + resp.status);

                    const item = CATALOGUE_DATA.find(i => i.id === itemId);
                    if (item) {
                        Object.assign(item, payload);
                    }
                }

                // ── Sauvegarder les médias ──

                // 1. Supprimer les médias retirés
                for (var mi = 0; mi < editMediaToDelete.length; mi++) {
                    var del = editMediaToDelete[mi];
                    await authenticatedFetch(SUPABASE_URL + '/rest/v1/item_media?id=eq.' + del.id, {
                        method: 'DELETE',
                        headers: { 'Prefer': 'return=minimal' }
                    });
                    // Tenter de supprimer du Storage aussi
                    if (del.file_url && del.file_url.indexOf('/fiche-images/') !== -1) {
                        var storagePath = del.file_url.split('/fiche-images/')[1];
                        if (storagePath) {
                            await authenticatedFetch(SUPABASE_URL + '/storage/v1/object/fiche-images/' + storagePath, {
                                method: 'DELETE'
                            }).catch(function() {});
                        }
                    }
                }
                editMediaToDelete = [];

                // 2. Upload nouveaux médias + insert item_media
                for (var mi2 = 0; mi2 < editMedia.length; mi2++) {
                    var m = editMedia[mi2];

                    if (m.isNew && m.file) {
                        var ts = Date.now();
                        var fileUrl;
                        var originalUrl = null;

                        if (m.originalFile) {
                            // Cropped image: upload original + cropped separately
                            var origPath = 'originals/' + itemId + '/' + ts + '.jpg';
                            var origResp = await authenticatedFetch(SUPABASE_URL + '/storage/v1/object/fiche-images/' + origPath, {
                                method: 'POST',
                                headers: { 'Content-Type': 'image/jpeg', 'x-upsert': 'true' },
                                body: m.originalFile
                            });
                            if (!origResp.ok) throw new Error('Erreur upload original: ' + origResp.status);
                            originalUrl = SUPABASE_URL + '/storage/v1/object/public/fiche-images/' + origPath;

                            var cropPath = itemId + '/' + ts + '_' + (m.cropRatio || '16x9').replace(':', 'x') + '.jpg';
                            var cropResp = await authenticatedFetch(SUPABASE_URL + '/storage/v1/object/fiche-images/' + cropPath, {
                                method: 'POST',
                                headers: { 'Content-Type': 'image/jpeg', 'x-upsert': 'true' },
                                body: m.file
                            });
                            if (!cropResp.ok) throw new Error('Erreur upload crop: ' + cropResp.status);
                            fileUrl = SUPABASE_URL + '/storage/v1/object/public/fiche-images/' + cropPath;
                        } else {
                            // Non-cropped file (PDF): upload as before
                            var ext = m.file.name ? m.file.name.split('.').pop().toLowerCase() : 'bin';
                            var path = itemId + '/' + ts + '_' + mi2 + '.' + ext;
                            var uploadResp = await authenticatedFetch(SUPABASE_URL + '/storage/v1/object/fiche-images/' + path, {
                                method: 'POST',
                                headers: { 'Content-Type': m.file.type || 'application/octet-stream', 'x-upsert': 'true' },
                                body: m.file
                            });
                            if (!uploadResp.ok) throw new Error('Erreur upload: ' + uploadResp.status);
                            fileUrl = SUPABASE_URL + '/storage/v1/object/public/fiche-images/' + path;
                        }

                        var insertPayload = {
                            catalogue_item_id: itemId,
                            file_url: fileUrl,
                            file_type: m.file_type,
                            tags: m.tags,
                            sort_order: mi2
                        };
                        if (originalUrl) insertPayload.original_url = originalUrl;
                        if (m.cropRatio) insertPayload.crop_ratio = m.cropRatio;
                        if (m.cropData) insertPayload.crop_data = m.cropData;

                        var insertResp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/item_media', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                            body: JSON.stringify(insertPayload)
                        });
                        if (!insertResp.ok) throw new Error('Erreur insertion m\u00e9dia: ' + insertResp.status);

                        var insertedData = await insertResp.json();
                        m.id = insertedData[0].id;
                        m.file_url = fileUrl;
                        m.isNew = false;
                        m.file = null;
                        m.originalFile = null;
                        m.previewUrl = null;
                    } else if (m.id && !m.isNew) {
                        // Mettre à jour tags
                        await authenticatedFetch(SUPABASE_URL + '/rest/v1/item_media?id=eq.' + m.id, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                            body: JSON.stringify({ tags: m.tags, sort_order: mi2 })
                        });
                    }
                }

                // 3. Auto-sync image_url depuis le premier média tagué "catalogue"
                var catalogueMedia = editMedia.find(function(m) { return m.tags.indexOf('catalogue') !== -1 && m.file_type === 'image'; });
                var syncImageUrl = catalogueMedia ? catalogueMedia.file_url : null;
                var currentItem = CATALOGUE_DATA.find(function(i) { return i.id === itemId; });
                if (currentItem && currentItem.image_url !== syncImageUrl) {
                    await authenticatedFetch(SUPABASE_URL + '/rest/v1/catalogue_items?id=eq.' + itemId, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                        body: JSON.stringify({ image_url: syncImageUrl })
                    });
                    if (currentItem) currentItem.image_url = syncImageUrl;
                }

                // 4. Sauver les composantes fournisseur
                await saveComponents(itemId);

                // Re-générer les tables
                generatePriceTables();

                // In embedded mode, notify parent with updated item and close
                if (isEmbedded && window.parent !== window) {
                    var savedItem = CATALOGUE_DATA.find(function(i) { return i.id === itemId; });
                    window.parent.postMessage({
                        type: 'catalogue-item-saved',
                        item: savedItem ? JSON.parse(JSON.stringify(savedItem)) : null
                    }, '*');
                    return;
                }

                // Reset dirty tracking after successful save
                _modalSnapshot = captureModalSnapshot();
                _modalDirty = false;

                if (!silent) {
                    status.textContent = '\u2713 Sauvegardé';
                    status.style.display = '';
                    status.className = 'edit-status success';

                    setTimeout(() => closeEditModal(), 800);
                }
            } catch (err) {
                console.error('Erreur sauvegarde:', err);
                status.textContent = 'Erreur: ' + err.message;
                status.style.display = '';
                status.className = 'edit-status error';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Sauvegarder';
            }
        }

        // Setup des handlers de la modal d'édition
        function setupEditModalHandlers() {
            const zone = document.getElementById('catDropzone');
            const input = document.getElementById('catMediaInput');

            zone.addEventListener('click', () => input.click());

            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                zone.classList.add('dragover');
            });

            zone.addEventListener('dragleave', () => {
                zone.classList.remove('dragover');
            });

            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('dragover');
                handleEditMediaFiles(e.dataTransfer.files);
            });

            input.addEventListener('change', () => {
                handleEditMediaFiles(input.files);
                input.value = '';
            });

            // Fermer modal au clic extérieur (sauf si le drawer AI est ouvert)
            document.getElementById('editModal').addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-overlay')) {
                    var drawerOpen = document.getElementById('ciDrawer') && document.getElementById('ciDrawer').classList.contains('active');
                    if (!drawerOpen) guardedCloseEditModal();
                }
            });

            // Fermer modal avec Escape (sauf si drawer AI ouvert ou confirmation affichée)
            document.addEventListener('keydown', function(e) {
                if (e.key !== 'Escape') return;
                // Don't intercept if unsaved confirmation dialog is showing
                if (document.querySelector('.unsaved-confirm-overlay')) return;
                var modal = document.getElementById('editModal');
                if (!modal || !modal.classList.contains('active')) return;
                var drawerOpen = document.getElementById('ciDrawer') && document.getElementById('ciDrawer').classList.contains('active');
                if (drawerOpen) return;
                e.preventDefault();
                guardedCloseEditModal();
            });
        }

        // ═══════════════════════════════════════════════════════════════════════
        // IMPORTATEUR CATALOGUE (AI CHAT)
        // ═══════════════════════════════════════════════════════════════════════

        var ciConversation = [];
        var ciPendingImages = [];
        var ciPendingToolCalls = null;
        var ciChatLoaded = false;
        var filterPendingOnly = false;

        function toggleImportDrawer() {
            var drawer = document.getElementById('ciDrawer');
            if (drawer.classList.contains('active')) closeImportDrawer();
            else openImportDrawer();
        }

        function openImportDrawer() {
            document.getElementById('ciOverlay').classList.add('active');
            document.getElementById('ciDrawer').classList.add('active');
            document.getElementById('navImportBtn').classList.add('active');
            if (!ciChatLoaded) {
                ciChatLoaded = true;
                loadCiChat();
            }
            setTimeout(function() {
                var inp = document.getElementById('ciInput');
                if (inp) inp.focus({ preventScroll: true });
            }, 300);
        }

        function closeImportDrawer() {
            document.getElementById('ciOverlay').classList.remove('active');
            document.getElementById('ciDrawer').classList.remove('active');
            document.getElementById('navImportBtn').classList.remove('active');
        }

        async function saveCiChatMessage(role, content) {
            try {
                await authenticatedFetch(SUPABASE_URL + '/rest/v1/chat_messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                    body: JSON.stringify({ context_type: 'catalogue', role: role, content: content || '' })
                });
            } catch (e) { console.warn('[CI] Failed to save chat message:', e); }
        }

        async function loadCiChat() {
            try {
                var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/chat_messages?context_type=eq.catalogue&order=created_at.desc&limit=20&select=role,content,created_at', {});
                if (!r.ok) return;
                var msgs = await r.json();
                if (msgs.length === 0) return;

                msgs.reverse();

                var container = document.getElementById('ciMessages');
                container.innerHTML = '';

                msgs.forEach(function(msg) {
                    appendCiMessage(msg.role, msg.content);
                });

                // Rebuild ciConversation from loaded messages
                ciConversation = [];
                msgs.forEach(function(msg) {
                    if (msg.role === 'user' || msg.role === 'assistant') {
                        ciConversation.push({ role: msg.role, content: msg.content });
                    }
                });

                // Hide quick actions since we have history
                var qa = document.getElementById('ciQuickActions');
                if (qa) qa.style.display = 'none';

                // Scroll to bottom
                container.scrollTop = container.scrollHeight;
            } catch (e) { console.warn('[CI] Failed to load chat:', e); }
        }

        function setupImportDrawerHandlers() {
            var input = document.getElementById('ciInput');
            var dropZone = document.getElementById('ciDropZone');
            var drawer = document.getElementById('ciDrawer');

            if (input) {
                input.addEventListener('paste', function(e) {
                    var items = (e.clipboardData || {}).items || [];
                    for (var i = 0; i < items.length; i++) {
                        if (items[i].type.indexOf('image') !== -1) {
                            e.preventDefault();
                            ciProcessImage(items[i].getAsFile());
                            break;
                        }
                    }
                });
            }

            if (drawer) {
                drawer.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    dropZone.classList.add('active');
                });
                drawer.addEventListener('dragleave', function(e) {
                    if (!drawer.contains(e.relatedTarget)) dropZone.classList.remove('active');
                });
                drawer.addEventListener('drop', function(e) {
                    e.preventDefault();
                    dropZone.classList.remove('active');
                    var files = e.dataTransfer.files;
                    for (var i = 0; i < files.length; i++) {
                        if (files[i].type.indexOf('image') !== -1) {
                            ciProcessImage(files[i]);
                        }
                    }
                });
            }
        }

        function ciProcessImage(file) {
            var reader = new FileReader();
            reader.onload = function(e) {
                var img = new Image();
                img.onload = function() {
                    var canvas = document.createElement('canvas');
                    var maxDim = 1200;
                    var w = img.width, h = img.height;
                    if (w > maxDim || h > maxDim) {
                        if (w > h) { h = Math.round(h * maxDim / w); w = maxDim; }
                        else { w = Math.round(w * maxDim / h); h = maxDim; }
                    }
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    ciPendingImages.push(canvas.toDataURL('image/jpeg', 0.8));
                    renderCiImagePreviews();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function renderCiImagePreviews() {
            var container = document.getElementById('ciImgPreview');
            container.innerHTML = '';
            ciPendingImages.forEach(function(src, i) {
                var div = document.createElement('div');
                div.className = 'ci-img-thumb';
                div.innerHTML = '<img src="' + src + '"><button class="ci-img-remove" onclick="ciRemoveImage(' + i + ')">&times;</button>';
                container.appendChild(div);
            });
        }

        function ciRemoveImage(index) {
            ciPendingImages.splice(index, 1);
            renderCiImagePreviews();
        }

        function ciInputKeydown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendImportMessage();
            }
        }

        function ciQuickAction(text) {
            document.getElementById('ciInput').value = text;
            document.getElementById('ciInput').focus();
        }

        function appendCiMessage(role, content, opts) {
            opts = opts || {};
            var container = document.getElementById('ciMessages');
            var div = document.createElement('div');

            if (role === 'confirm') {
                div.className = 'ci-msg ci-msg-confirm';
                var confirmId = 'ci-confirm-' + Date.now();
                div.id = confirmId;
                div.innerHTML = '<div class="ci-confirm-text">' + renderCiMarkdown(content) + '</div>' +
                    '<div class="ci-confirm-actions">' +
                    '<button class="btn-ci-apply" onclick="ciApplyPending(\'' + confirmId + '\')">Cr\u00e9er les articles</button>' +
                    '<button class="btn-ci-dismiss" onclick="ciDismissPending(\'' + confirmId + '\')">Ignorer</button>' +
                    '</div>';
                container.appendChild(div);
            } else {
                div.className = 'ci-msg ci-msg-' + role;
                if (role === 'user' && opts.images && opts.images.length > 0) {
                    var imgHtml = opts.images.map(function(src) {
                        return '<img src="' + src + '" style="max-width:100%;border-radius:8px;margin-bottom:6px;">';
                    }).join('');
                    div.innerHTML = imgHtml + renderCiMarkdown(content);
                } else {
                    div.innerHTML = renderCiMarkdown(content);
                }
                container.appendChild(div);
            }

            var isNearBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 80;
            if (isNearBottom) container.scrollTop = container.scrollHeight;
        }

        function renderCiMarkdown(text) {
            if (!text) return '';
            var s = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            // Code blocks
            s = s.replace(/```([\s\S]*?)```/g, '<pre>$1</pre>');
            // Inline code
            s = s.replace(/`([^`]+)`/g, '<code>$1</code>');
            // Bold
            s = s.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            // Italic
            s = s.replace(/\*(.+?)\*/g, '<em>$1</em>');
            // Tables → cards (with stagger animation)
            s = s.replace(/((?:\|.*\|\n?)+)/g, function(table) {
                var rows = table.trim().split('\n').filter(function(r) { return r.trim() && !/^\|[\s\-:]+\|$/.test(r); });
                if (rows.length === 0) return table;
                var headers = rows[0].split('|').filter(function(c) { return c.trim() !== ''; }).map(function(c) { return c.trim().toLowerCase(); });
                var codeIdx = -1, descIdx = -1, priceIdx = -1;
                headers.forEach(function(h, i) {
                    var hl = h.toLowerCase();
                    if (codeIdx < 0 && (hl === 'code' || hl === 'id' || hl.indexOf('code') >= 0)) codeIdx = i;
                    if (descIdx < 0 && (hl === 'description' || hl.indexOf('desc') >= 0 || hl === 'article' || hl === 'nom')) descIdx = i;
                    if (priceIdx < 0 && (hl === 'prix' || hl === 'price' || hl.indexOf('prix') >= 0 || hl.indexOf('total') >= 0 || hl === 'montant')) priceIdx = i;
                });
                if (descIdx >= 0 && rows.length > 1) {
                    var cards = '';
                    for (var ri = 1; ri < rows.length; ri++) {
                        var cells = rows[ri].split('|').filter(function(c) { return c.trim() !== ''; }).map(function(c) { return c.trim(); });
                        var code = codeIdx >= 0 && cells[codeIdx] ? cells[codeIdx] : '';
                        var desc = cells[descIdx] || '';
                        var price = priceIdx >= 0 && cells[priceIdx] ? cells[priceIdx] : '';
                        var meta = [];
                        headers.forEach(function(h, i) {
                            if (i !== codeIdx && i !== descIdx && i !== priceIdx && cells[i] && cells[i].trim()) {
                                meta.push(h.charAt(0).toUpperCase() + h.slice(1) + ': ' + cells[i]);
                            }
                        });
                        var delay = (ri - 1) * 40;
                        cards += '<div class="ci-card" style="animation-delay:' + delay + 'ms">';
                        if (code || price) {
                            cards += '<div class="ci-card-row">';
                            cards += code ? '<span class="ci-card-code">' + code + '</span>' : '<span></span>';
                            cards += price ? '<span class="ci-card-price">' + price + '</span>' : '';
                            cards += '</div>';
                        }
                        if (desc) cards += '<div class="ci-card-desc">' + desc + '</div>';
                        if (meta.length) cards += '<div class="ci-card-meta">' + meta.join(' &middot; ') + '</div>';
                        cards += '</div>';
                    }
                    return '<div class="ci-card-stack">' + cards + '</div>';
                }
                // Fallback: soft-styled table
                var html = '<table>';
                rows.forEach(function(row, i) {
                    var cells = row.split('|').filter(function(c) { return c.trim() !== ''; });
                    var tag = i === 0 ? 'th' : 'td';
                    html += '<tr>' + cells.map(function(c) { return '<' + tag + '>' + c.trim() + '</' + tag + '>'; }).join('') + '</tr>';
                });
                html += '</table>';
                return html;
            });
            // Unordered lists
            s = s.replace(/^[•\-\*] (.+)$/gm, '<li>$1</li>');
            s = s.replace(/((?:<li>.*<\/li>\n?)+)/g, '<ul>$1</ul>');
            // Paragraphs
            s = s.replace(/\n{2,}/g, '</p><p>');
            s = s.replace(/\n/g, '<br>');
            s = '<p>' + s + '</p>';
            s = s.replace(/<p><\/p>/g, '');
            return s;
        }

        function buildCiUserContent(text, images) {
            if (!images || images.length === 0) return text;
            var content = [];
            images.forEach(function(dataUrl) {
                var match = dataUrl.match(/^data:(.*?);base64,(.*)$/);
                if (match) {
                    content.push({
                        type: 'image',
                        source: { type: 'base64', media_type: match[1], data: match[2] }
                    });
                }
            });
            if (text) content.push({ type: 'text', text: text });
            return content;
        }

        function collectImportContext() {
            // Categories
            var cats = new Set(configCategories);
            CATALOGUE_DATA.forEach(function(i) { if (i.category) cats.add(i.category); });

            // Existing codes grouped by prefix
            var existingCodes = {};
            CATALOGUE_DATA.forEach(function(i) {
                if (!i.id) return;
                var parts = i.id.split('-');
                if (parts.length === 2) {
                    if (!existingCodes[parts[0]]) existingCodes[parts[0]] = [];
                    existingCodes[parts[0]].push(parts[1]);
                }
            });

            // Unit types
            var unitTypes = ['pi\u00b2', 'unitaire', 'lin\u00e9aire', '%'];

            // Check if an article is currently open in the edit modal
            var openArticle = null;
            var editModal = document.getElementById('editModal');
            if (editModal && editModal.classList.contains('active')) {
                var editId = document.getElementById('editItemId');
                if (editId && editId.value) {
                    var found = CATALOGUE_DATA.find(function(i) { return i.id === editId.value; });
                    if (found) {
                        openArticle = {
                            code: found.id,
                            category: found.category,
                            description: found.description,
                            type: found.type,
                            price: found.price,
                            instruction: found.instruction || null,
                            client_text: found.client_text || null,
                            is_default: found.is_default || false,
                            labor_minutes: found.labor_minutes || null,
                            material_costs: found.material_costs || null
                        };
                    }
                }
            }

            var pendingCount = CATALOGUE_DATA.filter(function(i) { return i.status === 'pending'; }).length;
            var approvedCount = CATALOGUE_DATA.filter(function(i) { return !i.status || i.status === 'approved'; }).length;

            // Usage stats summary
            var neverUsed = USAGE_STATS.filter(function(s) { return s.usage_count === 0; }).length;
            var dormant60 = USAGE_STATS.filter(function(s) { return s.usage_count > 0 && s.days_since_used !== null && s.days_since_used > 60; }).length;
            var activeMonth = USAGE_STATS.filter(function(s) { return s.days_since_used !== null && s.days_since_used <= 30; }).length;

            return {
                categories: Array.from(cats),
                existingCodes: existingCodes,
                unitTypes: unitTypes,
                expenseCategories: expenseCategories,
                tauxHoraires: tauxHoraires,
                totalItems: CATALOGUE_DATA.length,
                pendingCount: pendingCount,
                approvedCount: approvedCount,
                userEmail: (localStorage.getItem('sb_user_email') || '').toLowerCase(),
                openArticle: openArticle,
                usageSummary: {
                    neverUsed: neverUsed,
                    dormant60days: dormant60,
                    activeLastMonth: activeMonth
                }
            };
        }

        var ciStreamEl = null; // live-updating message element during streaming

        var _ciRetried401 = false;
        async function callCatalogueImport(messages, context) {
            var resp = await authenticatedFetch(SUPABASE_URL + '/functions/v1/catalogue-import', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ messages: messages, context: context })
            });
            if (!resp.ok) {
                var errText = await resp.text().catch(function() { return ''; });
                // Auto-retry on 401 auth error (force token refresh + one more try)
                if (resp.status === 401 && !_ciRetried401) {
                    _ciRetried401 = true;
                    if (await refreshAccessToken()) {
                        var result = await callCatalogueImport(messages, context);
                        _ciRetried401 = false;
                        return result;
                    }
                    throw new Error('Session expirée — veuillez vous reconnecter');
                }
                _ciRetried401 = false;
                try {
                    var errObj = JSON.parse(errText);
                    throw new Error(errObj.error || errObj.msg || errObj.message || 'Erreur ' + resp.status);
                } catch(e) { if (e.message) throw e; throw new Error('Erreur ' + resp.status); }
            }

            var contentType = resp.headers.get('content-type') || '';
            // Non-streaming fallback (error responses come as JSON)
            if (contentType.indexOf('text/event-stream') === -1) {
                return await resp.json();
            }

            // Parse SSE stream
            var reader = resp.body.getReader();
            var decoder = new TextDecoder();
            var buffer = '';
            var contentBlocks = [];
            var currentBlockIdx = -1;
            var currentText = '';
            var currentToolName = '';
            var currentToolId = '';
            var currentToolInput = '';
            var stopReason = null;
            var usage = null;

            // Create live message element (not appended yet — typing dots stay until first text arrives)
            ciStreamEl = document.createElement('div');
            ciStreamEl.className = 'ci-msg ci-msg-assistant';

            while (true) {
                var chunk = await reader.read();
                if (chunk.done) break;
                buffer += decoder.decode(chunk.value, { stream: true });
                var lines = buffer.split('\n');
                buffer = lines.pop() || '';
                for (var li = 0; li < lines.length; li++) {
                    var line = lines[li];
                    if (!line.startsWith('data: ')) continue;
                    var jsonStr = line.slice(6).trim();
                    if (!jsonStr || jsonStr === '[DONE]') continue;
                    try {
                        var evt = JSON.parse(jsonStr);
                        if (evt.type === 'content_block_start') {
                            currentBlockIdx = evt.index;
                            if (evt.content_block.type === 'text') {
                                currentText = '';
                            } else if (evt.content_block.type === 'tool_use') {
                                currentToolName = evt.content_block.name;
                                currentToolId = evt.content_block.id;
                                currentToolInput = '';
                            }
                        } else if (evt.type === 'content_block_delta') {
                            if (evt.delta.type === 'text_delta') {
                                currentText += evt.delta.text;
                                // Hide typing dots on first text, show streaming element
                                document.getElementById('ciTyping').classList.remove('active');
                                if (ciStreamEl && !ciStreamEl.parentNode) {
                                    document.getElementById('ciMessages').appendChild(ciStreamEl);
                                }
                                // Live update the message
                                if (ciStreamEl) {
                                    ciStreamEl.innerHTML = renderCiMarkdown(currentText);
                                    var container = document.getElementById('ciMessages');
                                    if (container.scrollHeight - container.scrollTop - container.clientHeight < 80) {
                                        container.scrollTop = container.scrollHeight;
                                    }
                                }
                            } else if (evt.delta.type === 'input_json_delta') {
                                currentToolInput += evt.delta.partial_json;
                            }
                        } else if (evt.type === 'content_block_stop') {
                            if (currentToolName) {
                                var parsedInput = {};
                                try { parsedInput = JSON.parse(currentToolInput); } catch(e2) {}
                                contentBlocks.push({ type: 'tool_use', id: currentToolId, name: currentToolName, input: parsedInput });
                                currentToolName = '';
                                currentToolId = '';
                                currentToolInput = '';
                            } else {
                                contentBlocks.push({ type: 'text', text: currentText });
                                currentText = '';
                            }
                        } else if (evt.type === 'message_delta') {
                            if (evt.delta && evt.delta.stop_reason) stopReason = evt.delta.stop_reason;
                            if (evt.usage) usage = evt.usage;
                        }
                    } catch(parseErr) {}
                }
            }

            // Remove the streaming element — it'll be re-added by ciHandleResponse
            if (ciStreamEl) { if (ciStreamEl.parentNode) ciStreamEl.remove(); ciStreamEl = null; }

            return { content: contentBlocks, stop_reason: stopReason, usage: usage };
        }

        // ── Edge Function helper (translate/optimize/AI buttons) ──
        async function callEdgeFunction(texts, action) {
            var resp = await authenticatedFetch(SUPABASE_URL + '/functions/v1/translate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ texts: texts, action: action })
            });
            if (!resp.ok) {
                if (resp.status === 401 || resp.status === 403) {
                    throw new Error('Session expirée — veuillez vous reconnecter.');
                }
                var errText = await resp.text().catch(function() { return ''; });
                try { var errObj = JSON.parse(errText); throw new Error(errObj.error || errObj.msg || 'Erreur ' + resp.status); }
                catch(e) { if (e.message) throw e; throw new Error('Erreur ' + resp.status + ': ' + errText.substring(0, 200)); }
            }
            var data = await resp.json();
            if (!data.translations || Object.keys(data.translations).length === 0) {
                throw new Error('Aucun résultat retourné par l\'AI');
            }
            return data.translations;
        }

        // ── AI Feedback shared helpers ──

        var _pendingAiData = {};

        /**
         * Parse AI response — handles envelope { status, warnings, ...data },
         * plain JSON without status, or raw text.
         */
        function parseAiEnvelope(raw, fallbackField) {
            if (!raw || typeof raw !== 'string') return { status: 'error', warnings: ['Aucune r\u00e9ponse de l\'AI.'] };
            var cleaned = raw.replace(/^```json?\s*/i, '').replace(/\s*```$/i, '').trim();
            try {
                var parsed = JSON.parse(cleaned);
                if (parsed && typeof parsed === 'object') {
                    if (parsed.status) return parsed;
                    // JSON sans status → wrap as ok
                    parsed.status = 'ok';
                    if (!parsed.warnings) parsed.warnings = [];
                    return parsed;
                }
            } catch (e) { /* not JSON — try to extract JSON object from mixed content */ }

            // Try to extract a JSON object from text that may contain narrative + JSON
            var firstBrace = cleaned.indexOf('{');
            if (firstBrace >= 0) {
                // Find matching closing brace using balanced counting
                var depth = 0, lastBrace = -1;
                for (var i = firstBrace; i < cleaned.length; i++) {
                    if (cleaned[i] === '{') depth++;
                    else if (cleaned[i] === '}') { depth--; if (depth === 0) { lastBrace = i; break; } }
                }
                if (lastBrace > firstBrace) {
                    try {
                        var extracted = JSON.parse(cleaned.substring(firstBrace, lastBrace + 1));
                        if (extracted && typeof extracted === 'object') {
                            if (extracted.status) return extracted;
                            extracted.status = 'ok';
                            if (!extracted.warnings) extracted.warnings = [];
                            return extracted;
                        }
                    } catch (e2) { /* still not valid JSON */ }
                }
            }

            // Raw text → wrap with fallbackField
            var result = { status: 'ok', warnings: [] };
            result[fallbackField || 'text'] = raw.trim();
            return result;
        }

        /**
         * Post-parse: separate explication text from embedded JSON in AI envelope.
         * jsonKeys: array of key names that identify a valid json field (e.g. ["cascade","ask"] or ["sections","order","prefix"])
         */
        function fixEnvelopeJsonSplit(envelope, jsonKeys) {
            if (!envelope) return;
            // Case 1: json is a string → try to parse it
            if (envelope.json && typeof envelope.json === 'string') {
                try { envelope.json = JSON.parse(envelope.json); } catch (e) { /* leave as-is */ }
            }
            // Case 2: json missing but explication contains embedded JSON
            if (!envelope.json && envelope.explication && typeof envelope.explication === 'string') {
                var exp = envelope.explication;
                function hasKey(obj) { return jsonKeys.some(function(k) { return obj[k] !== undefined; }); }
                function hasKeyStr(str) { return jsonKeys.some(function(k) { return str.indexOf('"' + k + '"') >= 0; }); }
                // Try code block: ```json { ... } ```
                var cbm = exp.match(/```json?\s*(\{[\s\S]*?\})\s*```/);
                if (cbm) {
                    try {
                        var p = JSON.parse(cbm[1]);
                        if (p && hasKey(p)) {
                            envelope.json = p;
                            envelope.explication = exp.replace(cbm[0], '').trim();
                            return;
                        }
                    } catch (e) { /* ignore */ }
                }
                // Scan for balanced { } containing expected keys
                for (var i = 0; i < exp.length; i++) {
                    if (exp[i] === '{') {
                        var d = 0, e2 = -1;
                        for (var j = i; j < exp.length; j++) {
                            if (exp[j] === '{') d++;
                            else if (exp[j] === '}') { d--; if (d === 0) { e2 = j; break; } }
                        }
                        if (e2 > i) {
                            var candidate = exp.substring(i, e2 + 1);
                            if (hasKeyStr(candidate)) {
                                try {
                                    var pc = JSON.parse(candidate);
                                    if (pc && hasKey(pc)) {
                                        envelope.json = pc;
                                        envelope.explication = (exp.substring(0, i) + exp.substring(e2 + 1)).replace(/\s{2,}/g, ' ').trim();
                                        return;
                                    }
                                } catch (e) { /* continue scanning */ }
                            }
                        }
                    }
                }
            }
            // Case 3: explication is actually a JSON object
            if (envelope.explication && typeof envelope.explication === 'object') {
                var expObj = envelope.explication;
                if (jsonKeys.some(function(k) { return expObj[k] !== undefined; })) {
                    envelope.json = expObj;
                    envelope.explication = '';
                }
            }
        }

        /**
         * Show feedback banners in a container.
         * envelope: { status, warnings: string[] }
         * applyFn: function to call when user clicks "Appliquer quand m\u00eame"
         * pendingKey: key in _pendingAiData to store the apply closure
         */
        function showAiFeedback(containerId, envelope, applyFn, pendingKey) {
            var container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';
            var messages = envelope.warnings || [];
            if (messages.length === 0 && envelope.status === 'error') {
                messages = ['Erreur AI inconnue.'];
            }
            var isWarning = envelope.status === 'needs_review';
            var isError = envelope.status === 'error';
            var cssClass = isError ? 'error' : isWarning ? 'warn' : 'info';
            var icon = isError ? '\u26A0' : isWarning ? '\u26A0' : '\u2139';

            messages.forEach(function(msg, idx) {
                var banner = document.createElement('div');
                banner.className = 'ai-feedback-banner ' + cssClass;

                var iconEl = document.createElement('span');
                iconEl.className = 'ai-feedback-icon';
                iconEl.textContent = icon;
                banner.appendChild(iconEl);

                var textEl = document.createElement('span');
                textEl.className = 'ai-feedback-text';
                textEl.textContent = msg;
                banner.appendChild(textEl);

                var actionsEl = document.createElement('span');
                actionsEl.className = 'ai-feedback-actions';

                // "Appliquer" button on the last warning if needs_review + applyFn exists
                if (isWarning && applyFn && idx === messages.length - 1) {
                    var applyBtn = document.createElement('button');
                    applyBtn.className = 'ai-feedback-btn-apply';
                    applyBtn.textContent = 'Appliquer';
                    applyBtn.onclick = function() {
                        if (_pendingAiData[pendingKey]) {
                            _pendingAiData[pendingKey]();
                            delete _pendingAiData[pendingKey];
                        }
                        clearAiFeedback(containerId);
                    };
                    actionsEl.appendChild(applyBtn);
                    if (pendingKey) _pendingAiData[pendingKey] = applyFn;
                }

                // Close button
                var closeBtn = document.createElement('button');
                closeBtn.className = 'ai-feedback-btn-close';
                closeBtn.innerHTML = '&times;';
                closeBtn.onclick = function() { banner.remove(); if (!container.children.length) container.innerHTML = ''; };
                actionsEl.appendChild(closeBtn);

                banner.appendChild(actionsEl);
                container.appendChild(banner);
            });
        }

        /** Clear all feedback banners from a container */
        function clearAiFeedback(containerId) {
            var el = document.getElementById(containerId);
            if (el) el.innerHTML = '';
        }

        /** Micro-flash success animation on a field element */
        function flashAiSuccess(fieldEl) {
            if (!fieldEl) return;
            fieldEl.classList.remove('ai-success-flash');
            void fieldEl.offsetWidth; // force reflow
            fieldEl.classList.add('ai-success-flash');
            setTimeout(function() { fieldEl.classList.remove('ai-success-flash'); }, 700);
        }

        function flashAiDotDone(btn) {
            if (!btn) return;
            btn.classList.add('ai-done');
            setTimeout(function() { btn.classList.remove('ai-done'); }, 500);
        }

        // ── AI context helpers ──

        function getAllRulesTemplates() {
            if (!expenseCategories) return '';
            return expenseCategories
                .filter(function(c) { return c.rules_template; })
                .map(function(c) { return c.name + ' : ' + c.rules_template; })
                .join('\n');
        }

        function buildArticleContext() {
            var code = (document.getElementById('editCode').value || '').trim();
            var desc = (document.getElementById('editDescription').value || '').trim();
            var cat = document.getElementById('editCategory') ? document.getElementById('editCategory').value : '';
            var itemType = document.getElementById('editItemType') ? document.getElementById('editItemType').value : '';
            var utype = document.getElementById('editType') ? document.getElementById('editType').value : '';
            var price = (document.getElementById('editPrice').value || '').trim();
            var instr = (document.getElementById('editInstruction').value || '').trim();
            var lines = [];
            if (code) lines.push('Code: ' + code);
            if (desc) lines.push('Description: ' + desc);
            if (cat) lines.push('Cat\u00e9gorie: ' + cat);
            if (itemType) lines.push('Classification: ' + itemType);
            if (utype) lines.push('Unit\u00e9: ' + utype);
            if (price) lines.push('Prix: ' + price + '$');
            if (instr) lines.push('Instruction: ' + instr);
            return lines.join('\n');
        }

        function getSimilarItems(category, limit) {
            var currentCode = (document.getElementById('editCode').value || '').trim();
            if (!category) return [];
            return CATALOGUE_DATA.filter(function(i) {
                return i.category === category && i.id !== currentCode && (i.status === 'approved' || !i.status);
            }).slice(0, limit || 15);
        }

        function getCategoryList() {
            var cats = new Set(configCategories);
            CATALOGUE_DATA.forEach(function(i) { if (i.category) cats.add(i.category); });
            return Array.from(cats).join(', ');
        }

        function getArticleCodesList() {
            return CATALOGUE_DATA.map(function(i) { return i.id; }).join(', ');
        }

        function getCalcRuleExamples(category, limit) {
            var currentCode = (document.getElementById('editCode').value || '').trim();
            var examples = CATALOGUE_DATA.filter(function(i) {
                return i.category === category && i.calculation_rule_ai && i.id !== currentCode;
            }).slice(0, limit || 3);
            if (examples.length === 0) {
                examples = CATALOGUE_DATA.filter(function(i) {
                    return i.calculation_rule_ai && i.id !== currentCode;
                }).slice(0, limit || 3);
            }
            return examples.map(function(ex) {
                return ex.id + ': ' + JSON.stringify(ex.calculation_rule_ai);
            }).join('\n');
        }

        // ── AI button handlers for catalogue modal ──

        async function aiCatalogueClientText() {
            var btn = document.getElementById('btnAiClientText');
            var input = document.getElementById('editClientText');
            var descField = document.getElementById('editDescription');
            var feedbackId = 'clientTextFeedback';
            clearAiFeedback(feedbackId);

            var existingText = input.value.trim();
            var category = document.getElementById('editCategory') ? document.getElementById('editCategory').value : '';

            var prompt = '=== ARTICLE ===\n' + buildArticleContext();
            prompt += '\nCat\u00e9gories existantes: ' + getCategoryList();

            var similar = getSimilarItems(category, 15);
            var similarTexts = similar.filter(function(i) { return i.client_text; })
                .map(function(i) { return i.id + ': ' + i.client_text; });
            if (similarTexts.length > 0) {
                prompt += '\n\n=== TEXTES CLIENTS SIMILAIRES (m\u00eame cat\u00e9gorie) ===\n' + similarTexts.join('\n');
            }

            if (existingText) {
                prompt += '\n\nTexte client actuel \u00e0 am\u00e9liorer :\n' + existingText;
            } else {
                prompt += '\n\nG\u00e9n\u00e8re un fragment de texte de pr\u00e9sentation client pour cet article.';
            }
            btn.disabled = true;
            btn.classList.add('ai-active');
            var hadError = false;
            try {
                var results = await callEdgeFunction([{ key: 'ct', text: prompt }], 'catalogue_client_text');
                var envelope = parseAiEnvelope(results['ct'], 'text');

                var applyData = function() {
                    if (envelope.text) input.value = envelope.text;
                    flashAiSuccess(input);
                    clearAiFeedback(feedbackId);
                };

                if (envelope.status === 'error') {
                    showAiFeedback(feedbackId, envelope);
                } else if (envelope.status === 'needs_review') {
                    showAiFeedback(feedbackId, envelope, applyData, 'clientText');
                } else {
                    applyData();
                }
            } catch (err) {
                hadError = true;
                showAiFeedback(feedbackId, { status: 'error', warnings: [err.message || 'Erreur inconnue'] });
            } finally {
                btn.disabled = false;
                btn.classList.remove('ai-active');
                if (!hadError) flashAiDotDone(btn);
            }
        }

        async function aiCatalogueExplication() {
            var btn = document.getElementById('btnAiExplication');
            var humanTextarea = document.getElementById('editPresRuleHuman');
            var jsonTextarea = document.getElementById('editPresRuleAi');
            var descField = document.getElementById('editDescription');
            var clientText = document.getElementById('editClientText');
            var feedbackId = 'presRuleFeedback';
            clearAiFeedback(feedbackId);

            var existingText = humanTextarea.value.trim();
            if (!existingText) {
                showAiFeedback(feedbackId, { status: 'error', warnings: ['\u00c9crivez d\'abord l\'explication avant de lancer l\'AI.'] });
                humanTextarea.focus();
                return;
            }
            var category = document.getElementById('editCategory') ? document.getElementById('editCategory').value : '';
            var clientTextVal = clientText ? clientText.value.trim() : '';

            var prompt = '=== ARTICLE ===\n' + buildArticleContext();
            if (clientTextVal) prompt += '\nTexte client: ' + clientTextVal;
            prompt += '\nCat\u00e9gories existantes: ' + getCategoryList();

            prompt += '\n\nSections de description connues: Caisson, Fa\u00e7ades, Tiroirs, Poign\u00e9es, D\u00e9tails, Exclusions';

            var templatesText = getAllRulesTemplates();
            if (templatesText) {
                prompt += '\n\n=== R\u00c8GLES DE BASE PAR CAT\u00c9GORIE ===\n' + templatesText;
                prompt += '\nResp\u00e8cte TOUJOURS ces r\u00e8gles. Ajoute seulement ce qui est sp\u00e9cifique \u00e0 cet article.';
            }

            var similar = getSimilarItems(category, 10);
            var similarRules = similar.filter(function(i) { return i.presentation_rule_human; })
                .map(function(i) { return i.id + ': ' + i.presentation_rule_human; });
            if (similarRules.length > 0) {
                prompt += '\n\n=== EXEMPLES EXPLICATIONS (m\u00eame cat\u00e9gorie) ===\n' + similarRules.join('\n');
            }

            prompt += '\n\nExplication actuelle :\n' + existingText;
            var existingJson = jsonTextarea ? jsonTextarea.value.trim() : '';
            if (existingJson) prompt += '\n\nJSON existant \u00e0 r\u00e9viser :\n' + existingJson;
            btn.disabled = true;
            btn.classList.add('ai-active');
            var hadError = false;
            try {
                var results = await callEdgeFunction([{ key: 'pr', text: prompt }], 'catalogue_pres_rule');
                var envelope = parseAiEnvelope(results['pr'], 'explication');
                fixEnvelopeJsonSplit(envelope, ['sections', 'order', 'prefix']);

                var applyData = function() {
                    if (envelope.explication) humanTextarea.value = envelope.explication;
                    if (envelope.json) {
                        jsonTextarea.value = JSON.stringify(envelope.json, null, 2);
                        jsonTextarea.classList.add('calc-rule-success');
                        setTimeout(function() { jsonTextarea.classList.remove('calc-rule-success'); }, 2000);
                    }
                    flashAiSuccess(humanTextarea);
                    clearAiFeedback(feedbackId);
                };

                if (envelope.status === 'error') {
                    showAiFeedback(feedbackId, envelope);
                } else if (envelope.status === 'needs_review') {
                    showAiFeedback(feedbackId, envelope, applyData, 'presRule');
                } else {
                    applyData();
                }
            } catch (err) {
                hadError = true;
                showAiFeedback(feedbackId, { status: 'error', warnings: [err.message || 'Erreur inconnue'] });
            } finally {
                btn.disabled = false;
                btn.classList.remove('ai-active');
                if (!hadError) flashAiDotDone(btn);
            }
        }

        async function aiCalcRuleGenerate() {
            var btn = document.getElementById('btnAiCalcRule');
            var humanTextarea = document.getElementById('editCalcRuleHuman');
            var jsonTextarea = document.getElementById('editCalcRuleAi');
            var descField = document.getElementById('editDescription');
            var feedbackId = 'calcRuleFeedback';
            clearAiFeedback(feedbackId);

            var humanText = humanTextarea.value.trim();
            if (!humanText) {
                showAiFeedback(feedbackId, { status: 'error', warnings: ['\u00c9crivez d\'abord l\'explication en langage naturel.'] });
                humanTextarea.focus();
                return;
            }
            var category = document.getElementById('editCategory') ? document.getElementById('editCategory').value : '';

            var prompt = '=== ARTICLE ===\n' + buildArticleContext();
            prompt += '\nCat\u00e9gories existantes: ' + getCategoryList();

            prompt += '\n\n=== CODES ARTICLES EXISTANTS ===\n' + getArticleCodesList();

            var matCatInfo = expenseCategories.map(function(c) {
                var defaultItem = CATALOGUE_DATA.find(function(i) { return i.is_default && i.category === c.name; });
                return c.name + (defaultItem ? ' (d\u00e9faut: ' + defaultItem.id + ')' : '');
            }).join(', ');
            if (matCatInfo) prompt += '\n\nCat\u00e9gories mat\u00e9riaux: ' + matCatInfo;

            var templatesText = getAllRulesTemplates();
            if (templatesText) {
                prompt += '\n\n=== R\u00c8GLES DE BASE PAR CAT\u00c9GORIE ===\n' + templatesText;
                prompt += '\nResp\u00e8cte TOUJOURS ces r\u00e8gles. Ajoute seulement ce qui est sp\u00e9cifique \u00e0 cet article.';
            }

            prompt += '\n\n=== FORMAT JSON ATTENDU ===\n{"cascade":[{"target":"CODE","qty":"number|formula","condition":"optional"}],"ask":["dim1"],"notes":"optional"}';

            var examples = getCalcRuleExamples(category, 3);
            if (examples) {
                prompt += '\n\n=== EXEMPLES JSON (articles similaires) ===\n' + examples;
            }

            prompt += '\n\nExplication actuelle :\n' + humanText;
            var existingJson = jsonTextarea.value.trim();
            if (existingJson) prompt += '\n\nJSON existant \u00e0 r\u00e9viser :\n' + existingJson;

            btn.disabled = true;
            btn.classList.add('ai-active');
            var hadError = false;
            try {
                var results = await callEdgeFunction([{ key: 'cr', text: prompt }], 'catalogue_calc_rule');
                var envelope = parseAiEnvelope(results['cr'], 'explication');
                fixEnvelopeJsonSplit(envelope, ['cascade', 'ask']);

                var applyData = function() {
                    if (envelope.explication) humanTextarea.value = envelope.explication;
                    if (envelope.json) {
                        jsonTextarea.value = JSON.stringify(envelope.json, null, 2);
                        jsonTextarea.classList.add('calc-rule-success');
                        setTimeout(function() { jsonTextarea.classList.remove('calc-rule-success'); }, 2000);
                    }
                    flashAiSuccess(humanTextarea);
                    clearAiFeedback(feedbackId);
                };

                if (envelope.status === 'error') {
                    showAiFeedback(feedbackId, envelope);
                } else if (envelope.status === 'needs_review') {
                    showAiFeedback(feedbackId, envelope, applyData, 'calcRule');
                } else {
                    applyData();
                }
            } catch (err) {
                hadError = true;
                showAiFeedback(feedbackId, { status: 'error', warnings: [err.message || 'Erreur inconnue'] });
            } finally {
                btn.disabled = false;
                btn.classList.remove('ai-active');
                if (!hadError) flashAiDotDone(btn);
            }
        }

        // ── Auto-generate base rules from templates on item creation ──

        async function autoGenerateBaseRules(item) {
            var templatesText = getAllRulesTemplates();
            if (!templatesText) return;

            var context = '=== ARTICLE ===\nCode: ' + (item.id || '') +
                '\nDescription: ' + (item.description || '') +
                '\nCat\u00e9gorie: ' + (item.category || '') +
                '\nType: ' + (item.type || '');

            var matCatInfo = expenseCategories.map(function(c) {
                var defaultItem = CATALOGUE_DATA.find(function(i) { return i.is_default && i.category === c.name; });
                return c.name + (defaultItem ? ' (d\u00e9faut: ' + defaultItem.id + ')' : '');
            }).join(', ');

            var basePrompt = context +
                '\nCat\u00e9gories existantes: ' + getCategoryList() +
                '\n\n=== CODES ARTICLES EXISTANTS ===\n' + getArticleCodesList() +
                '\nCat\u00e9gories mat\u00e9riaux: ' + matCatInfo +
                '\n\n=== R\u00c8GLES DE BASE PAR CAT\u00c9GORIE ===\n' + templatesText +
                '\nG\u00e9n\u00e8re les r\u00e8gles de BASE \u00e0 partir des templates ci-dessus. Pas d\'explication humaine fournie \u2014 d\u00e9duis le comportement depuis la description.';

            // Calc rule prompt
            var calcPrompt = basePrompt + '\n\n=== FORMAT JSON ATTENDU ===\n{"cascade":[{"target":"CODE","qty":"number|formula","condition":"optional"}],"ask":["dim1"],"notes":"optional"}';
            var category = item.category || '';
            var calcExamples = getCalcRuleExamples(category, 3);
            if (calcExamples) calcPrompt += '\n\n=== EXEMPLES JSON (articles similaires) ===\n' + calcExamples;

            // Pres rule prompt
            var presPrompt = basePrompt + '\n\nSections de description connues: Caisson, Fa\u00e7ades, Tiroirs, Poign\u00e9es, D\u00e9tails, Exclusions';
            var similar = getSimilarItems(category, 10);
            var similarRules = similar.filter(function(i) { return i.presentation_rule_human; })
                .map(function(i) { return i.id + ': ' + i.presentation_rule_human; });
            if (similarRules.length) presPrompt += '\n\n=== EXEMPLES EXPLICATIONS (m\u00eame cat\u00e9gorie) ===\n' + similarRules.join('\n');

            try {
                var results = await Promise.all([
                    callEdgeFunction([{ key: 'cr', text: calcPrompt }], 'catalogue_calc_rule'),
                    callEdgeFunction([{ key: 'pr', text: presPrompt }], 'catalogue_pres_rule')
                ]);

                var calcEnv = parseAiEnvelope(results[0]['cr'], 'explication');
                fixEnvelopeJsonSplit(calcEnv, ['cascade', 'ask']);
                var presEnv = parseAiEnvelope(results[1]['pr'], 'explication');
                fixEnvelopeJsonSplit(presEnv, ['sections', 'order', 'prefix']);

                var patch = {};
                if (calcEnv.json) patch.calculation_rule_ai = calcEnv.json;
                if (calcEnv.explication) patch.calculation_rule_human = calcEnv.explication;
                if (presEnv.json) patch.presentation_rule = presEnv.json;
                if (presEnv.explication) patch.presentation_rule_human = presEnv.explication;

                if (Object.keys(patch).length === 0) return;

                await authenticatedFetch(SUPABASE_URL + '/rest/v1/catalogue_items?id=eq.' + item.id, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                    body: JSON.stringify(patch)
                });

                var local = CATALOGUE_DATA.find(function(i) { return i.id === item.id; });
                if (local) Object.assign(local, patch);

                console.log('Auto-generated base rules for ' + item.id);
            } catch (err) {
                console.warn('Auto-generate base rules failed for ' + item.id + ':', err);
            }
        }

        // ── Import composantes AI (paste/drop images + text) ──

        var compImportImages = [];

        function initCompImportZone() {
            var zone = document.getElementById('compImportZone');
            var input = document.getElementById('compImportInput');
            if (!zone || !input || zone.dataset.init) return;
            zone.dataset.init = '1';

            input.addEventListener('paste', function(e) {
                var items = (e.clipboardData || {}).items || [];
                for (var i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        e.preventDefault();
                        compProcessImage(items[i].getAsFile());
                        break;
                    }
                }
            });

            zone.addEventListener('dragover', function(e) {
                e.preventDefault();
                zone.classList.add('drag-over');
            });
            zone.addEventListener('dragleave', function() {
                zone.classList.remove('drag-over');
            });
            zone.addEventListener('drop', function(e) {
                e.preventDefault();
                zone.classList.remove('drag-over');
                var files = e.dataTransfer.files;
                for (var i = 0; i < files.length; i++) {
                    if (files[i].type.indexOf('image') !== -1) {
                        compProcessImage(files[i]);
                    }
                }
            });
        }

        function compProcessImage(file) {
            var reader = new FileReader();
            reader.onload = function(e) {
                var img = new Image();
                img.onload = function() {
                    var canvas = document.createElement('canvas');
                    var maxDim = 1200;
                    var w = img.width, h = img.height;
                    if (w > maxDim || h > maxDim) {
                        if (w > h) { h = Math.round(h * maxDim / w); w = maxDim; }
                        else { w = Math.round(w * maxDim / h); h = maxDim; }
                    }
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    compImportImages.push(canvas.toDataURL('image/jpeg', 0.8));
                    renderCompImportThumbs();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function renderCompImportThumbs() {
            var container = document.getElementById('compImportThumbs');
            if (!container) return;
            container.innerHTML = '';
            compImportImages.forEach(function(src, i) {
                var div = document.createElement('div');
                div.className = 'comp-import-thumb';
                div.innerHTML = '<img src="' + src + '"><button class="comp-img-remove" onclick="compRemoveImage(' + i + ')">&times;</button>';
                container.appendChild(div);
            });
        }

        function compRemoveImage(index) {
            compImportImages.splice(index, 1);
            renderCompImportThumbs();
        }

        function clearImportRecap() {
            var recap = document.getElementById('compImportRecap');
            if (recap) { recap.style.display = 'none'; recap.innerHTML = ''; }
        }

        function showImportRecap(envelope) {
            var recap = document.getElementById('compImportRecap');
            if (!recap) return;
            var comps = envelope.components;
            if (!comps || !Array.isArray(comps) || comps.length === 0) {
                showAiFeedback('importCompFeedback', { status: 'error', warnings: ['Aucune composante trouv\u00e9e dans les donn\u00e9es.'] });
                return;
            }

            var html = '<div class="recap-header">' + comps.length + ' composante' + (comps.length > 1 ? 's' : '') + ' trouv\u00e9e' + (comps.length > 1 ? 's' : '') + '</div>';

            // Warnings
            var warnings = (envelope.warnings || []).filter(Boolean);
            if (envelope.notes) warnings.push(envelope.notes);
            if (warnings.length > 0) {
                html += '<div class="recap-warnings">\u26A0 ' + warnings.map(escapeHtml).join(' \u2022 ') + '</div>';
            }

            // Table
            html += '<table class="recap-table"><thead><tr>';
            html += '<th>Description</th><th>Fournisseur</th><th>Cat\u00e9gorie</th><th>Qt\u00e9</th><th>Co\u00fbt</th>';
            html += '</tr></thead><tbody>';
            comps.forEach(function(c) {
                html += '<tr>';
                html += '<td>' + escapeHtml(c.description || '\u2014') + '</td>';
                html += '<td>' + escapeHtml([c.supplier_name, c.supplier_sku].filter(Boolean).join(' \u2022 ') || '\u2014') + '</td>';
                html += '<td>' + escapeHtml(c.expense_category || '\u2014') + '</td>';
                html += '<td>' + (c.qty_per_unit || 1) + '</td>';
                html += '<td>' + (c.unit_cost != null ? Number(c.unit_cost).toFixed(2) + '$' : '\u2014') + '</td>';
                html += '</tr>';
            });
            html += '</tbody></table>';

            html += '<div class="recap-actions">';
            html += '<button class="recap-btn recap-btn-apply" onclick="applyImportRecap()">Appliquer ' + comps.length + ' composante' + (comps.length > 1 ? 's' : '') + '</button>';
            html += '<button class="recap-btn recap-btn-cancel" onclick="clearImportRecap()">Annuler</button>';
            html += '</div>';

            recap.innerHTML = html;
            recap.style.display = 'block';
            // Store pending components
            recap.dataset.pending = JSON.stringify(comps);
        }

        function applyImportRecap() {
            var recap = document.getElementById('compImportRecap');
            var input = document.getElementById('compImportInput');
            if (!recap || !recap.dataset.pending) return;
            try {
                var comps = JSON.parse(recap.dataset.pending);
                comps.forEach(function(comp) {
                    editComponents.push({
                        id: null,
                        supplier_name: comp.supplier_name || '',
                        supplier_sku: comp.supplier_sku || '',
                        description: comp.description || '',
                        expense_category: comp.expense_category || '',
                        qty_per_unit: comp.qty_per_unit || 1,
                        unit_cost: comp.unit_cost || 0,
                        notes: '',
                        sort_order: editComponents.length + 1,
                        isNew: true
                    });
                });
                renderComponents();
                syncComponentsToMaterials();
                if (input) { input.value = ''; }
                compImportImages = [];
                renderCompImportThumbs();
                flashAiSuccess(input);
            } catch (e) { /* ignore parse errors */ }
            clearImportRecap();
            clearAiFeedback('importCompFeedback');
        }

        async function aiImportComponents() {
            var btn = document.getElementById('btnAiImportComp');
            var input = document.getElementById('compImportInput');
            var feedbackId = 'importCompFeedback';
            clearAiFeedback(feedbackId);
            clearImportRecap();

            var text = input.value.trim();
            var images = compImportImages.slice();

            if (!text && images.length === 0) {
                showAiFeedback(feedbackId, { status: 'error', warnings: ['Collez une image ou tapez les donn\u00e9es fournisseur.'] });
                return;
            }

            var catNames = expenseCategories.map(function(c) { return c.name; }).join(', ');
            var supplierNames = supplierCompanies.map(function(s) { return s.name; }).join(', ');

            var contextText = '=== CATÉGORIES DE DÉPENSES DISPONIBLES ===\n' + catNames;
            if (supplierNames) contextText += '\n\n=== FOURNISSEURS CONNUS ===\n' + supplierNames;
            contextText += '\n\n=== ARTICLE EN COURS ===\n' + buildArticleContext();
            if (text) contextText += '\n\n=== DONNÉES FOURNISSEUR (texte) ===\n' + text;
            if (images.length > 0) contextText += '\n\n=== IMAGE(S) JOINTE(S) ===\n' + images.length + ' image(s) de données fournisseur jointe(s). Extraire les composantes visibles dans les images.';

            var imagePayload = images.map(function(dataUrl) {
                var match = dataUrl.match(/^data:(.*?);base64,(.*)$/);
                return match ? { media_type: match[1], data: match[2] } : null;
            }).filter(Boolean);

            btn.disabled = true;
            btn.classList.add('ai-active');
            var hadError = false;

            var payloadBody = {
                texts: [{ key: 'import', text: contextText }],
                action: 'import_components',
                images: imagePayload.length > 0 ? imagePayload : undefined
            };
            console.log('[IMPORT-DIAG] Payload:', {
                textLength: contextText.length,
                imageCount: imagePayload.length,
                imageTypes: imagePayload.map(function(img) { return img.media_type; }),
                imageSizes: imagePayload.map(function(img) { return img.data ? img.data.length : 0; }),
                textPreview: contextText.substring(0, 300)
            });

            try {
                var resp = await authenticatedFetch(SUPABASE_URL + '/functions/v1/translate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payloadBody)
                });
                if (!resp.ok) {
                    if (resp.status === 401 || resp.status === 403) {
                        throw new Error('Session expir\u00e9e \u2014 veuillez vous reconnecter.');
                    }
                    var errText = await resp.text().catch(function() { return ''; });
                    try { var errObj = JSON.parse(errText); throw new Error(errObj.error || errObj.msg || 'Erreur ' + resp.status); }
                    catch(e) { if (e.message) throw e; throw new Error('Erreur ' + resp.status); }
                }
                var data = await resp.json();
                console.log('[IMPORT-DIAG] Response:', { debug: data.debug, translationKeys: Object.keys(data.translations || {}) });
                var result = data.translations && data.translations['import'];
                if (!result) throw new Error('Aucun résultat retourné par l\'AI');

                console.log('[IMPORT-DIAG] Raw AI result:', result.substring(0, 500));
                var envelope = parseAiEnvelope(result, 'components');

                // Normalize: AI sometimes uses French field names
                if (!envelope.components && envelope.composantes) envelope.components = envelope.composantes;
                if (Array.isArray(envelope.components)) {
                    envelope.components = envelope.components.map(function(c) {
                        return {
                            supplier_name: c.supplier_name || c.fournisseur || c.supplier || '',
                            supplier_sku: c.supplier_sku || c.sku || c.code || '',
                            description: c.description || '',
                            expense_category: c.expense_category || c.categorie || c.category || '',
                            qty_per_unit: c.qty_per_unit || c.quantite || c.qty || 1,
                            unit_cost: c.unit_cost || c.cout_unitaire || c.cost || c.prix || 0,
                            notes: c.notes || c.note || ''
                        };
                    });
                }
                console.log('[IMPORT-DIAG] Parsed envelope:', { status: envelope.status, componentCount: (envelope.components || []).length, warnings: envelope.warnings });

                if (envelope.status === 'error') {
                    showAiFeedback(feedbackId, envelope);
                } else {
                    showImportRecap(envelope);
                }
            } catch (err) {
                hadError = true;
                showAiFeedback(feedbackId, { status: 'error', warnings: [err.message || 'Erreur inconnue'] });
            } finally {
                btn.disabled = false;
                btn.classList.remove('ai-active');
                if (!hadError) flashAiDotDone(btn);
            }
        }

        function ciSearchCatalogue(query) {
            var q = (query || '').toLowerCase();
            var results = CATALOGUE_DATA.filter(function(item) {
                return (item.description || '').toLowerCase().indexOf(q) !== -1 ||
                       (item.category || '').toLowerCase().indexOf(q) !== -1 ||
                       (item.id || '').toLowerCase().indexOf(q) !== -1;
            }).slice(0, 15).map(function(item) {
                return { id: item.id, description: item.description, category: item.category, type: item.type, price: item.price, status: item.status || 'approved' };
            });
            return { results: results, count: results.length };
        }

        function ciExecuteFilterCatalogue(input) {
            if (input.reset) {
                aiFilterActive = false;
                aiFilterCategory = null;
                aiFilterStatus = null;
                aiFilterStartsWith = null;
                aiFilterHasField = null;
                aiFilterMissingField = null;
                aiFilterItemType = null;
                catalogueSearchQuery = '';
                catalogueSortCol = null;
                document.getElementById('catalogueSearchInput').value = '';
                document.getElementById('filterFabBtn').classList.remove('active');
                document.getElementById('filterMatBtn').classList.remove('active');
                removeAiFilterBadge();
            } else {
                aiFilterActive = true;
                aiFilterStartsWith = null;
                aiFilterHasField = null;
                aiFilterMissingField = null;
                aiFilterItemType = null;
                if (input.starts_with) {
                    aiFilterStartsWith = input.starts_with.toLowerCase();
                }
                if (input.has_field) aiFilterHasField = input.has_field;
                if (input.missing_field) aiFilterMissingField = input.missing_field;
                if (input.item_type) {
                    aiFilterItemType = input.item_type;
                    document.getElementById('filterFabBtn').classList.toggle('active', aiFilterItemType === 'fabrication');
                    document.getElementById('filterMatBtn').classList.toggle('active', aiFilterItemType === 'materiau');
                }
                if (input.search) {
                    catalogueSearchQuery = input.search.toLowerCase();
                    document.getElementById('catalogueSearchInput').value = input.search;
                }
                if (input.category) {
                    aiFilterCategory = input.category;
                }
                if (input.status) {
                    aiFilterStatus = input.status;
                }
                if (input.sort_by) {
                    catalogueSortCol = input.sort_by;
                    catalogueSortDir = input.sort_dir || 'asc';
                }
                showAiFilterBadge();
            }
            generatePriceTables();
            return { filtered_count: countVisibleItems(), message: 'Filtre appliqué' };
        }

        function resetAiFilter() {
            aiFilterActive = false;
            aiFilterCategory = null;
            aiFilterStatus = null;
            aiFilterStartsWith = null;
            aiFilterHasField = null;
            aiFilterMissingField = null;
            aiFilterItemType = null;
            aiBatchCodes = null;
            catalogueSearchQuery = '';
            catalogueSortCol = null;
            document.getElementById('catalogueSearchInput').value = '';
            document.getElementById('filterFabBtn').classList.remove('active');
            document.getElementById('filterMatBtn').classList.remove('active');
            // Remove batch restore link if present
            var restoreLink = document.querySelector('.ai-batch-restore');
            if (restoreLink) restoreLink.remove();
            removeAiFilterBadge();
            generatePriceTables();
        }

        function showAiFilterBadge() {
            var badge = document.getElementById('aiFilterBadge');
            if (badge) badge.style.display = '';
        }

        function removeAiFilterBadge() {
            var badge = document.getElementById('aiFilterBadge');
            if (badge) badge.style.display = 'none';
        }

        function countVisibleItems() {
            return document.querySelectorAll('#mainCatalogueTable tbody tr:not(.cat-group-row)').length;
        }

        async function sendImportMessage() {
            var input = document.getElementById('ciInput');
            var text = input.value.trim();
            if (!text && ciPendingImages.length === 0) return;

            var images = ciPendingImages.slice();
            ciPendingImages = [];
            renderCiImagePreviews();
            input.value = '';
            input.style.height = 'auto';

            appendCiMessage('user', text || '(image)', { images: images });

            var userContent = buildCiUserContent(text, images);
            ciConversation.push({ role: 'user', content: userContent });
            saveCiChatMessage('user', text);
            var qa = document.getElementById('ciQuickActions');
            if (qa) qa.style.display = 'none';

            // Show typing
            document.getElementById('ciTyping').classList.add('active');
            document.getElementById('ciSendBtn').disabled = true;

            try {
                var context = collectImportContext();
                var data = await ciProcessResponse(ciConversation, context);
                ciHandleResponse(data);
            } catch (err) {
                appendCiMessage('assistant', 'Erreur : ' + err.message);
            } finally {
                document.getElementById('ciTyping').classList.remove('active');
                document.getElementById('ciSendBtn').disabled = false;
            }
        }

        // Process AI response — auto-execute read-only tools (search_catalogue), loop until text or create tool
        async function ciProcessResponse(conversation, context) {
            var maxLoops = 5; // safety limit for tool loops
            var data = await callCatalogueImport(conversation, context);

            for (var loop = 0; loop < maxLoops; loop++) {
                var contentBlocks = data.content || [];
                var toolCalls = contentBlocks.filter(function(b) { return b.type === 'tool_use'; });
                var readOnlyNames = ['search_catalogue', 'filter_catalogue', 'check_usage', 'audit_client_names'];
                var readOnlyTools = toolCalls.filter(function(tc) { return readOnlyNames.indexOf(tc.name) !== -1; });
                var actionTools = toolCalls.filter(function(tc) { return readOnlyNames.indexOf(tc.name) === -1; });

                // If no read-only tools to auto-execute, return as-is
                if (readOnlyTools.length === 0) return data;

                // Auto-execute read-only tools and continue the conversation
                conversation.push({ role: 'assistant', content: contentBlocks });

                var toolResults = [];
                readOnlyTools.forEach(function(tc) {
                    var result;
                    if (tc.name === 'filter_catalogue') {
                        result = ciExecuteFilterCatalogue(tc.input);
                    } else if (tc.name === 'check_usage') {
                        result = ciCheckUsage(tc.input);
                    } else if (tc.name === 'audit_client_names') {
                        result = ciAuditClientNames(tc.input);
                    } else {
                        result = ciSearchCatalogue(tc.input.query);
                    }
                    toolResults.push({ type: 'tool_result', tool_use_id: tc.id, content: JSON.stringify(result) });
                });

                // If there are also action tools, we need to return them for confirmation
                // but first send the search results back
                if (actionTools.length > 0) {
                    conversation.push({ role: 'user', content: toolResults });
                    return data; // The action tools will be handled by ciHandleResponse
                }

                // Only read-only tools — send results back and get next response
                conversation.push({ role: 'user', content: toolResults });
                document.getElementById('ciTyping').classList.add('active');
                data = await callCatalogueImport(conversation, context);
            }

            return data; // safety: return whatever we have after max loops
        }

        function ciHandleResponse(data) {
            var contentBlocks = data.content || [];
            var textParts = [];
            var actionTools = [];

            var readOnlyNames = ['search_catalogue', 'filter_catalogue', 'check_usage', 'audit_client_names'];
            contentBlocks.forEach(function(block) {
                if (block.type === 'text') textParts.push(block.text);
                if (block.type === 'tool_use' && readOnlyNames.indexOf(block.name) === -1) actionTools.push(block);
            });

            // Add to conversation if not already added (when no read-only tools were processed)
            var lastMsg = ciConversation[ciConversation.length - 1];
            if (!lastMsg || lastMsg.role !== 'assistant' || lastMsg.content !== contentBlocks) {
                ciConversation.push({ role: 'assistant', content: contentBlocks });
            }

            if (actionTools.length > 0) {
                var fullText = textParts.join('\n');
                if (fullText) appendCiMessage('assistant', fullText);

                ciPendingToolCalls = { tools: actionTools };
                var summary = formatCiPendingActions(actionTools);
                appendCiMessage('confirm', summary);
                saveCiChatMessage('assistant', fullText + '\n[Actions proposées]');
            } else {
                var fullText = textParts.join('\n');
                appendCiMessage('assistant', fullText);
                saveCiChatMessage('assistant', fullText);
            }
        }

        function formatCiPendingActions(toolCalls) {
            var lines = [];
            var createCount = 0, updateCount = 0, deleteCount = 0;
            toolCalls.forEach(function(tc) {
                if (tc.name === 'create_catalogue_item') createCount++;
                else if (tc.name === 'update_catalogue_item') updateCount++;
                else if (tc.name === 'delete_catalogue_item') deleteCount++;
            });
            if (createCount > 0) lines.push('**' + createCount + ' article(s) \u00e0 cr\u00e9er :**');
            toolCalls.forEach(function(tc) {
                if (tc.name === 'create_catalogue_item' && tc.input) {
                    lines.push('- **' + (tc.input.code || '?') + '** ' + (tc.input.description || '') + ' \u2014 ' + (tc.input.unit_type || ''));
                    var moParts = [];
                    if (tc.input.labor_minutes) {
                        Object.keys(tc.input.labor_minutes).forEach(function(dept) {
                            if (tc.input.labor_minutes[dept] > 0) moParts.push(dept + ' ' + tc.input.labor_minutes[dept] + 'min');
                        });
                    }
                    if (moParts.length) lines.push('  MO: ' + moParts.join(', '));
                    var matParts = [];
                    if (tc.input.material_costs) {
                        Object.keys(tc.input.material_costs).forEach(function(cat) {
                            if (tc.input.material_costs[cat] > 0) matParts.push(cat + ' ' + tc.input.material_costs[cat].toFixed(2) + '$');
                        });
                    }
                    if (matParts.length) lines.push('  Mat: ' + matParts.join(', '));
                }
            });
            if (updateCount > 0) {
                lines.push('**' + updateCount + ' article(s) \u00e0 modifier :**');
                toolCalls.forEach(function(tc) {
                    if (tc.name === 'update_catalogue_item' && tc.input) {
                        var fields = tc.input.updates ? Object.keys(tc.input.updates).join(', ') : '';
                        lines.push('- **' + tc.input.code + '** \u2192 ' + fields);
                    }
                });
            }
            if (deleteCount > 0) {
                lines.push('**' + deleteCount + ' article(s) \u00e0 supprimer :**');
                toolCalls.forEach(function(tc) {
                    if (tc.name === 'delete_catalogue_item' && tc.input) {
                        lines.push('- **' + tc.input.code + '**');
                    }
                });
            }
            return lines.join('\n') || 'Action propos\u00e9e';
        }

        async function ciApplyPending(confirmId) {
            if (!ciPendingToolCalls) return;
            var confirmEl = document.getElementById(confirmId);
            var actionsDiv = confirmEl ? confirmEl.querySelector('.ci-confirm-actions') : null;
            if (actionsDiv) actionsDiv.innerHTML = '<span class="ci-confirm-applied">Ex\u00e9cution en cours...</span>';

            var results = [];
            for (var i = 0; i < ciPendingToolCalls.tools.length; i++) {
                var tc = ciPendingToolCalls.tools[i];
                var result = await executeCiTool(tc.name, tc.input);
                results.push(result);

                // Add tool_result to conversation for proper API flow
                ciConversation.push({ role: 'user', content: [{ type: 'tool_result', tool_use_id: tc.id, content: JSON.stringify(result) }] });
            }

            ciPendingToolCalls = null;

            // Build summary from results
            var parts = [];
            var totalErrors = 0;
            results.forEach(function(r) {
                if (r.errors && r.errors.length) totalErrors += r.errors.length;
                if (r.action === 'created') parts.push(r.code + ' cr\u00e9\u00e9');
                else if (r.action === 'updated') parts.push(r.code + ' modifi\u00e9');
                else if (r.action === 'deleted') parts.push(r.code + ' supprim\u00e9');
            });

            if (actionsDiv) {
                var msg = parts.join(', ') || (results.length + ' action(s)');
                if (totalErrors > 0) msg += ' \u2014 ' + totalErrors + ' erreur(s)';
                actionsDiv.innerHTML = '<span class="ci-confirm-applied">\u2713 ' + msg + '</span>';
            }

            // Collect created codes for animation dispatch
            var createdCodes = results
                .filter(function(r) { return r.action === 'created' && r.success; })
                .map(function(r) { return r.code; });

            if (createdCodes.length === 1) {
                // UNIT MODE — open animated modal
                generatePriceTables();
                updatePendingBadge();
                openEditModalAnimated(createdCodes[0]);
            } else if (createdCodes.length > 1) {
                // BATCH MODE — show only new items with cascade
                ciShowBatchInsert(createdCodes);
            } else {
                // No creation (updates/deletes only)
                generatePriceTables();
                updatePendingBadge();
            }
        }

        // ═══ Batch insert mode (2+ articles) ═══
        function ciShowBatchInsert(codes) {
            aiBatchCodes = codes;
            aiFilterActive = true;
            generatePriceTables();
            updatePendingBadge();
            showAiFilterBadge();
        }

        async function executeCiTool(name, input) {
            var userEmail = (localStorage.getItem('sb_user_email') || '').toLowerCase();

            // ── CREATE ──
            if (name === 'create_catalogue_item') {
                try {
                    var maxSort = CATALOGUE_DATA.reduce(function(max, ci) { return Math.max(max, ci.sort_order || 0); }, 0);
                    var payload = {
                        category: input.category,
                        item_type: input.item_type || null,
                        dims_config: input.dims_config || null,
                        description: input.description,
                        type: input.unit_type,
                        instruction: input.instruction || null,
                        client_text: input.client_text || null,
                        is_default: input.is_default || false,
                        has_sales_sheet: input.has_sales_sheet || false,
                        labor_minutes: input.labor_minutes || null,
                        material_costs: input.material_costs || null,
                        status: 'pending',
                        proposed_by: userEmail,
                        in_calculator: input.visible_calculator !== false,
                        sort_order: maxSort + 1
                    };
                    // Code auto-genere par le trigger DB (shop_code_prefix + sequence)

                    var resp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/catalogue_items', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                        body: JSON.stringify(payload)
                    });

                    if (!resp.ok) throw new Error(await resp.text());

                    var createdItems = await resp.json();
                    var createdItem = Array.isArray(createdItems) ? createdItems[0] : createdItems;
                    var actualCode = createdItem.id;
                    CATALOGUE_DATA.push(createdItem);

                    // Insert supplier components if provided
                    if (input.supplier_components && input.supplier_components.length > 0) {
                        for (var sc = 0; sc < input.supplier_components.length; sc++) {
                            var comp = input.supplier_components[sc];
                            await authenticatedFetch(SUPABASE_URL + '/rest/v1/catalogue_item_components', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    catalogue_item_id: actualCode,
                                    supplier_name: comp.supplier_name || null,
                                    supplier_sku: comp.supplier_sku || null,
                                    unit_cost: comp.cost || 0,
                                    expense_category: comp.category || null,
                                    sort_order: sc
                                })
                            });
                        }
                    }

                    return { success: true, action: 'created', code: actualCode, errors: [], message: actualCode + ' cr\u00e9\u00e9' };
                } catch (e) {
                    return { success: false, action: 'created', code: input.code || '?', errors: [{ id: input.code || '?', error: e.message }], message: 'Erreur: ' + e.message };
                }
            }

            // ── UPDATE ──
            if (name === 'update_catalogue_item') {
                try {
                    var updates = input.updates || {};
                    var patchPayload = {};
                    if (updates.description !== undefined) patchPayload.description = updates.description;
                    if (updates.category !== undefined) patchPayload.category = updates.category;
                    if (updates.unit_type !== undefined) patchPayload.type = updates.unit_type;
                    if (updates.instruction !== undefined) patchPayload.instruction = updates.instruction;
                    if (updates.client_text !== undefined) patchPayload.client_text = updates.client_text;
                    if (updates.is_default !== undefined) patchPayload.is_default = updates.is_default;
                    if (updates.visible_calculator !== undefined) patchPayload.in_calculator = updates.visible_calculator;
                    if (updates.labor_minutes !== undefined) patchPayload.labor_minutes = updates.labor_minutes;
                    if (updates.material_costs !== undefined) patchPayload.material_costs = updates.material_costs;

                    var resp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/catalogue_items?id=eq.' + encodeURIComponent(input.code), {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                        body: JSON.stringify(patchPayload)
                    });

                    if (!resp.ok) throw new Error(await resp.text());

                    var updatedItems = await resp.json();
                    var updatedItem = Array.isArray(updatedItems) ? updatedItems[0] : updatedItems;

                    // Update local data
                    for (var idx = 0; idx < CATALOGUE_DATA.length; idx++) {
                        if (CATALOGUE_DATA[idx].id === input.code) {
                            CATALOGUE_DATA[idx] = updatedItem;
                            break;
                        }
                    }

                    return { success: true, action: 'updated', code: input.code, errors: [], message: input.code + ' modifi\u00e9' };
                } catch (e) {
                    return { success: false, action: 'updated', code: input.code, errors: [{ id: input.code, error: e.message }], message: 'Erreur: ' + e.message };
                }
            }

            // ── DELETE ──
            if (name === 'delete_catalogue_item') {
                try {
                    var resp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/catalogue_items?id=eq.' + encodeURIComponent(input.code), {
                        method: 'DELETE'
                    });

                    if (!resp.ok) throw new Error(await resp.text());

                    // Remove from local data
                    CATALOGUE_DATA = CATALOGUE_DATA.filter(function(ci) { return ci.id !== input.code; });

                    return { success: true, action: 'deleted', code: input.code, errors: [], message: input.code + ' supprim\u00e9' };
                } catch (e) {
                    return { success: false, action: 'deleted', code: input.code, errors: [{ id: input.code, error: e.message }], message: 'Erreur: ' + e.message };
                }
            }

            return { success: false, errors: [], message: 'Outil inconnu: ' + name };
        }

        function ciDismissPending(confirmId) {
            ciPendingToolCalls = null;
            var confirmEl = document.getElementById(confirmId);
            if (confirmEl) {
                var actionsDiv = confirmEl.querySelector('.ci-confirm-actions');
                if (actionsDiv) actionsDiv.innerHTML = '<span style="font-size:11px;color:#999;">Ignor\u00e9</span>';
            }
        }

        // ═══ Pending filter ═══

        function togglePendingFilter() {
            filterPendingOnly = !filterPendingOnly;
            var btn = document.getElementById('filterPendingBtn');
            if (btn) btn.classList.toggle('pending-active', filterPendingOnly);
            generatePriceTables();
        }

        function updatePendingBadge() {
            var count = CATALOGUE_DATA.filter(function(i) { return i.status === 'pending'; }).length;
            var btn = document.getElementById('filterPendingBtn');
            if (btn) {
                btn.textContent = '\u25CF En attente' + (count > 0 ? ' (' + count + ')' : '');
                btn.style.display = canEditCatalogue ? '' : 'none';
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // INITIALISATION
        // ═══════════════════════════════════════════════════════════════════════

        document.addEventListener('DOMContentLoaded', async function() {
            // Charger les permissions utilisateur + les tags médias
            await loadUserPermissions();
            await loadMediaTags();

            // Charger les données du catalogue depuis Supabase (ou cache/défaut)
            await loadCatalogueData();

            // Charger les stats d'utilisation (articles dormants)
            await loadUsageStats();

            // Générer les tableaux avec les données chargées
            generatePriceTables();

            // Setup des handlers de la modal d'édition
            if (canEditCatalogue) {
                setupEditModalHandlers();
                document.getElementById('navAddWrap').style.display = '';
                document.getElementById('navImportBtn').style.display = '';
                document.getElementById('filterPendingBtn').style.display = '';
                setupImportDrawerHandlers();
                updatePendingBadge();
            } else if (isEmbedded) {
                // Non-editors in embedded mode (proposer flow) need modal handlers too
                setupEditModalHandlers();
            }

            // Embedded mode: hide catalogue chrome, only show modal
            if (isEmbedded) {
                document.querySelector('.nav-bar').style.display = 'none';
                document.querySelector('.catalogue-search-bar').style.display = 'none';
                var aiFilterBadge = document.getElementById('aiFilterBadge');
                if (aiFilterBadge) aiFilterBadge.style.display = 'none';
                var headerBar = document.querySelector('.catalogue-header-bar');
                if (headerBar) headerBar.style.display = 'none';
                document.getElementById('mainCatalogueTable').style.display = 'none';
                document.body.style.background = 'transparent';
            }

            // Auto-open edit modal if URL has ?edit=ITEM_ID
            var urlParams = new URLSearchParams(window.location.search);
            var editId = urlParams.get('edit');
            if (editId) {
                var item = CATALOGUE_DATA.find(function(i) { return i.id === editId; });
                if (item && canEditCatalogue) {
                    openEditModal(editId);
                } else if (item) {
                    // Scroll to the item row
                    var row = document.querySelector('tr[data-id="' + CSS.escape(editId) + '"]');
                    if (row) row.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }

            // Auto-create new item if URL has ?new=1 (from calculator proposer flow)
            var newParam = urlParams.get('new');
            if (newParam && (canEditCatalogue || isEmbedded)) {
                var defaultCat = configCategories.length > 0 ? configCategories[0] : 'Autre';
                createNewItem(defaultCat);
            }
        });
    </script>

<!-- Import Drawer (AI Chat) -->
<div class="ci-drawer-overlay" id="ciOverlay" onclick="closeImportDrawer()"></div>
<div class="ci-drawer" id="ciDrawer">
    <div class="ci-drawer-header">
        <h3>Assistant Scopewright</h3>
        <button class="ci-drawer-close" onclick="closeImportDrawer()">&times;</button>
    </div>
    <div class="ci-messages" id="ciMessages"></div>
    <div class="ci-typing" id="ciTyping">
        <div class="ci-typing-dot"></div>
        <div class="ci-typing-dot"></div>
        <div class="ci-typing-dot"></div>
    </div>
    <div class="ci-quick-actions" id="ciQuickActions">
        <button class="ci-quick-btn" onclick="ciQuickAction('Voici un screenshot de ma liste de prix Excel')">Screenshot Excel</button>
        <button class="ci-quick-btn" onclick="ciQuickAction('Voici une liste de prix fournisseur')">Prix fournisseur</button>
        <button class="ci-quick-btn" onclick="ciQuickAction('Je veux ajouter ces articles :')">Liste manuelle</button>
    </div>
    <div class="ci-img-preview" id="ciImgPreview"></div>
    <div class="ci-input-area" style="position:relative;">
        <div class="ci-drop-zone" id="ciDropZone">D&eacute;posez une image ici</div>
        <textarea id="ciInput" placeholder="Collez un screenshot ou d&eacute;crivez les articles..." rows="1" onkeydown="ciInputKeydown(event)"></textarea>
        <button class="ci-send-btn" id="ciSendBtn" onclick="sendImportMessage()" title="Envoyer">&uarr;</button>
    </div>
</div>

<!-- Audit drawer -->
<div class="audit-drawer-overlay" id="auditOverlay" onclick="closeAuditDrawer()"></div>
<div class="audit-drawer" id="auditDrawer">
    <div class="audit-drawer-header">
        <h3>Audit du catalogue</h3>
        <button class="audit-drawer-close" onclick="closeAuditDrawer()">&times;</button>
    </div>
    <div class="audit-body" id="auditBody">
        <div class="audit-empty">Cliquez sur « Auditer » pour lancer l'analyse.</div>
    </div>
</div>

</body>
</html>
