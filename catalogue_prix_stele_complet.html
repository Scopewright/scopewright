<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catalogue de prix — Stele</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">

    <!-- Auth guard — vérifie le token localStorage avant d'afficher la page -->
    <script>
        if (!localStorage.getItem('sb_access_token')) {
            window.location.href = 'login.html';
        } else {
            document.documentElement.style.visibility = 'visible';
        }
    </script>
    <style>html { visibility: hidden; }</style>

    <script>
    /*
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║                                                                              ║
    ║   CATALOGUE DE PRIX STELE — DONNÉES                                          ║
    ║                                                                              ║
    ║   Les données sont chargées automatiquement depuis Supabase.                ║
    ║   En cas de perte de connexion, les dernières données connues sont utilisées.║
    ║                                                                              ║
    ╚══════════════════════════════════════════════════════════════════════════════╝
    */

    const SUPABASE_URL = 'https://rplzbtjfnwahqodrhpny.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJwbHpidGpmbndhaHFvZHJocG55Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NDU2MDEsImV4cCI6MjA4NjIyMTYwMX0.OQAZhc029PbRDSe1b02NDAuOUE8yn-_h3QqSnUDpLeU';

    // Clé pour le localStorage
    const STORAGE_KEY = 'stele_catalogue_data';
    const STORAGE_DATE_KEY = 'stele_catalogue_date';

    // Données par défaut (utilisées uniquement si jamais connecté et pas de cache)
    let CATALOGUE_DATA = [

        // ═══════════════════════════════════════════════════════════════════════
        // BUDGÉTAIRE — Façades et caissons
        // ═══════════════════════════════════════════════════════════════════════
        
        { id: 'BUD-001', category: 'Budgétaire', description: 'Façade (placage de bois) et caisson (mélamine)', type: 'pi²', price: 165.00, instruction: 'Calculer la surface totale des façades en pieds carrés. Inclut le placage de bois sur les façades et la mélamine pour les caissons.' },
        { id: 'BUD-002', category: 'Budgétaire', description: 'Façade (laque opaque) et caisson (mélamine)', type: 'pi²', price: 150.00, instruction: 'Calculer la surface totale des façades en pieds carrés. Finition laque opaque sur les façades.' },
        { id: 'BUD-003', category: 'Budgétaire', description: 'Façade (Shaker mince opaque) et caisson (mélamine)', type: 'pi²', price: 180.00, instruction: 'Calculer la surface totale des façades en pieds carrés. Style Shaker avec profil mince, finition opaque.' },
        { id: 'BUD-004', category: 'Budgétaire', description: 'Façade (Shaker mince placage) et caisson (mélamine)', type: 'pi²', price: 195.00, instruction: 'Calculer la surface totale des façades en pieds carrés. Style Shaker avec profil mince, finition placage.' },
        { id: 'BUD-005', category: 'Budgétaire', description: 'Façade (type AGT) et caisson (mélamine)', type: 'pi²', price: 100.00, instruction: 'Calculer la surface totale des façades en pieds carrés. Panneau AGT (acrylique haute brillance).' },
        { id: 'BUD-006', category: 'Budgétaire', description: 'Caisson ouvert (placage de bois)', type: 'pi²', price: 250.00, instruction: 'Calculer la surface visible du caisson ouvert. Toutes les surfaces visibles sont plaquées.' },
        { id: 'BUD-007', category: 'Budgétaire', description: 'Caisson ouvert (laque opaque)', type: 'pi²', price: 235.00, instruction: 'Calculer la surface visible du caisson ouvert. Toutes les surfaces visibles sont laquées.' },

        // ═══════════════════════════════════════════════════════════════════════
        // PANNEAUX
        // ═══════════════════════════════════════════════════════════════════════
        
        { id: 'PAN-001', category: 'Panneaux', description: 'Revêtement mural (placage)', type: 'pi²', price: 65.00, instruction: 'Calculer la surface murale à couvrir en pieds carrés. Placage de bois sur panneau.' },
        { id: 'PAN-002', category: 'Panneaux', description: 'Panneaux ajouté (placage)', type: 'pi²', price: 55.00, instruction: 'Surface des panneaux décoratifs ajoutés. Placage de bois.' },
        { id: 'PAN-003', category: 'Panneaux', description: 'Panneaux électro (placage)', type: 'pi²', price: 40.00, instruction: 'Panneaux pour habillage d\'électroménagers. Placage de bois.' },
        { id: 'PAN-004', category: 'Panneaux', description: 'Revêtement mural (opaque)', type: 'pi²', price: 58.00, instruction: 'Calculer la surface murale à couvrir en pieds carrés. Finition laque opaque.' },
        { id: 'PAN-005', category: 'Panneaux', description: 'Panneaux ajouté (opaque)', type: 'pi²', price: 48.00, instruction: 'Surface des panneaux décoratifs ajoutés. Finition laque opaque.' },
        { id: 'PAN-006', category: 'Panneaux', description: 'Panneaux électro (opaque)', type: 'pi²', price: 32.00, instruction: 'Panneaux pour habillage d\'électroménagers. Finition laque opaque.' },
        { id: 'PAN-007', category: 'Panneaux', description: 'Intérieur de caisson en stratifié sur CP versus mélamine', type: '%', price: 20, instruction: 'Appliquer ce pourcentage sur le prix total du mobilier concerné.' },

        // ═══════════════════════════════════════════════════════════════════════
        // POIGNÉES
        // ═══════════════════════════════════════════════════════════════════════
        
        { id: 'POI-001', category: 'Poignées', description: 'Ouverture à pression', type: 'unitaire', price: 40.00, instruction: 'Nombre de portes/tiroirs avec système push-to-open.' },
        { id: 'POI-002', category: 'Poignées', description: 'Placage : finger grip 45° avec traverse caisson', type: 'unitaire', price: 220.00, instruction: 'Nombre de poignées intégrées. Inclut la traverse de caisson modifiée. Finition placage.' },
        { id: 'POI-003', category: 'Poignées', description: 'Opaque : finger grip 45° avec traverse caisson', type: 'unitaire', price: 140.00, instruction: 'Nombre de poignées intégrées. Inclut la traverse de caisson modifiée. Finition opaque.' },
        { id: 'POI-004', category: 'Poignées', description: 'Placage : finger grip avec bois massif et replacage', type: 'unitaire', price: 275.00, instruction: 'Nombre de poignées. Poignée en bois massif avec replacage pour continuité du grain.' },

        // ═══════════════════════════════════════════════════════════════════════
        // TIROIRS
        // ═══════════════════════════════════════════════════════════════════════
        
        { id: 'TIR-001', category: 'Tiroirs', description: 'Bois massif à queue d\'aronde', type: 'unitaire', price: 400.00, instruction: 'Nombre de tiroirs. Caisson de tiroir en bois massif avec assemblage traditionnel.' },
        { id: 'TIR-002', category: 'Tiroirs', description: 'Legrabox avec façade', type: 'unitaire', price: 300.00, instruction: 'Nombre de tiroirs. Système Blum Legrabox avec façade incluse.' },
        { id: 'TIR-003', category: 'Tiroirs', description: 'Legrabox avec verre (à l\'anglaise)', type: 'unitaire', price: 350.00, instruction: 'Nombre de tiroirs. Système Blum Legrabox avec côtés en verre.' },

        // ═══════════════════════════════════════════════════════════════════════
        // ÉCLAIRAGE
        // ═══════════════════════════════════════════════════════════════════════
        
        { id: 'ECL-001', category: 'Éclairage', description: 'Bande Flexydel 3000K avec encastrement', type: 'linéaire', price: 53.00, instruction: 'Longueur totale en pieds linéaires. Bande LED encastrée, blanc chaud 3000K.' },
        { id: 'ECL-002', category: 'Éclairage', description: 'Œil magique', type: 'unitaire', price: 140.00, instruction: 'Nombre de spots. Luminaire encastré miniature.' },
        { id: 'ECL-003', category: 'Éclairage', description: 'Transformateur', type: 'unitaire', price: 250.00, instruction: 'Nombre de transformateurs requis. Généralement 1 par zone d\'éclairage.' },

        // ═══════════════════════════════════════════════════════════════════════
        // PORTES INTÉRIEURES
        // ═══════════════════════════════════════════════════════════════════════
        
        { id: 'POR-001', category: 'Portes intérieures', description: 'Porte 30" × 96" en placage sur penture invisible avec cadre', type: 'unitaire', price: null, instruction: 'Prix sur demande. Contacter pour soumission détaillée.' },
        { id: 'POR-002', category: 'Portes intérieures', description: 'Porte 30" × 96" en placage sur penture invisible sans cadre', type: 'unitaire', price: null, instruction: 'Prix sur demande. Contacter pour soumission détaillée.' },
        { id: 'POR-003', category: 'Portes intérieures', description: 'Porte 30" × 96" en placage sur système coulissant (pocket door)', type: 'unitaire', price: null, instruction: 'Prix sur demande. Contacter pour soumission détaillée.' },

    ];

    /*
    ╔══════════════════════════════════════════════════════════════════════════════╗
    ║   FIN DE LA SECTION DONNÉES — Ne pas modifier en dessous de cette ligne      ║
    ║   sauf si vous savez ce que vous faites.                                     ║
    ╚══════════════════════════════════════════════════════════════════════════════╝
    */

    // ═══════════════════════════════════════════════════════════════════════
    // REFRESH AUTOMATIQUE DU TOKEN
    // ═══════════════════════════════════════════════════════════════════════

    async function refreshAccessToken() {
        const refreshToken = localStorage.getItem('sb_refresh_token');
        if (!refreshToken) return false;

        try {
            const response = await fetch(SUPABASE_URL + '/auth/v1/token?grant_type=refresh_token', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'apikey': SUPABASE_KEY
                },
                body: JSON.stringify({ refresh_token: refreshToken })
            });

            if (!response.ok) return false;

            const data = await response.json();
            if (data.access_token) {
                localStorage.setItem('sb_access_token', data.access_token);
                localStorage.setItem('sb_refresh_token', data.refresh_token);
                return true;
            }
            return false;
        } catch (e) {
            console.warn('Échec du refresh token:', e);
            return false;
        }
    }

    async function authenticatedFetch(url, options) {
        const token = localStorage.getItem('sb_access_token');
        const headers = Object.assign({}, options.headers || {}, {
            'apikey': SUPABASE_KEY,
            'Authorization': 'Bearer ' + token
        });

        let response = await fetch(url, Object.assign({}, options, { headers: headers }));

        // Si 401 → tenter un refresh et réessayer une fois
        if (response.status === 401) {
            const refreshed = await refreshAccessToken();
            if (refreshed) {
                const newToken = localStorage.getItem('sb_access_token');
                headers['Authorization'] = 'Bearer ' + newToken;
                response = await fetch(url, Object.assign({}, options, { headers: headers }));
            } else {
                // Refresh échoué → session expirée, rediriger vers login
                localStorage.removeItem('sb_access_token');
                localStorage.removeItem('sb_refresh_token');
                window.location.href = 'login.html';
                return response;
            }
        }

        return response;
    }
    </script>

    <style>
        /* Reset et base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --stele-black: #0A0203;
            --stele-green: #4b6050;
            --stele-gray: #C8C8C8;
            --stele-light-gray: #F8F8F8;
            --stele-white: #FFFFFF;
        }

        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            font-size: 16px;
            line-height: 1.5;
            color: var(--stele-black);
            background: var(--stele-white);
        }

        /* Page setup for print */
        @media print {
            @page {
                size: landscape;
                margin: 0.75in;
            }

            .content-page {
                page-break-after: always;
            }

            .no-print {
                display: none;
            }
        }

        /* Content pages */
        .content-page {
            padding: 40px 60px;
            background: var(--stele-white);
        }

        /* Search bar */
        .catalogue-search-bar {
            position: sticky; top: 56px; z-index: 100;
            background: #fff; padding: 12px 60px;
            border-bottom: 1px solid #e5e7eb;
            margin-top: 56px;
        }
        .catalogue-search-bar input {
            width: 100%; padding: 10px 16px;
            border: 1px solid #d1d5db; border-radius: 10px;
            font-size: 14px; background: #f9fafb;
            outline: none; transition: border-color 0.15s;
        }
        .catalogue-search-bar input:focus {
            border-color: var(--stele-green); background: #fff;
        }
        .catalogue-search-bar input::placeholder { color: #9ca3af; }

        /* Sortable column headers */
        .price-table th.sortable {
            cursor: pointer; user-select: none; position: relative;
            padding-right: 18px;
        }
        .price-table th.sortable:hover { color: var(--stele-green); }
        .price-table th.sortable::after {
            content: '\u2195'; position: absolute; right: 4px; top: 50%;
            transform: translateY(-50%); font-size: 10px; color: #aaa;
        }
        .price-table th.sortable.sort-asc::after { content: '\u25B2'; color: var(--stele-green); }
        .price-table th.sortable.sort-desc::after { content: '\u25BC'; color: var(--stele-green); }

        /* Header */
        .page-header {
            display: flex;
            align-items: center;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--stele-gray);
            margin-bottom: 40px;
        }

        .header-logo {
            font-size: 28px;
            font-weight: 400;
            color: var(--stele-black);
            letter-spacing: -0.5px;
        }

        /* Section title */
        .section-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--stele-black);
            margin-bottom: 24px;
        }


        .legend-title {
            font-weight: 700;
            margin-bottom: 8px;
        }

        .legend ul {
            list-style: none;
            padding-left: 0;
        }

        .legend li {
            margin-bottom: 4px;
            padding-left: 0;
        }

        .legend li::before {
            content: "—";
            margin-right: 8px;
            color: var(--stele-gray);
        }

        /* Tables */
        .price-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        .price-table thead {
            background-color: var(--stele-black);
        }

        .price-table th {
            color: var(--stele-white);
            font-weight: 700;
            font-size: 14px;
            padding: 14px 16px;
            text-align: left;
        }

        .price-table th:nth-child(2) {
            text-align: center;
        }

        .price-table th:last-child {
            text-align: right;
        }

        .price-table td {
            padding: 12px 16px;
            font-size: 14px;
            border-bottom: 1px solid var(--stele-gray);
        }

        .price-table td:nth-child(1) {
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            color: #666;
        }

        .price-table td:nth-child(2) {
            text-align: center;
        }

        .price-table td:last-child {
            text-align: right;
            font-weight: 500;
        }

        .price-table tbody tr:nth-child(odd) {
            background-color: var(--stele-white);
        }

        .price-table tbody tr:nth-child(even) {
            background-color: var(--stele-light-gray);
        }

        .price-table tbody tr:last-child td {
            border-bottom: 2px solid var(--stele-black);
        }

        /* Column widths */
        .col-code { width: 10%; }
        .col-fiche { width: 8%; }
        .col-type { width: 10%; }
        .col-description { width: 52%; }
        .col-price { width: 20%; }

        .fiche-link {
            font-size: 11px;
            color: var(--stele-green);
            text-decoration: none;
            white-space: nowrap;
        }
        .fiche-link:hover { text-decoration: underline; }

        /* Footer */
        .page-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 40px;
            padding-top: 16px;
            font-size: 12px;
            color: var(--stele-black);
        }

        .footer-logo {
            font-size: 14px;
        }

        /* Navigation for web view */
        .nav-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--stele-white);
            border-bottom: 1px solid var(--stele-gray);
            padding: 12px 60px;
            display: flex;
            align-items: center;
            gap: 32px;
            z-index: 100;
        }

        .nav-logo {
            font-size: 20px;
            font-weight: 400;
            color: var(--stele-black);
        }

        .nav-links {
            display: flex;
            gap: 24px;
            flex-wrap: wrap;
        }

        .nav-links a {
            color: var(--stele-black);
            text-decoration: none;
            font-size: 14px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .nav-links a:hover {
            opacity: 1;
        }

        .nav-back {
            opacity: 0.4;
            border-right: 1px solid var(--stele-gray);
            padding-right: 24px;
            margin-right: 0;
        }

        .nav-back:hover {
            opacity: 0.7;
        }

        @media print {
            .nav-bar, .catalogue-search-bar {
                display: none;
            }

            .content-page {
                min-height: auto;
            }
        }

        /* Indicateur de statut des données */
        .data-status {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            padding: 6px 12px;
            border-radius: 20px;
            background: var(--stele-light-gray);
        }

        .data-status.online {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .data-status.offline {
            background: #fff3e0;
            color: #ef6c00;
        }

        .data-status.error {
            background: #ffebee;
            color: #c62828;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        .data-status.online .status-dot {
            background: #4caf50;
        }

        .data-status.offline .status-dot {
            background: #ff9800;
        }

        .data-status.error .status-dot {
            background: #f44336;
        }

        .status-text {
            white-space: nowrap;
        }

        @media print {
            .data-status {
                display: none;
            }
        }


        /* Tooltip styles */
        .tooltip-container {
            position: relative;
            cursor: help;
        }

        .tooltip {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--stele-black);
            color: var(--stele-white);
            padding: 10px 14px;
            border-radius: 4px;
            font-size: 12px;
            line-height: 1.5;
            white-space: normal;
            width: 240px;
            text-align: left;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: opacity 0.2s ease, visibility 0.2s ease;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }

        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--stele-black);
        }

        .tooltip-container:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        .tooltip-title {
            font-weight: 700;
            margin-bottom: 4px;
            font-size: 12px;
        }

        .tooltip-text {
            font-weight: 400;
            color: rgba(255,255,255,0.85);
        }

        /* Tooltips dans les tableaux */
        .tooltip-table {
            cursor: help;
            border-bottom: 1px dotted var(--stele-gray);
        }

        .tooltip-table .tooltip {
            width: 280px;
        }

        /* Tooltip aligné à gauche pour les descriptions longues */
        .tooltip-left .tooltip {
            left: 0;
            transform: translateX(0);
        }

        .tooltip-left .tooltip::after {
            left: 24px;
            transform: translateX(0);
        }

        /* Image dans le tooltip */
        .tooltip-image {
            width: 100%;
            max-width: 200px;
            height: auto;
            border-radius: 3px;
            margin-bottom: 8px;
            display: block;
        }

        .tooltip-table .tooltip.has-image {
            width: 320px;
        }

        /* Bouton modifier dans les tableaux */
        .col-edit {
            width: 40px;
            text-align: center;
        }

        .btn-edit-row {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px 6px;
            opacity: 0;
            transition: opacity 0.15s;
            color: var(--stele-black);
            font-size: 14px;
            border-radius: 3px;
        }

        .btn-edit-row:hover {
            background: rgba(0,0,0,0.06);
        }

        .price-table tbody tr:hover .btn-edit-row {
            opacity: 0.5;
        }

        .price-table tbody tr:hover .btn-edit-row:hover {
            opacity: 1;
        }

        .btn-add-item {
            width: 24px;
            height: 24px;
            border: 1.5px solid rgba(255,255,255,0.5);
            background: transparent;
            color: rgba(255,255,255,0.7);
            border-radius: 50%;
            font-size: 16px;
            line-height: 1;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
            padding: 0;
        }

        .btn-add-item:hover {
            background: rgba(255,255,255,0.2);
            color: #fff;
            border-color: rgba(255,255,255,0.8);
        }

        /* Modal d'édition — agrandie pour les champs */
        .modal.modal-edit {
            max-width: 800px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        .edit-row {
            display: flex;
            gap: 12px;
        }

        .edit-row .form-group {
            flex: 1;
        }

        /* ═══ Prix composé — tableaux minutes & matériaux ═══ */
        .composed-price-section {
            display: flex;
            gap: 16px;
            margin-top: 8px;
        }
        .cp-table-wrap {
            flex: 1;
            min-width: 0;
        }
        .calc-rule-json {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            tab-size: 2;
        }
        .calc-rule-error {
            color: #c62828;
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }
        .calc-rule-success {
            border-color: var(--stele-green) !important;
            transition: border-color 1.5s;
        }
        .cp-section-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--stele-green);
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 1px solid #f0f0f0;
        }
        .cp-sub-title {
            font-size: 11px;
            font-weight: 600;
            color: #555;
            margin-bottom: 6px;
        }
        .cp-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .cp-table th {
            text-align: left;
            font-weight: 600;
            font-size: 11px;
            color: #888;
            padding: 4px 6px;
            border-bottom: 1px solid #e0e0e0;
        }
        .cp-table th:last-child {
            text-align: right;
        }
        .cp-table td {
            padding: 3px 6px;
        }
        .cp-table td:first-child {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 140px;
            font-size: 11px;
        }
        .cp-table input[type="number"] {
            width: 100%;
            padding: 4px 6px;
            border: 1px solid #e0e0e0;
            border-radius: 3px;
            font-size: 12px;
            text-align: right;
            font-family: inherit;
        }
        .cp-table input[type="number"]:focus {
            outline: none;
            border-color: var(--stele-green);
        }
        .cp-table input[type="number"]:disabled {
            background: #f0f0f0;
            color: #999;
            cursor: not-allowed;
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textbox; }
        .cp-calculated {
            margin-top: 12px;
            padding: 10px 14px;
            background: #f8f8f4;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }
        .cp-calculated .cp-total-label {
            font-weight: 600;
            color: #555;
        }
        .cp-calculated .cp-total-value {
            font-weight: 700;
            font-size: 16px;
            color: var(--stele-green);
        }
        .cp-calculated .cp-breakdown {
            font-size: 11px;
            color: #888;
            margin-left: 8px;
        }
        @media (max-width: 768px) {
            .composed-price-section {
                flex-direction: column;
            }
            .modal.modal-edit {
                max-width: 98vw;
            }
        }

        /* ═══ Composantes fournisseur ═══ */
        .comp-row {
            display: flex; gap: 6px; align-items: center; margin-bottom: 6px;
        }
        .comp-row input, .comp-row select {
            padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px;
            font-size: 13px; font-family: inherit;
        }
        .comp-row input:focus, .comp-row select:focus { border-color: var(--stele-green); outline: none; }
        .comp-supplier-wrap {
            flex: 2; min-width: 0; position: relative;
        }
        .comp-supplier-wrap input {
            width: 100%; box-sizing: border-box;
        }
        .comp-supplier-dd {
            display: none; position: absolute; top: 100%; left: 0; right: 0;
            background: #fff; border: 1px solid #ddd; border-top: none; border-radius: 0 0 4px 4px;
            max-height: 200px; overflow-y: auto; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .comp-supplier-dd.open { display: block; }
        .comp-supplier-dd .comp-dd-item {
            padding: 7px 10px; cursor: pointer; font-size: 13px;
        }
        .comp-supplier-dd .comp-dd-item:hover { background: #f0f0f0; }
        .comp-supplier-dd .comp-dd-item.selected { background: #e8f0ea; font-weight: 600; }
        .comp-supplier-dd .comp-dd-add {
            padding: 7px 10px; cursor: pointer; font-size: 12px; color: var(--stele-green);
            font-weight: 600; border-top: 1px solid #eee;
        }
        .comp-supplier-dd .comp-dd-add:hover { background: #f5f5f5; }
        /* Supplier subtitle in catalogue list */
        .item-supplier-sub { font-size: 11px; color: #aaa; margin-top: 2px; }
        /* Default star in catalogue list */
        .default-star {
            cursor: pointer; font-size: 15px; color: #ddd; user-select: none;
            transition: color 0.15s; vertical-align: middle;
        }
        .default-star.active { color: #F59E0B; }
        .default-star:hover { color: #F59E0B; }
        /* Default filter button in nav */
        .nav-filter-btn {
            padding: 3px 10px; border: 1px solid #ddd; border-radius: 12px;
            background: #fff; cursor: pointer; font-size: 13px; color: #888;
            margin-left: 8px; transition: all 0.15s;
        }
        .nav-filter-btn.active { background: #F59E0B; color: #fff; border-color: #F59E0B; }
        .nav-filter-btn:hover { border-color: #F59E0B; color: #F59E0B; }
        .nav-filter-btn.active:hover { background: #d4880a; }
        .comp-category { flex: 1.5; min-width: 0; }
        .comp-sku { flex: 1.2; min-width: 0; }
        .comp-desc { flex: 2.5; min-width: 0; }
        .comp-qty { width: 55px; flex: none; text-align: center; }
        .comp-cost { width: 80px; flex: none; text-align: right; }
        .comp-remove {
            flex: none; width: 28px; height: 28px; border: 1px solid #c62828;
            background: #fff; color: #c62828; border-radius: 4px; cursor: pointer;
            font-size: 14px; line-height: 1; display: flex; align-items: center; justify-content: center;
        }
        .comp-remove:hover { background: #c62828; color: #fff; }
        .comp-header {
            display: flex; gap: 6px; margin-bottom: 4px; padding: 0 0 4px;
            border-bottom: 1px solid #eee;
        }
        .comp-header span {
            font-size: 11px; font-weight: 600; color: #888; text-transform: uppercase; letter-spacing: 0.3px;
        }
        .btn-add-component {
            background: none; border: 1px dashed #bbb; color: #666; padding: 6px 14px;
            border-radius: 4px; cursor: pointer; font-size: 12px; margin-top: 4px;
        }
        .btn-add-component:hover { border-color: var(--stele-green); color: var(--stele-green); }
        /* Matériaux verrouillés par composantes */
        .cp-table td.cp-locked-cell { position: relative; }
        .cp-table td.cp-locked-cell input { background: #f0f0f0; color: #888; }
        .cp-table td.cp-locked-cell::after {
            content: 'auto'; position: absolute; right: 6px; top: 50%; transform: translateY(-50%);
            font-size: 9px; color: #aaa; font-weight: 600; text-transform: uppercase; pointer-events: none;
        }
        /* Stele confirm dialog */
        .stele-confirm-overlay {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.45);
            z-index: 9999; justify-content: center; align-items: center;
        }
        .stele-confirm-overlay.active { display: flex; }
        .stele-confirm-box {
            background: #fff; border-radius: 10px; box-shadow: 0 8px 32px rgba(0,0,0,0.25);
            max-width: 480px; width: 90%; overflow: hidden;
        }
        .stele-confirm-box h3 { padding: 18px 24px 0; font-size: 15px; font-weight: 700; color: var(--stele-black); margin: 0; }
        .stele-confirm-box .scb-body { padding: 12px 24px 20px; font-size: 14px; color: #444; }
        .stele-confirm-box .scb-amount { font-size: 22px; font-weight: 700; color: #c0392b; display: block; margin: 8px 0; }
        .stele-confirm-box .scb-footer { display: flex; justify-content: flex-end; gap: 8px; padding: 0 24px 18px; }
        .stele-confirm-box .scb-footer button {
            padding: 8px 20px; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; border: 1px solid #ccc;
        }
        .scb-btn-cancel { background: #f5f5f5; color: #333; }
        .scb-btn-cancel:hover { background: #e8e8e8; }
        .scb-btn-ok { background: var(--stele-green); color: #fff; border-color: var(--stele-green) !important; }
        .scb-btn-ok:hover { opacity: 0.9; }

        /* ═══ Médias tagués ═══ */
        .cat-media-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--stele-green);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #f0f0f0;
        }

        .cat-dropzone {
            border: 2px dashed var(--stele-gray);
            border-radius: 6px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s;
            font-size: 13px;
            color: #888;
            margin-bottom: 12px;
        }

        .cat-dropzone:hover,
        .cat-dropzone.dragover {
            border-color: var(--stele-green);
            color: var(--stele-green);
        }

        .cat-media-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .cat-media-item {
            display: flex;
            gap: 10px;
            padding: 10px;
            background: #f8f8f8;
            border-radius: 6px;
            align-items: flex-start;
        }

        .cat-media-item img {
            width: 80px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid var(--stele-gray);
            flex-shrink: 0;
        }

        .cat-pdf-icon {
            width: 80px;
            height: 60px;
            background: #e8e8e8;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            color: #999;
            flex-shrink: 0;
        }

        .cat-media-info { flex: 1; min-width: 0; }

        .cat-media-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .cat-tag {
            display: inline-block;
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 12px;
            cursor: pointer;
            border: 1px solid var(--stele-gray);
            background: #fff;
            color: #666;
            transition: all 0.15s;
            user-select: none;
        }

        .cat-tag.active {
            background: var(--stele-green);
            color: #fff;
            border-color: var(--stele-green);
        }

        .cat-media-remove {
            background: none;
            border: none;
            color: #c62828;
            cursor: pointer;
            font-size: 18px;
            padding: 0 4px;
            flex-shrink: 0;
            opacity: 0.5;
            transition: opacity 0.15s;
        }

        .cat-media-remove:hover { opacity: 1; }

        /* ═══ Crop Modal (même pattern que calculateur.html) ═══ */
        .crop-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.88); z-index: 3000;
            justify-content: center; align-items: center; flex-direction: column;
        }
        .crop-overlay.active { display: flex; }
        .crop-box {
            background: #fff; border-radius: 8px; overflow: hidden;
            width: 90vw; max-width: 800px; max-height: 90vh; display: flex; flex-direction: column;
        }
        .crop-header {
            padding: 14px 20px; font-weight: 700; font-size: 15px;
            border-bottom: 1px solid #eee; display: flex; align-items: center; justify-content: space-between;
        }
        .crop-container { position: relative; flex: 1; min-height: 300px; max-height: 60vh; background: #222; overflow: hidden; }
        .crop-container img { display: block; max-width: 100%; }
        .crop-controls {
            padding: 12px 20px; display: flex; gap: 10px; align-items: center;
            border-top: 1px solid #eee; justify-content: space-between;
        }
        .crop-controls .crop-ratios { display: flex; gap: 6px; }
        .crop-controls .crop-ratio-btn {
            padding: 6px 16px; border: 2px solid #ccc; border-radius: 4px;
            background: #fff; cursor: pointer; font-size: 13px; font-weight: 600;
        }
        .crop-controls .crop-ratio-btn.active { border-color: var(--stele-green); background: var(--stele-green); color: #fff; }
        .crop-controls .crop-actions { display: flex; gap: 8px; }
        .crop-controls .crop-btn {
            padding: 8px 20px; border: none; border-radius: 4px;
            cursor: pointer; font-size: 13px; font-weight: 600;
        }
        .crop-btn-cancel { background: #eee; color: #555; }
        .crop-btn-confirm { background: var(--stele-green); color: #fff; }
        .crop-btn-confirm:disabled { opacity: 0.5; cursor: not-allowed; }
        .crop-error { padding: 10px 20px; background: #fee; color: #c00; font-size: 13px; display: none; }

        .edit-toggle-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .edit-toggle {
            position: relative;
            display: inline-block;
            width: 38px;
            height: 22px;
        }

        .edit-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .edit-toggle .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #ddd;
            border-radius: 22px;
            transition: background 0.25s;
        }

        .edit-toggle .slider::before {
            content: '';
            position: absolute;
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background: #fff;
            border-radius: 50%;
            transition: transform 0.25s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.15);
        }

        .edit-toggle input:checked + .slider {
            background: var(--stele-green);
        }

        .edit-toggle input:checked + .slider::before {
            transform: translateX(16px);
        }

        .edit-toggle-label {
            font-size: 13px;
            color: var(--stele-black);
        }

        .btn-sales-sheet {
            margin-left: auto;
            padding: 5px 12px;
            font-size: 12px;
            font-family: inherit;
            background: var(--stele-green);
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .btn-sales-sheet:hover { background: #3d4f42; }

        .btn-delete-item {
            padding: 8px 14px;
            font-size: 13px;
            font-family: inherit;
            background: none;
            color: #c62828;
            border: 1px solid #c62828;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.15s, color 0.15s;
        }

        .btn-delete-item:hover {
            background: #c62828;
            color: #fff;
        }

        .edit-status {
            font-size: 13px;
            padding: 8px 12px;
            border-radius: 4px;
            margin-top: 8px;
            display: none;
        }

        .edit-status.success {
            display: block;
            background: #e8f5e9;
            color: #2e7d32;
        }

        .edit-status.error {
            display: block;
            background: #ffebee;
            color: #c62828;
        }


        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--stele-white);
            border-radius: 8px;
            width: 100%;
            max-width: 450px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--stele-gray);
            display: flex; align-items: center; justify-content: space-between;
        }
        .modal-nav {
            display: flex; gap: 2px;
        }
        .modal-nav button {
            width: 32px; height: 32px; border-radius: 6px; border: 1px solid #ddd;
            background: #f8f8f8; cursor: pointer; font-size: 16px; color: #555;
            display: flex; align-items: center; justify-content: center; transition: all 0.15s;
        }
        .modal-nav button:hover:not(:disabled) { background: #eee; color: var(--stele-black); }
        .modal-nav button:disabled { opacity: 0.3; cursor: default; }

        .modal-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--stele-black);
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--stele-black);
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            font-size: 14px;
            font-family: inherit;
            border: 1px solid var(--stele-gray);
            border-radius: 4px;
            background: var(--stele-white);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--stele-green);
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--stele-gray);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .btn-cancel {
            padding: 10px 20px;
            background: transparent;
            color: var(--stele-black);
            border: 1px solid var(--stele-gray);
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-cancel:hover {
            background: var(--stele-light-gray);
        }

        .btn-generate {
            padding: 10px 20px;
            background: var(--stele-green);
            color: var(--stele-white);
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-generate:hover {
            background: #3d4f42;
        }
        /* Global add button in nav */
        .nav-add-wrap { position: relative; display: inline-block; margin-left: 8px; }
        .nav-add-btn {
            width: 28px; height: 28px; border-radius: 50%; border: 1.5px solid #ddd;
            background: #fff; color: #555; font-size: 18px; line-height: 1; cursor: pointer;
            display: inline-flex; align-items: center; justify-content: center; transition: all 0.15s;
        }
        .nav-add-btn:hover { border-color: var(--stele-green); color: var(--stele-green); }
        .nav-add-dd {
            display: none; position: absolute; top: 100%; right: 0; margin-top: 6px;
            background: #fff; border: 1px solid #ddd; border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.12); min-width: 220px; z-index: 500;
            max-height: 320px; overflow-y: auto;
        }
        .nav-add-dd.open { display: block; }
        .nav-add-dd .add-dd-item {
            padding: 8px 14px; cursor: pointer; font-size: 13px;
        }
        .nav-add-dd .add-dd-item:hover { background: #f0f0f0; }
        .nav-add-dd .add-dd-sep {
            border-top: 1px solid #eee; margin: 4px 0;
        }
        .nav-add-dd .add-dd-input {
            padding: 8px 14px; display: flex; gap: 6px;
        }
        .nav-add-dd .add-dd-input input {
            flex: 1; padding: 6px 10px; border: 1px solid #ddd; border-radius: 6px;
            font-size: 13px; font-family: inherit;
        }
        .nav-add-dd .add-dd-input input:focus { outline: none; border-color: var(--stele-green); }
        .nav-add-dd .add-dd-input button {
            padding: 6px 12px; background: var(--stele-green); color: #fff; border: none;
            border-radius: 6px; font-size: 12px; cursor: pointer; white-space: nowrap;
        }

        /* ═══ Import Drawer (AI Chat) — Premium Redesign ═══ */

        @keyframes ciMsgFadeIn {
            from { opacity: 0; transform: translateY(6px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes ciCardStagger {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .ci-drawer-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: transparent; z-index: 8700; pointer-events: none;
        }
        .ci-drawer-overlay.active { display: block; }

        .ci-drawer {
            position: fixed; top: 0; right: -460px; width: 440px; height: 100%;
            background: #fff; box-shadow: -2px 0 24px rgba(0,0,0,0.08);
            z-index: 8800; transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; flex-direction: column;
        }
        .ci-drawer.active { right: 0; }

        .ci-drawer-header {
            display: flex; align-items: center; gap: 10px;
            padding: 16px 20px; border-bottom: 1px solid #f0f0f0;
            background: #fff; flex-shrink: 0;
        }
        .ci-drawer-header h3 {
            font-size: 14px; font-weight: 600; margin: 0;
            color: #1A1A2E; flex: 1; letter-spacing: -0.01em;
        }
        .ci-drawer-close {
            background: none; border: none; font-size: 18px;
            cursor: pointer; color: #9ca3af; padding: 2px 4px;
            transition: color 0.15s; border-radius: 6px;
        }
        .ci-drawer-close:hover { color: #1A1A2E; }

        .ci-messages {
            flex: 1; overflow-y: auto; padding: 20px;
            display: flex; flex-direction: column; gap: 16px; justify-content: flex-end;
            overscroll-behavior: contain;
            scrollbar-width: thin; scrollbar-color: #e5e7eb transparent;
        }
        .ci-messages::-webkit-scrollbar { width: 5px; }
        .ci-messages::-webkit-scrollbar-track { background: transparent; }
        .ci-messages::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 3px; }
        .ci-messages::-webkit-scrollbar-thumb:hover { background: #d1d5db; }
        .ci-messages:empty::after {
            content: 'Collez un screenshot Excel, tapez une liste de prix, ou d\e9crivez les articles \e0 importer.';
            color: #9ca3af; font-size: 13px; text-align: center; padding: 40px 24px;
            line-height: 1.6;
        }

        .ci-msg {
            max-width: 85%; padding: 0; border-radius: 0;
            font-size: 14px; line-height: 1.5; word-wrap: break-word;
            color: #1A1A2E;
            animation: ciMsgFadeIn 180ms ease-out both;
        }
        .ci-msg p { margin: 0 0 8px 0; }
        .ci-msg p:last-child { margin-bottom: 0; }
        .ci-msg ul, .ci-msg ol { margin: 6px 0; padding-left: 20px; }
        .ci-msg li { margin-bottom: 4px; }
        .ci-msg strong { font-weight: 600; }
        .ci-msg code {
            background: #f3f4f6; padding: 2px 6px; border-radius: 4px;
            font-size: 13px; font-family: 'SF Mono', 'Cascadia Code', 'Consolas', monospace;
        }
        .ci-msg pre {
            background: #f8f9fa; padding: 12px 14px; border-radius: 8px;
            overflow-x: auto; font-size: 12px; margin: 8px 0;
            font-family: 'SF Mono', 'Cascadia Code', 'Consolas', monospace;
            line-height: 1.5;
        }

        /* Cards — replace tables */
        .ci-msg .ci-card-stack { display: flex; flex-direction: column; gap: 6px; margin: 10px 0; }
        .ci-msg .ci-card {
            background: #F8FAFC; border-radius: 10px; padding: 12px 14px;
            animation: ciCardStagger 180ms ease-out both;
        }
        .ci-msg .ci-card-row {
            display: flex; justify-content: space-between; align-items: baseline;
        }
        .ci-msg .ci-card-code {
            font-size: 12px; font-weight: 600; color: #6B7280;
            font-family: 'SF Mono', 'Cascadia Code', 'Consolas', monospace;
            letter-spacing: 0.02em;
        }
        .ci-msg .ci-card-price {
            font-size: 13px; font-weight: 600; color: #1A1A2E;
            font-family: 'SF Mono', 'Cascadia Code', 'Consolas', monospace;
        }
        .ci-msg .ci-card-desc {
            font-size: 13px; color: #374151; margin-top: 2px; line-height: 1.4;
        }
        .ci-msg .ci-card-meta {
            font-size: 11px; color: #9ca3af; margin-top: 4px;
        }

        /* Legacy table fallback — soft styling */
        .ci-msg table {
            width: 100%; border-collapse: separate; border-spacing: 0;
            margin: 8px 0; font-size: 13px; border-radius: 8px;
            overflow: hidden; background: #F8FAFC;
        }
        .ci-msg th, .ci-msg td {
            padding: 8px 12px; border: none; text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }
        .ci-msg th {
            background: #f1f5f9; font-weight: 600; font-size: 11px;
            color: #6B7280; text-transform: uppercase; letter-spacing: 0.04em;
        }
        .ci-msg tr:last-child td { border-bottom: none; }

        .ci-msg-user {
            align-self: flex-end; background: #F1F5F9;
            padding: 10px 14px; border-radius: 12px; border-bottom-right-radius: 4px;
        }
        .ci-msg-assistant {
            align-self: flex-start; background: transparent;
            padding: 2px 0;
        }

        .ci-msg-confirm {
            align-self: flex-start; background: #fff; border: none;
            border-radius: 12px; padding: 14px 16px; max-width: 92%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 0 0 1px rgba(0,0,0,0.04);
        }
        .ci-msg-confirm .ci-confirm-text {
            font-size: 14px; color: #1A1A2E; margin-bottom: 12px; line-height: 1.5;
        }
        .ci-confirm-actions { display: flex; gap: 8px; align-items: center; }
        .ci-confirm-actions button {
            padding: 8px 18px; border-radius: 8px; font-size: 13px; font-weight: 600;
            cursor: pointer; border: none; transition: all 0.15s;
        }
        .btn-ci-apply { background: #1B2B4B; color: #fff; }
        .btn-ci-apply:hover { background: #15223b; }
        .btn-ci-dismiss { background: transparent; color: #6B7280; padding: 8px 12px; }
        .btn-ci-dismiss:hover { color: #1A1A2E; }
        .ci-confirm-applied { font-size: 12px; color: #4b6050; font-weight: 500; }

        .ci-typing {
            padding: 12px 0 0 0; display: none;
        }
        .ci-typing.active { display: flex; gap: 5px; align-items: center; }
        .ci-typing-dot {
            width: 6px; height: 6px; border-radius: 50%; background: #d1d5db;
            animation: ciTypingBounce 1.2s infinite;
        }
        .ci-typing-dot:nth-child(2) { animation-delay: 0.15s; }
        .ci-typing-dot:nth-child(3) { animation-delay: 0.3s; }
        @keyframes ciTypingBounce {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-3px); opacity: 1; }
        }

        .ci-quick-actions {
            display: flex; gap: 6px; padding: 10px 20px; flex-wrap: wrap;
            border-top: 1px solid #f5f5f5; flex-shrink: 0;
        }
        .ci-quick-btn {
            padding: 6px 12px; border-radius: 8px; font-size: 12px;
            background: #fff; border: 1px solid #e5e7eb; color: #6B7280;
            cursor: pointer; transition: all 0.15s; white-space: nowrap;
            font-weight: 500;
        }
        .ci-quick-btn:hover { background: #f9fafb; border-color: #d1d5db; color: #374151; }

        .ci-input-area {
            display: flex; gap: 8px; padding: 12px 16px 14px;
            border-top: 1px solid #f0f0f0;
            background: #fff; flex-shrink: 0; align-items: flex-end;
        }
        .ci-input-area textarea {
            flex: 1; resize: none; border: 1px solid #e5e7eb; border-radius: 10px;
            padding: 10px 14px; font-size: 14px; font-family: inherit; line-height: 1.4;
            max-height: 120px; min-height: 40px; outline: none;
            transition: border-color 0.15s; background: #fafbfc;
            color: #1A1A2E;
        }
        .ci-input-area textarea:focus { border-color: #d1d5db; background: #fff; }
        .ci-input-area textarea::placeholder { color: #9ca3af; }

        .ci-send-btn {
            width: 36px; height: 36px; border-radius: 10px; border: none;
            background: #1B2B4B; color: #fff; font-size: 16px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: background 0.15s; flex-shrink: 0;
        }
        .ci-send-btn:hover { background: #15223b; }
        .ci-send-btn:disabled { background: #e5e7eb; color: #9ca3af; cursor: default; }

        .ci-drop-zone {
            display: none; position: absolute; inset: 0; background: rgba(27,43,75,0.04);
            border: 2px dashed #d1d5db; border-radius: 10px;
            z-index: 10; align-items: center; justify-content: center;
            font-size: 13px; color: #6B7280; font-weight: 500;
        }
        .ci-drop-zone.active { display: flex; }

        .ci-img-preview {
            display: flex; gap: 6px; padding: 6px 20px; flex-wrap: wrap; flex-shrink: 0;
        }
        .ci-img-preview:empty { display: none; }
        .ci-img-thumb {
            position: relative; width: 52px; height: 52px; border-radius: 8px;
            overflow: hidden; border: 1px solid #e5e7eb;
        }
        .ci-img-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .ci-img-thumb .ci-img-remove {
            position: absolute; top: 2px; right: 2px; width: 18px; height: 18px;
            border-radius: 50%; background: rgba(0,0,0,0.5); color: #fff;
            border: none; font-size: 11px; cursor: pointer; display: flex;
            align-items: center; justify-content: center; line-height: 1;
            transition: background 0.15s;
        }
        .ci-img-thumb .ci-img-remove:hover { background: rgba(0,0,0,0.7); }
        /* ═══ Pending badge ═══ */
        .item-pending-badge {
            font-size: 10px; font-weight: 600; padding: 2px 8px;
            border-radius: 10px; background: #FFF3E0; color: #E65100;
            margin-left: 8px; text-transform: uppercase;
            cursor: pointer; transition: background 0.15s;
        }
        .item-pending-badge:hover { background: #E8F5E9; color: #2E7D32; }
        .nav-filter-btn.pending-active { background: #E65100; color: #fff; }
        @media (max-width: 600px) {
            .ci-drawer { width: 100%; right: -100%; }
        }

    </style>
</head>
<body>

    <!-- Navigation (web only) -->
    <nav class="nav-bar no-print">
        <span class="nav-logo">stele</span>
        <div class="nav-links" id="navLinks">
            <a href="app.html" class="nav-back">&larr; Menu</a>
            <button class="nav-filter-btn" id="filterDefaultBtn" onclick="toggleDefaultFilter()" title="Afficher seulement les articles par d&eacute;faut">&#9733; D&eacute;faut</button>
            <button class="nav-filter-btn" id="filterPendingBtn" style="display:none;" onclick="togglePendingFilter()">&#9679; En attente</button>
            <button class="nav-filter-btn" id="navImportBtn" style="display:none;" onclick="toggleImportDrawer()">&#x2728; Assistant</button>
            <!-- Les liens des catégories sont générés dynamiquement -->
            <div class="nav-add-wrap" id="navAddWrap" style="display:none;">
                <button class="nav-add-btn" onclick="toggleAddDropdown()" title="Ajouter un article">+</button>
                <div class="nav-add-dd" id="navAddDd"></div>
            </div>
        </div>
        <div class="data-status" id="dataStatus">
            <span class="status-dot"></span>
            <span class="status-text" id="statusText">Chargement...</span>
        </div>
    </nav>

    <!-- Barre de recherche -->
    <div class="catalogue-search-bar no-print" id="catalogueSearchBar">
        <input type="text" id="catalogueSearchInput" placeholder="Rechercher un article (code, description, cat&#233;gorie...)" oninput="filterCatalogueSearch()">
    </div>

    <!-- Conteneur pour les sections de catégories (générées dynamiquement) -->
    <div id="dynamicSections"></div>


    <!-- Modal Édition catalogue -->
    <div class="modal-overlay" id="editModal">
        <div class="modal modal-edit">
            <div class="modal-header">
                <h3 class="modal-title">Modifier l'article</h3>
                <div class="modal-nav">
                    <button id="btnPrevItem" onclick="navigateItem(-1)" title="Article pr&eacute;c&eacute;dent">&#8249;</button>
                    <button id="btnNextItem" onclick="navigateItem(1)" title="Article suivant">&#8250;</button>
                </div>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editItemId">
                <div class="edit-row">
                    <div class="form-group">
                        <label class="form-label">Code</label>
                        <input type="text" class="form-input" id="editCode" readonly style="background:#f5f5f5; color:#888;">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Cat&eacute;gorie</label>
                        <select class="form-input" id="editCategory"></select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <input type="text" class="form-input" id="editDescription">
                </div>
                <div class="edit-row">
                    <div class="form-group">
                        <label class="form-label">Type</label>
                        <select class="form-input" id="editType"></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Prix</label>
                        <input type="hidden" id="editPrice">
                        <div class="form-input" id="editPriceDisplay" style="background:#f5f5f5; color:#888; min-height:38px; display:flex; align-items:center;">Calculé automatiquement</div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Instruction</label>
                    <textarea class="form-input" id="editInstruction" rows="2" style="resize:vertical;"></textarea>
                </div>
                <!-- Présentation client (admin only) -->
                <div class="form-group" id="clientTextGroup" style="display:none;">
                    <div class="cp-section-title">Pr&eacute;sentation client</div>
                    <label class="form-label" style="margin-top:8px;">Texte</label>
                    <input type="text" class="form-input" id="editClientText" placeholder="Ex: placage de ch&ecirc;ne blanc FC">
                </div>
                <!-- Comment décrire au client (admin only) -->
                <div class="form-group" id="presRuleGroup" style="display:none;">
                    <div class="cp-section-title">Comment d&eacute;crire au client</div>
                    <label class="form-label" style="margin-top:8px;">Explication</label>
                    <textarea class="form-input" id="editPresRuleHuman" rows="3" style="resize:vertical;" placeholder="Ex: Le mat&eacute;riau appara&icirc;t en premier avec le pr&eacute;fixe 'en'. Ne pas mentionner les pattes ni la bande de chant au client."></textarea>
                    <label class="form-label" style="margin-top:8px;">JSON</label>
                    <textarea class="form-input calc-rule-json" id="editPresRuleAi" rows="6" style="resize:vertical;" placeholder="JSON structur&eacute; pour l'AI..."></textarea>
                </div>
                <!-- Instructions AI (admin only) -->
                <div class="form-group" id="calcRuleGroup" style="display:none;">
                    <div class="cp-section-title">Instructions AI</div>
                    <label class="form-label" style="margin-top:8px;">Explication</label>
                    <textarea class="form-input" id="editCalcRuleHuman" rows="3" style="resize:vertical;" placeholder="Ex: Caisson au sol &mdash; ajouter 4 pattes. Demander largeur, profondeur, hauteur. Utiliser le mat&eacute;riau int&eacute;rieur des mat&eacute;riaux par d&eacute;faut." oninput="updateGenerateRuleBtn()"></textarea>
                    <div class="calc-rule-error" id="calcRuleError"></div>
                    <label class="form-label" style="margin-top:8px;">JSON</label>
                    <textarea class="form-input calc-rule-json" id="editCalcRuleAi" rows="6" style="resize:vertical;" placeholder="Instructions structur&eacute;es pour l'AI..."></textarea>
                </div>
                <!-- Composantes fournisseur -->
                <div class="form-group" id="componentsGroup">
                    <div class="cp-section-title">Composantes fournisseur</div>
                    <div id="componentsList"></div>
                    <button type="button" class="btn-add-component" onclick="addComponent()">+ Ajouter une composante</button>
                </div>
                <!-- Prix composé — Minutes & Matériaux -->
                <div class="form-group" id="composedPriceGroup">
                    <div class="cp-section-title">Prix compos&eacute;</div>
                    <div class="composed-price-section">
                        <div class="cp-table-wrap">
                            <div class="cp-sub-title">Minutes main-d'&oelig;uvre</div>
                            <table class="cp-table">
                                <thead><tr><th>D&eacute;partement</th><th style="width:70px">Min.</th></tr></thead>
                                <tbody id="cpMinutesBody"></tbody>
                            </table>
                        </div>
                        <div class="cp-table-wrap">
                            <div class="cp-sub-title">Mat&eacute;riaux</div>
                            <table class="cp-table">
                                <thead><tr><th>Cat&eacute;gorie</th><th style="width:80px">Co&ucirc;t ($)</th></tr></thead>
                                <tbody id="cpMaterialsBody"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="cp-calculated">
                        <div>
                            <span class="cp-total-label">Prix calcul&eacute;</span>
                            <span class="cp-breakdown" id="cpBreakdown"></span>
                        </div>
                        <span class="cp-total-value" id="cpTotalValue">—</span>
                    </div>
                </div>

                <div class="form-group">
                    <div class="cat-media-title">M&eacute;dias</div>
                    <div class="cat-dropzone" id="catDropzone">
                        Cliquer ou glisser des images / PDFs ici
                    </div>
                    <input type="file" id="catMediaInput" accept="image/*,.pdf,application/pdf" multiple style="display:none;">
                    <div class="cat-media-list" id="catMediaList"></div>
                </div>
                <div class="form-group" style="margin-bottom:0;">
                    <div class="edit-toggle-row">
                        <label class="edit-toggle">
                            <input type="checkbox" id="editInCalculator" checked>
                            <span class="slider"></span>
                        </label>
                        <span class="edit-toggle-label">Visible dans le calculateur</span>
                    </div>
                    <div class="edit-toggle-row" style="margin-top: 12px;">
                        <label class="edit-toggle">
                            <input type="checkbox" id="editIsDefault">
                            <span class="slider"></span>
                        </label>
                        <span class="edit-toggle-label">Article par d&eacute;faut &#9733;</span>
                    </div>
                    <div class="edit-toggle-row" style="margin-top: 12px;">
                        <label class="edit-toggle">
                            <input type="checkbox" id="editHasSalesSheet" onchange="toggleSalesSheetBtn()">
                            <span class="slider"></span>
                        </label>
                        <span class="edit-toggle-label">Ce produit a une fiche de vente</span>
                        <button class="btn-sales-sheet" id="btnSalesSheet" style="display:none;" onclick="openSalesSheet()">Ouvrir la fiche</button>
                    </div>
                </div>
                <div class="edit-status" id="editStatus"></div>
            </div>
            <div class="modal-footer" style="justify-content: space-between;">
                <button class="btn-delete-item" onclick="deleteItem()">Supprimer</button>
                <div style="display: flex; gap: 8px;">
                    <button class="btn-cancel" onclick="closeEditModal()">Annuler</button>
                    <button class="btn-generate" id="btnEditSave" onclick="saveEditModal()">Sauvegarder</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Stele confirm dialog -->
    <div class="stele-confirm-overlay" id="steleConfirmOverlay">
        <div class="stele-confirm-box">
            <h3 id="steleConfirmTitle">Confirmation</h3>
            <div class="scb-body" id="steleConfirmBody"></div>
            <div class="scb-footer">
                <button class="scb-btn-cancel" id="steleConfirmCancel">Annuler</button>
                <button class="scb-btn-ok" id="steleConfirmOk">Confirmer</button>
            </div>
        </div>
    </div>

    <!-- Supplier Modal -->
    <div class="modal-overlay" id="supplierModal" style="z-index:1100;" onclick="if(event.target===this)closeSupplierModal()">
        <div class="modal" style="max-width:480px;">
            <div class="modal-header"><h2 id="supplierModalTitle">Nouveau fournisseur</h2></div>
            <div class="modal-body" style="max-height:60vh; overflow-y:auto;">
                <div class="form-group">
                    <label class="form-label">Nom *</label>
                    <input class="form-input" id="supName" placeholder="Nom de l'entreprise">
                </div>
                <div class="form-group">
                    <label class="form-label">Adresse</label>
                    <input class="form-input" id="supAddress" placeholder="Adresse">
                </div>
                <div class="form-group" style="display:flex;gap:10px;">
                    <div style="flex:1;">
                        <label class="form-label">T&eacute;l&eacute;phone</label>
                        <input class="form-input" id="supPhone" placeholder="T&eacute;l&eacute;phone">
                    </div>
                    <div style="flex:1;">
                        <label class="form-label">Email</label>
                        <input class="form-input" id="supEmail" placeholder="Email" type="email">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Site web</label>
                    <input class="form-input" id="supWebsite" placeholder="https://...">
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-input" id="supNotes" rows="2" style="resize:vertical;" placeholder="Notes..."></textarea>
                </div>
                <div class="edit-status" id="supplierModalStatus"></div>
            </div>
            <div class="modal-footer" style="justify-content:flex-end;">
                <button class="btn-cancel" onclick="closeSupplierModal()">Annuler</button>
                <button class="btn-generate" onclick="saveNewSupplier()">Cr&eacute;er le fournisseur</button>
            </div>
        </div>
    </div>

    <!-- Crop Modal (même pattern que calculateur.html) -->
    <div class="crop-overlay" id="cropModal">
        <div class="crop-box">
            <div class="crop-header">
                <span>Cadrer l'image</span>
                <span id="cropDimensions" style="font-weight:400; font-size:12px; color:#888;"></span>
            </div>
            <div class="crop-error" id="cropError"></div>
            <div class="crop-container" id="cropContainer">
                <img id="cropImage" src="">
            </div>
            <div class="crop-controls">
                <div class="crop-ratios">
                    <button class="crop-ratio-btn active" id="cropRatio169" onclick="setCropRatio('16:9')">16:9</button>
                    <button class="crop-ratio-btn" id="cropRatio916" onclick="setCropRatio('9:16')">9:16</button>
                    <button class="crop-ratio-btn" id="cropRatio11" onclick="setCropRatio('1:1')">1:1</button>
                </div>
                <div class="crop-actions">
                    <button class="crop-btn crop-btn-cancel" onclick="cancelCrop()">Annuler</button>
                    <button class="crop-btn crop-btn-confirm" id="cropConfirmBtn" onclick="confirmCrop()">Valider</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ═══════════════════════════════════════════════════════════════════════
        // GÉNÉRATION AUTOMATIQUE DES TABLEAUX À PARTIR DE CATALOGUE_DATA
        // ═══════════════════════════════════════════════════════════════════════

        // Permissions (chargées depuis Supabase)
        let canEditCatalogue = false;
        let canEditMinutes = false;
        let canEditMaterials = false;
        let isAdmin = false;

        // Données de base (chargées depuis app_config)
        let tauxHoraires = [];
        let expenseCategories = [];

        // ── Stele Confirm Dialog ──
        var _steleConfirmResolve = null;
        function steleConfirm(bodyHtml, title, okLabel) {
            return new Promise(function(resolve) {
                _steleConfirmResolve = resolve;
                document.getElementById('steleConfirmTitle').textContent = title || 'Confirmation';
                document.getElementById('steleConfirmBody').innerHTML = bodyHtml;
                document.getElementById('steleConfirmOk').textContent = okLabel || 'Confirmer';
                document.getElementById('steleConfirmOverlay').classList.add('active');
            });
        }
        document.addEventListener('click', function(e) {
            if (e.target.id === 'steleConfirmCancel' || e.target.id === 'steleConfirmOverlay') {
                document.getElementById('steleConfirmOverlay').classList.remove('active');
                if (_steleConfirmResolve) { var fn = _steleConfirmResolve; _steleConfirmResolve = null; fn(false); }
            }
            if (e.target.id === 'steleConfirmOk') {
                document.getElementById('steleConfirmOverlay').classList.remove('active');
                if (_steleConfirmResolve) { var fn = _steleConfirmResolve; _steleConfirmResolve = null; fn(true); }
            }
        });

        // ── Crop Modal (même pattern que calculateur.html) ──
        var cropperLoaded = false;
        var currentCropper = null;
        var cropState = {}; // { originalBlob, ratio, _resolve }

        function loadCropperLib() {
            if (cropperLoaded) return Promise.resolve();
            return new Promise(function(resolve, reject) {
                var link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = 'https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.css';
                document.head.appendChild(link);
                var script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.js';
                script.onload = function() { cropperLoaded = true; resolve(); };
                script.onerror = function() { reject(new Error('Cropper.js failed to load')); };
                document.head.appendChild(script);
            });
        }

        function openCropModal(imageBlob) {
            cropState.originalBlob = imageBlob;
            cropState.ratio = '16:9';
            var url = URL.createObjectURL(imageBlob);
            var imgEl = document.getElementById('cropImage');
            var modal = document.getElementById('cropModal');
            var errEl = document.getElementById('cropError');
            errEl.style.display = 'none';

            var testImg = new Image();
            testImg.onload = async function() {
                document.getElementById('cropDimensions').textContent = testImg.width + ' \u00d7 ' + testImg.height + ' px';

                if (testImg.width < 800 || testImg.height < 600) {
                    errEl.textContent = 'Image trop petite (minimum 800\u00d7600). Celle-ci fait ' + testImg.width + '\u00d7' + testImg.height + '.';
                    errEl.style.display = 'block';
                    imgEl.src = url;
                    modal.classList.add('active');
                    document.getElementById('cropConfirmBtn').disabled = true;
                    return;
                }

                document.getElementById('cropConfirmBtn').disabled = false;
                imgEl.src = url;
                modal.classList.add('active');

                await loadCropperLib();
                if (currentCropper) { currentCropper.destroy(); currentCropper = null; }
                currentCropper = new Cropper(imgEl, {
                    aspectRatio: 16 / 9,
                    viewMode: 1,
                    autoCropArea: 0.9,
                    responsive: true,
                    background: false
                });

                document.getElementById('cropRatio169').classList.add('active');
                document.getElementById('cropRatio916').classList.remove('active');
                document.getElementById('cropRatio11').classList.remove('active');
            };
            testImg.src = url;
        }

        function setCropRatio(ratio) {
            cropState.ratio = ratio;
            document.getElementById('cropRatio169').classList.toggle('active', ratio === '16:9');
            document.getElementById('cropRatio916').classList.toggle('active', ratio === '9:16');
            document.getElementById('cropRatio11').classList.toggle('active', ratio === '1:1');
            var numRatio = ratio === '1:1' ? 1 : ratio === '9:16' ? 9 / 16 : 16 / 9;
            if (currentCropper) {
                currentCropper.setAspectRatio(numRatio);
            }
        }

        async function confirmCrop() {
            if (!currentCropper) return;
            var confirmBtn = document.getElementById('cropConfirmBtn');
            confirmBtn.disabled = true;
            confirmBtn.textContent = 'Traitement...';

            try {
                var croppedCanvas = currentCropper.getCroppedCanvas({
                    maxWidth: 2048,
                    maxHeight: 2048,
                    imageSmoothingQuality: 'high'
                });
                var cropData = currentCropper.getData(true);
                var croppedBlob = await new Promise(function(resolve) {
                    croppedCanvas.toBlob(function(b) { resolve(b); }, 'image/jpeg', 0.88);
                });

                // Save values before closeCropModal resets cropState
                var originalBlob = cropState.originalBlob;
                var ratio = cropState.ratio || '16:9';
                var resolve = cropState._resolve;
                closeCropModal();
                if (resolve) resolve({ croppedBlob: croppedBlob, originalBlob: originalBlob, ratio: ratio, cropData: cropData });
            } catch (err) {
                console.error('Crop error:', err);
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Valider';
            }
        }

        function cancelCrop() {
            var resolve = cropState._resolve;
            closeCropModal();
            if (resolve) resolve(null);
        }

        function closeCropModal() {
            var modal = document.getElementById('cropModal');
            modal.classList.remove('active');
            if (currentCropper) { currentCropper.destroy(); currentCropper = null; }
            var imgEl = document.getElementById('cropImage');
            if (imgEl.src && imgEl.src.startsWith('blob:')) URL.revokeObjectURL(imgEl.src);
            imgEl.src = '';
            cropState = {};
        }

        // Utilitaires d'échappement HTML
        function escapeHtml(str) {
            var div = document.createElement('div');
            div.textContent = str || '';
            return div.innerHTML;
        }
        function escapeAttr(str) {
            return (str || '').replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;');
        }

        // Catégories à exclure des tableaux (affichées uniquement dans le calculateur)
        // Comparaison insensible à la casse
        const excludedCategories = ['temps', 'ajouts', 'ajout'];

        function isExcludedCategory(category) {
            return excludedCategories.includes(category.toLowerCase().trim());
        }

        // Convertir un nom de catégorie en ID valide pour HTML
        function categoryToId(category) {
            return category
                .toLowerCase()
                .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // Enlever les accents
                .replace(/[^a-z0-9]+/g, '-') // Remplacer les caractères spéciaux par des tirets
                .replace(/^-|-$/g, ''); // Enlever les tirets au début et à la fin
        }

        // Formater le prix
        function formatPrice(amount) {
            if (amount === null || amount === undefined) {
                return 'Sur demande';
            }
            if (typeof amount === 'number' && amount < 1 && amount > 0) {
                return (amount * 100).toFixed(0) + '%';
            }
            return amount.toLocaleString('fr-CA', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }) + ' $';
        }

        // Formater le type pour affichage
        function formatType(type) {
            if (type === '%') return '%';
            return type;
        }

        // ═══ Search + Sort state ═══
        var catalogueSearchQuery = '';
        var catalogueSortCol = null; // 'code', 'type', 'description', 'price'
        var catalogueSortDir = 'asc'; // 'asc' or 'desc'

        function filterCatalogueSearch() {
            var input = document.getElementById('catalogueSearchInput');
            catalogueSearchQuery = (input ? input.value : '').toLowerCase().trim();
            generatePriceTables();
        }

        function sortCatalogueBy(col) {
            if (catalogueSortCol === col) {
                catalogueSortDir = catalogueSortDir === 'asc' ? 'desc' : 'asc';
            } else {
                catalogueSortCol = col;
                catalogueSortDir = 'asc';
            }
            generatePriceTables();
        }

        // Générer les tableaux de prix dynamiquement
        function generatePriceTables() {
            // Grouper par catégorie (en conservant l'ordre d'apparition)
            const grouped = {};
            const categoryOrder = [];

            CATALOGUE_DATA.forEach(item => {
                // Exclure les catégories Temps et Ajouts des tableaux
                if (isExcludedCategory(item.category)) return;
                if (filterDefaultsOnly && !item.is_default) return;
                if (filterPendingOnly && item.status !== 'pending') return;
                if (!canEditCatalogue && item.status === 'pending') return;

                // Search filter
                if (catalogueSearchQuery) {
                    var q = catalogueSearchQuery;
                    var match = (item.id || '').toLowerCase().indexOf(q) !== -1
                        || (item.description || '').toLowerCase().indexOf(q) !== -1
                        || (item.category || '').toLowerCase().indexOf(q) !== -1
                        || (item.instruction || '').toLowerCase().indexOf(q) !== -1
                        || (item.type || '').toLowerCase().indexOf(q) !== -1;
                    if (!match) return;
                }

                if (!grouped[item.category]) {
                    grouped[item.category] = [];
                    categoryOrder.push(item.category);
                }
                grouped[item.category].push(item);
            });

            // Sort items within each category
            if (catalogueSortCol) {
                Object.keys(grouped).forEach(function(cat) {
                    grouped[cat].sort(function(a, b) {
                        var va, vb;
                        if (catalogueSortCol === 'code') { va = a.id || ''; vb = b.id || ''; }
                        else if (catalogueSortCol === 'description') { va = a.description || ''; vb = b.description || ''; }
                        else if (catalogueSortCol === 'type') { va = a.type || ''; vb = b.type || ''; }
                        else if (catalogueSortCol === 'price') { va = a.price || 0; vb = b.price || 0; }
                        else { return 0; }
                        var cmp = typeof va === 'number' ? va - vb : va.localeCompare(vb, 'fr');
                        return catalogueSortDir === 'desc' ? -cmp : cmp;
                    });
                });
            }

            // Générer les liens de navigation
            const navLinks = document.getElementById('navLinks');

            // Supprimer les anciens liens dynamiques
            const existingLinks = navLinks.querySelectorAll('a.dynamic-nav-link');
            existingLinks.forEach(link => link.remove());

            // Ajouter les nouveaux liens
            categoryOrder.forEach(category => {
                const link = document.createElement('a');
                link.href = '#' + categoryToId(category);
                link.textContent = category;
                link.className = 'dynamic-nav-link';
                navLinks.appendChild(link);
            });

            // Générer les sections HTML
            const sectionsContainer = document.getElementById('dynamicSections');
            sectionsContainer.innerHTML = '';

            categoryOrder.forEach(category => {
                const sectionId = categoryToId(category);
                const tableId = 'table-' + sectionId;

                const section = document.createElement('section');
                section.className = 'content-page';
                section.id = sectionId;

                section.innerHTML = `
                    <header class="page-header">
                        <span class="header-logo">stele</span>
                    </header>
                    <h2 class="section-title">${escapeHtml(category)}</h2>
                    <table class="price-table" id="${tableId}"></table>
                `;

                sectionsContainer.appendChild(section);

                // Remplir le tableau
                const table = document.getElementById(tableId);
                let html = `
                    <thead>
                        <tr>
                            <th class="col-code sortable${catalogueSortCol==='code'? ' sort-'+catalogueSortDir:''}" onclick="sortCatalogueBy('code')">Code</th>
                            <th class="col-fiche"></th>
                            <th class="col-type sortable${catalogueSortCol==='type'? ' sort-'+catalogueSortDir:''}" onclick="sortCatalogueBy('type')">Type</th>
                            <th class="col-description sortable${catalogueSortCol==='description'? ' sort-'+catalogueSortDir:''}" onclick="sortCatalogueBy('description')">Description</th>
                            <th class="col-price sortable${catalogueSortCol==='price'? ' sort-'+catalogueSortDir:''}" onclick="sortCatalogueBy('price')">Prix</th>
                            ${canEditCatalogue ? `<th class="col-edit"><button class="btn-add-item" onclick="createNewItem('${escapeAttr(category).replace(/'/g, "&#39;")}')" title="Ajouter un article">+</button></th>` : ''}
                        </tr>
                    </thead>
                    <tbody>
                `;

                grouped[category].forEach(item => {
                    const imgHtml = item.image_url
                        ? `<img class="tooltip-image" src="${escapeAttr(item.image_url)}" alt="">`
                        : '';
                    const tooltipClass = item.image_url ? 'tooltip has-image' : 'tooltip';

                    html += `
                        <tr data-item-id="${escapeAttr(item.id)}">
                            <td>
                                <span class="tooltip-container tooltip-table">
                                    ${escapeHtml(item.id)}
                                    <div class="${tooltipClass}">
                                        ${imgHtml}
                                        <div class="tooltip-title">${escapeHtml(item.description)}</div>
                                        <div class="tooltip-text">${escapeHtml(item.instruction || '')}</div>
                                    </div>
                                </span>
                            </td>
                            <td>${item.has_sales_sheet ? `<a class="fiche-link" href="fiche.html?code=${encodeURIComponent(item.id)}" target="_blank">fiche client</a>` : ''}</td>
                            <td>${formatType(item.type)}</td>
                            <td>
                                ${canEditCatalogue ? `<span class="default-star${item.is_default ? ' active' : ''}" onclick="event.stopPropagation();toggleDefault('${escapeAttr(item.id)}',this)" title="Article par d\u00e9faut">\u2605</span> ` : (item.is_default ? '<span class="default-star active" style="cursor:default;" title="Article par d\u00e9faut">\u2605</span> ' : '')}
                                <span class="tooltip-container tooltip-table tooltip-left">
                                    ${escapeHtml(item.description)}
                                    <div class="${tooltipClass}">
                                        ${imgHtml}
                                        <div class="tooltip-title">${escapeHtml(item.id)}</div>
                                        <div class="tooltip-text">${escapeHtml(item.instruction || '')}</div>
                                    </div>
                                </span>
                                ${(item.supplier_name || item.supplier_sku) ? '<div class="item-supplier-sub">' + [item.supplier_name, item.supplier_sku].filter(Boolean).map(escapeHtml).join(' \u2022 ') + '</div>' : ''}
                                ${item.status === 'pending' ? '<span class="item-pending-badge" onclick="approveItem(\'' + escapeAttr(item.id) + '\', event)" title="Cliquer pour approuver">en attente</span>' : ''}
                            </td>
                            <td>${formatPrice(item.price)}</td>
                            ${canEditCatalogue ? `<td class="col-edit"><button class="btn-edit-row" onclick="openEditModal('${escapeAttr(item.id)}')" title="Modifier">&#9998;</button></td>` : ''}
                        </tr>
                    `;
                });

                html += '</tbody>';
                table.innerHTML = html;
            });
        }




        // ═══ Toggle default star ═══

        async function toggleDefault(itemId, starEl) {
            var item = CATALOGUE_DATA.find(function(i) { return i.id === itemId; });
            if (!item) return;
            var newVal = !item.is_default;
            starEl.classList.toggle('active', newVal);
            try {
                var resp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/catalogue_items?id=eq.' + encodeURIComponent(itemId), {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ is_default: newVal })
                });
                if (!resp.ok) throw new Error('Erreur ' + resp.status);
                item.is_default = newVal;
            } catch (e) {
                starEl.classList.toggle('active', !newVal);
            }
        }

        // ═══ Default filter ═══

        var filterDefaultsOnly = false;

        function toggleDefaultFilter() {
            filterDefaultsOnly = !filterDefaultsOnly;
            var btn = document.getElementById('filterDefaultBtn');
            if (btn) btn.classList.toggle('active', filterDefaultsOnly);
            generatePriceTables();
        }

        // ═══ Global add article dropdown ═══

        function toggleAddDropdown() {
            var dd = document.getElementById('navAddDd');
            if (dd.classList.contains('open')) { dd.classList.remove('open'); return; }
            // Build list of existing categories + configCategories
            var cats = new Set(configCategories);
            CATALOGUE_DATA.forEach(function(i) { if (i.category) cats.add(i.category); });
            var sorted = Array.from(cats).sort(function(a, b) { return a.localeCompare(b, 'fr'); });
            var html = '<div style="padding:8px 14px;font-size:11px;font-weight:600;color:#888;text-transform:uppercase;">Cat\u00e9gorie existante</div>';
            sorted.forEach(function(cat) {
                html += '<div class="add-dd-item" onclick="addItemInCategory(\'' + cat.replace(/'/g, "\\'") + '\')">' + escapeHtml(cat) + '</div>';
            });
            html += '<div class="add-dd-sep"></div>';
            html += '<div style="padding:8px 14px;font-size:11px;font-weight:600;color:#888;text-transform:uppercase;">Nouvelle cat\u00e9gorie</div>';
            html += '<div class="add-dd-input"><input id="newCatInput" placeholder="Nom..." onkeydown="if(event.key===\'Enter\')addItemNewCategory()"><button onclick="addItemNewCategory()">Cr\u00e9er</button></div>';
            dd.innerHTML = html;
            dd.classList.add('open');
        }

        function addItemInCategory(category) {
            document.getElementById('navAddDd').classList.remove('open');
            createNewItem(category);
        }

        function addItemNewCategory() {
            var input = document.getElementById('newCatInput');
            var name = input.value.trim();
            if (!name) return;
            document.getElementById('navAddDd').classList.remove('open');
            // Add to configCategories if not already there
            if (!configCategories.includes(name)) configCategories.push(name);
            createNewItem(name);
        }

        // Close dropdown on click outside
        document.addEventListener('click', function(e) {
            var wrap = document.getElementById('navAddWrap');
            if (wrap && !wrap.contains(e.target)) {
                document.getElementById('navAddDd').classList.remove('open');
            }
        });

        // ═══════════════════════════════════════════════════════════════════════
        // CHARGEMENT DES DONNÉES DEPUIS GOOGLE SHEETS (via API Visualization)
        // ═══════════════════════════════════════════════════════════════════════

        // Mettre à jour l'indicateur de statut
        function updateStatus(status, message) {
            const statusEl = document.getElementById('dataStatus');
            const textEl = document.getElementById('statusText');

            statusEl.className = 'data-status ' + status;
            textEl.textContent = message;
        }

        // Sauvegarder les données dans localStorage
        function saveToLocalStorage(data) {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                localStorage.setItem(STORAGE_DATE_KEY, new Date().toISOString());
            } catch (e) {
                console.warn('Impossible de sauvegarder dans localStorage:', e);
            }
        }

        // Charger les données depuis localStorage
        function loadFromLocalStorage() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                const date = localStorage.getItem(STORAGE_DATE_KEY);

                if (data) {
                    return {
                        data: JSON.parse(data),
                        date: date ? new Date(date) : null
                    };
                }
            } catch (e) {
                console.warn('Impossible de lire depuis localStorage:', e);
            }
            return null;
        }

        // Formater une date pour l'affichage
        function formatDate(date) {
            if (!date) return '';
            const options = { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' };
            return date.toLocaleDateString('fr-CA', options);
        }

        // Charger les données du catalogue depuis Supabase
        function loadCatalogueData() {
            return new Promise((resolve) => {
                updateStatus('', 'Chargement...');

                var statusFilter = canEditCatalogue
                    ? '&or=(status.eq.approved,status.is.null,status.eq.pending)'
                    : '&or=(status.eq.approved,status.is.null)';
                authenticatedFetch(SUPABASE_URL + '/rest/v1/catalogue_items?select=id,category,description,type,price,instruction,image_url,in_calculator,has_sales_sheet,labor_minutes,material_costs,calculation_rule_human,calculation_rule_ai,supplier_name,supplier_sku,is_default,client_text,client_text_en,presentation_rule_human,presentation_rule,status,proposed_by' + statusFilter + '&order=sort_order', {})
                .then(r => {
                    if (!r.ok) throw new Error('HTTP ' + r.status);
                    return r.json();
                })
                .then(data => {
                    if (data.length > 0) {
                        CATALOGUE_DATA = data;
                        saveToLocalStorage(data);
                        updateStatus('online', 'Données à jour');
                        resolve(true);
                    } else {
                        throw new Error('Données vides');
                    }
                })
                .catch(error => {
                    console.warn('Erreur chargement catalogue:', error);
                    loadFallbackData();
                    resolve(false);
                });
            });
        }

        // Charger les données de secours (cache ou défaut)
        function loadFallbackData() {
            const cached = loadFromLocalStorage();

            if (cached && cached.data && cached.data.length > 0) {
                CATALOGUE_DATA = cached.data;
                const dateStr = cached.date ? formatDate(cached.date) : '';
                updateStatus('offline', 'Hors-ligne' + (dateStr ? ' — ' + dateStr : ''));
            } else {
                // Utiliser les données par défaut
                updateStatus('error', 'Données par défaut');
            }
        }


        // ═══════════════════════════════════════════════════════════════════════
        // PERMISSIONS UTILISATEUR
        // ═══════════════════════════════════════════════════════════════════════

        const DEFAULT_PERMISSIONS = {
            'Admin':             { catalogue: true, catalogue_edit: true,  documents: true,  assistant: true,  admin: true,  edit_minutes: true,  edit_materials: true  },
            'Vente':             { catalogue: true, catalogue_edit: true,  documents: true,  assistant: true,  admin: false, edit_minutes: false, edit_materials: false },
            'Charg\u00e9 de projet': { catalogue: true, catalogue_edit: false, documents: true,  assistant: false, admin: false, edit_minutes: false, edit_materials: false },
            'Achat':             { catalogue: true, catalogue_edit: false, documents: true,  assistant: false, admin: false, edit_minutes: false, edit_materials: true  },
            'Atelier':           { catalogue: false, catalogue_edit: false, documents: true,  assistant: false, admin: false, edit_minutes: false, edit_materials: false },
            'Client':            { catalogue: false, catalogue_edit: false, documents: false, assistant: false, admin: false, edit_minutes: false, edit_materials: false }
        };

        const DEFAULT_USER_ROLES = { 'hubert@stele.ca': 'Admin' };
        let configCategories = [];

        function loadUserPermissions() {
            return new Promise((resolve) => {
                const email = (localStorage.getItem('sb_user_email') || '').toLowerCase();

                authenticatedFetch(SUPABASE_URL + '/rest/v1/app_config?select=key,value', {})
                .then(r => r.ok ? r.json() : [])
                .then(rows => {
                    let perms = DEFAULT_PERMISSIONS;
                    let roles = DEFAULT_USER_ROLES;
                    if (Array.isArray(rows)) {
                        rows.forEach(row => {
                            if (row.key === 'permissions') perms = row.value;
                            if (row.key === 'user_roles') roles = row.value;
                            if (row.key === 'taux_horaires') tauxHoraires = row.value;
                            if (row.key === 'expense_categories') expenseCategories = row.value;
                            if (row.key === 'catalogue_categories' && Array.isArray(row.value)) configCategories = row.value;
                        });
                    }
                    const role = roles[email] || 'Client';
                    const defaults = DEFAULT_PERMISSIONS[role] || {};
                    const saved = perms[role] || {};
                    const allowed = Object.assign({}, defaults, saved);
                    canEditCatalogue = !!allowed.catalogue_edit;
                    canEditMinutes = !!allowed.edit_minutes;
                    canEditMaterials = !!allowed.edit_materials;
                    isAdmin = !!allowed.admin;
                    resolve();
                })
                .catch(() => {
                    const email2 = (localStorage.getItem('sb_user_email') || '').toLowerCase();
                    const role = DEFAULT_USER_ROLES[email2] || 'Client';
                    const allowed = DEFAULT_PERMISSIONS[role] || {};
                    canEditCatalogue = !!allowed.catalogue_edit;
                    canEditMinutes = !!allowed.edit_minutes;
                    canEditMaterials = !!allowed.edit_materials;
                    isAdmin = !!allowed.admin;
                    resolve();
                });
            });
        }

        // ═══════════════════════════════════════════════════════════════════════
        // ÉDITION DU CATALOGUE
        // ═══════════════════════════════════════════════════════════════════════

        // ═══ Composantes fournisseur ═══
        let editComponents = [];          // { id, supplier_name, supplier_sku, description, expense_category, qty_per_unit, unit_cost, notes, sort_order, isNew }
        let editComponentsToDelete = [];  // UUIDs à supprimer au save
        let supplierCompanies = [];       // { id, name } from companies WHERE company_type='Fournisseurs'

        // ═══ Médias tagués ═══
        let editMedia = [];           // { id, file_url, file_type, tags, isNew, file, previewUrl }
        let editMediaToDelete = [];   // IDs à supprimer au save
        let mediaTagsList = ['fiche_client', 'catalogue', 'technique', 'dessin']; // défauts

        async function loadMediaTags() {
            try {
                const resp = await fetch(SUPABASE_URL + '/rest/v1/app_config?key=eq.media_tags&select=value', {
                    headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
                });
                if (resp.ok) {
                    const rows = await resp.json();
                    if (rows.length > 0 && Array.isArray(rows[0].value)) {
                        mediaTagsList = rows[0].value;
                    }
                }
            } catch (e) { /* keep defaults */ }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // AJOUT D'UN NOUVEL ARTICLE
        // ═══════════════════════════════════════════════════════════════════════

        let isNewItem = false;
        let newItemData = null;

        function generateNextCode(category) {
            const items = CATALOGUE_DATA.filter(i => i.category === category);
            if (items.length === 0) {
                // Catégorie nouvelle : 3 premières lettres
                const prefix = category.substring(0, 3).toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                return prefix + '-001';
            }
            // Extraire le préfixe et le numéro max
            const prefix = items[0].id.split('-')[0];
            let maxNum = 0;
            items.forEach(item => {
                const parts = item.id.split('-');
                if (parts.length === 2) {
                    const num = parseInt(parts[1], 10);
                    if (num > maxNum) maxNum = num;
                }
            });
            return prefix + '-' + String(maxNum + 1).padStart(3, '0');
        }

        function createNewItem(category) {
            const newCode = generateNextCode(category);
            const maxSort = CATALOGUE_DATA.reduce((max, i) => Math.max(max, i.sort_order || 0), 0);

            // Préparer l'item en mémoire seulement (pas de POST)
            newItemData = {
                id: newCode,
                category: category,
                description: '',
                type: 'unité',
                price: null,
                instruction: '',
                image_url: null,
                in_calculator: true,
                has_sales_sheet: false,
                sort_order: maxSort + 1
            };

            isNewItem = true;
            openEditModal(newCode);
        }

        // ── Navigation entre articles ──
        let navItemList = [];  // liste ordonnée des IDs navigables

        function buildNavList() {
            navItemList = CATALOGUE_DATA.slice()
                .sort(function(a, b) { return (a.category || '').localeCompare(b.category || '') || (a.sort_order || 0) - (b.sort_order || 0); })
                .map(function(item) { return item.id; });
        }

        function updateNavButtons(itemId) {
            var idx = navItemList.indexOf(itemId);
            var btnPrev = document.getElementById('btnPrevItem');
            var btnNext = document.getElementById('btnNextItem');
            if (btnPrev) btnPrev.disabled = (idx <= 0 || isNewItem);
            if (btnNext) btnNext.disabled = (idx < 0 || idx >= navItemList.length - 1 || isNewItem);
        }

        function navigateItem(direction) {
            var currentId = document.getElementById('editItemId').value;
            var idx = navItemList.indexOf(currentId);
            var newIdx = idx + direction;
            if (newIdx < 0 || newIdx >= navItemList.length) return;
            isNewItem = false;
            newItemData = null;
            openEditModal(navItemList[newIdx]);
        }

        async function approveItem(itemId, event) {
            event.stopPropagation();
            var badge = event.target;
            badge.textContent = '...';
            try {
                var resp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/catalogue_items?id=eq.' + encodeURIComponent(itemId), {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                    body: JSON.stringify({ status: 'approved' })
                });
                if (!resp.ok) throw new Error(await resp.text());
                // Update local data
                for (var i = 0; i < CATALOGUE_DATA.length; i++) {
                    if (CATALOGUE_DATA[i].id === itemId) { CATALOGUE_DATA[i].status = 'approved'; break; }
                }
                badge.remove();
                updatePendingBadge();
            } catch (e) {
                badge.textContent = 'en attente';
                alert('Erreur: ' + e.message);
            }
        }

        async function openEditModal(itemId) {
            // Pour un nouvel item, utiliser newItemData au lieu de chercher dans CATALOGUE_DATA
            const item = (isNewItem && newItemData) ? newItemData : CATALOGUE_DATA.find(i => i.id === itemId);
            if (!item) return;

            // Populer catégories dynamiquement
            const catSelect = document.getElementById('editCategory');
            const cats = new Set(configCategories);
            CATALOGUE_DATA.forEach(i => { if (i.category) cats.add(i.category); });
            if (item.category && !cats.has(item.category)) cats.add(item.category);
            catSelect.innerHTML = Array.from(cats).map(c => '<option value="' + c.replace(/"/g, '&quot;') + '">' + c + '</option>').join('');

            // Populer types dynamiquement
            const typeSelect = document.getElementById('editType');
            const types = new Set(['pi\u00b2', 'unitaire', 'lin\u00e9aire', '%']);
            CATALOGUE_DATA.forEach(i => { if (i.type) types.add(i.type); });
            if (item.type && !types.has(item.type)) types.add(item.type);
            typeSelect.innerHTML = Array.from(types).map(t => '<option value="' + t.replace(/"/g, '&quot;') + '">' + t + '</option>').join('');

            document.getElementById('editItemId').value = item.id;
            document.getElementById('editCode').value = item.id;
            document.getElementById('editCategory').value = item.category;
            catSelect.disabled = !isNewItem;
            document.getElementById('editDescription').value = item.description;
            document.getElementById('editType').value = item.type;
            document.getElementById('editPrice').value = item.price != null ? item.price : '';
            document.getElementById('editPriceDisplay').textContent = item.price != null ? formatPrice(item.price) : 'Calculé automatiquement';
            document.getElementById('editInstruction').value = item.instruction || '';

            // Présentation client (admin only)
            document.getElementById('editClientText').value = item.client_text || '';
            document.getElementById('clientTextGroup').style.display = isAdmin ? '' : 'none';

            // Règles de calcul (admin only)
            document.getElementById('editCalcRuleHuman').value = item.calculation_rule_human || '';
            document.getElementById('editCalcRuleAi').value = item.calculation_rule_ai ? JSON.stringify(item.calculation_rule_ai, null, 2) : '';
            document.getElementById('calcRuleGroup').style.display = isAdmin ? '' : 'none';
            document.getElementById('calcRuleError').style.display = 'none';
            updateGenerateRuleBtn();

            // Règles de présentation (admin only)
            document.getElementById('editPresRuleHuman').value = item.presentation_rule_human || '';
            document.getElementById('editPresRuleAi').value = item.presentation_rule ? JSON.stringify(item.presentation_rule, null, 2) : '';
            document.getElementById('presRuleGroup').style.display = isAdmin ? '' : 'none';

            document.getElementById('editInCalculator').checked = item.in_calculator !== false;
            document.getElementById('editIsDefault').checked = item.is_default === true;
            document.getElementById('editHasSalesSheet').checked = item.has_sales_sheet === true;
            toggleSalesSheetBtn();

            // Rafraîchir taux horaires et catégories dépenses depuis app_config
            try {
                var cfgResp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/app_config?key=in.(taux_horaires,expense_categories)&select=key,value', {});
                if (cfgResp.ok) {
                    var cfgRows = await cfgResp.json();
                    cfgRows.forEach(function(r) {
                        if (r.key === 'taux_horaires') tauxHoraires = r.value;
                        if (r.key === 'expense_categories') expenseCategories = r.value;
                    });
                }
            } catch (e) { /* use cached values */ }

            // Prix composé — tableaux minutes & matériaux
            renderComposedTables(item);

            // Composantes fournisseur
            var realItemId = (isNewItem && newItemData) ? null : item.id;
            loadComponents(realItemId);
            loadSupplierCompanies();

            // Médias
            editMedia = [];
            editMediaToDelete = [];
            if (!(isNewItem && newItemData)) {
                try {
                    const mResp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/item_media?catalogue_item_id=eq.' + encodeURIComponent(item.id) + '&order=sort_order&select=id,file_url,file_type,tags', {});
                    if (mResp.ok) {
                        const existing = await mResp.json();
                        editMedia = existing.map(function(m) {
                            return { id: m.id, file_url: m.file_url, file_type: m.file_type || 'image', tags: m.tags || [], isNew: false };
                        });
                    }
                } catch (e) { /* ignore */ }
            }
            renderEditMedia();

            // Reset status
            const status = document.getElementById('editStatus');
            status.className = 'edit-status';
            status.style.display = 'none';

            // Navigation
            if (navItemList.length === 0) buildNavList();
            updateNavButtons(item.id);

            document.getElementById('editModal').classList.add('active');
            document.querySelector('.modal-body').scrollTop = 0;
        }

        function toggleSalesSheetBtn() {
            const checked = document.getElementById('editHasSalesSheet').checked;
            document.getElementById('btnSalesSheet').style.display = checked ? '' : 'none';
        }

        function openSalesSheet() {
            const itemId = document.getElementById('editItemId').value;
            window.open('fiche.html?code=' + encodeURIComponent(itemId) + '&edit=true', '_blank');
        }

        function updateGenerateRuleBtn() {
            // No button yet — placeholder for future "Generate AI rule" button
            // This function is called by the oninput handler on editCalcRuleHuman
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            editMedia = [];
            editMediaToDelete = [];
            isNewItem = false;
            newItemData = null;
        }

        async function deleteItem() {
            const itemId = document.getElementById('editItemId').value;

            // Si c'est un nouvel item pas encore sauvegardé, juste fermer
            if (isNewItem && newItemData) {
                closeEditModal();
                return;
            }

            var ok = await steleConfirm('Supprimer l\u2019article <strong>' + escapeHtml(itemId) + '</strong> ?<br>Cette action est irr\u00e9versible.', 'Supprimer l\u2019article', 'Supprimer');
            if (!ok) return;

            try {
                const resp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/catalogue_items?id=eq.' + encodeURIComponent(itemId), {
                    method: 'DELETE',
                    headers: { 'Prefer': 'return=minimal' }
                });

                if (!resp.ok) throw new Error('Erreur suppression: ' + resp.status);

                // Retirer de CATALOGUE_DATA
                CATALOGUE_DATA = CATALOGUE_DATA.filter(i => i.id !== itemId);
                generatePriceTables();
                closeEditModal();
            } catch (err) {
                console.error('Erreur suppression:', err);
                const status = document.getElementById('editStatus');
                status.textContent = 'Erreur: ' + err.message;
                status.style.display = '';
                status.className = 'edit-status error';
            }
        }

        // ═══ Render & manage tagged media ═══

        function renderEditMedia() {
            const list = document.getElementById('catMediaList');
            list.innerHTML = '';

            editMedia.forEach(function(media, index) {
                var item = document.createElement('div');
                item.className = 'cat-media-item';

                // Preview: image or PDF icon
                if (media.file_type === 'pdf') {
                    var pdfIcon = document.createElement('div');
                    pdfIcon.className = 'cat-pdf-icon';
                    pdfIcon.textContent = 'PDF';
                    item.appendChild(pdfIcon);
                } else {
                    var img = document.createElement('img');
                    img.src = media.file_url || media.previewUrl || '';
                    img.alt = '';
                    item.appendChild(img);
                }

                var info = document.createElement('div');
                info.className = 'cat-media-info';

                var tags = document.createElement('div');
                tags.className = 'cat-media-tags';

                mediaTagsList.forEach(function(tag) {
                    var chip = document.createElement('span');
                    chip.className = 'cat-tag' + (media.tags.indexOf(tag) !== -1 ? ' active' : '');
                    chip.textContent = tag.replace(/_/g, ' ');
                    chip.onclick = function() {
                        var idx = media.tags.indexOf(tag);
                        if (idx !== -1) {
                            media.tags.splice(idx, 1);
                        } else {
                            media.tags.push(tag);
                        }
                        chip.classList.toggle('active');
                    };
                    tags.appendChild(chip);
                });

                info.appendChild(tags);
                item.appendChild(info);

                var removeBtn = document.createElement('button');
                removeBtn.className = 'cat-media-remove';
                removeBtn.innerHTML = '&times;';
                removeBtn.title = 'Supprimer';
                removeBtn.onclick = async function() {
                    if (media.id && !media.isNew) {
                        var ok = await steleConfirm('Supprimer ce média ? Cette action sera définitive après sauvegarde.', 'Supprimer le média', 'Supprimer');
                        if (!ok) return;
                        editMediaToDelete.push({ id: media.id, file_url: media.file_url });
                    }
                    editMedia.splice(index, 1);
                    renderEditMedia();
                };
                item.appendChild(removeBtn);

                list.appendChild(item);
            });
        }

        async function handleEditMediaFiles(files) {
            var fileList = Array.from(files);
            for (var i = 0; i < fileList.length; i++) {
                var file = fileList[i];
                var isPdf = file.type === 'application/pdf';
                var isImage = file.type.startsWith('image/');
                if (!isPdf && !isImage) continue;

                if (isImage) {
                    // Open crop modal, wait for result
                    var result = await new Promise(function(resolve) {
                        openCropModal(file);
                        cropState._resolve = resolve;
                    });
                    if (!result) continue; // cancelled

                    editMedia.push({
                        id: null,
                        file_url: null,
                        previewUrl: URL.createObjectURL(result.croppedBlob),
                        file_type: 'image',
                        tags: [],
                        isNew: true,
                        file: result.croppedBlob,
                        originalFile: result.originalBlob,
                        cropRatio: result.ratio,
                        cropData: result.cropData
                    });
                    renderEditMedia();
                } else {
                    // PDF: no crop
                    editMedia.push({
                        id: null,
                        file_url: null,
                        previewUrl: null,
                        file_type: 'pdf',
                        tags: [],
                        isNew: true,
                        file: file
                    });
                    renderEditMedia();
                }
            }
        }

        // ═══ Prix composé — Rendu des tableaux minutes & matériaux ═══

        function renderComposedTables(item) {
            var laborMinutes = item.labor_minutes || {};
            var materialCosts = item.material_costs || {};

            // Tableau des minutes
            var mBody = document.getElementById('cpMinutesBody');
            var mHtml = '';
            for (var i = 0; i < tauxHoraires.length; i++) {
                var dept = tauxHoraires[i].department;
                var val = laborMinutes[dept] || '';
                mHtml += '<tr><td>' + escapeHtml(dept) + '</td>' +
                    '<td><input type="number" step="0.1" placeholder="0" value="' + val + '"' +
                    ' data-dept="' + escapeAttr(dept) + '"' +
                    (canEditMinutes ? '' : ' disabled') +
                    ' oninput="updateComposedPrice()"></td></tr>';
            }
            mBody.innerHTML = mHtml;

            // Tableau des matériaux
            var cBody = document.getElementById('cpMaterialsBody');
            var cHtml = '';
            for (var j = 0; j < expenseCategories.length; j++) {
                var cat = expenseCategories[j].name;
                var cVal = materialCosts[cat] ? parseFloat(materialCosts[cat]).toFixed(2) : '';
                cHtml += '<tr><td title="' + escapeAttr(cat) + '">' + escapeHtml(cat) + '</td>' +
                    '<td><input type="number" step="0.01" placeholder="0.00" value="' + cVal + '"' +
                    ' data-cat="' + escapeAttr(cat) + '"' +
                    (canEditMaterials ? '' : ' disabled') +
                    ' oninput="updateComposedPrice()"></td></tr>';
            }
            cBody.innerHTML = cHtml;

            updateComposedPrice();
        }

        function updateComposedPrice() {
            // Calcul main-d'œuvre
            var laborTotal = 0;
            var mInputs = document.querySelectorAll('#cpMinutesBody input[type="number"]');
            for (var i = 0; i < mInputs.length; i++) {
                var minutes = parseFloat(mInputs[i].value) || 0;
                var dept = mInputs[i].getAttribute('data-dept');
                var taux = tauxHoraires.find(function(t) { return t.department === dept; });
                var tauxHoraire = taux ? (taux.taux_horaire || 0) : 0;
                laborTotal += (minutes / 60) * tauxHoraire;
            }

            // Calcul matériaux
            var materialTotal = 0;
            var cInputs = document.querySelectorAll('#cpMaterialsBody input[type="number"]');
            for (var j = 0; j < cInputs.length; j++) {
                var cost = parseFloat(cInputs[j].value) || 0;
                var catName = cInputs[j].getAttribute('data-cat');
                var expCat = expenseCategories.find(function(c) { return c.name === catName; });
                var markup = expCat ? (expCat.markup || 0) : 0;
                var waste = expCat ? (expCat.waste || 0) : 0;
                materialTotal += cost * (1 + markup / 100 + waste / 100);
            }

            var total = laborTotal + materialTotal;
            var totalEl = document.getElementById('cpTotalValue');
            var breakdownEl = document.getElementById('cpBreakdown');

            var priceField = document.getElementById('editPrice');
            var priceDisplay = document.getElementById('editPriceDisplay');
            if (total > 0) {
                totalEl.textContent = formatPrice(total);
                breakdownEl.textContent = '(MO: ' + formatPrice(laborTotal) + ' + Mat: ' + formatPrice(materialTotal) + ')';
                priceField.value = total.toFixed(2);
                priceDisplay.textContent = formatPrice(total);
            } else {
                totalEl.textContent = '\u2014';
                breakdownEl.textContent = '';
                priceField.value = '';
                priceDisplay.textContent = 'Calculé automatiquement';
            }
        }

        function collectLaborMinutes() {
            var data = {};
            var inputs = document.querySelectorAll('#cpMinutesBody input[type="number"]');
            for (var i = 0; i < inputs.length; i++) {
                var val = parseFloat(inputs[i].value) || 0;
                if (val > 0) {
                    data[inputs[i].getAttribute('data-dept')] = val;
                }
            }
            return data;
        }

        function collectMaterialCosts() {
            var data = {};
            var inputs = document.querySelectorAll('#cpMaterialsBody input[type="number"]');
            for (var i = 0; i < inputs.length; i++) {
                var val = parseFloat(inputs[i].value) || 0;
                if (val > 0) {
                    data[inputs[i].getAttribute('data-cat')] = val;
                }
            }
            return data;
        }

        // ═══ Composantes fournisseur ═══

        async function loadSupplierCompanies() {
            try {
                var resp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/companies?company_type=eq.Fournisseurs&select=id,name&order=name', {});
                if (resp.ok) {
                    supplierCompanies = await resp.json();
                }
            } catch (e) { /* ignore */ }
        }

        async function loadComponents(itemId) {
            editComponents = [];
            editComponentsToDelete = [];
            if (!itemId) { renderComponents(); return; }
            try {
                var resp = await authenticatedFetch(
                    SUPABASE_URL + '/rest/v1/catalogue_item_components?catalogue_item_id=eq.' + itemId + '&order=sort_order', {}
                );
                if (resp.ok) {
                    var rows = await resp.json();
                    editComponents = rows.map(function(r) {
                        return {
                            id: r.id,
                            supplier_name: r.supplier_name || '',
                            supplier_sku: r.supplier_sku || '',
                            description: r.description || '',
                            expense_category: r.expense_category || '',
                            qty_per_unit: r.qty_per_unit != null ? r.qty_per_unit : 1,
                            unit_cost: r.unit_cost != null ? r.unit_cost : 0,
                            notes: r.notes || '',
                            sort_order: r.sort_order || 0,
                            isNew: false
                        };
                    });
                }
            } catch (e) { /* ignore */ }
            renderComponents();
            syncComponentsToMaterials();
        }

        function renderComponents() {
            var container = document.getElementById('componentsList');
            if (!container) return;
            var html = '';
            if (editComponents.length > 0) {
                html += '<div class="comp-header">' +
                    '<span class="comp-supplier-wrap">Fournisseur</span>' +
                    '<span class="comp-category">Cat&eacute;gorie</span>' +
                    '<span class="comp-sku">Code produit</span>' +
                    '<span class="comp-desc">Description</span>' +
                    '<span class="comp-qty">Qt&eacute;</span>' +
                    '<span class="comp-cost">Co&ucirc;t ($)</span>' +
                    '<span style="width:28px;flex:none;"></span>' +
                    '</div>';
            }
            // Build category options
            var catOptions = '<option value="">—</option>';
            for (var j = 0; j < expenseCategories.length; j++) {
                catOptions += '<option value="' + escapeAttr(expenseCategories[j].name) + '">' + escapeHtml(expenseCategories[j].name) + '</option>';
            }
            for (var i = 0; i < editComponents.length; i++) {
                var c = editComponents[i];
                // Category select with correct selected option
                var catSelect = '<select class="comp-category" data-field="expense_category" onchange="onComponentCategoryChange(this)">';
                catSelect += '<option value="">—</option>';
                for (var k = 0; k < expenseCategories.length; k++) {
                    var sel = (c.expense_category === expenseCategories[k].name) ? ' selected' : '';
                    catSelect += '<option value="' + escapeAttr(expenseCategories[k].name) + '"' + sel + '>' + escapeHtml(expenseCategories[k].name) + '</option>';
                }
                catSelect += '</select>';

                html += '<div class="comp-row" data-idx="' + i + '">' +
                    '<div class="comp-supplier-wrap">' +
                        '<input type="text" placeholder="Fournisseur" value="' + escapeAttr(c.supplier_name) + '" data-field="supplier_name" oninput="filterSupplierDropdown(this)" onfocus="openSupplierDropdown(this)" autocomplete="off">' +
                        '<div class="comp-supplier-dd"></div>' +
                    '</div>' +
                    catSelect +
                    '<input class="comp-sku" placeholder="Code produit" value="' + escapeAttr(c.supplier_sku) + '" data-field="supplier_sku" oninput="updateComponentField(this)">' +
                    '<input class="comp-desc" placeholder="Description" value="' + escapeAttr(c.description) + '" data-field="description" oninput="updateComponentField(this)">' +
                    '<input type="number" class="comp-qty" step="0.01" min="0" placeholder="1" value="' + (c.qty_per_unit || '') + '" data-field="qty_per_unit" oninput="updateComponentField(this); syncComponentsToMaterials()">' +
                    '<input type="number" class="comp-cost" step="0.01" min="0" placeholder="0.00" value="' + (c.unit_cost || '') + '" data-field="unit_cost" oninput="updateComponentField(this); syncComponentsToMaterials()">' +
                    '<button type="button" class="comp-remove" onclick="removeComponent(' + i + ')">&times;</button>' +
                    '</div>';
            }
            container.innerHTML = html;
        }

        // ── Supplier combobox ──

        function openSupplierDropdown(input) {
            closeAllSupplierDropdowns();
            var dd = input.parentNode.querySelector('.comp-supplier-dd');
            populateSupplierDropdown(dd, input, '');
            dd.classList.add('open');
        }

        function filterSupplierDropdown(input) {
            updateComponentField(input);
            var dd = input.parentNode.querySelector('.comp-supplier-dd');
            var filter = input.value.toLowerCase().trim();
            populateSupplierDropdown(dd, input, filter);
            if (!dd.classList.contains('open')) dd.classList.add('open');
        }

        function populateSupplierDropdown(dd, input, filter) {
            var idx = parseInt(input.closest('.comp-row').getAttribute('data-idx'));
            var currentVal = editComponents[idx].supplier_name;
            var html = '';
            var count = 0;
            for (var i = 0; i < supplierCompanies.length; i++) {
                var name = supplierCompanies[i].name;
                if (filter && name.toLowerCase().indexOf(filter) === -1) continue;
                var sel = (name === currentVal) ? ' selected' : '';
                html += '<div class="comp-dd-item' + sel + '" data-name="' + escapeAttr(name) + '" onclick="selectSupplier(this)">' + escapeHtml(name) + '</div>';
                count++;
            }
            if (count === 0 && filter) {
                html += '<div class="comp-dd-item" style="color:#999;font-style:italic;">Aucun r&eacute;sultat</div>';
            }
            html += '<div class="comp-dd-add" onclick="addNewSupplier(this)">+ Ajouter un fournisseur</div>';
            dd.innerHTML = html;
        }

        function selectSupplier(el) {
            var name = el.getAttribute('data-name');
            var row = el.closest('.comp-row');
            var input = row.querySelector('.comp-supplier-wrap input');
            var idx = parseInt(row.getAttribute('data-idx'));
            input.value = name;
            editComponents[idx].supplier_name = name;
            closeAllSupplierDropdowns();
        }

        var _supplierTargetIdx = null;

        function addNewSupplier(el) {
            var row = el.closest('.comp-row');
            _supplierTargetIdx = parseInt(row.getAttribute('data-idx'));
            closeAllSupplierDropdowns();
            // Pre-fill name from current input text
            var input = row.querySelector('.comp-supplier-wrap input');
            document.getElementById('supName').value = input.value.trim();
            document.getElementById('supAddress').value = '';
            document.getElementById('supPhone').value = '';
            document.getElementById('supEmail').value = '';
            document.getElementById('supWebsite').value = '';
            document.getElementById('supNotes').value = '';
            document.getElementById('supplierModalStatus').textContent = '';
            document.getElementById('supplierModal').classList.add('active');
            document.getElementById('supName').focus();
        }

        function closeSupplierModal() {
            document.getElementById('supplierModal').classList.remove('active');
            _supplierTargetIdx = null;
        }

        async function saveNewSupplier() {
            var name = document.getElementById('supName').value.trim();
            if (!name) {
                document.getElementById('supplierModalStatus').textContent = 'Le nom est requis.';
                document.getElementById('supplierModalStatus').className = 'edit-status error';
                document.getElementById('supplierModalStatus').style.display = '';
                return;
            }
            try {
                var resp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/companies', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                    body: JSON.stringify({
                        name: name,
                        company_type: 'Fournisseurs',
                        address: document.getElementById('supAddress').value.trim() || null,
                        phone: document.getElementById('supPhone').value.trim() || null,
                        email: document.getElementById('supEmail').value.trim() || null,
                        website: document.getElementById('supWebsite').value.trim() || null,
                        notes: document.getElementById('supNotes').value.trim() || null,
                        created_by: localStorage.getItem('sb_user_id')
                    })
                });
                if (!resp.ok) throw new Error('Erreur ' + resp.status);
                var rows = await resp.json();
                if (rows.length > 0) {
                    supplierCompanies.push({ id: rows[0].id, name: name });
                    supplierCompanies.sort(function(a, b) { return a.name.localeCompare(b.name); });
                }
                // Assign to component row
                if (_supplierTargetIdx != null && editComponents[_supplierTargetIdx]) {
                    editComponents[_supplierTargetIdx].supplier_name = name;
                    renderComponents();
                }
                closeSupplierModal();
            } catch (e) {
                document.getElementById('supplierModalStatus').textContent = 'Erreur: ' + e.message;
                document.getElementById('supplierModalStatus').className = 'edit-status error';
                document.getElementById('supplierModalStatus').style.display = '';
            }
        }

        function closeAllSupplierDropdowns() {
            document.querySelectorAll('.comp-supplier-dd.open').forEach(function(dd) { dd.classList.remove('open'); });
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.comp-supplier-wrap')) {
                closeAllSupplierDropdowns();
            }
        });

        // ── Category change with warning ──

        async function onComponentCategoryChange(select) {
            var row = select.closest('.comp-row');
            var idx = parseInt(row.getAttribute('data-idx'));
            var newCat = select.value;
            var oldCat = editComponents[idx].expense_category || '';

            // Check if new category has a manual cost and no existing components in that category
            if (newCat) {
                var existingComponentsInCat = editComponents.filter(function(c, ci) {
                    return ci !== idx && c.expense_category === newCat;
                });
                if (existingComponentsInCat.length === 0) {
                    // No other components in this category — check for manual cost
                    var matInput = document.querySelector('#cpMaterialsBody input[data-cat="' + newCat + '"]');
                    if (matInput && parseFloat(matInput.value) > 0 && !matInput.disabled) {
                        var currentCost = parseFloat(matInput.value);
                        var confirmed = await steleConfirm(
                            'La cat\u00e9gorie <strong>' + escapeHtml(newCat) + '</strong> a d\u00e9j\u00e0 un co\u00fbt manuel de' +
                            '<span class="scb-amount">' + formatPrice(currentCost) + '</span>' +
                            'En ajoutant des composantes, ce montant sera remplac\u00e9 par le total calcul\u00e9 des composantes.',
                            'Remplacer le co\u00fbt manuel ?',
                            'Oui, remplacer par les composantes'
                        );
                        if (!confirmed) {
                            select.value = oldCat;
                            return;
                        }
                    }
                }
            }

            editComponents[idx].expense_category = newCat;
            syncComponentsToMaterials();
        }

        // ── Sync components → material costs ──

        function syncComponentsToMaterials() {
            // Calculate totals per expense category from components
            var catTotals = {};
            for (var i = 0; i < editComponents.length; i++) {
                var c = editComponents[i];
                if (c.expense_category) {
                    if (!catTotals[c.expense_category]) catTotals[c.expense_category] = 0;
                    catTotals[c.expense_category] += (c.qty_per_unit || 0) * (c.unit_cost || 0);
                }
            }

            // Update material cost inputs
            var inputs = document.querySelectorAll('#cpMaterialsBody input[type="number"]');
            for (var j = 0; j < inputs.length; j++) {
                var catName = inputs[j].getAttribute('data-cat');
                var td = inputs[j].parentNode;
                if (catTotals[catName] !== undefined) {
                    // Locked — calculated from components
                    inputs[j].value = catTotals[catName].toFixed(2);
                    inputs[j].disabled = true;
                    td.classList.add('cp-locked-cell');
                } else {
                    // Unlocked — manual entry
                    td.classList.remove('cp-locked-cell');
                    if (canEditMaterials) inputs[j].disabled = false;
                }
            }
            updateComposedPrice();
        }

        function updateComponentField(input) {
            var idx = parseInt(input.closest('.comp-row').getAttribute('data-idx'));
            var field = input.getAttribute('data-field');
            if (field === 'qty_per_unit' || field === 'unit_cost') {
                editComponents[idx][field] = parseFloat(input.value) || 0;
            } else {
                editComponents[idx][field] = input.value;
            }
        }

        function addComponent() {
            editComponents.push({
                id: null, supplier_name: '', supplier_sku: '', description: '',
                expense_category: '', qty_per_unit: 1, unit_cost: 0, notes: '',
                sort_order: editComponents.length + 1, isNew: true
            });
            renderComponents();
            syncComponentsToMaterials();
            var rows = document.querySelectorAll('#componentsList .comp-row');
            if (rows.length > 0) {
                var lastRow = rows[rows.length - 1];
                var firstInput = lastRow.querySelector('.comp-supplier-wrap input');
                if (firstInput) firstInput.focus();
            }
        }

        function removeComponent(index) {
            var comp = editComponents[index];
            if (comp.id && !comp.isNew) {
                editComponentsToDelete.push(comp.id);
            }
            editComponents.splice(index, 1);
            renderComponents();
            syncComponentsToMaterials();
        }

        async function saveComponents(itemId) {
            // Delete removed components
            if (editComponentsToDelete.length > 0) {
                var ids = editComponentsToDelete.map(function(id) { return '"' + id + '"'; }).join(',');
                await authenticatedFetch(
                    SUPABASE_URL + '/rest/v1/catalogue_item_components?id=in.(' + ids + ')',
                    { method: 'DELETE', headers: { 'Prefer': 'return=minimal' } }
                );
            }
            // Upsert components
            for (var i = 0; i < editComponents.length; i++) {
                var c = editComponents[i];
                c.sort_order = i + 1;
                var payload = {
                    catalogue_item_id: itemId,
                    supplier_name: c.supplier_name || null,
                    supplier_sku: c.supplier_sku || null,
                    description: c.description || null,
                    expense_category: c.expense_category || null,
                    qty_per_unit: c.qty_per_unit || 1,
                    unit_cost: c.unit_cost || 0,
                    notes: c.notes || null,
                    sort_order: c.sort_order
                };
                if (c.isNew) {
                    await authenticatedFetch(SUPABASE_URL + '/rest/v1/catalogue_item_components', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                        body: JSON.stringify(payload)
                    });
                } else if (c.id) {
                    await authenticatedFetch(SUPABASE_URL + '/rest/v1/catalogue_item_components?id=eq.' + c.id, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                        body: JSON.stringify(payload)
                    });
                }
            }
        }

        async function saveEditModal() {
            // Validate: components must have a supplier name
            for (var v = 0; v < editComponents.length; v++) {
                if (!editComponents[v].supplier_name || !editComponents[v].supplier_name.trim()) {
                    var rows = document.querySelectorAll('#componentsList .comp-row');
                    if (rows[v]) {
                        var inp = rows[v].querySelector('.comp-supplier-wrap input');
                        if (inp) { inp.focus(); inp.style.borderColor = '#c62828'; }
                    }
                    var valErr = document.getElementById('editStatus');
                    valErr.textContent = 'Le fournisseur est requis pour chaque composante.';
                    valErr.style.display = '';
                    valErr.className = 'edit-status error';
                    return;
                }
            }

            // Validate JSON in calc rule AI field if non-empty
            var calcRuleAiRaw = document.getElementById('editCalcRuleAi').value.trim();
            if (calcRuleAiRaw) {
                try { JSON.parse(calcRuleAiRaw); } catch (e) {
                    var errEl = document.getElementById('calcRuleError');
                    errEl.textContent = 'JSON invalide dans la r\u00e8gle AI : ' + e.message;
                    errEl.style.display = '';
                    document.getElementById('editCalcRuleAi').focus();
                    return;
                }
            }

            const btn = document.getElementById('btnEditSave');
            const status = document.getElementById('editStatus');
            btn.disabled = true;
            btn.textContent = 'Sauvegarde...';
            status.style.display = 'none';

            try {
                const itemId = document.getElementById('editItemId').value;
                const priceVal = document.getElementById('editPrice').value;

                const payload = {
                    category: document.getElementById('editCategory').value,
                    description: document.getElementById('editDescription').value,
                    type: document.getElementById('editType').value,
                    price: priceVal !== '' ? parseFloat(priceVal) : null,
                    instruction: document.getElementById('editInstruction').value,
                    in_calculator: document.getElementById('editInCalculator').checked,
                    is_default: document.getElementById('editIsDefault').checked,
                    has_sales_sheet: document.getElementById('editHasSalesSheet').checked,
                    labor_minutes: collectLaborMinutes(),
                    material_costs: collectMaterialCosts(),
                    calculation_rule_human: document.getElementById('editCalcRuleHuman').value || null,
                    calculation_rule_ai: (function() {
                        var v = document.getElementById('editCalcRuleAi').value.trim();
                        if (!v) return null;
                        try { return JSON.parse(v); } catch(e) { return null; }
                    })(),
                    client_text: document.getElementById('editClientText').value || null,
                    presentation_rule_human: document.getElementById('editPresRuleHuman').value || null,
                    presentation_rule: (function() {
                        var v = document.getElementById('editPresRuleAi').value.trim();
                        if (!v) return null;
                        try { return JSON.parse(v); } catch(e) { return null; }
                    })()
                };

                let resp;
                if (isNewItem && newItemData) {
                    // Nouvel item : POST avec id et sort_order
                    const createPayload = Object.assign({ id: itemId, sort_order: newItemData.sort_order }, payload);
                    resp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/catalogue_items', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify(createPayload)
                    });

                    if (!resp.ok) throw new Error('Erreur cr\u00e9ation: ' + resp.status);

                    const data = await resp.json();
                    CATALOGUE_DATA.push(data[0]);
                } else {
                    // Item existant : PATCH
                    resp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/catalogue_items?id=eq.' + itemId, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!resp.ok) throw new Error('Erreur sauvegarde: ' + resp.status);

                    const item = CATALOGUE_DATA.find(i => i.id === itemId);
                    if (item) {
                        Object.assign(item, payload);
                    }
                }

                // ── Sauvegarder les médias ──

                // 1. Supprimer les médias retirés
                for (var mi = 0; mi < editMediaToDelete.length; mi++) {
                    var del = editMediaToDelete[mi];
                    await authenticatedFetch(SUPABASE_URL + '/rest/v1/item_media?id=eq.' + del.id, {
                        method: 'DELETE',
                        headers: { 'Prefer': 'return=minimal' }
                    });
                    // Tenter de supprimer du Storage aussi
                    if (del.file_url && del.file_url.indexOf('/fiche-images/') !== -1) {
                        var storagePath = del.file_url.split('/fiche-images/')[1];
                        if (storagePath) {
                            await authenticatedFetch(SUPABASE_URL + '/storage/v1/object/fiche-images/' + storagePath, {
                                method: 'DELETE'
                            }).catch(function() {});
                        }
                    }
                }
                editMediaToDelete = [];

                // 2. Upload nouveaux médias + insert item_media
                for (var mi2 = 0; mi2 < editMedia.length; mi2++) {
                    var m = editMedia[mi2];

                    if (m.isNew && m.file) {
                        var ts = Date.now();
                        var fileUrl;
                        var originalUrl = null;

                        if (m.originalFile) {
                            // Cropped image: upload original + cropped separately
                            var origPath = 'originals/' + itemId + '/' + ts + '.jpg';
                            var origResp = await authenticatedFetch(SUPABASE_URL + '/storage/v1/object/fiche-images/' + origPath, {
                                method: 'POST',
                                headers: { 'Content-Type': 'image/jpeg', 'x-upsert': 'true' },
                                body: m.originalFile
                            });
                            if (!origResp.ok) throw new Error('Erreur upload original: ' + origResp.status);
                            originalUrl = SUPABASE_URL + '/storage/v1/object/public/fiche-images/' + origPath;

                            var cropPath = itemId + '/' + ts + '_' + (m.cropRatio || '16x9').replace(':', 'x') + '.jpg';
                            var cropResp = await authenticatedFetch(SUPABASE_URL + '/storage/v1/object/fiche-images/' + cropPath, {
                                method: 'POST',
                                headers: { 'Content-Type': 'image/jpeg', 'x-upsert': 'true' },
                                body: m.file
                            });
                            if (!cropResp.ok) throw new Error('Erreur upload crop: ' + cropResp.status);
                            fileUrl = SUPABASE_URL + '/storage/v1/object/public/fiche-images/' + cropPath;
                        } else {
                            // Non-cropped file (PDF): upload as before
                            var ext = m.file.name ? m.file.name.split('.').pop().toLowerCase() : 'bin';
                            var path = itemId + '/' + ts + '_' + mi2 + '.' + ext;
                            var uploadResp = await authenticatedFetch(SUPABASE_URL + '/storage/v1/object/fiche-images/' + path, {
                                method: 'POST',
                                headers: { 'Content-Type': m.file.type || 'application/octet-stream', 'x-upsert': 'true' },
                                body: m.file
                            });
                            if (!uploadResp.ok) throw new Error('Erreur upload: ' + uploadResp.status);
                            fileUrl = SUPABASE_URL + '/storage/v1/object/public/fiche-images/' + path;
                        }

                        var insertPayload = {
                            catalogue_item_id: itemId,
                            file_url: fileUrl,
                            file_type: m.file_type,
                            tags: m.tags,
                            sort_order: mi2
                        };
                        if (originalUrl) insertPayload.original_url = originalUrl;
                        if (m.cropRatio) insertPayload.crop_ratio = m.cropRatio;
                        if (m.cropData) insertPayload.crop_data = m.cropData;

                        var insertResp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/item_media', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                            body: JSON.stringify(insertPayload)
                        });
                        if (!insertResp.ok) throw new Error('Erreur insertion m\u00e9dia: ' + insertResp.status);

                        var insertedData = await insertResp.json();
                        m.id = insertedData[0].id;
                        m.file_url = fileUrl;
                        m.isNew = false;
                        m.file = null;
                        m.originalFile = null;
                        m.previewUrl = null;
                    } else if (m.id && !m.isNew) {
                        // Mettre à jour tags
                        await authenticatedFetch(SUPABASE_URL + '/rest/v1/item_media?id=eq.' + m.id, {
                            method: 'PATCH',
                            headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                            body: JSON.stringify({ tags: m.tags, sort_order: mi2 })
                        });
                    }
                }

                // 3. Auto-sync image_url depuis le premier média tagué "catalogue"
                var catalogueMedia = editMedia.find(function(m) { return m.tags.indexOf('catalogue') !== -1 && m.file_type === 'image'; });
                var syncImageUrl = catalogueMedia ? catalogueMedia.file_url : null;
                var currentItem = CATALOGUE_DATA.find(function(i) { return i.id === itemId; });
                if (currentItem && currentItem.image_url !== syncImageUrl) {
                    await authenticatedFetch(SUPABASE_URL + '/rest/v1/catalogue_items?id=eq.' + itemId, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                        body: JSON.stringify({ image_url: syncImageUrl })
                    });
                    if (currentItem) currentItem.image_url = syncImageUrl;
                }

                // 4. Sauver les composantes fournisseur
                await saveComponents(itemId);

                // Re-générer les tables
                generatePriceTables();

                status.textContent = '\u2713 Sauvegardé';
                status.style.display = '';
                status.className = 'edit-status success';

                setTimeout(() => closeEditModal(), 800);
            } catch (err) {
                console.error('Erreur sauvegarde:', err);
                status.textContent = 'Erreur: ' + err.message;
                status.style.display = '';
                status.className = 'edit-status error';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Sauvegarder';
            }
        }

        // Setup des handlers de la modal d'édition
        function setupEditModalHandlers() {
            const zone = document.getElementById('catDropzone');
            const input = document.getElementById('catMediaInput');

            zone.addEventListener('click', () => input.click());

            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                zone.classList.add('dragover');
            });

            zone.addEventListener('dragleave', () => {
                zone.classList.remove('dragover');
            });

            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('dragover');
                handleEditMediaFiles(e.dataTransfer.files);
            });

            input.addEventListener('change', () => {
                handleEditMediaFiles(input.files);
                input.value = '';
            });

            // Fermer modal au clic extérieur (sauf si le drawer AI est ouvert)
            document.getElementById('editModal').addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-overlay')) {
                    var drawerOpen = document.getElementById('ciDrawer') && document.getElementById('ciDrawer').classList.contains('active');
                    if (!drawerOpen) closeEditModal();
                }
            });
        }

        // ═══════════════════════════════════════════════════════════════════════
        // IMPORTATEUR CATALOGUE (AI CHAT)
        // ═══════════════════════════════════════════════════════════════════════

        var ciConversation = [];
        var ciPendingImages = [];
        var ciPendingToolCalls = null;
        var filterPendingOnly = false;

        function toggleImportDrawer() {
            var drawer = document.getElementById('ciDrawer');
            if (drawer.classList.contains('active')) closeImportDrawer();
            else openImportDrawer();
        }

        function openImportDrawer() {
            document.getElementById('ciOverlay').classList.add('active');
            document.getElementById('ciDrawer').classList.add('active');
            setTimeout(function() {
                var inp = document.getElementById('ciInput');
                if (inp) inp.focus({ preventScroll: true });
            }, 300);
        }

        function closeImportDrawer() {
            document.getElementById('ciOverlay').classList.remove('active');
            document.getElementById('ciDrawer').classList.remove('active');
        }

        function setupImportDrawerHandlers() {
            var input = document.getElementById('ciInput');
            var dropZone = document.getElementById('ciDropZone');
            var drawer = document.getElementById('ciDrawer');

            if (input) {
                input.addEventListener('paste', function(e) {
                    var items = (e.clipboardData || {}).items || [];
                    for (var i = 0; i < items.length; i++) {
                        if (items[i].type.indexOf('image') !== -1) {
                            e.preventDefault();
                            ciProcessImage(items[i].getAsFile());
                            break;
                        }
                    }
                });
            }

            if (drawer) {
                drawer.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    dropZone.classList.add('active');
                });
                drawer.addEventListener('dragleave', function(e) {
                    if (!drawer.contains(e.relatedTarget)) dropZone.classList.remove('active');
                });
                drawer.addEventListener('drop', function(e) {
                    e.preventDefault();
                    dropZone.classList.remove('active');
                    var files = e.dataTransfer.files;
                    for (var i = 0; i < files.length; i++) {
                        if (files[i].type.indexOf('image') !== -1) {
                            ciProcessImage(files[i]);
                        }
                    }
                });
            }
        }

        function ciProcessImage(file) {
            var reader = new FileReader();
            reader.onload = function(e) {
                var img = new Image();
                img.onload = function() {
                    var canvas = document.createElement('canvas');
                    var maxDim = 1200;
                    var w = img.width, h = img.height;
                    if (w > maxDim || h > maxDim) {
                        if (w > h) { h = Math.round(h * maxDim / w); w = maxDim; }
                        else { w = Math.round(w * maxDim / h); h = maxDim; }
                    }
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    ciPendingImages.push(canvas.toDataURL('image/jpeg', 0.8));
                    renderCiImagePreviews();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function renderCiImagePreviews() {
            var container = document.getElementById('ciImgPreview');
            container.innerHTML = '';
            ciPendingImages.forEach(function(src, i) {
                var div = document.createElement('div');
                div.className = 'ci-img-thumb';
                div.innerHTML = '<img src="' + src + '"><button class="ci-img-remove" onclick="ciRemoveImage(' + i + ')">&times;</button>';
                container.appendChild(div);
            });
        }

        function ciRemoveImage(index) {
            ciPendingImages.splice(index, 1);
            renderCiImagePreviews();
        }

        function ciInputKeydown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendImportMessage();
            }
        }

        function ciQuickAction(text) {
            document.getElementById('ciInput').value = text;
            document.getElementById('ciInput').focus();
        }

        function appendCiMessage(role, content, opts) {
            opts = opts || {};
            var container = document.getElementById('ciMessages');
            var div = document.createElement('div');

            if (role === 'confirm') {
                div.className = 'ci-msg ci-msg-confirm';
                var confirmId = 'ci-confirm-' + Date.now();
                div.id = confirmId;
                div.innerHTML = '<div class="ci-confirm-text">' + renderCiMarkdown(content) + '</div>' +
                    '<div class="ci-confirm-actions">' +
                    '<button class="btn-ci-apply" onclick="ciApplyPending(\'' + confirmId + '\')">Cr\u00e9er les articles</button>' +
                    '<button class="btn-ci-dismiss" onclick="ciDismissPending(\'' + confirmId + '\')">Ignorer</button>' +
                    '</div>';
                container.appendChild(div);
            } else {
                div.className = 'ci-msg ci-msg-' + role;
                if (role === 'user' && opts.images && opts.images.length > 0) {
                    var imgHtml = opts.images.map(function(src) {
                        return '<img src="' + src + '" style="max-width:100%;border-radius:8px;margin-bottom:6px;">';
                    }).join('');
                    div.innerHTML = imgHtml + renderCiMarkdown(content);
                } else {
                    div.innerHTML = renderCiMarkdown(content);
                }
                container.appendChild(div);
            }

            var isNearBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 80;
            if (isNearBottom) container.scrollTop = container.scrollHeight;
        }

        function renderCiMarkdown(text) {
            if (!text) return '';
            var s = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            // Code blocks
            s = s.replace(/```([\s\S]*?)```/g, '<pre>$1</pre>');
            // Inline code
            s = s.replace(/`([^`]+)`/g, '<code>$1</code>');
            // Bold
            s = s.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            // Italic
            s = s.replace(/\*(.+?)\*/g, '<em>$1</em>');
            // Tables → cards (with stagger animation)
            s = s.replace(/((?:\|.*\|\n?)+)/g, function(table) {
                var rows = table.trim().split('\n').filter(function(r) { return r.trim() && !/^\|[\s\-:]+\|$/.test(r); });
                if (rows.length === 0) return table;
                var headers = rows[0].split('|').filter(function(c) { return c.trim() !== ''; }).map(function(c) { return c.trim().toLowerCase(); });
                var codeIdx = -1, descIdx = -1, priceIdx = -1;
                headers.forEach(function(h, i) {
                    var hl = h.toLowerCase();
                    if (codeIdx < 0 && (hl === 'code' || hl === 'id' || hl.indexOf('code') >= 0)) codeIdx = i;
                    if (descIdx < 0 && (hl === 'description' || hl.indexOf('desc') >= 0 || hl === 'article' || hl === 'nom')) descIdx = i;
                    if (priceIdx < 0 && (hl === 'prix' || hl === 'price' || hl.indexOf('prix') >= 0 || hl.indexOf('total') >= 0 || hl === 'montant')) priceIdx = i;
                });
                if (descIdx >= 0 && rows.length > 1) {
                    var cards = '';
                    for (var ri = 1; ri < rows.length; ri++) {
                        var cells = rows[ri].split('|').filter(function(c) { return c.trim() !== ''; }).map(function(c) { return c.trim(); });
                        var code = codeIdx >= 0 && cells[codeIdx] ? cells[codeIdx] : '';
                        var desc = cells[descIdx] || '';
                        var price = priceIdx >= 0 && cells[priceIdx] ? cells[priceIdx] : '';
                        var meta = [];
                        headers.forEach(function(h, i) {
                            if (i !== codeIdx && i !== descIdx && i !== priceIdx && cells[i] && cells[i].trim()) {
                                meta.push(h.charAt(0).toUpperCase() + h.slice(1) + ': ' + cells[i]);
                            }
                        });
                        var delay = (ri - 1) * 40;
                        cards += '<div class="ci-card" style="animation-delay:' + delay + 'ms">';
                        if (code || price) {
                            cards += '<div class="ci-card-row">';
                            cards += code ? '<span class="ci-card-code">' + code + '</span>' : '<span></span>';
                            cards += price ? '<span class="ci-card-price">' + price + '</span>' : '';
                            cards += '</div>';
                        }
                        if (desc) cards += '<div class="ci-card-desc">' + desc + '</div>';
                        if (meta.length) cards += '<div class="ci-card-meta">' + meta.join(' &middot; ') + '</div>';
                        cards += '</div>';
                    }
                    return '<div class="ci-card-stack">' + cards + '</div>';
                }
                // Fallback: soft-styled table
                var html = '<table>';
                rows.forEach(function(row, i) {
                    var cells = row.split('|').filter(function(c) { return c.trim() !== ''; });
                    var tag = i === 0 ? 'th' : 'td';
                    html += '<tr>' + cells.map(function(c) { return '<' + tag + '>' + c.trim() + '</' + tag + '>'; }).join('') + '</tr>';
                });
                html += '</table>';
                return html;
            });
            // Unordered lists
            s = s.replace(/^[•\-\*] (.+)$/gm, '<li>$1</li>');
            s = s.replace(/((?:<li>.*<\/li>\n?)+)/g, '<ul>$1</ul>');
            // Paragraphs
            s = s.replace(/\n{2,}/g, '</p><p>');
            s = s.replace(/\n/g, '<br>');
            s = '<p>' + s + '</p>';
            s = s.replace(/<p><\/p>/g, '');
            return s;
        }

        function buildCiUserContent(text, images) {
            if (!images || images.length === 0) return text;
            var content = [];
            images.forEach(function(dataUrl) {
                var match = dataUrl.match(/^data:(.*?);base64,(.*)$/);
                if (match) {
                    content.push({
                        type: 'image',
                        source: { type: 'base64', media_type: match[1], data: match[2] }
                    });
                }
            });
            if (text) content.push({ type: 'text', text: text });
            return content;
        }

        function collectImportContext() {
            // Categories
            var cats = new Set(configCategories);
            CATALOGUE_DATA.forEach(function(i) { if (i.category) cats.add(i.category); });

            // Existing codes grouped by prefix
            var existingCodes = {};
            CATALOGUE_DATA.forEach(function(i) {
                if (!i.id) return;
                var parts = i.id.split('-');
                if (parts.length === 2) {
                    if (!existingCodes[parts[0]]) existingCodes[parts[0]] = [];
                    existingCodes[parts[0]].push(parts[1]);
                }
            });

            // Unit types
            var unitTypes = ['pi\u00b2', 'unitaire', 'lin\u00e9aire', '%'];

            // Check if an article is currently open in the edit modal
            var openArticle = null;
            var editModal = document.getElementById('editModal');
            if (editModal && editModal.classList.contains('active')) {
                var editId = document.getElementById('editItemId');
                if (editId && editId.value) {
                    var found = CATALOGUE_DATA.find(function(i) { return i.id === editId.value; });
                    if (found) {
                        openArticle = {
                            code: found.id,
                            category: found.category,
                            description: found.description,
                            type: found.type,
                            price: found.price,
                            instruction: found.instruction || null,
                            client_text: found.client_text || null,
                            is_default: found.is_default || false,
                            labor_minutes: found.labor_minutes || null,
                            material_costs: found.material_costs || null
                        };
                    }
                }
            }

            return {
                categories: Array.from(cats),
                existingCodes: existingCodes,
                unitTypes: unitTypes,
                expenseCategories: expenseCategories,
                tauxHoraires: tauxHoraires,
                userEmail: (localStorage.getItem('sb_user_email') || '').toLowerCase(),
                openArticle: openArticle
            };
        }

        async function callCatalogueImport(messages, context) {
            var resp = await authenticatedFetch(SUPABASE_URL + '/functions/v1/catalogue-import', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ messages: messages, context: context })
            });
            if (!resp.ok) {
                var errText = await resp.text().catch(function() { return ''; });
                try { var errObj = JSON.parse(errText); throw new Error(errObj.error || 'Erreur ' + resp.status); }
                catch(e) { if (e.message) throw e; throw new Error('Erreur ' + resp.status); }
            }
            return await resp.json();
        }

        function ciSearchCatalogue(query) {
            var q = (query || '').toLowerCase();
            var results = CATALOGUE_DATA.filter(function(item) {
                return (item.description || '').toLowerCase().indexOf(q) !== -1 ||
                       (item.category || '').toLowerCase().indexOf(q) !== -1 ||
                       (item.id || '').toLowerCase().indexOf(q) !== -1;
            }).slice(0, 15).map(function(item) {
                return { id: item.id, description: item.description, category: item.category, type: item.type, price: item.price };
            });
            return { results: results, count: results.length };
        }

        async function sendImportMessage() {
            var input = document.getElementById('ciInput');
            var text = input.value.trim();
            if (!text && ciPendingImages.length === 0) return;

            var images = ciPendingImages.slice();
            ciPendingImages = [];
            renderCiImagePreviews();
            input.value = '';
            input.style.height = 'auto';

            appendCiMessage('user', text || '(image)', { images: images });

            var userContent = buildCiUserContent(text, images);
            ciConversation.push({ role: 'user', content: userContent });

            // Show typing
            document.getElementById('ciTyping').classList.add('active');
            document.getElementById('ciSendBtn').disabled = true;

            try {
                var context = collectImportContext();
                var data = await ciProcessResponse(ciConversation, context);
                ciHandleResponse(data);
            } catch (err) {
                appendCiMessage('assistant', 'Erreur : ' + err.message);
            } finally {
                document.getElementById('ciTyping').classList.remove('active');
                document.getElementById('ciSendBtn').disabled = false;
            }
        }

        // Process AI response — auto-execute read-only tools (search_catalogue), loop until text or create tool
        async function ciProcessResponse(conversation, context) {
            var maxLoops = 5; // safety limit for tool loops
            var data = await callCatalogueImport(conversation, context);

            for (var loop = 0; loop < maxLoops; loop++) {
                var contentBlocks = data.content || [];
                var toolCalls = contentBlocks.filter(function(b) { return b.type === 'tool_use'; });
                var readOnlyTools = toolCalls.filter(function(tc) { return tc.name === 'search_catalogue'; });
                var actionTools = toolCalls.filter(function(tc) { return tc.name !== 'search_catalogue'; });

                // If no read-only tools to auto-execute, return as-is
                if (readOnlyTools.length === 0) return data;

                // Auto-execute read-only tools and continue the conversation
                conversation.push({ role: 'assistant', content: contentBlocks });

                var toolResults = [];
                readOnlyTools.forEach(function(tc) {
                    var result = ciSearchCatalogue(tc.input.query);
                    toolResults.push({ type: 'tool_result', tool_use_id: tc.id, content: JSON.stringify(result) });
                });

                // If there are also action tools, we need to return them for confirmation
                // but first send the search results back
                if (actionTools.length > 0) {
                    conversation.push({ role: 'user', content: toolResults });
                    return data; // The action tools will be handled by ciHandleResponse
                }

                // Only read-only tools — send results back and get next response
                conversation.push({ role: 'user', content: toolResults });
                data = await callCatalogueImport(conversation, context);
            }

            return data; // safety: return whatever we have after max loops
        }

        function ciHandleResponse(data) {
            var contentBlocks = data.content || [];
            var textParts = [];
            var actionTools = [];

            contentBlocks.forEach(function(block) {
                if (block.type === 'text') textParts.push(block.text);
                if (block.type === 'tool_use' && block.name !== 'search_catalogue') actionTools.push(block);
            });

            // Add to conversation if not already added (when no read-only tools were processed)
            var lastMsg = ciConversation[ciConversation.length - 1];
            if (!lastMsg || lastMsg.role !== 'assistant' || lastMsg.content !== contentBlocks) {
                ciConversation.push({ role: 'assistant', content: contentBlocks });
            }

            if (actionTools.length > 0) {
                var fullText = textParts.join('\n');
                if (fullText) appendCiMessage('assistant', fullText);

                ciPendingToolCalls = { tools: actionTools };
                var summary = formatCiPendingActions(actionTools);
                appendCiMessage('confirm', summary);
            } else {
                var fullText = textParts.join('\n');
                appendCiMessage('assistant', fullText);
            }
        }

        function formatCiPendingActions(toolCalls) {
            var lines = [];
            var createCount = 0, updateCount = 0, deleteCount = 0;
            toolCalls.forEach(function(tc) {
                if (tc.name === 'create_catalogue_item') createCount++;
                else if (tc.name === 'update_catalogue_item') updateCount++;
                else if (tc.name === 'delete_catalogue_item') deleteCount++;
            });
            if (createCount > 0) lines.push('**' + createCount + ' article(s) \u00e0 cr\u00e9er :**');
            toolCalls.forEach(function(tc) {
                if (tc.name === 'create_catalogue_item' && tc.input) {
                    lines.push('- **' + (tc.input.code || '?') + '** ' + (tc.input.description || '') + ' \u2014 ' + (tc.input.unit_type || ''));
                    var moParts = [];
                    if (tc.input.labor_minutes) {
                        Object.keys(tc.input.labor_minutes).forEach(function(dept) {
                            if (tc.input.labor_minutes[dept] > 0) moParts.push(dept + ' ' + tc.input.labor_minutes[dept] + 'min');
                        });
                    }
                    if (moParts.length) lines.push('  MO: ' + moParts.join(', '));
                    var matParts = [];
                    if (tc.input.material_costs) {
                        Object.keys(tc.input.material_costs).forEach(function(cat) {
                            if (tc.input.material_costs[cat] > 0) matParts.push(cat + ' ' + tc.input.material_costs[cat].toFixed(2) + '$');
                        });
                    }
                    if (matParts.length) lines.push('  Mat: ' + matParts.join(', '));
                }
            });
            if (updateCount > 0) {
                lines.push('**' + updateCount + ' article(s) \u00e0 modifier :**');
                toolCalls.forEach(function(tc) {
                    if (tc.name === 'update_catalogue_item' && tc.input) {
                        var fields = tc.input.updates ? Object.keys(tc.input.updates).join(', ') : '';
                        lines.push('- **' + tc.input.code + '** \u2192 ' + fields);
                    }
                });
            }
            if (deleteCount > 0) {
                lines.push('**' + deleteCount + ' article(s) \u00e0 supprimer :**');
                toolCalls.forEach(function(tc) {
                    if (tc.name === 'delete_catalogue_item' && tc.input) {
                        lines.push('- **' + tc.input.code + '**');
                    }
                });
            }
            return lines.join('\n') || 'Action propos\u00e9e';
        }

        async function ciApplyPending(confirmId) {
            if (!ciPendingToolCalls) return;
            var confirmEl = document.getElementById(confirmId);
            var actionsDiv = confirmEl ? confirmEl.querySelector('.ci-confirm-actions') : null;
            if (actionsDiv) actionsDiv.innerHTML = '<span class="ci-confirm-applied">Ex\u00e9cution en cours...</span>';

            var results = [];
            for (var i = 0; i < ciPendingToolCalls.tools.length; i++) {
                var tc = ciPendingToolCalls.tools[i];
                var result = await executeCiTool(tc.name, tc.input);
                results.push(result);

                // Add tool_result to conversation for proper API flow
                ciConversation.push({ role: 'user', content: [{ type: 'tool_result', tool_use_id: tc.id, content: JSON.stringify(result) }] });
            }

            ciPendingToolCalls = null;

            // Build summary from results
            var parts = [];
            var totalErrors = 0;
            results.forEach(function(r) {
                if (r.errors && r.errors.length) totalErrors += r.errors.length;
                if (r.action === 'created') parts.push(r.code + ' cr\u00e9\u00e9');
                else if (r.action === 'updated') parts.push(r.code + ' modifi\u00e9');
                else if (r.action === 'deleted') parts.push(r.code + ' supprim\u00e9');
            });

            if (actionsDiv) {
                var msg = parts.join(', ') || (results.length + ' action(s)');
                if (totalErrors > 0) msg += ' \u2014 ' + totalErrors + ' erreur(s)';
                actionsDiv.innerHTML = '<span class="ci-confirm-applied">\u2713 ' + msg + '</span>';
            }

            // Refresh display
            generatePriceTables();
            updatePendingBadge();
        }

        async function executeCiTool(name, input) {
            var userEmail = (localStorage.getItem('sb_user_email') || '').toLowerCase();

            // ── CREATE ──
            if (name === 'create_catalogue_item') {
                try {
                    var maxSort = CATALOGUE_DATA.reduce(function(max, ci) { return Math.max(max, ci.sort_order || 0); }, 0);
                    var payload = {
                        id: input.code,
                        category: input.category,
                        description: input.description,
                        type: input.unit_type,
                        instruction: input.instruction || null,
                        client_text: input.client_text || null,
                        is_default: input.is_default || false,
                        has_sales_sheet: input.has_sales_sheet || false,
                        labor_minutes: input.labor_minutes || null,
                        material_costs: input.material_costs || null,
                        status: 'pending',
                        proposed_by: userEmail,
                        in_calculator: input.visible_calculator !== false,
                        sort_order: maxSort + 1
                    };

                    var resp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/catalogue_items', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                        body: JSON.stringify(payload)
                    });

                    if (!resp.ok) throw new Error(await resp.text());

                    var createdItems = await resp.json();
                    var createdItem = Array.isArray(createdItems) ? createdItems[0] : createdItems;
                    CATALOGUE_DATA.push(createdItem);

                    // Insert supplier components if provided
                    if (input.supplier_components && input.supplier_components.length > 0) {
                        for (var sc = 0; sc < input.supplier_components.length; sc++) {
                            var comp = input.supplier_components[sc];
                            await authenticatedFetch(SUPABASE_URL + '/rest/v1/catalogue_item_components', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    catalogue_item_id: input.code,
                                    supplier_name: comp.supplier_name || null,
                                    supplier_sku: comp.supplier_sku || null,
                                    unit_cost: comp.cost || 0,
                                    expense_category: comp.category || null,
                                    sort_order: sc
                                })
                            });
                        }
                    }

                    return { success: true, action: 'created', code: input.code, errors: [], message: input.code + ' cr\u00e9\u00e9' };
                } catch (e) {
                    return { success: false, action: 'created', code: input.code, errors: [{ id: input.code, error: e.message }], message: 'Erreur: ' + e.message };
                }
            }

            // ── UPDATE ──
            if (name === 'update_catalogue_item') {
                try {
                    var updates = input.updates || {};
                    var patchPayload = {};
                    if (updates.description !== undefined) patchPayload.description = updates.description;
                    if (updates.category !== undefined) patchPayload.category = updates.category;
                    if (updates.unit_type !== undefined) patchPayload.type = updates.unit_type;
                    if (updates.instruction !== undefined) patchPayload.instruction = updates.instruction;
                    if (updates.client_text !== undefined) patchPayload.client_text = updates.client_text;
                    if (updates.is_default !== undefined) patchPayload.is_default = updates.is_default;
                    if (updates.visible_calculator !== undefined) patchPayload.in_calculator = updates.visible_calculator;
                    if (updates.labor_minutes !== undefined) patchPayload.labor_minutes = updates.labor_minutes;
                    if (updates.material_costs !== undefined) patchPayload.material_costs = updates.material_costs;

                    var resp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/catalogue_items?id=eq.' + encodeURIComponent(input.code), {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                        body: JSON.stringify(patchPayload)
                    });

                    if (!resp.ok) throw new Error(await resp.text());

                    var updatedItems = await resp.json();
                    var updatedItem = Array.isArray(updatedItems) ? updatedItems[0] : updatedItems;

                    // Update local data
                    for (var idx = 0; idx < CATALOGUE_DATA.length; idx++) {
                        if (CATALOGUE_DATA[idx].id === input.code) {
                            CATALOGUE_DATA[idx] = updatedItem;
                            break;
                        }
                    }

                    return { success: true, action: 'updated', code: input.code, errors: [], message: input.code + ' modifi\u00e9' };
                } catch (e) {
                    return { success: false, action: 'updated', code: input.code, errors: [{ id: input.code, error: e.message }], message: 'Erreur: ' + e.message };
                }
            }

            // ── DELETE ──
            if (name === 'delete_catalogue_item') {
                try {
                    var resp = await authenticatedFetch(SUPABASE_URL + '/rest/v1/catalogue_items?id=eq.' + encodeURIComponent(input.code), {
                        method: 'DELETE'
                    });

                    if (!resp.ok) throw new Error(await resp.text());

                    // Remove from local data
                    CATALOGUE_DATA = CATALOGUE_DATA.filter(function(ci) { return ci.id !== input.code; });

                    return { success: true, action: 'deleted', code: input.code, errors: [], message: input.code + ' supprim\u00e9' };
                } catch (e) {
                    return { success: false, action: 'deleted', code: input.code, errors: [{ id: input.code, error: e.message }], message: 'Erreur: ' + e.message };
                }
            }

            return { success: false, errors: [], message: 'Outil inconnu: ' + name };
        }

        function ciDismissPending(confirmId) {
            ciPendingToolCalls = null;
            var confirmEl = document.getElementById(confirmId);
            if (confirmEl) {
                var actionsDiv = confirmEl.querySelector('.ci-confirm-actions');
                if (actionsDiv) actionsDiv.innerHTML = '<span style="font-size:11px;color:#999;">Ignor\u00e9</span>';
            }
        }

        // ═══ Pending filter ═══

        function togglePendingFilter() {
            filterPendingOnly = !filterPendingOnly;
            var btn = document.getElementById('filterPendingBtn');
            if (btn) btn.classList.toggle('pending-active', filterPendingOnly);
            generatePriceTables();
        }

        function updatePendingBadge() {
            var count = CATALOGUE_DATA.filter(function(i) { return i.status === 'pending'; }).length;
            var btn = document.getElementById('filterPendingBtn');
            if (btn) {
                btn.textContent = '\u25CF En attente' + (count > 0 ? ' (' + count + ')' : '');
                btn.style.display = canEditCatalogue ? '' : 'none';
            }
        }

        // ═══════════════════════════════════════════════════════════════════════
        // INITIALISATION
        // ═══════════════════════════════════════════════════════════════════════

        document.addEventListener('DOMContentLoaded', async function() {
            // Charger les permissions utilisateur + les tags médias
            await loadUserPermissions();
            await loadMediaTags();

            // Charger les données du catalogue depuis Supabase (ou cache/défaut)
            await loadCatalogueData();

            // Générer les tableaux avec les données chargées
            generatePriceTables();

            // Setup des handlers de la modal d'édition
            if (canEditCatalogue) {
                setupEditModalHandlers();
                document.getElementById('navAddWrap').style.display = '';
                document.getElementById('navImportBtn').style.display = '';
                document.getElementById('filterPendingBtn').style.display = '';
                setupImportDrawerHandlers();
                updatePendingBadge();
            }
        });
    </script>

<!-- Import Drawer (AI Chat) -->
<div class="ci-drawer-overlay" id="ciOverlay" onclick="closeImportDrawer()"></div>
<div class="ci-drawer" id="ciDrawer">
    <div class="ci-drawer-header">
        <h3>Importateur catalogue</h3>
        <button class="ci-drawer-close" onclick="closeImportDrawer()">&times;</button>
    </div>
    <div class="ci-messages" id="ciMessages"></div>
    <div class="ci-typing" id="ciTyping">
        <div class="ci-typing-dot"></div>
        <div class="ci-typing-dot"></div>
        <div class="ci-typing-dot"></div>
    </div>
    <div class="ci-quick-actions" id="ciQuickActions">
        <button class="ci-quick-btn" onclick="ciQuickAction('Voici un screenshot de ma liste de prix Excel')">Screenshot Excel</button>
        <button class="ci-quick-btn" onclick="ciQuickAction('Voici une liste de prix fournisseur')">Prix fournisseur</button>
        <button class="ci-quick-btn" onclick="ciQuickAction('Je veux ajouter ces articles :')">Liste manuelle</button>
    </div>
    <div class="ci-img-preview" id="ciImgPreview"></div>
    <div class="ci-input-area" style="position:relative;">
        <div class="ci-drop-zone" id="ciDropZone">D&eacute;posez une image ici</div>
        <textarea id="ciInput" placeholder="Collez un screenshot ou d&eacute;crivez les articles..." rows="1" onkeydown="ciInputKeydown(event)"></textarea>
        <button class="ci-send-btn" id="ciSendBtn" onclick="sendImportMessage()" title="Envoyer">&uarr;</button>
    </div>
</div>

</body>
</html>
