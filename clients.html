<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contacts &mdash; Scopewright</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="scopewright-tokens.css">
    <script>
        if (!localStorage.getItem('sb_access_token')) { window.location.href = 'login.html'; }
        else { document.documentElement.style.visibility = 'visible'; }
    </script>
    <style>html { visibility: hidden; }</style>
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; color: var(--sw-text); }
        .app-wrapper { display: flex; min-height: 100vh; flex-direction: column; }

        /* HEADER SCOPEWRIGHT STANDARD */
        .nav-bar { position: fixed; top: 0; left: 0; right: 0; height: 56px; background: var(--sw-surface); border-bottom: 1px solid var(--sw-border); padding: 0 60px; display: flex; align-items: center; gap: var(--sw-space-3); z-index: 100; }
        .nav-logo { font-size: 23px; font-weight: 650; letter-spacing: -0.025em; line-height: 1; color: var(--sw-navy); text-decoration: none; }
        .nav-back { color: var(--sw-text); text-decoration: none; font-size: 13px; font-weight: 400; opacity: 0.45; transition: opacity var(--sw-ease); white-space: nowrap; }
        .nav-back:hover { opacity: 0.8; }
        .data-status { display: flex; align-items: center; gap: 8px; font-size: 12px; padding: 6px 12px; border-radius: 20px; background: #f5f5f5; }
        .data-status.online { background: #e8f5e9; color: #2e7d32; }
        .data-status.offline { background: #fff3e0; color: #ef6c00; }
        .data-status.error { background: #ffebee; color: #c62828; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; }
        .data-status.online .status-dot { background: #4caf50; }
        .data-status.offline .status-dot { background: #ff9800; }
        .data-status.error .status-dot { background: #f44336; }
        .status-text { white-space: nowrap; }

        /* Content */
        .app-content { flex: 1; padding: 40px; padding-top: 96px; max-width: 1100px; margin: 0 auto; width: 100%; }
        .page-title { font-size: 24px; font-weight: 700; margin-bottom: 8px; }
        .page-sub { font-size: 14px; color: #666; margin-bottom: 24px; }
        .app-footer { padding: 20px 40px; text-align: center; font-size: 11px; color: #999; border-top: 1px solid #e0e0e0; }

        /* Tabs */
        .tabs { display: flex; gap: 0; border-bottom: 2px solid #e0e0e0; margin-bottom: 24px; }
        .tab { padding: 10px 24px; font-size: 14px; font-weight: 600; color: #888; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px; transition: all 0.15s; background: none; border-top: none; border-left: none; border-right: none; font-family: inherit; }
        .tab:hover { color: #555; }
        .tab.active { color: var(--sw-navy); border-bottom-color: var(--sw-navy); }

        /* Toolbar */
        .toolbar { display: flex; gap: 12px; margin-bottom: 20px; align-items: center; }
        .search-input { flex: 1; padding: 10px 14px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 14px; font-family: inherit; }
        .search-input:focus { outline: none; border-color: var(--sw-navy); }
        .btn-primary { background: var(--sw-navy); color: #fff; border: none; padding: 10px 20px; font-size: 13px; font-weight: 600; cursor: pointer; border-radius: 6px; font-family: inherit; transition: opacity 0.15s; white-space: nowrap; }
        .btn-primary:hover { opacity: 0.9; }

        /* Card grid */
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; }
        .card { background: #f9f9f9; border: 1px solid #e8e8e8; border-radius: 8px; padding: 18px 20px; cursor: pointer; transition: all 0.15s; }
        .card:hover { border-color: #ccc; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
        .card-name { font-size: 15px; font-weight: 700; margin-bottom: 4px; }
        .card-meta { font-size: 12px; color: #888; line-height: 1.5; }
        .card-badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 600; background: #e8ecf3; color: var(--sw-navy); margin-top: 6px; }
        .card-companies { margin-top: 8px; display: flex; flex-wrap: wrap; gap: 4px; }
        .empty-state { text-align: center; padding: 40px 20px; color: #aaa; font-size: 14px; }

        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 200; align-items: flex-start; justify-content: center; padding-top: 60px; overflow-y: auto; }
        .modal-overlay.active { display: flex; }
        .modal { background: #fff; border-radius: 10px; width: 100%; max-width: 600px; box-shadow: 0 12px 40px rgba(0,0,0,0.15); margin-bottom: 40px; }
        .modal-header { padding: 20px 24px 0; }
        .modal-title { font-size: 18px; font-weight: 700; }
        .modal-body { padding: 16px 24px; }
        .modal-footer { padding: 16px 24px; display: flex; gap: 10px; justify-content: flex-end; border-top: 1px solid #f0f0f0; }

        .form-group { margin-bottom: 14px; }
        .form-label { display: block; font-size: 12px; font-weight: 600; color: #666; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.3px; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 9px 12px; border: 1px solid #e0e0e0; border-radius: 5px; font-size: 14px; font-family: inherit; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--sw-navy); }
        .form-select { background: #fff; cursor: pointer; }
        .form-textarea { resize: vertical; min-height: 60px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        .btn-modal-save { background: var(--sw-navy); color: #fff; border: none; padding: 9px 22px; font-size: 13px; font-weight: 600; cursor: pointer; border-radius: 5px; font-family: inherit; }
        .btn-modal-save:hover { opacity: 0.9; }
        .btn-modal-cancel { background: none; border: 1px solid #ddd; color: #666; padding: 9px 18px; font-size: 13px; cursor: pointer; border-radius: 5px; font-family: inherit; }
        .btn-modal-cancel:hover { background: #f5f5f5; }
        .btn-modal-danger { background: #c0392b; color: #fff; border: none; padding: 9px 18px; font-size: 13px; font-weight: 600; cursor: pointer; border-radius: 5px; font-family: inherit; margin-right: auto; }
        .btn-modal-danger:hover { opacity: 0.9; }

        /* Sub-sections in modal */
        .modal-section { margin-top: 16px; padding-top: 14px; border-top: 1px solid #f0f0f0; }
        .modal-section-title { font-size: 13px; font-weight: 700; color: #555; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; }
        .btn-small { background: none; border: 1px dashed #ccc; color: #888; padding: 4px 12px; font-size: 11px; cursor: pointer; border-radius: 4px; font-family: inherit; }
        .btn-small:hover { border-color: var(--sw-navy); color: var(--sw-navy); }

        .link-row { display: flex; align-items: center; gap: 8px; padding: 6px 0; border-bottom: 1px solid #f5f5f5; font-size: 13px; }
        .link-row:last-child { border-bottom: none; }
        .link-name { font-weight: 600; flex: 1; }
        .link-clickable { color: var(--sw-navy); text-decoration: none; cursor: pointer; }
        .link-clickable:hover { text-decoration: underline; }
        .link-role { color: #888; font-size: 12px; }
        .link-primary { background: var(--sw-navy); color: #fff; font-size: 9px; padding: 1px 6px; border-radius: 8px; font-weight: 600; }
        .link-remove { background: none; border: none; color: #ccc; font-size: 16px; cursor: pointer; padding: 2px 6px; }
        .link-remove:hover { color: #c0392b; }

        .comm-row { padding: 8px 0; border-bottom: 1px solid #f5f5f5; font-size: 13px; }
        .comm-row:last-child { border-bottom: none; }
        .comm-header { display: flex; align-items: center; gap: 8px; margin-bottom: 2px; }
        .comm-type-badge { font-size: 10px; font-weight: 600; padding: 1px 8px; border-radius: 8px; background: #e3f2fd; color: #1565c0; }
        .comm-direction { font-size: 10px; color: #999; }
        .comm-date { font-size: 11px; color: #999; margin-left: auto; }
        .comm-subject { font-weight: 600; }
        .comm-content { color: #666; font-size: 12px; margin-top: 2px; }

        .modal-status { font-size: 13px; margin-top: 8px; }
        .modal-status.success { color: var(--sw-navy); }
        .modal-status.error { color: #c0392b; }

        @media (max-width: 768px) {
            .nav-bar { padding: 0 20px; gap: 16px; }
            .app-content { padding: 24px 16px; padding-top: 80px; }
            .card-grid { grid-template-columns: 1fr; }
            .form-row { grid-template-columns: 1fr; }
        }

        .ct-ai-filter-badge {
            padding: 6px 16px; background: #EEF2FF; color: #3B5998;
            font-size: 12px; font-weight: 500; border-radius: 0 0 8px 8px;
            cursor: pointer; text-align: center; transition: background 0.15s;
        }
        .ct-ai-filter-badge:hover { background: #DBEAFE; }
        @keyframes ctCardFadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .ct-card-animate { animation: ctCardFadeIn 200ms ease-out both; }

        /* ═══ AI Chat Drawer ═══ */
        @keyframes ctMsgFadeIn {
            from { opacity: 0; transform: translateY(6px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .ct-drawer-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: transparent; z-index: 8700; pointer-events: none;
        }
        .ct-drawer-overlay.active { display: block; }
        .ct-drawer {
            position: fixed; top: 0; right: -460px; width: 440px; height: 100%;
            background: #fff; box-shadow: -2px 0 24px rgba(0,0,0,0.08);
            z-index: 8800; transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex; flex-direction: column;
        }
        .ct-drawer.active { right: 0; }
        .ct-drawer-header {
            display: flex; align-items: center; gap: 10px;
            padding: 16px 20px; border-bottom: 1px solid #f0f0f0;
            background: #fff; flex-shrink: 0;
        }
        .ct-drawer-header h3 {
            font-size: 14px; font-weight: 600; margin: 0;
            color: #1A1A2E; flex: 1; letter-spacing: -0.01em;
        }
        .ct-drawer-close {
            background: none; border: none; font-size: 18px;
            cursor: pointer; color: #9ca3af; padding: 2px 4px;
            transition: color 0.15s; border-radius: 6px;
        }
        .ct-drawer-close:hover { color: #1A1A2E; }
        .ct-messages {
            flex: 1; min-height: 0; overflow-y: auto; padding: 20px;
            display: flex; flex-direction: column; gap: 16px;
            overscroll-behavior: contain;
            scrollbar-width: thin; scrollbar-color: #e5e7eb transparent;
        }
        .ct-messages::before { content: ''; flex: 1 1 0; }
        .ct-messages::-webkit-scrollbar { width: 5px; }
        .ct-messages::-webkit-scrollbar-track { background: transparent; }
        .ct-messages::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 3px; }
        .ct-messages::-webkit-scrollbar-thumb:hover { background: #d1d5db; }
        .ct-messages:empty::after {
            content: 'Collez un screenshot de contacts, une carte d\27 affaires, ou d\e9 crivez les contacts \e0 importer.';
            color: #9ca3af; font-size: 13px; text-align: center; padding: 40px 24px;
            line-height: 1.6;
        }
        .ct-msg {
            max-width: 85%; padding: 0; border-radius: 0;
            font-size: 14px; line-height: 1.5; word-wrap: break-word;
            color: #1A1A2E; animation: ctMsgFadeIn 180ms ease-out both;
        }
        .ct-msg p { margin: 0 0 8px 0; }
        .ct-msg p:last-child { margin-bottom: 0; }
        .ct-msg ul, .ct-msg ol { margin: 6px 0; padding-left: 20px; }
        .ct-msg li { margin-bottom: 4px; }
        .ct-msg strong { font-weight: 600; }
        .ct-msg code {
            background: #f3f4f6; padding: 2px 6px; border-radius: 4px;
            font-size: 13px; font-family: 'SF Mono', 'Cascadia Code', 'Consolas', monospace;
        }
        .ct-msg pre {
            background: #f8f9fa; padding: 12px 14px; border-radius: 8px;
            overflow-x: auto; font-size: 12px; margin: 8px 0;
            font-family: 'SF Mono', 'Cascadia Code', 'Consolas', monospace;
            line-height: 1.5;
        }
        .ct-msg table {
            width: 100%; border-collapse: separate; border-spacing: 0;
            margin: 8px 0; font-size: 13px; border-radius: 8px;
            overflow: hidden; background: #F8FAFC;
        }
        .ct-msg th, .ct-msg td {
            padding: 8px 12px; border: none; text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }
        .ct-msg th {
            background: #f1f5f9; font-weight: 600; font-size: 11px;
            color: #6B7280; text-transform: uppercase; letter-spacing: 0.04em;
        }
        .ct-msg tr:last-child td { border-bottom: none; }
        .ct-msg-user {
            align-self: flex-end; background: #F1F5F9;
            padding: 10px 14px; border-radius: 12px; border-bottom-right-radius: 4px;
        }
        .ct-msg-assistant { align-self: flex-start; background: transparent; padding: 2px 0; }
        .ct-msg-confirm {
            align-self: flex-start; background: #fff; border: none;
            border-radius: 12px; padding: 14px 16px; max-width: 92%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 0 0 1px rgba(0,0,0,0.04);
        }
        .ct-msg-confirm .ct-confirm-text {
            font-size: 14px; color: #1A1A2E; margin-bottom: 12px; line-height: 1.5;
        }
        .ct-confirm-actions { display: flex; gap: 8px; align-items: center; }
        .ct-confirm-actions button {
            padding: 8px 18px; border-radius: 8px; font-size: 13px; font-weight: 600;
            cursor: pointer; border: none; transition: all 0.15s;
        }
        .btn-ct-apply { background: var(--sw-navy); color: #fff; }
        .btn-ct-apply:hover { background: #15223b; }
        .btn-ct-dismiss { background: transparent; color: #6B7280; padding: 8px 12px; }
        .btn-ct-dismiss:hover { color: #1A1A2E; }
        .ct-confirm-applied { font-size: 12px; color: var(--sw-navy); font-weight: 500; }
        .ct-typing { padding: 10px 20px; display: none; flex-shrink: 0; }
        .ct-typing.active { display: flex; gap: 6px; align-items: center; }
        .ct-typing-dot {
            width: 8px; height: 8px; border-radius: 50%; background: var(--sw-navy);
            animation: ctTypingBounce 1.4s ease-in-out infinite;
        }
        .ct-typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .ct-typing-dot:nth-child(3) { animation-delay: 0.3s; }
        @keyframes ctTypingBounce {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.25; }
            30% { transform: translateY(-4px); opacity: 0.9; }
        }
        .ct-quick-actions {
            display: flex; gap: 6px; padding: 10px 20px; flex-wrap: wrap;
            border-top: 1px solid #f5f5f5; flex-shrink: 0;
        }
        .ct-quick-btn {
            padding: 6px 12px; border-radius: 8px; font-size: 12px;
            background: #fff; border: 1px solid #e5e7eb; color: #6B7280;
            cursor: pointer; transition: all 0.15s; white-space: nowrap; font-weight: 500;
        }
        .ct-quick-btn:hover { background: #f9fafb; border-color: #d1d5db; color: #374151; }
        .ct-input-area {
            display: flex; gap: 8px; padding: 12px 16px 14px;
            border-top: 1px solid #f0f0f0;
            background: #fff; flex-shrink: 0; align-items: flex-end;
        }
        .ct-input-area textarea {
            flex: 1; resize: none; border: 1px solid #e5e7eb; border-radius: 10px;
            padding: 10px 14px; font-size: 14px; font-family: inherit; line-height: 1.4;
            max-height: 120px; min-height: 40px; outline: none;
            transition: border-color 0.15s; background: #fafbfc; color: #1A1A2E;
        }
        .ct-input-area textarea:focus { border-color: #d1d5db; background: #fff; }
        .ct-input-area textarea::placeholder { color: #9ca3af; }
        .ct-send-btn {
            width: 36px; height: 36px; border-radius: 10px; border: none;
            background: var(--sw-navy); color: #fff; font-size: 16px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: background 0.15s; flex-shrink: 0;
        }
        .ct-send-btn:hover { background: #15223b; }
        .ct-send-btn:disabled { background: #e5e7eb; color: #9ca3af; cursor: default; }
        .ct-drop-zone {
            display: none; position: absolute; inset: 0; background: rgba(11,18,32,0.04);
            border: 2px dashed #d1d5db; border-radius: 10px;
            z-index: 10; align-items: center; justify-content: center;
            font-size: 13px; color: #6B7280; font-weight: 500;
        }
        .ct-drop-zone.active { display: flex; }
        .ct-img-preview {
            display: flex; gap: 6px; padding: 6px 20px; flex-wrap: wrap; flex-shrink: 0;
        }
        .ct-img-preview:empty { display: none; }
        .ct-img-thumb {
            position: relative; width: 52px; height: 52px; border-radius: 8px;
            overflow: hidden; border: 1px solid #e5e7eb;
        }
        .ct-img-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .ct-img-thumb .ct-img-remove {
            position: absolute; top: 2px; right: 2px; width: 18px; height: 18px;
            border-radius: 50%; background: rgba(0,0,0,0.5); color: #fff;
            border: none; font-size: 11px; cursor: pointer; display: flex;
            align-items: center; justify-content: center; line-height: 1;
            transition: background 0.15s;
        }
        .ct-img-thumb .ct-img-remove:hover { background: rgba(0,0,0,0.7); }
        .ai-assistant-btn { vertical-align: middle; }
        @media (max-width: 600px) {
            .ct-drawer { width: 100%; right: -100%; }
        }
    </style>
</head>
<body>
    <div class="app-wrapper">
        <nav class="nav-bar">
            <span class="nav-logo">scopewright</span>
            <a href="app.html" class="nav-back">&larr; Menu</a>
            <div class="nav-right">
                <button class="ai-assistant-btn" id="navAssistantBtn" title="Assistant Scopewright" onclick="toggleCtDrawer()"></button>
                <div class="data-status" id="dataStatus">
                    <span class="status-dot"></span>
                    <span class="status-text" id="statusText">Chargement...</span>
                </div>
            </div>
        </nav>

        <main class="app-content">
            <div class="page-title">Contacts</div>
            <div class="page-sub">G&eacute;rez vos contacts, entreprises et communications.</div>

            <div class="tabs">
                <button class="tab active" id="tabContacts" onclick="switchTab('contacts')">Contacts</button>
                <button class="tab" id="tabCompanies" onclick="switchTab('companies')">Entreprises</button>
            </div>
            <div class="ct-ai-filter-badge" id="ctAiFilterBadge" style="display:none;" onclick="resetCtAiFilter()">Filtre AI actif &mdash; Tout afficher</div>

            <!-- Contacts view -->
            <div id="viewContacts">
                <div class="toolbar">
                    <input type="text" class="search-input" id="searchContacts" placeholder="Rechercher un contact..." oninput="renderContacts()">
                    <button class="btn-primary" onclick="openContactModal()">+ Nouveau contact</button>
                </div>
                <div class="card-grid" id="contactGrid"></div>
                <div class="empty-state" id="contactEmpty" style="display:none;">Aucun contact. Cliquez sur &laquo; + Nouveau contact &raquo; pour commencer.</div>
            </div>

            <!-- Companies view -->
            <div id="viewCompanies" style="display:none;">
                <div class="toolbar">
                    <input type="text" class="search-input" id="searchCompanies" placeholder="Rechercher une entreprise..." oninput="renderCompanies()">
                    <button class="btn-primary" onclick="openCompanyModal()">+ Nouvelle entreprise</button>
                </div>
                <div class="card-grid" id="companyGrid"></div>
                <div class="empty-state" id="companyEmpty" style="display:none;">Aucune entreprise. Cliquez sur &laquo; + Nouvelle entreprise &raquo; pour commencer.</div>
            </div>
        </main>

        <footer class="app-footer">stele &mdash; stele.ca</footer>
    </div>

    <!-- Contact modal -->
    <div class="modal-overlay" id="contactModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="contactModalTitle">Nouveau contact</div>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Pr&eacute;nom</label>
                        <input type="text" class="form-input" id="cFirstName">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nom</label>
                        <input type="text" class="form-input" id="cLastName">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Courriel personnel</label>
                        <input type="email" class="form-input" id="cEmail">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Cellulaire</label>
                        <input type="tel" class="form-input" id="cPhone">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Adresse personnelle</label>
                    <input type="text" class="form-input" id="cAddress">
                </div>
                <div class="form-group">
                    <label class="form-label">M&eacute;thode de contact pr&eacute;f&eacute;r&eacute;e</label>
                    <select class="form-select" id="cPreferred">
                        <option value="email">Courriel</option>
                        <option value="phone">T&eacute;l&eacute;phone</option>
                        <option value="text">Texto</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-textarea" id="cNotes" rows="2"></textarea>
                </div>

                <!-- Company links -->
                <div class="modal-section" id="contactLinksSection" style="display:none;">
                    <div class="modal-section-title">
                        <span>Entreprises li&eacute;es</span>
                        <button class="btn-small" onclick="openLinkModal()">+ Lier</button>
                    </div>
                    <div id="contactLinksList"></div>
                </div>

                <!-- Communications -->
                <div class="modal-section" id="contactCommsSection" style="display:none;">
                    <div class="modal-section-title">
                        <span>Communications</span>
                        <button class="btn-small" onclick="openCommModal()">+ Ajouter</button>
                    </div>
                    <div id="contactCommsList"></div>
                </div>

                <div class="modal-status" id="contactModalStatus"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal-danger" id="btnDeleteContact" style="display:none;" onclick="deleteContact()">Supprimer</button>
                <button class="btn-modal-cancel" onclick="closeContactModal()">Fermer</button>
                <button class="btn-modal-save" onclick="saveContact()">Sauvegarder</button>
            </div>
        </div>
    </div>

    <!-- Company modal -->
    <div class="modal-overlay" id="companyModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="companyModalTitle">Nouvelle entreprise</div>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Nom de l'entreprise</label>
                        <input type="text" class="form-input" id="coName">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Type</label>
                        <input type="text" class="form-input" id="coType" list="coTypeOptions" placeholder="S&eacute;lectionner ou taper..." oninput="updateTypeFields()">
                        <datalist id="coTypeOptions"></datalist>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Adresse</label>
                    <input type="text" class="form-input" id="coAddress">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">T&eacute;l&eacute;phone</label>
                        <input type="tel" class="form-input" id="coPhone">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Courriel</label>
                        <input type="email" class="form-input" id="coEmail">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Site web</label>
                    <input type="text" class="form-input" id="coWebsite">
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-textarea" id="coNotes" rows="2"></textarea>
                </div>

                <div id="coExtraFields"></div>

                <!-- Contact links -->
                <div class="modal-section" id="companyLinksSection" style="display:none;">
                    <div class="modal-section-title">
                        <span>Contacts li&eacute;s</span>
                        <button class="btn-small" onclick="openLinkModalFromCompany()">+ Lier</button>
                    </div>
                    <div id="companyLinksList"></div>
                </div>

                <div class="modal-status" id="companyModalStatus"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal-danger" id="btnDeleteCompany" style="display:none;" onclick="deleteCompany()">Supprimer</button>
                <button class="btn-modal-cancel" onclick="closeCompanyModal()">Fermer</button>
                <button class="btn-modal-save" onclick="saveCompany()">Sauvegarder</button>
            </div>
        </div>
    </div>

    <!-- Link modal (contact → company) -->
    <div class="modal-overlay" id="linkModal">
        <div class="modal" style="max-width:440px;">
            <div class="modal-header">
                <div class="modal-title">Lier &agrave; une entreprise</div>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Entreprise</label>
                    <select class="form-select" id="linkCompanySelect"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">R&ocirc;le</label>
                    <select class="form-select" id="linkRole"></select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Courriel pro</label>
                        <input type="email" class="form-input" id="linkWorkEmail">
                    </div>
                    <div class="form-group">
                        <label class="form-label">T&eacute;l&eacute;phone pro</label>
                        <input type="tel" class="form-input" id="linkWorkPhone">
                    </div>
                </div>
                <div class="form-group">
                    <label style="font-size:13px; cursor:pointer;">
                        <input type="checkbox" id="linkPrimary"> Contact principal de l'entreprise
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal-cancel" onclick="closeLinkModal()">Annuler</button>
                <button class="btn-modal-save" onclick="saveLink()">Lier</button>
            </div>
        </div>
    </div>

    <!-- Link modal (company → contact) -->
    <div class="modal-overlay" id="linkModalFromCompany">
        <div class="modal" style="max-width:440px;">
            <div class="modal-header">
                <div class="modal-title">Lier un contact</div>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Contact</label>
                    <select class="form-select" id="linkContactSelect"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">R&ocirc;le</label>
                    <select class="form-select" id="linkRole2"></select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Courriel pro</label>
                        <input type="email" class="form-input" id="linkWorkEmail2">
                    </div>
                    <div class="form-group">
                        <label class="form-label">T&eacute;l&eacute;phone pro</label>
                        <input type="tel" class="form-input" id="linkWorkPhone2">
                    </div>
                </div>
                <div class="form-group">
                    <label style="font-size:13px; cursor:pointer;">
                        <input type="checkbox" id="linkPrimary2"> Contact principal de l'entreprise
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal-cancel" onclick="closeLinkModalFromCompany()">Annuler</button>
                <button class="btn-modal-save" onclick="saveLinkFromCompany()">Lier</button>
            </div>
        </div>
    </div>

    <!-- Modal générique (confirm / alert) -->
    <div class="modal-overlay" id="steleDialogOverlay">
        <div class="modal" style="max-width:440px;">
            <div class="modal-header">
                <div class="modal-title" id="steleDialogTitle"></div>
            </div>
            <div class="modal-body">
                <p id="steleDialogMessage" style="font-size:14px; color:#444; margin-bottom:12px;"></p>
            </div>
            <div class="modal-footer">
                <button class="btn-modal-cancel" id="steleDialogCancel" onclick="steleDialogResolve(null)" style="display:none;">Annuler</button>
                <button class="btn-modal-save" id="steleDialogOk" onclick="steleDialogResolve(true)">OK</button>
            </div>
        </div>
    </div>

    <!-- Communication modal -->
    <div class="modal-overlay" id="commModal">
        <div class="modal" style="max-width:480px;">
            <div class="modal-header">
                <div class="modal-title">Nouvelle communication</div>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Type</label>
                        <select class="form-select" id="commType"></select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Direction</label>
                        <select class="form-select" id="commDirection">
                            <option value="outbound">Sortant</option>
                            <option value="inbound">Entrant</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Objet</label>
                    <input type="text" class="form-input" id="commSubject">
                </div>
                <div class="form-group">
                    <label class="form-label">D&eacute;tails</label>
                    <textarea class="form-textarea" id="commContent" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Date</label>
                    <input type="datetime-local" class="form-input" id="commDate">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal-cancel" onclick="closeCommModal()">Annuler</button>
                <button class="btn-modal-save" onclick="saveComm()">Sauvegarder</button>
            </div>
        </div>
    </div>

    <script>
    var SUPABASE_URL = 'https://rplzbtjfnwahqodrhpny.supabase.co';
    var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJwbHpidGpmbndhaHFvZHJocG55Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NDU2MDEsImV4cCI6MjA4NjIyMTYwMX0.OQAZhc029PbRDSe1b02NDAuOUE8yn-_h3QqSnUDpLeU';

    // ═══════════════════════════════════════════════════════════════
    // AUTH
    // ═══════════════════════════════════════════════════════════════

    async function refreshAccessToken() {
        var rt = localStorage.getItem('sb_refresh_token');
        if (!rt) return false;
        try {
            var r = await fetch(SUPABASE_URL + '/auth/v1/token?grant_type=refresh_token', {
                method: 'POST', headers: { 'Content-Type': 'application/json', 'apikey': SUPABASE_KEY },
                body: JSON.stringify({ refresh_token: rt })
            });
            if (!r.ok) return false;
            var d = await r.json();
            if (d.access_token) { localStorage.setItem('sb_access_token', d.access_token); localStorage.setItem('sb_refresh_token', d.refresh_token); return true; }
            return false;
        } catch (e) { return false; }
    }

    async function authenticatedFetch(url, options) {
        var tok = localStorage.getItem('sb_access_token');
        var h = Object.assign({}, options.headers || {}, { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + tok });
        var resp = await fetch(url, Object.assign({}, options, { headers: h }));
        if (resp.status === 401) {
            if (await refreshAccessToken()) {
                h['Authorization'] = 'Bearer ' + localStorage.getItem('sb_access_token');
                resp = await fetch(url, Object.assign({}, options, { headers: h }));
            } else { window.location.href = 'login.html'; }
        }
        return resp;
    }

    function updateStatus(status, message) {
        var statusEl = document.getElementById('dataStatus');
        var textEl = document.getElementById('statusText');
        statusEl.className = 'data-status ' + status;
        textEl.textContent = message;
    }

    function escapeHtml(s) { var d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }

    // ═══════════════════════════════════════════════════════════════
    // STATE
    // ═══════════════════════════════════════════════════════════════

    var allContacts = [];
    var allCompanies = [];
    var currentContactId = null;
    var currentCompanyId = null;
    var currentCompanyExtraData = {};
    var configCompanyTypes = ['Designer', 'Architecte', 'Entrepreneur', 'Promoteur', 'Particulier', 'Autre'];
    var configContactRoles = ['Propri\u00e9taire', 'Designer principal', 'Architecte', 'Charg\u00e9 de projet', 'Adjoint(e)', 'Comptabilit\u00e9', 'Autre'];
    var configCommTypes = ['Appel', 'Courriel', 'Texto', 'Rencontre', 'Note'];
    var ctAiFilterActive = false;
    var ctAiFilterCompanyType = null;

    var _steleDialogResolve = null;
    function steleDialogResolve(val) {
        document.getElementById('steleDialogOverlay').classList.remove('active');
        if (_steleDialogResolve) { var fn = _steleDialogResolve; _steleDialogResolve = null; fn(val); }
    }
    function steleConfirm(msg, title, okLabel, danger) {
        return new Promise(function(resolve) {
            _steleDialogResolve = resolve;
            document.getElementById('steleDialogTitle').textContent = title || 'Confirmation';
            document.getElementById('steleDialogMessage').textContent = msg;
            document.getElementById('steleDialogCancel').style.display = '';
            document.getElementById('steleDialogOk').textContent = okLabel || 'Confirmer';
            if (danger) document.getElementById('steleDialogOk').style.cssText = 'background:#c0392b; color:#fff; border:none; padding:9px 22px; font-size:13px; font-weight:600; cursor:pointer; border-radius:5px;';
            else document.getElementById('steleDialogOk').style.cssText = '';
            document.getElementById('steleDialogOverlay').classList.add('active');
        });
    }

    var TYPE_EXTRA_FIELDS = {
        'Designer': [
            { key: 'specialite', label: 'Sp\u00e9cialit\u00e9', type: 'text' },
            { key: 'portfolio', label: 'Portfolio / Site cr\u00e9atif', type: 'url' }
        ],
        'Architecte': [
            { key: 'numero_oaq', label: 'N\u00b0 OAQ', type: 'text' },
            { key: 'specialite', label: 'Sp\u00e9cialit\u00e9', type: 'text' }
        ],
        'Entrepreneur': [
            { key: 'licence_rbq', label: 'Licence RBQ', type: 'text' },
            { key: 'specialite', label: 'Sp\u00e9cialit\u00e9', type: 'text' }
        ],
        'Promoteur': [
            { key: 'type_projets', label: 'Type de projets', type: 'text' }
        ],
        'Particulier': [],
        'Autre': []
    };

    function updateTypeFields() {
        var container = document.getElementById('coExtraFields');
        var type = document.getElementById('coType').value.trim();
        var fields = TYPE_EXTRA_FIELDS[type];
        if (!fields || fields.length === 0) { container.innerHTML = ''; return; }
        var html = '<div class="modal-section" style="margin-top:10px; padding-top:10px;">';
        html += '<div class="modal-section-title"><span>D\u00e9tails \u2014 ' + escapeHtml(type) + '</span></div>';
        html += '<div class="form-row">';
        for (var i = 0; i < fields.length; i++) {
            var f = fields[i];
            var val = (currentCompanyExtraData && currentCompanyExtraData[f.key]) || '';
            html += '<div class="form-group">';
            html += '<label class="form-label">' + escapeHtml(f.label) + '</label>';
            html += '<input type="' + f.type + '" class="form-input extra-field" data-key="' + escapeHtml(f.key) + '" value="' + escapeHtml(val) + '">';
            html += '</div>';
        }
        html += '</div></div>';
        container.innerHTML = html;
    }

    // ═══════════════════════════════════════════════════════════════
    // TABS
    // ═══════════════════════════════════════════════════════════════

    function switchTab(tab) {
        document.getElementById('tabContacts').className = 'tab' + (tab === 'contacts' ? ' active' : '');
        document.getElementById('tabCompanies').className = 'tab' + (tab === 'companies' ? ' active' : '');
        document.getElementById('viewContacts').style.display = tab === 'contacts' ? '' : 'none';
        document.getElementById('viewCompanies').style.display = tab === 'companies' ? '' : 'none';
    }

    // ═══════════════════════════════════════════════════════════════
    // LOAD DATA
    // ═══════════════════════════════════════════════════════════════

    async function loadContacts() {
        var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/contacts?order=last_name,first_name&select=*,contact_companies(id,company_id,role,work_email,work_phone,is_primary_contact,companies(name))', {});
        if (r.ok) allContacts = await r.json();
    }

    async function loadCompanies() {
        var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/companies?order=name&select=*,contact_companies(id,contact_id,role,work_email,work_phone,is_primary_contact,contacts(first_name,last_name))', {});
        if (r.ok) allCompanies = await r.json();
    }

    async function loadConfig() {
        try {
            var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/app_config?key=in.(company_types,contact_roles,communication_types)&select=key,value', {});
            if (r.ok) {
                var rows = await r.json();
                for (var i = 0; i < rows.length; i++) {
                    if (rows[i].key === 'company_types') configCompanyTypes = rows[i].value;
                    if (rows[i].key === 'contact_roles') configContactRoles = rows[i].value;
                    if (rows[i].key === 'communication_types') configCommTypes = rows[i].value;
                }
            }
        } catch (e) { /* use defaults */ }
    }

    // ═══════════════════════════════════════════════════════════════
    // RENDER CONTACTS
    // ═══════════════════════════════════════════════════════════════

    function renderContacts() {
        var grid = document.getElementById('contactGrid');
        var empty = document.getElementById('contactEmpty');
        var query = (document.getElementById('searchContacts').value || '').toLowerCase().trim();

        var filtered = allContacts.filter(function(c) {
            if (!query) return true;
            var full = (c.first_name + ' ' + c.last_name + ' ' + (c.email || '') + ' ' + (c.phone || '')).toLowerCase();
            return full.indexOf(query) !== -1;
        });

        if (filtered.length === 0) {
            grid.innerHTML = '';
            empty.style.display = '';
            return;
        }
        empty.style.display = 'none';

        var html = '';
        for (var i = 0; i < filtered.length; i++) {
            var c = filtered[i];
            var companies = (c.contact_companies || []).map(function(cc) {
                return '<span class="card-badge">' + escapeHtml(cc.companies ? cc.companies.name : '?') + '</span>';
            }).join('');
            html += '<div class="card" onclick="openContactModal(\'' + c.id + '\')">' +
                '<div class="card-name">' + escapeHtml(c.first_name + ' ' + c.last_name) + '</div>' +
                '<div class="card-meta">' +
                    (c.email ? escapeHtml(c.email) + '<br>' : '') +
                    (c.phone ? escapeHtml(c.phone) : '') +
                '</div>' +
                (companies ? '<div class="card-companies">' + companies + '</div>' : '') +
                '</div>';
        }
        grid.innerHTML = html;
        if (ctAiFilterActive) {
            var cards = grid.querySelectorAll('.card');
            cards.forEach(function(card, i) { card.classList.add('ct-card-animate'); card.style.animationDelay = Math.min(i * 30, 300) + 'ms'; });
        }
    }

    // ═══════════════════════════════════════════════════════════════
    // RENDER COMPANIES
    // ═══════════════════════════════════════════════════════════════

    function renderCompanies() {
        var grid = document.getElementById('companyGrid');
        var empty = document.getElementById('companyEmpty');
        var query = (document.getElementById('searchCompanies').value || '').toLowerCase().trim();

        var filtered = allCompanies.filter(function(co) {
            if (ctAiFilterCompanyType) {
                if ((co.company_type || '').toLowerCase() !== ctAiFilterCompanyType.toLowerCase()) return false;
            }
            if (!query) return true;
            var full = (co.name + ' ' + (co.company_type || '') + ' ' + (co.email || '')).toLowerCase();
            return full.indexOf(query) !== -1;
        });

        if (filtered.length === 0) {
            grid.innerHTML = '';
            empty.style.display = '';
            return;
        }
        empty.style.display = 'none';

        var html = '';
        for (var i = 0; i < filtered.length; i++) {
            var co = filtered[i];
            var contacts = (co.contact_companies || []).map(function(cc) {
                var name = cc.contacts ? (cc.contacts.first_name + ' ' + cc.contacts.last_name) : '?';
                return '<span class="card-badge">' + escapeHtml(name) + '</span>';
            }).join('');
            html += '<div class="card" onclick="openCompanyModal(\'' + co.id + '\')">' +
                '<div class="card-name">' + escapeHtml(co.name) + '</div>' +
                '<div class="card-meta">' +
                    (co.company_type ? escapeHtml(co.company_type) + '<br>' : '') +
                    (co.phone ? escapeHtml(co.phone) : '') +
                '</div>' +
                (contacts ? '<div class="card-companies">' + contacts + '</div>' : '') +
                '</div>';
        }
        grid.innerHTML = html;
        if (ctAiFilterActive) {
            var cards = grid.querySelectorAll('.card');
            cards.forEach(function(card, i) { card.classList.add('ct-card-animate'); card.style.animationDelay = Math.min(i * 30, 300) + 'ms'; });
        }
    }

    // ═══════════════════════════════════════════════════════════════
    // CONTACT MODAL
    // ═══════════════════════════════════════════════════════════════

    async function openContactModal(id) {
        currentContactId = id || null;
        document.getElementById('contactModalTitle').textContent = id ? 'Modifier le contact' : 'Nouveau contact';
        document.getElementById('btnDeleteContact').style.display = id ? '' : 'none';
        document.getElementById('contactLinksSection').style.display = id ? '' : 'none';
        document.getElementById('contactCommsSection').style.display = id ? '' : 'none';
        document.getElementById('contactModalStatus').textContent = '';

        if (id) {
            var c = allContacts.find(function(x) { return x.id === id; });
            if (!c) return;
            document.getElementById('cFirstName').value = c.first_name || '';
            document.getElementById('cLastName').value = c.last_name || '';
            document.getElementById('cEmail').value = c.email || '';
            document.getElementById('cPhone').value = c.phone || '';
            document.getElementById('cAddress').value = c.address || '';
            document.getElementById('cPreferred').value = c.preferred_contact || 'email';
            document.getElementById('cNotes').value = c.notes || '';
            renderContactLinks(c);
            await loadAndRenderComms(id);
        } else {
            document.getElementById('cFirstName').value = '';
            document.getElementById('cLastName').value = '';
            document.getElementById('cEmail').value = '';
            document.getElementById('cPhone').value = '';
            document.getElementById('cAddress').value = '';
            document.getElementById('cPreferred').value = 'email';
            document.getElementById('cNotes').value = '';
        }
        document.getElementById('contactModal').classList.add('active');
    }

    function closeContactModal() {
        document.getElementById('contactModal').classList.remove('active');
        currentContactId = null;
    }
    document.getElementById('contactModal').addEventListener('click', function(e) { if (e.target === this) closeContactModal(); });

    async function saveContact() {
        var fn = document.getElementById('cFirstName').value.trim();
        var ln = document.getElementById('cLastName').value.trim();
        if (!fn || !ln) { showStatus('contactModalStatus', 'error', 'Pr\u00e9nom et nom requis.'); return; }

        var data = {
            first_name: fn, last_name: ln,
            email: document.getElementById('cEmail').value.trim() || null,
            phone: document.getElementById('cPhone').value.trim() || null,
            address: document.getElementById('cAddress').value.trim() || null,
            preferred_contact: document.getElementById('cPreferred').value,
            notes: document.getElementById('cNotes').value.trim() || null,
            updated_at: new Date().toISOString()
        };

        try {
            if (currentContactId) {
                await authenticatedFetch(SUPABASE_URL + '/rest/v1/contacts?id=eq.' + currentContactId, {
                    method: 'PATCH', headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                    body: JSON.stringify(data)
                });
            } else {
                data.created_by = localStorage.getItem('sb_user_id');
                var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/contacts', {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                    body: JSON.stringify(data)
                });
                if (r.ok) { var res = await r.json(); currentContactId = res[0].id; }
            }
            showStatus('contactModalStatus', 'success', 'Sauvegard\u00e9.');
            await loadContacts(); renderContacts();
            // Show links/comms sections now that we have an ID
            document.getElementById('contactLinksSection').style.display = '';
            document.getElementById('contactCommsSection').style.display = '';
            document.getElementById('btnDeleteContact').style.display = '';
            document.getElementById('contactModalTitle').textContent = 'Modifier le contact';
            var c = allContacts.find(function(x) { return x.id === currentContactId; });
            if (c) renderContactLinks(c);
        } catch (e) {
            showStatus('contactModalStatus', 'error', 'Erreur lors de la sauvegarde.');
        }
    }

    async function deleteContact() {
        if (!currentContactId || !(await steleConfirm('Supprimer ce contact ?', 'Supprimer', 'Supprimer', true))) return;
        await authenticatedFetch(SUPABASE_URL + '/rest/v1/contacts?id=eq.' + currentContactId, { method: 'DELETE' });
        closeContactModal();
        await loadContacts(); renderContacts();
    }

    // ═══════════════════════════════════════════════════════════════
    // CONTACT LINKS (companies)
    // ═══════════════════════════════════════════════════════════════

    function renderContactLinks(contact) {
        var list = document.getElementById('contactLinksList');
        var links = contact.contact_companies || [];
        if (links.length === 0) { list.innerHTML = '<div style="font-size:12px; color:#aaa; padding:6px 0;">Aucune entreprise li\u00e9e.</div>'; return; }
        var html = '';
        for (var i = 0; i < links.length; i++) {
            var lk = links[i];
            var coName = lk.companies ? lk.companies.name : '?';
            var details = [lk.role, lk.work_email, lk.work_phone].filter(Boolean).join(' \u00b7 ');
            html += '<div class="link-row" style="flex-wrap:wrap;">' +
                '<a href="#" class="link-name link-clickable" onclick="event.preventDefault(); closeContactModal(); openCompanyModal(\'' + lk.company_id + '\')">' + escapeHtml(coName) + '</a>' +
                (lk.is_primary_contact ? '<span class="link-primary">Principal</span>' : '') +
                '<button class="link-remove" onclick="removeLink(\'' + lk.id + '\')" title="Retirer">&times;</button>' +
                (details ? '<div style="width:100%; font-size:11px; color:#999; margin-top:1px;">' + escapeHtml(details) + '</div>' : '') +
                '</div>';
        }
        list.innerHTML = html;
    }

    async function removeLink(linkId) {
        if (!(await steleConfirm('Retirer ce lien ?', 'Retirer'))) return;
        await authenticatedFetch(SUPABASE_URL + '/rest/v1/contact_companies?id=eq.' + linkId, { method: 'DELETE' });
        await loadContacts(); renderContacts();
        var c = allContacts.find(function(x) { return x.id === currentContactId; });
        if (c) renderContactLinks(c);
    }

    // ═══════════════════════════════════════════════════════════════
    // LINK MODAL (from contact)
    // ═══════════════════════════════════════════════════════════════

    function openLinkModal() {
        var sel = document.getElementById('linkCompanySelect');
        sel.innerHTML = allCompanies.map(function(co) {
            return '<option value="' + co.id + '">' + escapeHtml(co.name) + '</option>';
        }).join('');
        populateRoleSelect('linkRole');
        document.getElementById('linkWorkEmail').value = '';
        document.getElementById('linkWorkPhone').value = '';
        document.getElementById('linkPrimary').checked = false;
        document.getElementById('linkModal').classList.add('active');
    }
    function closeLinkModal() { document.getElementById('linkModal').classList.remove('active'); }
    document.getElementById('linkModal').addEventListener('click', function(e) { if (e.target === this) closeLinkModal(); });

    async function saveLink() {
        var coId = document.getElementById('linkCompanySelect').value;
        if (!coId || !currentContactId) return;
        var data = {
            contact_id: currentContactId, company_id: coId,
            role: document.getElementById('linkRole').value || null,
            work_email: document.getElementById('linkWorkEmail').value.trim() || null,
            work_phone: document.getElementById('linkWorkPhone').value.trim() || null,
            is_primary_contact: document.getElementById('linkPrimary').checked
        };
        await authenticatedFetch(SUPABASE_URL + '/rest/v1/contact_companies', {
            method: 'POST', headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal,resolution=merge-duplicates' },
            body: JSON.stringify(data)
        });
        closeLinkModal();
        await loadContacts(); await loadCompanies(); renderContacts(); renderCompanies();
        var c = allContacts.find(function(x) { return x.id === currentContactId; });
        if (c) renderContactLinks(c);
    }

    // ═══════════════════════════════════════════════════════════════
    // COMPANY MODAL
    // ═══════════════════════════════════════════════════════════════

    async function openCompanyModal(id) {
        currentCompanyId = id || null;
        currentCompanyExtraData = {};
        document.getElementById('companyModalTitle').textContent = id ? 'Modifier l\'entreprise' : 'Nouvelle entreprise';
        document.getElementById('btnDeleteCompany').style.display = id ? '' : 'none';
        document.getElementById('companyLinksSection').style.display = id ? '' : 'none';
        document.getElementById('companyModalStatus').textContent = '';

        populateTypeSelect('coType');

        if (id) {
            var co = allCompanies.find(function(x) { return x.id === id; });
            if (!co) return;
            document.getElementById('coName').value = co.name || '';
            document.getElementById('coType').value = co.company_type || '';
            document.getElementById('coType').disabled = true;
            document.getElementById('coAddress').value = co.address || '';
            document.getElementById('coPhone').value = co.phone || '';
            document.getElementById('coEmail').value = co.email || '';
            document.getElementById('coWebsite').value = co.website || '';
            document.getElementById('coNotes').value = co.notes || '';
            currentCompanyExtraData = co.extra_data || {};
            renderCompanyLinks(co);
        } else {
            document.getElementById('coType').disabled = false;
            document.getElementById('coName').value = '';
            document.getElementById('coType').value = '';
            document.getElementById('coAddress').value = '';
            document.getElementById('coPhone').value = '';
            document.getElementById('coEmail').value = '';
            document.getElementById('coWebsite').value = '';
            document.getElementById('coNotes').value = '';
        }
        updateTypeFields();
        document.getElementById('companyModal').classList.add('active');
    }

    function closeCompanyModal() {
        document.getElementById('companyModal').classList.remove('active');
        currentCompanyId = null;
    }
    document.getElementById('companyModal').addEventListener('click', function(e) { if (e.target === this) closeCompanyModal(); });

    async function saveCompany() {
        var name = document.getElementById('coName').value.trim();
        if (!name) { showStatus('companyModalStatus', 'error', 'Nom requis.'); return; }

        var type = document.getElementById('coType').value.trim() || null;

        // Collect extra fields
        var extraData = {};
        document.querySelectorAll('#coExtraFields .extra-field').forEach(function(el) {
            var key = el.dataset.key;
            var val = el.value.trim();
            if (val) extraData[key] = val;
        });

        var data = {
            name: name, company_type: type,
            address: document.getElementById('coAddress').value.trim() || null,
            phone: document.getElementById('coPhone').value.trim() || null,
            email: document.getElementById('coEmail').value.trim() || null,
            website: document.getElementById('coWebsite').value.trim() || null,
            notes: document.getElementById('coNotes').value.trim() || null,
            extra_data: extraData,
            updated_at: new Date().toISOString()
        };

        // Auto-save new custom type to app_config
        if (type && configCompanyTypes.indexOf(type) === -1) {
            configCompanyTypes.push(type);
            populateTypeSelect('coType');
            authenticatedFetch(SUPABASE_URL + '/rest/v1/app_config?key=eq.company_types', {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                body: JSON.stringify({ value: configCompanyTypes })
            });
        }

        try {
            if (currentCompanyId) {
                await authenticatedFetch(SUPABASE_URL + '/rest/v1/companies?id=eq.' + currentCompanyId, {
                    method: 'PATCH', headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                    body: JSON.stringify(data)
                });
            } else {
                data.created_by = localStorage.getItem('sb_user_id');
                var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/companies', {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                    body: JSON.stringify(data)
                });
                if (r.ok) { var res = await r.json(); currentCompanyId = res[0].id; }
            }
            showStatus('companyModalStatus', 'success', 'Sauvegard\u00e9.');
            await loadCompanies(); renderCompanies();
            document.getElementById('companyLinksSection').style.display = '';
            document.getElementById('btnDeleteCompany').style.display = '';
            document.getElementById('companyModalTitle').textContent = 'Modifier l\'entreprise';
            var co = allCompanies.find(function(x) { return x.id === currentCompanyId; });
            if (co) renderCompanyLinks(co);
        } catch (e) {
            showStatus('companyModalStatus', 'error', 'Erreur lors de la sauvegarde.');
        }
    }

    async function deleteCompany() {
        if (!currentCompanyId || !(await steleConfirm('Supprimer cette entreprise ?', 'Supprimer', 'Supprimer', true))) return;
        await authenticatedFetch(SUPABASE_URL + '/rest/v1/companies?id=eq.' + currentCompanyId, { method: 'DELETE' });
        closeCompanyModal();
        await loadCompanies(); renderCompanies();
    }

    // ═══════════════════════════════════════════════════════════════
    // COMPANY LINKS (contacts)
    // ═══════════════════════════════════════════════════════════════

    function renderCompanyLinks(company) {
        var list = document.getElementById('companyLinksList');
        var links = company.contact_companies || [];
        if (links.length === 0) { list.innerHTML = '<div style="font-size:12px; color:#aaa; padding:6px 0;">Aucun contact li\u00e9.</div>'; return; }
        var html = '';
        for (var i = 0; i < links.length; i++) {
            var lk = links[i];
            var name = lk.contacts ? (lk.contacts.first_name + ' ' + lk.contacts.last_name) : '?';
            var details = [lk.role, lk.work_email, lk.work_phone].filter(Boolean).join(' \u00b7 ');
            html += '<div class="link-row" style="flex-wrap:wrap;">' +
                '<a href="#" class="link-name link-clickable" onclick="event.preventDefault(); closeCompanyModal(); openContactModal(\'' + lk.contact_id + '\')">' + escapeHtml(name) + '</a>' +
                (lk.is_primary_contact ? '<span class="link-primary">Principal</span>' : '') +
                '<button class="link-remove" onclick="removeLinkFromCompany(\'' + lk.id + '\')" title="Retirer">&times;</button>' +
                (details ? '<div style="width:100%; font-size:11px; color:#999; margin-top:1px;">' + escapeHtml(details) + '</div>' : '') +
                '</div>';
        }
        list.innerHTML = html;
    }

    async function removeLinkFromCompany(linkId) {
        if (!(await steleConfirm('Retirer ce lien ?', 'Retirer'))) return;
        await authenticatedFetch(SUPABASE_URL + '/rest/v1/contact_companies?id=eq.' + linkId, { method: 'DELETE' });
        await loadCompanies(); renderCompanies();
        var co = allCompanies.find(function(x) { return x.id === currentCompanyId; });
        if (co) renderCompanyLinks(co);
    }

    // ═══════════════════════════════════════════════════════════════
    // LINK MODAL (from company)
    // ═══════════════════════════════════════════════════════════════

    function openLinkModalFromCompany() {
        var sel = document.getElementById('linkContactSelect');
        sel.innerHTML = allContacts.map(function(c) {
            return '<option value="' + c.id + '">' + escapeHtml(c.first_name + ' ' + c.last_name) + '</option>';
        }).join('');
        populateRoleSelect('linkRole2');
        document.getElementById('linkWorkEmail2').value = '';
        document.getElementById('linkWorkPhone2').value = '';
        document.getElementById('linkPrimary2').checked = false;
        document.getElementById('linkModalFromCompany').classList.add('active');
    }
    function closeLinkModalFromCompany() { document.getElementById('linkModalFromCompany').classList.remove('active'); }
    document.getElementById('linkModalFromCompany').addEventListener('click', function(e) { if (e.target === this) closeLinkModalFromCompany(); });

    async function saveLinkFromCompany() {
        var cId = document.getElementById('linkContactSelect').value;
        if (!cId || !currentCompanyId) return;
        var data = {
            contact_id: cId, company_id: currentCompanyId,
            role: document.getElementById('linkRole2').value || null,
            work_email: document.getElementById('linkWorkEmail2').value.trim() || null,
            work_phone: document.getElementById('linkWorkPhone2').value.trim() || null,
            is_primary_contact: document.getElementById('linkPrimary2').checked
        };
        await authenticatedFetch(SUPABASE_URL + '/rest/v1/contact_companies', {
            method: 'POST', headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal,resolution=merge-duplicates' },
            body: JSON.stringify(data)
        });
        closeLinkModalFromCompany();
        await loadContacts(); await loadCompanies(); renderContacts(); renderCompanies();
        var co = allCompanies.find(function(x) { return x.id === currentCompanyId; });
        if (co) renderCompanyLinks(co);
    }

    // ═══════════════════════════════════════════════════════════════
    // COMMUNICATIONS
    // ═══════════════════════════════════════════════════════════════

    async function loadAndRenderComms(contactId) {
        var list = document.getElementById('contactCommsList');
        try {
            var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/communications?contact_id=eq.' + contactId + '&order=comm_date.desc&limit=20&select=*', {});
            if (!r.ok) { list.innerHTML = ''; return; }
            var comms = await r.json();
            if (comms.length === 0) { list.innerHTML = '<div style="font-size:12px; color:#aaa; padding:6px 0;">Aucune communication.</div>'; return; }
            var html = '';
            for (var i = 0; i < comms.length; i++) {
                var cm = comms[i];
                var date = new Date(cm.comm_date).toLocaleDateString('fr-CA', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                var dir = cm.direction === 'inbound' ? 'Entrant' : 'Sortant';
                html += '<div class="comm-row">' +
                    '<div class="comm-header">' +
                    '<span class="comm-type-badge">' + escapeHtml(cm.comm_type) + '</span>' +
                    '<span class="comm-direction">' + dir + '</span>' +
                    '<span class="comm-date">' + date + '</span>' +
                    '</div>' +
                    (cm.subject ? '<div class="comm-subject">' + escapeHtml(cm.subject) + '</div>' : '') +
                    (cm.content ? '<div class="comm-content">' + escapeHtml(cm.content) + '</div>' : '') +
                    '</div>';
            }
            list.innerHTML = html;
        } catch (e) { list.innerHTML = ''; }
    }

    function openCommModal() {
        populateCommTypeSelect();
        document.getElementById('commSubject').value = '';
        document.getElementById('commContent').value = '';
        document.getElementById('commDirection').value = 'outbound';
        var now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('commDate').value = now.toISOString().slice(0, 16);
        document.getElementById('commModal').classList.add('active');
    }
    function closeCommModal() { document.getElementById('commModal').classList.remove('active'); }
    document.getElementById('commModal').addEventListener('click', function(e) { if (e.target === this) closeCommModal(); });

    async function saveComm() {
        var type = document.getElementById('commType').value;
        if (!type || !currentContactId) return;
        var data = {
            contact_id: currentContactId,
            comm_type: type,
            direction: document.getElementById('commDirection').value,
            subject: document.getElementById('commSubject').value.trim() || null,
            content: document.getElementById('commContent').value.trim() || null,
            comm_date: document.getElementById('commDate').value ? new Date(document.getElementById('commDate').value).toISOString() : new Date().toISOString(),
            created_by: localStorage.getItem('sb_user_id')
        };
        await authenticatedFetch(SUPABASE_URL + '/rest/v1/communications', {
            method: 'POST', headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
            body: JSON.stringify(data)
        });
        closeCommModal();
        await loadAndRenderComms(currentContactId);
    }

    // ═══════════════════════════════════════════════════════════════
    // HELPERS
    // ═══════════════════════════════════════════════════════════════

    function populateTypeSelect(id) {
        var dl = document.getElementById(id + 'Options');
        if (!dl) return;
        dl.innerHTML = configCompanyTypes.map(function(t) {
            return '<option value="' + escapeHtml(t) + '">';
        }).join('');
    }

    function populateRoleSelect(id) {
        var sel = document.getElementById(id);
        sel.innerHTML = '<option value="">Aucun</option>' + configContactRoles.map(function(r) {
            return '<option value="' + escapeHtml(r) + '">' + escapeHtml(r) + '</option>';
        }).join('');
    }

    function populateCommTypeSelect() {
        var sel = document.getElementById('commType');
        sel.innerHTML = configCommTypes.map(function(t) {
            return '<option value="' + escapeHtml(t) + '">' + escapeHtml(t) + '</option>';
        }).join('');
    }

    function showStatus(id, type, msg) {
        var el = document.getElementById(id);
        el.textContent = msg;
        el.className = 'modal-status ' + type;
        setTimeout(function() { el.textContent = ''; el.className = 'modal-status'; }, 3000);
    }

    // ═══════════════════════════════════════════════════════════════
    // AI CHAT DRAWER
    // ═══════════════════════════════════════════════════════════════

    var ctConversation = [];
    var ctPendingImages = [];
    var ctPendingToolCalls = null;
    var ctPendingConfirmId = 0;
    var ctChatLoaded = false;

    function toggleCtDrawer() {
        var drawer = document.getElementById('ctDrawer');
        if (drawer.classList.contains('active')) closeCtDrawer();
        else openCtDrawer();
    }

    function openCtDrawer() {
        document.getElementById('ctDrawer').classList.add('active');
        document.getElementById('ctOverlay').classList.add('active');
        document.getElementById('navAssistantBtn').classList.add('active');
        setupCtDrawerHandlers();
        if (!ctChatLoaded) {
            ctChatLoaded = true;
            loadCtChat();
        }
        setTimeout(function() {
            var msgs = document.getElementById('ctMessages');
            msgs.scrollTop = msgs.scrollHeight;
            document.getElementById('ctInput').focus();
        }, 300);
    }

    function closeCtDrawer() {
        document.getElementById('ctDrawer').classList.remove('active');
        document.getElementById('ctOverlay').classList.remove('active');
        document.getElementById('navAssistantBtn').classList.remove('active');
    }

    async function saveCtChatMessage(role, content) {
        try {
            await authenticatedFetch(SUPABASE_URL + '/rest/v1/chat_messages', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                body: JSON.stringify({ context_type: 'contacts', role: role, content: content || '' })
            });
        } catch (e) { console.warn('[CT] Failed to save chat message:', e); }
    }

    async function loadCtChat() {
        try {
            var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/chat_messages?context_type=eq.contacts&order=created_at.desc&limit=20&select=role,content,created_at', {});
            if (!r.ok) return;
            var msgs = await r.json();
            if (msgs.length === 0) return;

            msgs.reverse();

            var container = document.getElementById('ctMessages');
            container.innerHTML = '';

            msgs.forEach(function(msg) {
                appendCtMessage(msg.role, msg.content);
            });

            // Rebuild ctConversation from loaded messages
            ctConversation = [];
            msgs.forEach(function(msg) {
                if (msg.role === 'user' || msg.role === 'assistant') {
                    ctConversation.push({ role: msg.role, content: msg.content });
                }
            });

            // Hide quick actions since we have history
            var qa = document.getElementById('ctQuickActions');
            if (qa) qa.style.display = 'none';

            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        } catch (e) { console.warn('[CT] Failed to load chat:', e); }
    }

    function setupCtDrawerHandlers() {
        var input = document.getElementById('ctInput');
        var drawer = document.getElementById('ctDrawer');
        var dropZone = document.getElementById('ctDropZone');

        // Paste handler
        if (!input._ctPasteSetup) {
            input._ctPasteSetup = true;
            input.addEventListener('paste', function(e) {
                var items = (e.clipboardData || {}).items || [];
                for (var i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        e.preventDefault();
                        ctProcessImage(items[i].getAsFile());
                        return;
                    }
                }
            });
        }

        // Drag-drop handlers
        if (!drawer._ctDragSetup) {
            drawer._ctDragSetup = true;
            var dragCounter = 0;
            drawer.addEventListener('dragenter', function(e) { e.preventDefault(); dragCounter++; dropZone.classList.add('active'); });
            drawer.addEventListener('dragleave', function(e) { e.preventDefault(); dragCounter--; if (dragCounter <= 0) { dragCounter = 0; dropZone.classList.remove('active'); } });
            drawer.addEventListener('dragover', function(e) { e.preventDefault(); });
            drawer.addEventListener('drop', function(e) {
                e.preventDefault(); dragCounter = 0; dropZone.classList.remove('active');
                var files = e.dataTransfer.files;
                for (var i = 0; i < files.length; i++) {
                    if (files[i].type.indexOf('image') !== -1) ctProcessImage(files[i]);
                }
            });
        }
    }

    function ctProcessImage(file) {
        if (!file) return;
        var reader = new FileReader();
        reader.onload = function(e) {
            var img = new Image();
            img.onload = function() {
                var maxW = 1200;
                var w = img.width, h = img.height;
                if (w > maxW) { h = Math.round(h * (maxW / w)); w = maxW; }
                var canvas = document.createElement('canvas');
                canvas.width = w; canvas.height = h;
                canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                ctPendingImages.push(canvas.toDataURL('image/jpeg', 0.8));
                renderCtImagePreviews();
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    function renderCtImagePreviews() {
        var container = document.getElementById('ctImgPreview');
        container.innerHTML = '';
        ctPendingImages.forEach(function(src, i) {
            var div = document.createElement('div');
            div.className = 'ct-img-thumb';
            div.innerHTML = '<img src="' + src + '"><button class="ct-img-remove" onclick="ctRemoveImage(' + i + ')">&times;</button>';
            container.appendChild(div);
        });
    }

    function ctRemoveImage(index) {
        ctPendingImages.splice(index, 1);
        renderCtImagePreviews();
    }

    function ctInputKeydown(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendCtMessage();
        }
    }

    function ctQuickAction(text) {
        document.getElementById('ctInput').value = text;
        document.getElementById('ctInput').focus();
    }

    function appendCtMessage(role, content, opts) {
        opts = opts || {};
        var container = document.getElementById('ctMessages');
        var div = document.createElement('div');

        if (role === 'confirm') {
            div.className = 'ct-msg ct-msg-confirm';
            var confirmId = 'ct-confirm-' + (++ctPendingConfirmId);
            div.id = confirmId;
            div.innerHTML = '<div class="ct-confirm-text">' + renderCtMarkdown(content) + '</div>' +
                '<div class="ct-confirm-actions">' +
                '<button class="btn-ct-apply" onclick="ctApplyPending(\'' + confirmId + '\')">Appliquer</button>' +
                '<button class="btn-ct-dismiss" onclick="ctDismissPending(\'' + confirmId + '\')">Ignorer</button>' +
                '</div>';
            container.appendChild(div);
        } else {
            div.className = 'ct-msg ct-msg-' + role;
            if (role === 'user' && opts.images && opts.images.length > 0) {
                var imgHtml = opts.images.map(function(src) {
                    return '<img src="' + src + '" style="max-width:100%;border-radius:8px;margin-bottom:6px;">';
                }).join('');
                div.innerHTML = imgHtml + renderCtMarkdown(content);
            } else {
                div.innerHTML = renderCtMarkdown(content);
            }
            container.appendChild(div);
        }

        var isNearBottom = container.scrollHeight - container.scrollTop - container.clientHeight < 80;
        if (isNearBottom) container.scrollTop = container.scrollHeight;
    }

    function renderCtMarkdown(text) {
        if (!text) return '';
        var s = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        s = s.replace(/```([\s\S]*?)```/g, '<pre>$1</pre>');
        s = s.replace(/`([^`]+)`/g, '<code>$1</code>');
        s = s.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        s = s.replace(/\*(.+?)\*/g, '<em>$1</em>');
        // Tables
        s = s.replace(/((?:\|.*\|\n?)+)/g, function(table) {
            var rows = table.trim().split('\n').filter(function(r) { return r.trim() && !/^\|[\s\-:]+\|$/.test(r); });
            if (rows.length === 0) return table;
            var html = '<table>';
            rows.forEach(function(row, i) {
                var cells = row.split('|').filter(function(c) { return c.trim() !== ''; });
                var tag = i === 0 ? 'th' : 'td';
                html += '<tr>' + cells.map(function(c) { return '<' + tag + '>' + c.trim() + '</' + tag + '>'; }).join('') + '</tr>';
            });
            html += '</table>';
            return html;
        });
        s = s.replace(/^[•\-\*] (.+)$/gm, '<li>$1</li>');
        s = s.replace(/((?:<li>.*<\/li>\n?)+)/g, '<ul>$1</ul>');
        s = s.replace(/\n{2,}/g, '</p><p>');
        s = s.replace(/\n/g, '<br>');
        s = '<p>' + s + '</p>';
        s = s.replace(/<p><\/p>/g, '');
        return s;
    }

    function buildCtUserContent(text, images) {
        if (!images || images.length === 0) return text;
        var content = [];
        images.forEach(function(dataUrl) {
            var match = dataUrl.match(/^data:(.*?);base64,(.*)$/);
            if (match) {
                content.push({
                    type: 'image',
                    source: { type: 'base64', media_type: match[1], data: match[2] }
                });
            }
        });
        if (text) content.push({ type: 'text', text: text });
        return content;
    }

    function collectContactsContext() {
        // Summary only — full lists are accessed via search_contacts tool
        return {
            contactCount: allContacts.length,
            companyCount: allCompanies.length,
            companyTypes: configCompanyTypes,
            contactRoles: configContactRoles,
            userEmail: (localStorage.getItem('sb_user_email') || '').toLowerCase()
        };
    }

    var ctStreamEl = null;

    async function callContactsImport(messages, context, _retryCount) {
        var retryCount = _retryCount || 0;
        var maxRetries = 2;
        var resp = await authenticatedFetch(SUPABASE_URL + '/functions/v1/contacts-import', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ messages: messages, context: context })
        });
        if (!resp.ok) {
            var errText = await resp.text().catch(function() { return ''; });
            // Auto-retry on 401 auth error (force token refresh + one more try)
            if (resp.status === 401 && retryCount === 0) {
                if (await refreshAccessToken()) {
                    return callContactsImport(messages, context, 1);
                }
                window.location.href = 'login.html';
                throw new Error('Session expir\u00e9e');
            }
            // Auto-retry on 429 rate limit
            if ((resp.status === 429 || errText.indexOf('429') !== -1 || errText.indexOf('rate') !== -1) && retryCount < maxRetries) {
                appendCtMessage('assistant', 'Rate limit atteint \u2014 r\u00e9essai dans 5 secondes...');
                await new Promise(function(r) { setTimeout(r, 5000); });
                // Remove the retry notice
                var msgs = document.getElementById('ctMessages');
                if (msgs && msgs.lastChild) msgs.removeChild(msgs.lastChild);
                return callContactsImport(messages, context, retryCount + 1);
            }
            // Parse error message (Supabase gateway uses 'msg', our function uses 'error')
            try {
                var errObj = JSON.parse(errText);
                throw new Error(errObj.error || errObj.msg || errObj.message || 'Erreur ' + resp.status);
            } catch(e) {
                if (e.message) throw e;
                throw new Error('Erreur ' + resp.status);
            }
        }

        var contentType = resp.headers.get('content-type') || '';
        if (contentType.indexOf('text/event-stream') === -1) {
            return await resp.json();
        }

        // Parse SSE stream
        var reader = resp.body.getReader();
        var decoder = new TextDecoder();
        var buffer = '';
        var contentBlocks = [];
        var currentText = '';
        var currentToolName = '';
        var currentToolId = '';
        var currentToolInput = '';
        var stopReason = null;
        var usage = null;

        // Create live message element (not appended yet — typing dots stay until first text arrives)
        ctStreamEl = document.createElement('div');
        ctStreamEl.className = 'ct-msg ct-msg-assistant';

        while (true) {
            var chunk = await reader.read();
            if (chunk.done) break;
            buffer += decoder.decode(chunk.value, { stream: true });
            var lines = buffer.split('\n');
            buffer = lines.pop() || '';
            for (var li = 0; li < lines.length; li++) {
                var line = lines[li];
                if (!line.startsWith('data: ')) continue;
                var jsonStr = line.slice(6).trim();
                if (!jsonStr || jsonStr === '[DONE]') continue;
                try {
                    var evt = JSON.parse(jsonStr);
                    if (evt.type === 'content_block_start') {
                        if (evt.content_block.type === 'text') {
                            currentText = '';
                        } else if (evt.content_block.type === 'tool_use') {
                            currentToolName = evt.content_block.name;
                            currentToolId = evt.content_block.id;
                            currentToolInput = '';
                        }
                    } else if (evt.type === 'content_block_delta') {
                        if (evt.delta.type === 'text_delta') {
                            currentText += evt.delta.text;
                            // Hide typing dots on first text, show streaming element
                            document.getElementById('ctTyping').classList.remove('active');
                            if (ctStreamEl && !ctStreamEl.parentNode) {
                                document.getElementById('ctMessages').appendChild(ctStreamEl);
                            }
                            if (ctStreamEl) {
                                ctStreamEl.innerHTML = renderCtMarkdown(currentText);
                                var cont = document.getElementById('ctMessages');
                                if (cont.scrollHeight - cont.scrollTop - cont.clientHeight < 80) cont.scrollTop = cont.scrollHeight;
                            }
                        } else if (evt.delta.type === 'input_json_delta') {
                            currentToolInput += evt.delta.partial_json;
                        }
                    } else if (evt.type === 'content_block_stop') {
                        if (currentToolName) {
                            var parsedInput = {};
                            try { parsedInput = JSON.parse(currentToolInput); } catch(e2) {}
                            contentBlocks.push({ type: 'tool_use', id: currentToolId, name: currentToolName, input: parsedInput });
                            currentToolName = '';
                            currentToolId = '';
                            currentToolInput = '';
                        } else {
                            contentBlocks.push({ type: 'text', text: currentText });
                            currentText = '';
                        }
                    } else if (evt.type === 'message_delta') {
                        if (evt.delta && evt.delta.stop_reason) stopReason = evt.delta.stop_reason;
                        if (evt.usage) usage = evt.usage;
                    }
                } catch(parseErr) {}
            }
        }

        if (ctStreamEl) { if (ctStreamEl.parentNode) ctStreamEl.remove(); ctStreamEl = null; }
        return { content: contentBlocks, stop_reason: stopReason, usage: usage };
    }

    function ctSearchContacts(query) {
        var q = (query || '').toLowerCase();
        var contactResults = allContacts.filter(function(c) {
            return (c.first_name + ' ' + c.last_name).toLowerCase().indexOf(q) !== -1 ||
                   (c.email || '').toLowerCase().indexOf(q) !== -1 ||
                   (c.phone || '').indexOf(q) !== -1;
        }).slice(0, 15).map(function(c) {
            var companies = (c.contact_companies || []).map(function(cc) { return cc.companies ? cc.companies.name : null; }).filter(Boolean);
            return { id: c.id, name: c.first_name + ' ' + c.last_name, email: c.email, phone: c.phone, companies: companies };
        });
        var companyResults = allCompanies.filter(function(co) {
            return (co.name || '').toLowerCase().indexOf(q) !== -1 ||
                   (co.email || '').toLowerCase().indexOf(q) !== -1;
        }).slice(0, 10).map(function(co) {
            return { id: co.id, name: co.name, type: co.company_type, email: co.email, phone: co.phone };
        });
        return { contacts: contactResults, companies: companyResults, total: contactResults.length + companyResults.length };
    }

    function ctExecuteFilterContacts(input) {
        if (input.reset) {
            ctAiFilterActive = false;
            ctAiFilterCompanyType = null;
            document.getElementById('searchContacts').value = '';
            document.getElementById('searchCompanies').value = '';
            document.getElementById('ctAiFilterBadge').style.display = 'none';
            renderContacts();
            renderCompanies();
        } else {
            ctAiFilterActive = true;
            if (input.tab) switchTab(input.tab);
            if (input.search) {
                var activeTab = document.getElementById('viewContacts').style.display !== 'none' ? 'contacts' : 'companies';
                if (activeTab === 'contacts') {
                    document.getElementById('searchContacts').value = input.search;
                } else {
                    document.getElementById('searchCompanies').value = input.search;
                }
            }
            if (input.company_type) {
                ctAiFilterCompanyType = input.company_type;
                switchTab('companies');
            }
            document.getElementById('ctAiFilterBadge').style.display = '';
            renderContacts();
            renderCompanies();
        }
        var activeTab = document.getElementById('viewContacts').style.display !== 'none' ? 'contacts' : 'companies';
        var count = activeTab === 'contacts'
            ? document.querySelectorAll('#contactGrid .card').length
            : document.querySelectorAll('#companyGrid .card').length;
        return { filtered_count: count, message: 'Filtre appliqué' };
    }

    function resetCtAiFilter() {
        ctAiFilterActive = false;
        ctAiFilterCompanyType = null;
        document.getElementById('searchContacts').value = '';
        document.getElementById('searchCompanies').value = '';
        document.getElementById('ctAiFilterBadge').style.display = 'none';
        renderContacts();
        renderCompanies();
    }

    async function sendCtMessage() {
        var input = document.getElementById('ctInput');
        var text = input.value.trim();
        if (!text && ctPendingImages.length === 0) return;

        var images = ctPendingImages.slice();
        ctPendingImages = [];
        renderCtImagePreviews();
        input.value = '';
        input.style.height = 'auto';

        appendCtMessage('user', text || '(image)', { images: images });

        var userContent = buildCtUserContent(text, images);
        ctConversation.push({ role: 'user', content: userContent });
        saveCtChatMessage('user', text);
        var qa = document.getElementById('ctQuickActions');
        if (qa) qa.style.display = 'none';

        document.getElementById('ctTyping').classList.add('active');
        document.getElementById('ctSendBtn').disabled = true;

        try {
            var context = collectContactsContext();
            var data = await ctProcessResponse(ctConversation, context);
            ctHandleResponse(data);
        } catch (err) {
            appendCtMessage('assistant', 'Erreur : ' + err.message);
        } finally {
            document.getElementById('ctTyping').classList.remove('active');
            document.getElementById('ctSendBtn').disabled = false;
        }
    }

    async function ctProcessResponse(conversation, context) {
        var maxLoops = 5;
        var data = await callContactsImport(conversation, context);

        for (var loop = 0; loop < maxLoops; loop++) {
            var contentBlocks = data.content || [];
            var toolCalls = contentBlocks.filter(function(b) { return b.type === 'tool_use'; });
            var readOnlyNames = ['search_contacts', 'filter_contacts'];
            var readOnlyTools = toolCalls.filter(function(tc) { return readOnlyNames.indexOf(tc.name) !== -1; });
            var actionTools = toolCalls.filter(function(tc) { return readOnlyNames.indexOf(tc.name) === -1; });

            if (readOnlyTools.length === 0) return data;

            conversation.push({ role: 'assistant', content: contentBlocks });

            var toolResults = [];
            readOnlyTools.forEach(function(tc) {
                var result;
                if (tc.name === 'filter_contacts') {
                    result = ctExecuteFilterContacts(tc.input);
                } else {
                    result = ctSearchContacts(tc.input.query);
                }
                toolResults.push({ type: 'tool_result', tool_use_id: tc.id, content: JSON.stringify(result) });
            });

            if (actionTools.length > 0) {
                conversation.push({ role: 'user', content: toolResults });
                return data;
            }

            conversation.push({ role: 'user', content: toolResults });
            document.getElementById('ctTyping').classList.add('active');
            data = await callContactsImport(conversation, context);
        }

        return data;
    }

    function ctHandleResponse(data) {
        var contentBlocks = data.content || [];
        var textParts = [];
        var actionTools = [];

        var readOnlyNames = ['search_contacts', 'filter_contacts'];
        contentBlocks.forEach(function(block) {
            if (block.type === 'text') textParts.push(block.text);
            if (block.type === 'tool_use' && readOnlyNames.indexOf(block.name) === -1) actionTools.push(block);
        });

        var lastMsg = ctConversation[ctConversation.length - 1];
        if (!lastMsg || lastMsg.role !== 'assistant' || lastMsg.content !== contentBlocks) {
            ctConversation.push({ role: 'assistant', content: contentBlocks });
        }

        if (actionTools.length > 0) {
            var fullText = textParts.join('\n');
            if (fullText) appendCtMessage('assistant', fullText);
            ctPendingToolCalls = { tools: actionTools };
            var summary = formatCtPendingActions(actionTools);
            appendCtMessage('confirm', summary);
            saveCtChatMessage('assistant', fullText + '\n[Actions proposées]');
        } else {
            var fullText = textParts.join('\n');
            appendCtMessage('assistant', fullText);
            saveCtChatMessage('assistant', fullText);
        }
    }

    function formatCtPendingActions(tools) {
        var creates = { contacts: 0, companies: 0 };
        var updates = { contacts: 0, companies: 0 };
        var deletes = { contacts: 0, companies: 0 };
        var links = 0;
        var details = [];

        tools.forEach(function(tc) {
            if (tc.name === 'create_contact') {
                creates.contacts++;
                details.push('+ ' + (tc.input.first_name || '') + ' ' + (tc.input.last_name || ''));
            } else if (tc.name === 'create_company') {
                creates.companies++;
                details.push('+ ' + (tc.input.name || '') + (tc.input.company_type ? ' (' + tc.input.company_type + ')' : ''));
            } else if (tc.name === 'update_contact') {
                updates.contacts++;
                var fields = Object.keys(tc.input.updates || {}).join(', ');
                details.push('\u270f Contact ' + (tc.input.contact_id || '').substring(0, 8) + '... \u2192 ' + fields);
            } else if (tc.name === 'update_company') {
                updates.companies++;
                var fields = Object.keys(tc.input.updates || {}).join(', ');
                details.push('\u270f Entreprise ' + (tc.input.company_id || '').substring(0, 8) + '... \u2192 ' + fields);
            } else if (tc.name === 'delete_contact') {
                deletes.contacts++;
                details.push('\u2717 Contact ' + (tc.input.contact_id || '').substring(0, 8) + '...');
            } else if (tc.name === 'delete_company') {
                deletes.companies++;
                details.push('\u2717 Entreprise ' + (tc.input.company_id || '').substring(0, 8) + '...');
            } else if (tc.name === 'link_contact_company') {
                links++;
                details.push('\u2194 Lier contact \u2192 entreprise');
            }
        });

        var parts = [];
        if (creates.contacts) parts.push(creates.contacts + ' contact' + (creates.contacts > 1 ? 's' : '') + ' \u00e0 cr\u00e9er');
        if (creates.companies) parts.push(creates.companies + ' entreprise' + (creates.companies > 1 ? 's' : '') + ' \u00e0 cr\u00e9er');
        if (updates.contacts) parts.push(updates.contacts + ' contact' + (updates.contacts > 1 ? 's' : '') + ' \u00e0 modifier');
        if (updates.companies) parts.push(updates.companies + ' entreprise' + (updates.companies > 1 ? 's' : '') + ' \u00e0 modifier');
        if (deletes.contacts) parts.push(deletes.contacts + ' contact' + (deletes.contacts > 1 ? 's' : '') + ' \u00e0 supprimer');
        if (deletes.companies) parts.push(deletes.companies + ' entreprise' + (deletes.companies > 1 ? 's' : '') + ' \u00e0 supprimer');
        if (links) parts.push(links + ' lien' + (links > 1 ? 's' : '') + ' \u00e0 cr\u00e9er');

        return '**' + parts.join(', ') + '**\n\n' + details.join('\n');
    }

    async function ctApplyPending(confirmId) {
        if (!ctPendingToolCalls) return;
        var tools = ctPendingToolCalls.tools;
        ctPendingToolCalls = null;

        var el = document.getElementById(confirmId);
        if (el) {
            var actions = el.querySelector('.ct-confirm-actions');
            if (actions) actions.innerHTML = '<span class="ct-confirm-applied">Application en cours...</span>';
        }

        var results = [];
        var created = { contacts: 0, companies: 0 };
        var updated = { contacts: 0, companies: 0 };
        var deleted = { contacts: 0, companies: 0 };
        var linked = 0;
        var errors = [];

        for (var i = 0; i < tools.length; i++) {
            try {
                var result = await executeCtTool(tools[i].name, tools[i].input);
                results.push({ type: 'tool_result', tool_use_id: tools[i].id, content: JSON.stringify(result) });
                if (tools[i].name === 'create_contact') created.contacts++;
                else if (tools[i].name === 'create_company') created.companies++;
                else if (tools[i].name === 'update_contact') updated.contacts++;
                else if (tools[i].name === 'update_company') updated.companies++;
                else if (tools[i].name === 'delete_contact') deleted.contacts++;
                else if (tools[i].name === 'delete_company') deleted.companies++;
                else if (tools[i].name === 'link_contact_company') linked++;
            } catch (err) {
                errors.push(tools[i].name + ': ' + err.message);
                results.push({ type: 'tool_result', tool_use_id: tools[i].id, content: JSON.stringify({ error: err.message }), is_error: true });
            }
        }

        // Build summary
        var parts = [];
        if (created.contacts) parts.push(created.contacts + ' contact' + (created.contacts > 1 ? 's' : '') + ' cr\u00e9\u00e9' + (created.contacts > 1 ? 's' : ''));
        if (created.companies) parts.push(created.companies + ' entreprise' + (created.companies > 1 ? 's' : '') + ' cr\u00e9\u00e9e' + (created.companies > 1 ? 's' : ''));
        if (updated.contacts) parts.push(updated.contacts + ' contact' + (updated.contacts > 1 ? 's' : '') + ' modifi\u00e9' + (updated.contacts > 1 ? 's' : ''));
        if (updated.companies) parts.push(updated.companies + ' entreprise' + (updated.companies > 1 ? 's' : '') + ' modifi\u00e9e' + (updated.companies > 1 ? 's' : ''));
        if (deleted.contacts) parts.push(deleted.contacts + ' contact' + (deleted.contacts > 1 ? 's' : '') + ' supprim\u00e9' + (deleted.contacts > 1 ? 's' : ''));
        if (deleted.companies) parts.push(deleted.companies + ' entreprise' + (deleted.companies > 1 ? 's' : '') + ' supprim\u00e9e' + (deleted.companies > 1 ? 's' : ''));
        if (linked) parts.push(linked + ' lien' + (linked > 1 ? 's' : '') + ' cr\u00e9\u00e9' + (linked > 1 ? 's' : ''));

        var summary = parts.length > 0 ? '\u2705 ' + parts.join(', ') + '.' : '\u2705 Termin\u00e9.';
        if (errors.length > 0) summary += '\n\u26a0\ufe0f Erreurs : ' + errors.join(', ');

        if (el) {
            var actions = el.querySelector('.ct-confirm-actions') || el.querySelector('.ct-confirm-applied');
            if (actions) actions.outerHTML = '<span class="ct-confirm-applied">' + escapeHtml(summary) + '</span>';
        }

        // Continue conversation with tool results
        ctConversation.push({ role: 'user', content: results });

        // Reload data
        await Promise.all([loadContacts(), loadCompanies()]);
        renderContacts();
        renderCompanies();
    }

    function ctDismissPending(confirmId) {
        ctPendingToolCalls = null;
        var el = document.getElementById(confirmId);
        if (el) {
            var actions = el.querySelector('.ct-confirm-actions');
            if (actions) actions.innerHTML = '<span class="ct-confirm-applied">Ignor\u00e9</span>';
        }
    }

    async function executeCtTool(name, input) {
        if (name === 'create_contact') {
            var data = {
                first_name: input.first_name,
                last_name: input.last_name,
                email: input.email || null,
                phone: input.phone || null,
                address: input.address || null,
                preferred_contact: input.preferred_contact || null,
                notes: input.notes || null,
                created_by: localStorage.getItem('sb_user_id')
            };
            var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/contacts', {
                method: 'POST', headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                body: JSON.stringify(data)
            });
            if (!r.ok) throw new Error('Erreur cr\u00e9ation contact: ' + r.status);
            var res = await r.json();
            return { success: true, contact_id: res[0].id, name: input.first_name + ' ' + input.last_name };
        }

        if (name === 'create_company') {
            var data = {
                name: input.name,
                company_type: input.company_type || null,
                address: input.address || null,
                phone: input.phone || null,
                email: input.email || null,
                website: input.website || null,
                notes: input.notes || null,
                created_by: localStorage.getItem('sb_user_id')
            };
            var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/companies', {
                method: 'POST', headers: { 'Content-Type': 'application/json', 'Prefer': 'return=representation' },
                body: JSON.stringify(data)
            });
            if (!r.ok) throw new Error('Erreur cr\u00e9ation entreprise: ' + r.status);
            var res = await r.json();
            return { success: true, company_id: res[0].id, name: input.name };
        }

        if (name === 'update_contact') {
            var updates = input.updates || {};
            updates.updated_at = new Date().toISOString();
            var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/contacts?id=eq.' + input.contact_id, {
                method: 'PATCH', headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                body: JSON.stringify(updates)
            });
            if (!r.ok) throw new Error('Erreur modification contact: ' + r.status);
            return { success: true, contact_id: input.contact_id };
        }

        if (name === 'update_company') {
            var updates = input.updates || {};
            updates.updated_at = new Date().toISOString();
            var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/companies?id=eq.' + input.company_id, {
                method: 'PATCH', headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal' },
                body: JSON.stringify(updates)
            });
            if (!r.ok) throw new Error('Erreur modification entreprise: ' + r.status);
            return { success: true, company_id: input.company_id };
        }

        if (name === 'delete_contact') {
            var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/contacts?id=eq.' + input.contact_id, { method: 'DELETE' });
            if (!r.ok) throw new Error('Erreur suppression contact: ' + r.status);
            return { success: true, contact_id: input.contact_id };
        }

        if (name === 'delete_company') {
            var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/companies?id=eq.' + input.company_id, { method: 'DELETE' });
            if (!r.ok) throw new Error('Erreur suppression entreprise: ' + r.status);
            return { success: true, company_id: input.company_id };
        }

        if (name === 'link_contact_company') {
            var data = {
                contact_id: input.contact_id,
                company_id: input.company_id,
                role: input.role || null,
                work_email: input.work_email || null,
                work_phone: input.work_phone || null,
                is_primary_contact: input.is_primary_contact || false
            };
            var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/contact_companies', {
                method: 'POST', headers: { 'Content-Type': 'application/json', 'Prefer': 'return=minimal,resolution=merge-duplicates' },
                body: JSON.stringify(data)
            });
            if (!r.ok) throw new Error('Erreur liaison contact-entreprise: ' + r.status);
            return { success: true };
        }

        return { error: 'Tool inconnu: ' + name };
    }

    // ═══════════════════════════════════════════════════════════════
    // PERMISSION CHECK
    // ═══════════════════════════════════════════════════════════════

    var DEFAULT_PERMISSIONS = {
        'Admin':             { clients: true },
        'Vente':             { clients: true },
        'Charg\u00e9 de projet': { clients: true },
        'Achat':             { clients: false },
        'Atelier':           { clients: false },
        'Client':            { clients: false }
    };
    var DEFAULT_USER_ROLES = { 'hubert@stele.ca': 'Admin' };

    async function checkPageAccess() {
        var email = (localStorage.getItem('sb_user_email') || '').toLowerCase();
        var perms = DEFAULT_PERMISSIONS;
        var roles = DEFAULT_USER_ROLES;
        try {
            var r = await authenticatedFetch(SUPABASE_URL + '/rest/v1/app_config?key=in.(permissions,user_roles)&select=key,value', {});
            if (r.ok) {
                var rows = await r.json();
                for (var i = 0; i < rows.length; i++) {
                    if (rows[i].key === 'permissions') perms = rows[i].value;
                    if (rows[i].key === 'user_roles') roles = rows[i].value;
                }
            }
        } catch (e) { /* use defaults */ }
        var role = roles[email] || 'Client';
        var defaults = DEFAULT_PERMISSIONS[role] || {};
        var saved = perms[role] || {};
        var allowed = {};
        for (var k in defaults) allowed[k] = defaults[k];
        for (var k2 in saved) allowed[k2] = saved[k2];
        if (!allowed.clients) { window.location.href = 'app.html'; return false; }
        return true;
    }

    // ═══════════════════════════════════════════════════════════════
    // INIT
    // ═══════════════════════════════════════════════════════════════

    (async function() {
        if (!(await checkPageAccess())) return;
        await loadConfig();
        await Promise.all([loadContacts(), loadCompanies()]);
        renderContacts();
        renderCompanies();
        updateStatus('online', 'Donn\u00e9es \u00e0 jour');

        // Hash detection: open contact or company modal from deep link
        var hash = window.location.hash;
        if (hash.startsWith('#contact-')) {
            var contactId = hash.substring(9);
            setTimeout(function() { openContactModal(contactId); }, 400);
        } else if (hash.startsWith('#company-')) {
            var companyId = hash.substring(9);
            setTimeout(function() { switchTab('companies'); openCompanyModal(companyId); }, 400);
        }
    })();
    </script>

<!-- AI Chat Drawer -->
<div class="ct-drawer-overlay" id="ctOverlay" onclick="closeCtDrawer()"></div>
<div class="ct-drawer" id="ctDrawer">
    <div class="ct-drawer-header">
        <h3>Assistant Scopewright</h3>
        <button class="ct-drawer-close" onclick="closeCtDrawer()">&times;</button>
    </div>
    <div class="ct-messages" id="ctMessages"></div>
    <div class="ct-typing" id="ctTyping">
        <div class="ct-typing-dot"></div>
        <div class="ct-typing-dot"></div>
        <div class="ct-typing-dot"></div>
    </div>
    <div class="ct-quick-actions" id="ctQuickActions">
        <button class="ct-quick-btn" onclick="ctQuickAction('Voici un screenshot de mon carnet d\'adresses')">Carnet d'adresses</button>
        <button class="ct-quick-btn" onclick="ctQuickAction('Voici des cartes d\'affaires')">Cartes d'affaires</button>
        <button class="ct-quick-btn" onclick="ctQuickAction('Je veux ajouter ces contacts :')">Liste manuelle</button>
    </div>
    <div class="ct-img-preview" id="ctImgPreview"></div>
    <div class="ct-input-area" style="position:relative;">
        <div class="ct-drop-zone" id="ctDropZone">D&eacute;posez une image ici</div>
        <textarea id="ctInput" placeholder="Collez un screenshot ou d&eacute;crivez les contacts..." rows="1" onkeydown="ctInputKeydown(event)"></textarea>
        <button class="ct-send-btn" id="ctSendBtn" onclick="sendCtMessage()" title="Envoyer">&uarr;</button>
    </div>
</div>

</body>
</html>
