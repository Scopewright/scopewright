<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soumission — Stele</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --stele-black: #0A0203;
            --stele-green: #4b6050;
            --stele-gray: #C8C8C8;
            --stele-light-gray: #F8F8F8;
            --stele-white: #FFFFFF;
        }

        html, body {
            min-height: 100vh;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: #fff;
            color: var(--stele-black);
            line-height: 1.5;
            scroll-snap-type: y mandatory;
            overflow-y: scroll;
        }

        /* ── Layout ── */
        .quote-page-wrapper {
            margin: 0 auto;
            padding: 0;
        }

        /* ── Loading / Error states ── */
        .state-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            text-align: center;
        }

        .spinner {
            width: 48px; height: 48px;
            border: 4px solid var(--stele-gray);
            border-top-color: var(--stele-green);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .state-screen h2 { font-size: 20px; font-weight: 600; margin-bottom: 8px; }
        .state-screen p { font-size: 15px; opacity: 0.7; }

        .error-icon {
            width: 56px; height: 56px;
            border-radius: 50%;
            background: #f44336;
            color: #fff;
            display: flex; align-items: center; justify-content: center;
            font-size: 28px; font-weight: 700;
            margin-bottom: 16px;
        }

        /* ── Pages container ── */
        .quote-pages {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        /* ── Landscape pages (11 × 8.5 in) — fullscreen presentation ── */
        .pv-page {
            background: #fff;
            padding: 36px 48px;
            scroll-snap-align: start;
            height: 100vh;
            max-height: 100vh;
            width: calc(100vh * 11 / 8.5);
            max-width: 100vw;
            margin: 0 auto;
            box-sizing: border-box;
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* Title page — split 50/50 */
        .pv-page-title { flex-direction: row; padding: 0; align-items: stretch; }
        .pv-cover-left {
            flex: 1; display: flex; flex-direction: column; justify-content: center;
            padding: 48px 52px; background: #F7F8FA; text-align: left; position: relative;
        }
        .pv-cover-left .pv-logo { height: 56px; margin-bottom: 40px; align-self: flex-start; }
        .pv-cover-left .pv-project-name { font-size: 26px; font-weight: 600; color: var(--stele-black); line-height: 1.25; margin-bottom: 8px; }
        .pv-cover-left .pv-client-name { font-size: 17px; font-weight: 400; color: #444; margin-bottom: 4px; }
        .pv-cover-left .pv-client-address { font-size: 14px; color: #888; margin-bottom: 0; line-height: 1.5; }
        .pv-cover-left .pv-cover-divider { width: 40px; height: 2px; background: var(--stele-green); margin: 24px 0; }
        .pv-cover-left .pv-sub-number { font-size: 14px; font-weight: 600; color: var(--stele-green); margin-bottom: 4px; letter-spacing: 0.02em; }
        .pv-cover-left .pv-sub-date { font-size: 13px; color: #999; }
        .pv-cover-right {
            flex: 1; background: #0B0F17; overflow: hidden; position: relative;
        }
        .pv-cover-right img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .pv-cover-right .pv-cover-overlay {
            position: absolute; inset: 0; background: linear-gradient(135deg, rgba(15,23,42,0.15) 0%, rgba(15,23,42,0.35) 100%);
        }

        /* Installation non incluse — indicators */
        .pv-install-banner { position: absolute; bottom: 20px; left: 0; right: 50%; text-align: center; font-size: 11px; color: #999; letter-spacing: 0.3px; }
        .pv-install-room-note { font-size: 11px; color: #999; font-style: italic; margin-top: -30px; margin-bottom: 20px; padding-left: 20px; }
        .pv-install-total-note { font-size: 13px; color: #999; margin-bottom: 16px; letter-spacing: 0.3px; }

        /* Room page — landscape layout */
        .pv-page-room-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 20px; background: var(--stele-green); color: #fff;
            border-radius: 4px; margin-bottom: 38px; flex-shrink: 0;
        }
        .pv-page-room-name { font-size: 17px; font-weight: 600; letter-spacing: 0.3px; }
        .pv-page-room-subtotal { font-size: 17px; font-weight: 700; }
        .pv-page-room-body { flex: 1; display: flex; gap: 38px; overflow: hidden; min-height: 0; }
        .pv-page-room-text { flex: 1; display: flex; flex-direction: column; overflow: hidden; justify-content: center; }
        .pv-page-room-media {
            flex: 1; display: grid; grid-template-columns: repeat(2, 1fr);
            gap: 8px; align-content: center; max-height: 100%;
        }
        .pv-page-room-media.imgs-1 { grid-template-columns: 1fr; }
        .pv-page-room-media.imgs-2 { grid-template-columns: 1fr; gap: 38px; }
        .pv-page-room-media.imgs-3 { gap: 8px; }
        .pv-page-room-media.imgs-3 .pv-img-wrap:first-child { grid-column: 1 / -1; }
        .pv-img-wrap { position: relative; border-radius: 4px; overflow: hidden; min-height: 0; }
        .pv-img-wrap img {
            width: 100%; height: 100%; object-fit: cover; display: block; cursor: pointer;
        }

        /* Room description — client mode (no edit borders) */
        .pv-page-room-desc {
            font-size: 13px; line-height: 1.5; color: #444;
            font-family: inherit; white-space: normal; word-wrap: break-word;
            border-color: transparent; background: transparent; padding: 0;
            flex: initial; min-height: auto;
        }
        .pv-page-room-desc p { margin: 0 0 6px 0; }
        .pv-page-room-desc ul { margin: 4px 0 8px 0; padding-left: 20px; }
        .pv-page-room-desc li { margin-bottom: 2px; }
        .pv-page-room-desc strong { font-weight: 700; }

        /* Clauses page */
        .pv-page-clauses-header {
            font-size: 12px; text-transform: uppercase; letter-spacing: 1px;
            color: var(--stele-green); font-weight: 700; margin-bottom: 14px;
            padding-bottom: 6px; border-bottom: 2px solid var(--stele-green);
        }
        .pv-page-clauses-body { flex: 1; overflow: hidden; }
        .pv-page-clause {
            margin-bottom: 8px; padding: 6px 14px;
            border: 1px solid #e0e0e0;
            border-left: 3px solid var(--stele-green);
            border-radius: 0 3px 3px 0;
        }
        .pv-page-clause-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 2px; }
        .pv-page-clause-text { font-size: 12px; line-height: 1.3; color: #555; }

        /* Total page */
        .pv-page-total { justify-content: center; align-items: center; text-align: center; }
        .pv-total-box {
            padding: 36px 56px; background: var(--stele-black); color: #fff; border-radius: 6px;
        }
        .pv-total-box .total-label { font-size: 16px; font-weight: 300; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 10px; opacity: 0.8; }
        .pv-total-box .total-amount { font-size: 42px; font-weight: 700; }
        .pv-total-box .total-taxes { font-size: 13px; opacity: 0.6; margin-top: 6px; }
        .pv-page-footer-text { margin-top: 32px; font-size: 12px; color: #aaa; letter-spacing: 0.5px; }

        /* Steps page */
        .pv-page-steps { padding: 32px 48px; }
        .pv-steps-title {
            font-size: 12px; text-transform: uppercase; letter-spacing: 1px;
            color: var(--stele-green); font-weight: 700; margin-bottom: 20px;
            padding-bottom: 6px; border-bottom: 2px solid var(--stele-green);
        }
        .pv-steps-grid {
            flex: 1; display: grid; grid-template-columns: 1fr 1fr;
            grid-template-rows: repeat(4, 1fr); gap: 10px 48px;
            grid-auto-flow: column;
        }
        .pv-step { display: flex; gap: 16px; align-items: flex-start; }
        .pv-step-circle {
            width: 64px; height: 64px; min-width: 64px; border-radius: 50%;
            color: #fff; display: flex; align-items: center; justify-content: center;
            font-size: 24px; font-weight: 700; margin-top: 2px;
        }
        .pv-step-content { flex: 1; min-width: 0; }
        .pv-step-label {
            font-size: 12px; font-weight: 700; text-transform: uppercase;
            letter-spacing: 0.3px; color: var(--stele-black); margin-bottom: 4px;
        }
        .pv-step-desc { font-size: 11px; line-height: 1.45; color: #555; }

        /* ── Acceptance section ── */
        .acceptance-section {
            scroll-snap-align: start;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 28px;
            background: var(--stele-white);
            text-align: center;
        }

        .acceptance-section h2 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--stele-black);
        }

        .acceptance-subtitle {
            font-size: 14px;
            opacity: 0.6;
            margin-bottom: 24px;
        }

        .acceptance-form {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 14px;
            max-width: 380px;
            margin: 0 auto;
        }

        .acceptance-form input {
            width: 100%;
            padding: 12px 14px;
            font-size: 15px;
            font-family: inherit;
            border: 1px solid rgba(0,0,0,0.15);
            border-radius: 3px;
            background: var(--stele-light-gray);
        }

        .acceptance-form input:focus {
            outline: none;
            border-color: var(--stele-green);
            box-shadow: 0 0 0 2px rgba(75, 96, 80, 0.15);
        }

        .btn-accept {
            width: 100%;
            padding: 14px;
            font-size: 16px;
            font-weight: 600;
            font-family: inherit;
            background: var(--stele-green);
            color: var(--stele-white);
            border: none;
            border-radius: 3px;
            cursor: pointer;
            transition: background 0.2s;
            margin-top: 4px;
        }

        .btn-accept:hover { background: #3d5043; }
        .btn-accept:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ── Signature pad ── */
        .signature-block {
            width: 100%;
            margin-top: 4px;
        }

        .signature-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            color: var(--stele-green);
            font-weight: 600;
            margin-bottom: 6px;
            text-align: left;
        }

        .signature-canvas-wrap {
            position: relative;
            width: 100%;
            border: 1px solid rgba(0,0,0,0.15);
            border-radius: 3px;
            background: #fff;
        }

        .signature-canvas {
            display: block;
            width: 100%;
            height: 140px;
            cursor: crosshair;
            touch-action: none;
        }

        .signature-placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px;
            color: #bbb;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .signature-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 4px;
        }

        .btn-clear-sig {
            background: none;
            border: none;
            font-size: 12px;
            color: #999;
            cursor: pointer;
            font-family: inherit;
            padding: 2px 0;
        }

        .btn-clear-sig:hover { color: var(--stele-black); }

        /* ── Accepted confirmation ── */
        .accepted-banner {
            scroll-snap-align: start;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 28px;
            background: var(--stele-white);
            text-align: center;
        }

        .accepted-banner .check-icon {
            width: 56px; height: 56px;
            border-radius: 50%;
            background: #4CAF50;
            color: #fff;
            display: inline-flex; align-items: center; justify-content: center;
            font-size: 28px;
            margin-bottom: 12px;
        }

        .accepted-banner h2 {
            font-size: 20px;
            font-weight: 600;
            color: #2E7D32;
            margin-bottom: 4px;
        }

        .accepted-banner p {
            font-size: 14px;
            color: #555;
        }

        /* ── Lightbox ── */
        .lightbox-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .lightbox-overlay.active {
            display: flex;
        }

        .lightbox-img {
            max-width: 90vw;
            max-height: 90vh;
            border-radius: 4px;
            box-shadow: 0 8px 40px rgba(0,0,0,0.5);
        }

        .lightbox-close {
            position: absolute;
            top: 20px; right: 24px;
            background: none;
            border: none;
            color: #fff;
            font-size: 36px;
            cursor: pointer;
            line-height: 1;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .lightbox-close:hover { opacity: 1; }

        /* ── Fullscreen button ── */
        .btn-fullscreen {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
            background: var(--stele-green);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s, transform 0.2s;
            opacity: 0.7;
        }
        .btn-fullscreen:hover { opacity: 1; transform: scale(1.1); }

        /* ── Footer ── */
        .quote-footer {
            display: none;
        }

        /* ── Responsive ── */
        @media (max-width: 768px) {
            .quote-page-wrapper { padding: 0; }
            .pv-page { padding: 20px 24px; width: 100vw; }
            .pv-page-room-body { flex-direction: column; gap: 16px; }
            .pv-page-room-media { grid-template-columns: 1fr 1fr; }
            .pv-steps-grid { grid-template-columns: 1fr; grid-auto-flow: row; }
            .pv-step-circle { width: 48px; height: 48px; min-width: 48px; font-size: 18px; }
            .pv-page-title .pv-client-name { font-size: 22px; }
            .pv-page-title .pv-sub-number { font-size: 18px; }
            .pv-total-box .total-amount { font-size: 28px; }
        }

        /* ── Print ── */
        @media print {
            html, body { background: #fff; }
            .quote-page-wrapper { padding: 0; max-width: 100%; }
            .pv-page {
                break-inside: avoid;
                box-shadow: none;
                border: 1px solid #eee;
                page-break-after: always;
            }
            .acceptance-section,
            .accepted-banner,
            .quote-footer { display: none; }
            .pv-page-room-header, .pv-total-box, .pv-step-circle {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
    </style>
</head>
<body>

<!-- ════════════════════════════════════════════ -->
<!-- LOADING STATE                                -->
<!-- ════════════════════════════════════════════ -->
<div class="quote-page-wrapper">
    <div id="loadingState" class="state-screen">
        <div class="spinner"></div>
        <h2>Chargement de la soumission...</h2>
        <p>Veuillez patienter</p>
    </div>

    <div id="errorState" class="state-screen" style="display:none;">
        <div class="error-icon">!</div>
        <h2 id="errorTitle">Lien invalide</h2>
        <p id="errorMessage">Ce lien de soumission est invalide ou a expiré.</p>
    </div>

    <!-- ════════════════════════════════════════ -->
    <!-- QUOTE CONTENT (hidden until loaded)      -->
    <!-- ════════════════════════════════════════ -->
    <div id="quoteContent" style="display:none;">

        <!-- Pages container (landscape pages) -->
        <div class="quote-pages" id="quotePages"></div>

        <!-- Acceptance form (hidden when already accepted) -->
        <div class="acceptance-section" id="acceptanceSection">
            <h2>Accepter cette soumission</h2>
            <p class="acceptance-subtitle">Veuillez entrer vos informations pour confirmer votre acceptation.</p>
            <div class="acceptance-form">
                <input type="text" id="acceptName" placeholder="Votre nom complet" required>
                <input type="email" id="acceptEmail" placeholder="Votre courriel" required>
                <div class="signature-block">
                    <div class="signature-label">Signature</div>
                    <div class="signature-canvas-wrap">
                        <canvas class="signature-canvas" id="signatureCanvas"></canvas>
                        <span class="signature-placeholder" id="sigPlaceholder">Dessinez votre signature ici</span>
                    </div>
                    <div class="signature-actions">
                        <button type="button" class="btn-clear-sig" onclick="clearSignature()">Effacer</button>
                    </div>
                </div>
                <button class="btn-accept" id="btnAccept" onclick="acceptQuote()">Accepter la soumission</button>
            </div>
        </div>

        <!-- Already accepted banner -->
        <div class="accepted-banner" id="acceptedBanner" style="display:none;">
            <div class="check-icon">&#10003;</div>
            <h2>Soumission acceptée</h2>
            <p id="acceptedInfo"></p>
        </div>

        <!-- Footer -->
        <div class="quote-footer">
            Stele &mdash; Ébénisterie sur mesure
        </div>
    </div>
</div>

<!-- Fullscreen toggle -->
<button class="btn-fullscreen" id="btnFullscreen" onclick="toggleFullscreen()" title="Plein écran">&#x26F6;</button>

<!-- Lightbox -->
<div class="lightbox-overlay" id="lightbox" onclick="closeLightbox()">
    <button class="lightbox-close" onclick="closeLightbox()">&times;</button>
    <img class="lightbox-img" id="lightboxImg" src="" alt="">
</div>

<script>
// ═══════════════════════════════════════════════════════════════════════
// CONFIG
// ═══════════════════════════════════════════════════════════════════════

const SUPABASE_URL = 'https://rplzbtjfnwahqodrhpny.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJwbHpidGpmbndhaHFvZHJocG55Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NDU2MDEsImV4cCI6MjA4NjIyMTYwMX0.OQAZhc029PbRDSe1b02NDAuOUE8yn-_h3QqSnUDpLeU';

// Steps data (same as calculateur.html)
var STEPS = [
    { label: 'Conception', desc: '\u00c0 cette \u00e9tape, nous veillerons \u00e0 rassembler toutes les informations n\u00e9cessaires au bon d\u00e9roulement du projet. Cela inclut le choix des poign\u00e9es, l\u2019approbation des mat\u00e9riaux, ainsi que l\u2019\u00e9tude des d\u00e9fis sp\u00e9cifiques au projet. Nous rassemblerons \u00e9galement les fiches techniques des \u00e9lectrom\u00e9nagers et validerons l\u2019\u00e9ch\u00e9ancier avec le client et l\u2019entrepreneur.' },
    { label: 'Prise de mesure initiale', desc: 'Typiquement, cette prise de mesures s\u2019effectue sur les colombages et le plancher non fini. Nous tiendrons compte de l\u2019\u00e9paisseur du rev\u00eatement de sol et des murs pr\u00e9vus afin d\u2019\u00e9laborer nos dessins.' },
    { label: 'Approbation des dessins d\u2019atelier', desc: 'Suite \u00e0 notre premi\u00e8re prise de mesures, les dessins d\u2019atelier vous seront remis pour approbation. Une fois ces dessins approuv\u00e9s, aucune modification ne pourra y \u00eatre apport\u00e9e.' },
    { label: 'Commande de mat\u00e9riaux', desc: 'Comme nous prenons en compte les \u00e9paisseurs de rev\u00eatement lors de notre prise de mesures sur l\u2019ossature brute, nous sommes en mesure de commander les mat\u00e9riaux, tels que les placages de bois et la quincaillerie sp\u00e9ciale, afin d\u2019\u00e9viter tout d\u00e9lai lors de la mise en production.' },
    { label: 'Prise de mesure finale', desc: 'La prise de mesures finale s\u2019effectue une fois le plancher fini et les joints ainsi que les coins de fer pos\u00e9s. Apr\u00e8s cette prise de mesures, un d\u00e9lai de 6 semaines est n\u00e9cessaire avant le d\u00e9but de l\u2019installation.' },
    { label: 'Dessins d\u2019atelier pour production', desc: 'Comme nous avons pr\u00e9alablement ajust\u00e9 la prise de mesures initiale pour qu\u2019elle soit presque conforme au r\u00e9sultat final, les ajustements \u00e0 ce stade sont mineurs. Sauf en cas de changement majeur, les dessins d\u2019atelier ne vous seront pas renvoy\u00e9s pour approbation \u00e0 cette \u00e9tape.' },
    { label: 'Installation', desc: 'La dur\u00e9e de cette \u00e9tape varie en fonction de l\u2019ampleur du projet, mais elle marque un moment cl\u00e9\u00a0: celui o\u00f9 votre vision prend forme. Il ne restera plus que notre mobilier, pr\u00eat \u00e0 s\u2019int\u00e9grer dans votre quotidien et \u00e0 accompagner vos plus beaux moments \u00e0 la maison.' },
    { label: 'Contr\u00f4le de qualit\u00e9', desc: 'Une fois l\u2019installation termin\u00e9e, un repr\u00e9sentant Stele effectuera une visite avec vous pour \u00e9tablir ensemble une liste unique d\u2019ajustements, si n\u00e9cessaire. Stele pr\u00e9parera ensuite tout le n\u00e9cessaire et, lors d\u2019une seule visite suppl\u00e9mentaire, apportera les ajustements n\u00e9cessaires pour garantir un r\u00e9sultat final \u00e0 la hauteur de vos attentes.' }
];
var STEP_COLORS = ['#2f3e34','#3a4b3f','#45584a','#4b6050','#5e7462','#718874','#849c86','#97b098'];

// ═══════════════════════════════════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════════════════════════════════

let quoteData = null;
let currentToken = null;
var coverImageUrl = '';

(async function init() {
    // Extract token from URL
    const params = new URLSearchParams(window.location.search);
    currentToken = params.get('token');

    if (!currentToken) {
        showError('Lien invalide', 'Aucun jeton de soumission trouvé dans le lien.');
        return;
    }

    try {
        const resp = await fetch(SUPABASE_URL + '/rest/v1/rpc/get_public_quote', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY
            },
            body: JSON.stringify({ p_token: currentToken })
        });

        if (!resp.ok) {
            const errText = await resp.text();
            console.error('RPC error:', resp.status, errText);
            showError('Erreur', 'Impossible de charger la soumission. Veuillez réessayer plus tard.');
            return;
        }

        quoteData = await resp.json();

        if (!quoteData || quoteData.error) {
            showError('Lien invalide', quoteData?.error || 'Ce lien de soumission est invalide ou a expiré.');
            return;
        }

        // Load cover image from app_config (anon read)
        try {
            var ciResp = await fetch(SUPABASE_URL + '/rest/v1/app_config?key=eq.cover_image&select=value', {
                headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
            });
            if (ciResp.ok) {
                var ciRows = await ciResp.json();
                if (ciRows.length > 0 && ciRows[0].value) coverImageUrl = ciRows[0].value;
            }
        } catch (e) { /* fallback to dark bg */ }

        await renderQuote();
        initSignaturePad();
    } catch (err) {
        console.error('Fetch error:', err);
        showError('Erreur de connexion', 'Impossible de joindre le serveur. Vérifiez votre connexion internet.');
    }
})();

// ═══════════════════════════════════════════════════════════════════════
// RENDER
// ═══════════════════════════════════════════════════════════════════════

async function renderQuote() {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('quoteContent').style.display = 'block';

    var sub = quoteData.submission;
    var proj = quoteData.project;
    var rooms = quoteData.rooms || [];
    var token = quoteData.token;

    // Load room_media for all rooms (new Storage-based images)
    var roomMediaMap = {};
    try {
        var roomIds = rooms.map(function(r) { return r.id; }).filter(Boolean);
        if (roomIds.length > 0) {
            var mediaResp = await fetch(SUPABASE_URL + '/rest/v1/room_media?room_id=in.(' + roomIds.join(',') + ')&order=sort_order.asc', {
                headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
            });
            if (mediaResp.ok) {
                var allMedia = await mediaResp.json();
                allMedia.forEach(function(m) {
                    if (!roomMediaMap[m.room_id]) roomMediaMap[m.room_id] = [];
                    roomMediaMap[m.room_id].push(m);
                });
            }
        }
    } catch (e) { console.error('Load room_media error:', e); }

    // Title
    document.title = 'Soumission #' + sub.submission_number + ' — Stele';

    var html = '';
    var grandTotal = 0;

    // ── PAGE 1: Title ──
    var subDate = formatDate(sub.sent_at || sub.approved_at || new Date().toISOString());
    var acceptanceProofHtml = '';
    if (token.accepted_at || sub.accepted_at) {
        acceptanceProofHtml += '<div style="position:absolute;top:10px;left:20px;background:#e8f5e9;border:1px solid var(--stele-green);border-radius:8px;padding:12px 16px;max-width:320px;font-size:11px;line-height:1.6;z-index:1;text-align:left;">';
        acceptanceProofHtml += '<div style="font-weight:700;font-size:13px;color:var(--stele-green);margin-bottom:6px;">Soumission accept\u00e9e</div>';
        if (token.client_name) acceptanceProofHtml += '<div><strong>Nom :</strong> ' + escapeHtml(token.client_name) + '</div>';
        if (token.client_email) acceptanceProofHtml += '<div><strong>Courriel :</strong> ' + escapeHtml(token.client_email) + '</div>';
        var acceptedDate = token.accepted_at || sub.accepted_at;
        if (acceptedDate) acceptanceProofHtml += '<div><strong>Date :</strong> ' + new Date(acceptedDate).toLocaleString('fr-CA') + '</div>';
        if (token.signature_data) acceptanceProofHtml += '<div style="margin-top:8px;"><img src="' + token.signature_data + '" style="max-width:200px;border:1px solid #ccc;border-radius:4px;" alt="Signature"></div>';
        acceptanceProofHtml += '</div>';
    }
    // Build address from new columns with fallback
    var coverAddrParts = [];
    var projAddr = proj.project_address || proj.client_address || '';
    var projCity = proj.project_city || '';
    var projPostal = proj.project_postal_code || '';
    if (projAddr) coverAddrParts.push(escapeHtml(projAddr));
    if (projCity) coverAddrParts.push(escapeHtml(projCity));
    if (projPostal) coverAddrParts.push(escapeHtml(projPostal));
    var coverAddr = coverAddrParts.join(', ');

    // Pre-scan installation status
    var installExcludedIds = {};
    var totalRooms = rooms.length;
    rooms.forEach(function(r) { if (r.installation_included === false) installExcludedIds[r.id] = true; });
    var excludedCount = Object.keys(installExcludedIds).length;
    var allInstallExcluded = totalRooms > 0 && excludedCount === totalRooms;
    var someInstallExcluded = excludedCount > 0 && !allInstallExcluded;

    html += '<div class="pv-page pv-page-title">';
    html += '<div class="pv-cover-left">';
    html += acceptanceProofHtml;
    html += '<img class="pv-logo" src="https://rplzbtjfnwahqodrhpny.supabase.co/storage/v1/object/public/assets/stele_logo_noir.png" alt="Stele">';
    if (proj.name) html += '<div class="pv-project-name">' + escapeHtml(proj.name) + '</div>';
    if (proj.client_name) html += '<div class="pv-client-name">' + escapeHtml(proj.client_name) + '</div>';
    if (coverAddr) html += '<div class="pv-client-address">' + coverAddr + '</div>';
    html += '<div class="pv-cover-divider"></div>';
    html += '<div class="pv-sub-number">Soumission #' + escapeHtml(sub.submission_number + '') + '</div>';
    if (subDate) html += '<div class="pv-sub-date">' + escapeHtml(subDate) + '</div>';
    if (allInstallExcluded) html += '<div class="pv-install-banner">Installation non incluse</div>';
    html += '</div>';
    html += '<div class="pv-cover-right">';
    if (coverImageUrl) {
        html += '<img src="' + escapeAttr(coverImageUrl) + '" alt="">';
        html += '<div class="pv-cover-overlay"></div>';
    }
    html += '</div>';
    html += '</div>';

    // ── Room pages (one per room) — text left, images right ──
    rooms.forEach(function(room) {
        var subtotal = parseFloat(room.subtotal) || 0;
        grandTotal += subtotal;

        // Collect images: new room_media + legacy Base64
        var allImages = [];
        var mediaImages = roomMediaMap[room.id] || [];
        mediaImages.forEach(function(m) {
            if ((m.tags || ['presentation_soumission']).indexOf('presentation_soumission') !== -1) {
                allImages.push({
                    src: m.cropped_url,
                    name: (m.cropped_url || '').split('/').pop() || 'image.jpg',
                    cropRatio: m.crop_ratio || '16:9'
                });
            }
        });
        var legacyImages = (room.images || []).filter(function(img) { return img.showInQuote; });
        legacyImages.forEach(function(img) {
            allImages.push({ src: img.dataUrl, name: img.name || 'Image', cropRatio: '16:9' });
        });

        var hasImages = allImages.length > 0;
        var desc = room.client_description || '';

        html += '<div class="pv-page">';
        html += '<div class="pv-page-room-header">';
        html += '<span class="pv-page-room-name">' + escapeHtml(room.name) + '</span>';
        html += '<span class="pv-page-room-subtotal">' + formatMoney(subtotal) + '</span>';
        html += '</div>';
        if (someInstallExcluded && installExcludedIds[room.id]) {
            html += '<div class="pv-install-room-note">* Installation non incluse pour cette section</div>';
        }
        html += '<div class="pv-page-room-body">';

        // Left column: description
        if (hasImages) {
            html += '<div class="pv-page-room-text">';
            html += '<div class="pv-page-room-desc">';
            html += textToHtml(desc);
            html += '</div>';
            html += '</div>';

            // Right column: images grid
            var imgCount = Math.min(allImages.length, 4);
            html += '<div class="pv-page-room-media imgs-' + imgCount + '">';
            allImages.slice(0, 4).forEach(function(img) {
                var ratio = img.cropRatio === '1:1' ? '1/1' : img.cropRatio === '9:16' ? '9/16' : '16/9';
                html += '<div class="pv-img-wrap">';
                html += '<img src="' + img.src + '" alt="' + escapeHtml(img.name) + '"';
                html += ' style="aspect-ratio:' + ratio + ';"';
                html += ' onclick="openLightbox(this.src)">';
                html += '</div>';
            });
            html += '</div>';
        } else {
            // No images — description takes full width
            html += '<div class="pv-page-room-text" style="flex:1;">';
            html += '<div class="pv-page-room-desc">';
            html += textToHtml(desc);
            html += '</div>';
            html += '</div>';
        }

        html += '</div></div>';
    });

    // ── Clauses page ──
    var clauses = sub.clauses || [];
    if (clauses.length > 0) {
        html += '<div class="pv-page">';
        html += '<div class="pv-page-clauses-header">Clauses du contrat</div>';
        html += '<div class="pv-page-clauses-body">';
        clauses.forEach(function(clause) {
            html += '<div class="pv-page-clause">';
            html += '<div class="pv-page-clause-title">' + escapeHtml(clause.title) + '</div>';
            html += '<div class="pv-page-clause-text">' + escapeHtml(clause.content || '') + '</div>';
            html += '</div>';
        });
        html += '</div></div>';
    }

    // ── Total page ──
    var totalToShow = sub.approved_total ? parseFloat(sub.approved_total) : grandTotal;
    html += '<div class="pv-page pv-page-total">';
    if (allInstallExcluded) {
        html += '<div class="pv-install-total-note">Installation non incluse</div>';
    }
    html += '<div class="pv-total-box">';
    html += '<div class="total-label">Total</div>';
    html += '<div class="total-amount">' + formatMoney(totalToShow) + '</div>';
    html += '<div class="total-taxes">+ taxes applicables</div>';
    html += '</div>';
    html += '<div class="pv-page-footer-text">Stele \u2014 \u00c9b\u00e9nisterie sur mesure</div>';
    html += '</div>';

    // ── Steps page ──
    html += '<div class="pv-page pv-page-steps">';
    html += '<div class="pv-steps-title">\u00c9tapes d\u2019un projet type</div>';
    html += '<div class="pv-steps-grid">';
    STEPS.forEach(function(step, i) {
        html += '<div class="pv-step">';
        html += '<div class="pv-step-circle" style="background:' + STEP_COLORS[i] + '">' + (i + 1) + '</div>';
        html += '<div class="pv-step-content">';
        html += '<div class="pv-step-label">' + escapeHtml(step.label) + '</div>';
        html += '<div class="pv-step-desc">' + escapeHtml(step.desc) + '</div>';
        html += '</div></div>';
    });
    html += '</div></div>';

    // ── Inject all pages ──
    document.getElementById('quotePages').innerHTML = html;

    // ── Acceptance state ──
    if (token.accepted_at || sub.accepted_at) {
        document.getElementById('acceptanceSection').style.display = 'none';
        document.getElementById('acceptedBanner').style.display = 'block';
        var acceptedDate = token.accepted_at || sub.accepted_at;
        var acceptedName = token.client_name || '';
        var info = 'Acceptée le ' + formatDate(acceptedDate);
        if (acceptedName) info += ' par ' + acceptedName;
        document.getElementById('acceptedInfo').textContent = info;
    }

    // Pre-fill acceptance form with project client info
    if (proj.client_name) {
        document.getElementById('acceptName').value = proj.client_name;
    }
    if (proj.client_email) {
        document.getElementById('acceptEmail').value = proj.client_email;
    }
}

// ═══════════════════════════════════════════════════════════════════════
// ACCEPT QUOTE
// ═══════════════════════════════════════════════════════════════════════

async function acceptQuote() {
    var name = document.getElementById('acceptName').value.trim();
    var email = document.getElementById('acceptEmail').value.trim();

    if (!name) {
        document.getElementById('acceptName').focus();
        return;
    }
    if (!email) {
        document.getElementById('acceptEmail').focus();
        return;
    }

    if (!sigHasDrawn) {
        alert('Veuillez dessiner votre signature.');
        return;
    }

    var signatureData = document.getElementById('signatureCanvas').toDataURL('image/png');

    var btn = document.getElementById('btnAccept');
    btn.disabled = true;
    btn.textContent = 'Traitement en cours...';

    try {
        var resp = await fetch(SUPABASE_URL + '/rest/v1/rpc/accept_quote', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY
            },
            body: JSON.stringify({
                p_token: currentToken,
                p_name: name,
                p_email: email,
                p_signature: signatureData
            })
        });

        var respText = await resp.text();
        console.log('accept_quote response:', resp.status, respText);

        if (!resp.ok) {
            btn.disabled = false;
            btn.textContent = 'Accepter la soumission';
            alert('Erreur ' + resp.status + ' : ' + respText);
            return;
        }

        // Parse JSON (may be empty for void functions)
        var result = null;
        if (respText && respText.trim()) {
            try { result = JSON.parse(respText); } catch(e) { /* not JSON, that's ok */ }
        }

        if (result && result.error) {
            btn.disabled = false;
            btn.textContent = 'Accepter la soumission';
            alert(result.error);
            return;
        }

        // Success — show accepted banner
        document.getElementById('acceptanceSection').style.display = 'none';
        document.getElementById('acceptedBanner').style.display = 'block';
        document.getElementById('acceptedInfo').textContent =
            'Acceptée le ' + formatDate(new Date().toISOString()) + ' par ' + name;

    } catch (err) {
        console.error('Accept fetch error:', err);
        btn.disabled = false;
        btn.textContent = 'Accepter la soumission';
        alert('Erreur de connexion : ' + err.message);
    }
}

// ═══════════════════════════════════════════════════════════════════════
// SIGNATURE PAD
// ═══════════════════════════════════════════════════════════════════════

var sigCanvas, sigCtx, sigDrawing = false, sigHasDrawn = false;

function initSignaturePad() {
    sigCanvas = document.getElementById('signatureCanvas');
    if (!sigCanvas) return;
    sigCtx = sigCanvas.getContext('2d');

    // Set canvas internal resolution to match display size
    function resizeCanvas() {
        var rect = sigCanvas.getBoundingClientRect();
        sigCanvas.width = rect.width * 2;
        sigCanvas.height = rect.height * 2;
        sigCtx.scale(2, 2);
        sigCtx.lineCap = 'round';
        sigCtx.lineJoin = 'round';
        sigCtx.lineWidth = 2;
        sigCtx.strokeStyle = '#000';
        if (sigHasDrawn) {
            sigHasDrawn = false;
            document.getElementById('sigPlaceholder').style.opacity = '1';
        }
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    // Mouse events
    sigCanvas.addEventListener('mousedown', sigStart);
    sigCanvas.addEventListener('mousemove', sigMove);
    sigCanvas.addEventListener('mouseup', sigEnd);
    sigCanvas.addEventListener('mouseleave', sigEnd);

    // Touch events
    sigCanvas.addEventListener('touchstart', function(e) {
        e.preventDefault();
        sigStart(e.touches[0]);
    }, { passive: false });
    sigCanvas.addEventListener('touchmove', function(e) {
        e.preventDefault();
        sigMove(e.touches[0]);
    }, { passive: false });
    sigCanvas.addEventListener('touchend', function(e) {
        e.preventDefault();
        sigEnd();
    });
}

function sigGetPos(e) {
    var rect = sigCanvas.getBoundingClientRect();
    return { x: e.clientX - rect.left, y: e.clientY - rect.top };
}

function sigStart(e) {
    sigDrawing = true;
    var pos = sigGetPos(e);
    sigCtx.beginPath();
    sigCtx.moveTo(pos.x, pos.y);
    if (!sigHasDrawn) {
        sigHasDrawn = true;
        document.getElementById('sigPlaceholder').style.opacity = '0';
    }
}

function sigMove(e) {
    if (!sigDrawing) return;
    var pos = sigGetPos(e);
    sigCtx.lineTo(pos.x, pos.y);
    sigCtx.stroke();
}

function sigEnd() {
    sigDrawing = false;
}

function clearSignature() {
    if (!sigCtx) return;
    sigCtx.clearRect(0, 0, sigCanvas.width, sigCanvas.height);
    sigHasDrawn = false;
    document.getElementById('sigPlaceholder').style.opacity = '1';
}

// ═══════════════════════════════════════════════════════════════════════
// LIGHTBOX
// ═══════════════════════════════════════════════════════════════════════

function openLightbox(src) {
    document.getElementById('lightboxImg').src = src;
    document.getElementById('lightbox').classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeLightbox() {
    document.getElementById('lightbox').classList.remove('active');
    document.body.style.overflow = '';
}

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') { closeLightbox(); return; }
    var pages = document.querySelectorAll('.pv-page');
    if (pages.length === 0) return;

    if (e.key === 'ArrowDown' || e.key === 'Enter' || e.key === ' ' || e.key === 'ArrowRight') {
        e.preventDefault();
        presScrollToNext(pages, 1);
    }
    if (e.key === 'ArrowUp' || e.key === 'Backspace' || e.key === 'ArrowLeft') {
        e.preventDefault();
        presScrollToNext(pages, -1);
    }
});

document.addEventListener('click', function(e) {
    if (e.target.closest('button, a, input, canvas, .pv-img-wrap, .acceptance-form, .lightbox-overlay')) return;
    var pages = document.querySelectorAll('.pv-page');
    if (pages.length > 0) presScrollToNext(pages, 1);
});

function presScrollToNext(pages, direction) {
    var scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
    var threshold = 20;
    for (var i = 0; i < pages.length; i++) {
        var top = pages[i].offsetTop;
        if (direction > 0 && top > scrollTop + threshold) {
            pages[i].scrollIntoView({ behavior: 'smooth', block: 'start' });
            return;
        }
        if (direction < 0 && i > 0 && top >= scrollTop - threshold) {
            pages[i - 1].scrollIntoView({ behavior: 'smooth', block: 'start' });
            return;
        }
    }
    // Edge: at last page going forward, try acceptance section
    if (direction > 0) {
        var acceptance = document.getElementById('acceptanceSection');
        var accepted = document.getElementById('acceptedBanner');
        var target = (acceptance && acceptance.style.display !== 'none') ? acceptance : accepted;
        if (target && target.style.display !== 'none') {
            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }
    if (direction < 0) pages[0].scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// ═══════════════════════════════════════════════════════════════════════
// FULLSCREEN
// ═══════════════════════════════════════════════════════════════════════

function toggleFullscreen() {
    if (document.fullscreenElement) {
        document.exitFullscreen();
    } else {
        document.documentElement.requestFullscreen();
    }
}

document.addEventListener('fullscreenchange', function() {
    var btn = document.getElementById('btnFullscreen');
    if (document.fullscreenElement) {
        btn.innerHTML = '&#x2716;';
        btn.title = 'Quitter plein \u00e9cran';
    } else {
        btn.innerHTML = '&#x26F6;';
        btn.title = 'Plein \u00e9cran';
    }
});

// ═══════════════════════════════════════════════════════════════════════
// HELPERS
// ═══════════════════════════════════════════════════════════════════════

function showError(title, message) {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('errorState').style.display = 'flex';
    document.getElementById('errorTitle').textContent = title;
    document.getElementById('errorMessage').textContent = message;
}

function formatMoney(val) {
    return parseFloat(val).toLocaleString('fr-CA', { style: 'currency', currency: 'CAD' });
}

function formatDate(isoStr) {
    if (!isoStr) return '';
    var d = new Date(isoStr);
    return d.toLocaleDateString('fr-CA', { year: 'numeric', month: 'long', day: 'numeric' });
}

function escapeHtml(str) {
    if (!str) return '';
    var div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

function textToHtml(str) {
    if (!str) return '';
    if (str.indexOf('<p>') !== -1 || str.indexOf('<strong>') !== -1 || str.indexOf('<ul>') !== -1) {
        return str; // already HTML
    }
    return escapeHtml(str).replace(/\n/g, '<br>');
}
</script>
</body>
</html>
