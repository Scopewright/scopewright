<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soumission — Stele</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;1,300;1,400&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --stele-black: #0A0203;
            --stele-green: #4b6050;
            --stele-gray: #C8C8C8;
            --stele-light-gray: #F8F8F8;
            --stele-white: #FFFFFF;
        }

        html, body {
            min-height: 100vh;
            font-family: 'Inter', -apple-system, sans-serif;
            background: #fff;
            color: #1A1A1A;
            line-height: 1.5;
            scroll-snap-type: y mandatory;
            overflow-y: scroll;
        }

        /* ── Layout ── */
        .quote-page-wrapper {
            margin: 0 auto;
            padding: 0;
        }

        /* ── Loading / Error states ── */
        .state-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            text-align: center;
        }

        .spinner {
            width: 48px; height: 48px;
            border: 4px solid var(--stele-gray);
            border-top-color: var(--stele-green);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .state-screen h2 { font-size: 20px; font-weight: 600; margin-bottom: 8px; }
        .state-screen p { font-size: 15px; opacity: 0.7; }

        .error-icon {
            width: 56px; height: 56px;
            border-radius: 50%;
            background: #f44336;
            color: #fff;
            display: flex; align-items: center; justify-content: center;
            font-size: 28px; font-weight: 700;
            margin-bottom: 16px;
        }

        /* ── Pages container ── */
        .quote-pages {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        /* ── Landscape pages (11 × 8.5 in) — fullscreen presentation ── */
        .pv-page {
            background: #fff;
            padding: 36px 48px;
            scroll-snap-align: start;
            height: 100vh;
            max-height: 100vh;
            width: calc(100vh * 11 / 8.5);
            max-width: 100vw;
            margin: 0 auto;
            box-sizing: border-box;
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* Title page — full-screen image + text overlay */
        .pv-page-title { position: relative; padding: 32px; overflow: hidden; background: #fff; }
        .pv-cover-right {
            position: absolute; inset: 32px; z-index: 0; background: #0F1C2D; overflow: hidden; border-radius: 8px;
        }
        .pv-cover-right img { width: 100%; height: 100%; object-fit: cover; display: block; filter: none; opacity: 1; }
        .pv-cover-right .pv-cover-overlay { display: none; }
        .pv-cover-left {
            position: relative; z-index: 1; width: 320px;
            display: flex; flex-direction: column; justify-content: flex-start;
            padding: 48px; min-height: 100%;
            background: transparent; text-align: left;
        }
        .pv-cover-brand {
            position: absolute; bottom: 49px; left: 56px; z-index: 1;
            font-family: 'Inter', -apple-system, sans-serif;
            font-size: 40px; font-weight: 400; letter-spacing: -0.01em;
            text-transform: lowercase; color: white; opacity: 0.9;
            margin: 0; line-height: 1;
        }
        .pv-cover-label {
            font-family: 'Cormorant Garamond', Georgia, serif;
            font-style: italic; font-size: 13px; color: rgba(255,255,255,0.75);
            line-height: 1.2; margin-bottom: 10px;
        }
        .pv-cover-left .pv-client-name {
            font-family: 'Inter', -apple-system, sans-serif;
            font-size: 15px; font-weight: 400; color: white; opacity: 0.85;
            line-height: 1.5; margin-bottom: 0;
        }
        .pv-cover-left .pv-client-address {
            font-family: 'Inter', -apple-system, sans-serif;
            font-size: 15px; font-weight: 400; color: white; opacity: 0.85;
            line-height: 1.5; margin-bottom: 0;
        }
        .pv-cover-left .pv-project-name {
            font-family: 'Inter', -apple-system, sans-serif;
            font-size: 56px; font-weight: 400; color: #FFFFFF;
            line-height: 1.1; letter-spacing: -0.02em;
            margin-top: 28px; margin-bottom: 0;
        }
        .pv-cover-left .pv-cover-divider { width: 32px; height: 1px; background: rgba(255,255,255,0.25); margin: 14px 0; }
        .pv-cover-left .pv-sub-number { font-family: 'Inter', -apple-system, sans-serif; font-size: 13px; font-weight: 400; color: white; opacity: 0.7; margin-bottom: 2px; }
        .pv-cover-left .pv-sub-date { font-family: 'Inter', -apple-system, sans-serif; font-size: 13px; font-weight: 400; color: white; opacity: 0.7; }
        .pv-cover-logo { display: none; }

        /* Installation non incluse — indicators */
        .pv-install-banner { font-size: 12px; color: rgba(255,255,255,0.7); margin-top: 60px; letter-spacing: 0.3px; }
        .pv-install-room-note { font-size: 11px; color: #999; font-style: italic; margin-top: -30px; margin-bottom: 20px; padding-left: 20px; }
        .pv-install-total-note { font-size: 13px; color: #999; margin-bottom: 16px; letter-spacing: 0.3px; }

        /* Room page — landscape layout */
        .pv-page-room-header {
            display: flex; align-items: baseline; justify-content: space-between;
            padding: 10px 0; background: transparent; color: #1A1A1A;
            border-radius: 0; margin: 0; flex-shrink: 0;
            border-bottom: 1px solid #1A1A1A;
        }
        .pv-room-separator {
            border-bottom: 1px solid #E5E5E5;
            flex-shrink: 0;
        }
        .pv-page-room-name {
            font-family: 'Inter', -apple-system, sans-serif;
            font-size: 12px; font-weight: 500; letter-spacing: 0.05em;
            text-transform: uppercase; color: #1A1A1A;
        }
        .pv-page-room-subtotal {
            font-family: 'Inter', -apple-system, sans-serif;
            font-size: 17px; font-weight: 600; letter-spacing: -0.01em;
            color: #1A1A1A;
        }
        .pv-page-room-body { flex: 1; display: flex; gap: 56px; overflow: hidden; min-height: 0; padding-top: 32px; }
        .pv-page-room-text { flex: 0 1 440px; max-width: 440px; display: flex; flex-direction: column; overflow: hidden; justify-content: center; }
        .pv-page-room-media {
            flex: 1.3; display: grid; grid-template-columns: 1fr;
            gap: 14px; align-content: center; max-height: 100%;
        }
        .pv-img-wrap {
            position: relative; overflow: hidden; min-height: 0;
            background: transparent; border: none;
            border-radius: 0; padding: 0;
            box-shadow: none;
        }
        .pv-img-wrap img {
            width: 100%; height: 100%; object-fit: contain; display: block; cursor: pointer;
            border-radius: 0;
        }

        /* Smart image layouts — applied by JS after ratio detection */
        .pv-page-room-media.layout-1 { grid-template-columns: 1fr; }
        .pv-page-room-media.layout-2v { grid-template-columns: 1fr; }
        .pv-page-room-media.layout-2h { grid-template-columns: 1fr 1fr; }
        .pv-page-room-media.layout-2-lp { grid-template-columns: 1fr; }
        .pv-page-room-media.layout-2-lp .pv-img-wrap:last-child { max-width: 65%; justify-self: center; }
        .pv-page-room-media.layout-2h-mixed { grid-template-columns: 3fr 2fr; align-items: center; }
        .pv-page-room-media.layout-3h { grid-template-columns: repeat(3, 1fr); }
        .pv-page-room-media.layout-3-featured { grid-template-columns: 1fr 1fr; }
        .pv-page-room-media.layout-3-featured .pv-img-wrap:first-child { grid-column: 1 / -1; }
        .pv-page-room-media.layout-4-grid { grid-template-columns: 1fr 1fr; }
        .pv-page-room-media.layout-4-featured { grid-template-columns: repeat(3, 1fr); }
        .pv-page-room-media.layout-4-featured .pv-img-wrap:first-child { grid-column: 1 / -1; }
        .pv-page-room-media.layout-gallery { grid-template-columns: repeat(3, 1fr); }
        .pv-page-room-media.layout-gallery .pv-img-wrap.pv-img-landscape { grid-column: span 2; }

        /* Room description — client mode (no edit borders) */
        .pv-page-room-desc {
            font-family: 'Inter', -apple-system, sans-serif;
            font-size: 14px; font-weight: 400; line-height: 1.6; color: #2B2B2B;
            white-space: normal; word-wrap: break-word;
            border-color: transparent; background: transparent; padding: 0;
            flex: initial; min-height: auto;
        }
        .pv-page-room-desc p { margin: 0 0 8px 0; }
        .pv-page-room-desc ul { margin: 6px 0 12px 0; padding-left: 18px; }
        .pv-page-room-desc li { margin-bottom: 6px; color: #555555; font-size: 14px; line-height: 1.6; }
        .pv-page-room-desc li::marker { color: #B0B0B0; }
        .pv-page-room-desc ul + p { margin-top: 16px; }
        .pv-page-room-desc strong { font-weight: 500; color: #1A1A1A; letter-spacing: 0.01em; }

        /* Clauses page */
        .pv-page-clauses-header {
            font-family: 'Inter', -apple-system, sans-serif;
            font-size: 12px; text-transform: uppercase; letter-spacing: 1px;
            color: #1A1A1A; font-weight: 500; margin-bottom: 14px;
            padding-bottom: 6px; border-bottom: 1px solid #1A1A1A;
        }
        .pv-page-clauses-body { flex: 1; overflow: hidden; }
        .pv-page-clause {
            margin-bottom: 8px; padding: 6px 14px;
            border-left: 1px solid #1A1A1A;
            border-radius: 0;
        }
        .pv-page-clause-title {
            font-family: 'Inter', -apple-system, sans-serif;
            font-size: 11px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.3px; margin-bottom: 2px; color: #1A1A1A;
        }
        .pv-page-clause-text {
            font-family: 'Inter', -apple-system, sans-serif;
            font-size: 12px; line-height: 1.3; color: #555555;
        }

        /* Total page */
        .pv-page-total { justify-content: center; align-items: center; text-align: center; }
        .pv-total-box {
            padding: 36px 56px; background: #1A1A1A; color: #fff; border-radius: 0;
        }
        .pv-total-box .total-label {
            font-family: 'Inter', -apple-system, sans-serif;
            font-size: 12px; font-weight: 400; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 10px; opacity: 0.8;
        }
        .pv-total-box .total-amount {
            font-family: 'Inter', -apple-system, sans-serif;
            font-size: 42px; font-weight: 400; letter-spacing: -0.02em;
        }
        .pv-total-box .total-taxes { font-size: 13px; opacity: 0.6; margin-top: 6px; }
        .pv-page-footer-text {
            margin-top: 32px; font-family: 'Inter', -apple-system, sans-serif;
            font-size: 12px; font-weight: 400; color: #888888; letter-spacing: 0.02em; text-transform: uppercase;
        }
        .pv-total-breakdown { margin-bottom: 12px; }
        .pv-total-subtotal-line, .pv-total-discount-line { display: flex; justify-content: space-between; font-size: 16px; padding: 4px 0; opacity: 0.8; }
        .pv-total-discount-line { color: #ef5350; }
        .pv-total-divider { border-top: 1px solid rgba(255,255,255,0.2); margin: 8px 0; }

        /* Steps page */
        .pv-page-steps { padding: 32px 32px; }
        .pv-steps-title {
            font-family: 'Inter', -apple-system, sans-serif;
            font-size: 12px; text-transform: uppercase; letter-spacing: 1px;
            color: #1A1A1A; font-weight: 500; margin-bottom: 20px;
            padding-bottom: 6px; border-bottom: 1px solid #1A1A1A;
        }
        .pv-steps-grid {
            flex: 1; display: grid; grid-template-columns: 1fr 1fr;
            grid-template-rows: repeat(4, 1fr); gap: 10px 48px;
            grid-auto-flow: column;
        }
        .pv-step { display: flex; gap: 16px; align-items: flex-start; }
        .pv-step-circle {
            width: 64px; height: 64px; min-width: 64px; border-radius: 50%;
            color: #fff; display: flex; align-items: center; justify-content: center;
            font-family: 'Inter', -apple-system, sans-serif;
            font-size: 24px; font-weight: 400; margin-top: 2px;
        }
        .pv-step-content { flex: 1; min-width: 0; }
        .pv-step-label {
            font-family: 'Inter', -apple-system, sans-serif;
            font-size: 12px; font-weight: 500; text-transform: uppercase;
            letter-spacing: 0.3px; color: #1A1A1A; margin-bottom: 4px;
        }
        .pv-step-desc {
            font-family: 'Inter', -apple-system, sans-serif;
            font-size: 11px; font-weight: 400; line-height: 1.45; color: #555555;
        }

        /* ── Introduction page ── */
        .pv-page-intro {
            padding: 32px;
            display: grid;
            grid-template-columns: 42% 1fr;
            grid-template-rows: 1fr auto;
            overflow: hidden;
            position: relative;
        }
        .pv-intro-section-label {
            display: none;
        }
        .pv-intro-image {
            grid-row: 1;
            grid-column: 1;
            overflow: hidden;
            border-radius: 8px;
        }
        .pv-intro-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
            display: block;
            border-radius: 8px;
        }
        .pv-intro-content {
            grid-column: 2;
            grid-row: 1;
            padding: 40px 24px 32px 48px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            overflow: hidden;
        }
        .pv-intro-attention-label {
            font-family: 'Inter', -apple-system, sans-serif;
            font-style: italic;
            font-weight: 400;
            font-size: 13px;
            color: #888888;
            margin-bottom: 6px;
            letter-spacing: 0.05em;
        }
        .pv-intro-attention-name {
            font-family: 'Inter', -apple-system, sans-serif;
            font-weight: 400;
            font-size: 14px;
            color: #1a1a1a;
            letter-spacing: 0.01em;
            margin-bottom: 52px;
            line-height: 1.6;
        }
        .pv-intro-rule {
            width: 48px;
            height: 1px;
            background: #1A1A1A;
            margin-bottom: 52px;
        }
        .pv-intro-title {
            font-family: 'Inter', -apple-system, sans-serif;
            font-weight: 400;
            font-size: 28px;
            line-height: 1.3;
            letter-spacing: -0.02em;
            color: #1A1A1A;
            margin-bottom: 48px;
        }
        .pv-intro-title strong {
            font-weight: 600;
        }
        .pv-intro-body {
            max-width: 460px;
        }
        .pv-intro-body p {
            font-family: 'Inter', -apple-system, sans-serif;
            font-weight: 400;
            font-size: 14px;
            line-height: 1.7;
            color: #555555;
            margin-bottom: 20px;
        }
        .pv-intro-body p:last-child {
            margin-bottom: 0;
        }
        .pv-intro-footer {
            grid-column: 1 / -1;
            grid-row: 2;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            padding: 16px 24px 12px 0;
        }
        .pv-intro-footer-addresses {
            display: flex;
            gap: 48px;
        }
        .pv-intro-footer-block {
            display: flex;
            gap: 8px;
            align-items: baseline;
        }
        .pv-intro-footer-label {
            font-family: 'Inter', -apple-system, sans-serif;
            font-weight: 500;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #888888;
        }
        .pv-intro-footer-value {
            font-family: 'Inter', -apple-system, sans-serif;
            font-weight: 400;
            font-size: 10px;
            color: #888888;
        }
        .pv-intro-footer-right {
            text-align: right;
        }
        .pv-intro-footer-name {
            font-family: 'Inter', -apple-system, sans-serif;
            font-weight: 400;
            font-size: 11px;
            color: #1a1a1a;
            margin-bottom: 2px;
        }
        .pv-intro-footer-email {
            font-family: 'Inter', -apple-system, sans-serif;
            font-weight: 400;
            font-size: 10px;
            color: #888888;
        }
        .pv-intro-bottom {
            position: absolute;
            bottom: 8px;
            left: 32px;
            right: 56px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .pv-intro-bottom-url {
            font-family: 'Inter', -apple-system, sans-serif;
            font-weight: 400;
            font-size: 9px;
            color: #1a1a1a;
            text-decoration: none;
            letter-spacing: 0.02em;
        }
        .pv-intro-bottom-page {
            font-family: 'Inter', -apple-system, sans-serif;
            font-weight: 400;
            font-size: 9px;
            color: #888;
        }

        /* ── Page Pourquoi Stele ── */
        .pv-page-why {
            display: grid;
            grid-template-columns: 42% 1fr;
            grid-template-rows: 1fr;
            padding: 32px;
            overflow: hidden;
            position: relative;
        }
        .pv-why-image {
            grid-row: 1;
            grid-column: 1;
            overflow: hidden;
            border-radius: 8px;
        }
        .pv-why-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
            display: block;
            border-radius: 8px;
            filter: grayscale(100%) contrast(1.05);
            box-shadow: none;
        }
        .pv-why-content {
            grid-row: 1;
            grid-column: 2;
            padding: 40px 24px 32px 48px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .pv-why-rule {
            width: 48px;
            height: 1px;
            background: #1A1A1A;
            margin-bottom: 52px;
        }
        .pv-why-title {
            font-family: 'Inter', -apple-system, sans-serif;
            font-size: 28px;
            font-weight: 400;
            letter-spacing: -0.02em;
            line-height: 1.3;
            color: #1A1A1A;
            margin-bottom: 48px;
        }
        .pv-why-title strong {
            font-weight: 600;
        }
        .pv-why-body {
            max-width: 460px;
        }
        .pv-why-body p {
            font-family: 'Inter', -apple-system, sans-serif;
            font-size: 14px;
            font-weight: 400;
            line-height: 1.7;
            color: #555555;
            margin-bottom: 20px;
        }
        .pv-why-body p:last-child {
            margin-bottom: 0;
        }
        .pv-why-bottom {
            position: absolute;
            bottom: 8px;
            left: 32px;
            right: 56px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .pv-why-bottom-url {
            font-family: 'Inter', -apple-system, sans-serif;
            font-size: 9px;
            font-weight: 400;
            letter-spacing: 0.02em;
            color: #1a1a1a;
        }
        .pv-why-bottom-page {
            font-family: 'Inter', -apple-system, sans-serif;
            font-size: 9px;
            font-weight: 400;
            color: #888;
        }

        /* ── Acceptance section ── */
        .acceptance-section {
            scroll-snap-align: start;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 28px;
            background: var(--stele-white);
            text-align: center;
        }

        .acceptance-section h2 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--stele-black);
        }

        .acceptance-subtitle {
            font-size: 14px;
            opacity: 0.6;
            margin-bottom: 24px;
        }

        .acceptance-form {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 14px;
            max-width: 380px;
            margin: 0 auto;
        }

        .acceptance-form input {
            width: 100%;
            padding: 12px 14px;
            font-size: 15px;
            font-family: inherit;
            border: 1px solid rgba(0,0,0,0.15);
            border-radius: 3px;
            background: var(--stele-light-gray);
        }

        .acceptance-form input:focus {
            outline: none;
            border-color: var(--stele-green);
            box-shadow: 0 0 0 2px rgba(75, 96, 80, 0.15);
        }

        .btn-accept {
            width: 100%;
            padding: 14px;
            font-size: 16px;
            font-weight: 600;
            font-family: inherit;
            background: var(--stele-green);
            color: var(--stele-white);
            border: none;
            border-radius: 3px;
            cursor: pointer;
            transition: background 0.2s;
            margin-top: 4px;
        }

        .btn-accept:hover { background: #3d5043; }
        .btn-accept:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ── Signature pad ── */
        .signature-block {
            width: 100%;
            margin-top: 4px;
        }

        .signature-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            color: var(--stele-green);
            font-weight: 600;
            margin-bottom: 6px;
            text-align: left;
        }

        .signature-canvas-wrap {
            position: relative;
            width: 100%;
            border: 1px solid rgba(0,0,0,0.15);
            border-radius: 3px;
            background: #fff;
        }

        .signature-canvas {
            display: block;
            width: 100%;
            height: 140px;
            cursor: crosshair;
            touch-action: none;
        }

        .signature-placeholder {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px;
            color: #bbb;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .signature-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 4px;
        }

        .btn-clear-sig {
            background: none;
            border: none;
            font-size: 12px;
            color: #999;
            cursor: pointer;
            font-family: inherit;
            padding: 2px 0;
        }

        .btn-clear-sig:hover { color: var(--stele-black); }

        /* ── Accepted confirmation ── */
        .accepted-banner {
            scroll-snap-align: start;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 28px;
            background: var(--stele-white);
            text-align: center;
        }

        .accepted-banner .check-icon {
            width: 56px; height: 56px;
            border-radius: 50%;
            background: #4CAF50;
            color: #fff;
            display: inline-flex; align-items: center; justify-content: center;
            font-size: 28px;
            margin-bottom: 12px;
        }

        .accepted-banner h2 {
            font-size: 20px;
            font-weight: 600;
            color: #2E7D32;
            margin-bottom: 4px;
        }

        .accepted-banner p {
            font-size: 14px;
            color: #555;
        }

        /* ── Lightbox ── */
        .lightbox-overlay {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.92); z-index: 9999;
            flex-direction: column; align-items: center; justify-content: center;
        }
        .lightbox-overlay.active { display: flex; }

        .lightbox-container {
            position: relative; display: flex; align-items: center;
            justify-content: center; width: 100%; height: 100%;
            touch-action: none;
        }

        .lightbox-img {
            max-width: 90vw; max-height: 85vh; border-radius: 4px;
            box-shadow: 0 8px 40px rgba(0,0,0,0.5);
            transition: transform 0.15s ease;
            user-select: none; -webkit-user-select: none;
        }

        .lightbox-close {
            position: absolute; top: 16px; right: 20px;
            background: none; border: none; color: #fff;
            font-size: 32px; cursor: pointer; line-height: 1;
            opacity: 0.7; transition: opacity 0.2s;
            z-index: 10; width: 44px; height: 44px;
            display: flex; align-items: center; justify-content: center;
        }
        .lightbox-close:hover { opacity: 1; }

        .lightbox-nav {
            position: absolute; top: 50%; transform: translateY(-50%);
            background: rgba(255,255,255,0.15); border: none; color: #fff;
            font-size: 28px; cursor: pointer;
            width: 44px; height: 44px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            opacity: 0.7; transition: opacity 0.2s, background 0.2s;
            z-index: 10;
        }
        .lightbox-nav:hover { opacity: 1; background: rgba(255,255,255,0.25); }
        .lightbox-prev { left: 16px; }
        .lightbox-next { right: 16px; }

        .lightbox-counter {
            position: absolute; bottom: 20px;
            color: rgba(255,255,255,0.6); font-size: 13px;
            z-index: 10; letter-spacing: 0.5px;
        }

        /* ── Fullscreen button ── */
        .btn-fullscreen {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
            background: var(--stele-green);
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 44px;
            height: 44px;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity 0.2s, transform 0.2s;
            opacity: 0.7;
        }
        .btn-fullscreen:hover { opacity: 1; transform: scale(1.1); }

        /* ── Footer ── */
        .quote-footer {
            display: none;
        }

        /* ── Responsive ── */
        @media (max-width: 768px) {
            .quote-page-wrapper { padding: 0; }
            .pv-page { padding: 20px 24px; width: 100vw; height: auto; max-height: none; }
            .pv-page-room-header { margin: -20px -24px 0 -24px; padding: 10px 24px; }
            .pv-page-room-body { flex-direction: column; gap: 16px; }
            .pv-page-room-media { grid-template-columns: 1fr !important; gap: 12px; }
            .pv-page-room-media .pv-img-wrap { max-width: 100% !important; }
            .pv-img-wrap.pv-img-portrait img { max-height: 50vh; }
            .pv-steps-grid { grid-template-columns: 1fr; grid-auto-flow: row; }
            .pv-step-circle { width: 48px; height: 48px; min-width: 48px; font-size: 18px; }
            .pv-page-title .pv-client-name { font-size: 22px; }
            .pv-page-title .pv-sub-number { font-size: 18px; }
            .pv-total-box .total-amount { font-size: 28px; }
            .lightbox-nav { display: none; }
            .lightbox-img { max-width: 96vw; max-height: 90vh; }
            /* Intro page mobile */
            .pv-page-intro {
                grid-template-columns: 1fr;
                grid-template-rows: 50vh auto auto;
                height: auto; max-height: none;
            }
            .pv-intro-image { grid-row: 1; grid-column: 1; }
            .pv-intro-content { grid-column: 1; grid-row: 2; padding: 32px 24px; }
            .pv-intro-footer {
                grid-column: 1; grid-row: 3;
                flex-direction: column; gap: 16px;
                padding: 16px 24px 48px;
            }
            .pv-intro-footer-addresses { flex-direction: column; gap: 8px; }
            .pv-intro-footer-right { text-align: left; }
            .pv-intro-section-label { display: none; }
            .pv-intro-bottom { left: 24px; right: 24px; }
            /* Why page mobile */
            .pv-page-why {
                grid-template-columns: 1fr;
                grid-template-rows: 50vh auto;
                height: auto; max-height: none;
                padding: 0;
            }
            .pv-why-image { grid-row: 1; grid-column: 1; border-radius: 0; }
            .pv-why-image img { border-radius: 0; }
            .pv-why-content { grid-column: 1; padding: 32px 24px; }
            .pv-why-bottom { position: static; padding: 0 24px 8px 24px; }
        }

        @media (max-width: 480px) {
            .pv-page { padding: 16px; }
            .pv-page-room-header { padding: 10px 0; }
            .pv-page-room-body { gap: 16px; }
            .pv-page-room-media { gap: 8px !important; }
            .pv-intro-content { padding: 24px 16px; }
            .pv-why-content { padding: 24px 16px; }
        }

        /* ── Print ── */
        @media print {
            html, body { background: #fff; }
            .quote-page-wrapper { padding: 0; max-width: 100%; }
            .pv-page {
                break-inside: avoid;
                box-shadow: none;
                border: 1px solid #eee;
                page-break-after: always;
            }
            .acceptance-section,
            .accepted-banner,
            .quote-footer,
            .btn-fullscreen { display: none; }
            .pv-page-room-header, .pv-total-box, .pv-step-circle {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .pv-page-room-body { break-inside: avoid; }
            .pv-img-wrap { break-inside: avoid; box-shadow: none; }
            .pv-page-intro { page-break-after: always; }
            .pv-page-why { page-break-after: always; break-inside: avoid; }
            .pv-why-image img {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .pv-intro-image img {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
    </style>
</head>
<body>

<!-- ════════════════════════════════════════════ -->
<!-- LOADING STATE                                -->
<!-- ════════════════════════════════════════════ -->
<div class="quote-page-wrapper">
    <div id="loadingState" class="state-screen">
        <div class="spinner"></div>
        <h2>Chargement de la soumission...</h2>
        <p>Veuillez patienter</p>
    </div>

    <div id="errorState" class="state-screen" style="display:none;">
        <div class="error-icon">!</div>
        <h2 id="errorTitle">Lien invalide</h2>
        <p id="errorMessage">Ce lien de soumission est invalide ou a expiré.</p>
    </div>

    <!-- ════════════════════════════════════════ -->
    <!-- QUOTE CONTENT (hidden until loaded)      -->
    <!-- ════════════════════════════════════════ -->
    <div id="quoteContent" style="display:none;">

        <!-- Pages container (landscape pages) -->
        <div class="quote-pages" id="quotePages"></div>

        <!-- Acceptance form (hidden when already accepted) -->
        <div class="acceptance-section" id="acceptanceSection">
            <h2>Accepter cette soumission</h2>
            <p class="acceptance-subtitle">Veuillez entrer vos informations pour confirmer votre acceptation.</p>
            <div class="acceptance-form">
                <input type="text" id="acceptName" placeholder="Votre nom complet" required>
                <input type="email" id="acceptEmail" placeholder="Votre courriel" required>
                <div class="signature-block">
                    <div class="signature-label">Signature</div>
                    <div class="signature-canvas-wrap">
                        <canvas class="signature-canvas" id="signatureCanvas"></canvas>
                        <span class="signature-placeholder" id="sigPlaceholder">Dessinez votre signature ici</span>
                    </div>
                    <div class="signature-actions">
                        <button type="button" class="btn-clear-sig" onclick="clearSignature()">Effacer</button>
                    </div>
                </div>
                <button class="btn-accept" id="btnAccept" onclick="acceptQuote()">Accepter la soumission</button>
            </div>
        </div>

        <!-- Already accepted banner -->
        <div class="accepted-banner" id="acceptedBanner" style="display:none;">
            <div class="check-icon">&#10003;</div>
            <h2>Soumission acceptée</h2>
            <p id="acceptedInfo"></p>
        </div>

        <!-- Footer -->
        <div class="quote-footer">
            Stele &mdash; Ébénisterie sur mesure
        </div>
    </div>
</div>

<!-- Fullscreen toggle -->
<button class="btn-fullscreen" id="btnFullscreen" onclick="toggleFullscreen()" title="Plein écran">&#x26F6;</button>

<!-- Lightbox -->
<div class="lightbox-overlay" id="lightbox">
    <button class="lightbox-close" onclick="closeLightbox()">&times;</button>
    <div class="lightbox-container" id="lbContainer">
        <button class="lightbox-nav lightbox-prev" id="lbPrev" onclick="event.stopPropagation();lbNavigate(-1)">&#8249;</button>
        <img class="lightbox-img" id="lightboxImg" src="" alt="" onclick="event.stopPropagation()">
        <button class="lightbox-nav lightbox-next" id="lbNext" onclick="event.stopPropagation();lbNavigate(1)">&#8250;</button>
    </div>
    <div class="lightbox-counter" id="lbCounter"></div>
</div>

<script>
// ═══════════════════════════════════════════════════════════════════════
// CONFIG
// ═══════════════════════════════════════════════════════════════════════

const SUPABASE_URL = 'https://rplzbtjfnwahqodrhpny.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJwbHpidGpmbndhaHFvZHJocG55Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NDU2MDEsImV4cCI6MjA4NjIyMTYwMX0.OQAZhc029PbRDSe1b02NDAuOUE8yn-_h3QqSnUDpLeU';

// Steps data (same as calculateur.html)
var STEPS = [
    { label: 'Conception', desc: '\u00c0 cette \u00e9tape, nous veillerons \u00e0 rassembler toutes les informations n\u00e9cessaires au bon d\u00e9roulement du projet. Cela inclut le choix des poign\u00e9es, l\u2019approbation des mat\u00e9riaux, ainsi que l\u2019\u00e9tude des d\u00e9fis sp\u00e9cifiques au projet. Nous rassemblerons \u00e9galement les fiches techniques des \u00e9lectrom\u00e9nagers et validerons l\u2019\u00e9ch\u00e9ancier avec le client et l\u2019entrepreneur.' },
    { label: 'Prise de mesure initiale', desc: 'Typiquement, cette prise de mesures s\u2019effectue sur les colombages et le plancher non fini. Nous tiendrons compte de l\u2019\u00e9paisseur du rev\u00eatement de sol et des murs pr\u00e9vus afin d\u2019\u00e9laborer nos dessins.' },
    { label: 'Approbation des dessins d\u2019atelier', desc: 'Suite \u00e0 notre premi\u00e8re prise de mesures, les dessins d\u2019atelier vous seront remis pour approbation. Une fois ces dessins approuv\u00e9s, aucune modification ne pourra y \u00eatre apport\u00e9e.' },
    { label: 'Commande de mat\u00e9riaux', desc: 'Comme nous prenons en compte les \u00e9paisseurs de rev\u00eatement lors de notre prise de mesures sur l\u2019ossature brute, nous sommes en mesure de commander les mat\u00e9riaux, tels que les placages de bois et la quincaillerie sp\u00e9ciale, afin d\u2019\u00e9viter tout d\u00e9lai lors de la mise en production.' },
    { label: 'Prise de mesure finale', desc: 'La prise de mesures finale s\u2019effectue une fois le plancher fini et les joints ainsi que les coins de fer pos\u00e9s. Apr\u00e8s cette prise de mesures, un d\u00e9lai de 6 semaines est n\u00e9cessaire avant le d\u00e9but de l\u2019installation.' },
    { label: 'Dessins d\u2019atelier pour production', desc: 'Comme nous avons pr\u00e9alablement ajust\u00e9 la prise de mesures initiale pour qu\u2019elle soit presque conforme au r\u00e9sultat final, les ajustements \u00e0 ce stade sont mineurs. Sauf en cas de changement majeur, les dessins d\u2019atelier ne vous seront pas renvoy\u00e9s pour approbation \u00e0 cette \u00e9tape.' },
    { label: 'Installation', desc: 'La dur\u00e9e de cette \u00e9tape varie en fonction de l\u2019ampleur du projet, mais elle marque un moment cl\u00e9\u00a0: celui o\u00f9 votre vision prend forme. Il ne restera plus que notre mobilier, pr\u00eat \u00e0 s\u2019int\u00e9grer dans votre quotidien et \u00e0 accompagner vos plus beaux moments \u00e0 la maison.' },
    { label: 'Contr\u00f4le de qualit\u00e9', desc: 'Une fois l\u2019installation termin\u00e9e, un repr\u00e9sentant Stele effectuera une visite avec vous pour \u00e9tablir ensemble une liste unique d\u2019ajustements, si n\u00e9cessaire. Stele pr\u00e9parera ensuite tout le n\u00e9cessaire et, lors d\u2019une seule visite suppl\u00e9mentaire, apportera les ajustements n\u00e9cessaires pour garantir un r\u00e9sultat final \u00e0 la hauteur de vos attentes.' }
];
var STEP_COLORS = ['#2f3e34','#3a4b3f','#45584a','#4b6050','#5e7462','#718874','#849c86','#97b098'];

// ═══════════════════════════════════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════════════════════════════════

let quoteData = null;
let currentToken = null;
var coverImageUrl = '';
var introConfig = {};
var projectManagerName = '';
var projectManagerEmail = '';
var designerArchitectName = '';

(async function init() {
    // Extract token from URL
    const params = new URLSearchParams(window.location.search);
    currentToken = params.get('token');

    if (!currentToken) {
        showError('Lien invalide', 'Aucun jeton de soumission trouvé dans le lien.');
        return;
    }

    try {
        const resp = await fetch(SUPABASE_URL + '/rest/v1/rpc/get_public_quote', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY
            },
            body: JSON.stringify({ p_token: currentToken })
        });

        if (!resp.ok) {
            const errText = await resp.text();
            console.error('RPC error:', resp.status, errText);
            showError('Erreur', 'Impossible de charger la soumission. Veuillez réessayer plus tard.');
            return;
        }

        quoteData = await resp.json();

        if (!quoteData || quoteData.error) {
            showError('Lien invalide', quoteData?.error || 'Ce lien de soumission est invalide ou a expiré.');
            return;
        }

        // Load config from app_config (cover image + intro page)
        function cleanConfigValue(val) {
            if (typeof val === 'string' && val.length >= 2 && val[0] === '"' && val[val.length - 1] === '"') {
                try { return JSON.parse(val); } catch (e) {}
            }
            return val;
        }
        try {
            var configKeys = 'cover_image,intro_image,presentation_intro_text_1,presentation_intro_text_2,presentation_intro_text_3,presentation_intro_atelier,presentation_intro_bureau,presentation_intro_phone,presentation_intro_url';
            var ciResp = await fetch(SUPABASE_URL + '/rest/v1/app_config?key=in.(' + configKeys + ')&select=key,value', {
                headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
            });
            if (ciResp.ok) {
                var cfgRows = await ciResp.json();
                cfgRows.forEach(function(row) { introConfig[row.key] = cleanConfigValue(row.value); });
                if (introConfig.cover_image) coverImageUrl = introConfig.cover_image;
            }
        } catch (e) { /* fallback to dark bg */ }

        // Load project manager info from employees
        try {
            var pmAssigned = quoteData.project.assigned_to || '';
            if (pmAssigned) {
                projectManagerName = pmAssigned;
                var empResp = await fetch(SUPABASE_URL + '/rest/v1/employees?name=eq.' + encodeURIComponent(pmAssigned) + '&select=email&limit=1', {
                    headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
                });
                if (empResp.ok) {
                    var empRows = await empResp.json();
                    if (empRows.length > 0 && empRows[0].email) projectManagerEmail = empRows[0].email;
                }
            }
        } catch (e) { /* graceful: no PM shown */ }

        // Load architect/designer name from project contacts
        try {
            var projId = quoteData.project.id;
            if (projId) {
                var pcResp = await fetch(SUPABASE_URL + '/rest/v1/project_contacts?project_id=eq.' + projId + '&select=role,contacts(first_name,last_name)', {
                    headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
                });
                if (pcResp.ok) {
                    var pcRows = await pcResp.json();
                    var archMatch = pcRows.find(function(pc) {
                        var r = (pc.role || '').toLowerCase();
                        return r.indexOf('architecte') >= 0 || r.indexOf('architect') >= 0 || r.indexOf('designer') >= 0;
                    });
                    if (archMatch && archMatch.contacts) {
                        var c = archMatch.contacts;
                        designerArchitectName = ((c.first_name || '') + ' ' + (c.last_name || '')).trim();
                    }
                }
            }
        } catch (e) { /* graceful: fallback to generic text */ }

        try {
            await renderQuote();
            initSignaturePad();
        } catch (renderErr) {
            console.error('Render error:', renderErr);
            showError('Erreur d\u2019affichage', 'Impossible d\u2019afficher la soumission : ' + renderErr.message);
        }
    } catch (err) {
        console.error('Fetch error:', err);
        showError('Erreur de connexion', 'Impossible de joindre le serveur. V\u00e9rifiez votre connexion internet.');
    }
})();

// ═══════════════════════════════════════════════════════════════════════
// RENDER
// ═══════════════════════════════════════════════════════════════════════

async function renderQuote() {
    var sub = quoteData.submission;
    var proj = quoteData.project;
    var rooms = quoteData.rooms || [];
    var token = quoteData.token;

    // Try to load snapshot for approved/sent submissions
    var isLocked = sub.status && sub.status !== 'draft' && sub.status !== 'returned' && sub.status !== 'pending_internal';
    if (isLocked && sub.id) {
        try {
            var snapUrl = SUPABASE_URL + '/storage/v1/object/public/submission-snapshots/' + sub.id + '.html';
            var snapResp = await fetch(snapUrl);
            if (snapResp.ok) {
                var snapHtml = await snapResp.text();
                var bodyMatch = snapHtml.match(/<body[^>]*>([\s\S]*)<\/body>/i);
                if (bodyMatch) {
                    document.getElementById('quotePages').innerHTML = bodyMatch[1];
                    applySmartLayouts();
                    document.getElementById('loadingState').style.display = 'none';
                    document.getElementById('quoteContent').style.display = 'block';
                    renderAcceptanceSection(sub, token);
                    return;
                }
            }
        } catch (e) { /* snapshot not available, render live */ }
    }

    // Load room_media for all rooms (new Storage-based images)
    var roomMediaMap = {};
    try {
        var roomIds = rooms.map(function(r) { return r.id; }).filter(Boolean);
        if (roomIds.length > 0) {
            var mediaResp = await fetch(SUPABASE_URL + '/rest/v1/room_media?room_id=in.(' + roomIds.join(',') + ')&order=sort_order.asc', {
                headers: { 'apikey': SUPABASE_KEY, 'Authorization': 'Bearer ' + SUPABASE_KEY }
            });
            if (mediaResp.ok) {
                var allMedia = await mediaResp.json();
                allMedia.forEach(function(m) {
                    if (!roomMediaMap[m.room_id]) roomMediaMap[m.room_id] = [];
                    roomMediaMap[m.room_id].push(m);
                });
            }
        }
    } catch (e) { console.error('Load room_media error:', e); }

    // Title
    document.title = 'Soumission #' + sub.submission_number + ' — Stele';

    var html = '';
    var grandTotal = 0;

    // ── PAGE 1: Title ──
    var subDate = formatDate(sub.sent_at || sub.approved_at || new Date().toISOString());
    var acceptanceProofHtml = '';
    if (token.accepted_at || sub.accepted_at) {
        acceptanceProofHtml += '<div style="position:absolute;top:10px;left:20px;background:#e8f5e9;border:1px solid var(--stele-green);border-radius:8px;padding:12px 16px;max-width:320px;font-size:11px;line-height:1.6;z-index:1;text-align:left;">';
        acceptanceProofHtml += '<div style="font-weight:700;font-size:13px;color:var(--stele-green);margin-bottom:6px;">Soumission accept\u00e9e</div>';
        if (token.client_name) acceptanceProofHtml += '<div><strong>Nom :</strong> ' + escapeHtml(token.client_name) + '</div>';
        if (token.client_email) acceptanceProofHtml += '<div><strong>Courriel :</strong> ' + escapeHtml(token.client_email) + '</div>';
        var acceptedDate = token.accepted_at || sub.accepted_at;
        if (acceptedDate) acceptanceProofHtml += '<div><strong>Date :</strong> ' + new Date(acceptedDate).toLocaleString('fr-CA') + '</div>';
        if (token.signature_data) acceptanceProofHtml += '<div style="margin-top:8px;"><img src="' + token.signature_data + '" style="max-width:200px;border:1px solid #ccc;border-radius:4px;" alt="Signature"></div>';
        acceptanceProofHtml += '</div>';
    }
    // Build separate address lines (new columns with fallback)
    var coverAddrLine = proj.project_address || proj.client_address || '';
    var coverCityParts = [];
    if (proj.project_city) coverCityParts.push(proj.project_city);
    if (proj.project_postal_code) coverCityParts.push(proj.project_postal_code);
    var coverCityPostal = coverCityParts.join(', ');

    // Pre-scan installation status
    var installExcludedIds = {};
    var totalRooms = rooms.length;
    rooms.forEach(function(r) { if (r.installation_included === false) installExcludedIds[r.id] = true; });
    var excludedCount = Object.keys(installExcludedIds).length;
    var allInstallExcluded = totalRooms > 0 && excludedCount === totalRooms;
    var someInstallExcluded = excludedCount > 0 && !allInstallExcluded;

    html += '<div class="pv-page pv-page-title">';
    html += '<div class="pv-cover-right">';
    if (coverImageUrl) {
        html += '<img src="' + escapeHtml(coverImageUrl) + '" alt="">';
    }
    html += '<div class="pv-cover-overlay"></div>';
    html += '</div>';
    html += '<div class="pv-cover-left">';
    html += acceptanceProofHtml;
    html += '<div class="pv-cover-label">Soumission préparée pour</div>';
    if (proj.client_name) html += '<div class="pv-client-name">' + escapeHtml(proj.client_name) + '</div>';
    if (coverAddrLine) html += '<div class="pv-client-address">' + escapeHtml(coverAddrLine) + '</div>';
    if (coverCityPostal) html += '<div class="pv-client-address">' + escapeHtml(coverCityPostal) + '</div>';
    if (proj.name) html += '<div class="pv-project-name">' + escapeHtml(proj.name) + '</div>';
    html += '<div class="pv-cover-divider"></div>';
    html += '<div class="pv-sub-number">Soumission #' + escapeHtml(sub.submission_number + '') + '</div>';
    if (subDate) html += '<div class="pv-sub-date">' + escapeHtml(subDate) + '</div>';
    if (allInstallExcluded) html += '<div class="pv-install-banner">Installation non incluse</div>';
    html += '</div>';
    html += '<div class="pv-cover-brand">stele</div>';
    html += '</div>';

    // ── Introduction page (skip for locked submissions — those are frozen like a PDF) ──
    var introImageUrl = !isLocked ? (introConfig.intro_image || '') : '';
    var introText1 = !isLocked ? (introConfig.presentation_intro_text_1 || '') : '';
    var introText2 = !isLocked ? (introConfig.presentation_intro_text_2 || '') : '';
    var introText3 = !isLocked ? (introConfig.presentation_intro_text_3 || '') : '';
    var introAtelier = !isLocked ? (introConfig.presentation_intro_atelier || '') : '';
    var introBureau = !isLocked ? (introConfig.presentation_intro_bureau || '') : '';
    var introPhone = !isLocked ? (introConfig.presentation_intro_phone || '') : '';
    var introUrl = !isLocked ? (introConfig.presentation_intro_url || '') : '';

    if (introImageUrl || introText1 || introText2 || introText3) {
        html += '<div class="pv-page pv-page-intro">';

        // Section label
        html += '<span class="pv-intro-section-label">Introduction</span>';

        // Left column: image
        html += '<div class="pv-intro-image">';
        if (introImageUrl) {
            html += '<img src="' + escapeHtml(introImageUrl) + '" alt="">';
        }
        html += '</div>';

        // Right column: content
        html += '<div class="pv-intro-content">';

        html += '<div class="pv-intro-attention-label">\u00c0 l\u2019attention de\u2009:</div>';

        // Client info (dynamic)
        var introClientParts = [];
        if (proj.client_name) introClientParts.push(escapeHtml(proj.client_name));
        if (coverAddrLine) introClientParts.push(escapeHtml(coverAddrLine));
        if (coverCityPostal) introClientParts.push(escapeHtml(coverCityPostal));
        if (introClientParts.length > 0) {
            html += '<div class="pv-intro-attention-name">' + introClientParts.join('<br>') + '</div>';
        }

        html += '<div class="pv-intro-rule"></div>';

        html += '<h2 class="pv-intro-title">Merci de<br>consid\u00e9rer <strong>stele</strong><br>pour votre projet.</h2>';

        html += '<div class="pv-intro-body">';
        if (introText1) html += '<p>' + escapeHtml(introText1) + '</p>';
        if (introText2) html += '<p>' + escapeHtml(introText2) + '</p>';
        if (introText3) html += '<p>' + escapeHtml(introText3) + '</p>';
        html += '</div>';

        html += '</div>'; // end pv-intro-content

        // Footer (full width)
        html += '<div class="pv-intro-footer">';

        html += '<div class="pv-intro-footer-addresses">';
        if (introAtelier) {
            html += '<div class="pv-intro-footer-block">';
            html += '<span class="pv-intro-footer-label">Atelier</span>';
            html += '<span class="pv-intro-footer-value">' + escapeHtml(introAtelier) + '</span>';
            html += '</div>';
        }
        if (introBureau) {
            html += '<div class="pv-intro-footer-block">';
            html += '<span class="pv-intro-footer-label">Bureau</span>';
            html += '<span class="pv-intro-footer-value">' + escapeHtml(introBureau) + '</span>';
            html += '</div>';
        }
        if (introPhone) {
            html += '<div class="pv-intro-footer-block">';
            html += '<span class="pv-intro-footer-value">' + escapeHtml(introPhone) + '</span>';
            html += '</div>';
        }
        html += '</div>'; // end addresses

        html += '<div class="pv-intro-footer-right">';
        if (projectManagerName) {
            html += '<div class="pv-intro-footer-name">' + escapeHtml(projectManagerName) + '</div>';
            if (projectManagerEmail) html += '<div class="pv-intro-footer-email">' + escapeHtml(projectManagerEmail) + '</div>';
        }
        html += '</div>';

        html += '</div>'; // end pv-intro-footer

        // Bottom bar
        html += '<div class="pv-intro-bottom">';
        html += '<span class="pv-intro-bottom-url">' + escapeHtml(introUrl || 'stele.ca') + '</span>';
        html += '<span class="pv-intro-bottom-page">1</span>';
        html += '</div>';

        html += '</div>'; // end pv-page-intro
    }

    // ── Page "Pourquoi stele" ──
    var whyDesignerName = designerArchitectName || 'votre architecte';
    html += '<div class="pv-page pv-page-why">';
    html += '<div class="pv-why-image">';
    html += '<img src="images/why-stele.jpg" alt="Atelier stele" onerror="this.style.display=\'none\'" />';
    html += '</div>';
    html += '<div class="pv-why-content">';
    html += '<div class="pv-why-rule"></div>';
    html += '<h2 class="pv-why-title">Pourquoi <strong>stele</strong></h2>';
    html += '<div class="pv-why-body">';
    html += '<p>Parce que, comme vous, nous estimons et admirons le travail de ' + escapeHtml(whyDesignerName) + ', et souhaitons rendre hommage à leur vision avec la même exigence.</p>';
    html += '<p>Parce que nos années d\'expérience dans la réalisation de projets d\'ébénisterie d\'envergure nous ont appris à maîtriser la complexité, et que notre équipe se distingue par son habileté là où la technologie atteint ses limites.</p>';
    html += '<p>Parce que stele, c\'est avant tout une équipe de gens passionnés, animés par le désir de créer des pièces uniques. Si chaque projet apporte son lot de défis, nous sommes prêts à les relever pour que chaque étape se fasse en toute simplicité.</p>';
    html += '</div>';
    html += '</div>';
    html += '<div class="pv-why-bottom">';
    html += '<span class="pv-why-bottom-url">stele.ca</span>';
    html += '<span class="pv-why-bottom-page">2</span>';
    html += '</div>';
    html += '</div>'; // end pv-page-why

    // ── Room pages (one per room) — text left, images right ──
    rooms.forEach(function(room) {
        var calculatedSubtotal = parseFloat(room.subtotal) || 0;
        var globalMod = parseFloat(sub.global_price_modifier_pct) || 0;
        var roomMod = parseFloat(room.price_modifier_pct) || 0;
        var multiplier = (1 + globalMod / 100) * (1 + roomMod / 100);
        var subtotal = Math.round(calculatedSubtotal * multiplier * 100) / 100;
        grandTotal += subtotal;

        // Collect images: new room_media + legacy Base64
        var allImages = [];
        var mediaImages = roomMediaMap[room.id] || [];
        mediaImages.forEach(function(m) {
            if ((m.tags || ['presentation_soumission']).indexOf('presentation_soumission') !== -1) {
                allImages.push({
                    src: m.cropped_url,
                    name: (m.cropped_url || '').split('/').pop() || 'image.jpg',
                    cropRatio: m.crop_ratio || '16:9'
                });
            }
        });
        var legacyImages = (room.images || []).filter(function(img) { return img.showInQuote; });
        legacyImages.forEach(function(img) {
            allImages.push({ src: img.dataUrl, name: img.name || 'Image', cropRatio: '16:9' });
        });

        var hasImages = allImages.length > 0;
        var desc = room.client_description || '';

        html += '<div class="pv-page">';
        html += '<div class="pv-page-room-header">';
        html += '<span class="pv-page-room-name">' + escapeHtml(room.name) + '</span>';
        html += '<span class="pv-page-room-subtotal">' + formatMoney(subtotal) + '</span>';
        html += '</div>';
        if (someInstallExcluded && installExcludedIds[room.id]) {
            html += '<div class="pv-install-room-note">* Installation non incluse pour cette section</div>';
        }
        html += '<div class="pv-page-room-body">';

        // Left column: description
        if (hasImages) {
            html += '<div class="pv-page-room-text">';
            html += '<div class="pv-page-room-desc">';
            html += formatRoomDescription(desc);
            html += '</div>';
            html += '</div>';

            // Right column: images grid (smart layout applied after load)
            html += '<div class="pv-page-room-media">';
            allImages.slice(0, 6).forEach(function(img) {
                html += '<div class="pv-img-wrap">';
                html += '<img src="' + img.src + '" alt="' + escapeHtml(img.name) + '"';
                html += ' onclick="openLightbox(this.src)">';
                html += '</div>';
            });
            html += '</div>';
        } else {
            // No images — description takes full width
            html += '<div class="pv-page-room-text" style="flex:1;">';
            html += '<div class="pv-page-room-desc">';
            html += formatRoomDescription(desc);
            html += '</div>';
            html += '</div>';
        }

        html += '</div>';
        html += '<div class="pv-room-separator"></div>';
        html += '</div>';
    });

    // ── Clauses page ──
    var clauses = sub.clauses || [];
    if (clauses.length > 0) {
        html += '<div class="pv-page">';
        html += '<div class="pv-page-clauses-header">Clauses du contrat</div>';
        html += '<div class="pv-page-clauses-body">';
        clauses.forEach(function(clause) {
            html += '<div class="pv-page-clause">';
            html += '<div class="pv-page-clause-title">' + escapeHtml(clause.title) + '</div>';
            html += '<div class="pv-page-clause-text">' + escapeHtml(clause.content || '') + '</div>';
            html += '</div>';
        });
        html += '</div></div>';
    }

    // ── Total page ──
    var discountType = sub.discount_type || null;
    var discountValue = sub.discount_value ? parseFloat(sub.discount_value) : 0;
    var discountAmt = 0;
    if (discountType && discountValue > 0) {
        discountAmt = discountType === 'percentage' ? grandTotal * discountValue / 100 : discountValue;
    }
    var finalTotal = grandTotal - discountAmt;
    var totalToShow = sub.approved_total ? parseFloat(sub.approved_total) : finalTotal;
    html += '<div class="pv-page pv-page-total">';
    if (allInstallExcluded) {
        html += '<div class="pv-install-total-note">Installation non incluse</div>';
    }
    html += '<div class="pv-total-box">';
    if (discountType && discountValue > 0) {
        var discountLabel = discountType === 'percentage' ? 'Rabais (' + discountValue + '%)' : 'Rabais';
        html += '<div class="pv-total-breakdown">';
        html += '<div class="pv-total-subtotal-line"><span>Sous-total</span><span>' + formatMoney(grandTotal) + '</span></div>';
        html += '<div class="pv-total-discount-line"><span>' + escapeHtml(discountLabel) + '</span><span>- ' + formatMoney(discountAmt) + '</span></div>';
        html += '<div class="pv-total-divider"></div>';
        html += '</div>';
    }
    html += '<div class="total-label">Total</div>';
    html += '<div class="total-amount">' + formatMoney(totalToShow) + '</div>';
    html += '<div class="total-taxes">+ taxes applicables</div>';
    html += '</div>';
    html += '<div class="pv-page-footer-text">Stele \u2014 \u00c9b\u00e9nisterie sur mesure</div>';
    html += '</div>';

    // ── Steps page ──
    html += '<div class="pv-page pv-page-steps">';
    html += '<div class="pv-steps-title">\u00c9tapes d\u2019un projet type</div>';
    html += '<div class="pv-steps-grid">';
    STEPS.forEach(function(step, i) {
        html += '<div class="pv-step">';
        html += '<div class="pv-step-circle" style="background:' + STEP_COLORS[i] + '">' + (i + 1) + '</div>';
        html += '<div class="pv-step-content">';
        html += '<div class="pv-step-label">' + escapeHtml(step.label) + '</div>';
        html += '<div class="pv-step-desc">' + escapeHtml(step.desc) + '</div>';
        html += '</div></div>';
    });
    html += '</div></div>';

    // ── Inject all pages ──
    document.getElementById('quotePages').innerHTML = html;
    applySmartLayouts();
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('quoteContent').style.display = 'block';

    // ── Acceptance UI ──
    renderAcceptanceSection(sub, token);
}

function renderAcceptanceSection(sub, token) {
    var proj = quoteData ? quoteData.project : {};
    if (token.accepted_at || sub.accepted_at) {
        document.getElementById('acceptanceSection').style.display = 'none';
        document.getElementById('acceptedBanner').style.display = 'block';
        var acceptedDate = token.accepted_at || sub.accepted_at;
        var acceptedName = token.client_name || '';
        var info = 'Acceptée le ' + formatDate(acceptedDate);
        if (acceptedName) info += ' par ' + acceptedName;
        document.getElementById('acceptedInfo').textContent = info;
    }

    // Pre-fill acceptance form with project client info
    if (proj.client_name) {
        document.getElementById('acceptName').value = proj.client_name;
    }
    if (proj.client_email) {
        document.getElementById('acceptEmail').value = proj.client_email;
    }
}

// ═══════════════════════════════════════════════════════════════════════
// ACCEPT QUOTE
// ═══════════════════════════════════════════════════════════════════════

async function acceptQuote() {
    var name = document.getElementById('acceptName').value.trim();
    var email = document.getElementById('acceptEmail').value.trim();

    if (!name) {
        document.getElementById('acceptName').focus();
        return;
    }
    if (!email) {
        document.getElementById('acceptEmail').focus();
        return;
    }

    if (!sigHasDrawn) {
        alert('Veuillez dessiner votre signature.');
        return;
    }

    var signatureData = document.getElementById('signatureCanvas').toDataURL('image/png');

    var btn = document.getElementById('btnAccept');
    btn.disabled = true;
    btn.textContent = 'Traitement en cours...';

    try {
        var resp = await fetch(SUPABASE_URL + '/rest/v1/rpc/accept_quote', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'apikey': SUPABASE_KEY,
                'Authorization': 'Bearer ' + SUPABASE_KEY
            },
            body: JSON.stringify({
                p_token: currentToken,
                p_name: name,
                p_email: email,
                p_signature: signatureData
            })
        });

        var respText = await resp.text();
        console.log('accept_quote response:', resp.status, respText);

        if (!resp.ok) {
            btn.disabled = false;
            btn.textContent = 'Accepter la soumission';
            alert('Erreur ' + resp.status + ' : ' + respText);
            return;
        }

        // Parse JSON (may be empty for void functions)
        var result = null;
        if (respText && respText.trim()) {
            try { result = JSON.parse(respText); } catch(e) { /* not JSON, that's ok */ }
        }

        if (result && result.error) {
            btn.disabled = false;
            btn.textContent = 'Accepter la soumission';
            alert(result.error);
            return;
        }

        // Success — show accepted banner
        document.getElementById('acceptanceSection').style.display = 'none';
        document.getElementById('acceptedBanner').style.display = 'block';
        document.getElementById('acceptedInfo').textContent =
            'Acceptée le ' + formatDate(new Date().toISOString()) + ' par ' + name;

    } catch (err) {
        console.error('Accept fetch error:', err);
        btn.disabled = false;
        btn.textContent = 'Accepter la soumission';
        alert('Erreur de connexion : ' + err.message);
    }
}

// ═══════════════════════════════════════════════════════════════════════
// SIGNATURE PAD
// ═══════════════════════════════════════════════════════════════════════

var sigCanvas, sigCtx, sigDrawing = false, sigHasDrawn = false;

function initSignaturePad() {
    sigCanvas = document.getElementById('signatureCanvas');
    if (!sigCanvas) return;
    sigCtx = sigCanvas.getContext('2d');

    // Set canvas internal resolution to match display size
    function resizeCanvas() {
        var rect = sigCanvas.getBoundingClientRect();
        sigCanvas.width = rect.width * 2;
        sigCanvas.height = rect.height * 2;
        sigCtx.scale(2, 2);
        sigCtx.lineCap = 'round';
        sigCtx.lineJoin = 'round';
        sigCtx.lineWidth = 2;
        sigCtx.strokeStyle = '#000';
        if (sigHasDrawn) {
            sigHasDrawn = false;
            document.getElementById('sigPlaceholder').style.opacity = '1';
        }
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    // Mouse events
    sigCanvas.addEventListener('mousedown', sigStart);
    sigCanvas.addEventListener('mousemove', sigMove);
    sigCanvas.addEventListener('mouseup', sigEnd);
    sigCanvas.addEventListener('mouseleave', sigEnd);

    // Touch events
    sigCanvas.addEventListener('touchstart', function(e) {
        e.preventDefault();
        sigStart(e.touches[0]);
    }, { passive: false });
    sigCanvas.addEventListener('touchmove', function(e) {
        e.preventDefault();
        sigMove(e.touches[0]);
    }, { passive: false });
    sigCanvas.addEventListener('touchend', function(e) {
        e.preventDefault();
        sigEnd();
    });
}

function sigGetPos(e) {
    var rect = sigCanvas.getBoundingClientRect();
    return { x: e.clientX - rect.left, y: e.clientY - rect.top };
}

function sigStart(e) {
    sigDrawing = true;
    var pos = sigGetPos(e);
    sigCtx.beginPath();
    sigCtx.moveTo(pos.x, pos.y);
    if (!sigHasDrawn) {
        sigHasDrawn = true;
        document.getElementById('sigPlaceholder').style.opacity = '0';
    }
}

function sigMove(e) {
    if (!sigDrawing) return;
    var pos = sigGetPos(e);
    sigCtx.lineTo(pos.x, pos.y);
    sigCtx.stroke();
}

function sigEnd() {
    sigDrawing = false;
}

function clearSignature() {
    if (!sigCtx) return;
    sigCtx.clearRect(0, 0, sigCanvas.width, sigCanvas.height);
    sigHasDrawn = false;
    document.getElementById('sigPlaceholder').style.opacity = '1';
}

// ═══════════════════════════════════════════════════════════════════════
// SMART IMAGE LAYOUT
// ═══════════════════════════════════════════════════════════════════════

function classifyRatio(w, h) {
    if (!w || !h) return 'landscape';
    var r = w / h;
    if (r >= 0.9 && r <= 1.1) return 'square';
    if (r > 1.4) return 'landscape';
    if (r < 0.7) return 'portrait';
    if (r >= 1.1) return 'landscape';
    return 'portrait';
}

function computeLayout(ratios) {
    var n = ratios.length;
    if (n <= 0) return '';
    if (n === 1) return 'layout-1';
    var c = { landscape: 0, portrait: 0, square: 0 };
    ratios.forEach(function(r) { c[r]++; });
    if (n === 2) {
        if (c.landscape === 2) return 'layout-2v';
        if (c.portrait === 2 || c.square === 2) return 'layout-2h';
        if (c.landscape >= 1 && c.portrait >= 1) return 'layout-2-lp';
        if (c.portrait >= 1 && c.square >= 1) return 'layout-2h-mixed';
        return 'layout-2h';
    }
    if (n === 3) {
        if (c.portrait === 3) return 'layout-3h';
        return 'layout-3-featured';
    }
    if (n === 4) {
        if (c.landscape >= 1 && ratios[0] === 'landscape') return 'layout-4-featured';
        return 'layout-4-grid';
    }
    return 'layout-gallery';
}

function applySmartLayouts() {
    document.querySelectorAll('.pv-page-room-media').forEach(function(container) {
        var imgs = container.querySelectorAll('img');
        var total = imgs.length;
        if (total === 0) return;
        var loaded = 0;
        function checkAll() {
            if (++loaded < total) return;
            var wraps = Array.from(container.querySelectorAll('.pv-img-wrap'));
            var ratios = [];
            wraps.forEach(function(wrap) {
                var img = wrap.querySelector('img');
                var r = classifyRatio(img.naturalWidth, img.naturalHeight);
                ratios.push(r);
                wrap.classList.add('pv-img-' + r);
            });
            var layout = computeLayout(ratios);
            container.classList.add(layout);
            // Reorder: landscape should be first for featured layouts
            if ((layout === 'layout-2-lp' || layout === 'layout-3-featured' || layout === 'layout-4-featured')
                && ratios[0] !== 'landscape') {
                var lIdx = ratios.indexOf('landscape');
                if (lIdx > 0) container.insertBefore(wraps[lIdx], wraps[0]);
            }
        }
        imgs.forEach(function(img) {
            if (img.complete && img.naturalWidth > 0) checkAll();
            else { img.onload = checkAll; img.onerror = checkAll; }
        });
    });
}

// ═══════════════════════════════════════════════════════════════════════
// LIGHTBOX — Enhanced with navigation, swipe, pinch-to-zoom
// ═══════════════════════════════════════════════════════════════════════

var lbImages = [];
var lbIndex = 0;
var lbScale = 1;
var lbActive = false;

function openLightbox(src) {
    lbImages = [];
    document.querySelectorAll('.pv-page-room-media .pv-img-wrap img').forEach(function(img) {
        lbImages.push(img.src);
    });
    lbIndex = lbImages.indexOf(src);
    if (lbIndex < 0) { lbImages = [src]; lbIndex = 0; }
    lbScale = 1;
    lbActive = true;
    updateLbImage();
    document.getElementById('lightbox').classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeLightbox() {
    document.getElementById('lightbox').classList.remove('active');
    document.body.style.overflow = '';
    lbActive = false;
    lbScale = 1;
    var img = document.getElementById('lightboxImg');
    if (img) img.style.transform = '';
}

function lbNavigate(dir) {
    if (lbImages.length <= 1) return;
    lbIndex = (lbIndex + dir + lbImages.length) % lbImages.length;
    lbScale = 1;
    updateLbImage();
}

function updateLbImage() {
    var img = document.getElementById('lightboxImg');
    img.src = lbImages[lbIndex];
    img.style.transform = '';
    var counter = document.getElementById('lbCounter');
    var prev = document.getElementById('lbPrev');
    var next = document.getElementById('lbNext');
    var multi = lbImages.length > 1;
    counter.textContent = (lbIndex + 1) + ' / ' + lbImages.length;
    prev.style.display = multi ? '' : 'none';
    next.style.display = multi ? '' : 'none';
    counter.style.display = multi ? '' : 'none';
}

// Close on overlay click (not on image or buttons)
document.getElementById('lightbox').addEventListener('click', function(e) {
    if (e.target === this || e.target.id === 'lbContainer') closeLightbox();
});

// Touch: swipe + pinch-to-zoom
(function initLightboxTouch() {
    var container = document.getElementById('lbContainer');
    if (!container) return;
    var startX = 0, startY = 0, startDist = 0, startScale = 1;
    var swiping = false;

    container.addEventListener('touchstart', function(e) {
        if (e.touches.length === 1) {
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
            swiping = true;
        }
        if (e.touches.length === 2) {
            e.preventDefault();
            swiping = false;
            var dx = e.touches[0].clientX - e.touches[1].clientX;
            var dy = e.touches[0].clientY - e.touches[1].clientY;
            startDist = Math.hypot(dx, dy);
            startScale = lbScale;
        }
    }, { passive: false });

    container.addEventListener('touchmove', function(e) {
        if (e.touches.length === 2) {
            e.preventDefault();
            var dx = e.touches[0].clientX - e.touches[1].clientX;
            var dy = e.touches[0].clientY - e.touches[1].clientY;
            var dist = Math.hypot(dx, dy);
            if (startDist > 0) {
                lbScale = Math.max(1, Math.min(5, startScale * (dist / startDist)));
                document.getElementById('lightboxImg').style.transform = 'scale(' + lbScale + ')';
            }
        }
    }, { passive: false });

    container.addEventListener('touchend', function(e) {
        if (e.touches.length === 0 && swiping && lbScale <= 1.1) {
            var endX = e.changedTouches[0].clientX;
            var diffX = endX - startX;
            if (Math.abs(diffX) > 60) {
                lbNavigate(diffX > 0 ? -1 : 1);
            }
        }
        if (e.touches.length === 0 && lbScale > 1 && lbScale < 1.3) {
            lbScale = 1;
            document.getElementById('lightboxImg').style.transform = '';
        }
        swiping = false;
    });
})();

// Keyboard navigation
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') { closeLightbox(); return; }

    // Lightbox navigation when active
    if (lbActive) {
        if (e.key === 'ArrowLeft') { e.preventDefault(); lbNavigate(-1); return; }
        if (e.key === 'ArrowRight') { e.preventDefault(); lbNavigate(1); return; }
        return;
    }

    // Presentation navigation
    var pages = document.querySelectorAll('.pv-page');
    if (pages.length === 0) return;

    if (e.key === 'ArrowDown' || e.key === 'Enter' || e.key === ' ' || e.key === 'ArrowRight') {
        e.preventDefault();
        presScrollToNext(pages, 1);
    }
    if (e.key === 'ArrowUp' || e.key === 'Backspace' || e.key === 'ArrowLeft') {
        e.preventDefault();
        presScrollToNext(pages, -1);
    }
});

document.addEventListener('click', function(e) {
    if (e.target.closest('button, a, input, canvas, .pv-img-wrap, .acceptance-form, .lightbox-overlay')) return;
    var pages = document.querySelectorAll('.pv-page');
    if (pages.length > 0) presScrollToNext(pages, 1);
});

function presScrollToNext(pages, direction) {
    var scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
    var threshold = 20;
    for (var i = 0; i < pages.length; i++) {
        var top = pages[i].offsetTop;
        if (direction > 0 && top > scrollTop + threshold) {
            pages[i].scrollIntoView({ behavior: 'smooth', block: 'start' });
            return;
        }
        if (direction < 0 && i > 0 && top >= scrollTop - threshold) {
            pages[i - 1].scrollIntoView({ behavior: 'smooth', block: 'start' });
            return;
        }
    }
    // Edge: at last page going forward, try acceptance section
    if (direction > 0) {
        var acceptance = document.getElementById('acceptanceSection');
        var accepted = document.getElementById('acceptedBanner');
        var target = (acceptance && acceptance.style.display !== 'none') ? acceptance : accepted;
        if (target && target.style.display !== 'none') {
            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }
    if (direction < 0) pages[0].scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// ═══════════════════════════════════════════════════════════════════════
// FULLSCREEN
// ═══════════════════════════════════════════════════════════════════════

function toggleFullscreen() {
    if (document.fullscreenElement) {
        document.exitFullscreen();
    } else {
        document.documentElement.requestFullscreen();
    }
}

document.addEventListener('fullscreenchange', function() {
    var btn = document.getElementById('btnFullscreen');
    if (document.fullscreenElement) {
        btn.innerHTML = '&#x2716;';
        btn.title = 'Quitter plein \u00e9cran';
    } else {
        btn.innerHTML = '&#x26F6;';
        btn.title = 'Plein \u00e9cran';
    }
});

// ═══════════════════════════════════════════════════════════════════════
// HELPERS
// ═══════════════════════════════════════════════════════════════════════

function showError(title, message) {
    document.getElementById('loadingState').style.display = 'none';
    document.getElementById('quoteContent').style.display = 'none';
    document.getElementById('errorState').style.display = 'flex';
    document.getElementById('errorTitle').textContent = title;
    document.getElementById('errorMessage').textContent = message;
}

function formatMoney(val) {
    return parseFloat(val).toLocaleString('fr-CA', { style: 'currency', currency: 'CAD' });
}

function formatDate(isoStr) {
    if (!isoStr) return '';
    var d = new Date(isoStr);
    return d.toLocaleDateString('fr-CA', { year: 'numeric', month: 'long', day: 'numeric' });
}

function escapeHtml(str) {
    if (!str) return '';
    var div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

function textToHtml(str) {
    if (!str) return '';
    if (str.indexOf('<p>') !== -1 || str.indexOf('<strong>') !== -1 || str.indexOf('<ul>') !== -1) {
        return str; // already HTML
    }
    return escapeHtml(str).replace(/\n/g, '<br>');
}

function toSentenceCase(str) {
    if (!str) return '';
    return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
}

function formatDescriptionForDisplay(text) {
    if (!text || !text.trim()) return '';
    var lines = text.split('\n');
    var keywords = [
        'CAISSON', 'FAÇADES ET PANNEAUX APPARENTS', 'FAÇADES',
        'TIROIRS LEGRABOX', 'TIROIRS', 'POIGNÉES', 'ÉCLAIRAGE',
        'DÉTAILS', 'EXCLUSIONS', 'COMPTOIR', 'QUINCAILLERIE',
        'FINITION', 'ÉLECTRO', 'RANGEMENT', 'DIMENSIONS',
        'NOTES', 'PARTICULARITÉS'
    ];
    var hasKeyword = lines.some(function(l) {
        var upper = l.trim().toUpperCase();
        return keywords.some(function(k) { return upper.startsWith(k); });
    });
    if (!hasKeyword) return escapeHtml(text).replace(/\n/g, '<br>');
    var html = '';
    var inList = false;
    lines.forEach(function(line) {
        var trimmed = line.trim();
        if (!trimmed) { if (inList) { html += '</ul>'; inList = false; } return; }
        if (trimmed.startsWith('-') || trimmed.startsWith('•')) {
            if (!inList) { html += '<ul>'; inList = true; }
            html += '<li>' + escapeHtml(trimmed.replace(/^[-•]\s*/, '')) + '</li>';
            return;
        }
        if (inList) { html += '</ul>'; inList = false; }
        var matched = false;
        var upper = trimmed.toUpperCase();
        for (var i = 0; i < keywords.length; i++) {
            if (upper.startsWith(keywords[i])) {
                var colonIdx = trimmed.indexOf(':');
                if (colonIdx !== -1) {
                    var label = trimmed.substring(0, colonIdx).trim();
                    var value = trimmed.substring(colonIdx + 1).trim();
                    html += '<p><strong>' + escapeHtml(toSentenceCase(label)) + ' :</strong> ' + escapeHtml(value) + '</p>';
                } else {
                    html += '<p><strong>' + escapeHtml(toSentenceCase(trimmed)) + '</strong></p>';
                }
                matched = true;
                break;
            }
        }
        if (!matched) html += '<p>' + escapeHtml(trimmed) + '</p>';
    });
    if (inList) html += '</ul>';
    return html;
}

function formatRoomDescription(str) {
    if (!str) return '';
    // Already rich HTML from AI optimizer
    if (str.indexOf('<p>') !== -1 || str.indexOf('<strong>') !== -1 || str.indexOf('<ul>') !== -1) {
        return str;
    }
    // Convert stored <br> to newlines, strip remaining tags, then format
    var text = str.replace(/<br\s*\/?>/gi, '\n').replace(/<[^>]+>/g, '');
    return formatDescriptionForDisplay(text);
}
</script>
</body>
</html>
